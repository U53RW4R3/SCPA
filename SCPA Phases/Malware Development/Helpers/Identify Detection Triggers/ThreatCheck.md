# ThreatCheck

## 01 - C\#

### 1.1 - Compile

^1f5090

- Install a targeting pack

https://dotnet.microsoft.com/en-us/download/dotnet-framework/net481

- We need to make directory to place the tools

`PS C:\Users\userware> mkdir Tools`

- **Note:** You must run this as administrator add any exclusions

```
PS C:\Users\userware> Add-MpPreference -ExclusionPath C:\Users\$env:username\Tools

PS C:\Users\userware> cd Tools
```

- This is the easiest way to download the files with `git clone`

```
PS C:\Users\userware\Tools> git clone https://github.com/rasta-mouse/ThreatCheck.git

PS C:\Users\userware\Tools> cd ThreatCheck\ThreatCheck\ThreatCheck
```

- **First we copy the `Program.cs` as a backup to prevent it from overwriting it**

```
PS C:\Users\userware\Tools\ThreatCheck\ThreatCheck\ThreatCheck> copy Program.cs Program.cs.bak
dotnet new console --force
del Program.cs; move Program.cs.bak Program.cs
```

- **Then we add a dependency when using flags like `-f file.ps1`**

`PS C:\Users\userware\Tools\ThreatCheck\ThreatCheck\ThreatCheck> dotnet add package CommandLineParser --version 2.8.0`

- **Then we compile it**

`PS C:\Users\userware\Tools\ThreatCheck\ThreatCheck\ThreatCheck> dotnet publish -r win-x64 -c Release -p:PublishSingleFile=true --sc false`

- Or you can just use `build`

`PS C:\Users\userware\Tools\ThreatCheck\ThreatCheck\ThreatCheck> dotnet build -c Release -p:PublishSingleFile=true --sc false`

You'll eventually gonna see duplicate syntax errors which is an easy fix to navigate to the file named `ThreatCheck.AssemblyInfo.cs` and comment the lines. You can see the screenshot figure below.

![[ThreatCheck.AssemblyInfo Comment Lines.png]]

- **Then we compile it again and it works!**

`PS C:\Users\userware\Tools\ThreatCheck\ThreatCheck\ThreatCheck> dotnet publish -r win-x64 -c Release -p:PublishSingleFile=true --sc false`

### 1.2 - Help Menu

```
PS C:\Users\userware\Tools\ThreatCheck\ThreatCheck\ThreatCheck\bin\Release\net6.0\win-x64\publish> .\ThreatCheck.exe --help
ThreatCheck 1.0.0.0
Copyright c  2019

  -e, --engine    (Default: Defender) Scanning engine. Options: Defender, AMSI

  -f, --file      Analyze a file on disk

  -u, --url       Analyze a file from a URL

  --help          Display this help screen.

  --version       Display version information.
```

### 1.3 - Usage

#### 1.3.1 - Defender

`PS C:\Users\userware\Tools\ThreatCheck\ThreatCheck\ThreatCheck\bin\Release\net6.0\win-x64\publish> .\ThreatCheck.exe -f implant.exe`

#### 1.3.2 - AMSI

`PS C:\Users\userware\Tools\ThreatCheck\ThreatCheck\ThreatCheck\bin\Release\net6.0\win-x64\publish> .\ThreatCheck.exe -f implant.ps1 -e AMSI`

## 02 - Python

### 2.1 - Help Menu

`PS C:\> Invoke-WebRequest -UseBasicParsing https://gist.githubusercontent.com/daddycocoaman/108d807e89a0f9731304bc848fa219f0/raw/d505b9138e810caddaddcae60ba1d7ff5e99e2d2/pydefendercheck.py -OutFile pydefendercheck.py`

```
PS C:\> python .\pydefendercheck.py -h
usage: pydefendercheck.py [-h] filename

Python version of DefenderCheck

positional arguments:
  filename

options:
  -h, --help  show this help message and exit
```

### 2.2 - Usage

`PS C:\> python .\pydefendercheck.py implant.exe`

---
## References

- [ThreatCheck](https://github.com/rasta-mouse/ThreatCheck)

- [PyDefenderCheck](https://gist.github.com/daddycocoaman/108d807e89a0f9731304bc848fa219f0)

- [Offensive Defence: Bypassing Defender with ThreatCheck & Ghidra](https://offensivedefence.co.uk/posts/threatcheck-ghidra/)