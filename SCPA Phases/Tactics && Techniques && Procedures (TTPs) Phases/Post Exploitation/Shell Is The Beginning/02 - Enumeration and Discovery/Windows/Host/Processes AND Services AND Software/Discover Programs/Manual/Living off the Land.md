# Living off the Land

## 01 - Installed Programs

### 1.1 - Command Prompt

#### 1.1.1 - List Installed Software

```
C:\> wmic product get name,version,vendor

C:\> reg query hkey_local_machine\software

C:\> reg query hklm\software
```

- .NET MSBuild compilers

```
C:\> dir %windir%\Microsoft.NET\Framework64 /ad

C:\> dir /b %windir%\Microsoft.NET\Framework64\v*

C:\> wmic product get description | findstr /c:.NET
```

#### 1.1.2 - List directories including hidden files and folders

```
C:\> dir /a "C:\Program Files"

C:\> dir /a "C:\Program Files (x86)"
```

#### 1.1.3 - Find a specific program

- Syntax

```
C:\> where <program.exe>

C:\> where /r <C:\ | \\<IP>\c$> <program.exe>

C:\> where /r  <program.exe>

C:\> dir /s /b c:\ | findstr "<program.exe>"
```

- File Explorer

```
C:\> where explorer.exe

C:\> where /r C:\ explorer.exe

C:\> dir /s /b c:\ | findstr "explorer.exe"
```

- Internet Explorer

```
C:\> where iexplore.exe

C:\> where /r C:\ iexplore.exe

C:\> dir /s /b c:\ | findstr "iexplore.exe"
```

- Java Updater

```
C:\> where jucheck.exe

C:\> where /r C:\ jucheck.exe

C:\> dir /s /b c:\ | findstr "jucheck.exe"
```

- Find MSBuild C# compiler versions

```
C:\> where /r C:\ MSBuild.exe

C:\> where /r \\<IP>\c$ MSBuild.exe

C:\> dir /s /b c:\ | findstr "MSBuild.exe"
```

### 1.2 - Powershell

#### 1.2.1 - List Installed Software

```
PS C:\> Get-CimInstance -Query "Select * FROM Win32_Product" | ? {?_.Vendor -Notmatch 'Microsoft'}

PS C:\> Get-ChildItem -Path Registry::HKEY_LOCAL_MACHINE\SOFTWARE | ft Name
```

- List the .MSI installation that isn't vendored by Microsoft

```
PS C:\> Get-ChildItem -Recursive -Path $env:windir\Microsoft.NET\Framework64

PS C:\> Get-Item C:\Windows\Microsoft.Net\Framework64\v4.0.30319\clr.dll | ft
```

#### 1.2.2 - List directories including hidden files and folders

```
PS C:\> Get-ChildItem 'C:\Program Files','C:\Program Files (x86)' | ft Parent,Name,LastWriteTime
```

#### 1.2.3 - Find a specific program

- Syntax

```
PS C:\> Get-Command <program.exe> | Format-Table CommandType, Name, Definition

PS C:\> (Get-Command <program.exe>).Definition

PS C:\> (Get-ChildItem -Recurse -Path <C:\ | \\<IP>\c$> -Include "<program.exe>" -ErrorAction SilentlyContinue).FullName

PS C:\> Get-ChildItem -Recurse -Path <C:\ | \\<IP>\c$> -Include "<program.exe>" -ErrorAction SilentlyContinue | ForEach-Object {$_.FullName}

PS C:\> Get-ChildItem -Recurse -Path <C:\ | \\<IP>\c$> -ErrorAction SilentlyContinue | Where-Object {($_.Name -eq "<program.exe>")} | % {$_.FullName}
```

- File Explorer

```
PS C:\> (Get-Command explorer.exe).Definition

PS C:\> (Get-ChildItem -Recurse -Path C:\ -Include "explorer.exe" -ErrorAction SilentlyContinue).FullName
```

- Internet Explorer

```
PS C:\> (Get-Command iexplore.exe).Definition

PS C:\> (Get-ChildItem -Recurse -Path C:\ -Include "iexplore.exe" -ErrorAction SilentlyContinue).FullName
```

- Java Updater

`PS C:\> (Get-ChildItem -Recurse -Path C:\ -Include "jucheck.exe" -ErrorAction SilentlyContinue).FullName`

- Find MSBuild C# compiler versions

```
PS C:\> (Get-ChildItem -Recurse -Path C:\ -Include "MSBuild.exe" -ErrorAction SilentlyContinue).FullName

PS C:\> (Get-ChildItem -Recurse -Path \\<IP>\c$ -Include "MSBuild.exe" -ErrorAction SilentlyContinue).FullName
```

## 02 - Powershell and .NET

### 2.1 - Command Prompt

- Discover available Powershell engines

```
C:\> reg query [\\<IP>\]hkey_local_machines\software\microsoft\powershell\1\powershellengine /v powershellversion

C:\> reg query [\\<IP>\]hklm\software\microsoft\powershell\3\powershellengine /v powershellversion
```

- Discover Powershell Logging

```
C:\> reg query [\\<IP>\]HKLM\SOFTWARE\Wow6432Node\Policies\Microsoft\Windows\Powershell\Transcription

C:\> reg query [\\<IP>\]HKLM\SOFTWARE\Wow6432Node\Policies\Microsoft\Windows\PowerShell\ModuleLogging

C:\> reg query [\\<IP>\]HKLM\SOFTWARE\Wow6432Node\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging
```

- Enumerate available Common Language Runtime (CLR) versions

```
C:\> dir %windir%\Microsoft.Net\Framework\ /s /b | find "System.dll"

C:\> reg query "HKLM\SOFTWARE\Microsoft\Net Framework Setup\NDP\v4\Full Release"
```

### 2.2 - Powershell

- Discover available Powershell engines

`PS C:\> Get-ItemPropertyValue HKLM:\software\microsoft\powershell\*\powershellengine -Name PowerShellVersion`

- Enumerate available Common Language Runtime (CLR) versions

```powershell
PS C:\> [System.IO.File]::Exists("$env:windir\Microsoft.Net\Framework\v2.0.50727\System.dll")

PS C:\> [System.IO.File]::Exists("$env:windir\Microsoft.Net\Framework\v4.0.30319\System.dll")
```

## 03 - Device Drivers

### 3.1 - Command Prompt

```
C:\> driverquery.exe [/s <IP>] [/u [<DOMAIN_NAME>\]username>] [/p <password>] [/v] /fo list

C:\> driverquery.exe [/s <IP>] [/u [<DOMAIN_NAME>\]username>] [/p <password>] /fo table

C:\> driverquery.exe [/s <IP>] [/u [<DOMAIN_NAME>\]username>] [/p <password>] --no-msft
```

### 3.2 - Powershell

- Filtering the installed 3rd party drivers with WMI

```powershell
PS C:\> driverquery.exe [/s <IP>] [/u [<DOMAIN_NAME>\]username>] [/p <password>] /v /fo csv | ConvertFrom-CSV | Select-Object 'Display Name', 'Start Mode', Path

PS C:\> Get-CimInstance Win32_PnPSignedDriver | Select-Object DeviceName, DriverVersion, Manufacturer | Where-Object {$_.DeviceName -like "*VMWare*"}
```

- Using WMI for virtualization detection

```powershell
PS C:\> $VMAdapter = Get-CimInstance Win32_NetworkAdapter -Filter 'Manufacturer LIKE "%VMware%" OR Name LIKE "%VMWare%"'

$VMBios = Get-CimInstance Win32_BIOS -Filter 'SerialNumber LIKE "%VMWare%"'

$VMToolsRunning = Get-CimInstance Win32_Process -Filter 'Name="vmtoolsd.exe"'

[Bool]($VMAdapter -or $VMBios -or $VMToolsRunning)
```

## 04 - Antivirus and EDR

### 4.1 - Command Prompt

- Check Antivirus Programs

```
C:\> sc query windefend

C:\> wmic [/node:<IP>] /namespace:\\root\securitycenter2 path antivirusproduct

C:\> wmic [/node:<IP>] /namespace:\\root\securitycenter2 path antivirusproduct get displayname, productState, pathToSignedProductExe
```

### 4.2 - Powershell

- Check Antivirus Programs

```
PS C:\> Get-MpComputerStatus

PS C:\> Get-CimInstance -Namespace root\securitycenter2 -Classname antivirusproduct

PS C:\> Get-CimInstance -Namespace root\SecurityCenter2 -Class AntiVirusProduct | Select-Object -Property displayname

PS C:\> Get-CimSession | Get-Avstatus | where {-Not $_.Uptodate}

PS C:\> Get-CimSession | Get-Avstatus | group Displayname | Select-Object Name,Count
```

---
## References

- [Config Server Firewall: CMD Where Command | Find Files Using Command Prompt](https://www.configserverfirewall.com/windows-10/cmd-where-command/)

- [Deep Dive into the Solorigate Second Stage Activation from Sunburst to Teardrop and Raindrop](https://www.microsoft.com/en-us/security/blog/2021/01/20/deep-dive-into-the-solorigate-second-stage-activation-from-sunburst-to-teardrop-and-raindrop/)