# Metasploit
Search Tag(s): #post-exploitation #enumeration-and-discovery #metasploit-framework #windows

## 01 - Installed Programs

TODO: Convert the manual methods to meterpreter

### 1.1 - List Installed Software

```
meterpreter > run post/windows/gather/enum_applications

meterpreter > run post/windows/gather/enum_chocolatey_applications

meterpreter > run post/windows/gather/wmic_command command="product get name,version,vendor"

meterpreter > reg enumkey [-r <target_IP>] -k HKLM\\SOFTWARE
```

### 1.2 - List directories including hidden files and folders

```
meterpreter > ls -R "C:\Program Files"

meterpreter > ls -R "C:\Program Files (x86)"
```

### 1.3 - Find a specific program

File Explorer

```
meterpreter > ls -RS "explorer.exe" C:\\

meterpreter > search -d C:\\ -f explorer.exe
```

Internet Explorer

```
meterpreter > ls -RS "iexplore.exe" C:\\

meterpreter > search -d C:\\ -f iexplore.exe
```

Java Updater

```
meterpreter > ls -RS "jucheck.exe" C:\\

meterpreter > search -d C:\\ -f jucheck.exe
```

Find MSBuild C# compiler versions

```
meterpreter > ls -RS "MSBuild.exe" C:\\

meterpreter > search -d C:\\ -f MSBuild.exe

meterpreter > ls -R %windir%\Microsoft.NET\Framework64

meterpreter > ls %windir%\Microsoft.NET\Framework64\v*

meterpreter > run post/windows/gather/wmic_command command="product get description"

user@pentestos:~$ grep ".NET" /root/.msf4/loot/msf-loot-file.txt
```

## 02 - Powershell and .NET

Discover available Powershell engines.

```
meterpreter > reg queryval [-r <target_IP>] -k hklm\\software\\microsoft\\powershell\\1\\powershellengine -v powershellversion

meterpreter > reg queryval [-r <target_IP>] -k hklm\\software\\microsoft\\powershell\\3\\powershellengine -v powershellversion
```

Discover Powershell Logging.

```
meterpreter > reg enumkey [-r <target_IP>] -k HKLM\\SOFTWARE\\Wow6432Node\\Policies\\Microsoft\\Windows\\Powershell\\Transcription

meterpreter > reg enumkey [-r <target_IP>] -k HKLM\\SOFTWARE\\Wow6432Node\\Policies\\Microsoft\\Windows\\PowerShell\\ModuleLogging

meterpreter > reg enumkey [-r <target_IP>] -k HKLM\\SOFTWARE\\Wow6432Node\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging
```

Enumerate available Common Language Runtime (CLR) versions.

```
meterpreter > ls -RS "System.dll" %windir%\Microsoft.Net\Framework\

C:\> reg enumkey [-r <target_IP>] -k "HKLM\SOFTWARE\Microsoft\Net Framework Setup\NDP\v4\Full Release"
```

## 03 - Device Drivers

### 3.1 - Meterpreter Command

```
meterpreter > execute -Hicf driverquery.exe -a "[/s <IP>] [/u [<DOMAIN>\]username>] [/p <password>] [/v] /fo list"

meterpreter > execute -Hicf driverquery.exe -a "[/s <IP>] [/u [<DOMAIN>\]username>] [/p <password>] /fo table"

meterpreter > execute -Hicf driverquery.exe -a "[/s <IP>] [/u [<DOMAIN>\]username>] [/p <password>] --no-msft"
```

### 3.2 - Powershell Extension

#### 3.2.1 - Execute Powershell Commands

```
meterpreter > powershell_execute 'driverquery.exe [/s <IP>] [/u [<DOMAIN>\]username>] [/p <password>] /v /fo csv | ConvertFrom-CSV | Select-Object "Display Name", Start Mode", Path'

meterpreter > powershell_execute 'Get-CimInstance Win32_PnPSignedDriver | Select-Object DeviceName, DriverVersion, Manufacturer | Where-Object {$_.DeviceName -like "*VMWare*"}'
```

## 04 - Antivirus and EDR

```
meterpreter > service_query WinDefend

meterpreter > run post/windows/gather/enum_av

meterpreter > run post/windows/gather/wmic_command command="/namespace:\\root\securitycenter2 path antivirusproduct"

meterpreter > run post/windows/gather/wmic_command command="/namespace:\\root\securitycenter2 path antivirusproduct get displayname, productState, pathToSignedProductExe"
```

---
## References

- [[04 - Powershell|Powershell Meterpreter Extension]]

- [Rapid7: Metasploit Framework Enumerate AV Gather Post Module](https://github.com/rapid7/metasploit-framework/blob/master/documentation/modules/post/windows/gather/enum_av.md)