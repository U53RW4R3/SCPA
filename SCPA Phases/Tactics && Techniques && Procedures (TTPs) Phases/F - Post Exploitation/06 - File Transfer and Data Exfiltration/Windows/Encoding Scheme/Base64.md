# Base64

## 01 - Command Prompt

### 1.1 - CertUtil

```
C:\> certutil -encode file.txt encoded_file.txt

C:\> certutil -decode encoded_file.txt decoded_file.txt
```

## 02 - Powershell

### 2.1 - Encoding a file to Base64

```powershell
PS C:\> $file = 'C:\path\to\file.txt'
$bytes = [IO.File]::ReadAllBytes($file)
$encoded = [Convert]::ToBase64String($bytes)
Set-Content -Path 'encodedb64.txt' -Value $encoded
```

A much shorter one.

```powershell
PS C:\> $file = 'C:\path\to\file.txt'
$encoded = [Convert]::ToBase64String([IO.File]::ReadAllBytes($file)); 
Set-Content -Path 'encodedb64.txt' -Value $encoded
```

### 2.2 - Decoding Base64 to a file

Decode text files.

```powershell
PS C:\> $encoded_file = [IO.File]::ReadAllLines("encodedb64.txt") # Any of these two lines works
PS C:\> $encoded_file = [IO.File]::ReadAllText("encodedb64.txt")
$decoded = [Convert]::FromBase64String($encoded_file)
$bytes = [char[]]([int[]]$decoded) -join ""
Set-Content -Path 'file.txt' -Value $bytes
```

Decode binary files.

```powershell
PS C:\> $payload = "<base64_encoded_payload>"
[byte[]]$decoded = [Convert]::FromBase64String($payload)
[IO.File]::WriteAllBytes("implant.exe", $decoded)
```

### 2.3 - Data Compression

Compression via Base64 encoding.

```powershell
PS C:\> $file = 'C:\path\to\file.txt'
$memorystream = New-Object System.IO.MemoryStream
$compress = System.IO.Compression.GZipStream($memorystream, [System.IO.Compression.CompressionMode]::Compress)
$filestream = [System.IO.File]::OpenRead($file)
$filestream.CopyTo($compress)
$compress.Close()
$filestream.Close()
$encoded = [Convert]::ToBase64String($memorystream.ToArray())
$encoded | Out-File 'compressed.txt'

[IO.File]::WriteAllBytes("compressed.txt", $encoded)
```

TODO: Convert the file compression from Linux bash commands to powershell cmdlets.

Decompression via Base64 decoding.

```powershell
$encodedstring = Get-Content 'b64output.txt'
$data = [System.Convert]::FromBase64String("$encodedstring")
$ms = New-Object System.IO.MemoryStream
$ms.Write($data, 0, $data.Length)
$ms.Seek(0,0) | Out-Null
$sr = New-Object System.IO.StreamReader(New-Object System.IO.Compression.GZipStream($ms, [System.IO.Compression.CompressionMode]::Decompress))
$sr.ReadToEnd() | Out-File 'DecodedText.txt
```

```powershell
PS C:\> $payload = "<base64_encoded_compressed_payload>"
[byte[]]$decoded = [Convert]::FromBase64String($payload)
$memorystream = New-Object System.IO.MemoryStream
$memorystream.Write($decoded, 0, $decoded.Length)
$memorystream.Seek(0,0) | Out-Null
$streamreader = New-Object System.IO.StreamReader(New-Object System.IO.Compression.GZipStream($memorystream, [System.IO.Compression.CompressionMode]::Decompress))

$streamreader.ReadToEnd() | Out-File 'DecodedText.txt

[IO.File]::WriteAllBytes("implant.exe", $decoded)
```

---
## References

- [[Command Line/Operating Systems/Windows/Powershell/Use Cases/Base64|Command Line: Windows Base64]]

- [[Tactics && Techniques && Procedures (TTPs) Phases/F - Post Exploitation/06 - File Transfer and Data Exfiltration/Linux/Encoding Scheme/Base64|File Transfer and Data Exfiltration: Linux Base64]]

- [DmFrSecurity Windows Base64 Encoding and Decoding Using Certutil](https://dmfrsecurity.com/2017/01/07/windows-base64-encoding-and-decoding-using-certutil/)

- [Powershell Base64](https://www.educba.com/powershell-base64/)

- [Encoding Binary Files to Include In Scripts](https://davejlong.com/encoding-binary-files-to-include-in-scripts/)