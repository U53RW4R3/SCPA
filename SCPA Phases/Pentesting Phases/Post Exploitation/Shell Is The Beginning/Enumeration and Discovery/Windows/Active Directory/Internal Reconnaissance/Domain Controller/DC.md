# DC

## 01 - Manual

### 1.1 - Command Prompt

- **Domain Controller**

- Enumerate the current domain controller

`C:\> set | find "USERDOMAIN"`

`C:\> echo %logonserver%`

`C:\> qwinsta /server:<IP>`

`C:\> wmic path win32_groupuser where (groupcomponent="win32_group.name='domain admins', domain='<DOMAIN>'")`

`c:\> wmic group list`

`C:\> wmic ntdomain get domaincontrolleraddress,domainname,roles`

`C:\> wmic /namespace:\\root\directory\ldap path ds_user get ds_samaccountname`

`C:\> wmic /namespace:\\root\directory\ldap path ds_group get ds_samaccountname`

`C:\> wmic /namespace:\\root\directory\ldap path ds_computer get ds_samaccountname`

`C:\> wmic computersystem get domain`

- **Sysnative tools**

`C:\> c:\windows\sysnative\nltest.exe /dclist:<domain>`

`C:\> nltest /dclist:`

`C:\> nltest /dclist:<domain_name>`

`C:\> nltest /dcname:<domain_name>`

`C:\> nltest /dcgetdc:<domain_name>`

`C:\> nltest /domain_trusts`

`C:\> nltest /domain_trusts /all_trusts`

`C:\> nltest /domain_trusts & nltest /dclist:&c:\windows\sysnative\nltest /domain_trusts & c:\windows\sysnative\nltest /dclist:<domain_name>`

### 1.2 - Powershell

`PS C:\> Get-ADComputer -Filter {Enabled -eq $true} -Properties * | Select-Object Name, DNSHostName, OperatingSystem, LastLogonDate | Export-CSV C:\temp\AllWindows.csv -NoTypeInformation -Encoding UTF8`

`PS C:\> echo $env:userdomain`

`PS C:\> Get-CimInstance -ClassName Win32_UserInDomain | Format-Table -AutoSize`

`PS C:\> Get-CimInstance -ClassName Win32_NTDomain | Format-Table -AutoSize`

`PS C:\> echo (Get-CimInstance Win32_ComputerSystem).Domain`

`PS C:\> echo (Get-WmiObject Win32_ComputerSystem).Domain`

`PS C:\> [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()`

- To enumerate Nested Groups in an active directory environment

`$ cat enumerateAD.ps1`

---

```powershell
$domainObj = [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()

$PDC = ($domainObj.PdcRoleOwner).Name

$SearchString = "LDAP://"

$SearchString = $PDC + "/"

$DistinguishedName = "DC=$($domainObj.Name.Replace('.', ',DC='))"

$SearchString += $DistinguishedName

$SearchString

$Searcher = New-Object System.DirectoryServices.DirectorySearcher([ADSI]$SearchString)

$objDomain = New-Object System.DirectoryServices.DirectoryEntry

$Searcher.SearchRoot = $objDomain

# property=value
# such as => name=<domain_username>
#$Searcher.filter = "samAccounType=805306368"

#$Searcher.FindAll()

#foreach($obj in $Result) {
#    foreach($prop in $obj.Properties) {
#        $prop
#    }
#    Write-Host "------------------------"
#}

# Enumerate each group member

# (property=value)
# such as => name=<Group_name>
#$Searcher.filter = "(objectClass=Group)"

#$Result = $Searcher.FindAll()

#foreach($obj in $Result) {
#    $obj.Properties.name
#}

$Searcher.filter = "(name=Domain Admins)"

$Output = $Searcher.FindAll()

foreach($obj in $Output) {
    $obj.Properties.member
}
```

- Retrieve SPN users that are possibly **kerberoastable** of the `samaccountname` and `serviceprincipalname`

`$ cat enumerateSPN.ps1`

---

```powershell
$domainObj = [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()

$PDC = ($domainObj.PdcRoleOwner).Name

$SearchString = "LDAP://"

$SearchString = $PDC + "/"

$DistinguishedName = "DC=$($domainObj.Name.Replace('.', ',DC='))"

$SearchString += $DistinguishedName

$SearchString

$Searcher = New-Object System.DirectoryServices.DirectorySearcher([ADSI]$SearchString)

$objDomain = New-Object System.DirectoryServices.DirectoryEntry

$Searcher.SearchRoot = $objDomain

$Searcher.filter = "serviceprincipalname=*http*"

$Result = $Searcher.FindAll()

foreach($obj in $Output) {
    foreach($prop in $obj.Properties) {
        $prop
    }
}
```

## 02 - Impacket

TODO: Finish this

`$ wmiquery.py <domain_name>/<username>:<password>@<IP>`

`$ wmiquery.py <domain_name>/<username>@<IP> -hashes :<nt_hash>`

`WQL>`

## 03 - Third-Party Tools

### 3.1 - adfind.exe

#### 3.1.1 - Basic Usage with Examples

`C:\> adfind.exe -h <IP> -sc < adinfo | computers_pwdnotreqd | dclist | dcmodes | domainlist | trustdmp | u:<username> > -f <filter>`

`C:\> adfind.exe -b dc=<domain_name>,dc=<tdl> -sc u:<username>`

`C:\> adfind.exe -f "(objectcategory=<group>)"`

- **Find all computers**

`C:\> adfind.exe -f "objectcategory=computer" > ad_computers.txt`

- **Gather all subnets in the active directory network**

`C:\> adfind.exe -subnets -f (objectCategory=subnet) > subnets.txt`

- **Find all users**

`C:\> adfind.exe -f "(objectcategory=person)" > ad_users.txt`

`C:\> adfind.exe -f "(objectcategory=organizationalUnit)" > org_units.txt`

`C:\> adfind.exe -h <IP> -f (name="Domain Admins") member -list > da_users.txt`

`C:\> adfind.exe -h <IP> -f (objectcategory=*) > all_categories.txt`

- **Dump Trust Objects of the domain controllers**

`C:\> adfind.exe -sc trustdmp > trustdmp.txt`

- **Dump Trust Objects** **of the Forest (the root of the active directory network of the hierarchy)**

`C:\> adfind.exe -gcb -sc trustdmp > forest_trustdmp.txt`

## 04 - Powersploit

### 4.1 - PowerView

- Displays list of all the groups in the Domain Controller

`PS C:\> Get-NetGroup`

`PS C:\> Get-NetGroup -Domain <domain_name>`

- Retrieve information about the **Domain Name**

`PS C:\> Get-NetDomain`

`PS C:\> Get-NetDomainController`

- Retrieve the `objectsid` which outputs what privileges you're running as which could be a user, domain controller, administrator, etc. This help you understand when using mimikatz to dump the hashes and get a golden ticket to maintain access.

`PS C:\> Get-DomainSID`

- If we're able to compromise the Domain Controller. We want to find admin access and which computers are active.

`PS C:\> Find-LocalAdminAccess`

## 05 - Cobalt Strike

`beacon> net view`

`beacon> net domain_controllers`

`beacon> net dclist`

## References

- [PYSA/Mespinoza Ransomware](https://thedfirreport.com/2020/11/23/pysa-mespinoza-ransomware/)

- [AD Recon for Beginners](https://blog.certcube.com/ad-recon-for-beginners/)

- [ADFind Usage](https://www.joeware.net/freetools/tools/adfind/usage.htm)

- [Active Directory Domain Enumeration Part 1](https://nored0x.github.io/red-teaming/active-directory-domain-enumeration-part-1/)

- [Deep Dive into the Solorigate Second Stage Activation from Sunburst to Teardrop and Raindrop](https://www.microsoft.com/en-us/security/blog/2021/01/20/deep-dive-into-the-solorigate-second-stage-activation-from-sunburst-to-teardrop-and-raindrop/)