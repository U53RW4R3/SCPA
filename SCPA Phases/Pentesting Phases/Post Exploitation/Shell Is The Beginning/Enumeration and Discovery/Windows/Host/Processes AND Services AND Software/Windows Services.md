# Windows Services

## 01 - Manual

### 1.1 - Discover Permissions

#### 1.1.1 - Command Prompt

##### 1.1.1.1 - icacls.exe

- **Finding Windows installed program folders that contains full access Permissions that the Users and the rest of the groups configuration**

`C:\> icacls "C:\Program Files\*" 2>nul | findstr "(F)" | findstr "Everyone"`

`C:\> icacls "C:\Program Files (x86)\*" 2>nul | findstr "(F)" | findstr "Everyone"`

`C:\> icacls "C:\Program Files\*" 2>nul | findstr "(F)" | findstr "BUILTIN\Users"`

`C:\> icacls "C:\Program Files (x86)\*" 2>nul | findstr "(F)" | findstr "BUILTIN\Users"`

`C:\> icacls "C:\Program Files\*" 2>nul | findstr "(F)" | findstr "Authenticated Users"`

`C:\> icacls "C:\Program Files (x86)*" 2>nul | findstr "(F)" | findstr "Authenticated Users"`

- **Finding Windows installed program folders that contains modifiable Permissions that the Users and the rest of the groups configuration**

`C:\> icacls "C:\Program Files\*" 2>nul | findstr "(M)" | findstr "Everyone"`

`C:\> icacls "C:\Program Files (x86)\*" 2>nul | findstr "(M)" | findstr "Everyone"`

`C:\> icacls "C:\Program Files\*" 2>nul | findstr "(M)" | findstr "BUILTIN\Users"`

`C:\> icacls "C:\Program Files (x86)\*" 2>nul | findstr "(M)" | findstr "BUILTIN\Users"`

`C:\> icacls "C:\Program Files (x86)*" 2>nul | findstr "(M)" | findstr "Authenticated Users"`

`C:\> icacls "C:\Program Files (x86)\*" 2>nul | findstr "(M)" | findstr "Authenticated Users"`

##### 1.1.1.2 - SCManager

- **Check permissions for service creation**

`C:\> sc sdshow scmanager`

#### 1.1.2 - Powershell

- **Running the powershell cmdlet with Get-ACL to find certain permissions**

`PS C:\> Get-ChildItem "C:\Program Files" -Recurse | Get-ACL | ?{$_.AccessToString -match "Everyone\sAllow\s\sModify"}`

#### 1.1.3 - Sysinternals

##### 1.1.3.1 - Accesschk

- **Using sysinternals toolkit to enumerate the path to look for possible misconfigured services**

- Automatically accept the EULA in order to use the binary

`C:\> accesschk.exe /accepteula`

- Enumerating directories permissions' in the `"C:\Program Files"` and `"C:\Program Files (x86)"` path

`C:\> accesschk.exe -uwcqv Users "C:\Program Files"`

`C:\> accesschk.exe -uwcqv "Authenticated Users" "C:\Program Files"`

`C:\> accesschk.exe -uws "Everyone" "C:\Program Files"`

`C:\> accesschk.exe -uwcqv Users "C:\Program Files (x86)"`

`C:\> accesschk.exe -uwcqv "Authenticated Users" "C:\Program Files (x86)"`

`C:\> accesschk.exe -uws "Everyone" "C:\Program Files (x86)"`

- Enumerating services that the users have been granted access of what permissions

`C:\> accesschk.exe -uwcqv Users *`

`C:\> accesschk.exe -uwcqv "Authenticated Users" *`

`C:\> accesschk.exe -uwcqv "Everyone" *`

- Enumerating the directories that contains users group permissions on each drive

`C:\> accesschk.exe -uwcqv Users c:\`

`C:\> accesschk.exe -uwcqv "Authenticated Users" c:\`

`C:\> accesschk.exe -uwcqv "Everyone" c:\`

`C:\> accesschk.exe -uwcqv Users c:\*.*`

`C:\> accesschk.exe -uwcqv "Authenticated Users" c:\*.*`

`C:\> accesschk.exe -uwcqv "Everyone" c:\*.*`

- Enumerating global objects that anyone modify

`C:\> accesschk.exe -wuo everyone \basednamedobjects`

##### 1.1.3.2 - Sysmon

- **Find the Sysmon executable process**

`C:\> tasklist /svc | findstr /i sysmon`

`C:\> wmic process where name="Sysmon64.exe" get executablepath`

- **Get configuration**

`C:\> Sysmon64.exe -c`

`C:\> Sysmon64.exe -s`

`C:\> dir /s *.xml`

### 1.2 - Insecure File Permissions

#### 1.2.1 - Command Prompt

- Manual services

`C:\> wmic service get name,pathname,startname,startmode | findstr /i "localsystem" | findstr /i /v "c:\windows"`

- Auto and Running services

`C:\> wmic service get name,pathname,startname,startmode | findstr /i "auto" | findstr /i "localsystem" | findstr /i /v "c:\windows"`

#### 1.2.2 - Powershell

- Auto and Running services

`PS C:\> Get-WmiObject Win32_Service | Select-Object Name, State, PathName | Where-Object {$_.State -like 'Running'}`

`PS C:\> Get-CimInstance -ClassName Win32_Service | Select-Object Name, State, PathName | Where-Object {$_.State -like 'Running'}`

### 1.3 - Unquoted Service Paths

#### 1.3.1 - Command Prompt

- Manual services

`C:\> wmic service get name,displayname,startname,pathname,startmode 2>nul | findstr /i /v "c:\windows" 2>nul | findstr /i /v """`

- Auto services

`C:\> wmic service get name,startname,pathname,startmode 2>nul | findstr /i "auto" 2>nul | findstr /i /v "c:\windows" | findstr /i /v """`

`C:\> wmic service list brief`

#### 1.3.2 - Powershell

- Auto services

`PS C:\> gwmi -classname Win32_Service -Property Name, DisplayName, PathName, StartMode | Where {$_.StartMode -eq "Auto" -and $_.PathName -notlike "C:\Windows*" -and $_.PathName -notlike '"*'} | select PathName,DisplayName,Name`

`PS C:\> Get-CimInstance -classname Win32_Service -Property Name, DisplayName, PathName, StartMode | Where {$_.StartMode -eq "Auto" -and $_.PathName -notlike "C:\Windows*" -and $_.PathName -notlike '"*'} | Select-Object PathName,DisplayName,Name`

### 1.4 - Discover Services

#### 1.4.1 - Service Control Management

##### 1.4.1.1 - Command Prompt

- Listing all windows services with Service Control Management

`C:\> sc query`

`C:\> sc query type= service state= all`

`C:\> sc queryex type= service`

`C:\> net start`

##### 1.4.1.2 - Powershell

`PS C:\> get-service | fl`

`PS C:\> get-service | ? {?_.status -eq "running" }`

`PS C:\> get-service -computername <IP> | fl`

`C:\> wmic service get name,startname`

#### 1.4.2 - Startup Services

##### 1.4.2.1 - Command Prompt

- **Discover startup services**

`C:\> wmic startup service`

`C:\> wmic startup list full`

`C:\> wmic startup get caption,command`

`C:\> reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Run`

`C:\> reg query HKLM\Software\Microsoft\Windows\CurrentVersion\RunOnce`

`C:\> reg query HKCU\Software\Microsoft\Windows\CurrentVersion\Run`

`C:\> reg query HKCU\Software\Microsoft\Windows\CurrentVersion\RunOnce`

`C:\> dir "C:\Documents and Settings\All Users\Start Menu\Programs\Startup"`

`C:\> dir "C:\Documents and Settings\%username%\Start Menu\Programs\Startup"`

##### 1.4.2.2 - Powershell

- **Discover startup services**

`PS C:\> Get-CimInstance Win32_StartupCommand | select Name, command, Location, User | fl`

`PS C:\> Get-ItemProperty -Path 'Registry::HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run'`

`PS C:\> Get-ItemProperty -Path 'Registry::HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnce'`

`PS C:\> Get-ItemProperty -Path 'Registry::HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run'`

`PS C:\> Get-ItemProperty -Path 'Registry::HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnce'`

`PS C:\> Get-ChildItem "C:\Users\All Users\Start Menu\Programs\Startup"`

`PS C:\> Get-ChildItem "C:\Users\$env:USERNAME\Start Menu\Programs\Startup"`

## 02 - Impacket

### 2.1 - Discover Services

#### 2.1.1 - Service Control Management

##### 2.1.1.1 - Services

`$ services.py <domain_name>/<username>:<password>@<IP> list`

`$ services.py <domain_name>/<username>@<IP> -hashes :<nt_hash> list`

##### 2.1.1.2 - Wmiquery

`$ wmiquery.py <domain_name>/<username>:<password>@<IP>`

`$ wmiquery.py <domain_name>/<username>@<IP> -hashes :<nt_hash>`

`WQL> SELECT * FROM win32_service`

## 03 - Metasploit

```
meterpreter > run post/windows/gather/enum_services

meterpreter > run service_manager -h
Meterpreter Script for managing Windows Services.

OPTIONS:

    -C   Create Service, service will be set to auto start
    -c   Change Service StartUp. Default <Auto>
    -d   Display Name of Service
    -D   Delete Service
    -h   Help menu.
    -i   Get Service Information
    -K   Stop Service
    -l   List Services
    -n   Service Name
    -p   Service command
    -S   Start Service
    -s   Startup Parameter for service. Specify Auto, Manual or Disabled

meterpreter > service_enum

meterpreter > service_query <servicesvc>

meterpreter > service_control [start|pause|resume|stop|restart]
```

## References

- [Understanding SDDL Syntax](https://itconnect.uw.edu/wares/msinf/other-help/understanding-sddl-syntax/)

- [Windows Privilege Escalation Weak Permission](https://steflan-security.com/windows-privilege-escalation-weak-permission/)