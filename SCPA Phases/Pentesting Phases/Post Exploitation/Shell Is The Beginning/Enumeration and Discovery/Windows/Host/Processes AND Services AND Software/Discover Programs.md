# Discover Programs

## 01 - Manual

### 1.1 - Installed Programs

#### 1.1.1 - Command Prompt

- **List directories including hidden files and folders**

`C:\> dir /a "C:\Program Files"`

`C:\> dir /a "C:\Program Files (x86)"`

`C:\> reg query HKLM\SOFTWARE`

- **Find a specific program**

`C:\> dir /s /b c:\ | findstr "explorer.exe"`

`C:\> dir /s /b c:\ | findstr "jucheck.exe"`

`C:\> dir /s /b c:\ | findstr "iexplore.exe"`

- **Two ways to query via `reg.exe`**

`C:\> reg query hkey_local_machine\software`

`C:\> reg query hklm\software`

`C:\> wmic product get name,version,vendor`

`C:\> dir %windir%\Microsoft.NET\Framework64 /ad`

`C:\> dir /b %windir%\Microsoft.NET\Framework64\v*`

`C:\> wmic product get description | findstr /c:.NET`

#### 1.1.2 - Powershell

- **List directories including hidden files and folders**

`PS C:\> Get-ChildItem 'C:\Program Files','C:\Program Files (x86)' | ft Parent,Name,LastWriteTime`

`PS C:\> Get-ChildItem -Path Registry::HKEY_LOCAL_MACHINE\SOFTWARE | ft Name`

- **List the .MSI installation that isn't vendored by Microsoft**

`PS C:\> Get-CimInstance -Query "Select * FROM Win32_Product" | ? {?_.Vendor -Notmatch 'Microsoft'}`

`PS C:\> Get-Item C:\Windows\Microsoft.Net\Framework64\v4.0.30319\clr.dll | ft`

### 1.2 - Powershell and .NET

#### 1.2.1 - Command Prompt

- **Discover available Powershell engines**

`C:\> reg query hkey_local_machines\software\microsoft\powershell\1\powershellengine /v powershellversion`

`C:\> reg query hklm\software\microsoft\powershell\3\powershellengine /v powershellversion`

- **Discover Powershell Logging**

`C:\> reg query HKLM\SOFTWARE\Wow6432Node\Policies\Microsoft\Windows\Powershell\Transcription`

`C:\> reg query HKLM\SOFTWARE\Wow6432Node\Policies\Microsoft\Windows\PowerShell\ModuleLogging`

`C:\> reg query HKLM\SOFTWARE\Wow6432Node\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging`

- **Enumerate available Common Language Runtime (CLR) versions**

`C:\> dir %windir%\Microsoft.Net\Framework\ /s /b | find "System.dll"`

`C:\> reg query "HKLM\SOFTWARE\Microsoft\Net Framework Setup\NDP\v4\Full Release"`

#### 1.2.2 - Powershell

- **Discover available Powershell engines**

`PS C:\> Get-ItemPropertyValue HKLM:\software\microsoft\powershell\*\powershellengine -Name PowerShellVersion`

- **Enumerate available Common Language Runtime (CLR) versions**

`PS C:\> [System.IO.File]::Exists("$env:windir\Microsoft.Net\Framework\v2.0.50727\System.dll")`

`PS C:\> [System.IO.File]::Exists("$env:windir\Microsoft.Net\Framework\v4.0.30319\System.dll")`

### 1.3 - Device Drivers

#### 1.3.1 - Command Prompt

`C:\> driverquery.exe /fo list`

`C:\> driverquery.exe /fo table`

`C:\> driverquery.exe /v /fo list`

`C:\> driverquery.exe --no-msft`

`C:\> driverquery.exe /s <IP> /fo list`

`C:\> driverquery.exe /s <IP> /u <DOMAIN_NAME\username> /p <password> /fo list`

#### 1.3.2 - Powershell

- Filtering the installed 3rd party drivers with powershell cmdlet of `wmic` version yet very powerful (for example virtualization detection)

`PS C:\> driverquery.exe /v /fo csv | ConvertFrom-CSV | Select-Object 'Display Name', 'Start Mode', Path`

`PS C:\> Get-CimInstance Win32_PnPSignedDriver | Select-Object DeviceName, DriverVersion, Manufacturer | Where-Object {$_.DeviceName -like "*VMWare*"}`

```powershell
$VMAdapter = Get-CimInstance Win32_NetworkAdapter -Filter 'Manufacturer LIKE "%VMware%" OR Name LIKE "%VMWare%"'

$VMBios = Get-CimInstance Win32_BIOS -Filter 'SerialNumber LIKE "%VMWare%"'

$VMToolsRunning = Get-CimInstance Win32_Process -Filter 'Name="vmtoolsd.exe"'

[Bool]($VMAdapter -or $VMBios -or $VMToolsRunning)
```

### 1.4 - Antivirus and EDR

#### 1.4.1 - Command Prompt

- **Check Antivirus Programs**

`C:\> sc query windefend`

`C:\> wmic /node:localhost /namespace:\\root\securitycenter2 path antivirusproduct`

`C:\> wmic /node:localhost /namespace:\\root\securitycenter2 path antivirusproduct get displayname, productState, pathToSignedProductExe`

#### 1.4.2 - Powershell

- **Check Antivirus Programs**

`PS C:\> Get-MpComputerStatus`

`PS C:\> Get-CimInstance -Namespace root\securitycenter2 -Classname antivirusproduct`

`PS C:\> Get-CimInstance -Namespace root\SecurityCenter2 -Class AntiVirusProduct | Select-Object -Property displayname`

`PS C:\> Get-CimSession | Get-Avstatus | where {-Not $_.Uptodate}`

`PS C:\> Get-CimSession | Get-Avstatus | group Displayname | Select-Object Name,Count`

## 02 - SharpEDRChecker

`C:\> .\SharpEDRChecker.exe`

## References

- [Deep Dive into the Solorigate Second Stage Activation from Sunburst to Teardrop and Raindrop](https://www.microsoft.com/en-us/security/blog/2021/01/20/deep-dive-into-the-solorigate-second-stage-activation-from-sunburst-to-teardrop-and-raindrop/)

- [SharpEDRChecker](https://github.com/PwnDexter/SharpEDRChecker)