# Living off the Land

Search Tag(s): #post-exploitation #enumeration-and-discovery #living-off-the-land #windows

## 01 - Current User Enumeration

### 1.1 - Command Prompt

Note: The percent/modulus sign means for Windows operating systems it will echo out the variable (for example: `%VARIABLE%`) which is similar to bash script in Linux (for example: `$VARIABLE`)

Current user enumeration.

```
C:\> whoami

C:\> echo %USERNAME%
```

Retrieve user basic information.

```
C:\> net user %USERNAME%

C:\> net user <username>
```

Retrieves the user's SID.

```
C:\> whoami /user
```

Check the user's privileges.

```
C:\> whoami /priv

C:\> whoami /groups

C:\> whoami /all
```

### 1.2 - Powershell

```powershell
PS C:\> $Env:USERNAME

PS C:\> [Environment]::UserName

PS C:\> [Environment]::GetEnvironmentVariable('USERNAME')

PS C:\> [System.Security.Principal.WindowsIdentity]::GetCurrent().Name
```

Check the user's privileges.

```
PS C:\> Get-LocalUser

PS C:\> Get-LocalUser | Format-Table Name,Enabled,LastLogon
```

## 02 - Enumerate Usernames

### 2.1 - Command Prompt

```
C:\> net user

C:\> net users

C:\> wmic useraccount

C:\> wmic useraccount list

C:\> wmic useraccount get name,sid

C:\> wmic useraccount get /all

C:\> dir /b /ad "C:\Users\"
```

Windows XP and below.

```
C:\> dir /b /ad "C:\Documents and Settings\"
```

### 2.2 - Powershell

```
PS C:\> Get-CimInstance [-ComputerName <IP>] -ClassName Win32_UserAccount | Format-Table -AutoSize

PS C:\> Get-CimInstance [-ComputerName <IP>] -ClassName Win32_UserAccount -filter "LocalAccount=True" | Select-Object PSComputername, Name, Status, Disabled, AccountType, Lockout, PasswordRequired, PasswordChangeable

PS C:\> Get-ChildItem C:\Users -Force | Select-Object Name

PS C:\> Get-ChildItem \\<IP>\C$\Users -Force | Select-Object Name
```

TODO: Check these cmdlets one by one

```
PS C:\> Get-CimInstance [-ComputerName <IP>] -ClassName Win32_Account | Format-Table -AutoSize
```

```
PS C:\> Get-CimInstance [-ComputerName <IP>] -ClassName Win32_UserDesktop | Format-Table -AutoSize
```

## 03 - Local Groups

### 3.1 - Command Prompt

Enumerate local groups.

```
C:\> net localgroup
```

Enumerate current local group users.

```
C:\> net localgroup "<local_group_name>"

C:\> net localgroup "Administrators"
```

### 3.2 - Powershell

```
PS C:\> Get-CimInstance [-ComputerName <IP>] -ClassName Win32_Group | Format-Table -AutoSize
```

## 04 - Logged On Users

### 4.1 - Command Prompt

Gather logged-on local users.

```
C:\> quser

C:\> query user <username> [/server:<IP>]

C:\> net accounts
```

### 4.2 - Powershell

Gather logged-on local users.

```
PS C:\> Get-CimInstance [-ComputerName <IP>] -ClassName Win32_ComputerSystem | Select-Object Name

PS C:\> Get-WmiObject [-ComputerName <IP>] -ClassName Win32_ComputerSystem | Select-Object Name

PS C:\> Get-CimInstance [-ComputerName <IP>] -Query "SELECT * FROM Win32_LoggedOnUser" | ?{$_.LogonType -notmatch '(Service|Network|System)'}
```

## 05 - User Environment

### 5.1 - Command Prompt

Shows all current environmental variables. Specific ones to look for are `USERDOMAIN`, `USERNAME`, `USERPROFILE`, `HOMEPATH`, `LOGONSERVER`, `COMPUTERNAME`, `APPDATA`, and `ALLUSERPROFILE`.

```
C:\> set

C:\> reg query "HKLM\SYSTEM\CurrentControlSet\Control\Session Manager\Environment"
```

### 5.2 - Powershell

Shows all current environmental variables. Specific ones to look for are `USERDOMAIN`, `USERNAME`, `USERPROFILE`, `HOMEPATH`, `LOGONSERVER`, `COMPUTERNAME`, `APPDATA`, and `ALLUSERPROFILE`.

```
PS C:\> Get-ChildItem Env:

PS C:\> Get-ChildItem Env:* | Format-Table Key,Value

PS C:\> Get-ItemProperty "HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Environment"

PS C:\> [System.Environment]::GetEnvironmentVariables()
```

---
## References

- [Wikipedia: Environment Variable](https://en.wikipedia.org/wiki/Environment_variable)

- [CmdLine Scripts for Reverse TCP Shell Addicts](https://github.com/r00t-3xp10it/venom/wiki/CmdLine-%26-Scripts-for-reverse-TCP-shell-addicts)

- [The DFIR Report: Bazarloader to Conti Ransomware in 32 Hours](https://thedfirreport.com/2021/09/13/bazarloader-to-conti-ransomware-in-32-hours/)

- [Active Directory Domain Enumeration Part 1](https://nored0x.github.io/red-teaming/active-directory-domain-enumeration-part-1/)