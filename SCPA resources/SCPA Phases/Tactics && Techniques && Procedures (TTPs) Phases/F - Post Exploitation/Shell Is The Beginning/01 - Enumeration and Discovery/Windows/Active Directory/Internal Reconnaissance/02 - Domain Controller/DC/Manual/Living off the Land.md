# Living off the Land

Search Tag(s): #post-exploitation #enumeration-and-discovery #active-directory #living-off-the-land #windows

## 01 - Command Prompt

Enumerate the current domain controller.

```
C:\> set | find "USERDOMAIN"

C:\> echo %logonserver%

C:\> qwinsta /server:<IP>

C:\> wmic [/node:<IP>] path win32_groupuser where (groupcomponent="win32_group.name='domain admins', domain='<DOMAIN>'")

c:\> wmic [/node:<IP>] group list

C:\> wmic [/node:<IP>] ntdomain get domaincontrolleraddress,domainname,roles

C:\> wmic [/node:<IP>] /namespace:\\root\directory\ldap path ds_user get ds_samaccountname

C:\> wmic [/node:<IP>] /namespace:\\root\directory\ldap path ds_group get ds_samaccountname

C:\> wmic [/node:<IP>] /namespace:\\root\directory\ldap path ds_computer get ds_samaccountname

C:\> wmic [/node:<IP>] computersystem get domain
```

Using `csvde.exe` to enumerate the whole active directory network. If domain controller is not specified it'll use the current one to enumerate the network.

TODO: Provide more usage and use cases for `csvde`

Note: This only works on Windows Servers

```
C:\> csvde [-s <domain_controller_IP>] -f domain-network.csv

$ grep -oP '^:"CN=.*?,' domain-network.csv
```

### 1.1 - Sysnative

```
C:\> c:\windows\sysnative\nltest.exe /dclist:<domain>

C:\> nltest /dclist:

C:\> nltest /dclist:<domain_name>

C:\> nltest /dcname:<domain_name>

C:\> nltest /dcgetdc:<domain_name>

C:\> nltest /domain_trusts

C:\> nltest /domain_trusts /all_trusts

C:\> nltest /domain_trusts & nltest /dclist:&c:\windows\sysnative\nltest /domain_trusts & c:\windows\sysnative\nltest /dclist:<domain_name>
```

## 02 - Powershell

```
PS C:\> Get-ADComputer -Filter {Enabled -eq $true} -Properties * | Select-Object Name, DNSHostName, OperatingSystem, LastLogonDate, IPv4Address | Export-Csv C:\temp\AllWindows.csv -NoTypeInformation -Encoding UTF8
```

```
PS C:\> Write-Output $Env:USERDOMAIN
```

`PS C:\> Get-CimInstance -ClassName Win32_UserInDomain | Format-Table -AutoSize`

`PS C:\> Get-CimInstance -ClassName Win32_NTDomain | Format-Table -AutoSize`

```
PS C:\> Write-Output (Get-WmiObject -ClassName Win32_ComputerSystem).Domain

PS C:\> Write-Output (Get-CimInstance -ClassName Win32_ComputerSystem).Domain

PS C:\> [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()
```

TODO: Re-arrange them in Privilege Escalation section

- To enumerate Nested Groups in an active directory environment

`$ cat enumerateAD.ps1`

---

```powershell
$domainObj = [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()

$PDC = ($domainObj.PdcRoleOwner).Name

$SearchString = "LDAP://"

$SearchString = $PDC + "/"

$DistinguishedName = "DC=$($domainObj.Name.Replace('.', ',DC='))"

$SearchString += $DistinguishedName

$SearchString

$Searcher = New-Object System.DirectoryServices.DirectorySearcher([ADSI]$SearchString)

$objDomain = New-Object System.DirectoryServices.DirectoryEntry

$Searcher.SearchRoot = $objDomain

# property=value
# such as => name=<domain_username>
#$Searcher.filter = "samAccounType=805306368"

#$Searcher.FindAll()

#foreach($obj in $Result) {
#    foreach($prop in $obj.Properties) {
#        $prop
#    }
#    Write-Host "------------------------"
#}

# Enumerate each group member

# (property=value)
# such as => name=<Group_name>
#$Searcher.filter = "(objectClass=Group)"

#$Result = $Searcher.FindAll()

#foreach($obj in $Result) {
#    $obj.Properties.name
#}

$Searcher.filter = "(name=Domain Admins)"

$Output = $Searcher.FindAll()

foreach($obj in $Output) {
    $obj.Properties.member
}
```

- Retrieve SPN users that are possibly **kerberoastable** of the `samaccountname` and `serviceprincipalname`

`$ cat enumerateSPN.ps1`

---

```powershell
$domainObj = [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()

$PDC = ($domainObj.PdcRoleOwner).Name

$SearchString = "LDAP://"

$SearchString = $PDC + "/"

$DistinguishedName = "DC=$($domainObj.Name.Replace('.', ',DC='))"

$SearchString += $DistinguishedName

$SearchString

$Searcher = New-Object System.DirectoryServices.DirectorySearcher([ADSI]$SearchString)

$objDomain = New-Object System.DirectoryServices.DirectoryEntry

$Searcher.SearchRoot = $objDomain

$Searcher.filter = "serviceprincipalname=*http*"

$Result = $Searcher.FindAll()

foreach($obj in $Output) {
    foreach($prop in $obj.Properties) {
        $prop
    }
}
```

---
## References

- [Podalirius: Useful LDAP queries for Windows Active Directory pentesting](https://podalirius.net/en/articles/useful-ldap-queries-for-windows-active-directory-pentesting/)

- [The DFIR Report: PYSA/Mespinoza Ransomware](https://thedfirreport.com/2020/11/23/pysa-mespinoza-ransomware/)

- [Certcube: AD Recon for Beginners](https://blog.certcube.com/ad-recon-for-beginners/)

- [Active Directory Domain Enumeration Part 1](https://nored0x.github.io/red-teaming/active-directory-domain-enumeration-part-1/)

- [Mubix Post Exploitation Wiki: Active Directory Discovery and Enumeration](https://github.com/mubix/post-exploitation/blob/master/win32bins/activedirectory/readme.md)