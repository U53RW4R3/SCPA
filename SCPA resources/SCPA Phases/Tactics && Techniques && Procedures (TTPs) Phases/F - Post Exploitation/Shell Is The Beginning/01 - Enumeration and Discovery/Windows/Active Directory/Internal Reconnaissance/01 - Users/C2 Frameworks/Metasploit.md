# Metasploit

Search Tag(s): #post-exploitation #enumeration-and-discovery #active-directory #metasploit-framework #network-protocols #msrpc #smb #windows

## 01 - Modules

### 1.1 - Auxiliary



#### 1.1.2 - SMB Network Protocol

```
msf > use auxiliary/scanner/smb/smb_enumusers

msf auxiliary(scanner/smb/smb_enumusers) > options

Module options (auxiliary/scanner/smb/smb_enumusers):

   Name          Current Setting  Required  Description
   ----          ---------------  --------  -----------
   DB_ALL_USERS  false            no        Add all enumerated usernames to the database
   RHOSTS                         yes       The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/Using-Metasploit
   SMBDomain     .                no        The Windows domain to use for authentication
   SMBPass                        no        The password for the specified username
   SMBUser                        no        The username to authenticate as
   THREADS       1                yes       The number of concurrent threads (max one per host)

msf auxiliary(scanner/smb/smb_enumusers) > set smbuser <username>

msf auxiliary(scanner/smb/smb_enumusers) > set smbpass <password | aad3b435b51404eeaad3b435b51404ee:<nt_hash>>

msf auxiliary(scanner/smb/smb_enumusers) > set rhosts <IP>

msf auxiliary(scanner/smb/smb_enumusers) > set smbdomain [<domain>]

msf auxiliary(scanner/smb/smb_enumusers) > set threads 4

msf auxiliary(scanner/smb/smb_enumusers) > run
```

TODO: Fill this info

- Metasploit auxiliary bruteforce users via SID lookups

```
msf > use auxiliary/scanner/smb/smb_lookupsid

msf auxiliary(scanner/smb/smb_lookupsid) > show actions 

Auxiliary actions:

       Name    Description
       ----    -----------
       DOMAIN  Enumerate domain accounts
   =>  LOCAL   Enumerate local accounts

msf auxiliary(scanner/smb/smb_lookupsid) > options

Module options (auxiliary/scanner/smb/smb_lookupsid):

   Name       Current Setting  Required  Description
   ----       ---------------  --------  -----------
   MaxRID     4000             no        Maximum RID to check
   MinRID     500              no        Starting RID to check
   RHOSTS                      yes       The target host(s), see https://docs.metasploit.com/docs/using-metasploit/basics/using-metasploit.html
   SMBDomain  .                no        The Windows domain to use for authentication
   SMBPass                     no        The password for the specified username
   SMBUser                     no        The username to authenticate as
   THREADS    1                yes       The number of concurrent threads (max one per host)


Auxiliary action:

   Name   Description
   ----   -----------
   LOCAL  Enumerate local accounts



View the full module info with the info, or info -d command.

msf auxiliary(scanner/smb/smb_lookupsid) > set smbuser <username>

msf auxiliary(scanner/smb/smb_lookupsid) > set smbpass <password | aad3b435b51404eeaad3b435b51404ee:<nt_hash>>

msf auxiliary(scanner/smb/smb_lookupsid) > set smbdomain [<domain>]

msf auxiliary(scanner/smb/smb_lookupsid) > set action <LOCAL | DOMAIN>

msf auxiliary(scanner/smb/smb_lookupsid) > set rhosts <target_IP>

msf auxiliary(scanner/smb/smb_lookupsid) > set minrid <min_id_range>

msf auxiliary(scanner/smb/smb_lookupsid) > set maxrid <max_id_range>

msf auxiliary(scanner/smb/smb_lookupsid) > set threads 2

msf auxiliary(scanner/smb/smb_lookupsid) > run
```

### 1.2 - Post

```
meterpreter > ls C:/Users/

meterpreter > ls //<IP>/C$/Users/
```

run post/windows/gather/enum_domain

run post/windows/gather/enum_tokens

run post/windows/gather/enum_domain_tokens

run post/windows/gather/credentials/enum_laps

```
msf > use post/windows/gather/enum_domain_group_users

msf post(windows/gather/enum_domain_group_users) > options

Module options (post/windows/gather/enum_domain_group_users):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   GROUP                     yes       Domain Group to enumerate
   SESSION                   yes       The session to run this module on

msf post(windows/gather/enum_domain_group_users) > set group <domain_group>

msf post(windows/gather/enum_domain_group_users) > set session <session_id>

msf post(windows/gather/enum_domain_group_users) > exploit
```

- One liner

```
meterpreter > run post/windows/gather/enum_domain_group_users group="Domain Admins"

meterpreter > run post/windows/gather/enum_domain_group_users group="Enterprise Admins"
```

TODO: Fill this info

- LDAP query

```
meterpreter > run post/windows/gather/enum_ad_groups

meterpreter > run post/windows/gather/enum_ad_managedby_groups

meterpreter > run post/windows/gather/enum_ad_to_wordlist

meterpreter > run post/windows/gather/enum_ad_user_comments

meterpreter > run post/windows/gather/enum_ad_users
```

- Bitlocker

```
metepreter > run post/windows/gather/enum_ad_bitlocker
```

## 06 - RPC Endpoints

#### 1.1.1 - MSRPC Network Protocol

- Metasploit auxiliary module Endpoint Mapper Service Discovery

```
msf > use auxiliary/scanner/dcerpc/endpoint_mapper

msf auxiliary(scanner/dcerpc/endpoint_mapper) > options

Module options (auxiliary/scanner/dcerpc/endpoint_mapper):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   RHOSTS                    yes       The target host(s), see https://docs.metasploit.com/docs/using-metasploit/basics/using-metasploit.html
   RPORT    135              yes       The target port (TCP)
   THREADS  1                yes       The number of concurrent threads (max one per host)


View the full module info with the info, or info -d command.

msf auxiliary(scanner/dcerpc/endpoint_mapper) > set threads 8

msf auxiliary(scanner/dcerpc/endpoint_mapper) > set rhosts <IP>

msf auxiliary(scanner/dcerpc/endpoint_mapper) > run
```

- Metasploit auxiliary module Hidden DCERPC Service Discovery

```
msf > use auxiliary/scanner/dcerpc/hidden

msf auxiliary(scanner/dcerpc/hidden) > options

Module options (auxiliary/scanner/dcerpc/hidden):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   RHOSTS                    yes       The target host(s), see https://docs.metasploit.com/docs/using-metasploit/basics/using-metasploit.html
   THREADS  1                yes       The number of concurrent threads (max one per host)


View the full module info with the info, or info -d command.

msf auxiliary(scanner/dcerpc/hidden) > set threads 2

msf auxiliary(scanner/dcerpc/hidden) > set rhosts <IP>

msf auxiliary(scanner/dcerpc/hidden) > run
```

- Metasploit auxiliary module Remote Management Interface Discovery

```
msf > use auxiliary/scanner/dcerpc/management

msf auxiliary(scanner/dcerpc/management) > options

Module options (auxiliary/scanner/dcerpc/management):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   RHOSTS                    yes       The target host(s), see https://docs.metasploit.com/docs/using-metasploit/basics/using-metasploit.html
   RPORT    135              yes       The target port (TCP)
   THREADS  1                yes       The number of concurrent threads (max one per host)


View the full module info with the info, or info -d command.

msf auxiliary(scanner/dcerpc/management) > set threads 2

msf auxiliary(scanner/dcerpc/management) > set rhosts <IP>

msf auxiliary(scanner/dcerpc/management) > run
```

- Metasploit auxiliary module Remote Management Interface Discovery

```
msf > use auxiliary/scanner/dcerpc/tcp_dcerpc_auditor

msf auxiliary(scanner/dcerpc/tcp_dcerpc_auditor) > options

Module options (auxiliary/scanner/dcerpc/tcp_dcerpc_auditor):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   RHOSTS                    yes       The target host(s), see https://docs.metasploit.com/docs/using-metasploit/basics/using-metasploit.html
   RPORT    135              yes       The target port (TCP)
   THREADS  1                yes       The number of concurrent threads (max one per host)


View the full module info with the info, or info -d command.

msf auxiliary(scanner/dcerpc/tcp_dcerpc_auditor) > set threads 2

msf auxiliary(scanner/dcerpc/tcp_dcerpc_auditor) > set rhosts <IP>

msf auxiliary(scanner/dcerpc/tcp_dcerpc_auditor) > run
```

---
## References

- [Rapid7: Metasploit Framework Enumerate Domain Controller Gather Post Module](https://github.com/rapid7/metasploit-framework/blob/master/documentation/modules/post/windows/gather/enum_domain.md)

- [Rapid7: Metasploit Framework Enumerate Tokens Gather Post Module](https://github.com/rapid7/metasploit-framework/blob/master/documentation/modules/post/windows/gather/enum_tokens.md)