# WinAPI

## Python

### `pywin32`

```python
import ctypes
import os
import pythoncom
import win32con
import win32security
import win32com.client

LOGON32_LOGON_INTERACTIVE = win32con.LOGON32_LOGON_INTERACTIVE
LOGON32_PROVIDER_DEFAULT = win32con.LOGON32_PROVIDER_DEFAULT

ImpersonateLoggedOnUser = win32security.ImpersonateLoggedOnUser
RevertToSelf = win32security.RevertToSelf

CoInitialize = pythoncom.CoInitialize

wmi = win32com.client.GetObject("winmgmts:")

def get_token(username, password, domain=None):
    if domain:
        user = f"{domain}\\{username}"
    else:
        user = username

    try:
        token = win32security.LogonUser(
            user,
            domain,
            password,
            LOGON32_LOGON_INTERACTIVE,
            LOGON32_PROVIDER_DEFAULT
        )
        return token
    except Exception as e:
        print(f"Error getting token: {str(e)}")
        return None

def impersonate(token) -> bool:
    try:
        ImpersonateLoggedOnUser(token)
    except Exception as e:
        print(f"Error impersonating: {str(e)}")
        return False
    return True

def revert_to_self(token) -> bool:
    try:
        RevertToSelf()
    except Exception as e:
        print(f"Error reverting to self: {str(e)}")
        return False

def main():
    username = "Administrator"
    password = ""
    domain = None

    token = get_token(username, password, domain)

    if token:
        if impersonate(token):
            try:
                CoInitialize()
                for process in wmi.InstancesOf("Win32_Process")
                    print(f"Process Name: {process.Name}")

                CoInitialize()
            except Exception as e:
                print(f"Impersonation failed")

if __name__ == "__main__":
    main()
```

---
## References

### DMCXBlue

- [DMCXBlue: Create Process with Token](https://dmcxblue.gitbook.io/red-team-notes-2-0/red-team-techniques/privilege-escalation/t1134-access-token-manipulation/create-process-with-token)