---
author(s):
  - Userware
tags:
  - post-exploitation
  - enumeration-and-discovery
  - metasploit-framework
  - windows
---
# Metasploit

## 01 - Current User Enumeration

Discover current username.

```
meterpreter > getuid
```

Using interactive ruby shell to retrieve current username.

```
meterpreter > irb
>> client.sys.config.getuid
```

Check the user's privileges

```
meterpreter > getprivs

meterpreter > run post/windows/gather/win_privs
```

Enumerate local username is an administrator.

```
meterpreter > irb
>> client.railgun.shell32.IsUserAnAdmin()
```

Discover username's current SID

```
meterpreter > getsid
```

Using interactive ruby shell to retrieve current SID.

```
meterpreter > irb
>> client.sys.config.getsid
```

## 02 - Enumerate usernames

### 2.1 - SMB Port

```
msf > use auxiliary/scanner/smb/smb_enumusers

msf auxiliary(scanner/smb/smb_enumusers) > options

Module options (auxiliary/scanner/smb/smb_enumusers):

   Name          Current Setting  Required  Description
   ----          ---------------  --------  -----------
   DB_ALL_USERS  false            no        Add all enumerated usernames to the database
   RHOSTS                         yes       The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/Using-Metasploit
   SMBDomain     .                no        The Windows domain to use for authentication
   SMBPass                        no        The password for the specified username
   SMBUser                        no        The username to authenticate as
   THREADS       1                yes       The number of concurrent threads (max one per host)

msf auxiliary(scanner/smb/smb_enumusers) > set smbuser <username>

msf auxiliary(scanner/smb/smb_enumusers) > set smbpass <password | aad3b435b51404eeaad3b435b51404ee:<nt_hash>>

msf auxiliary(scanner/smb/smb_enumusers) > set rhosts <IP>

msf auxiliary(scanner/smb/smb_enumusers) > set smbdomain [<domain>]

msf auxiliary(scanner/smb/smb_enumusers) > set threads 4

msf auxiliary(scanner/smb/smb_enumusers) > run
```

### 2.2 - Interactive Session

Enumerate usernames from a directory (OPSEC safe).

```
meterpreter > ls C:/Users/

meterpreter > ls //<IP>/C$/Users/
```

## 02 - User Environment

### 2.1 - Modules

#### 2.1.1 - Post

```
msf > use post/multi/gather/env

msf post(multi/gather/env) > options

Module options (post/multi/gather/env):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SESSION                   yes       The session to run this module on

msf post(multi/gather/env) > set session <session_ID>

msf post(multi/gather/env) > run
```

### 2.2 - Meterpreter

```
meterpreter > run post/multi/gather/env

meterpreter > run post/windows/gather/enum_powershell_env
```

## 03 - Logged On Users

```
meterpreter > run post/windows/gather/enum_logged_on_users
```

Enumerate RDP sessions.

```
meterpreter > run post/windows/gather/enum_termserv
```

## 04 - User enumeration via RID Cycling

```
msf > use auxiliary/scanner/smb/smb_lookupsid

msf auxiliary(scanner/smb/smb_lookupsid) > show actions 

Auxiliary actions:

       Name    Description
       ----    -----------
       DOMAIN  Enumerate domain accounts
   =>  LOCAL   Enumerate local accounts

msf auxiliary(scanner/smb/smb_lookupsid) > options

Module options (auxiliary/scanner/smb/smb_lookupsid):

   Name    Current Setting  Required  Description
   ----    ---------------  --------  -----------
   MaxRID  4000             no        Maximum RID to check
   MinRID  500              no        Starting RID to check


   Used when making a new connection via RHOSTS:

   Name       Current Setting  Required  Description
   ----       ---------------  --------  -----------
   RHOSTS                      no        The target host(s), see https://docs.metasploit.com/docs/using-metasploit/basics/using-metasploit.html
   SMBDomain  .                no        The Windows domain to use for authentication
   SMBPass                     no        The password for the specified username
   SMBUser                     no        The username to authenticate as
   THREADS    1                yes       The number of concurrent threads (max one per host)


   Used when connecting via an existing SESSION:

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SESSION                   no        The session to run this module on


Auxiliary action:

   Name   Description
   ----   -----------
   LOCAL  Enumerate local accounts



View the full module info with the info, or info -d command.

msf auxiliary(scanner/smb/smb_lookupsid) > set action local

msf auxiliary(scanner/smb/smb_lookupsid) > set smbuser <username>

msf auxiliary(scanner/smb/smb_lookupsid) > set smbpass <password | aad3b435b51404eeaad3b435b51404ee:<nt_hash>>

msf auxiliary(scanner/smb/smb_lookupsid) > set smbdomain [<domain>]

msf auxiliary(scanner/smb/smb_lookupsid) > set rhosts <target_IP>

msf auxiliary(scanner/smb/smb_lookupsid) > set minrid <min_id_range>

msf auxiliary(scanner/smb/smb_lookupsid) > set maxrid <max_id_range>

msf auxiliary(scanner/smb/smb_lookupsid) > set threads 2

msf auxiliary(scanner/smb/smb_lookupsid) > run
```

## 05 - All in one go

```
meterpreter > run winenum
```