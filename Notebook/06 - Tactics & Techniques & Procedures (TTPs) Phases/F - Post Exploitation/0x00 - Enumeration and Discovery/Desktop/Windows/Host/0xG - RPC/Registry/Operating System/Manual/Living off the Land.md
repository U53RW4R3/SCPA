# Living off the Land

## 01 - Command Prompt

### 1.1 - Kernel

```
C:\> reg.exe query "[\\<IP>\]HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion" /v ProductName

C:\> reg.exe query "[\\<IP>\]HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion" /v Installdate

C:\> reg.exe query "[\\<IP>\]HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion" /v RegisteredOwner
```

### 1.2 - System

#### 1.2.1 - Hostname

```
C:\> reg.exe query [\\<IP>\]HKLM\SYSTEM\CurrentControlSet\Control\ComputerName\ComputerName

C:\> reg.exe query [\\<IP>\]HKLM\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters /v Hostname
```

#### 1.2.2 - Date and Time

```
C:\> reg.exe query [\\<IP>\]HKLM\SYSTEM\CurrentControlSet\Control\TimeZoneInformation
```

TODO: Check these registry entries one by one.

```
C:\> reg.exe query [\\<IP>\]HKLM\SYSTEM\CurrentControlSet\Services\W32Time\Config\LastClockRate

HKLM\SYSTEM\CurrentControlSet\Services\W32Time
HKLM\SYSTEM\CurrentControlSet\Services\W32Time\Config
HKLM\SYSTEM\CurrentControlSet\Services\W32Time\Parameters
HKLM\SYSTEM\CurrentControlSet\Services\W32Time\TimeProviders\NtpClient
HKLM\SYSTEM\CurrentControlSet\Services\W32Time\TimeProviders\NtpServer
```

#### 1.2.3 - Windows Product Key

^a280e5

```
C:\> reg.exe query "[\\<IP>\]HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\SoftwareProtectionPlatform" /t REG_SZ /v BackupProductKeyDefault
```

#### 1.2.4 - Security Restrictions

> [!INFO]
> If registry's value is set to `0x00`. Execute PsExec as `NT AUTHORITY\SYSTEM`.

```
C:\> reg.exe query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /v EnableLUA
```

```
https://web.archive.org/web/20240317074756/https://notes.offsec-journey.com/privilege-escalation/local-privilege-escalation

ConsentPromptBehaviorAdmin

PromptOnSecureDesktop
```

### 1.3 - Hardware Information

#### 1.3.1 - Mounted Drives

Check if there are external USB drives history activity to the workstation. This will provide leverage to insert malware to spread the infection or possibly to exfiltrate data.

```
C:\> reg.exe query [\\<IP>\]HKLM\SYSTEM\CurrentControlSet\Control\DeviceClasses\{53f56307-b6bf-11d0-94f2-00a0c91efb8b} /s
```

- Find Serial # to obtain the Drive Letter of the USB device
- Find Serial # to obtain the Volume GUID of the USB device

```
C:\> reg.exe query [\\<IP>\]HKLM\SYSTEM\MountedDevices
```

USB Times:
- First time device is connected
- Last time device is connected
- Removal time

```
C:\> reg.exe query [\\<IP>\]HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Mountpoints2
```

```
C:\> reg.exe query [\\<IP>\]HKLM\SYSTEM\CurrentControlSet\Enum\USB

C:\> reg.exe query [\\<IP>\]HKLM\SYSTEM\CurrentControlSet\Enum\USBSTOR
```

```
C:\> reg.exe query "[\\<IP>\]HKLM\SYSTEM\CurrentControlSet\Enum\USBSTOR\Ven_Prod_Version\USB iSerial"

#\Properties\{83da6326-97a6-4088-9453-a1923f573b29}\####
```

#### 1.3.2 - CPU

Retrieving the number of CPU cores and threads.

```
C:\> reg.exe query [\\<IP>\]HKLM\HARDWARE\DESCRIPTION\System\CentralProcessor\* /v ProcessNameString
```

## 02 - PowerShell

### 2.1 - Kernel

```
PS C:\> Get-ItemProperty "HKLM:SOFTWARE\Microsoft\Windows NT\CurrentVersion" -Name ProductName
```

### 2.2 - System

#### 2.2.1 - Hostname

Computer name.

```
PS C:\> Get-ItemProperty Registry::HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\ComputerName\ComputerName

PS C:\> Get-ItemProperty Registry::HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters -Value Hostname
```

#### 2.2.2 - Date and Time

```
PS C:\> Get-ItemProperty Registry::HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\TimeZoneInformation
```

TODO: Check these registry entries one by one.

```
PS C:\> Get-ItemProperty Registry::HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\W32Time\Config\LastClockRate

HKLM\SYSTEM\CurrentControlSet\Services\W32Time
HKLM\SYSTEM\CurrentControlSet\Services\W32Time\Config
HKLM\SYSTEM\CurrentControlSet\Services\W32Time\Parameters
HKLM\SYSTEM\CurrentControlSet\Services\W32Time\TimeProviders\NtpClient
HKLM\SYSTEM\CurrentControlSet\Services\W32Time\TimeProviders\NtpServer
```

#### 2.2.3 - Windows Product Key

```
PS C:\> Get-ItemProperty -Path 'Registry::HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\SoftwareProtectionPlatform' -Type "String" -Value "BackupProductKeyDefault"
```

#### 2.2.4 - Security Restrictions

> [!INFO]
> If registry's value is set to `0x00`. Execute PsExec as `NT AUTHORITY\SYSTEM`.

```
PS C:\> Get-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" -Name EnableLUA
```

```
https://web.archive.org/web/20240317074756/https://notes.offsec-journey.com/privilege-escalation/local-privilege-escalation

ConsentPromptBehaviorAdmin

PromptOnSecureDesktop
```

### 2.3 - Hardware Information

#### 2.3.1 - Mounted Drives

Check if there are external USB drives history activity to the workstation. This will provide leverage to insert malware to spread the infection or possibly to exfiltrate data.

```
PS C:\> Get-ItemProperty HKLM:\SYSTEM\CurrentControlSet\Control\DeviceClasses\{53f56307-b6bf-11d0-94f2-00a0c91efb8b}\*
```

- Find Serial # to obtain the Drive Letter of the USB device
- Find Serial # to obtain the Volume GUID of the USB device

```
PS C:\> Get-ItemProperty HKLM:\SYSTEM\MountedDevices
```

USB Times:
- First time device is connected
- Last time device is connected
- Removal time

```
PS C:\> Get-ItemProperty HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Mountpoints2
```

```
PS C:\> Get-ItemProperty HKLM:\SYSTEM\CurrentControlSet\Enum\USB

PS C:\> Get-ItemProperty HKLM:\SYSTEM\CurrentControlSet\Enum\USBSTOR
```

Gather USB names.

```
PS C:\> Get-ItemProperty -Path HKLM:\SYSTEM\CurrentControlSet\Enum\USBSTOR\*\* | Select-Object FriendlyName

PS C:\> Invoke-Command -ComputerName <IP> [-Credential $credentials] -ScriptBlock { Get-ItemProperty -Path HKLM:\SYSTEM\CurrentControlSet\Enum\USBSTOR\*\* | Select-Object FriendlyName }
```

```
PS C:\> Get-ItemProperty HKLM:\SYSTEM\CurrentControlSet\Enum\USBSTOR\Ven_Prod_Version\USB iSerial

#\Properties\{83da6326-97a6-4088-9453-a1923f573b29}\####
```

#### 2.3.2 - CPU

```
PS C:\> Get-ItemProperty HKLM:\HARDWARE\DESCRIPTION\System\CentralProcessor\*
```

---
## References

### PDQ

- [PDQ: Powershell Guide Get CimInstance and Get WMIObject](https://www.pdq.com/blog/powershell-guide-get-ciminstance-and-get-wmiobject/)

### LOFLCAB

- [LOFLCAB: quser](https://lofl-project.github.io/loflcab/Binaries/quser/)

- [LOFLCAB: Get-NetAdapter](https://lofl-project.github.io/loflcab/Cmdlets/Get-NetAdapter/)

### Hacking Articles

- [Hacking Articles: Post Exploitation Using WMIC (System Command)](https://www.hackingarticles.in/post-exploitation-using-wmic-system-command/)

### 13cubed

- [13cubed: Windows Registry Cheat Sheet](https://13cubed.s3.amazonaws.com/downloads/windows_registry_cheat_sheet.pdf)