---
author(s):
  - Userware
tags:
  - post-exploitation
  - enumeration-and-discovery
  - living-off-the-land
  - T1047
  - windows
---
# Living off the Land

## 01 - Command Prompt

### 1.1 - Hardware Information

TODO: Convert it to `wmic`

#### 1.1.3 - Mounted Drives

Enumerate for mounted and unmounted drives

```
C:\> mountvol.exe

C:\> vol

C:\> fsutil.exe fsInfo drives
```

TODO: Inspect the module and convert into commands

Check if there are external USB drives history activity to the workstation. This will provide leverage to insert malware to spread the infection or possibly to exfiltrate data.

```
meterpreter > run post/windows/gather/usb_history
```

- Find Serial # to obtain the Drive Letter of the USB device
- Find Serial # to obtain the Volume GUID of the USB device

```
C:\> reg.exe query [\\<IP>\]HKLM\SYSTEM\MountedDevices
```

USB Times:
- First time device is connected
- Last time device is connected
- Removal time

```
C:\> reg.exe query [\\<IP>\]HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Mountpoints2
```

```
C:\> reg.exe query [\\<IP>\]HKLM\SYSTEM\CurrentControlSet\Enum\USB

C:\> reg.exe query [\\<IP>\]HKLM\SYSTEM\CurrentControlSet\Enum\USBSTOR
```

```
C:\> reg.exe query "[\\<IP>\]HKLM\SYSTEM\CurrentControlSet\Enum\USBSTOR\Ven_Prod_Version\USB iSerial"

#\Properties\{83da6326-97a6-4088-9453-a1923f573b29}\####
```

Display information of the storage size.

```
C:\> wmic.exe [/node:<IP>] [/user:<username> /password:<password>] path win32_logicaldisk get caption, filesystem, freespace, size, volumename

C:\> wmic.exe [/node:<IP>] [/user:<username> /password:<password>] logicaldisk where drivetype=3 get name, freespace, systemname, filesystem, size, volumeserialnumber

C:\> wmic.exe [/node:<IP>] [/user:<username> /password:<password>] volume list

C:\> wmic.exe [/node:<IP>] [/user:<username> /password:<password>] volume list brief
```

Display mounted drives.

```
C:\> wmic.exe [/node:<IP>] [/user:<username> /password:<password>] logicaldisk get name

C:\> wmic.exe [/node:<IP>] [/user:<username> /password:<password>] logicaldisk get caption

C:\> wmic.exe [/node:<IP>] [/user:<username> /password:<password>] diskdrive list

C:\> wmic.exe [/node:<IP>] [/user:<username> /password:<password>] diskdrive list brief
```

#### 1.1.4 - MAC Addresses

```
C:\> wmic.exe [/node:<IP>] [/user:<username> /password:<password>]
```

#### 1.1.5 - Motherboard

```
C:\> wmic.exe [/node:<IP>] [/user:<username> /password:<password>] bios

C:\> wmic.exe [/node:<IP>] [/user:<username> /password:<password>] bios get serialnumber

C:\> wmic.exe [/node:<IP>] [/user:<username> /password:<password>] baseboard get Manufacturer, Product, SerialNumber, Version
```

#### 1.1.6 - Hardware Model

```
C:\> wmic.exe [/node:<IP>] [/user:<username> /password:<password>] csproduct get name
```

#### 1.1.7 - CPU

Retrieving the number of CPU cores and threads.

```
C:\> wmic.exe [/node:<IP>] [/user:<username> /password:<password>] cpu get deviceid, numberofcores, numberoflogicalprocessors

C:\> wmic.exe [/node:<IP>] [/user:<username> /password:<password>] cpu list full
```

#### 1.1.8 - RAM

```
C:\> wmic.exe [/node:<IP>] [/user:<username> /password:<password>]

PS C:\> SELECT TotalPhysicalMemory FROM Win32_ComputerSystem
```

### 1.2 - Printers

```
C:\> wmic.exe [/node:<IP>] [/user:<username> /password:<password>] printer list brief
```

## 02 - PowerShell

### 2.1 - Hardware Information

#### 2.1.3 - Mounted Drives

Display mounted drives.

TODO: Inspect the module and convert into cmdlets

```
C:\> wmic.exe [/node:<IP>] [/user:<username> /password:<password>] logicaldisk get name

C:\> wmic.exe [/node:<IP>] [/user:<username> /password:<password>] logicaldisk get caption

C:\> wmic.exe [/node:<IP>] [/user:<username> /password:<password>] diskdrive list

C:\> wmic.exe [/node:<IP>] [/user:<username> /password:<password>] diskdrive list brief
```

Display information of the storage size.

```
PS C:\> Get-CimInstance -ClassName Win32_LogicalDisk

PS C:\> Get-WmiObject -ClassName Win32_LogicalDisk
```

Check if there are external USB drives history activity to the workstation. This will provide leverage to insert malware to spread the infection or possibly to exfiltrate data.

```
meterpreter > run post/windows/gather/usb_history
```

- Find Serial # to obtain the Drive Letter of the USB device
- Find Serial # to obtain the Volume GUID of the USB device

```
C:\> reg.exe query HKLM\SYSTEM\MountedDevices
```

USB Times:
- First time device is connected
- Last time device is connected
- Removal time

```
C:\> reg.exe query HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Mountpoints2
```

```
C:\> reg.exe query HKLM\SYSTEM\CurrentControlSet\Enum\USB

C:\> reg.exe query HKLM\SYSTEM\CurrentControlSet\Enum\USBSTOR
```

```
C:\> reg.exe query HKLM\SYSTEM\CurrentControlSet\Enum\USBSTOR\Ven_Prod_Version\USB iSerial
#\Properties\{83da6326-97a6-4088-9453-a1923f573b29}\####
```

#### 2.1.4 - MAC Addresses

- Basic hardware information

```
PS C:\> Get-CimInstance Win32_Processor | Format-List -AutoSize
```

#### 2.1.5 - Motherboard

Motherboard (The namespace is CIMV2)

```
PS C:\> Get-CimInstance -ClassName Win32_NetworkAdapterConfiguration -Filter "IPEnabled = $true"

PS C:\> Get-WmiObject [-ComputerName <IP>] -ClassName Win32_NetworkAdapterConfiguration -Filter "IPEnabled = $true"

PS C:\> Get-CimInstance [-ComputerName <IP>] -Query "SELECT * FROM Win32_NetworkAdapterConfiguration WHERE IPEnabled = True" | Where-Object {$_.Name -notlike "svchost*"} | Select Name, Handle, @{Label="Owner";Expression={$_.GetOwner().User}} | Format-Table -AutoSize

PS C:\> Get-WmiObject [-ComputerName <IP>] -Query "SELECT * FROM Win32_NetworkAdapterConfiguration WHERE IPEnabled = True" | Where-Object {$_.Name -notlike "svchost*"} | Select Name, Handle, @{Label="Owner";Expression={$_.GetOwner().User}} | Format-Table -AutoSize

PS C:\> Get-CimInstance [-ComputerName <IP>] -Query "SELECT SerialNumber FROM Win32_BIOS" | Where-Object {$_.Name -notlike "svchost*"} | Select Name, Handle, @{Label="Owner";Expression={$_.GetOwner().User}} | Format-Table -AutoSize

PS C:\> Get-WmiObject [-ComputerName <IP>] -Query "SELECT SerialNumber FROM Win32_BIOS" | Where-Object {$_.Name -notlike "svchost*"} | Select Name, Handle, @{Label="Owner";Expression={$_.GetOwner().User}} | Format-Table -AutoSize

PS C:\> Get-CimInstance [-ComputerName <IP>] -ClassName Win32_NetworkAdapterConfiguration | Format-Table -Property Name,NetConnectionStatus -AutoSize

PS C:\> Get-WmiObject [-ComputerName <IP>] -ClassName Win32_NetworkAdapterConfiguration | Format-Table -Property Name,NetConnectionStatus -AutoSize

PS C:\> Get-CimInstance [-ComputerName <IP>] -ClassName Win32_NetworkAdapterConfiguration -Filter "NetConnectionStatus = 2" | Format-List -Property [a-z]\*

PS C:\> Get-WmiObject [-ComputerName <IP>] -ClassName Win32_NetworkAdapterConfiguration -Filter "NetConnectionStatus = 2" | Format-List -Property [a-z]\*
```

```
C:\> wmic.exe [/node:<IP>] [/user:<username> /password:<password>] baseboard get manufacturer

C:\> wmic.exe [/node:<IP>] [/user:<username> /password:<password>] cpu list full
```

#### 2.1.6 - Hardware Model

```
C:\> wmic.exe [/node:<IP>] [/user:<username> /password:<password>] csproduct get name

Computer Model: SELECT Model FROM Win32_ComputerSystem

Part Number: SELECT PartNumber FROM Win32_SystemEnclosure

Asset Tag: SELECT SMBIOSAssetTag FROM Win32_SystemEnclosure
```

#### 2.1.7 - CPU

```
PS C:\> SELECT Name FROM Win32_Processor
```

#### 2.1.8 - RAM

```
PS C:\> SELECT TotalPhysicalMemory FROM Win32_ComputerSystem -Name ProcessNameString
```

#### 2.1.9 - Monitors

```
PS C:\> SELECT * FROM WmiMonitorID
```

### 2.2 - Printers

```
C:\> wmic.exe [/node:<IP>] [/user:<username> /password:<password>] printer list brief
```

---
## References

### Backlinks

- [[06 - Tactics & Techniques & Procedures (TTPs) Phases/F - Post Exploitation/0x00 - Enumeration and Discovery/Desktop/Windows/Host/0xF - Operating System/Hardware/Manual/Living off the Land|Enumeration and Discovery: Windows Hardware]]

### CyberITHub

- [CyberITHub: 20 Useful WMIC Command Examples in Windows Cheatsheet](https://www.cyberithub.com/20-useful-wmic-command-examples-in-windows-cheat-sheet/)