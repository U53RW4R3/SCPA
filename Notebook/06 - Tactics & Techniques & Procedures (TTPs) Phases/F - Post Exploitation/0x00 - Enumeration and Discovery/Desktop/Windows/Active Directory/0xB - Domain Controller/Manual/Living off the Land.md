---
author(s):
  - Userware
tags:
  - post-exploitation
  - enumeration-and-discovery
  - active-directory
  - living-off-the-land
  - windows
---
# Living off the Land

## 01 - Enumerate Domain Controllers

### 1.1 - Command Prompt

Enumerate the current domain controller.

```
C:\> set | find.exe "USERDOMAIN"

C:\> qwinsta.exe /server:<IP>

C:\> systeminfo.exe | findstr.exe /c:"Domain:"

C:\> echo %LOGONSERVER%
```

#### 1.1.1 - Reverse DNS Lookup

> [!NOTE] What is TLD?
> **TLD** stands for **Top Level Domain**.

Enumerate the **PDC (Principal Domain Controller)**.

```
C:\> nslookup.exe -type=srv _ldap._tcp.pdc._msdcs.<domain>.<tld>
```

Enumerate the **domain controllers**.

```
C:\> nslookup.exe -type=all _ldap._tcp.dc._msdcs.<domain>.<tld>
```

Enumerate the **GC (Global Catalog, i.e. DC with extended data)**.

```
C:\> nslookup.exe -type=srv gc._msdcs.<domain>.<tld>
```

Other ways to find services hosts that may be DCs.

```
C:\> nslookup.exe -type=srv _kerberos._tcp.<domain>.<tld>

C:\> nslookup.exe -type=srv _kpasswd._tcp.<domain>.<tld>

C:\> nslookup.exe -type=srv _ldap._tcp.<domain>.<tld>
```

Using `csvde.exe` to enumerate the whole active directory network. If domain controller is not specified it'll use the current one to enumerate the network.

TODO: Provide more usage and use cases for `csvde`

> [!INFO]
> This only works on Windows Servers

```
C:\> csvde.exe [-s <domain_controller_IP>] -f domain-network.csv

$ grep -oP '^:"CN=.*?,' domain-network.csv
```

### 1.2 - PowerShell

```
PS C:\> Get-ADComputer -Filter {Enabled -eq $true} -Properties * | Select-Object Name, DNSHostName, OperatingSystem, LastLogonDate, IPv4Address | Export-Csv C:\temp\AllWindows.csv -NoTypeInformation -Encoding UTF8
```

```
PS C:\> Write-Output $Env:USERDOMAIN

PS C:\> [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()
```

TODO: Re-arrange them in Privilege Escalation section

- To enumerate Nested Groups in an active directory environment

`$ cat enumerateAD.ps1`

---

```powershell
$domainObj = [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()

$PDC = ($domainObj.PdcRoleOwner).Name

$SearchString = "LDAP://"

$SearchString = $PDC + "/"

$DistinguishedName = "DC=$($domainObj.Name.Replace('.', ',DC='))"

$SearchString += $DistinguishedName

Write-Output $SearchString

$Searcher = New-Object System.DirectoryServices.DirectorySearcher([ADSI]$SearchString)

$objDomain = New-Object System.DirectoryServices.DirectoryEntry

$Searcher.SearchRoot = $objDomain

# property=value
# such as => name=<domain_username>
#$Searcher.filter = "samAccounType=805306368"

#$Searcher.FindAll()

#foreach($obj in $Result) {
#    foreach($prop in $obj.Properties) {
#        $prop
#    }
#    Write-Host "------------------------"
#}

# Enumerate each group member

# (property=value)
# such as => name=<Group_name>
#$Searcher.filter = "(objectClass=Group)"

#$Result = $Searcher.FindAll()

#foreach($obj in $Result) {
#    $obj.Properties.name
#}

$Searcher.filter = "(name=Domain Admins)"

$Output = $Searcher.FindAll()

foreach($obj in $Output) {
    Write-Output $obj.Properties.member
}
```

```powershell
$PDC = ($domainObj.PdcRoleOwner).Name
$SearchString = "LDAP://"
$SearchString += $PDC + "/"
$DistinguishedName = "DC=$domainObj.Name.Replace('.', ',DC='))"
$SearchString += $DistinguishedName
$Searcher = New-Object System.DirectoryServices.DirectorySearcher([ADSI]$SearchString)
$objDomain = New-Object System.DirectoryServices.DirectoryEntry
$Searcher.SearchRoot = $objDomain

# Search by what
$Searcher.filter="serviceprincipalname=*"

$Result = $Searcher.Findall()

Write-Host "---------------------------"
Foreach($obj in $Result)
{
    
    ForEach($prop in $obj.Properties) {
        # uncommnent to print all attributes
        #$prop
    }
    Write-Host "[SAM Account Name]"
    $obj.Properties.samaccountname
    Write-Host ""
    Write-Host "[User Principal Name]"
    $obj.Properties.userprincipalname
    Write-Host ""
    Write-Host "[Service Principal Name]"
    $obj.Properties.serviceprincipalname
    Write-Host "---------------------------"
}
```

## 02 - Enumerate Current Forest

### 2.2 - PowerShell

Trust relationship between domains.

```
PS C:\> ([System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()).GetAllTrustRelationships()
```

Current forest information.

```
PS C:\> [System.DirectoryServices.ActiveDirectory.Forest]::GetCurrentForest()
```

Get forest trust relationships.

```
PS C:\> ([System.DirectoryServices.ActiveDirectory.Forest]::GetForest((New-Object System.DirectoryServices.ActiveDirectory.DirectoryContext('Forest', '<forest_domain>.<tld>')))).GetAllTrustRelationships()
```

## 03 - Group Policy Object

Save the information in HTML.

```
C:\> gpresult.exe [/s <IP>] /h gpreport.html
```

Extremely verbose output of GPO settings

```
C:\> gpresult.exe [/s <IP>] /z
```

## 03 - Sysnative

```
C:\> C:\Windows\sysnative\nltest.exe /dclist:<domain>

C:\> nltest.exe /dclist:

C:\> nltest.exe /dclist:<domain>

C:\> nltest.exe /dcname:<domain>

C:\> nltest.exe /dcgetdc:<domain>
```

Trust relationship between domains

```
C:\> nltest.exe /domain_trusts

C:\> nltest.exe /domain_trusts /all_trusts

C:\> nltest.exe /trusted_domains
```

```
C:\> nltest.exe /domain_trusts & nltest.exe /dclist: & c:\windows\sysnative\nltest.exe /domain_trusts & c:\windows\sysnative\nltest.exe /dclist:<domain>
```

---
## References

### LOFLCAB

- [LOFLCAB: nslookup.exe](https://lofl-project.github.io/loflcab/Binaries/nslookup/)

- [LOFLCAB: csvde](https://lofl-project.github.io/loflcab/Binaries/csvde/)

- [LOFLCAB: qwinsta](https://lofl-project.github.io/loflcab/Binaries/qwinsta/)

### The Hacker Recipes

- [The Hacker Recipes: DNS](https://www.thehacker.recipes/ad/recon/dns)

- [Podalirius: Useful LDAP queries for Windows Active Directory pentesting](https://podalirius.net/en/articles/useful-ldap-queries-for-windows-active-directory-pentesting/)

- [Certcube: AD Recon for Beginners](https://blog.certcube.com/ad-recon-for-beginners/)

- [Active Directory Domain Enumeration Part 1](https://nored0x.github.io/red-teaming/active-directory-domain-enumeration-part-1/)