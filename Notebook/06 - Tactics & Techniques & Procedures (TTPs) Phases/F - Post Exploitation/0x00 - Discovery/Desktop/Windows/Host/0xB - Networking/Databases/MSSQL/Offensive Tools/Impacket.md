# Impacket

## 06 - Database

### 6.1 - Current Database

Enumerate current database

```
1> SELECT DB_NAME();
2> go
```

### 6.2 - Retrieve Database

Enumerate all available databases

```
1> SELECT name FROM sys.databases;
2> go

1> SELECT name FROM master.dbo.sysdatabases;
2> go
```

### 6.3 - Relation Names

- Enumerate table names

```
1> SELECT * FROM <database>.INFORMATION_SCHEMA.TABLES;
2> go
```

### 6.4 - Usernames

- Gather all users from MSSQL Database

```
1> SELECT sp.name AS login, sp.type_desc AS login_type, so.password_hash, sp.create_date, sp.modify_date, CASE WHEN sp.is_disabled = 1 THEN 'Disabled' ELSE 'Enabled' END AS STATUS FROM sys.server_principals sp LEFT JOIN sys.sql_logins sl ON sp.principal_id = sl.principal_id WHERE sp.type NOT IN ('G', 'R') ORDER BY sp.name;
2> go
```

- Gather all administrators logins

```
1> SELECT loginname FROM syslogins WHERE sysadmin = 1;
2> go
```

### 6.6 - Enable `xp_cmdshell` (Manual)

Enumerate the `xp_cmdshell` whatever if it's enabled or not.

```
1> SELECT name, CONVERT(INT, ISNULL(value, value_in_use)) AS IsConfigured FROM sys.configurations WHERE name = 'xp_cmdshell';
2> go
```

Enable `xp_cmdshell` for remote execution

```
1> EXEC sp_configure 'show advanced options', 1;
2> EXEC sp_configure 'xp_cmdshell', 1;
3> RECONFIGURE;
4> go

1> xp_cmdshell 'whoami';
2> go
```

### 2.3 - Enable `xp_cmdshell` (impacket)

```
SQL> enable_xp_cmdshell
```

## 05 - Linked Servers

### 5.1 - Enumerate Linked Servers

```
1> EXEC sp_linkedservers;
2> SELECT * FROM sys.servers;
3> go
```

## 04 - Operating System

### 4.1 - Hostname

Enumerate target machine hostname

```
1> SELECT HOST_NAME();
2> go
```

### 4.2 - Version

MSSQL version details

```
1> SELECT @@VERSION;
2> go
```

---
## References

### Backlinks

- [[06 - Tactics & Techniques & Procedures (TTPs) Phases/A - Information Gathering/0x02 - Active Fingerprinting/Network Ports/Windows/Database/MSSQL]]