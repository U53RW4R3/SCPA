# Windows

## Scripting

### PowerShell

#### DCOM Object

```powershell
$com = [Type]::GetTypeFromCLSID("{9BA05972-F6A8-11CF-A442-00A0C90A8F39}")
$obj = [System.Activator]::CreateInstance($com)
$item.Document.Application.ShellExecute("notepad.exe")
```

## WinAPI

### C++

```cpp
#include <windows.h>
#include <shellapi.h>

#pragma comment(lib, "shell32.lib")

BOOL run() {
 const std::shared_ptr<TCHAR> process_path { new TCHAR[MAX_PATH]()};
 GetModuleFileNameExW(GetCurrentProcess(), nullptr, process_path.get(), MAX_PATH);
 const auto arg = std::wstring{ L"/c " } +process_path.get();

 SHELLEXECUTEINFO exec_info{};
 exec_info.cbSize = sizeof(exec_info);
 exec_info.hwnd = nullptr;
 exec_info.lpVerb = L"runas";
 exec_info.lpFile = L"cmd.exe";
 exec_info.lpParameters = arg.c_str();
 exec_info.nShow = SW_SHOW; // SW_HIDE;

 return ShellExecuteEx(&exec_info);
}
```

Compile the payload.

```
$ x86_64-w64-mingw32-g++ -l shell32 -o payload.exe payload.cpp
```

### Python

```python
import ctypes
from sys import executable

shell32 = ctypes.windll.shell32
ShellExecuteW = shell32.ShellExecuteW

def run_as():
    executable_path = os.path.realpath(executable)
    result = ShellExecuteW(None, 'runas', executable_path, '', None, 1)
    if result > 32:
        return None
```

### VBA

```vb
Private Declare PtrSafe Function ShellExecute Lib "shell32.dll" _
    Alias "ShellExecuteA" ( _
    ByVal hwnd As Long, _
    ByVal lpOperation As String, _
    ByVal lpFile As String, _
    ByVal lpParameters As String, _
    ByVal lpDirectory As String, _
    ByVal nShowCmd As Long) As Long

Private Const SW_HIDE = 0
Private Const SW_NORMAL = 1

Sub Execute()
    ShellExecute 0, "RunAs", "C:\Windows\System32\cmd.exe", "[arguments]", "", SW_HIDE
    ' ShellExecute 0, "Open", "C:\Windows\System32\cmd.exe", "[arguments]", "", SW_HIDE
End Sub
```

---
## References

### Backlinks

- [[Enumerate Builtin Functions]]

### Microsoft

- [Microsoft Documentation: Shell.ShellExecute](https://docs.microsoft.com/en-us/windows/win32/shell/shell-shellexecute)

### MalAPI

- [MalAPI: `ShellExecuteA`](https://malapi.io/winapi/ShellExecuteA)

- [MalAPI: `ShellExecuteExA`](https://malapi.io/winapi/ShellExecuteExA)

### Tenouk

- [Tenouk: Processes and Threads - C Run-Time - Part 1](https://www.tenouk.com/ModuleR.html)

- [Tenouk: Processes and Threads - C Run-Time - Part 2](https://www.tenouk.com/ModuleR1.html)

### Secrary

- [secrary: RedTeamTrick](https://secrary.com/Random/RedTeamTrick/)