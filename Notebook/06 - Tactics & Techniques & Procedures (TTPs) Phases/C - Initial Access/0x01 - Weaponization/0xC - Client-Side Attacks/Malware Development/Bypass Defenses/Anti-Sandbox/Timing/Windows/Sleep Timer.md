# Sleep Timer

## Scripting

### VBA

```vb
Public Sub Timeout(duration As Double)
	Dim starttime As Double, x As Integer
	starttime = Timer
	Do While Timer - starttime < duration
		x = DoEvents()
	Loop
End Sub

Call Timeout(1)
```

## WinAPI

### C

```c
#include <stdio.h>
#include <time.h>
#include <stdlib.h>
#include <windows.h>
#include <synchapi.h>

#pragma comment(lib, "kernel32.lib")

int DelayFunction() {
    clock_t start_time;
    clock_t end_time;
    double total_time;
    int = 6; // Change to number of seconds for your delay. 10 would be a delay of 10 seconds. Default here is 6.

    start_time = clock();
    printf("[i] Sleeping for %d seconds\n", i);

    // Sleep counts in milliseconds, so need to convert from seconds to milliseconds (seconds * 1000)
    Sleep(i * 1000);
    end_time = clock();
    printf("[i] Sleep ended: end_time = %ld cycles\n", end_time);

    if(((double)(end_time - start_time) / CLOCKS_PER_SEC) < 4.5) {
	    // execute payload here
	    exit(0);
    }

    return 0;
}
```

```c
#include <windows.h>
#include <time.h>
#include <synchapi.h>

#pragma comment(lib, "kernel32.lib")
#pragma comment(lib, "winmm.lib")

int main() {
	DWORD measure_one;
	DWORD measure_two;

	measure_one = timeGetTime();
	SleepEx(5000, TRUE);
	measure_two = timeGetTime();

	if ((measure_two > (measure_one + 1000)) && (measure_two < (measure_one + 1005))) {
		// execute payload here
	}

	return 0;
}
```

```
$ x86_64-w64-mingw32-gcc -l kernel32 -o payload.exe payload.c
```

### VBA

```vb
Private Declare PtrSafe Function Sleep Lib "KERNEL32" ( _
ByVal mili As Long _
) As Long

Sleep(10000)
```

```vb
Public Declare Function GetTickCount Lib "kernel32" () As Long

Sub Pause(hInterval As Long)
	Dim hCurrent As Long
	hInterval = hInterval * 1000
	hCurrent = GetTickCount
	Do While GetTickCount - hCurrent < Val(hInterval)
		DoEvents
	Loop
End Sub

' Pause for one second
Call Pause(1)
```

---
## References

### MalAPI

- [MalAPI: Sleep](https://malapi.io/winapi/Sleep)

- [MalAPI: SleepEx](https://malapi.io/winapi/SleepEx)

- [MalAPI: GetTickCount](https://malapi.io/winapi/GetTickCount)

- [MalAPI: GetTickCount64](https://malapi.io/winapi/GetTickCount64)

### Tenouk

- [Tenouk: Supplement](https://www.tenouk.com/Supplement.html)

- [Tenouk: Processes and Threads - C Runtime - Part 6](https://www.tenouk.com/ModuleS2.html)

- [Tenouk: Processes and Threads - WinAPIs - Part 10](https://www.tenouk.com/ModuleU4.html)

- [Tenouk: Windows Process and Thread References 3](https://www.tenouk.com/crstufunction2.html)

- [Tenouk: Windows Thread Synchronization References 3](https://www.tenouk.com/crstufunction5.html)

### InstallSetupConfig

- [InstallSetupConfig: Win32 Windows Volume Program and Code Example 7](https://www.installsetupconfig.com/win32programming/windowsvolumeapis1_6.html)

### patorjk

- [patorjk: Visual Basic 6.0 Code Bank - Timeout Code](https://patorjk.com/programming/tutorials/vb6codebank.htm)

### CheckPoint

- [CheckPoint: Evasion Timing](https://evasions.checkpoint.com/src/Evasions/techniques/timing.html)

- [CheckPoint: Evasion Anti-Debug Timing](https://evasions.checkpoint.com/src/Anti-Debug/techniques/timing.html)

### TrustedSec

- [TrustedSec: Enumerating Anti-Sandboxing Techniques](https://trustedsec.com/blog/enumerating-anti-sandboxing-techniques)

### Threat Zone

- [Threat Zone: Simplest Yet Most Common and Effective Evasion Tactic: Sleep!](https://blog.threat.zone/simplest-yet-most-common-and-effective-evasion-tactic-sleep/)