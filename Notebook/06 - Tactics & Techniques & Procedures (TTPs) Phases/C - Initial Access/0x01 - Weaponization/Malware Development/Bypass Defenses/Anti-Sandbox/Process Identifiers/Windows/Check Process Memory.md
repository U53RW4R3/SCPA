# Check Process Memory

## C

```c
#include <windows.h>
#include <psapi.h>

#pragma comment(lib, "psapi.lib")

int main() {
	PROCESS_MEMORY_COUNTERS process_memory_counters;

	GetProcessMemoryInfo(GetCurrentProcess(), &process_memory_counters, sizeof(process_memory_counters));
	if (process_memory_counters.WorkingSetSize <= 3500000) {
		// execute payload here
	}
	return 0;
}
```

## C\#

```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Runtime.InteropServices;
using System.Net;

namespace CheckProcessMemory {
    class Runner {
        [DllImport("kernel32.dll")]
        private static extern IntPtr GetCurrentProcess();

        [StructLayout(LayoutKind.Sequential, Size = 40)]
        private struct PROCESS_MEMORY_COUNTERS {
            public uint cb;             
            public uint PageFaultCount;        
            public uint PeakWorkingSetSize;  
            public uint WorkingSetSize;        
            public uint QuotaPeakPagedPoolUsage;    
            public uint QuotaPagedPoolUsage;
            public uint QuotaPeakNonPagedPoolUsage;
            public uint QuotaNonPagedPoolUsage;
            public uint PagefileUsage;
            public uint PeakPagefileUsage;
        }
    
        [DllImport("psapi.dll", SetLastError = true)]
        static extern bool GetProcessMemoryInfo(IntPtr hProcess, out PROCESS_MEMORY_COUNTERS counters, uint size);
        static void Main(string[] args) {
            PROCESS_MEMORY_COUNTERS process_memory_counters;
            process_memory_counters.cb = (uint)Marshal.SizeOf(typeof(PROCESS_MEMORY_COUNTERS));
            GetProcessMemoryInfo(GetCurrentProcess(), out process_memory_counters, process_memory_counters.cb);
            if (process_memory_counters.WorkingSetSize <= 3500000) {
                // execute payload here
            }
            return;
        }
    }
}
```

---
## References

### Source Repositories

- [cinzinga: Evasion-Practice](https://github.com/cinzinga/Evasion-Practice)