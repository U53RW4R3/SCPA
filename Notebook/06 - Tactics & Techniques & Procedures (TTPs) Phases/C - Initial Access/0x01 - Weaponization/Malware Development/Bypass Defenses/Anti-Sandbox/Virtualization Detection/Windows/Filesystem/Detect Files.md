# Detect Files

## ReadFile

```c
#include <windows.h>
#include <fileapi.h>

#pragma comment(lib, "kernel32.lib")

#define FILE_PATH "C:\\path\\to\\file.txt"

int main() {
	HANDLE file;
	DWORD tmp;
	LPCVOID buffer = "1234";
	char output_buffer[5] = {0};

	file = CreateFile(FILE_PATH, GENERIC_WRITE, 0, NULL, CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL, 0);

	if (WriteFile(file, buffer, strlen((const char *)buff), &tmp, NULL)) {
		CloseHandle(file);

		file = CreateFile(FILE_PATH,
					GENERIC_READ,
					FILE_SHARE_READ,
					NULL,
					OPEN_EXISTING,   // existing file only
					FILE_ATTRIBUTE_NORMAL,
					NULL);
		if (ReadFile(file, output_buffer, 4, &tmp, NULL)) {
			if (strncmp(buffer, output_buffer, 4) == 0) {
				// execute payload here
			}
		}
		CloseHandle(file);
	}

	DeleteFile(FILE_PATH);

	return 0;
}
```

## PathFileExists

```

```

## GetFileAttributes

```

```

## FindFirstFile

```

```

## GetModuleHandle

```python
import ctypes

kernel32 = ctypes.windll.kernel32

def detect_sandboxie():
    return kernel32.GetModuleHandleW('SbieDll.dll') != 0
```

## .NET

### PowerShell

```powershell
$filename = 'file.txt'

if ([System.IO.File]::Exists($filename)) {
	Write-Host "The file exists."
}
```

---
## References

### Backlinks

- [[06 - Tactics & Techniques & Procedures (TTPs) Phases/F - Post Exploitation/0x00 - Discovery/Desktop/Windows/Host/0xA - Internal Reconnaissance/Files and Directories/Malware Development/Filesystem Management/Read File]]

### Microsoft

- [WinAPI Documentation: PathFileExists](https://learn.microsoft.com/en-us/windows/win32/api/shlwapi/nf-shlwapi-pathfileexistsa)

- [WinAPI Documentation: GetFileAtrributes](https://learn.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-getfileattributesa)

- [.NET Documentation: File.Exists()](https://learn.microsoft.com/en-us/dotnet/api/system.io.file.exists?view=net-8.0)

### Tenouk

- [Tenouk: ModuleB](https://www.tenouk.com/ModuleB.html)

- [Tenouk: ModuleD1](https://www.tenouk.com/ModuleD1.html)

### TrustedSec

- [TrustedSec: Enumerating Anti-Sandboxing Techniques](https://trustedsec.com/blog/enumerating-anti-sandboxing-techniques)

### Ryan

- [Ryan: Checking If a File Exists in C++](https://medium.com/@ryan_forrester_/checking-if-a-file-exists-in-c-practical-guide-f4faa58989fd)