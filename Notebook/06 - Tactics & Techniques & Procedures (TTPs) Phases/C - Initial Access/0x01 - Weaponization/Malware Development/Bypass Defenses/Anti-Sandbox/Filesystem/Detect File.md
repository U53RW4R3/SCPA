# Detect File

## User Directory

ANSI version of `CreateFileA`.

Brief MSDN: "Creates or opens a file or I/O device. The most commonly used I/O devices are as follows: file, file stream, directory, physical disk, volume, console buffer, tape drive, communications resource, mailslot, and pipe. The function returns a handle that can be used to access the file or device for various types of I/O depending on the file or device and the flags and attributes specified."

`WriteFile()` - Write a buffer to handle.

Brief: "Writes data to the specified file or input/output (I/O) device. This function is designed for both synchronous and asynchronous operation. For a similar function designed solely for asynchronous operation, see WriteFileEx."

```c
#include <windows.h>
#include <fileapi.h>

#pragma comment(lib, "kernel32.lib")

#define FILE_PATH "C:\\Users\\<username>\\Documents\\file.txt"

int main() {
	HANDLE file;
	DWORD tmp;
	LPCVOID buffer = "1234";
	char output_buffer[5] = {0};

	file = CreateFileA(FILE_PATH, GENERIC_WRITE, 0, NULL, CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL, 0);

	if (WriteFile(file, buffer, strlen((const char *)buff), &tmp, NULL)) {
		CloseHandle(file);

		file = CreateFile(FILE_PATH,
					GENERIC_READ,
					FILE_SHARE_READ,
					NULL,
					OPEN_EXISTING,   // existing file only
					FILE_ATTRIBUTE_NORMAL,
					NULL);
		if (ReadFile(file, output_buffer, 4, &tmp, NULL)) {
			if (strncmp(buffer, output_buffer, 4) == 0) {
				// execute payload here
			}
		}
		CloseHandle(file);
	}

	DeleteFile(FILE_PATH);

	return 0;
}
```

Unicode version (UTF-16) of `CreateFileW`.

```
HANDLE CreateFileW(
  LPCWSTR               lpFileName,
  DWORD                 dwDesiredAccess,
  DWORD                 dwShareMode,
  LPSECURITY_ATTRIBUTES lpSecurityAttributes,
  DWORD                 dwCreationDisposition,
  DWORD                 dwFlagsAndAttributes,
  HANDLE                hTemplateFile
);
```

---
## References

### Backlinks

- [[06 - Tactics & Techniques & Procedures (TTPs) Phases/F - Post Exploitation/0x00 - Discovery/Desktop/Windows/Host/0xA - Internal Reconnaissance/Files and Directories/Malware Development/Filesystem Management/Read File]]