---
author(s):
  - Userware
tags:
  - post-exploitation
  - discovery
  - living-off-the-land
  - windows
---
# Living off the Land

## 01 - Current User Enumeration

### 1.1 - Command Prompt

> [!NOTE] [[06 - Tactics & Techniques & Procedures Phases/F - Post Exploitation/0x01 - Defense Evasion/08 - Obfuscate Artifacts/Obfuscation/Malware Development/Obfuscation Techniques/String Manipulation/Windows/Batch|Environment Variables]]
> The percent/modulus sign means for Windows operating systems it will echo out the variable (for example: `%VARIABLE%`) which is similar to bash script in Linux (for example: `$VARIABLE`)

Current user enumeration.

```
C:\> whoami.exe

C:\> echo %USERNAME%
```

Retrieve user basic information.

```
C:\> net.exe user %USERNAME%

C:\> net.exe user <username>
```

Retrieves the user's SID.

```
C:\> whoami.exe /user
```

Check the user's privileges.

```
C:\> whoami.exe /groups

C:\> whoami.exe /all /fo list
```

### 1.2 - PowerShell

```powershell
PS C:\> Get-ComputerInfo -Property CsUserName

PS C:\> $Env:USERNAME

PS C:\> [System.Environment]::UserName

PS C:\> [System.Environment]::GetEnvironmentVariable('USERNAME')

PS C:\> [System.Security.Principal.WindowsIdentity]::GetCurrent().Name
```

Retrieves the user's SID.

```powershell
PS C:\> ([System.Security.Principal.WindowsIdentity]::GetCurrent()).User.Value
```

Check the user's privileges.

```
PS C:\> Get-LocalUser

PS C:\> Get-LocalUser | Format-Table Name,Enabled,LastLogon
```

### 1.3 - Sysinternals

> [!IMPORTANT] Conditions
> To execute sysinternal tool. EULA must be accepted (`-accepteula`). Otherwise this can be done in registry hive.
> ```
> C:\> reg.exe add [\\<IP>\]HKCU\Software\Sysinternals /t REG_DWORD /v 'EulaAccepted' /d 0x00000001
> 
> PS C:\> Set-ItemProperty -Path 'Registry::HKEY_CURRENT_USER\Software\Sysinternals' -Type DWord -Name 'EulaAccepted' -Value 0x00000001
> ```

#### 1.3.1 - Command Prompt

```
C:\> net.exe use z: \\live.sysinternals.com\tools

C:\> copy z:\PsGetsid64.exe .

C:\> net.exe use z: /delete
```

#### 1.3.2 - PowerShell

```
PS C:\> New-PSDrive -Name Z -PSProvider FileSystem -Root "\\live.sysinternals.com\tools"

PS C:\> Copy-Item z:\PsGetsid64.exe .

PS C:\> Remove-PSDrive -Name Z
```

Accept the EULA.

```
C:\> .\PsGetsid64.exe -accepteula
```

Retrieves the user's SID.

```
C:\> .\PsGetsid64.exe [\\<IP> -u <username> -p <password>]
```

## 02 - Enumerate Local Usernames

### 2.1 - Command Prompt

```
C:\> net.exe user

C:\> net.exe users

C:\> dir /b /ad "C:\Users\"
```

Windows XP and below.

```
C:\> dir /b /ad "C:\Documents and Settings\"
```

### 2.2 - PowerShell

```
PS C:\> Get-ChildItem -Path "C:\Users" -Force | Select-Object Name

PS C:\> Get-ChildItem -Path "\\<IP>\C$\Users" -Force | Select-Object Name
```

## 03 - Enumerate Local Groups

Enumerate local groups.

```
C:\> net.exe localgroup
```

Enumerate current local group users.

```
C:\> net.exe localgroup "<local_group_name>"

C:\> net.exe localgroup "Administrators"
```

## 04 - Logged On Users

### 4.1 - Command Prompt

Gather logged-on local users.

```
C:\> quser.exe

C:\> query.exe user <username> [/server:<IP>]

C:\> net.exe session [\\<IP>]

C:\> net.exe session [\\<IP>] | find / "\\"

C:\> qwinsta.exe /server:<IP>

C:\> for /f "tokens=1,2" %i in ('qwinsta.exe /server:<IP> ^| findstr "Active Disc"') do @echo %i | find /v "#" | find /v "console" || echo %j

C:\> @for /f %n in (computers.txt) do @for /f "tokens=1,2" %i in ('qwinsta.exe /server:%n ^| findstr "Active Disc"') do @echo %i | find /v "#" | find /v "console" || echo %j > usernames.txt
```

### 4.2 - Sysinternals

> [!IMPORTANT] Conditions
> To execute sysinternal tool. EULA must be accepted (`-accepteula`). Otherwise this can be done in registry hive.
> ```
> C:\> reg.exe add [\\<IP>\]HKCU\Software\Sysinternals /t REG_DWORD /v 'EulaAccepted' /d 0x00000001
> 
> PS C:\> Set-ItemProperty -Path 'Registry::HKEY_CURRENT_USER\Software\Sysinternals' -Type DWord -Name 'EulaAccepted' -Value 0x00000001
> ```

#### 4.2.1 - Command Prompt

```
C:\> net.exe use z: \\live.sysinternals.com\tools

C:\> copy z:\logonsessions64.exe .

copy z:\PsLoggedon64.exe .

C:\> net.exe use z: /delete
```

#### 4.2.2 - PowerShell

```
PS C:\> New-PSDrive -Name Z -PSProvider FileSystem -Root "\\live.sysinternals.com\tools"

PS C:\> Copy-Item z:\logonsessions64.exe .

Copy-Item z:\PsLoggedon64.exe .

PS C:\> Remove-PSDrive -Name Z
```

Accept the EULA.

```
C:\> .\logonsessions64.exe -accepteula

.\PsLoggedon64.exe -accepteula
```

Gather logged-on users.

```
C:\> .\logonsessions64.exe

C:\> .\PsLoggedon64.exe [\\<IP>\<username>]
```

## 05 - Account Lockouts and Password Policies

```
C:\> net.exe accounts
```

Check if password expiration exists in the current user.

```
C:\> net.exe user <username> /domain | findstr.exe /C:expires
```

## 06 - User Environment

### 6.1 - Command Prompt

Shows all current environmental variables. Specific ones to look for are `USERDOMAIN`, `USERNAME`, `USERPROFILE`, `HOMEPATH`, `LOGONSERVER`, `COMPUTERNAME`, `APPDATA`, and `ALLUSERPROFILE`.

```
C:\> set
```

### 6.2 - PowerShell

Shows all current environmental variables. Specific ones to look for are `USERDOMAIN`, `USERNAME`, `USERPROFILE`, `HOMEPATH`, `LOGONSERVER`, `COMPUTERNAME`, `APPDATA`, and `ALLUSERPROFILE`.

```
PS C:\> Get-ChildItem Env:

PS C:\> Get-ChildItem Env:* | Format-Table Key,Value

PS C:\> [System.Environment]::GetEnvironmentVariables()
```

## 07 - Event Logs

### 7.1 - Command Prompt

```
C:\> wevutils.exe
```

### 7.2 - PowerShell

```
PS C:\> Get-WinEvent

PS C:\> Get-EventLog
```

### 7.3 - Sysinternals

> [!IMPORTANT] Conditions
> To execute sysinternal tool. EULA must be accepted (`-accepteula`). Otherwise this can be done in registry hive.
> ```
> C:\> reg.exe add [\\<IP>\]HKCU\Software\Sysinternals /t REG_DWORD /v 'EulaAccepted' /d 0x00000001
> 
> PS C:\> Set-ItemProperty -Path 'Registry::HKEY_CURRENT_USER\Software\Sysinternals' -Type DWord -Name 'EulaAccepted' -Value 0x00000001
> ```

^400df0

#### 7.3.1 - Command Prompt

```
C:\> net.exe use z: \\live.sysinternals.com\tools

C:\> copy z:\psloglist64.exe .

C:\> net.exe use z: /delete
```

^f115ee

#### 7.3.2 - PowerShell

```
PS C:\> New-PSDrive -Name Z -PSProvider FileSystem -Root "\\live.sysinternals.com\tools"

PS C:\> Copy-Item z:\psloglist64.exe .

PS C:\> Remove-PSDrive -Name Z
```

^792124

Accept the EULA.

```
C:\> .\psloglist64.exe -accepteula
```

^585c1d

List the machine's event logs to check for user activity

```
C:\> .\psloglist64.exe [\\<IP> -u <username> -p <password>]
```

## 08 - Enumerate Token Privileges

### 8.1 - Command Prompt

Check the user's privileges.

```
C:\> whoami.exe /priv
```

### 8.2 - PowerShell

Enumerate `SeShutdownPrivilege` access token privilege.

```
PS C:\> Restart-Computer -WhatIf
What if: Performing the operating "Enable the Local shutdown access rights and restart the computer." on target "<IP> (<hostname>)"
```

^a5f1fa

---
## References

###  LOFLCAB

- [LOFLCAB: quser](https://lofl-project.github.io/loflcab/Binaries/quser/)

### Wikipedia

- [Wikipedia: Environment Variable](https://en.wikipedia.org/wiki/Environment_variable)

### r00t-3xp10it

- [r00t-3xp10it: CmdLine Scripts for Reverse TCP Shell Addicts](https://github.com/r00t-3xp10it/venom/wiki/CmdLine-%26-Scripts-for-reverse-TCP-shell-addicts)

### NoRed0x

- [NoRed0x: Active Directory Domain Enumeration Part 1](https://nored0x.github.io/red-teaming/active-directory-domain-enumeration-part-1/)

### Pwnage Base

- [Pwnage Base: Account Lockout](https://pwn.no0.be/exploitation/password/account_lockout/)

### Hacking Articles

- [Hacking Articles: Remote Windows PC Enumeration using PSTools](https://www.hackingarticles.in/remote-windows-pc-enumeration-using-pstools/)