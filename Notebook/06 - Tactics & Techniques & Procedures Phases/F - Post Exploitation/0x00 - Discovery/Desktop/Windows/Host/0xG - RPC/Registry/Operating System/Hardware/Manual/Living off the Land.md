# Living off the Land

## 01 - Command Prompt

### 1.1 - Mounted Drives

Gather the **Volume Name** of USB devices. ^2c40b9

```
C:\> reg.exe query [\\<IP>\]HKLM\SYSTEM\CurrentControlSet\Enum\USBSTOR /s /v FriendlyName 2>nul | findstr.exe /r /c:"FriendlyName\s*REG_SZ\s*"

C:\> reg.exe query [\\<IP>\]HKLM\SOFTWARE\Microsoft\Windows Portable Devices\Devices /s /v FriendlyName 2>nul | findstr.exe /r /c:"FriendlyName\s*REG_SZ\s*"
```

> [!INFO]
> Inside the registry key `USB`. You'll identifiers preceded by `VID` and `PID` (e.g., `VID_0DA2&PID_2001`).
> > [!TIP]
> > It is hard to make out one by one. It's best to refer to the `USBSTOR` registry key after finding the serial number of the USB device.

^936a9e

```
C:\> reg.exe query [\\<IP>\]HKLM\SYSTEM\CurrentControlSet\Enum\USB /s | findstr.exe /r /c:"Device Parameters" /c:"FriendlyName" /c:"HardwareID" /c:"Serial" /c:"^\\HKLM\\SYSTEM\\CurrentControlSet\\Enum\\USB\\"
```

Find serial number to obtain the **Drive Letter** and **Volume GUID** of the USB device. ^e7d598

```
C:\> reg.exe query [\\<IP>\]HKLM\SYSTEM\MountedDevices /s
```

USB timestamps will contain the following, first time device is connected, last time device is connected, and removal time. ^3339d9

```
C:\> reg.exe query [\\<IP>\]HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Mountpoints2
```

Check if there are external USB drives history activity to the workstation. This will provide leverage to insert malware to spread the infection or possibly to exfiltrate data. ^74fcbf

```
C:\> reg.exe query [\\<IP>\]HKLM\SYSTEM\CurrentControlSet\Control\DeviceClasses\{53f56307-b6bf-11d0-94f2-00a0c91efb8b} /s
```

### 1.2 - MAC Addresses

```
C:\> reg.exe query HKLM /f NetworkAddress /s /v /k

C:\> reg.exe query HKLM /s /v NetworkAddress

C:\> reg.exe query "[\\<IP>\]HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\NetworkList\Profiles" /s /v NetworkAddress

C:\> reg.exe query "[\\<IP>\]HKLM\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters" /v NetworkAddress
```

### 1.3 - CPU

Retrieving the number of CPU cores and threads.

```
C:\> reg.exe query [\\<IP>\]HKLM\HARDWARE\DESCRIPTION\System\CentralProcessor\* /v ProcessorNameString
```

## 02 - PowerShell

### 2.1 - Mounted Drives

![[#^2c40b9]]

```
PS C:\> Get-ItemProperty -Path Registry::HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Enum\USBSTOR\*\* | Select-Object FriendlyName

PS C:\> Invoke-Command -ComputerName <IP> [-Credential $credentials] -ScriptBlock { Get-ItemProperty -Path Registry::HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Enum\USBSTOR\*\* | Select-Object FriendlyName }

PS C:\> Get-ItemProperty -Path Registry::HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Portable Devices\Devices\*\* | Select-Object FriendlyName

PS C:\> Invoke-Command -ComputerName <IP> [-Credential $credentials] -ScriptBlock { Get-ItemProperty -Path Registry::HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Portable Devices\Devices\*\* | Select-Object FriendlyName }
```

![[#^936a9e]]

```
PS C:\> Get-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Enum\USB\*\*" -Name SerialNumber -ErrorAction SilentlyContinue | Select-Object PSChildName, SerialNumber
```

![[#^e7d598]]

```
PS C:\> Get-ItemProperty -Path Registry::HKEY_LOCAL_MACHINE\SYSTEM\MountedDevices\*\*
```

![[#^3339d9]]

```
PS C:\> Get-ItemProperty -Path Registry::HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Mountpoints2
```

![[#^74fcbf]]

```
PS C:\> Get-ItemProperty -Path Registry::HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\DeviceClasses\{53f56307-b6bf-11d0-94f2-00a0c91efb8b}\*
```

### 2.2 - MAC Addresses

```
PS C:\> Get-ChildItem -Path 'Registry::HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\NetworkList\Profiles' -Recurse -ErrorAction SilentlyContinue | ForEach-Object { Get-ItemProperty -Path $_.PSPath -Name NetworkAddress -ErrorAction SilentlyContinue }

PS C:\> Get-ItemProperty -Path 'Registry::HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters' -Name NetworkAddress -ErrorAction SilentlyContinue
```

### 2.3 - CPU

```
PS C:\> Get-ItemProperty -Path Registry::HKEY_LOCAL_MACHINE\HARDWARE\DESCRIPTION\System\CentralProcessor\*
```