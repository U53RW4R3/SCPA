---
author(s):
  - Userware
tags:
  - post-exploitation
  - discovery
  - living-off-the-land
  - windows
---
# Living off the Land

## 01 - List Installed Software

### 1.1 - Command Prompt

```
C:\> wmic.exe [/node:<IP>] [/user:<username> /password:<password>] Product GET Name,Version,Vendor
```

DotNET MSBuild compilers

```
C:\> wmic.exe [/node:<IP>] [/user:<username> /password:<password>] product get description | findstr.exe /c:.NET
```

### 1.2 - PowerShell

```
PS C:\> Get-CimInstance [-ComputerName <IP>] -Query "SELECT Name,Caption,Version,InstallLocation,IdentifyingNumber FROM Win32_Product" | ? {?_.Vendor -Notmatch 'Microsoft'}

PS C:\> Get-CimInstance [-ComputerName <IP>] -Query "SELECT Name,Caption,Version,InstallLocation,IdentifyingNumber FROM Win32_Product WHERE NOT LIKE 'Microsoft'"
```

## 02 - List directories including hidden files and folders

### 2.1 - Command Prompt

```
C:\> wmic.exe [/node:<IP>] [/user:<username> /password:<password>] PATH Win32_Directory WHERE "Name LIKE 'C:\\%' AND Hidden = True"
```

### 2.2 - PowerShell

```
PS C:\> Get-CimInstance [-ComputerName <IP>] -Query "SELECT Name FROM Win32_Directory WHERE Name LIKE 'C:\\%' AND Hidden = True"
```

## 03 - Find a specific program

### 3.1 - Command Prompt

Syntax

```
C:\> wmic.exe [/node:<IP>] [/user:<username> /password:<password>] datafile where "drive='C:\\' AND name like '<program.exe>'" get name /value
```

File Explorer

```
C:\> wmic.exe [/node:<IP>] [/user:<username> /password:<password>] datafile where "drive='C:\\Windows\\' AND name like 'explorer.exe'" get name /value
```

Internet Explorer

```
C:\> wmic.exe [/node:<IP>] [/user:<username> /password:<password>] datafile where "drive='C:\\Windows\\' AND name like 'iexplore.exe'" get name /value
```

Java Updater

```
C:\> wmic.exe [/node:<IP>] [/user:<username> /password:<password>] datafile where "drive='C:\\Windows\\' AND name like 'jucheck.exe'" get name /value
```

Find MSBuild C# compiler versions

```
C:\> wmic.exe [/node:<IP>] [/user:<username> /password:<password>] datafile where "drive='C:\\Windows\\Microsoft.NET\\Framework\\' AND name like 'MSBuild.exe'" get name /value
```

### 3.2 - PowerShell

TODO: Convert it to Get-CimInstance and Get-WmiObject

Syntax 

```
C:\> wmic.exe [/node:<IP>] [/user:<username> /password:<password>] datafile where "drive='C:\\' AND name like '<program.exe>'" get name /value
```

```
PS C:\> Get-CimInstance -Namespace "root\cimv2" -ClassName CIM_DataFile -Filter "Name = 'C:\\Windows\\System32\\notepad.exe'" | Select-Object Version

PS C:\> Get-WmiObject -Namespace "root\cimv2" -ClassName CIM_DataFile -Filter "Name = 'C:\\Windows\\System32\\notepad.exe'" | Select-Object Version
```

File Explorer

```
PS C:\> (Get-Command explorer.exe).Definition

PS C:\> (Get-ChildItem -Recurse -Path C:\ -Include "explorer.exe" -ErrorAction SilentlyContinue).FullName
```

Internet Explorer

```
PS C:\> (Get-Command iexplore.exe).Definition

PS C:\> (Get-ChildItem -Recurse -Path C:\ -Include "iexplore.exe" -ErrorAction SilentlyContinue).FullName
```

Java Updater

```
PS C:\> (Get-ChildItem -Recurse -Path C:\ -Include "jucheck.exe" -ErrorAction SilentlyContinue).FullName
```

Find MSBuild C# compiler versions

```
PS C:\> (Get-ChildItem -Recurse -Path C:\ -Include "MSBuild.exe" -ErrorAction SilentlyContinue).FullName

PS C:\> (Get-ChildItem -Recurse -Path \\<IP>\c$ -Include "MSBuild.exe" -ErrorAction SilentlyContinue).FullName
```

## 04 - Enumerate Program's Version

### 4.1 - Command Prompt

```
C:\> wmic.exe [/node:<IP>] [/user:<username> /password:<password>] datafile WHERE Name="C:\\Windows\\System32\\notepad.exe" get Version
```

### 4.2 - PowerShell

```
PS C:\> Get-CimInstance -Namespace "root\cimv2" -ClassName CIM_DataFile -Filter "Name = 'C:\\Windows\\System32\\notepad.exe'" | Select-Object Version

PS C:\> Get-CimInstance -Query 'SELECT Version FROM CIM_DataFile WHERE Name = "C:\\Windows\\System32\\notepad.exe"' | Select-Object Version

PS C:\> Get-WmiObject -Namespace "root\cimv2" -ClassName CIM_DataFile -Filter "Name = 'C:\\Windows\\System32\\notepad.exe'" | Select-Object Version

PS C:\> Get-WmiObject -Query 'SELECT Version FROM CIM_DataFile WHERE Name = "C:\\Windows\\System32\\notepad.exe"' | Select-Object Version
```

## 03 - Device Drivers

### 3.1 - Command Prompt

TODO: Convert it from cmdlets

```

```

### 3.2 - PowerShell

Filtering the installed 3rd party drivers with WMI.

```powershell
PS C:\> Get-CimInstance -ClassName Win32_PnPSignedDriver | Select-Object DeviceName, DriverVersion, Manufacturer | Where-Object {$_.DeviceName -like "*VMWare*"}

PS C:\> Get-CimInstance -Query "SELECT DeviceName, DriverVersion, Manufacturer WHERE LIKE '%VMWare%'"
```

Using WMI for virtualization detection.

```powershell
PS C:\> $VMAdapter = Get-CimInstance -ClassName Win32_NetworkAdapter -Filter 'Manufacturer LIKE "%VMware%" OR Name LIKE "%VMWare%"'

$VMBios = Get-CimInstance Win32_BIOS -Filter 'SerialNumber LIKE "%VMWare%"'

$VMToolsRunning = Get-CimInstance Win32_Process -Filter 'Name="vmtoolsd.exe"'

[Bool]($VMAdapter -or $VMBios -or $VMToolsRunning)
```

## 04 - Antivirus and EDR

### 4.1 - Command Prompt

```
C:\> wmic.exe [/node:<IP>] [/user:<username> /password:<password>] /namespace:\\root\securitycenter2 PATH antivirusproduct

C:\> wmic.exe [/node:<IP>] [/user:<username> /password:<password>] /namespace:\\root\securitycenter2 PATH antivirusproduct GET DisplayName, ProductState, PathToSignedProductExe

C:\> wmic.exe [/node:<IP>] [/user:<username> /password:<password>] /namespace:\\root\securitycenter2 PATH antispywareproduct get /value

C:\> wmic.exe [/node:<IP>] [/user:<username> /password:<password>] /namespace:\\root\securitycenter2 PATH firewallproduct get /value
```

### 4.2 - PowerShell

```
PS C:\> Get-CimInstance -Namespace root\securitycenter2 -ClassName Antivirusproduct

PS C:\> Get-CimInstance -Namespace root\SecurityCenter2 -ClassName AntiVirusProduct | Select-Object -Property DisplayName

PS C:\> Get-CimInstance -Namespace root\securitycenter2 -ClassName Antispywareproduct

PS C:\> Get-CimInstance -Namespace root\securitycenter2 -ClassName Firewallproduct
```

---
## References

### Backlinks

- [[06 - Tactics & Techniques & Procedures Phases/F - Post Exploitation/0x00 - Discovery/Desktop/Windows/Host/0xA - Internal Reconnaissance/Software/Discover Programs/Manual/Living off the Land]]

### Hackmag

- [Hackmag: Malware under surveillance. Sandboxes and how to detect them](https://hackmag.com/security/malware-sandbox)