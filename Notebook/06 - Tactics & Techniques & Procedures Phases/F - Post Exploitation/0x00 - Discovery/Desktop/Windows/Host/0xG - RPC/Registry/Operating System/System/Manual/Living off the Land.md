# Living off the Land

## 01 - Command Prompt

### 1.1 - Date and Time

```
C:\> reg.exe query [\\<IP>\]HKLM\SYSTEM\CurrentControlSet\Control\TimeZoneInformation
```

TODO: Check these registry entries one by one.

```
C:\> reg.exe query [\\<IP>\]HKLM\SYSTEM\CurrentControlSet\Services\W32Time\Config\LastClockRate

HKLM\SYSTEM\CurrentControlSet\Services\W32Time
HKLM\SYSTEM\CurrentControlSet\Services\W32Time\Config
HKLM\SYSTEM\CurrentControlSet\Services\W32Time\Parameters
HKLM\SYSTEM\CurrentControlSet\Services\W32Time\TimeProviders\NtpClient
HKLM\SYSTEM\CurrentControlSet\Services\W32Time\TimeProviders\NtpServer
```

### 1.2 - Windows Product Key

^a280e5

```
C:\> reg.exe query "[\\<IP>\]HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\SoftwareProtectionPlatform" /t REG_SZ /v BackupProductKeyDefault
```

#### 1.2.3 - Security Restrictions

^c27723

> [!INFO]
> If registry's value is set to `0x00` it means **User Account Control (UAC)** is disabled. Execute `PsExec64.exe` as `NT AUTHORITY\SYSTEM`.

^a57f28

```
C:\> reg.exe query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /v EnableLUA
```

Checking UAC prompt level.

> [!INFO] UAC Levels
> If the `ConsentPromptBehaviorAdmin` registry key is set to `0`. It can be bypassed to [[06 - Tactics & Techniques & Procedures Phases/F - Post Exploitation/0x02 - Privilege Escalation/Windows/Local Privilege Escalation/Bypass UAC/UAC Bypass/Manual/Living off the Land|administrative privileges]].

^8a3f38

```
C:\> reg.exe query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /v ConsentPromptBehaviorAdmin
```

```
C:\> reg.exe query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /v PromptOnSecureDesktop

https://web.archive.org/web/20240317074756/https://notes.offsec-journey.com/privilege-escalation/local-privilege-escalation
```

## 02 - PowerShell

### 2.1 - Date and Time

```
PS C:\> Get-ItemProperty Registry::HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\TimeZoneInformation
```

TODO: Check these registry entries one by one.

```
PS C:\> Get-ItemProperty Registry::HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\W32Time\Config\LastClockRate

HKLM\SYSTEM\CurrentControlSet\Services\W32Time
HKLM\SYSTEM\CurrentControlSet\Services\W32Time\Config
HKLM\SYSTEM\CurrentControlSet\Services\W32Time\Parameters
HKLM\SYSTEM\CurrentControlSet\Services\W32Time\TimeProviders\NtpClient
HKLM\SYSTEM\CurrentControlSet\Services\W32Time\TimeProviders\NtpServer
```

### 2.2 - Windows Product Key

```
PS C:\> Get-ItemProperty -Path 'Registry::HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\SoftwareProtectionPlatform' -Type "String" -Value "BackupProductKeyDefault"
```

### 2.3 - Security Restrictions

> [!INFO]
> If registry's value is set to `0x00`. Execute PsExec as `NT AUTHORITY\SYSTEM`.

```
PS C:\> Get-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" -Name EnableLUA
```

Checking UAC prompt level.

![[#^8a3f38]]

```
PS C:\> Get-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" -Name ConsentPromptBehaviorAdmin
```

```
PS C:\> Get-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" -Name PromptOnSecureDesktop

https://web.archive.org/web/20240317074756/https://notes.offsec-journey.com/privilege-escalation/local-privilege-escalation
```