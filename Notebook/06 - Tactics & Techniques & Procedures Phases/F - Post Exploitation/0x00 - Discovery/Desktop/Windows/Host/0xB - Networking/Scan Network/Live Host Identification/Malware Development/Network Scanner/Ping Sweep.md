# Ping Sweep

## Scripting

### Batch

```batch
@echo off

:: Number of scanning threads
set NUMTH=8

set ipfile=t%random%m%random%p
set scanfx=s%random%c%random%n
set /A thinc=256/%NUMTH% >nul

ping.exe -4 -n 1 -w 1 %computername% | find.exe "statistics" > %ipfile%
for /F "tokens=4,5,6,7 delims=:. " %%i in (%ipfile%) do (
  if not "%%i"=="" (
    echo Local IP address: %%i.%%j.%%k.%%l
    echo Scanning range  : %%i.%%j.%%k.0/24

    echo for /L %%a in (1,1,32) do @ping.exe -n 1 -w 1 %%i.%%j.%%k.%%a | find.exe "time=" >> %%0.log > %scanfx%1.bat
    echo for /L %%a in (33,1,64) do @ping.exe -n 1 -w 1 %%i.%%j.%%k.%%a | find.exe "time=" >> %%0.log > %scanfx%2.bat
    echo for /L %%a in (65,1,96) do @ping.exe -n 1 -w 1 %%i.%%j.%%k.%%a | find.exe "time=" >> %%0.log > %scanfx%3.bat
    echo for /L %%a in (97,1,128) do @ping.exe -n 1 -w 1 %%i.%%j.%%k.%%a | find.exe "time=" >> %%0.log > %scanfx%4.bat
    echo for /L %%a in (129,1,160) do @ping.exe -n 1 -w 1 %%i.%%j.%%k.%%a | find.exe "time=" >> %%0.log > %scanfx%5.bat
    echo for /L %%a in (161,1,192) do @ping.exe -n 1 -w 1 %%i.%%j.%%k.%%a | find.exe "time=" >> %%0.log > %scanfx%6.bat
    echo for /L %%a in (193,1,224) do @ping.exe -n 1 -w 1 %%i.%%j.%%k.%%a | find.exe "time=" >> %%0.log > %scanfx%7.bat
    echo for /L %%a in (225,1,254) do @ping.exe -n 1 -w 1 %%i.%%j.%%k.%%a | find.exe "time=" >> %%0.log > %scanfx%8.bat
  )
)

for /L %%i in (1,1,%NUMTH%) do echo @echo 1 > %%0.txt & exit >> %scanfx%%%i.bat

for /L %%i in (1,1,%NUMTH%) do start /MIN %scanfx%%%i.bat
echo Scanning...

:: Wait for all threads to finish
:waitthread
ping.exe -n 2 127.0.0.1 >nul
for /L %%i in (1,1,%NUMTH%) do if not exist %scanfx%%%i.bat.txt goto waitthread

:: Copy the scan logs to a single file
copy %scanfx%*.bat.log %scanfx%.scan.log >nul

:: Clean up, delete temp files
del /F /Q %ipfile%
for /L %%i in (1,1,%NUMTH%) do @del /F /Q %scanfx%%%i.bat
for /L %%i in (1,1,%NUMTH%) do @del /F /Q %scanfx%%%i.bat.txt
for /L %%i in (1,1,%NUMTH%) do @del /F /Q %scanfx%%%i.bat.log

start "" %windir%\notepad.exe %scanfx%.scan.log
::type %scanfx%.scan.log |more

:: Wait for notepad to open before killing the file
:waitnotepad
ping.exe -n 2 127.0.0.1 >nul
tasklist.exe /FI "WINDOWTITLE eq %scanfx%.scan.log*" | find "notepad.exe" >nul
if not "%errorlevel%"=="0" goto waitnotepad

del /F /Q %scanfx%.scan.log
```

### PowerShell

```powershell
1..254 | ForEach-Object {
    $ip = "10.10.31.$($_)"
    $ping = New-Object -TypeName System.Net.NetworkInformation.Ping
    $result = $ping.Send($ip, 100)

    if ($result.Status -eq "Success") {
        try {
            $hostname = ([System.Net.Dns]::GetHostEntry($ip)).HostName
        } catch {
            $hostname = "Unknown"
        }

        Write-Output "$ip - ($hostname)"
    }
}
```

## .NET

### C\#

```cs
using System;
using System.Net.NetworkInformation;
using System.Threading.Tasks;

class Program {
    static async Task Main(string[] args) {
        string baseIp = "192.168.1."; // Base IP address
        int start = 1;
        int end = 254;

        // Create a list to hold tasks
        var tasks = new List<Task>();

        // Loop through the range of IP addresses
        for (int i = start; i <= end; i++) {
            string ipAddress = baseIp + i;
            tasks.Add(PingAddressAsync(ipAddress));
        }

        // Wait for all tasks to complete
        await Task.WhenAll(tasks);
    }

    static async Task PingAddressAsync(string ipAddress) {
        using (Ping ping = new Ping()) {
            PingReply reply = await ping.SendPingAsync(ipAddress);

            if (reply.Status == IPStatus.Success) {
                Console.WriteLine($"Active IP: {ipAddress}");
            }
        }
    }
}
```

A longer variant.

```cs
using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Net;
using System.Net.NetworkInformation;
using System.Net.Sockets;
using System.Threading;
using System.Threading.Tasks;

namespace NetScannerApp {
    public class HostData {
        public string HostName { get; }
        public string IPAddress { get; }
        public string[] HostNameParts { get; }

        public HostData(IPHostEntry hostEntry, string ip) {
            if (hostEntry != null && !string.IsNullOrEmpty(hostEntry.HostName)) {
                HostName = hostEntry.HostName;
                HostNameParts = hostEntry.HostName.Split('.');
            } else {
                HostName = ip;
                HostNameParts = new[] { ip };
            }
            IPAddress = ip;
        }

        public override string ToString() {
            return $"{HostName} ({IPAddress})";
        }
    }

    public class NetScanner {
        public string BaseIP { get; set; } = "192.168.0.";
        public int StartIP { get; set; } = 1;
        public int StopIP { get; set; } = 254;
        public int Timeout { get; set; } = 1000;
        public int Concurrency { get; set; } = 50;
        public int Found => _nFound;

        private readonly List<HostData> _hosts = new List<HostData>();
        private readonly object _hostsLock = new object();
        private int _nFound = 0;

        private readonly Stopwatch _stopwatch = new Stopwatch();
        public TimeSpan Elapsed => _stopwatch.Elapsed;

        public event EventHandler<string> PingEvent;

        public async Task RunPingSweepAsync(CancellationToken cancellation = default) {
            if (string.IsNullOrWhiteSpace(BaseIP) || !BaseIP.EndsWith("."))
                throw new ArgumentException("BaseIP must end with a dot, e.g., \"192.168.1.\"", nameof(BaseIP));

            _stopwatch.Restart();
            Interlocked.Exchange(ref _nFound, 0);
            _hosts.Clear();

            var tasks = new List<Task>();
            using (var limiter = new SemaphoreSlim(Concurrency)) {
                for (int i = StartIP; i <= StopIP; i++) {
                    cancellation.ThrowIfCancellationRequested();
                    string ip = BaseIP + i.ToString();

                    await limiter.WaitAsync(cancellation).ConfigureAwait(false);

                    var t = Task.Run(async () => {
                        try {
                            await PingAndUpdateAsync(ip, cancellation).ConfigureAwait(false);
                        } catch (OperationCanceledException) {
                        } catch (Exception ex) {
                            Debug.WriteLine($"Error scanning {ip}: {ex.Message}");
                        } finally {
                            limiter.Release();
                        }
                    }, cancellation);

                    tasks.Add(t);
                }

                try {
                    await Task.WhenAll(tasks).ConfigureAwait(false);
                } catch (OperationCanceledException) {
                }
            }

            _stopwatch.Stop();
            PingEvent?.Invoke(this, $"Scan complete: {Found} hosts found in {Elapsed}");
        }

        private async Task PingAndUpdateAsync(string ip, CancellationToken cancellation) {
            try {
                using (var ping = new Ping()) {
                    var reply = await ping.SendPingAsync(ip, Timeout).ConfigureAwait(false);

                    if (reply.Status == IPStatus.Success) {
                        IPHostEntry hostEntry = null;
                        try {
                            hostEntry = await Dns.GetHostEntryAsync(ip).ConfigureAwait(false);
                        } catch (SocketException) {
                        } catch (Exception ex) {
                            Debug.WriteLine($"DNS error for {ip}: {ex.Message}");
                        }

                        var hostData = new HostData(hostEntry, ip);

                        lock (_hostsLock) {
                            _hosts.Add(hostData);
                        }

                        Interlocked.Increment(ref _nFound);
                        PingEvent?.Invoke(this, hostData.ToString());
                    }
                }
            } catch (PingException) {
            } catch (OperationCanceledException) {
                throw;
            } catch (Exception ex) {
                Debug.WriteLine($"Unexpected error pinging {ip}: {ex}");
            }
        }

        public IList<HostData> GetResults() {
            lock (_hostsLock) {
                return new List<HostData>(_hosts);
            }
        }
    }

    class Program {
        static async Task Main(string[] args) {
            var scanner = new NetScanner {
                BaseIP = "192.168.1.",
                StartIP = 1,
                StopIP = 254,
                Timeout = 500,
                Concurrency = 80
            };

            using (var cts = new CancellationTokenSource()) {
                Console.CancelKeyPress += (s, e) => {
                    Console.WriteLine("Cancellation requested...");
                    e.Cancel = true;
                    cts.Cancel();
                };

                scanner.PingEvent += (s, msg) => {
                    Console.WriteLine(msg);
                };

                Console.WriteLine($"Starting scan {scanner.BaseIP}{scanner.StartIP} -> {scanner.BaseIP}{scanner.StopIP}");
                try {
                    await scanner.RunPingSweepAsync(cts.Token).ConfigureAwait(false);
                } catch (OperationCanceledException) {
                    Console.WriteLine("Scan cancelled.");
                }

                Console.WriteLine();
                Console.WriteLine($"Elapsed: {scanner.Elapsed}");
                Console.WriteLine($"Hosts found: {scanner.Found}");

                var results = scanner.GetResults();
                foreach (var h in results) {
                    Console.WriteLine(h.ToString());
                }
            }
        }
    }
}
```

---
## References

### karcyeh

- [karcyeh: Batch script port scanner](https://karceh.blogspot.com/2011/06/batch-script-port-scanner.html)