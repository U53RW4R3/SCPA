# WinAPI

## Python

### `ctypes`

```python
import ctypes
import string

kernel32 = ctypes.windll.kernel32
GetLogicalDrives = kernel32.GetLogicalDrives()

def get_drives():
    drive_bitmask = GetLogicalDrives()
    drives = []

    for letter in string.ascii_uppercase:
        if drive_bitmask & (1 << (ord(letter) - ord('A'))):
            drives.append(f"{letter}:\\")

    return drives

def main() -> None:
    drives = get_drives()
    print("Logical drives:")
    for drive in drives:
        print(drive)

if __name__ == "__main__":
	main()
```

## C

```c
#include <stdio.h>
#include <windows.h>
#include <errhandlingapi.h>
#include <fileapi.h>
#include <tchar.h>

#pragma comment(lib, "kernel32.lib")

void getDrives() {
    DWORD drives = GetLogicalDrives();
    if (drives == 0) {
        printf("Failed to retrieve logical drives. Error: %lu\n", GetLastError());
        return 1;
    }

    printf("Logical drives:\n");
    for (TCHAR drive = 'A'; drive <= 'Z'; drive++) {
        if (drives & (1 << (drive - 'A'))) { // Check if the corresponding bit is set
            printf("%c:\\\n", drive);
        }
    }
}

int main() {
	getDrives();

    return 0;
}
```

An extended version to display the drive letters and volume name.

```c
#include <windows.h>
#include <wchar.h>
#include <stdio.h>

void getDrives() {
    DWORD drives = GetLogicalDrives();

    for (wchar_t letter = L'A'; letter <= L'Z'; letter++) {
        if (drives & (1 << (letter - L'A'))) {

            wchar_t root[4] = { letter, L':', L'\\', L'\0' };
            UINT type = GetDriveTypeW(root);

            if (type == DRIVE_FIXED || type == DRIVE_REMOVABLE)
            {
                wchar_t volume[256] = L"(no label)";
                DWORD serial, maxComp, flags;
                wchar_t fsName[64];

                if (GetVolumeInformationW(
                        root,
                        volume, 256,
                        &serial,
                        &maxComp,
                        &flags,
                        fsName, 64))
                {
                    // volume contains label
                }

                wprintf(L"%c: - %s\n", letter, volume);
            }
        }
    }
}

int wmain() {
    getDrives();

    return 0;
}
```

Compile the program to list the available drives.

```
$ x86_64-w64-mingw32-gcc -l kernel32 -o enumerate_drives.exe enumerate_drives.c
```

Another variant using `GetLogicalDriveStringsA()`.

```c
#include <windows.h>
#include <fileapi.h>

#pragma comment(lib, "kernel32.lib")

GetLogicalDriveStringsA()
```

## Go

```go
package main

import (
	"fmt"
	"syscall"
)

func main() {
	kernel32 := syscall.NewLazyDLL("kernel32.dll")
	getLogicalDrives := kernel32.NewProc("GetLogicalDrives")

	result, _, _ := getLogicalDrives.Call()
	bitmask := uint32(result)

	fmt.Println("Logical drives:")
	for i := 65; i < 90; i++ {
		if bitmask&(1<<(i-65)) != 0 {
			fmt.Printf("%c:\\\n", i)
		}
	}
}
```

Compile the program to list the available drives.

```
> GOOS=windows GOARCH=amd64 go build . -o enumerate_drives.exe
```

---
## References

### Table Reference

| Constant  | Value | Description            |
| --------- | ----: | ---------------------- |
| Unknown   |     0 | Unknown drive type.    |
| Removable |     1 | Removable media drive. |
| Fixed     |     2 | Local hard disk.       |
| Remote    |     3 | Network drive.         |
| CDROM     |     4 | CD-ROM drive.          |
| RAMDisk   |     5 | RAM disk.              

### Microsoft

- [C-Runtime: `_getdrives`](https://learn.microsoft.com/en-us/cpp/c-runtime-library/reference/getdrives?view=msvc-170)

- [WinAPI Documentation: `GetLogicalDriveStringsA`](https://learn.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-getlogicaldrivestringsa)

- [WinAPI Documentation: `GetLogicalDriveStringsW`](https://learn.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-getlogicaldrivestringsw)

### MalAPI

- [MalAPI: `GetLogicalDrives`](https://malapi.io/winapi/GetLogicalDrives)

### Tenouk

- [Tenouk: ModuleA](https://www.tenouk.com/ModuleA.html)

- [Tenouk: Supplement](https://www.tenouk.com/Supplement.html)

- [Tenouk: ModuleF](https://www.tenouk.com/ModuleF.html)

- [Tenouk: ModuleF1](https://www.tenouk.com/ModuleF1.html)

- [Tenouk: GetLogicalDrives Code Example](https://www.tenouk.com/cpluscodesnippet/getlogicaldrives.html)

### InstallSetupConfig

- [InstallSetupConfig: Win32 Windows Volume Program and Code Example 4](https://www.installsetupconfig.com/win32programming/windowsvolumeapis1_3.html)

- [InstallSetupConfig: Win32 Windows Volume Program and Code Example 7](https://www.installsetupconfig.com/win32programming/windowsvolumeapis1_6.html)

- [InstallSetupConfig: Win32 Windows Volume Program and Code Example 8](https://www.installsetupconfig.com/win32programming/windowsvolumeapis1_7.html)

- [InstallSetupConfig: Win32 Windows Volume Program and Code Example 9](https://www.installsetupconfig.com/win32programming/windowsvolumeapis1_8.html)

- [InstallSetupConfig:  Win32 Windows Volume Program and Code Example 10](https://www.installsetupconfig.com/win32programming/windowsvolumeapis1_9.html)

- [InstallSetupConfig: Win32 Windows Volume Program and Code Example 27](https://www.installsetupconfig.com/win32programming/windowsvolumeapis1_26.html)

### ShellGeek

- [ShellGeek: How to Get Free Disk Space in PowerShell?]([https://shellgeek.com/how-to-get-free-disk-space-in-powershell/](https://shellgeek.com/how-to-get-free-disk-space-in-powershell/))

### TrustedSec

- [TrustedSec: Enumerating Anti-Sandboxing Techniques](https://trustedsec.com/blog/enumerating-anti-sandboxing-techniques)