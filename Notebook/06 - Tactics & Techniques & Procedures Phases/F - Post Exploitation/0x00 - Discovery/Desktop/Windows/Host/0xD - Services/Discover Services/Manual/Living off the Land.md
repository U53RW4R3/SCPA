---
author(s):
  - Userware
tags:
  - post-exploitation
  - discovery
  - privilege-escalation
  - living-off-the-land
  - windows
---
# Living off the Land

## 01 - Command Prompt

Query all windows services with `net.exe`.

```
C:\> net.exe start
```

Query all windows services with **Service Control Management**.

```
C:\> sc.exe [\\<IP>] query

C:\> sc.exe [\\<IP>] queryex

C:\> sc.exe [\\<IP>] query | findstr.exe SERVICE_NAME

C:\> sc.exe [\\<IP>] query type= service state= all

C:\> sc.exe [\\<IP>] queryex type= service
```

Obtain the full path of the service executable.

```
C:\> sc.exe query state= all | findstr.exe "SERVICE_NAME:" >> services.txt & FOR /F "tokens=2 delims= " %i in (services.txt) DO @echo %i >> binaries.txt & FOR /F %i in (binaries.txt) DO @(@echo %i & @echo --------- & @sc.exe qc %i | findstr.exe "BINARY_PATH_NAME" & @echo.) & del services.txt 2>nul & del binaries.txt 2>nul
```

## 02 - PowerShell

```
PS C:\> Get-Service | Format-List

PS C:\> Get-Service [-ComputerName <IP>] | Format-List

PS C:\> Get-Service | Where-Object {?_.Status -eq "Running" } | Format-Wide -Property Name -Column 1

PS C:\> Get-Service [-ComputerName <IP>] | Where-Object {?_.Status -eq "Running" } | Format-Wide -Property Name -Column 1
```

## 03 - Sysinternals

> [!IMPORTANT] Conditions
> To execute sysinternal tool. EULA must be accepted (`-accepteula`). Otherwise this can be done in registry hive.
> ```
> C:\> reg.exe add [\\<IP>\]HKCU\Software\Sysinternals /t REG_DWORD /v 'EulaAccepted' /d 0x00000001
> 
> PS C:\> Set-ItemProperty -Path 'Registry::HKEY_CURRENT_USER\Software\Sysinternals' -Type DWord -Name 'EulaAccepted' -Value 0x00000001
> ```

### 3.1 - Copy File from WebDAV

#### 3.1.1 - Command Prompt

```
C:\> net.exe use z: \\live.sysinternals.com\tools

copy z:\PsService64.exe .

net.exe use z: /delete
```

#### 3.1.2 - PowerShell

```
PS C:\> New-PSDrive -Name Z -PSProvider FileSystem -Root "\\live.sysinternals.com\tools"

PS C:\> Copy-Item z:\PsService64.exe .

PS C:\> Remove-PSDrive -Name Z
```

Using sysinternals toolkit to enumerate the path to look for possible misconfigured services. Automatically accept the EULA in order to use the binary.

```
C:\> .\PsService64.exe /accepteula
```

Query all windows services.

```
C:\> .\PsService64.exe [\\<IP>] query
```

---
## References

### LOFLCAB

- [LOFLCAB: Get-Service](https://lofl-project.github.io/loflcab/Cmdlets/Get-Service/)

### Steflan Security

- [Steflan Security: Windows Privilege Escalation Weak Permission](https://steflan-security.com/windows-privilege-escalation-weak-permission/)