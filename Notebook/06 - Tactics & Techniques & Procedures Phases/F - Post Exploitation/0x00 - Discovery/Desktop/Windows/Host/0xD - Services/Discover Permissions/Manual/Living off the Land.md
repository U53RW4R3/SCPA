---
author(s):
  - Userware
tags:
  - post-exploitation
  - discovery
  - privilege-escalation
  - living-off-the-land
  - windows
---
# Living off the Land

## 01 - Command Prompt

### 1.1 - `icacls.exe`

Finding installed program inside folders that contains **full access permissions** that the **Users** and the rest of the groups configuration.

```
C:\> icacls.exe "C:\Program Files\*" 2>nul | findstr.exe "(F)" | findstr.exe "Everyone"

C:\> icacls.exe "C:\Program Files (x86)\*" 2>nul | findstr.exe "(F)" | findstr.exe "Everyone"

C:\> cacls.exe "c:\Program Files" /T | findstr.exe Users

C:\> icacls.exe "C:\Program Files\*" 2>nul | findstr.exe "(F)" | findstr.exe "BUILTIN\Users"

C:\> icacls.exe "C:\Program Files (x86)\*" 2>nul | findstr.exe "(F)" | findstr.exe "BUILTIN\Users"

C:\> icacls.exe "C:\Program Files\*" 2>nul | findstr.exe "(F)" | findstr.exe "Authenticated Users"

C:\> icacls.exe "C:\Program Files (x86)*" 2>nul | findstr.exe "(F)" | findstr.exe "Authenticated Users"
```

Finding installed programs inside folders that contains **modifiable permissions** that the **Users** and the rest of the groups configuration.

```
C:\> icacls.exe "C:\Program Files\*" 2>nul | findstr.exe "(M)" | findstr.exe "Everyone"

C:\> icacls.exe "C:\Program Files (x86)\*" 2>nul | findstr.exe "(M)" | findstr.exe "Everyone"

C:\> cacls.exe "c:\Program Files" /T | findstr.exe Users

C:\> icacls.exe "C:\Program Files\*" 2>nul | findstr.exe "(M)" | findstr.exe "BUILTIN\Users"

C:\> icacls.exe "C:\Program Files (x86)\*" 2>nul | findstr.exe "(M)" | findstr.exe "BUILTIN\Users"

C:\> icacls.exe "C:\Program Files (x86)*" 2>nul | findstr.exe "(M)" | findstr.exe "Authenticated Users"

C:\> icacls.exe "C:\Program Files (x86)\*" 2>nul | findstr.exe "(M)" | findstr.exe "Authenticated Users"
```

### 1.2 - SCManager

Check permissions for service creation. Refer to this [[SCManager References|table section]].

```
C:\> sc.exe sdshow scmanager
```

## 02 - PowerShell

Running the powershell cmdlet with `Get-Acl` to find certain permissions.

```
PS C:\> Get-ChildItem "C:\Program Files" -Recurse | Get-Acl | ?{$_.AccessToString -match "Everyone\sAllow\s\sModify"}
```

## 03 - Sysinternals

### 3.1 - AccessChk

> [!IMPORTANT] Conditions
> To execute sysinternal tool. EULA must be accepted (`-accepteula`). Otherwise this can be done in registry hive.
> ```
> C:\> reg.exe add [\\<IP>\]HKCU\Software\Sysinternals /t REG_DWORD /v 'EulaAccepted' /d 0x00000001
> 
> PS C:\> Set-ItemProperty -Path 'Registry::HKEY_CURRENT_USER\Software\Sysinternals' -Type DWord -Name 'EulaAccepted' -Value 0x00000001
> ```

#### 3.1.1 - Copy File from WebDAV

##### 3.1.1.1 - Command Prompt

```
C:\> net.exe use z: \\live.sysinternals.com\tools

copy z:\accesschk64.exe .

net.exe use z: /delete
```

##### 3.1.1.2 - PowerShell

```
PS C:\> New-PSDrive -Name Z -PSProvider FileSystem -Root "\\live.sysinternals.com\tools"

PS C:\> Copy-Item z:\accesschk64.exe .

PS C:\> Remove-PSDrive -Name Z
```

Using sysinternals toolkit to enumerate the path to look for possible misconfigured services. Automatically accept the EULA in order to use the binary.

```
C:\> .\accesschk64.exe /accepteula
```

Enumerating directories permissions' in the `"C:\Program Files"` and `"C:\Program Files (x86)"` path.

```
C:\> .\accesschk64.exe -uwcqv Users "C:\Program Files"

C:\> .\accesschk64.exe -uwcqv "Authenticated Users" "C:\Program Files"

C:\> .\accesschk64.exe -uws "Everyone" "C:\Program Files"

C:\> .\accesschk64.exe -uwcqv Users "C:\Program Files (x86)"

C:\> .\accesschk64.exe -uwcqv "Authenticated Users" "C:\Program Files (x86)"

C:\> .\accesschk64.exe -uws "Everyone" "C:\Program Files (x86)"
```

Enumerating services that the users have been granted access of what permissions

```
C:\> .\accesschk64.exe -uwcqv Users *

C:\> .\accesschk64.exe -uwcqv "Authenticated Users" *

C:\> .\accesschk64.exe -uwcqv "Everyone" *
```

Enumerating the directories that contains users group permissions on each drive

```
C:\> .\accesschk64.exe -uwcqv Users C:\

C:\> .\accesschk64.exe -uwcqv "Authenticated Users" C:\

C:\> .\accesschk64.exe -uwcqv "Everyone" C:\

C:\> .\accesschk64.exe -uwcqv Users C:\*.*

C:\> .\accesschk64.exe -uwcqv "Authenticated Users" C:\*.*

C:\> .\accesschk64.exe -uwcqv "Everyone" C:\*.*
```

Enumerating global objects that anyone modify

```
C:\> .\accesschk64.exe -wuo everyone \basednamedobjects
```

### 3.2 - Sysmon

Find the Sysmon executable process

```
C:\> tasklist.exe [/s <IP>] [/u <username> /p <password>] /svc | findstr.exe /i sysmon
```

Get configuration

```
C:\> Sysmon64.exe -c

C:\> Sysmon64.exe -s

C:\> dir /s *.xml
```