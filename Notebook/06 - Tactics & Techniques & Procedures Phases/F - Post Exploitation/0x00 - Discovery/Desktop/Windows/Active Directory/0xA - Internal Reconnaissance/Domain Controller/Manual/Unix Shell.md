---
author(s):
  - Userware
tags:
  - post-exploitation
  - discovery
  - active-directory
  - staying-off-the-land
  - networking
  - network-ports
  - dns
  - msrpc
  - ldap
  - windows
---
# Unix Shell

## 01 - DNS Port

TODO: Convert the `nslookup` command to `dig`.

Enumerate the **PDC (Principal Domain Controller)**.

```
$ nslookup -type=srv _ldap._tcp.pdc._msdcs.<domain>.<tld>
```

Enumerate the **domain controllers**.

```
$ nslookup -type=srv _ldap._tcp.dc._msdcs.<domain>.<tld>
```

Enumerate the **GC (Global Catalog, i.e. DC with extended data)**.

```
$ nslookup -type=srv gc._msdcs.<domain>.<tld>
```

Other ways to find services hosts that may be DCs.

```
$ nslookup -type=srv _kerberos._tcp.<domain>.<tld>

$ nslookup -type=srv _kpasswd._tcp.<domain>.<tld>

$ nslookup -type=srv _ldap._tcp.<domain>.<tld>
```

Dump DNS records in a domain.

```
$ dig axfr @<domain_controller_IP> <domain>.<tld>
```

## 02 - MSRPC Port

TODO: Fill this info

Domain Information

```
rpcclient $> querydominfo

rpcclient $> enumdomains
```

Enumerate trusted domains within an AD forest.

```
rpcclient $> dsenumdomtrusts
```

Enumerate domain name and SID

```
rpcclient $> lsaquery

rpcclient $> dsroledominfo
```

Retrieve Domain SID

```
rpcclient $> lookupdomain <domain>
```

Domain password Information.

```
rpcclient $> getdompwinfo
```

Retrieve password policy.

```
rpcclient $> polenum
```

## 03 - LDAP Port

Enumerate **domain controllers**.

```
$ ldapsearch -x -D '<DOMAIN>\<username>' -w '' -b "(&(objectCategory=Computer)(userAccountControl:1.2.840.113556.1.4.803:=8192))" -H ldap://<IP>
```

Enumerate **windows servers**.

```
$ ldapsearch -x -D '<DOMAIN>\<username>' -w '' -b "(&(&(&(&(samAccountType=805306369)(!(primaryGroupId=516)))(objectCategory=computer)(operatingSystem=Windows Server*))))" -H ldap://<IP>
```

Retrieve password policy.

```
$ ldapsearch -x -D '<DOMAIN>\<username>' -w '' -b "(&(objectClass=msDS-PasswordSettings))" -H ldap://<IP>
```

---
## References

### Backlinks

- [[06 - Tactics & Techniques & Procedures Phases/A - Information Gathering/0x02 - Active Fingerprinting/Network Ports/Cross Platform/Remote Services/Telnet|Manual: Telnet Active Enumeration]]

### The Hacker Recipes

- [The Hacker Recipes: DNS](https://www.thehacker.recipes/ad/recon/dns)