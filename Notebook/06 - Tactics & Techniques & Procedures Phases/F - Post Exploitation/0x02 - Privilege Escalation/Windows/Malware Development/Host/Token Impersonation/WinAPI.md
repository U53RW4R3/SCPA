# WinAPI

## Python

### `pywin32`

```python
import ctypes
import os
import pythoncom
import win32con
import win32security
import win32com.client

LOGON32_LOGON_INTERACTIVE = win32con.LOGON32_LOGON_INTERACTIVE
LOGON32_PROVIDER_DEFAULT = win32con.LOGON32_PROVIDER_DEFAULT

ImpersonateLoggedOnUser = win32security.ImpersonateLoggedOnUser
RevertToSelf = win32security.RevertToSelf

CoInitialize = pythoncom.CoInitialize

wmi = win32com.client.GetObject("winmgmts:")

def get_token(username, password, domain=None):
    if domain:
        user = f"{domain}\\{username}"
    else:
        user = username

    try:
        token = win32security.LogonUser(
            user,
            domain,
            password,
            LOGON32_LOGON_INTERACTIVE,
            LOGON32_PROVIDER_DEFAULT
        )
        return token
    except Exception as e:
        print(f"Error getting token: {str(e)}")
        return None

def impersonate(token) -> bool:
    try:
        ImpersonateLoggedOnUser(token)
    except Exception as e:
        print(f"Error impersonating: {str(e)}")
        return False
    return True

def revert_to_self(token) -> bool:
    try:
        RevertToSelf()
    except Exception as e:
        print(f"Error reverting to self: {str(e)}")
        return False

def main():
    username = "Administrator"
    password = ""
    domain = None

    token = get_token(username, password, domain)

    if token:
        if impersonate(token):
            try:
                CoInitialize()
                for process in wmi.InstancesOf("Win32_Process")
                    print(f"Process Name: {process.Name}")

                CoInitialize()
            except Exception as e:
                print(f"Impersonation failed")

if __name__ == "__main__":
    main()
```

## C++

```cpp
#include <windows.h>

INT WINAPI wWinMain(
_In_ HINSTANCE hInstance,
_In_opt_ HINSTANCE PrevInstance,
_In_ PWSTR szCmdLine,
_In_ INT nShowCmd
) {
    // token impersonation
    HANDLE handle_token;
    LUID luid;

    ::LookupPrivilegeValue(NULL, SE_SHUTDOWN_NAME, &luid);

    TOKEN_PRIVILEGES token_privileges;
    token_privileges.Privileges[0].Luid = luid;
    token_privileges.Privileges[0].Attributes = SE_PRIVILEGE_ENABLED;
    token_privileges.PrivilegeCount = 1;

    ::OpenProcessToken(::GetCurrentProcess(), TOKEN_ALL_ACCESS, &handle_token);
    ::AdjustTokenPrivileges(handle_token, false, &token_privileges, sizeof(token_privileges), NULL, NULL);

    return 0;
}
```

---
## References

### Tenouk

- [Tenouk: Windows OS Security - Access Control Story - Part 1](https://www.tenouk.com/ModuleH.html)

- [Tenouk: Windows OS Security - Access Control Story - Part 6](https://www.tenouk.com/ModuleI2.html)

- [Tenouk: Windows OS Security - Access Control Story - Part 8](https://www.tenouk.com/ModuleI3.html)

- [Tenouk: Windows OS Security - Access Control Story - Part 10](https://www.tenouk.com/ModuleJ.html)

- [Tenouk: Windows OS Security - Access Control Story - Part 11](https://www.tenouk.com/ModuleJ1.html)

- [Tenouk: Windows OS Security - Access Control Story - Part 12](https://www.tenouk.com/ModuleK.html)

- [Tenouk: Windows OS Security - Access Control Story - Part 13](https://www.tenouk.com/ModuleK1.html)

- [Tenouk: Windows OS Security - Access Control Story - Part 14](https://www.tenouk.com/ModuleL.html)

- [Tenouk: Windows OS Security - Access Control Story - Part 15](https://www.tenouk.com/ModuleL1.html)

- [Tenouk: Windows Process & Threads - A Supplementary Note](https://www.tenouk.com/chijklsupp.html)

- [Tenouk: Windows Access Controls - A Supplementary Note](https://www.tenouk.com/chijklsupptwo.html)

### Decoder

- [Decoder: Windows Named Pipes & Impersonation](https://decoder.cloud/2019/03/06/windows-named-pipes-impersonation/)

### DMCXBlue

- [DMCXBlue: Create Process with Token](https://dmcxblue.gitbook.io/red-team-notes-2-0/red-team-techniques/privilege-escalation/t1134-access-token-manipulation/create-process-with-token)

### Bordergate

- [Bordergate: Access Token Manipulation](https://www.bordergate.co.uk/access-token-manipulation/)