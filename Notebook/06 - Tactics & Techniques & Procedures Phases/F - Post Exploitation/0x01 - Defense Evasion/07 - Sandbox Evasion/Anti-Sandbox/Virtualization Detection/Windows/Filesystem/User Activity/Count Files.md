# Count Files

## Downloaded Files

https://github.com/soc-otter/Blue/blob/main/Download_Folder_Files_All_Users.ps1
https://github.com/soc-otter/Blue/blob/main/Internet_Downloaded_Files.ps1

```
C:\\Users\\<username>\\Downloads
```

## Autosaved Files

https://github.com/soc-otter/Blue/blob/main/Notepad_AutoSaved_Files_All_Users.ps1
https://github.com/soc-otter/Blue/blob/main/PowerShell_ISE_AutoSaved_Files_All_Users.ps1 

```

```
## Recent Files

```
HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\RecentDocs
```

### WinAPI

 This will check the total number of recent files under the current userâ€™s home directory. If the total number is less than five, exit. 

```cpp
int file_count = 0;

DWORD dwRet;
LPTSTR pszOldVal;
pszOldVal = (LPTSTR)malloc(4096 * sizeof(TCHAR));
dwRet = GetEnvironmentVariable("USERPROFILE", pszOldVal, 4096);

std::string stdstr = pszOldVal;
stdstr += "\\AppData\\Roaming\\Microsoft\\Windows\\Recent\\*";

LPSTR s = const_cast<char *>(stdstr.c_str());

WIN32_FIND_DATA data;
HANDLE hFind = FindFirstFile(s, &data);

if (hFind != INVALID_HANDLE_VALUE) {
           do {
                       file_count++;
           } while (FindNextFile(hFind, &data));
           FindClose(hFind);
}

if (file_count < 5) {
           return 0;
}
```

### PowerShell

https://github.com/soc-otter/Blue/blob/main/Recent_Files_and_Directories.ps1

https://github.com/soc-otter/Blue/blob/main/Word_Document_History_All_Users.ps1

```powershell
$registryEntries = Get-ChildItem 'Registry::HKEY_USER\*\Software\Microsoft\Office\*\Word\Reading Locations\*' -ErrorAction SilentlyContinue
$totalEntries = $registryEntries.Count
$currentEntry = 0
```

## Trusted Documents

### PowerShell

https://github.com/soc-otter/Blue/blob/main/Documents_Users_Trusted_and_Enabled.ps1

## Temp Files

### Userland

 This will check for the number of temporary files in a directory normally written to if the user does not have local administrative privileges. If the count is less than three, exit. 

```cpp
int file_count = 0;
DWORD dwRet;   
LPTSTR pszOldVal;
pszOldVal = (LPTSTR)malloc(4096 * sizeof(TCHAR));
dwRet = GetEnvironmentVariable("TEMP", pszOldVal, 4096); // get path from environment variable

std::string stdstr = pszOldVal;
stdstr += "\\*";

LPSTR s = const_cast<char *>(stdstr.c_str());

WIN32_FIND_DATA data;
HANDLE hFind = FindFirstFile(s, &data);

if (hFind != INVALID_HANDLE_VALUE) {
            do {
                      file_count++;
            } while (FindNextFile(hFind, &data));
            FindClose(hFind);
}

if (file_count < 3) {
         return 0;
}
```

### Elevated

 This will check for the number of temporary files in a directory normally written to if the user has local administrative privileges. If the count is less than three, exit. 

```cpp
int file_count = 0;

DWORD dwRet;   
LPTSTR pszOldVal;
pszOldVal = (LPTSTR)malloc(4096 * sizeof(TCHAR));
WIN32_FIND_DATA data2;
HANDLE hFind2 = FindFirstFile("C:\\Windows\\Temp\\*", &data2);

if (hFind2 != INVALID_HANDLE_VALUE) {
          do {
                     file_count++;
          } while (FindNextFile(hFind2, &data2));
          FindClose(hFind2);
}
if (file_count < 3) {
         return 0;
}
```

---
## References

### Red Team Guides

- [Red Team Guides: Registry Attack Vectors](https://blog.redteamguides.com/registry-attack-vectorsrtc0018)

### TrustedSec

- [TrustedSec: Enumerating Anti-Sandboxing Techniques](https://trustedsec.com/blog/enumerating-anti-sandboxing-techniques)

### DMCXBlue

- [DMCXBlue Gitbook: User Activity Based Checks](https://dmcxblue.gitbook.io/red-team-notes-2-0/red-team-techniques/defense-evasion/t1497-virtualization-sandbox-evasion/user-activity-based-checks)