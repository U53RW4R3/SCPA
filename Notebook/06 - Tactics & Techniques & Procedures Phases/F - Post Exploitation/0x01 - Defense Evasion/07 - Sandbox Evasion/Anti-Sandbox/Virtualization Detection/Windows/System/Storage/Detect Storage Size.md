---
author(s):
  - Userware
tags:
  - malware-development
  - defense-evasion
---
# Detect Storage Size

## Total Disk Size

```c
HANDLE drive;
BOOL result;
GET_LENGTH_INFORMATION size;
DWORD lpBytesReturned;

drive = CreateFile("\\\\.\\PhysicalDrive0", GENERIC_READ, FILE_SHARE_READ, NULL, OPEN_EXISTING, 0, NULL);
if (drive == INVALID_HANDLE_VALUE) {
            // Someone is playing tricks. Or not enough privileges.
            CloseHandle(drive);
            return FALSE;
}
result = DeviceIoControl(drive, IOCTL_DISK_GET_LENGTH_INFO, NULL, 0, &size,
         sizeof(GET_LENGTH_INFORMATION), &lpBytesReturned, NULL);
CloseHandle(drive);
if (result != 0) {
	if (size.Length.QuadPart / 1073741824 <= 60) /* <= 60 GB */
		return 0;
}
```

```cpp
#include <iostream>
#include <string>
#include <windows.h>

bool check_storage_size() {
    HANDLE hDevice = CreateFileW(L"\\\\.\\PhysicalDrive0", 0, FILE_SHARE_READ | FILE_SHARE_WRITE, NULL, OPEN_EXISTING, 0, NULL);
    DISK_GEOMETRY pDiskGeometry;
    DWORD bytesReturned;
    DeviceIoControl(hDevice, IOCTL_DISK_GET_DRIVE_GEOMETRY, NULL, 0, &pDiskGeometry, sizeof(pDiskGeometry), &bytesReturned, (LPOVERLAPPED)NULL);
    DWORD diskSizeGB;
    diskSizeGB = pDiskGeometry.Cylinders.QuadPart * (ULONG)pDiskGeometry.TracksPerCylinder * (ULONG)pDiskGeometry.SectorsPerTrack * (ULONG)pDiskGeometry.BytesPerSector / 1024 / 1024 / 1024;

    if (diskSizeGB < 100) return true;

    return false;
}

int main() {
    if (!check_storage_size()) {
        std::cout << "Executing payload!" << std::endl;
    }
    return 0;
}
```

## Free Space

### Scripting

```powershell
function Check-AvailableStorage {
    $totalGB = 0

    # Get all logical disks (including removable drives)
    $disks = Get-CimInstance -ClassName Win32_LogicalDisk -Filter "DriveType=3"

    foreach ($disk in $disks) {
        # Size is in bytes; convert to GB and round down
        $totalGB += [math]::Floor($disk.Size / 1GB)
    }

    if ($totalGB -lt 60) {
        # Placeholder for whatever action you need when storage is low
        Write-Host "Available storage is less than 60â€¯GB."
        # Example: pause for a few seconds
        Start-Sleep -Seconds 5
    }
}
```

## Used Space

```

```

---
## References

### Backlinks

- [[06 - Tactics & Techniques & Procedures (TTPs) Phases/F - Post Exploitation/0x00 - Enumeration and Discovery/Desktop/Windows/Malware Development/System/Storage Space]]

### TrustedSec

- [TrustedSec: Enumerating Anti-Sandboxing Techniques](https://trustedsec.com/blog/enumerating-anti-sandboxing-techniques)