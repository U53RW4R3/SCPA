# USB Activity

## Scripting

### Python

```python
import subprocess

def check_usb() -> bool:
	commands: list = ['wmic.exe', 'logicaldisk', 'get', 'DriveType,', 'caption']
	output = subprocess.check_output(commands, shell=True)

	for drive in str(output).strip().split('\\r\\r\\n'):
		if '2' in drive:
			drive_letter = drive.split(':')[0]
			drive_type = drive.split(':')[1].strip()
			if drive_type == '2':
				return True
		else:
			return False

if __name__ == "__main__":
	if check_usb():
		print("Removable media is present!")
	else:
		print("Not found!")
```

### Batch

```batch
@echo off
setlocal enabledelayedexpansion

:: Get a list of all drive letters
for /F "tokens=2-99 delims=:\" %%a in ('fsutil fsinfo drives') do (
    :: The tokenized variables %%a, %%b, %%c... hold the drive letters (C, D, E...)
    for %%c in (%%a %%b %%c %%d %%e %%f %%g %%h) do (
        :: Check if the drive letter is not empty then outputs a string like "Drive type is Removable"
        if not "%%c"=="" (
            for /F "tokens=3" %%d in ('fsutil fsinfo drivetype %%c:') do (
                if /I "%%d"=="Removable" (
                    echo Drive %%c: is Removable (USB^)
                )
            )
        )
    )
)
```

### PowerShell

```powershell
$usbDrive = Get-CimInstance -Query "SELECT * FROM Win32_DiskDrive WHERE InterfaceType='USB'"

if ($usbDrive) {
	Write-Output "USB drive is connected."
} else {
	Write-Output "No USB drive detected"
}
```

## WinAPI

### Python

You find a removable media with a specific label name.

```python
import subprocess
import sys
from time import sleep
import psutil
import win32api

def get_drives() -> int:
	get_drive = subprocess.getoutput("fsutil.exe fsinfo drives").split(" ")[1:]
	last_drive = get_drive[-1]
	length_drives = get_drive.index(last_drive)
	return length_drives + 1

def check_usb_name(label_name: str) -> bool:
	for drive in range(0, get_drives()):
		try:
			removable = psutil.disk_partitions()[drive][3].split(",")[1]

			if "removable" in removable:
				disk_name = psutil.disk_partitions()[drive][1]
				disk_label = win32api.GetVolumeInformation(f"{disk_name}\\")[0]

				
				if disk_label == label_name:
					return True
		except IndexError:
			pass

	return False

if __name__ == '__main__':
	# Choose a specific removable media using label name to detect it
	removable_media_name = 'LABEL NAME'

	if check_usb_name(removable_media_name):
		print("USB drive detected:", str(removable_media_name))
	else:
		print("Not found!")
```

### C

```c
#include <windows.h>
#include <fileapi.h>
#include <tchar.h>

bool checkUSB() {
    DWORD drives = GetLogicalDrives();

    for (DWORD i = 0; i < 26; i++) {
        if ((drives >> i) & 1) {
            TCHAR drivePath[] = {0, ':', '\\', '\0'};
            drivePath[0] = (TCHAR)('A' + i);

            // GetDriveType is mapped to GetDriveTypeA or GetDriveTypeW depending on UNICODE define
            UINT driveType = GetDriveTypeW(drivePath);

            if (driveType == DRIVE_REMOVABLE) {
                return TRUE;
            }
        }
    }

    return FALSE;
}
```

---
## References

### Backlinks

- [[06 - Tactics & Techniques & Procedures Phases/F - Post Exploitation/0x00 - Discovery/Desktop/Windows/Host/0xF - Operating System/Hardware/Malware Development/Mounted Drives/CRT|Discovery: Mounted Drives C Runtime]]

- [[06 - Tactics & Techniques & Procedures Phases/F - Post Exploitation/0x00 - Discovery/Desktop/Windows/Host/0xF - Operating System/Hardware/Malware Development/Mounted Drives/WinAPI|Discovery: Mounted Drives WinAPI]]