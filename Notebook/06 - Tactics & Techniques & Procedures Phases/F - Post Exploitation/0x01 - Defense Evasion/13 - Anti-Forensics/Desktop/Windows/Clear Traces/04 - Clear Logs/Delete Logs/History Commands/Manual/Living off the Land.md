---
author(s):
  - Userware
tags:
  - post-exploitation
  - defense-evasion
  - anti-forensics
  - living-off-the-land
  - T1070-003
  - windows
---
# Living off the Land

## 01 - Registry Logs

### 1.1 - Windows Dialog Box

#### 1.1.1 - Command Prompt

Delete commands history that was executed from windows dialog box.

```
C:\> reg.exe query [\\<IP>\]HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\RunMRU

C:\> reg.exe delete [\\<IP>\]HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\RunMRU /va /reg:64 /f
```

#### 1.1.2 - PowerShell

Delete commands history that was executed from windows dialog box.

```
PS C:\> Get-ItemProperty -Path Registry::HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\RunMRU

PS C:\> Remove-ItemProperty -Path Registry::HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\RunMRU -Name * -Force
```

### 1.2 - Windows File Explorer

#### 1.2.1 - Command Prompt

Query registry values if it contains history that must be erased.

```
C:\> reg.exe query [\\<IP>\]HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\TypedPaths

C:\> reg.exe query /s [\\<IP>\]HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\ComDlg32
```

Delete paths history that was executed from windows explorer (`explorer.exe`).

```
C:\> reg.exe delete [\\<IP>\]HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\TypedPaths /va /reg:64 /f

C:\> reg.exe query /s [\\<IP>\]HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\ComDlg32\LastVisitedPidMRU /va /reg:64

C:\> reg.exe query /s [\\<IP>\]HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\ComDlg32\OpenSavePidlMRU /va /reg:64
```

#### 1.2.2 - PowerShell

Query registry values if it contains history that must be erased.

```
PS C:\> Get-ItemProperty -Path Registry::HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\TypedPaths

PS C:\> Get-ItemProperty -Recurse -Path Registry::HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\ComDlg32
```

Delete paths history that was executed from windows explorer (`explorer.exe`).

```
PS C:\> Remove-ItemProperty -Path Registry::HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\TypedPaths -Name * -Force

PS C:\> Remove-ItemProperty -Path Registry::HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\ComDlg32\LastVisitedPidMRU -Name * -Force

PS C:\> Remove-ItemProperty -Path Registry::HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\ComDlg32\OpenSavePidlMRU -Name * -Force
```

### 1.3 - Windows Search

#### 1.3.1 - Command Prompt

Delete windows search history.

```
C:\> reg.exe query "[\\<IP>\]HKLM\SOFTWARE\Policies\Microsoft\Windows\Windows Search"

C:\> reg.exe delete "[\\<IP>\]HKLM\SOFTWARE\Policies\Microsoft\Windows\Windows Search" /va /reg:64 /f
```

#### 1.3.2 - PowerShell

Delete windows search history.

```
PS C:\> Get-ItemProperty -Path "Registry::HKEY_LOCAL_MACHINE\Policies\Microsoft\Windows\Windows Search"

PS C:\> Remove-ItemProperty -Path "Registry::HKEY_LOCAL_MACHINE\Policies\Microsoft\Windows\Windows Search" -Name * -Force
```

### 1.4 - Document History

#### 1.4.1 - Command Prompt

```
C:\> reg.exe query "[\\<IP>\]HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\RecentDocs"

C:\> reg.exe delete "[\\<IP>\]HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\RecentDocs" /va /reg:64 /f
```

#### 1.4.2 - PowerShell

```
PS C:\> Get-ItemProperty -Path "Registry::HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\RecentDocs"

PS C:\> Remove-ItemProperty -Path "Registry::HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\RecentDocs" -Name * -Force
```

### 1.5 - GUI Programs Count History

#### 1.5.1 - Command Prompt

```
C:\> reg.exe query /s "[\\<IP>\]HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\UserAssist"

C:\> reg.exe delete /s "[\\<IP>\]HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\UserAssist" /va /reg:64 /f
```

#### 1.5.2 - PowerShell

```
PS C:\> Get-ItemProperty -Recurse -Path "Registry::HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\UserAssist"

PS C:\> Remove-ItemProperty -Path "Registry::HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\UserAssist\*" -Name * -Force
```

## 02 - Command Prompt History Commands

To clear command prompt history the shortcut keys are **ALT+F7** then check it's gone.

```
C:\> doskey.exe /history
```

## 03 - PowerShell History Commands

### 3.1 - Command Prompt

```
C:\> del C:\Users\%USERNAME%\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt

C:\> del %USERPROFILE%\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt
```

### 3.2 - PowerShell

```powershell
PS C:\> Clear-Content C:\Users\$Env:USERNAME\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt

PS C:\> Clear-Content $Env:USERPROFILE\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt

PS C:\> Write-Output "" > (Get-PSReadlineOption).HistorySavePath
```