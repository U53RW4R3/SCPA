# Command Execution

## Run As Administrator

```cpp
#include <windows.h>
#include <shellapi.h>

#pragma comment(lib, "shell32.lib")

BOOL run() {
 const std::shared_ptr<TCHAR> process_path { new TCHAR[MAX_PATH]()};
 ::GetModuleFileNameExW(::GetCurrentProcess(), nullptr, process_path.get(), MAX_PATH);
 const auto arg = std::wstring{ L"/c " } +process_path.get();

 SHELLEXECUTEINFO exec_info{};
 exec_info.cbSize = sizeof(exec_info);
 exec_info.hwnd = nullptr;
 exec_info.lpVerb = L"runas";
 exec_info.lpFile = L"cmd.exe";
 exec_info.lpParameters = arg.c_str();
 exec_info.nShow = SW_SHOW; // SW_HIDE;

 return ::ShellExecuteEx(&exec_info);
}
```

Compile the payload.

```
$ x86_64-w64-mingw32-g++ -l shell32 -o payload.exe payload.cpp
```

---
## References

### Backlinks

- [[Enumerate Builtin Functions]]

### Microsoft

- [Microsoft Documentation: Shell.ShellExecute](https://docs.microsoft.com/en-us/windows/win32/shell/shell-shellexecute)

### MalAPI

- [MalAPI: `ShellExecuteA`](https://malapi.io/winapi/ShellExecuteA)

- [MalAPI: `ShellExecuteExA`](https://malapi.io/winapi/ShellExecuteExA)

### Tenouk

- [Tenouk: Processes and Threads - C Run-Time - Part 1](https://www.tenouk.com/ModuleR.html)

- [Tenouk: Processes and Threads - C Run-Time - Part 2](https://www.tenouk.com/ModuleR1.html)

### Secrary

- [secrary: RedTeamTrick](https://secrary.com/posts/redteamtrick/)