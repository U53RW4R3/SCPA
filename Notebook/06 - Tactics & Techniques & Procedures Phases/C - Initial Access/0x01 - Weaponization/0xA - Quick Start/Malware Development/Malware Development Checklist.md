---
author(s):
  - Userware
tags:
  - checklist
  - malware-development
  - initial-access
  - defense-evasion
---
# Malware Development Checklist

TODO: Provide a checklist for developing payloads with a general context to improve evasion success rate

- Create steps to make a flowchart diagram of what evasion features to implement the program. It allows you to articulate to understand of what an engineer or a programmer would think.
- Most importantly never reinvent the wheel unless you want to be a persistent adversary.
- Find references from malware analysis blog post or research whitepapers that provides to generate new ideas of what to make.

## Data Integrity

- [ ] Ensure your malware isn't tampered. Use digest hash algorithm.

## Whitelisting

- [ ] [[06 - Tactics & Techniques & Procedures Phases/C - Initial Access/0x01 - Weaponization/0xA - Quick Start/Malware Development/Helpers/Evasion/Detection/Hardware/Windows/MAC Address|List of MAC Addresses]].
- [ ] [[Blacklist IP Ranges|List of IP Addresses]].
- Timezones
	- [ ] Local system-based timezone
	- [ ] Internet connected timezone
		- Using NTP (Network Time Protocol)
		- Using third-party services

## Blacklisting

- [ ] [[06 - Tactics & Techniques & Procedures Phases/C - Initial Access/0x01 - Weaponization/0xA - Quick Start/Malware Development/Helpers/Evasion/Detection/Hardware/Windows/MAC Address|List of MAC Addresses]].
- [ ] [[Blacklist IP Ranges|List of IP Addresses]].
- Timezones
	- [ ] Local system-based timezone
	- [ ] Internet connected timezone
		- Using NTP (Network Time Protocol)
		- Using third-party services
- [ ] Block WinAPI and NtAPI code injection (look more into this for mapping DLLs).

## Greylisting

- [ ] It's in the form of both whitelisting and blacklisting.

## Anti-Sandbox

### Cross Platform

#### Software

- [ ] Computer Name (Hostname).

#### Hardware

- Gather information of the hardware specifications. Here are the list:
	- Architecture
		- [ ] x86 (32-bit)
		- [ ] x86_64 (64-bit)
		- [ ] ARM
		- [ ] MIPS
		- [ ] PowerPC
	- RAM (Random Access Memory)
		- [ ] Available memory capacity.
		- [ ] Used memory.
		- [ ] Total memory capacity.
	- [[06 - Tactics & Techniques & Procedures Phases/C - Initial Access/0x01 - Weaponization/0xA - Quick Start/Malware Development/Helpers/Evasion/Detection/Hardware/Mac OSX/Mounted Drives|Mounted storage (drives)]]
		- [ ] Enumerate [[06 - Tactics & Techniques & Procedures Phases/F - Post Exploitation/0x00 - Discovery/Desktop/Windows/Host/0xF - Operating System/Hardware/Malware Development/Mounted Drives/CRT|mounted drives]].
		- [ ] Type of storage
			- Internal storage
				- [ ] HDD (Hard Disk Drive)
				- [ ] SSD (Solid State Drive)
				- [ ] NVMe (NonVolatile Memory express)
			- External storage
				- [ ] USB flashdrive/pendrive
				- [ ] HDD (Hard Disk Drive)
				- [ ] SSD (Solid State Drive)
		- [ ] Available storage.
		- [ ] Used storage.
		- [ ] Total storage size.
	- MAC Address
		- [ ] Motherboard
		- [ ] Network Adapters
	- Display Monitors
		- [ ] Number of monitors.
		- [ ] Screen size.
	- GPUs (Graphics Processing Unit)/Display Adapters
		- [ ] Number of core processors.
		- [ ] Number of threads.
		- [ ] Temperature
	- CPU (Central Processing Unit)
		- [ ] Number of core processors.
		- [ ] Number of threads.
		- [ ] Temperature
	- [ ] Hardware Model
- Detect network configuration in the machine.
	- [ ] Check if it's in a isolated network.
	- [ ] Retrieve Geolocation of the IP address.
	- [ ] Specify a list of blocked IP addresses.
- [ ] Check battery status
- [ ] Implement trigonometry to detect mouse movement.

#### Network

- [ ] Check for internet connection with the following methods.
	- ICMP Ping
	- DNS Query
- [ ] Detect honeypot with the following methods.
	- Honeypot software installed
	- Fake network configuration

### Linux

- Detect third party programs are installed in the machine. These include:
	- Monitoring System
	- [[06 - Tactics & Techniques & Procedures Phases/F - Post Exploitation/0x01 - Defense Evasion/05 - Security Endpoints/Windows/Anti-Debugger/Helpers/Third Party|Debuggers]]
	- Hypervisor
		- [ ] [[06 - Tactics & Techniques & Procedures Phases/F - Post Exploitation/0x01 - Defense Evasion/07 - Sandbox Evasion/Anti-Sandbox/Helpers/Hypervisors/Type-2 Hosted Hypervisors/VirtualBox|VirtualBox]]
		- [ ] [[VMWare|VMWare]]
		- [ ] Docker
		- [ ] [[06 - Tactics & Techniques & Procedures Phases/F - Post Exploitation/0x01 - Defense Evasion/07 - Sandbox Evasion/Anti-Sandbox/Helpers/Hypervisors/Type-2 Hosted Hypervisors/QEMU|QEMU/KVM SPICE]]
		- [ ] [[Parallels|Parallels (Virtual Apple)]]

### Windows

#### Software

- [ ] Enumerate installed programs on the system.

##### Build OS Version

- [ ] Restrict to specific Windows build and operating system version.

#### System Drivers

- Detect other system drivers. These include:
	- Hypervisor
		- [ ] [[06 - Tactics & Techniques & Procedures Phases/F - Post Exploitation/0x01 - Defense Evasion/07 - Sandbox Evasion/Anti-Sandbox/Helpers/Hypervisors/Type-2 Hosted Hypervisors/VirtualBox|VirtualBox]]
		- [ ] [[VMWare|VMWare]]
		- [ ] Docker
		- [ ] [[06 - Tactics & Techniques & Procedures Phases/F - Post Exploitation/0x01 - Defense Evasion/07 - Sandbox Evasion/Anti-Sandbox/Helpers/Hypervisors/Type-2 Hosted Hypervisors/QEMU|QEMU/KVM SPICE]]
		- [ ] [[Parallels|Parallels (Virtual Apple)]]

#### Process Identifiers

- Enumerate process identifiers (PIDs) to detect programs. These include:
	- [[06 - Tactics & Techniques & Procedures Phases/F - Post Exploitation/0x01 - Defense Evasion/05 - Security Endpoints/Windows/Anti-Debugger/Helpers/Third Party|Debuggers]]
	- Hypervisor
		- [ ] [[06 - Tactics & Techniques & Procedures Phases/F - Post Exploitation/0x01 - Defense Evasion/07 - Sandbox Evasion/Anti-Sandbox/Helpers/Hypervisors/Type-2 Hosted Hypervisors/VirtualBox|VirtualBox]]
		- [ ] [[VMWare|VMWare]]
		- [ ] Docker
		- [ ] [[06 - Tactics & Techniques & Procedures Phases/F - Post Exploitation/0x01 - Defense Evasion/07 - Sandbox Evasion/Anti-Sandbox/Helpers/Hypervisors/Type-2 Hosted Hypervisors/QEMU|QEMU/KVM SPICE]]
		- [ ] [[Parallels|Parallels (Virtual Apple)]]
- Detect third party programs are installed in the machine. These include:
	- Monitoring System
		- [ ] Process Hacker
	- Debuggers
		- Dynamic Debuggers
			- [ ] x64dbg and x32dbg
		- Static Debuggers
			- [ ] IDA
			- [ ] Ghidra
	- Hypervisor
		- [ ] [[06 - Tactics & Techniques & Procedures Phases/F - Post Exploitation/0x01 - Defense Evasion/07 - Sandbox Evasion/Anti-Sandbox/Helpers/Hypervisors/Type-2 Hosted Hypervisors/VirtualBox|VirtualBox]]
		- [ ] [[VMWare|VMWare]]
		- [ ] Docker
		- [ ] [[06 - Tactics & Techniques & Procedures Phases/F - Post Exploitation/0x01 - Defense Evasion/07 - Sandbox Evasion/Anti-Sandbox/Helpers/Hypervisors/Type-2 Hosted Hypervisors/QEMU|QEMU/KVM SPICE]]
		- [ ] [[Parallels|Parallels (Virtual Apple)]]
- [ ] Detect [[06 - Tactics & Techniques & Procedures Phases/F - Post Exploitation/0x01 - Defense Evasion/07 - Sandbox Evasion/Anti-Sandbox/Helpers/Hypervisors/Generic|WINE]] software.
- Enumerate Antivirus, IDS/IPS and EDR programs.
	- [ ] Check registry values for security solutions.

#### Hardware

- Check for display drivers. Here are the following list:
	1. Monitors
		- [ ] Non-PnP (Plug n Play)

#### Network

- [ ] Check for active directory network.

## Initial Access

### Process Injection

- [ ] When injecting a process. Ensure the process name does establish internet connection, such as a web browser.
- [ ] Enumerate uncommon programs to inject the shellcode. Spawn the process name in order to inject it if necessary.

## Evasion

### User Interaction

- [ ] Use [[06 - Tactics & Techniques & Procedures Phases/F - Post Exploitation/0x01 - Defense Evasion/07 - Sandbox Evasion/Anti-Sandbox/MessageBox/C|MessageBox]] as a way to bypass endpoint solutions to come up with interactive questions.

### Sleep Timer

- [ ] Implement a sleep timer to delay the runtime execution of the program.

### DLL Injection

- [ ] [[Module Stomping|Module Stomping]]

### Cryptography

- [ ] Use symmetric or asymmetric encryption algorithms that are covered in **Cryptography** section.
- [ ] Change the encryption configuration patterns.

### Compression

- [ ] Add compression algorithm.

### Obfuscation

#### Cross Platform

- [ ] Insert any random predefined functions that allows to include and does nothing.
- [ ] Rename variables, classes and functions.
- [ ] Make (pre)defined functions verbose.
- [ ] Modify data types.
- [ ] Modify boolean values.
- [ ] Modify strings.
- [ ] Substitute loops.
- [ ] Add or remove comments.
- [ ] Aliases
	- [ ] Convert objects into aliases.
	- [ ] Change keywords that has a predefined alias.
- [ ] Disguise the shellcode.
- [ ] Switch compilers.

#### Windows

- Obfuscate WinAPI and NtAPI functions
	- [ ] [[API Hashing]]
	- [ ] [[06 - Tactics & Techniques & Procedures Phases/F - Post Exploitation/0x01 - Defense Evasion/08 - Obfuscate Artifacts/Obfuscation/Malware Development/Functions/Windows/Import Address Table/C|Import Address Table]]
	- [ ] [[Ordinals|Ordinals]]
	- [ ] [[Rename Entry Points]]
- Obfuscate strings
	- [ ] [[Stack Strings|Stack Strings]]

## Test Malware

> [!WARNING]
> DO NOT USE VIRUSTOTAL. You'll destroy your effort of making a payload to bypass defenses.

- [ ] Test the Windows binary payload
	- Execute it `wine` in the Linux VM
	- Execute it in a native Windows VM
- [ ] Test the Linux binary payload in a Linux VM
- [ ] Check the results of how many security endpoints were bypassed.
	- [WebSec: Malware Scanner](https://websec.net/tools/malware-scanner)
	- [KleenScan](https://kleenscan.com/index)

---
## References

### Backlinks

- [[Modify Payload|Shellcode: Obfuscation Techniques]]

- [[06 - Tactics & Techniques & Procedures Phases/F - Post Exploitation/0x01 - Defense Evasion/08 - Obfuscate Artifacts/Obfuscation/Malware Development/Obfuscation Techniques/Syntax Obfuscation/Obscure Variables/Modify File/Cross Platform/PowerShell|Powershell: Obfuscation Techniques]]

- [[PHP|Webshell: Obfuscation Techniques]]

### Compass Security

- [Compass Security: Evading Static Machine Learning Malware Detection Models - Part 1 - The Black-Box Approach](https://blog.compass-security.com/2020/10/evading-static-machine-learning-malware-detection-models-the-black-box-approach/)

- [Compass Security: Evading Static Machine Learning Malware Detection Models - Part 2 - The Gray-Box Approach](https://blog.compass-security.com/2020/11/evading-static-machine-learning-malware-detection-models-part-2-the-gray-box-approach/)

### SpectorOps

- [SpectorOps: Learning Machine Learning Part 2 - Attacking White Box Models](https://posts.specterops.io/learning-machine-learning-part-2-attacking-white-box-models-1a10bbb4a2ae)