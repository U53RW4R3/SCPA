# Entropy

## 01 - Unix Shell

```
$ ent payload.exe
```

If the percentage is higher than the entropy is reduced (using words to substitute the shellcode makes it effective).

```
$ gzip -vc payload.exe > /dev/null
```

## 02 - Windows

The greater the entropy, the more likely the data is obfuscated or encrypted (not always). The more probable the file is malicious.

```
C:\> net use z: \\live.sysinternals.com\tools

copy z:\sigcheck64.exe .

net use z: /delete

C:\> sigcheck64.exe /accepteula -a -s -c -nobanner payload.exe
```

## 03 - Python

```python
#!/usr/bin/env python
import argparse
import math
import pefile

def entropy(data):
    "Calculates the Shannon entropy of a UTF-8 encoded string or binary data"

    # If the input is a string, decode it as UTF-8
    if isinstance(data, str):
        unicode_data = data.decode('utf-8')
    else:
        unicode_data = data

    # Get probability of characters in data
    probability = [float(unicode_data.count(characters)) / len(unicode_data) for characters in dict.fromkeys(list(unicode_data))]

    # Calculate the entropy
    entropy = - sum([p * math.log(p) / math.log(2.0) for p in probability])

    return entropy

def sections_entropy(pe):
    for section in pe.sections[:3]:
        print(section.Name.decode('utf-8'))
        print("\tvirtual address: " + hex(section.VirtualAddress))
        print("\tvirtual size: " + hex(section.Misc_VirtualSize))
        print("\traw size: " + hex(section.SizeOfRawData))
        print ("\tentropy: " + str(entropy(section.get_data())))

if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument('-f', '--file', required=True, help="target file")
    parser.add_argument('-s', '--script', action='store_true', help="calculate PowerShell file entropy")
    parser.add_argument('-p', '--pe', action='store_true', help="scan PE (Portable Executable) files")
    args = vars(parser.parse_args())

    target_file = args['file']

    if args['script']:
        # Calculate entropy for PowerShell file
        with open(target_file, 'rb') as f:
            file_data = f.read()
        print("Entropy: ", entropy(file_data))

    if args['pe']:
        # Scan PE (Portable Executable) file
        pe = pefile.PE(target_file)
        sections_entropy(pe)
```

Analyze the entropy from a PE file.

```
$ entropy.py -p -f payload.exe
.text
        virtual address: 0x1000
        virtual size: 0x104e
        raw size: 0x1200
        entropy: 0.16810049402497224
.rdata
        virtual address: 0x3000
        virtual size: 0x84
        raw size: 0x200
        entropy: 0.9630867345987311
.mmji
        virtual address: 0x4000
        virtual size: 0x278
        raw size: 0x400
        entropy: 4.275297617191621
```

Analyze the entropy from a script.

```
$ entropy.py -s -f payload.ps1
Entropy:  4.364376561185324
```

---
## References

### Source Repositories

- [ENT - Fourmilab Random Sequence Tester](https://github.com/Fourmilab/ent_random_sequence_tester)

### ENT

- [ENT: A Pseudorandom Number Sequence Test Program](https://www.fourmilab.ch/random/)

### Microsoft

- [Sigcheck](https://learn.microsoft.com/en-us/sysinternals/downloads/sigcheck)

### RedSiege

- [RedSiege: Evading CrowdStrike Falcon Using Entropy](https://redsiege.com/blog/2023/04/evading-crowdstrike-falcon-using-entropy/)

### Cocomelonc

- [Cocomelonc: Malware analysis: part 6. Shannon entropy. Simple python script.](https://cocomelonc.github.io/malware/2022/11/05/malware-analysis-6.html)

### t3l3machus

- [t3l3machus: Powershell Obfuscation Bible](https://github.com/t3l3machus/PowerShell-Obfuscation-Bible)