# C

## WinAPI

### VirtualAlloc

Reserves, commits, or changes the state of a region of memory within the virtual address space of the calling process.

```c
#include <windows.h>
#include <memoryapi.h>

#pragma comment(lib, "onecore.lib")
```

### VirtualFree

Releases, decommits, or releases and decommits a region of memory within the virtual address space of the calling process.

```powershell
$Win32Functions = New-Object System.Object

$VirtualFreeAddress = Get-ProcAddress kernel32.dll VirtualFree
$VirtualFreeDelegate = Get-DelegateType @([IntPtr], [UIntPtr], [UInt32]) ([Bool])
$VirtualFree = [System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer($VirtualFreeAddress, $VirtualFreeDelegate)
$Win32Functions | Add-Member NoteProperty -Name VirtualFree -Value $VirtualFree
```

### VirtualFreeEx

```powershell
$Win32Functions = New-Object System.Object

$VirtualFreeExAddress = Get-ProcAddress kernel32.dll VirtualFreeEx
$VirtualFreeExDelegate = Get-DelegateType @([IntPtr], [IntPtr], [UIntPtr], [UInt32]) ([Bool])
$VirtualFreeEx = [System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer($VirtualFreeExAddress, $VirtualFreeExDelegate)
$Win32Functions | Add-Member NoteProperty -Name VirtualFreeEx -Value $VirtualFreeEx
```

### VirtualProtect

Changes the protection on a region of committed pages in the virtual address space of the calling process.

```
VirtualProtect(memory_execute, memory_allocation, PAGE_EXECUTE, &ignore);
```

### VirtualProtectEx

```
VirtualProtectEx
```

### Copy Memory

```
CopyMemory(&destMemAddr,&source, length);
```

```powershell
$Win32Functions = New-Object System.Object

$memcpyAddress = Get-ProcAddress msvcrt.dll memcpy
$memcpyDelegate = Get-DelegateType @([IntPtr], [IntPtr], [UIntPtr]) ([IntPtr])
$memcpy = [System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer($memcpyAddress, $memcpyDelegate)
$Win32Functions | Add-Member -MemberType NoteProperty -Name memcpy -Value $memcpy
```

### Move Memory

```c
RtlMoveMemory(&destMemAddr, &source, length);
MoveMemory(&destMemAddr, &source, length);
FillMemory(&destMemAddr, 1, ByteByteOfShellcode);
```

```powershell
$Win32Functions = New-Object System.Object

$memsetAddress = Get-ProcAddress msvcrt.dll memset
$memsetDelegate = Get-DelegateType @([IntPtr], [Int32], [IntPtr]) ([IntPtr])
$memset = [System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer($memsetAddress, $memsetDelegate)
$Win32Functions | Add-Member -MemberType NoteProperty -Name memset -Value $memset
```

```
$ x86_64-w64-mingw32-gcc -l kernel32 -o implant.exe implant.c
```
## NTAPI

https://redops.at/en/blog/direct-syscalls-vs-indirect-syscalls

---
## References

### Github

- [DimopoulosEilas: SimpleShellcodeInjector](https://github.com/DimopoulosElias/SimpleShellcodeInjector)

### Microsoft Documentation

- [Microsoft Documentation: VirtualAlloc()](https://learn.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc)

- [Microsoft Documentation: Reserving and Committing Memory](https://learn.microsoft.com/en-us/windows/win32/memory/reserving-and-committing-memory)

### Tenouk

- [Tenouk: Windowsâ€™s Virtual Address Space](https://www.tenouk.com/WinVirtualAddressSpace.html)

### Mr. Rc

- [Mr. Rc: Exploring Virtual Memory and the Virtual Memory Management API.](https://de-engineer.github.io/Understanding-Virtual-Memory-Paging-and-other-memory-related-concepts/)

## RedOps

- [RedOps: Unleashing Assembly for Shellcode Execution](https://redops.at/en/blog/shell-we-assemble-unleashing-x86-inline-assembly-for-shellcode-execution)