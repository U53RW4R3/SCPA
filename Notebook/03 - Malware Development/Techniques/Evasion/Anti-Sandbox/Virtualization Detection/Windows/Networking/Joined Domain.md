# Joined Domain

## WinAPI

### C++

```cpp
bool is_member_of_domain() {
	bool ret = false;
	DWORD dwLevel = 100;
	LPWKSTA_INFO_100 pBuf = NULL;
	NET_API_STATUS nStatus;
	LPWSTR pszServerName = L"localhost";
	nStatus = NetWkstaGetInfo(pszServerName, dwLevel, (LPBYTE *)&pBuf);
	if (nStatus == NERR_Success) {
		char response[500];
		wcstombs(response, pBuf->wki100_langroup, 500);

		char workgroup[] = "WORKGROUP";

		if (strcmp(response, workgroup)) { // returns 0 if identical
			ret = true;
		}
	}
	return ret;
}

if (!is_member_of_domain()) {
	return 0;
}
```

### Go

```go
func checkDomain() (bool, error) {
	var domain *uint16
	var status uint32
	err := syscall.NetGetJoinInformation(nil, &domain, &status)
	if err != nil {
		return false, err
	}
	syscall.NetApiBufferFree((*byte)(unsafe.Pointer(domain)))
	return status == syscall.NetSetupDomainName, nil
}
```

### VBA

```vb
Const ComputerNameDnsDomain = 2

Declare PtrSafe Function GetComputerNameExA Lib "kernel32" ( _
    ByVal NameType As Long, _
    ByVal lpBuffer As String, _
    ByRef nSize As Long _
) As Boolean

Sub GetDomainName()
    Dim DomainName As String * 256
    GetComputerNameExA ComputerNameDnsDomain, DomainName, 256
    Debug.Print "Domain: " & DomainName
End Sub
```

```vb
Const ComputerNameDnsDomain = 2

Declare PtrSafe Function GetComputerNameExA Lib "kernel32" ( _
    ByVal NameType As Long, _
    ByVal lpBuffer As String, _
    ByRef nSize As Long _
) As Boolean

Declare PtrSafe Function GetUserNameA Lib "advapi32" ( _
    ByVal NameType As Long, _
    ByVal lpBuffer As String, _
    ByRef nSize As Long _
) As Boolean

Sub GetUsername()
    Dim Username As String * 256
    GetComputerNameExA ComputerNameDnsDomain, DomainName, 256
    Debug.Print "Username: " & Username
End Sub
```

## Windows Scripting Host

### VBA

```vb
Sub GetDomainName()
    Set wsNetwork = CreateObject("Wscript.Network")
    DomainName = wsNetwork.UserDomain
    Debug.Print "Domain: " & DomainName
End Sub
```

## Environment Variable

### VBA

```vb
Sub GetDomainName()
    DomainName = VBA.Interaction.Environ("UserDomain")
    Debug.Print "Domain: " & DomainName
End Sub
```

---
## References

### Microsoft

- [WinAPI Documentation: `NetWkstaGetInfo`](https://learn.microsoft.com/en-us/windows/win32/api/lmwksta/nf-lmwksta-netwkstagetinfo)

### TrustedSec

- [TrustedSec: Enumerating Anti-Sandboxing Techniques](https://trustedsec.com/blog/enumerating-anti-sandboxing-techniques)

### vaadata

- [vaadata: Antivirus and EDR Bypass Techniques](https://www.vaadata.com/blog/antivirus-and-edr-bypass-techniques/)