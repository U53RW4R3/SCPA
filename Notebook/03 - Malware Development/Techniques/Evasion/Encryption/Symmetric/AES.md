# AES

```c
void DecryptAES(char *data, DWORD length, char *key, DWORD keylength) {
    HCRYPTPROV handle_prov;
    HCRYPTHASH handle_hash;
    HCRYPTKEY handle_key;

    CryptAcquireContextW(&handle_prov, NULL, NULL, PROV_RSA_AES, CRYPT_VERIFYCONTEXT);
    CryptCreateHash(handle_prov, CALG_SHA_256, 0, 0, &handle_hash);
    CryptHashData(handle_hash, (BYTE*) key, keylength, 0);
    CryptDeriveKey(handle_prov, CALG_AES_256), handle_hash, 0, &handle_key);
    CryptDecrypt(handle_key, (HCRYPTHASH) NULL, 0, 0, (BYTE*)data, &length);

    CryptReleaseContext(handle_prov, 0);
    CryptDestroyHash(handle_hash);
    CryptDestroyKey(handle_key);
}
```

---
## References

- [secarma: Bypassing Windows Defender with Environmental Decryption Keys](https://secarma.com/bypassing-windows-defender-with-environmental-decryption-keys/)