# Detect Debuggers

## IsDebuggerPresent

Determines whether the calling process is being debugged by a user-mode debugger.

```c
#include <stdio.io>
#include <windows.h>
#include <debugapi.h>

#pragma comment(lib, "kernel32.lib")

int main() {
	if (IsDebuggerPresent()) {
		printf("[!] Debugger detected! Terminating program...");
		return 0;
	}

	return 0;
}
```

```
$ x86_64-w64-mingw32-gcc -l kernel32 -o check_debugger.exe check_debugger.c
```

## CheckRemoteDebuggerPresent

Determines whether the specified process is being debugged.

```c
#include <stdio.io>
#include <windows.h>
#include <debugapi.h>

int main() {
	HANDLE process_handle = GetCurrentProcess();
	PBOOL pointer_boolean_debugger_present;

	if (CheckRemoteDebuggerPresent(process_handle, pointer_boolean_debugger_present)) {
		printf("[!] Process handle is being debugged! Terminating program...");
		return 0;
	}

	return 0;
}
```

## Custom Anti-Debugger

### PEB

The code reference was taken from [x64dbg `ntdll.h`](https://github.com/x64dbg/x64dbg/blob/development/src/dbg/ntdll/ntdll.h) custom header.

```c
#include <stdio.h>
#include <windows.h>

typedef struct _PEB {
    BOOLEAN BeingDebugged;
} PEB, *PPEB;

BOOL CustomIsDebuggerPresent() {

#ifdef _WIN64
	PPEB pointer_peb = (PEB*)(__readgsqword(0x60));
#ifdef _WIN32
	PPEB pointer_peb = (PEB*)(__readgsqword(0x30));
#endif

	if (pointer_peb->BeingDebugged == 1) {
		return TRUE;
	}
	return FALSE;
}

int main() {
	if (IsDebuggerPresent()) {
		printf("[!] Debugger detected! Terminating program...");
		return 0;
	}

	return 0;
}
```

### Assembly instructions

```c
#include <stdio.h>
#include <windows.h>

BOOL CustomIsDebuggerPresent64() {
    __asm {
        mov rax, gs:[0x60]
        movzx eax, byte ptr[rax+2]
        retn
    }
}

BOOL CustomIsDebuggerPresent32() {
    __asm {
        mov eax, fs:[0x30]
        movzx eax, byte ptr[eax+2]
        retn
    }
}

void main() {
    printf("Is Being Debugged1: %d\n", CustomIsDebuggerPresent64());
    printf("Is Being Debugged2: %d\n", CustomIsDebuggerPresent32());
}
```

---
## References

### MalAPI

- [MalAPI: `IsDebuggerPresent`](https://malapi.io/winapi/IsDebuggerPresent)

- [MalAPI: `CheckRemoteDebuggerPresent`](https://malapi.io/winapi/CheckRemoteDebuggerPresent)

### Checkpoint

- [Checkpoint: Evasions Debug Flags](https://evasions.checkpoint.com/src/Anti-Debug/techniques/debug-flags.html)

- [Checkpoint: Evasions Object Handles](https://evasions.checkpoint.com/src/Anti-Debug/techniques/object-handles.html)

- [Checkpoint: Evasions Exceptions](https://evasions.checkpoint.com/src/Anti-Debug/techniques/exceptions.html)

- [Checkpoint: Process Memory](https://evasions.checkpoint.com/src/Anti-Debug/techniques/process-memory.html)

- [Checkpoint: Assembly instructions](https://evasions.checkpoint.com/src/Anti-Debug/techniques/assembly.html)

- [Checkpoint: Evasions Direct debugger interaction](https://evasions.checkpoint.com/src/Anti-Debug/techniques/interactive.html)