# Windows Service
## C

```c
#include <windows.h>
#include <stdio.h>

#define SLEEP_TIME 5000

SERVICE_STATUS ServiceStatus;
SERVICE_STATUS_HANDLE hStatus;

void ServiceMain(int argc, char** argv);
void ControlHandler(DWORD request);

int Payload() {
    // add the payload here
    return 0;
}

int main() {
    SERVICE_TABLE_ENTRY ServiceTable[2];
    // Replace "<service_name>" to something else
    ServiceTable[0].lpServiceName = "<service_name>";
    ServiceTable[0].lpServiceProc = (LPSERVICE_MAIN_FUNCTION)ServiceMain;

    ServiceTable[1].lpServiceName = NULL;
    ServiceTable[1].lpServiceProc = NULL;

    StartServiceCtrlDispatcher(ServiceTable);
    return 0;
}

void ServiceMain(int argc, char** argv) {
    ServiceStatus.dwServiceType        = SERVICE_WIN32;
    ServiceStatus.dwCurrentState       = SERVICE_START_PENDING;
    ServiceStatus.dwControlsAccepted   = SERVICE_ACCEPT_STOP | SERVICE_ACCEPT_SHUTDOWN;
    ServiceStatus.dwWin32ExitCode      = 0;
    ServiceStatus.dwServiceSpecificExitCode = 0;
    ServiceStatus.dwCheckPoint         = 0;
    ServiceStatus.dwWaitHint           = 0;

	// Replace "<service_name>" to something else
    hStatus = RegisterServiceCtrlHandler("<service_name>", (LPHANDLER_FUNCTION)ControlHandler);
    Run();

    ServiceStatus.dwCurrentState = SERVICE_RUNNING;
    SetServiceStatus (hStatus, &ServiceStatus);

    while (ServiceStatus.dwCurrentState == SERVICE_RUNNING) {
                Sleep(SLEEP_TIME);
    }
    return;
}

void ControlHandler(DWORD request) {
    switch(request) {
        case SERVICE_CONTROL_STOP:
                        ServiceStatus.dwWin32ExitCode = 0;
            ServiceStatus.dwCurrentState  = SERVICE_STOPPED;
            SetServiceStatus (hStatus, &ServiceStatus);
            return;

        case SERVICE_CONTROL_SHUTDOWN:
            ServiceStatus.dwWin32ExitCode = 0;
            ServiceStatus.dwCurrentState  = SERVICE_STOPPED;
            SetServiceStatus (hStatus, &ServiceStatus);
            return;

        default:
            break;
    }
    SetServiceStatus (hStatus,  &ServiceStatus);
    return;
}
```

```
$ x86_64-w64-mingw32-gcc programsvc.c -o programsvc.exe
```

## C\#

```csharp
using System;
using System.ComponentModel;

namespace WindowsService {
    [RunInstaller(true)]
    public partial class ServiceName : ServiceBase {
        public ServiceName() {
            InitializeComponent();
        }
    }
    public override void OnStart(string[] args) {
        // this is where the payload runs
        base.OnStart(args);
    }

    public override void OnStop() {
        base.OnStop();
    }

    static void Main(string[] args) {
        ServiceBase.Run(new LoggingService());
    }
}
```

```
$ dotnet build
```

---
## References

### C

- [Cocomelonc: Persistence - Part 4. Windows services](https://cocomelonc.github.io/tutorial/2022/05/09/malware-pers-4.html)

### C\#

- [WebstersProdigy: AV Evading Meterpreter Shell from a .NET Service](https://webstersprodigy.net/2012/08/31/av-evading-meterpreter-shell-from-a-net-service/)

- [Didier Stevens: Abusing A Writable Windows Service ](https://blog.didierstevens.com/2017/09/05/abusing-a-writable-windows-service/)

- [C# Corner: Windows Services in C#](https://www.c-sharpcorner.com/UploadFile/7d3362/window-service-in-C-Sharp/)

- [C# Corner: Develop and Install a Windows Service in C#](https://www.c-sharpcorner.com/UploadFile/naresh.avari/develop-and-install-a-windows-service-in-C-Sharp/)

- [C# Corner: Create A Windows Service In C#](https://www.c-sharpcorner.com/article/create-windows-services-in-c-sharp/)