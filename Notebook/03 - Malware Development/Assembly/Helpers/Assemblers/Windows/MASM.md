---
author(s):
  - Userware
tags:
  - helpers
  - command-line
  - assembler
  - windows
---
# MASM

## Linux

### Setup

TODO: Check if 64-bit architecture installation works.

Create `WINEPREFIX`.

```
$ WINEARCH=win64 WINEPREFIX=~/wine-masm winecfg

$ WINEARCH=win32 WINEPREFIX=~/wine-masm winecfg
```

Download and install **MASM** assembler. Follow the instructions.

```
$ wget https://masm32.com/download/masm32v11r.zip && \
7z x masm32v11r.zip && \
WINEPREFIX=~/wine-masm wine64 install.exe
```

```
$ wget https://github.com/surferkip/asmbook/raw/refs/heads/main/Irvine.zip
```

Append this bash function in your default resource profile.

```bash
export WINE_MASM_DIR=~/wine-masm
function masm() (
    # Stop on errors
    set -e

    # Use the correct wine directory
    export WINEPREFIX=$WINE_MASM_DIR

    # Get the path to the file without a .asm extension
    FILENAME="$(basename "$1")"
    EXTENSION="${FILENAME##*.}"
    shopt -s nocasematch   # String case-insensitive comparison
    if [[ "$EXTENSION" = "asm" ]]; then
        FILENAME="${FILENAME%.*}"   # Remove extension
    fi
    UNIX_PATH="$(dirname "$1")/$FILENAME"

    # Convert forwards slashes into backslashes
    WINDOWS_PATH=$(echo "$UNIX_PATH" | tr '/' '\')

    # Assemble file
    wine64 ml -nologo -c -coff -Zi "$WINDOWS_PATH.asm"

    # Link files
    # Notes: Irvine's asm32.bat script includes a /DEBUG flag. I found that
    # including this flag causes a link fail:
    #   LINK : fatal error LNK1000: unknown error; consult documentation for
    #   technical support options
    # Therefore, I have omitted it. Additionally, the default entry point
    # for Wine or perhaps later versions of Windows appears to be
    # mainCRTStartup instead of main (see http://stackoverflow.com/a/12391264),
    # so we need to manually specify main as the entry point with /ENTRY.
    wine64 link /NOLOGO /SUBSYSTEM:CONSOLE /ENTRY:main \
        /LIBPATH:'C:\Irvine' \
        irvine32.lib kernel32.lib user32.lib "$WINDOWS_PATH.obj"

    # Run the linked executable
    wine64 "$WINDOWS_PATH.exe"
)
```

### Compile

```
$ WINEPREFIX=~/wine-masm wine64 'C:\masm32\bin\ml.exe'
```

## Windows

x86_64 architecture

```
C:\> ml64.exe /c /coff shellcode.asm

C:\> link.exe /SUBSYSTEM:WINDOWS /ENTRY:start /VERSION:4.0 shellcode.obj
```

You can just translate the executable file into just a binary.

```
C:\> objcopy -O binary shellcode.exe shellcode.bin
```

---
## References

- [MASM32 Assembler](https://masm32.com/)

- [Ryan Eberhardt: Using MASM on Mac or Linux via Wine](https://reberhardt.com/blog/programming/2016/01/30/masm-on-mac-or-linux.html)

- [Left 404: Converting x86 assembly from masm to nasm](https://left404.com/2011/01/04/converting-x86-assembly-from-masm-to-nasm-3/)