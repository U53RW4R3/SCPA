# Powershell

Search Tag(s): #helpers #malware-development #defense-evasion

TODO: Provide more ways to obfuscate powershell script/implant.

## 01 - Remove Spaces, Comments and Aliases

```
$ sed -i -e "/<#/,/#>/c\\" \
-e "s/^[[:space:]]*#.*$//g"
-e "/Set-Alias/d" implant.ps1
```

## 02 - Modify Variables and Concatenate Strings

Using `Invoke-Mimikatz` as an example.

```
$ sed -i "s/-Name VirtualProtect/<new_string>/g" \
-e "s/-Name WriteProcessMemory/<new_string>/g" \
-e "s/::logonPass/<new_string>/g" \
-e "s/DumpCreds/<new_variable>/g" \
-e "s/DumpCerts/<new_variable>/g" \
-e "s/CustomCommand/<new_variable>/g" \
-e "s/TypeBuilder/<new_variable>/g" \
-e "s/Win32Types/<new_variable>/g" \
-e "s/Win32Functions/<new_variable>/g" \
-e "s/shellcode/<new_variable>/g" \
-e "s/PEBytes64/<new_variable>/g" \
-e "s/PEBytes32/<new_variable>/g" \
-e "s/ArgumentPtr/<new_variable>/g" \
-e "s/CallDllMainSC1/<new_variable>/g" \
-e "s/'TVq/'TV'+'q/g" Invoke-Mimikatz.ps1
```

---
## References

- [Powershell Obfuscation](https://huebicode.com/blog/20230502_powershell_obfuscation.php)

- [Powershell Obfuscation Bible](https://github.com/t3l3machus/PowerShell-Obfuscation-Bible)

- [gh0x0st: Layer 0 Obfuscation](https://github.com/gh0x0st/Invoke-PSObfuscation/blob/main/layer-0-obfuscation.md)

- [huebicode: Powershell Obfuscation](https://huebicode.com/blog/powershell-obfuscation.html)

- [onlyf8: Powershell and Obfuscation](https://onlyf8.com/powershell-obfuscationEN)

- [klezvirus: Chameleon Born From a Chimera](https://klezvirus.github.io/RedTeaming/AV_Evasion/BornFromAChimera/)

- [geoda: Running an Obfuscated version of Mimikatz in Memory to bypass AntiVirus and other host based controls](https://blog.geoda-security.com/2018/05/running-obfuscated-version-of-mimikatz.html)

- [Black Hills Information Security: How to Bypass Anti-Virus to Run Mimikatz](https://www.blackhillsinfosec.com/bypass-anti-virus-run-mimikatz/)

- [CTFIoT: Bypassing Windows Defender](https://www.ctfiot.com/112423.html)

- [r00t-3xp10it: Simple Obfuscation](https://github.com/r00t-3xp10it/hacking-material-books/blob/master/obfuscation/simple_obfuscation.md)

### Debugging AMSI Function

- [Winslow Blog: Bypass AMSI On Windows 11](https://winslow1984.com/books/red-team/page/bypass-amsi-on-windows-11)