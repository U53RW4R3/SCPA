# Escape Mitigations

1b. How to easily counter this attack (assuming your system is vulnerable)

There's one huge step you can take to prevent this from happening forever (just in case your system ever has been vulnerable and you don't want to have to worry about it anymore). By default, your restricted shell should not let the user redefine the IFS variable. Here's the one thing you can do to make it impossible for this hack to work (although it will come at some cost, since no one will be able to preserve crashed vi files. And, we should note that part of this vulnerability is that this command used to be setuid root!):

```
host # chmod a-x /usr/lib/expreserve
```

> [!NOTE]
>  This file may be in a different directory depending on your distro, and may also be differently titled. For instance, the `elvis` program - a `vi` clone - uses the `elvprsv` command to do its preserves.

Now, no one can execute that command by running `[esc]:pre` in `vi` or `vim`. (Note also that)

2b. The easiest fix, if it's available, is included in some versions of vi and in most versions of vim.

If you invoke them as rvi or rvim, the shell escape is disabled by default :) In some instances, invoking vi as rvi will dump your user to the "ex" editor. That's bordering on cruelty ;)

3b. Here's a very simple way to ensure this will never happen (at least, not the unoriginal way ;)

First, set the restricted user's home directory up with an .exrc file. Normally, these are considered bad to have, but, in fact, it's generally better practice to have an existing .exrc file, that the user can't access, than none at all (since that leaves it for them to create if they can figure out a way).

```
# touch /home/restricted/.exrc
# chown root:root /home/restricted/.exrc
# chmod 644 /home/restricted/.exrc
# vi /home/restricted/.exrc
set exrc
set shell=/bin/false
```

And you're all set. Now, whenever your user uses `vi` (or `vim` - the same method is used to implement the above), the `.exrc` file will get processed and the default `shell` will be set to /bin/false. So, when they type:

```
[esc]:shell
```

It will knock them right back to the editor. As an added bonus, this will prevent them from being able to use the `[esc]:!` one-line command functionality, since it will try to execute that command using `/bin/false`. This will fail if `/bin/false` exists (because it returns failure no matter what) and also if it doesn't (because the invocation of the non-existent shell will return failure also). If you want to play it safe, make sure your system has a `/bin/false` before you set this (to avoid any bizarre unanticipated OS behavior). Another common "useless" shell is `/sbin/nologin`, but /bin/false should be on almost every flavor and distro of Linux and Unix out there.