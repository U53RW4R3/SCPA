# SMB

## 01 - Server Setup

### 1.1 - Samba

```
$ cat /etc/samba/smb.conf

Please note that you also need to set appropriate Unix permissions
# to the drivers directory for these users to have write rights in it
;   write list = root, @lpadmin

# client min protocol = LANMAN1
# client min protocol = NT1
# client min protocol = SMB2
[global]
client min protocol = CORE
client max protocol = SMB3

[visualstudio]
path = /path/to/directory
browseable = yes
read only = no
```

```
$ sudo smbpasswd -a <username>

$ sudo systemctl restart smbd

$ sudo /etc/init.d/smbd restart

$ sudo service smbd restart
```

### 1.2 - Impacket

```
$ sudo smbserver.py <share_name> .

$ sudo smbserver.py <share_name> $(pwd)
```

## 02 - Usage

### 2.1 - Samba Suite Utils

```
$ smbclient //<IP>/C$

smb: \>
```

Download everything on the SMB server

```
smb: \> recurse on

smb: \> prompt off

smb: \> mget *
```

Archive everything in a tarball file.

```
$ smbclient -Tc[v] archive.tar /path/to/remote/directory/

smb: \> tar c backup.tar /path/to/remote/directory/
```

Once you've setup the CIFS/SMB/Samba server on the Client Side for Windows workstation in this will copy the files from the attacker's server. Visit this [[07 - Tactics & Techniques & Procedures (TTPs) Phases/F - Post Exploitation/0x05 - File Transfer and Data Exfiltration/Windows/Network Ports/SMB|section]] to see the practical methods

### 2.2 - Impacket

```
$ smbclient.py [<domain>/]<username>@<IP>

# shares

# use <share_name>

# mget *
```

### 2.3 - NetExec

TODO: Use the spider regex in netexec to find data

```
$ netexec smb -M spider_plus --options
[*] spider_plus module options:

            READ_ONLY           Only list files and put the name into a JSON (default: True)
            EXCLUDE_EXTS        Extension file to exclude (Default: ico,lnk)
            EXCLUDE_DIR         Directory to exclude (Default: print$)
            MAX_FILE_SIZE       Max file size allowed to dump (Default: 51200)
            OUTPUT_FOLDER       Path of the remote folder where the dump will occur (Default: /tmp/cme_spider_plus)

$ netexec smb <IP> -u "<username>" -p "<password>" [-d <domain> | --local-auth] --spider <share_name> --pattern <pattern>

$ netexec smb <IP> -u "<username>" -p "<password>" [-d <domain> | --local-auth] --spider <share_name> --regex <python_regex>
```

---
## References

### Backlinks

- [[Sensitive Filenames|Exfiltration: Sensitive Files]]

- [0xBEN: SMB Client Configuration](https://notes.benheater.com/books/kali-optimizations/page/smb-client-configuration)