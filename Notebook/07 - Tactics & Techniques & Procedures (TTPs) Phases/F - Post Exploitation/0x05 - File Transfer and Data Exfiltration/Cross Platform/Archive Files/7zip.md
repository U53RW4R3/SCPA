# 7zip

Search Tag(s): #post-exploitation #file-transfer-and-data-exfiltration #archive-files

## 01 - Setup

- Choose a standalone console version to use a portable program

![[01 - 7zip Program Selection.png]]

If you want to install 7zip on windows

```
C:\> certutil -urlcache -split -f https://www.7-zip.org/a/7z2107-x64.exe 7z-installer.exe

C:\> curl.exe -o 7z-installer.exe https://www.7-zip.org/a/7z2107-x64.exe
```

```
PS C:\> Invoke-WebRequest -UseBasicParse -Uri https://www.7-zip.org/a/7z2107-x64.exe -OutFile 7z-installer.exe
```

Silently install 7zip program

```
PS C:\> 7z-installer.exe /S
```

## 02 - Usage

### 2.1 - Syntax for the 7zip

```
> 7z a <destination> <file_1>,<file_2>,...
```

### 2.2 - Locate 7zip executable program

#### 2.2.1 - Linux

```
$ which 7z

$ whereis 7z
```

```
$ 7z a -t7z -m0=lzma2 -mx=9 -mfb=64-md=32m -ms=on <destination> <file_1>,<file_2>,...

$ 7z a archive.7z -r src/*.c
```

#### 2.2.2 - Windows

```
C:\> where /r C:\ tar.exe

PS C:\> Get-ChildItem -Recurse -Path C:\ -Include "tar.exe" -ErrorAction SilentlyContinue | ForEach-Object {$_.FullName}
```

```
C:\> "c:\program files\7-Zip\7z.exe" a -t7z -m0=lzma2 -mx=9 -mfb=64-md=32m -ms=on <destination> <file_1>,<file_2>,...
```

Use a short path to execute a program

```
C:\> "C:\Progra~1\7-Zip\7z.exe" a -t7z -m0=lzma2 -mx=9 -mfb=64-md=32m -ms=on <destination> <file_1>,<file_2>,...
```

### 2.3 - Split into multiple zip files as volumes for easier exfiltration with `-v` flag

- Note: you'll see the volume of 7zip archive files like file.7z.001, file.7z.002, etc

```
> 7z a -t7z -v<bytes>m -mx9 -r0 -p<password> archive.7z [<drive_letter>:]/path/to/folder
```

- You can of course archive the files from the file sharing SMB machine.

```
C:\> 7z a -t7z -v650m -mx9 -r0 -p<password> exfiltrated-documents.7z \\<IP>\<share_name>\
```

### 2.4 - Match specific extensions then archive the files

#### 2.4.1 - Linux

- Recursively archive files with specific file extensions

```
$ find /path/to/directory -type f \( -name "*.txt" -o -name "*.pdf" -o -name "*.doc" -o -name "*.docx" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" -o -name "*.ppt" -o -name "*.pptx" -o -name "*.xls" -o -name "*.xlsx" \) -exec 7z a -t7z -v650m -mx9 -r0 -p<password> archive.7z {} + 2>&1
```

- Recursively archive files with specific file extensions. Ensure the filenames are unique to avoid duplicates.

```
$ find /path/to/directory -type f \( -name "*.txt" -o -name "*.pdf" -o -name "*.doc" -o -name "*.docx" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" -o -name "*.ppt" -o -name "*.pptx" -o -name "*.xls" -o -name "*.xlsx" \) -exec 7z a -t7z -v650m -mx9 -r0 -p<password> archive.7z {} \; 2>&1 | rev | cut -d. -f1 | rev | sort | uniq
```

---
## References

- [7zip](https://www.7-zip.org/download.html)

- [7zip Command Line](https://7ziphelp.com/7zip-command-line)

- [Deep Dive into the Solorigate Second Stage Activation from Sunburst to Teardrop and Raindrop](https://www.microsoft.com/en-us/security/blog/2021/01/20/deep-dive-into-the-solorigate-second-stage-activation-from-sunburst-to-teardrop-and-raindrop/)

- [7zip FAQ (it provided a silent install flag)](https://7-zip.org/faq.html)