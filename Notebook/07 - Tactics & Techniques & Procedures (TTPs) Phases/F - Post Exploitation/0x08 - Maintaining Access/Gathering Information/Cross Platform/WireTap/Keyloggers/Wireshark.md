# Wireshark

```lua
-- We want to capture USB data for each packet
local usbdata = Field.new("usb.capdata")

-- The listener function to create our tap
local function init_listener()
    print("[*] Started KeySniffing...\n")

    -- Only listen for USB packets
    local tap = Listener.new("usb")

    -- Key mapping from USB HID Usage Tables
    -- Reference: http://www.usb.org/developers/docs/Hut1_11.pdf
    local keys = "????abcdefghijklmnopqrstuvwxyz1234567890\n??\t -=[]\\?;??,./"

    -- Called for every packet matching the filter
    function tap.packet(pinfo, tvb)
        -- Get the usb.capdata field
        local data = usbdata()

        -- Ensure the packet actually has a usb.capdata field
        if data ~= nil then
            local keycodes = {}
            local i = 0

            -- Extract hex bytes from the usb.capdata field and add to the table
            for v in string.gmatch(tostring(data), "%x+") do
                i = i + 1
                keycodes[i] = v
            end

            -- Ensure we have at least 3 keypress values
            if #keycodes < 3 then
                return
            end

            -- Convert the 3rd hex key to decimal
            local code = tonumber(keycodes[3], 16) + 1

            -- Get the corresponding key from the mapping
            local key = keys:sub(code, code)

            -- Print the key to stdout if it's not '?'
            if key ~= '?' then
                io.write(key)
                io.flush()
            end
        end
    end

    -- Called when the capture is reset
    function tap.reset()
        print("[*] Done Capturing")
    end

    -- Called at the end of the `tshark` run
    function tap.draw()
        print("\n\n[*] Done Processing")
    end
end

-- Initialize the listener
init_listener()
```

```
> tshark -Q -i usbmon2 -Xlua_script:keysniffer.lua
```