---
author(s):
  - Userware
tags:
  - post-exploitation
  - pivot
  - tunneling
  - icmp
---
# ICMPTunnel

## 01 - Setup

### 1.1 - Compile Source Code

Clone the repository and compile.

```
# git clone https://github.com/jamesbarlow/icmptunnel.git && cd icmptunnel/ && \
make
```

Download the archived source code.

```
# wget -qO icmptunnel.zip https://github.com/jamesbarlow/icmptunnel/archive/refs/heads/master.zip

# curl -o icmptunnel.zip https://github.com/jamesbarlow/icmptunnel/archive/refs/heads/master.zip
```

Then extract the source then compile.

```
# unzip icmptunnel.zip && cd icmptunnel-master/

# 7z x icmptunnel.zip && cd icmptunnel-master/
```

### 1.2 - Disable ICMP Echo Reply

This must configured on both the server and the client.

```
# sysctl -w net.ipv4.icmp_echo_ignore_all=1

# echo 1 > /proc/sys/net/ipv4/icmp_echo_ignore_all
```

## 02 - Help Menu

```
# ./icmptunnel -h
icmptunnel 0.1-beta.
usage: ./icmptunnel [options] -s|server

  -v               print version and exit.
  -h               print help and exit.
  -k <interval>    interval between keep-alive packets.
                   the default interval is 5 seconds.
  -r <retries>     packet retry limit before timing out.
                   the default is 5 retries.
  -m <mtu>         max frame size of the tunnel interface.
                   the default tunnel mtu is 1500 bytes.
  -e               emulate the microsoft ping utility.
  -d               run in the background as a daemon.
  -s               run in server-mode.
  server           run in client-mode, using the server ip/hostname.
```

## 03 - Usage

### 3.1 - Server

Launch ICMP tunnel to create a virtual network interface `tun0`.

```
root@server:~# ./icmptunnel -s -d
```

Assign an IP address.

```
root@server:~# ip address add 10.0.0.1/24 dev tun0

root@server:~# ifconfig tun0 10.0.0.1 netmask 255.255.255.0
```

### 3.2 - Client

```
root@hackware-os:~# ./icmptunnel -d <server_IP>
```

Assign an IP address.

```
root@hackware-os:~# ip address add 10.0.0.2/24 dev tun0

root@hackware-os:~# ifconfig tun0 10.0.0.2 netmask 255.255.255.0
```

### 3.3 - Cleanup and Revert Settings

#### 3.3.1 - Delete Tunnel Network Interface

Delete the network interface from the server side.

```
root@server:~# ip address del 10.0.0.1/24 dev tun0

root@server:~# ifconfig tun0 10.0.0.1 netmask 255.255.255.0 down
```

Delete the network interface from the client side.

```
root@hackware-os:~# ip address del 10.0.0.2/24 dev tun0

root@hackware-os:~# ifconfig tun0 10.0.0.2 netmask 255.255.255.0 down
```

#### 3.3.2 - Terminate Program

Then terminate the program via process ID.

```
# pgrep -a icmptunnel

# kill -9 <PID>
```

Terminate the program via the process name.

```
# pkill icmptunnel
```

#### 3.3.3 - Re-enable ICMP Echo Reply

```
# sysctl -w net.ipv4.icmp_echo_ignore_all=1

# echo 1 > /proc/sys/net/ipv4/icmp_echo_ignore_all
```

---
## References

- [Hacking Articles: Port Forwarding Tunneling CheatSheet](https://www.hackingarticles.in/port-forwarding-tunnelling-cheatsheet/)