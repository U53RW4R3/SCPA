# PTunnel

Search Tag(s): #post-exploitation #pivot #port-forward #tunneling #icmp

## 01 - Setup

### 1.1 - Compile

#### 1.1.1 - Linux

```
$ git clone https://github.com/utoni/ptunnel-ng.git && cd ptunnel-ng && \
sudo ./autogen.sh
```

#### 1.1.2 - Windows

TODO: Compile for windows binary

### 1.2 - Package Manager

Install program according to your package manager.

```
$ sudo apt install -y ptunnel-ng

$ sudo dnf install -y ptunnel-ng

$ sudo pacman -S ptunnel-ng
```

## 02 - Help Menu

```
$ ./ptunnel-ng -h
ptunnel-ng 1.42

Usage: ./ptunnel-ng -p <address> -r<address> -R<port> [-m <magic>] [-l <port>] [-c <connections>] [-v <level>] [-L <interface>] [--list-libpcap-devices] [-o<file>] [-s] [-P <password>] [--udp] [--unprivileged] [--force-sha512 <force-sha512>] [-d<pidfile>] [-S] [-u<user>] [-g<group>] [-C<directory>] [-e<context>] [-h]

    -p --proxy
        Set address of peer running packet forwarder. This causes
        ptunnel to operate in forwarding mode (Client) - the absence of this
        option causes ptunnel to operate in proxy mode (Server).
    -r --remote-addr
        Set remote proxy destination address if client
        Restrict to only this destination address if server
            (default: 127.0.0.1)
    -R --remote-port
        Set remote proxy destination port if client
        Restrict to only this destination port if server
            (default: 22)
    -m --magic
        Set ptunnel magic hexadecimal number. (32-bit unsigned)
        It is an identifier for all ICMP/UDP packets
        and can be used to bypass Cisco IPS fingerprint scan.
        This value has to be the same on the server and client!
            (default: 0xDEADC0DE)
    -l --listen
        Set TCP listening port (only used when operating in forward mode)
            (default: 2222)
    -c --connections
        Set maximum number of concurrent tunnels
            (default: 10)
    -v --verbosity
        Verbosity level (-1 to 4, where -1 is no output, and 4 is all output)
        The special level 5 (or higher) includes xfer logging (lots of output)
            (default: 2)
    -L --libpcap
        (Not available on this platform.)
        Enable libpcap on the given device.
    --list-libpcap-devices
        (Not available on this platform.)
        List all available pcap devices.
    -o --logfile
        Specify a file to log to, rather than printing to standard out.
            (default: /var/log/ptunnel.log)
    -s --statistics
        Client only. Enables continuous output of statistics (packet loss, etc.)
    -P --passwd
        Set a password (must be same on client and proxy)
        DEPRECATED: Will be removed/replaced soon!
    --udp
        Toggle use of UDP instead of ICMP. Proxy will listen on port 53 (must be root).
    --unprivileged
        Run proxy in unprivileged mode. This causes the proxy to forward
        packets using standard echo requests, instead of crafting custom echo replies.
        Unprivileged mode will only work on some systems, and is in general less reliable
        than running in privileged mode.
    --force-sha512
        Force SHA512 as challenge response checksum generator.
        This is the default for this configuration.
    -d --daemon
        Run in background, the PID will be written in the file supplied as argument
            (default: /run/ptunnel.pid)
    -S --syslog
        Output debug to syslog instead of standard out.
    -u --user
        When started in privileged mode, drop down to user's rights as soon as possible
            (default: nobody)
    -g --group
        When started in privileged mode, drop down to group's rights as soon as possible
            (default: nogroup)
    -C --chroot
        When started in privileged mode, restrict file access to the specified directory
            (default: /var/lib/ptunnel)
    -e --setcon
        Set SELinux context when all there is left to do are network I/O operations
        To combine with --chroot you will have to `mount --bind /proc /chrootdir/proc`
            (default: ptunnel)
    -h --help
        this
```

## 02 - Server

TODO: Fill this info

## 03 - Client

## 04 - Scenarios

---
## References

- [ptunnel-ng](https://github.com/utoni/ptunnel-ng)

- [PingTunnel](https://www.cs.uit.no/~daniels/PingTunnel/)

- [CyberSec Wikimandine: ICMP Tunneling using ptunnel-ng](https://amandinegh.gitbook.io/cyberadventure/internal/pivoting-tunneling-and-port-forwarding/icmp-tunneling-using-ptunnel-ng)