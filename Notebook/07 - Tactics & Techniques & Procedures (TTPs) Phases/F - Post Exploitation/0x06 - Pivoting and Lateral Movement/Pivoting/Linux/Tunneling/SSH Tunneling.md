# SSH Tunneling

## 01 - Pseudo-VPN Network

### 1.1 - Conditions

- SSH configuration requires `PermitTunnel` enabled

```
user@sshserver:~$ cat /etc/ssh/sshd_config
..[omitted]..
PermitTunnel yes
..[omitted]..
```

### 1.2 - Setup

Note: `<IP>/32` literally means it's a single host which is suitable when setting up a VPN.

TODO: Test it to make sure it works

```
userware@hackware-os:~$ ssh <username>@<IP> -w any:any

userware@hackware-os:~$ ip a

userware@hackware-os:~$ sudo ip address add 192.168.0.2/32 peer 192.168.0.1 dev tun0

userware@hackware-os:~$ sudo route add -net 10.0.0.0/24 gw 192.168.0.1
```

On the SSH server.

```
user@server:~$ sudo ip address add 192.168.0.1/32 peer 192.168.0.2 dev tun0

user@server:~$ sudo sysctl -w net.ipv4.ip_forward=1

user@server:~$ sudo iptables -t nat -A POSTROUTING -s 192.168.0.1 -o <interface> -j MASQUERADE
```

## 02 - SSHuttle

### 2.1 - Usage

```
$ sudo sshuttle --dns -vr <username>@<IP> -x <IPv4>/<CIDR>

$ sudo sshuttle --dns [-e <'ssh -i /path/to/key'>] -vr <username>@<IP> -x <IPv4>/<CIDR>
```

- Prevent sshuttle redirect

```
$ sudo sshuttle -r <username>@<IP> -x <same_ssh_IP> <IPv4>/<CIDR>
```

---
## References

- [Arch Linux: VPN over SSH](https://wiki.archlinux.org/title/VPN_over_SSH)

- [Blackhillsinfosec: Forwarding Traffic Through SSH](https://www.blackhillsinfosec.com/forwarding-traffic-through-ssh/)

- [Certcube: Pivoting Port Forwarding](https://blog.certcube.com/pivoting-port-forwarding/)

- [RawSec: Overview of Network Pivoting and Tunneling](https://blog.raw.pm/en/state-of-the-art-of-network-pivoting-in-2019/)