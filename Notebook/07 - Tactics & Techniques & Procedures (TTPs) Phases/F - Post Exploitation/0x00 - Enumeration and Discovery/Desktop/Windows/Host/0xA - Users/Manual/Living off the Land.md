---
author(s):
  - Userware
tags:
  - post-exploitation
  - enumeration-and-discovery
  - living-off-the-land
  - windows
---
# Living off the Land

## 01 - Current User Enumeration

### 1.1 - Command Prompt

> [!NOTE] [[05 - Common Environment Variables|Environment Variables]]
> The percent/modulus sign means for Windows operating systems it will echo out the variable (for example: `%VARIABLE%`) which is similar to bash script in Linux (for example: `$VARIABLE`)

Current user enumeration.

```
C:\> whoami.exe

C:\> echo %USERNAME%
```

Retrieve user basic information.

```
C:\> net.exe user %USERNAME%

C:\> net.exe user <username>
```

Retrieves the user's SID.

```
C:\> whoami.exe /user
```

Check the user's privileges.

```
C:\> whoami.exe /priv

C:\> whoami.exe /groups

C:\> whoami.exe /all /fo list
```

### 1.2 - PowerShell

```powershell
PS C:\> $Env:USERNAME

PS C:\> [System.Environment]::UserName

PS C:\> [System.Environment]::GetEnvironmentVariable('USERNAME')

PS C:\> [System.Security.Principal.WindowsIdentity]::GetCurrent().Name
```

Retrieves the user's SID.

```powershell
PS C:\> ([System.Security.Principal.WindowsIdentity]::GetCurrent()).User.Value
```

Check the user's privileges.

```
PS C:\> Get-LocalUser

PS C:\> Get-LocalUser | Format-Table Name,Enabled,LastLogon
```

## 02 - Enumerate Local Usernames

### 2.1 - Command Prompt

```
C:\> net.exe user

C:\> net.exe users

C:\> dir /b /ad "C:\Users\"
```

Windows XP and below.

```
C:\> dir /b /ad "C:\Documents and Settings\"
```

### 2.2 - PowerShell

```
PS C:\> Get-ChildItem -Path "C:\Users" -Force | Select-Object Name

PS C:\> Get-ChildItem -Path "\\<IP>\C$\Users" -Force | Select-Object Name
```

## 03 - Enumerate Local Groups

Enumerate local groups.

```
C:\> net.exe localgroup
```

Enumerate current local group users.

```
C:\> net.exe localgroup "<local_group_name>"

C:\> net.exe localgroup "Administrators"
```

## 04 - Logged On Users

Gather logged-on local users.

```
C:\> quser.exe

C:\> query.exe user <username> [/server:<IP>]

C:\> net.exe accounts

C:\> net.exe session [\\<IP>]

C:\> net.exe session [\\<IP>] | find / "\\"

C:\> qwinsta.exe /server:<IP>

C:\> for /f "tokens=1,2" %i in ('qwinsta.exe /server:<IP> ^| findstr "Active Disc"') do @echo %i | find /v "#" | find /v "console" || echo %j

C:\> @for /f %n in (computers.txt) do @for /f "tokens=1,2" %i in ('qwinsta.exe /server:%n ^| findstr "Active Disc"') do @echo %i | find /v "#" | find /v "console" || echo %j > usernames.txt
```

## 05 - User Environment

### 5.1 - Command Prompt

Shows all current environmental variables. Specific ones to look for are `USERDOMAIN`, `USERNAME`, `USERPROFILE`, `HOMEPATH`, `LOGONSERVER`, `COMPUTERNAME`, `APPDATA`, and `ALLUSERPROFILE`.

```
C:\> set
```

### 5.2 - PowerShell

Shows all current environmental variables. Specific ones to look for are `USERDOMAIN`, `USERNAME`, `USERPROFILE`, `HOMEPATH`, `LOGONSERVER`, `COMPUTERNAME`, `APPDATA`, and `ALLUSERPROFILE`.

```
PS C:\> Get-ChildItem Env:

PS C:\> Get-ChildItem Env:* | Format-Table Key,Value

PS C:\> [System.Environment]::GetEnvironmentVariables()
```

---
## References

###  LOFLCAB

- [LOFLCAB: quser](https://lofl-project.github.io/loflcab/Binaries/quser/)

### Wikipedia

- [Wikipedia: Environment Variable](https://en.wikipedia.org/wiki/Environment_variable)

### r00t-3xp10it

- [r00t-3xp10it: CmdLine Scripts for Reverse TCP Shell Addicts](https://github.com/r00t-3xp10it/venom/wiki/CmdLine-%26-Scripts-for-reverse-TCP-shell-addicts)

### NoRed0x

- [NoRed0x: Active Directory Domain Enumeration Part 1](https://nored0x.github.io/red-teaming/active-directory-domain-enumeration-part-1/)

### InfoSec Matter

- [InfoSec Matter: Powershell Commands for Pentesters](https://www.infosecmatter.com/powershell-commands-for-pentesters/)