# Living off the Land

Search Tag(s): #post-exploitation #enumeration-and-discovery #privilege-escalation #living-off-the-land #windows

## 01 - Discover Permissions

### 1.1 - Command Prompt

#### 1.1.1 - icacls.exe

Finding installed program inside folders that contains **full access permissions** that the **Users** and the rest of the groups configuration.

```
C:\> icacls "C:\Program Files\*" 2>nul | findstr "(F)" | findstr "Everyone"

C:\> icacls "C:\Program Files (x86)\*" 2>nul | findstr "(F)" | findstr "Everyone"

C:\> cacls "c:\Program Files" /T | findstr Users

C:\> icacls "C:\Program Files\*" 2>nul | findstr "(F)" | findstr "BUILTIN\Users"

C:\> icacls "C:\Program Files (x86)\*" 2>nul | findstr "(F)" | findstr "BUILTIN\Users"

C:\> icacls "C:\Program Files\*" 2>nul | findstr "(F)" | findstr "Authenticated Users"

C:\> icacls "C:\Program Files (x86)*" 2>nul | findstr "(F)" | findstr "Authenticated Users"
```

Finding installed programs inside folders that contains **modifiable permissions** that the **Users** and the rest of the groups configuration.

```
C:\> icacls "C:\Program Files\*" 2>nul | findstr "(M)" | findstr "Everyone"

C:\> icacls "C:\Program Files (x86)\*" 2>nul | findstr "(M)" | findstr "Everyone"

C:\> cacls "c:\Program Files" /T | findstr Users

C:\> icacls "C:\Program Files\*" 2>nul | findstr "(M)" | findstr "BUILTIN\Users"

C:\> icacls "C:\Program Files (x86)\*" 2>nul | findstr "(M)" | findstr "BUILTIN\Users"

C:\> icacls "C:\Program Files (x86)*" 2>nul | findstr "(M)" | findstr "Authenticated Users"

C:\> icacls "C:\Program Files (x86)\*" 2>nul | findstr "(M)" | findstr "Authenticated Users"
```

##### 1.1.1.2 - SCManager

Check permissions for service creation.

```
C:\> sc sdshow scmanager
```

#### 1.1.2 - Powershell

Running the powershell cmdlet with `Get-ACL` to find certain permissions.

```
PS C:\> Get-ChildItem "C:\Program Files" -Recurse | Get-ACL | ?{$_.AccessToString -match "Everyone\sAllow\s\sModify"}
```

#### 1.1.3 - Sysinternals

##### 1.1.3.1 - Accesschk

- Using sysinternals toolkit to enumerate the path to look for possible misconfigured services.

- Automatically accept the EULA in order to use the binary.

```
C:\> accesschk.exe /accepteula
```

- Enumerating directories permissions' in the `"C:\Program Files"` and `"C:\Program Files (x86)"` path

```
C:\> accesschk.exe -uwcqv Users "C:\Program Files"

C:\> accesschk.exe -uwcqv "Authenticated Users" "C:\Program Files"

C:\> accesschk.exe -uws "Everyone" "C:\Program Files"

C:\> accesschk.exe -uwcqv Users "C:\Program Files (x86)"

C:\> accesschk.exe -uwcqv "Authenticated Users" "C:\Program Files (x86)"

C:\> accesschk.exe -uws "Everyone" "C:\Program Files (x86)"
```

- Enumerating services that the users have been granted access of what permissions

```
C:\> accesschk.exe -uwcqv Users *

C:\> accesschk.exe -uwcqv "Authenticated Users" *

C:\> accesschk.exe -uwcqv "Everyone" *
```

- Enumerating the directories that contains users group permissions on each drive

```
C:\> accesschk.exe -uwcqv Users c:\

C:\> accesschk.exe -uwcqv "Authenticated Users" c:\

C:\> accesschk.exe -uwcqv "Everyone" c:\

C:\> accesschk.exe -uwcqv Users c:\*.*

C:\> accesschk.exe -uwcqv "Authenticated Users" c:\*.*

C:\> accesschk.exe -uwcqv "Everyone" c:\*.*
```

- Enumerating global objects that anyone modify

```
C:\> accesschk.exe -wuo everyone \basednamedobjects
```

##### 1.1.3.2 - Sysmon

- Find the Sysmon executable process

```
C:\> tasklist [/s <IP>] [/u <username> /p <password>] /svc | findstr /i sysmon

C:\> wmic [/node:<IP>] [/user:<username> /password:<password>] [/user:<username> /password:<password>] process where name="Sysmon64.exe" get executablepath
```

- Get configuration

```
C:\> Sysmon64.exe -c

C:\> Sysmon64.exe -s

C:\> dir /s *.xml
```

### 1.2 - Insecure File Permissions

#### 1.2.1 - Command Prompt

Manual services

```
C:\> wmic [/node:<IP>] [/user:<username> /password:<password>] service get name,pathname,startname,startmode | findstr /i "localsystem" | findstr /i /v "c:\windows"
```

Auto and running services

```
C:\> wmic [/node:<IP>] service get name,pathname,startname,startmode | findstr /i "auto" | findstr /i "localsystem" | findstr /i /v "c:\windows"
```

#### 1.2.2 - Powershell

Auto and running services.

```
PS C:\> Get-CimInstance -ClassName Win32_Service | Select-Object Name, State, PathName | Where-Object {$_.State -like 'Running'}

PS C:\> Get-WmiObject -ClassName Win32_Service | Select-Object Name, State, PathName | Where-Object {$_.State -like 'Running'}
```

### 1.3 - Unquoted Service Paths

#### 1.3.1 - Command Prompt

Manual services

```
C:\> wmic [/node:<IP>] service get name,displayname,startname,pathname,startmode 2>nul | findstr /i /v "c:\windows" 2>nul | findstr /i /v """
```

Auto services

```
C:\> wmic service get name,startname,pathname,startmode 2>nul | findstr /i "auto" 2>nul | findstr /i /v "c:\windows" | findstr /i /v """

C:\> wmic [/node:<IP>] service list brief
```

#### 1.3.2 - Powershell

Auto services

```
PS C:\> Get-CimInstance -ClassName Win32_Service -Property Name, DisplayName, PathName, StartMode | Where-Object {$_.StartMode -eq "Auto" -and $_.PathName -notlike "C:\Windows*" -and $_.PathName -notlike '"*'} | Select-Object PathName, DisplayName, Name

PS C:\> Get-WmiObject -ClassName Win32_Service -Property Name, DisplayName, PathName, StartMode | Where-Object {$_.StartMode -eq "Auto" -and $_.PathName -notlike "C:\Windows*" -and $_.PathName -notlike '"*'} | Select-Object PathName, DisplayName, Name
```

### 1.4 - Discover Services

#### 1.4.1 - Service Control Management

##### 1.4.1.1 - Command Prompt

Listing all windows services with **Service Control Management**.

```
C:\> net start

C:\> sc [\\<IP>] query

C:\> sc [\\<IP>] queryex

C:\> sc [\\<IP>] query | findstr SERVICE_NAME

C:\> sc [\\<IP>] query type= service state= all

C:\> sc [\\<IP>] queryex type= service

C:\> wmic [/node:<IP>] service get name, startname
```

##### 1.4.1.2 - Powershell

```
PS C:\> Get-Service | fl

PS C:\> Get-Service | ? {?_.Status -eq "Running" }

PS C:\> Get-Service [-ComputerName <IP>] | Format-List
```

#### 1.4.2 - Startup Services

##### 1.4.2.1 - Command Prompt

Discover startup services

```
C:\> dir "C:\Users\All Users\Start Menu\Programs\Startup"

C:\> dir "C:\Users\<username>\Start Menu\Programs\Startup"

C:\> dir "\\<IP>\C$\Users\<username>\Start Menu\Programs\Startup"

C:\> wmic [/node:<IP>] startup service

C:\> wmic [/node:<IP>] startup list full

C:\> wmic [/node:<IP>] startup get caption,command

C:\> reg query [\\<IP>\]HKLM\Software\Microsoft\Windows\CurrentVersion\Run

C:\> reg query [\\<IP>\]HKLM\Software\Microsoft\Windows\CurrentVersion\RunOnce

C:\> reg query [\\<IP>\]HKCU\Software\Microsoft\Windows\CurrentVersion\Run

C:\> reg query [\\<IP>\]HKCU\Software\Microsoft\Windows\CurrentVersion\RunOnce
```

##### 1.4.2.2 - Powershell

Discover startup services

```
PS C:\> Get-ChildItem "C:\Users\All Users\Start Menu\Programs\Startup"

PS C:\> Get-ChildItem "C:\Users\<username>\Start Menu\Programs\Startup"

PS C:\> Get-ChildItem "\\<IP>\C$\Users\<username>\Start Menu\Programs\Startup"

PS C:\> Get-CimInstance Win32_StartupCommand | Select-Object Name, Command, Location, User | Format-List

PS C:\> Get-ItemProperty -Path 'Registry::HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run'

PS C:\> Get-ItemProperty -Path 'Registry::HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnce'

PS C:\> Get-ItemProperty -Path 'Registry::HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run'

PS C:\> Get-ItemProperty -Path 'Registry::HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnce'
```

---
## References

- [Understanding SDDL Syntax](https://itconnect.uw.edu/wares/msinf/other-help/understanding-sddl-syntax/)

- [Windows Privilege Escalation Weak Permission](https://steflan-security.com/windows-privilege-escalation-weak-permission/)