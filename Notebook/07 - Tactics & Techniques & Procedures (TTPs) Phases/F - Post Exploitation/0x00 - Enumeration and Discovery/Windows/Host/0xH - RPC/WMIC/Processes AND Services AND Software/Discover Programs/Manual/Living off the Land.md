---
author(s):
  - Userware
tags:
  - post-exploitation
  - enumeration-and-discovery
  - living-off-the-land
  - windows
---
# Living off the Land

## 01 - Installed Programs

### 1.1 - Command Prompt

#### 1.1.1 - List Installed Software

```
C:\> wmic.exe [/node:<IP>] [/user:<username> /password:<password>] Product GET Name,Version,Vendor
```

DotNET MSBuild compilers

```
C:\> wmic.exe [/node:<IP>] [/user:<username> /password:<password>] product get description | findstr /c:.NET
```

#### 1.1.2 - List directories including hidden files and folders

```
C:\> wmic.exe PATH Win32_Directory WHERE "Name LIKE 'C:\\%' AND Hidden = True"
```

#### 1.1.3 - Find a specific program

TODO: Convert it to WMIC

Syntax

```
C:\> where.exe <program.exe>

C:\> where.exe /r <C:\ | \\<IP>\c$> <program.exe>

C:\> where.exe /r <program.exe>

C:\> dir /s /b c:\ | findstr "<program.exe>"
```

File Explorer

```
C:\> where.exe explorer.exe

C:\> where.exe /r C:\ explorer.exe

C:\> dir /s /b c:\ | findstr "explorer.exe"
```

Internet Explorer

```
C:\> where.exe iexplore.exe

C:\> where.exe /r C:\ iexplore.exe

C:\> dir /s /b c:\ | findstr "iexplore.exe"
```

Java Updater

```
C:\> where.exe jucheck.exe

C:\> where.exe /r C:\ jucheck.exe

C:\> dir /s /b c:\ | findstr "jucheck.exe"
```

Find MSBuild C# compiler versions

```
C:\> where.exe /r C:\ MSBuild.exe

C:\> where.exe /r \\<IP>\c$ MSBuild.exe

C:\> dir /s /b c:\ | findstr "MSBuild.exe"
```

### 1.2 - PowerShell

#### 1.2.1 - List Installed Software

```
PS C:\> Get-CimInstance [-ComputerName <IP>] -Query "SELECT Name,Caption,Version,InstallLocation,IdentifyingNumber FROM Win32_Product" | ? {?_.Vendor -Notmatch 'Microsoft'}

PS C:\> Get-CimInstance [-ComputerName <IP>] -Query "SELECT Name,Caption,Version,InstallLocation,IdentifyingNumber FROM Win32_Product WHERE NOT LIKE 'Microsoft'"
```

#### 1.2.2 - List directories including hidden files and folders

```
PS C:\> Get-CimInstance [-ComputerName <IP>] -Query "SELECT Name FROM Win32_Directory WHERE Name LIKE 'C:\\%' AND Hidden = True"
```

#### 1.2.3 - Find a specific program

TODO: Convert it to Get-CimInstance and Get-WmiObject

Syntax 

```
PS C:\> Get-Command <program.exe> | Format-Table CommandType, Name, Definition

PS C:\> (Get-Command <program.exe>).Definition

PS C:\> (Get-ChildItem -Recurse -Path <C:\ | \\<IP>\C$\> -Include "<program.exe>" -ErrorAction SilentlyContinue).FullName

PS C:\> Get-ChildItem -Recurse -Path <C:\ | \\<IP>\C$\> -Include "<program.exe>" -ErrorAction SilentlyContinue | ForEach-Object {$_.FullName}

PS C:\> Get-ChildItem -Recurse -Path <C:\ | \\<IP>\C$\> -ErrorAction SilentlyContinue | Where-Object {($_.Name -eq "<program.exe>")} | % {$_.FullName}
```

File Explorer

```
PS C:\> (Get-Command explorer.exe).Definition

PS C:\> (Get-ChildItem -Recurse -Path C:\ -Include "explorer.exe" -ErrorAction SilentlyContinue).FullName
```

Internet Explorer

```
PS C:\> (Get-Command iexplore.exe).Definition

PS C:\> (Get-ChildItem -Recurse -Path C:\ -Include "iexplore.exe" -ErrorAction SilentlyContinue).FullName
```

Java Updater

```
PS C:\> (Get-ChildItem -Recurse -Path C:\ -Include "jucheck.exe" -ErrorAction SilentlyContinue).FullName
```

Find MSBuild C# compiler versions

```
PS C:\> (Get-ChildItem -Recurse -Path C:\ -Include "MSBuild.exe" -ErrorAction SilentlyContinue).FullName

PS C:\> (Get-ChildItem -Recurse -Path \\<IP>\c$ -Include "MSBuild.exe" -ErrorAction SilentlyContinue).FullName
```

## 03 - Device Drivers

### 3.1 - Command Prompt

TODO: Convert it from cmdlets

```

```

### 3.2 - PowerShell

Filtering the installed 3rd party drivers with WMI.

```powershell
PS C:\> Get-CimInstance -ClassName Win32_PnPSignedDriver | Select-Object DeviceName, DriverVersion, Manufacturer | Where-Object {$_.DeviceName -like "*VMWare*"}

PS C:\> Get-CimInstance -Query "SELECT DeviceName, DriverVersion, Manufacturer WHERE LIKE '%VMWare%'"
```

Using WMI for virtualization detection.

```powershell
PS C:\> $VMAdapter = Get-CimInstance -ClassName Win32_NetworkAdapter -Filter 'Manufacturer LIKE "%VMware%" OR Name LIKE "%VMWare%"'

$VMBios = Get-CimInstance Win32_BIOS -Filter 'SerialNumber LIKE "%VMWare%"'

$VMToolsRunning = Get-CimInstance Win32_Process -Filter 'Name="vmtoolsd.exe"'

[Bool]($VMAdapter -or $VMBios -or $VMToolsRunning)
```

## 04 - Antivirus and EDR

### 4.1 - Command Prompt

```
C:\> wmic.exe [/node:<IP>] [/user:<username> /password:<password>] /namespace:\\root\securitycenter2 PATH antivirusproduct

C:\> wmic.exe [/node:<IP>] [/user:<username> /password:<password>] /namespace:\\root\securitycenter2 PATH antivirusproduct GET DisplayName, ProductState, PathToSignedProductExe

C:\> wmic.exe [/node:<IP>] [/user:<username> /password:<password>] /namespace:\\root\securitycenter2 PATH antispywareproduct get /value

C:\> wmic.exe [/node:<IP>] [/user:<username> /password:<password>] /namespace:\\root\securitycenter2 PATH firewallproduct get /value
```

### 4.2 - PowerShell

```
PS C:\> Get-CimInstance -Namespace root\securitycenter2 -ClassName Antivirusproduct

PS C:\> Get-CimInstance -Namespace root\SecurityCenter2 -ClassName AntiVirusProduct | Select-Object -Property DisplayName

PS C:\> Get-CimInstance -Namespace root\securitycenter2 -ClassName Antispywareproduct

PS C:\> Get-CimInstance -Namespace root\securitycenter2 -ClassName Firewallproduct
```

---
## References

- [[07 - Tactics & Techniques & Procedures (TTPs) Phases/F - Post Exploitation/0x00 - Enumeration and Discovery/Windows/Host/0xG - Processes AND Services AND Software/Discover Programs/Manual/Living off the Land]]