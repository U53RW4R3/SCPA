---
author(s):
  - Userware
tags:
  - post-exploitation
  - enumeration-and-discovery
  - privilege-escalation
  - living-off-the-land
  - windows
---
# Living off the Land

## 01 - Command Prompt

### 1.1 - `icacls.exe`

Finding installed program inside folders that contains **full access permissions** that the **Users** and the rest of the groups configuration.

```
C:\> icacls.exe "C:\Program Files\*" 2>nul | findstr "(F)" | findstr "Everyone"

C:\> icacls.exe "C:\Program Files (x86)\*" 2>nul | findstr "(F)" | findstr "Everyone"

C:\> cacls.exe "c:\Program Files" /T | findstr Users

C:\> icacls.exe "C:\Program Files\*" 2>nul | findstr "(F)" | findstr "BUILTIN\Users"

C:\> icacls.exe "C:\Program Files (x86)\*" 2>nul | findstr "(F)" | findstr "BUILTIN\Users"

C:\> icacls.exe "C:\Program Files\*" 2>nul | findstr "(F)" | findstr "Authenticated Users"

C:\> icacls.exe "C:\Program Files (x86)*" 2>nul | findstr "(F)" | findstr "Authenticated Users"
```

Finding installed programs inside folders that contains **modifiable permissions** that the **Users** and the rest of the groups configuration.

```
C:\> icacls.exe "C:\Program Files\*" 2>nul | findstr "(M)" | findstr "Everyone"

C:\> icacls.exe "C:\Program Files (x86)\*" 2>nul | findstr "(M)" | findstr "Everyone"

C:\> cacls.exe "c:\Program Files" /T | findstr Users

C:\> icacls.exe "C:\Program Files\*" 2>nul | findstr "(M)" | findstr "BUILTIN\Users"

C:\> icacls.exe "C:\Program Files (x86)\*" 2>nul | findstr "(M)" | findstr "BUILTIN\Users"

C:\> icacls.exe "C:\Program Files (x86)*" 2>nul | findstr "(M)" | findstr "Authenticated Users"

C:\> icacls.exe "C:\Program Files (x86)\*" 2>nul | findstr "(M)" | findstr "Authenticated Users"
```

### 1.2 - SCManager

Check permissions for service creation.

```
C:\> sc.exe sdshow scmanager
```

## 02 - PowerShell

Running the powershell cmdlet with `Get-Acl` to find certain permissions.

```
PS C:\> Get-ChildItem "C:\Program Files" -Recurse | Get-Acl | ?{$_.AccessToString -match "Everyone\sAllow\s\sModify"}
```

## 03 - Sysinternals

### 3.1 - Accesschk

Using sysinternals toolkit to enumerate the path to look for possible misconfigured services. Automatically accept the EULA in order to use the binary.

```
C:\> accesschk.exe /accepteula
```

Enumerating directories permissions' in the `"C:\Program Files"` and `"C:\Program Files (x86)"` path.

```
C:\> accesschk.exe -uwcqv Users "C:\Program Files"

C:\> accesschk.exe -uwcqv "Authenticated Users" "C:\Program Files"

C:\> accesschk.exe -uws "Everyone" "C:\Program Files"

C:\> accesschk.exe -uwcqv Users "C:\Program Files (x86)"

C:\> accesschk.exe -uwcqv "Authenticated Users" "C:\Program Files (x86)"

C:\> accesschk.exe -uws "Everyone" "C:\Program Files (x86)"
```

Enumerating services that the users have been granted access of what permissions

```
C:\> accesschk.exe -uwcqv Users *

C:\> accesschk.exe -uwcqv "Authenticated Users" *

C:\> accesschk.exe -uwcqv "Everyone" *
```

Enumerating the directories that contains users group permissions on each drive

```
C:\> accesschk.exe -uwcqv Users C:\

C:\> accesschk.exe -uwcqv "Authenticated Users" C:\

C:\> accesschk.exe -uwcqv "Everyone" C:\

C:\> accesschk.exe -uwcqv Users C:\*.*

C:\> accesschk.exe -uwcqv "Authenticated Users" C:\*.*

C:\> accesschk.exe -uwcqv "Everyone" C:\*.*
```

Enumerating global objects that anyone modify

```
C:\> accesschk.exe -wuo everyone \basednamedobjects
```

### 3.2 - Sysmon

Find the Sysmon executable process

```
C:\> tasklist.exe [/s <IP>] [/u <username> /p <password>] /svc | findstr.exe /i sysmon
```

Get configuration

```
C:\> Sysmon64.exe -c

C:\> Sysmon64.exe -s

C:\> dir /s *.xml
```

---
## References

- [Understanding SDDL Syntax](https://itconnect.uw.edu/wares/msinf/other-help/understanding-sddl-syntax/)

- [Steflan Security: Windows Privilege Escalation Weak Permission](https://steflan-security.com/windows-privilege-escalation-weak-permission/)