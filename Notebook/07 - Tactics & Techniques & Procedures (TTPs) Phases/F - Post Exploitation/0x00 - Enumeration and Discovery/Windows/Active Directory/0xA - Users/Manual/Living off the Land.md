---
author(s):
  - Userware
tags:
  - post-exploitation
  - enumeration-and-discovery
  - active-directory
  - living-off-the-land
  - windows
---
# Living off the Land

## 01 - Current User Enumeration

### 1.1 - Command Prompt

Enumerate current user.

```
C:\> whoami.exe /fqdn

C:\> whoami.exe /upn
```

Retrieve basic domain user information.

> [!IMPORTANT]
> If you're getting an error message `System error 1722 has occured`. Depending on the shell prompt context, it may be missing at least one of the access tokens either it's `NT AUTHORITY\NETWORK` or `NT AUTHORITY\SERVICE` if you check the privileges by running `whoami.exe /priv`. For `NT AUTHORITY\NETWORK` try a different remote authentication method such as, SSH, SMB, MSRPC, RDP, WMI, or WinRM. If a callback implant isn't enough to get the privileges.

```
C:\> set userdomain

C:\> net.exe user %USERNAME% /domain

C:\> net.exe user <username> /domain
```

Gather logged-on domain users.

```
C:\> net.exe accounts /domain
```

### 1.2 - PowerShell

Ensure RSAT (Remote Server Administration Tools) is installed.

```
PS C:\> Add-WindowsCapability –Online –Name "Rsat.ActiveDirectory.DS-LDS.Tools~~~~0.0.1.0"
```

Import RSAT PowerShell module.

```
PS C:\> Import-Module ActiveDirectory
```

Retrieve basic domain user information.

```
PS C:\> Get-ADUser $Env:USERNAME

PS C:\> Get-ADUser <username>
```

## 02 - Enumerate Usernames

### 2.1 - Command Prompt

```
C:\> dir C:\Users\

C:\> dir \\<IP>\C$\Users\
```

Enumerate usernames in a active directory network.

```
C:\> net.exe user /domain
```

### 2.2 - PowerShell

```
PS C:\> Get-ADUser -Filter * -SearchBase "CN=Users,DC=<domain>,DC=<tld>"

PS C:\> Get-ADUser -Filter * -SearchBase "OU=<organization_unit>,DC=<domain>,DC=<tld>"
```

Find obsolete users.

```
PS C:\> Get-ADUser -Filter { -Not (ScriptPath -Like "*")}

PS C:\> Get-ChildItem C:\Users\

PS C:\> Get-ChildItem \\<IP>\C$\Users\
```

Enumerate **AdminSDHolder** users.

```
PS C:\> Get-ADUser -LDAPFilter "(objectcategory=person)(samaccountname=*)(admincount=1)"

PS C:\> ([adsisearcher]"(AdminCount=1)").findall()
```

## 03 - Enumerate domain groups

### 3.1 - Command Prompt

Enumerate groups in a active directory.

```
C:\> net.exe group /domain

C:\> net.exe group /domain:<DOMAIN>
```

Enumerate **domain users**.

```
C:\> net.exe group "Domain Users" /domain
```

Enumerate **domain admins**.

```
C:\> net.exe group "Domain Admins" /domain

C:\> net.exe group "Enterprise Admins" /domain
```

### 3.2 - PowerShell

Enumerate local groups.

```
PS C:\> Get-LocalGroup | Format-Table Name -AutoSize
```

Enumerate local **administrator users**.

```
PS C:\> Get-LocalGroupMember Administrators | Format-Table Name, PrincipalSource
```

Enumerate **domain users**.

```
PS C:\> Get-LocalGroupMember "Domain Users" | Format-Table Name, PrincipalSource
```

Enumerate **domain admins**.

```
PS C:\> Get-LocalGroupMember "Domain Admins" | Format-Table Name, PrincipalSource

PS C:\> Get-LocalGroupMember "Enterprise Admins" | Format-Table Name, PrincipalSource
```

Enumerate **AdminSDHolder** groups.

```
PS C:\> Get-ADGroup -LDAPFilter "(objectcategory=group) (admincount=1)"

PS C:\> ([adsisearcher]"(AdminCount=1)").findall()
```