---
author(s):
  - Userware
tags:
  - post-exploitation
  - enumeration-and-discovery
  - active-directory
  - networking
  - network-protocols
  - msrpc
  - smb
  - metasploit-framework
  - windows
---
# Metasploit

TODO: Re-arrange

Building a wordlist when going against password policy. Useful for password cracking.

```
meterpreter > run post/windows/gather/enum_ad_to_wordlist
```

Bitlocker

```
metepreter > run post/windows/gather/enum_ad_bitlocker
```

## 01 - Enumerate Current Username

```
meterpreter > getenv USERNAME
```

## 02 - Enumerate Usernames

### 2.1 - SMB Port

```
msf > use auxiliary/scanner/smb/smb_enumusers_domain

msf auxiliary(scanner/smb/smb_enumusers_domain) > options 

Module options (auxiliary/scanner/smb/smb_enumusers_domain):

   Used when making a new connection via RHOSTS:

   Name       Current Setting  Required  Description
   ----       ---------------  --------  -----------
   RHOSTS                      no        The target host(s), see https://docs.metasploit.com/docs/using-metasploit/basics/using-metasploit.html
   SMBDomain  .                no        The Windows domain to use for authentication
   SMBPass                     no        The password for the specified username
   SMBUser                     no        The username to authenticate as
   THREADS    1                yes       The number of concurrent threads (max one per host)


   Used when connecting via an existing SESSION:

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SESSION                   no        The session to run this module on


View the full module info with the info, or info -d command.

msf auxiliary(scanner/smb/smb_enumusers_domain) > set rhosts <IP>

msf auxiliary(scanner/smb/smb_enumusers_domain) > set smbuser <username>

msf auxiliary(scanner/smb/smb_enumusers_domain) > set smbpass <password | aad3b435b51404eeaad3b435b51404ee:<nt_hash>>

msf auxiliary(scanner/smb/smb_enumusers_domain) > set smbdomain <domain>

msf auxiliary(scanner/smb/smb_enumusers_domain) > set threads <int>

msf auxiliary(scanner/smb/smb_enumusers_domain) > run
```

### 2.2 - MSRPC Port

TODO: Fill this info

```
msf > use auxiliary/scanner/dcerpc/nrpc_enumusers
```

### 2.3 - LDAP Port

TODO: Fill this info

```
msf > use auxiliary/gather/ldap_query

msf auxiliary(gather/ldap_query) > options

Module options (auxiliary/gather/ldap_query):

   Name           Current Setting  Required  Description
   ----           ---------------  --------  -----------
   BASE_DN                         no        LDAP base DN if you already have it
   DOMAIN                          no        The domain to authenticate to
   OUTPUT_FORMAT  table            yes       The output format to use (Accepted: csv, table, json)
   PASSWORD                        no        The password to authenticate with
   RHOSTS                          yes       The target host(s), see https://docs.metasploit.com/docs/using-metasploit/basics/using-metasploit.html
   RPORT          389              yes       The target port
   SSL            false            no        Enable SSL on the LDAP connection
   USERNAME                        no        The username to authenticate with


   When ACTION is RUN_SINGLE_QUERY:

   Name              Current Setting  Required  Description
   ----              ---------------  --------  -----------
   QUERY_ATTRIBUTES                   no        Comma seperated list of attributes to retrieve from the server
   QUERY_FILTER                       no        Filter to send to the target LDAP server to perform the query


   When ACTION is RUN_QUERY_FILE:

   Name             Current Setting  Required  Description
   ----             ---------------  --------  -----------
   QUERY_FILE_PATH                   no        Path to the JSON or YAML file to load and run queries from


Auxiliary action:

   Name           Description
   ----           -----------
   ENUM_ACCOUNTS  Dump info about all known user accounts in the domain.



View the full module info with the info, or info -d command.

msf auxiliary(gather/ldap_query) > set
```

### 2.4 - Kerberos Port

```
msf > use auxiliary/gather/kerberos_enumusers

msf auxiliary(gather/kerberos_enumusers) > options 

Module options (auxiliary/gather/kerberos_enumusers):

   Name              Current Setting  Required  Description
   ----              ---------------  --------  -----------
   ANONYMOUS_LOGIN   false            yes       Attempt to login with a blank username and password
   BLANK_PASSWORDS   false            no        Try blank passwords for all users
   BRUTEFORCE_SPEED  5                yes       How fast to bruteforce, from 0 to 5
   DB_ALL_CREDS      false            no        Try each user/password couple stored in the current database
   DB_ALL_PASS       false            no        Add all passwords in the current database to the list
   DB_ALL_USERS      false            no        Add all users in the current database to the list
   DB_SKIP_EXISTING  none             no        Skip existing credentials stored in the current database (Accepted: none, user, user&realm)
   DOMAIN                             yes       The Domain Eg: demo.local
   PASSWORD                           no        A specific password to authenticate with
   PASS_FILE                          no        File containing passwords, one per line
   RHOSTS                             yes       The target host(s), see https://docs.metasploit.com/docs/using-metasploit/basics/using-metasploit.html
   RPORT             88               yes       The target port
   STOP_ON_SUCCESS   false            yes       Stop guessing when a credential works for a host
   THREADS           1                yes       The number of concurrent threads (max one per host)
   USERNAME                           no        A specific username to authenticate as
   USERPASS_FILE                      no        File containing users and passwords separated by space, one pair per line
   USER_AS_PASS      false            no        Try the username as the password for all users
   USER_FILE                          no        File containing usernames, one per line
   VERBOSE           true             yes       Whether to print output for all attempts


View the full module info with the info, or info -d command.

msf auxiliary(gather/kerberos_enumusers) > set rhosts <IP>

msf auxiliary(gather/kerberos_enumusers) > set domain <domain>

msf auxiliary(gather/kerberos_enumusers) > set username <username>

msf auxiliary(gather/kerberos_enumusers) > set password <password>

msf auxiliary(gather/kerberos_enumusers) > run
```

### 2.5 - SNMP Port

```
msf > use auxiliary/scanner/snmp/snmp_enumusers

msf auxiliary(scanner/snmp/snmp_enumusers) > options

Module options (auxiliary/scanner/snmp/snmp_enumusers):

   Name       Current Setting  Required  Description
   ----       ---------------  --------  -----------
   COMMUNITY  public           yes       SNMP Community String
   RETRIES    1                yes       SNMP Retries
   RHOSTS                      yes       The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/Using-Metasploit
   RPORT      161              yes       The target port (UDP)
   THREADS    1                yes       The number of concurrent threads (max one per host)
   TIMEOUT    1                yes       SNMP Timeout
   VERSION    1                yes       SNMP Version <1/2c>

msf auxiliary(scanner/snmp/snmp_enumusers) > set version <1 | 2c>

msf auxiliary(scanner/snmp/snmp_enumusers) > run rhosts=<target_IP> rport=<target_PORT> community=<password>
```

### 2.6 - Interactive Session

Enumerate usernames from a directory (OPSEC safe).

```
meterpreter > ls C:/Users/

meterpreter > ls //<IP>/C$/Users/
```

TODO: Fill this info

- LDAP query

```
msf > use post/windows/gather/enum_ad_users

options

msf > use post/windows/gather/enum_ad_user_comments

meterpreter > run post/windows/gather/enum_domain_users
```

## 03 - Enumerate domain groups

### Interactive Shell

Enumerate **domain users.**

```
meterpreter > run post/windows/gather/enum_domain_group_users group="Domain Users"
```

Enumerate **domain admins.**

```
meterpreter > run post/windows/gather/enum_domain_group_users group="Domain Admins"

meterpreter > run post/windows/gather/enum_domain_group_users group="Enterprise Admins"
```

TODO: Fill this info

- LDAP query

```
meterpreter > run post/windows/gather/enum_ad_groups

meterpreter > run post/windows/gather/enum_ad_managedby_groups
```

## User enumeration via RID Cycling

Metasploit auxiliary bruteforce users via SID lookups.

```
msf > use auxiliary/scanner/smb/smb_lookupsid

msf auxiliary(scanner/smb/smb_lookupsid) > show actions 

Auxiliary actions:

       Name    Description
       ----    -----------
       DOMAIN  Enumerate domain accounts
   =>  LOCAL   Enumerate local accounts

msf auxiliary(scanner/smb/smb_lookupsid) > options

Module options (auxiliary/scanner/smb/smb_lookupsid):

   Name    Current Setting  Required  Description
   ----    ---------------  --------  -----------
   MaxRID  4000             no        Maximum RID to check
   MinRID  500              no        Starting RID to check


   Used when making a new connection via RHOSTS:

   Name       Current Setting  Required  Description
   ----       ---------------  --------  -----------
   RHOSTS                      no        The target host(s), see https://docs.metasploit.com/docs/using-metasploit/basics/using-metasploit.html
   SMBDomain  .                no        The Windows domain to use for authentication
   SMBPass                     no        The password for the specified username
   SMBUser                     no        The username to authenticate as
   THREADS    1                yes       The number of concurrent threads (max one per host)


   Used when connecting via an existing SESSION:

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SESSION                   no        The session to run this module on


Auxiliary action:

   Name   Description
   ----   -----------
   LOCAL  Enumerate local accounts



View the full module info with the info, or info -d command.

msf auxiliary(scanner/smb/smb_lookupsid) > set action domain

msf auxiliary(scanner/smb/smb_lookupsid) > set smbpass <password | aad3b435b51404eeaad3b435b51404ee:<nt_hash>>

msf auxiliary(scanner/smb/smb_lookupsid) > set minrid <min_id_range>

msf auxiliary(scanner/smb/smb_lookupsid) > set maxrid <max_id_range>

msf auxiliary(scanner/smb/smb_lookupsid) > run 'smb://<domain>;<username>:<password>@<IP>' threads=2
```

---
## References

- [Rapid7: Metasploit Framework - Enumerate Domain Controller Gather Post Module](https://github.com/rapid7/metasploit-framework/blob/master/documentation/modules/post/windows/gather/enum_domain.md)

- [Rapid7: Metasploit Framework - Enumerate Tokens Gather Post Module](https://github.com/rapid7/metasploit-framework/blob/master/documentation/modules/post/windows/gather/enum_tokens.md)