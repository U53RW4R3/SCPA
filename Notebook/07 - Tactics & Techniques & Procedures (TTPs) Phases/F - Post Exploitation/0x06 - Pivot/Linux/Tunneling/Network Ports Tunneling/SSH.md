---
author(s):
  - Userware
tags:
  - post-exploitation
  - pivot
  - tunneling
  - networking
  - ssh
---
# SSH

## 01 - Pseudo-VPN Network

> [!INFO]
> This tunneling method will not work in Windows.

### 1.1 - Setup

> [!IMPORTANT] Conditions
> SSH configuration requires `PermitTunnel` enabled. Here's the required modifications:
> ```
user@server:~$ cat /etc/ssh/sshd_config
..[omitted]..
PermitTunnel yes
..[omitted]..
> ```
>> [!NOTE]
>> `<IP>/32` literally means it's a single host which is suitable when setting up a VPN.

TODO: Test it to make sure it works

Client side.

```
root@hackware-os:~# ssh <username>@<IP> -w any:any

root@hackware-os:~# ip a

root@hackware-os:~# ip address add 192.168.0.2/32 peer 192.168.0.1 dev tun0

root@hackware-os:~# route add -net 10.0.0.0/24 gw 192.168.0.1
```

Server side.

```
root@server:~# ip address add 192.168.0.1/32 peer 192.168.0.2 dev tun0

root@server:~# sysctl -w net.ipv4.ip_forward=1

root@server:~# iptables -t nat -A POSTROUTING -s 192.168.0.1 -o <interface> -j MASQUERADE
```

### 1.2 - Assign an IP address

Server side.

```
root@server:~# ip address add 10.0.0.1/24 dev tun0

root@server:~# ifconfig tun0 10.0.0.1 netmask 255.255.255.0
```

Client side.

```
root@hackware-os:~# ip address add 10.0.0.2/24 dev tun0

root@hackware-os:~# ifconfig tun0 10.0.0.2 netmask 255.255.255.0
```

### 1.3 - Delete Tunnel Network Interface

Server side.

```
root@server:~# ip address del 10.0.0.1/24 dev tun0

root@server:~# ifconfig tun0 10.0.0.1 netmask 255.255.255.0 down
```

Client side.

```
root@hackware-os:~# ip address del 10.0.0.2/24 dev tun0

root@hackware-os:~# ifconfig tun0 10.0.0.2 netmask 255.255.255.0 down
```

## 02 - SSHuttle

> [!INFO]
> This tunneling method will not work in Windows as a pivoting vector, because it requires python to be installed on the server-side.
> > [!WARNING] OPSEC Warning
> > As a tradeoff `sshuttle` will drop a large python file if you check with detailed verbosity (`-vvv`) it can be used as an indicator of compromise.

### 2.1 - Usage

```
$ sudo sshuttle --dns -vr <username>@<IP> -x <IPv4>/<CIDR>

$ sudo sshuttle --dns [-e <'ssh -i /path/to/key'>] -vr <username>@<IP> -x <IPv4>/<CIDR>
```

Prevent sshuttle redirect

```
$ sudo sshuttle -r <username>@<IP> -x <same_ssh_IP> <IPv4>/<CIDR>
```

---
## References

### Github

- [SSHuttle](https://github.com/sshuttle/sshuttle)

### Arch Linux Wiki

- [Arch Linux: VPN over SSH](https://wiki.archlinux.org/title/VPN_over_SSH)

### Black Hills Information Security

- [Black Hills Information Security: Forwarding Traffic Through SSH](https://www.blackhillsinfosec.com/forwarding-traffic-through-ssh/)

### Certcube

- [Certcube: Pivoting Port Forwarding](https://blog.certcube.com/pivoting-port-forwarding/)

### RawSec

- [RawSec: Overview of Network Pivoting and Tunneling](https://blog.raw.pm/en/state-of-the-art-of-network-pivoting-in-2019/)