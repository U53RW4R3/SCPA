---
author(s):
  - Userware
tags:
  - post-exploitation
  - pivot
  - tunneling
  - networking
  - ssh
---
# SSH Tunneling

## 01 - Pseudo-VPN Network

### 1.1 - Conditions

SSH configuration requires `PermitTunnel` enabled. Here's the required modifications:

```
user@server:~$ cat /etc/ssh/sshd_config
..[omitted]..
PermitTunnel yes
..[omitted]..
```

### 1.2 - Setup

> [!NOTE]
> `<IP>/32` literally means it's a single host which is suitable when setting up a VPN.

TODO: Test it to make sure it works

```
root@hackware-os:~# ssh <username>@<IP> -w any:any

root@hackware-os:~# ip a

root@hackware-os:~# ip address add 192.168.0.2/32 peer 192.168.0.1 dev tun0

root@hackware-os:~# route add -net 10.0.0.0/24 gw 192.168.0.1
```

On the SSH server.

```
root@server:~# ip address add 192.168.0.1/32 peer 192.168.0.2 dev tun0

root@server:~# sysctl -w net.ipv4.ip_forward=1

root@server:~# iptables -t nat -A POSTROUTING -s 192.168.0.1 -o <interface> -j MASQUERADE
```

============================

Assign an IP address.

```
root@server:~# ip address add 10.0.0.1/24 dev tun0

root@server:~# ifconfig tun0 10.0.0.1 netmask 255.255.255.0
```

Assign an IP address.

```
root@hackware-os:~# ip address add 10.0.0.2/24 dev tun0

root@hackware-os:~# ifconfig tun0 10.0.0.2 netmask 255.255.255.0
```

#### 3.3.1 - Delete Tunnel Network Interface

Delete the network interface from the server side.

```
root@server:~# ip address del 10.0.0.1/24 dev tun0

root@server:~# ifconfig tun0 10.0.0.1 netmask 255.255.255.0 down
```

Delete the network interface from the client side.

```
root@hackware-os:~# ip address del 10.0.0.2/24 dev tun0

root@hackware-os:~# ifconfig tun0 10.0.0.2 netmask 255.255.255.0 down
```

=====================

## 02 - SSHuttle

### 2.1 - Usage

```
$ sudo sshuttle --dns -vr <username>@<IP> -x <IPv4>/<CIDR>

$ sudo sshuttle --dns [-e <'ssh -i /path/to/key'>] -vr <username>@<IP> -x <IPv4>/<CIDR>
```

Prevent sshuttle redirect

```
$ sudo sshuttle -r <username>@<IP> -x <same_ssh_IP> <IPv4>/<CIDR>
```

---
## References

- [SSHuttle](https://github.com/sshuttle/sshuttle)

- [Arch Linux: VPN over SSH](https://wiki.archlinux.org/title/VPN_over_SSH)

- [Blackhillsinfosec: Forwarding Traffic Through SSH](https://www.blackhillsinfosec.com/forwarding-traffic-through-ssh/)

- [Certcube: Pivoting Port Forwarding](https://blog.certcube.com/pivoting-port-forwarding/)

- [RawSec: Overview of Network Pivoting and Tunneling](https://blog.raw.pm/en/state-of-the-art-of-network-pivoting-in-2019/)