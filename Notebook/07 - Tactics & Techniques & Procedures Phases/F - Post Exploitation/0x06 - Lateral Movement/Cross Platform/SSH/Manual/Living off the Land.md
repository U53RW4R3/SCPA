# Living off the Land

## 01 - Authenticating via Password

```
> ssh [-p <PORT>] <username>@<IP>

> ssh [-oKexAlgorithms=+diffie-hellman-group1-sha1 -c aes256-cbc] [-p <PORT>] <username>@<IP>
```

When establishing connection through a legacy SSH server.

```
> ssh -oHostKeyAlgorithms=+ssh-rsa -oPubKeyAcceptedAlgorithms=+ssh-rsa [-p <PORT>] <username>@<IP>

> ssh -oHostKeyAlgorithms=+ssh-dss -oPubKeyAcceptedAlgorithms=+ssh-dss [-p <PORT>] <username>@<IP>
```

## 02 - Authenticating via SSH Key

Ensure the right permissions are set depending on the SSH key. Here's a table reference:

| File                    | File Type    | Permission         | Description                                                                             |
| ----------------------- | ------------ | ------------------ | --------------------------------------------------------------------------------------- |
| `$HOME/.ssh/`           | Directory    | 700 (`drwx------`) | SSH Directory                                                                           |
| `$HOME/id_rsa.pub`      | Regular File | 644 (`-rw-r--r--`) | Public keys                                                                             |
| `$HOME/id_rsa`          | Regular File | 600 (`-rw-------`) | Private keys                                                                            |
| `$HOME/authorized_keys` | Regular File | 600 (`-rw-------`) | File contains public keys that were copied and authorized to connect to the SSH server. |
| `$HOME/known_hosts`     | Regular File | 600 (`-rw-------`) | A list contains established SSH servers.                                                |
| `$HOME/config`          | Regular File | 600 (`-rw-------`) | A SSH config file.                                                                      |

```
$ chmod 600 /path/to/ssh_key

> ssh -i /path/to/ssh_key [-oHostKeyAlgorithms=+ssh-rsa] <username>@<IP>
```

To convert `.ppk` files into `.pem`.

```
$ sudo apt install -y putty-tools

$ puttygen file.ppk -O private-openssh -o file.pem
```

## 03 - SSH Agent

TODO: Figure it out how it works.

```
$ env | grep SSH_AUTH_SOCK
```

```
$ eval $(ssh-agent -s)

$ ssh-add -l
```

```
$ pstree -p <username> | grep sshd

$ sudo tr '\0' '\n' < /proc/<sshd_pid>/environ | grep SSH_AUTH_SOCK

$ ps auxeww | grep ssh-agent | grep SSH_AUTH_SOCK | sed 's/.*SSH_AUTH_SOCK=//' | cut -f 1 -d ' '
```

```
$ export SSH_AUTH_SOCK=/path/to/agent.<pid>

$ export SSH_AUTH_SOCK=/tmp/ssh-tqiEl28473/agent.28473

$ ssh user@host
```

---
## References

### Backlinks

- [[07 - Tactics & Techniques & Procedures Phases/C - Initial Access/0x00 - Exploitation/0xF - Remote Services Exploitation/Network Ports/Remote Services/SSH/Unix Shell]]

### Hacktricks

- [Hacktricks: SSH Forward Agent exploitation](https://book.hacktricks.wiki/en/linux-hardening/privilege-escalation/ssh-forward-agent-exploitation.html)

### Embrace The Red

- [Embrace The Red: TTP Diaries - SSH Agent Hijacking](https://embracethered.com/blog/posts/2022/ttp-diaries-ssh-agent-hijacking/)

### ROPNOP

- [ROPNOP: Extracting SSH Private Keys From Windows 10 `ssh-agent`](https://blog.ropnop.com/extracting-ssh-private-keys-from-windows-10-ssh-agent/)