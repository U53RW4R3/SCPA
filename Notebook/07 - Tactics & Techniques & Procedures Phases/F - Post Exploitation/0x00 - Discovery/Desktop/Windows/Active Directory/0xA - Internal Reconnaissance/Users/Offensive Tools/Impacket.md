---
author(s):
  - Userware
tags:
  - post-exploitation
  - enumeration-and-discovery
  - active-directory
  - staying-off-the-land
  - networking
  - network-ports
  - msrpc
  - smb
  - windows
---
# Impacket
## 01 - Enumerate User Accounts

### 1.1 - `smbclient`

Authentication syntax

```
$ smbclient.py <domain>\<username>:"<password>"@<IP>

$ smbclient.py <domain>\<username>@<IP> -hashes :<nt_hash>
```

Enumerate user accounts through the directory. This is limited but ideal to avoid detection from security endpoints.

```
# use C$
ls \Users\
```

### 1.2 - `GetADUsers`

```
$ GetADUsers.py -all <domain>\<username>:"<password>"@<IP> -dc-ip <domain_controller_IP>

$ GetADUsers.py -all <domain>\<username>@<IP> -hashes :<nt_hash> -dc-ip <domain_controller_IP>
```

## 02 - User enumeration via RID Cycling

> [!IMPORTANT] Condition
> `HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa` registry path with a registry name `RestrictAnonymous` must be set with a value of `0x1`.

Authentication for RID lookup.

```
$ samrdump.py <domain>/<username>:<password>@<IP>

$ samrdump.py <domain>/<username>@<IP> -hashes :<nt_hash>
```

User enumeration.

```
$ samrdump.py guest@<IP> -no-pass
```

## 03 - User enumeration via SID Cycling

Authentication for SID lookup.

```
$ lookupsids.py <domain>/<username>:<password>@<IP>

$ lookupsids.py <domain>/<username>@<IP> -hashes :<nt_hash>
```

User enumeration.

```
$ lookupsids.py guest@<IP> -no-pass
```

---
## References

### Hacking Articles

- [Hacking Articles: Impacket Guide: SMB/MSRPC](https://www.hackingarticles.in/impacket-guide-smb-msrpc/)

### SMB Port

- [[07 - Tactics & Techniques & Procedures Phases/A - Information Gathering/0x02 - Active Fingerprinting/Network Ports/Cross Platform/Remote Services/SMB|Manual: SMB Active Enumeration]]

- [Juggernaut-Sec: AD Recon â€“ MSRPC Over SMB (135/139/445)](https://juggernaut-sec.com/ad-recon-msrpc-over-smb/)

- [Wadcoms: Impacket GetADUsers](https://wadcoms.github.io/wadcoms/Impacket-GetADUsers/)

### LDAP Port

- [Hacktricks: Pentesting LDAP](https://book.hacktricks.wiki/en/network-services-pentesting/pentesting-ldap.html)

- [Malicious.link: LDAPSearch Reference](https://room362.com/posts/2022/ldapsearch-reference/)