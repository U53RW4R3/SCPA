---
author(s):
  - Userware
tags:
  - post-exploitation
  - enumeration-and-discovery
  - active-directory
  - staying-off-the-land
  - networking
  - network-ports
  - msrpc
  - smb
  - ldap
  - windows
---
# Unix Shell

## 01 - Current Username Enumeration

### 1.1 - MSRPC Port

#### 1.1.1 - `rpcclient`

Authentication syntax.

```
$ rpcclient -U "<username>%<password>" [-p 593] <IP>
```

Authenticate `guest` account.

```
$ rpcclient <IP> -U 'guest%' <IP>
rpcclient $>
```

Enumerate current user.

```
rpcclient $> samlookupnames domain <username>

rpcclient $> samlookuprids domain <username_rid_value>
```

Retrieve current domain user password information.

```
rpcclient $> getusrdompwinfo <username_rid_value>
```

Retrieve the SID's current username.

```
rpcclient $> lookupnames <username>
```

List all of the SIDs.

```
rpcclient $> lsaenumsid
```

Identify the SID current username.

```
rpcclient $> lookupsids <SID>
```

Enumerate the levels of privileges such as high, low, and attribute

```
rpcclient $> lsaenumprivaccount <SID>
```

Display Query Information. You can find information in the description that my contain credentials.

```
rpcclient $> querydispinfo
```

#### 1.1.2 - `net`

```
$ net <ads | rpc> user info "<username>" -U "<username>%<password>" -S <IP>

$ net <ads | rpc> user info "<username>" -U "<username>" --pw-nt-hash <nt_hash> -S <IP>
```

### 1.2 - LDAP Port

#### 1.2.1 - `ldapsearch`

> [!INFO] What TLD looks like?
> TLD (Top Level Domain) looks like this `.com`, `.net`, etc.

Syntax command.

```
$ ldapsearch -x -D '<DOMAIN>\<username>' -w '<password>' -b "DC=<domain>,DC=<tdl>" -H ldap://<IP>
```

Retrieve a specific user account.

```
$ ldapsearch -x -D '<DOMAIN>\<username>' -w '' -b "CN=<username>,CN=Users,DC=<subdomain>,DC=<tdl>" -H ldap://<IP>
```

#### 1.2.2 - `samba-tool`

```
$ samba-tool user show <remote_username> --attributes=* -U [<domain>/]<username>@<password> -H ldap://<IP>
```

## 02 - Enumerate User Accounts

### 2.1 - MSRPC Port

#### 2.1.1 - `rpcclient`

```
rpcclient $> enumdomtrusts
```

#### 2.1.2 - `net`

```
$ net <ads | rpc> user -U "<username>%<password>" -S <IP>

$ net <ads | rpc> user -U "<username>" --pw-nt-hash <nt_hash> -S <IP>
```

### 2.2 - SMB Port

Enumerate user accounts through the directory. This is limited but ideal to avoid detection from security endpoints.

```
$ smbclient -U "[<domain>/]<username>%<password>" //<IP>/C$ -c "ls /Users/"

$ smbclient -U "[<domain>/]<username>" --pw-nt-hash <nt_hash> //<IP>/C$ -c "ls /Users/"
```

### 2.3 - LDAP Port

#### 2.3.1 - `ldapsearch`

Retrieve **local users**.

```
$ ldapsearch -x -D '<DOMAIN>\<username>' -w '' -b "CN=Users,DC=<subdomain>,DC=<tdl>" -H ldap://<IP>
```

Enumerate all active users.

```
$ ldapsearch -x -D '<DOMAIN>\<username>' -w '' -b "(&(objectCategory=person)(objectClass=user)(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))" -H ldap://<IP>
```

Enumerate users contains with password is not required (`passnotreq`) set.

```
$ ldapsearch -x -D '<DOMAIN>\<username>' -w '' -b "(&(objectCategory=Person)(objectClass=User)(userAccountControl:1.2.840.113556.1.4.803:=32))" -H ldap://<IP>
```

All users with `Password Never Expires` set.

```
$ ldapsearch -x -D '<DOMAIN>\<username>' -w '' -b "(&(objectCategory=person)(objectClass=user)(userAccountControl:1.2.840.113556.1.4.803:=65536))" -H ldap://<IP>
```

#### 2.3.2 - `samba-tool`

TODO: Convert the commands from `ldapsearch`.

```
$ samba-tool user show <remote_username> --attributes=* -U [<domain>/]<username>@<password> -H ldap://<IP>
```

## 03 - Enumerate groups

### 3.1 - MSRPC Port

#### 3.1.1 - `rpcclient`

Enumerate **domain users**

```
rpcclient $> enumdomusers

rpcclient $> querygroupmem <group_rid_value>
```

Enumerate **domain groups**

```
rpcclient $> enumdomgroups

rpcclient $> enumalsgroups domain
```

Enumerate current group.

```
rpcclient $> querygroup <group_rid_value>
```

Retrieve the SID's current group.

```
rpcclient $> lookupnames <group>
```

##### 3.1.1.2 - Enumerating LSA Group Privileges

List all of the SIDs.

```
rpcclient $> lsaenumsid
```

Identify the SID of the group's name.

```
rpcclient $> lookupsids <SID>
```

Enumerate the levels of privileges such as high, low, and attribute

```
rpcclient $> lsaenumprivaccount <SID>
```

#### 3.1.2 - `net`

Retrieve **domain groups**.

```
$ net rpc group list -U '[<domain>/]<username>%<password>' -S <IP>
```

Retrieve current domain group.

```
$ net rpc group members '<group_name>' -U "[<domain>/]<username>%<password>" -S '<IP>'

$ net rpc group members '<group_name>' -U "[<domain>/]<username>" --pw-nt-hash <nt_hash> -S '<IP>'
```

Retrieve **domain users**.

```
$ net rpc group members 'Domain Users' -U '[<domain>/]<username>%<password>' -S '<IP>'
```

Retrieve **domain administrators**.

```
$ net rpc group members 'Domain Admins' -U '[<domain>/]<username>%<password>' -S '<IP>'

$ net rpc group members 'Enterprise Admins' -U '[<domain>/]<username>%<password>' -S '<IP>'

$ net rpc group members 'Administrators' -U '[<domain>/]<username>%<password>' -S '<IP>'
```

### 3.2 - LDAP Port

#### 3.3.1 - `ldapsearch`

Enumerate all groups.

```
$ ldapsearch -x -D '<DOMAIN>\<username>' -w '' -b "(&(objectClass=group))" -H ldap://<IP>
```

Retrieve **domain users**.

```
$ ldapsearch -x -D '<DOMAIN>\<username>' -w '' -b "CN=Domain Users,CN=Users,DC=<subdomain>,DC=<tdl>" -H ldap://<IP>
```

Retrieve **domain admins**.

```
$ ldapsearch -x -D '<DOMAIN>\<username>' -w '' -b "(&(objectCategory=group)(name=Domain Admins))" -H ldap://<IP>

$ ldapsearch -x -D '<DOMAIN>\<username>' -w '' -b "CN=Domain Admins,CN=Users,DC=<subdomain>,DC=<tdl>" -H ldap://<IP>
```

Retrieve **enterprise admins**.

```
$ ldapsearch -x -D '<DOMAIN>\<username>' -w '' -b "CN=Enterprise Admins,CN=Users,DC=<subdomain>,DC=<tdl>" -H ldap://<IP>
```

Retrieve **local administrators**.

```
$ ldapsearch -x -D '<DOMAIN>\<username>' -w '' -b "CN=Administrators,CN=Builtin,DC=<subdomain>,DC=<tdl>" -H ldap://<IP>
```

Retrieve **remote desktop users**.

```
$ ldapsearch -x -D '<DOMAIN>\<username>' -w '' -b "CN=Remote Desktop Users,CN=Builtin,DC=<subdomain>,DC=<tdl>" -H ldap://<IP>
```

#### 3.3.1 - `samba-tool`

TODO: Convert the commands from `ldapsearch`.

## 04 - Enumerate Privileges

LSA Query Security Objects

```
rpcclient $> lsaquerysecobj
```

Lookup LSA privilege value.

```
rpcclient $> lsalookupprivvalue SeCreateTokenPrivilege
```

## 05 - User enumeration via RID Cycling

> [!IMPORTANT] Condition
> `HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa` registry path with a registry name `RestrictAnonymous` must be set with a value of `0x1`.

User enumeration via RID Cycling.

```
$ for i in $(seq 500 1100); do rpcclient -N -U "" <IP> -c "queryuser 0x$(printf '%x\n' $i)" | grep "User Name\|user_rid\|group_rid" && echo ""; done
```

---
## References

### Hacking Articles

- [Hacking Articles: Impacket Guide: SMB/MSRPC](https://www.hackingarticles.in/impacket-guide-smb-msrpc/)

### MSRPC Port

- [Hacktricks: rpcclient enumeration](https://book.hacktricks.wiki/en/network-services-pentesting/pentesting-smb/rpcclient-enumeration.html)

### SMB Port

- [[07 - Tactics & Techniques & Procedures Phases/A - Information Gathering/0x02 - Active Fingerprinting/Network Ports/Cross Platform/Remote Services/SMB|Manual: SMB Active Enumeration]]

- [Juggernaut-Sec: AD Recon â€“ MSRPC Over SMB (135/139/445)](https://juggernaut-sec.com/ad-recon-msrpc-over-smb/)

### LDAP Port

### LDAP Port

- [Hacktricks: Pentesting LDAP](https://book.hacktricks.wiki/en/network-services-pentesting/pentesting-ldap.html)

- [Malicious.link: LDAPSearch Reference](https://room362.com/posts/2022/ldapsearch-reference/)

- [Techno Herder: How To Search LDAP using ldapsearch (With Examples)](https://web.archive.org/web/20240528071006/https://hack.technoherder.com/how-to-search-ldap-using-ldapsearch-with-examples/)