---
author(s):
  - Userware
tags:
  - post-exploitation
  - maintaining-access
  - persistence
  - living-off-the-land
  - network-protocols
  - ssh
  - windows
---
# Living off the Land

> [!INFO]
> This can work on older operating systems at least from Windows 7 and Windows 2012 R2 (version 6.3.9600).

## 01 - Install OpenSSH Server

### 1.2 - Command Prompt

TODO: Fill this info

```
C:\> winget search openssh

C:\> winget install --id=Microsoft.OpenSSH.Beta -e
```

```
C:\> Dism.exe /Online /Get-Capabilities | findstr.exe /i "OpenSSH."

C:\> Dism.exe /Online /Add-Capability /CapabilityName:OpenSSH.Client~~~~0.0.1.0

C:\> Dism.exe /Online /Add-Capability /CapabilityName:OpenSSH.Server~~~~0.0.1.0
```

```
C:\> msiexec.exe /i /qn https://github.com/PowerShell/Win32-OpenSSH/releases/download/v9.5.0.0p1-Beta/OpenSSH-Win32-v9.5.0.0.msi
```

7. Start the OpenSSH Authentication Agent and SSH Server services: 

```
C:\> sc.exe start sshd

C:\> sc.exe start ssh-agent
```

```
C:\> netsh.exe
```

Test the SSH port is running in the background.

```
C:\> ssh.exe <username>@localhost
```

### 1.2 - PowerShell

```
PS C:\> Get-WindowsCapability -Online | ? Name -Like 'OpenSSH'

PS C:\> Add-WindowsCapability -Online -Name OpenSSH.Client~~~~0.0.1.0

PS C:\> Add-WindowsCapability -Online -Name OpenSSH.Server~~~~0.0.1.0
```

1. Unblock the downloaded OpenSSH archive if necessary: 

```
PS C:\> Invoke-WebRequest https://github.com/PowerShell/Win32-OpenSSH/releases/download/v9.5.0.0p1-Beta/OpenSSH-Win64.zip -OutFile $Env:UserProfile\Downloads\OpenSSH-Win64.zip -UseBasicParsing
```

```
PS C:\> Unblock-File .\$Env:UserProfile\Downloads\OpenSSH-Win64.zip
```

Extract the archive.

```
PS C:\> Expand-Archive .\$Env:UserProfile\Downloads\OpenSSH-Win64.zip -DestinationPath .
```

Copy the `OpenSSH-Win64` folder to your desired location, (e.g. `C:\`)

```
PS C:\> Copy-Item -Recurse .\OpenSSH-Win64\ C:\
```

The `libcrypto.dll` file has to be accessible for all users.

```
PS C:\> icacls C:\OpenSSH-Win64\libcrypto.dll /grant Everyone:RX
```

5. Run `install-sshd.ps1` to create the OpenSSH authentication agent and OpenSSH service for the server. It also sets some permissions and registers an **Event Tracing (ETW)** provider.

```
PS C:\> C:\OpenSSH-Win64\install-sshd.ps1
```

6. Change the service startup to Automatic. The OpenSSH SSH Server service is set to manual as default. 

```
PS C:\> Set-Service -Name sshd -StartupType 'Automatic'

PS C:\> Set-Service -Name ssh-agent -StartupType 'Automatic'
```

```
PS C:\> sc.exe config sshd start= auto

PS C:\> sc.exe config ssh-agent start= auto
```

7. Start the OpenSSH Authentication Agent and SSH Server services: 

```
PS C:\> Start-Service sshd

PS C:\> Start-Service ssh-agent
```

```
PS C:\> Get-NetFirewallRule -Name *OpenSSH-Server* | Select-Object Name, DisplayName, Description, Enabled
```

8. Make sure your Windows Defender Firewall is open for port 22, rule OpenSSH-Server-In-TCP must be enabled. If this rule is not available, manually create it:

```
PS C:\> New-NetFirewallRule -Name sshd -DisplayName 'OpenSSH Server (sshd)' -Enabled True -Direction Inbound -Protocol TCP -Action Allow -LocalPort 22

PS C:\> New-NetFirewallRule -Name sshd -DisplayName 'OpenSSH SSH Server' -Enabled True -Direction Inbound -Protocol TCP -Action Allow -LocalPort 22 -Program "C:\Windows\System32\OpenSSH\sshd.exe"
```

Replace `C:\Windows\System32\OpenSSH\sshd.exe` with the actual path to the `sshd.exe` (`C:\OpenSSH\sshd.exe`, if you followed this instruction). Or go to Control Panel > System and Security > Windows Firewall > Advanced Settings > Inbound Rules and add a new rule for port 22.

Test the SSH port is running in the background.

```
PS C:\> Test-NetConnection -ComputerName localhost -Port 22
```

## 02 - Uninstall OpenSSH Server

### 2.1 - Command Prompt

```
C:\> Dism.exe /Online /Disable-Feature /FeatureName:OpenSSH.Client~~~~0.0.1.0

C:\> Dism.exe /Online /Disable-Feature /FeatureName:OpenSSH.Server~~~~0.0.1.0
```

### 2.2 - PowerShell

```
PS C:\> Remove-WindowsCapability -Online -Name TFTP
```

---
## References

### Backlinks

- [[07 - Tactics & Techniques & Procedures Phases/F - Post Exploitation/0x07 - Maintaining Access/Persistence/Windows/Host Persistence/Remote Login/Network Ports/SSH/Install Service/Malware Development/Scripting]]

### Github

- [PowerShell: OpenSSH-Portable](https://github.com/PowerShell/openssh-portable)

- [PowerShell: Install Win32-OpenSSH](https://github.com/PowerShell/Win32-OpenSSH/wiki/Install-Win32-OpenSSH)

### Null Byte

- [Null Byte: Hacking Windows 10: How to Turn Compromised Windows PCs into Web Proxies](https://null-byte.wonderhowto.com/how-to/hacking-windows-10-turn-compromised-windows-pcs-into-web-proxies-0197334/)

### TrustedSec

- [TrustedSec: The SOCKS We Have at Home](https://trustedsec.com/blog/the-socks-we-have-at-home)