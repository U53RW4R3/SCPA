# C

## XOR

### Single XOR

#### WinAPI

```c
VOID XOR(IN PBYTE data, IN SIZE_T data_length, IN BYTE key) {
	for (size_t i = 0; i < data_length; i++) {
		data[i] ^= key;
	}
}

int main() {
	BYTE buffer = "";

	SIZE_T size = sizeof(buffer);
	BYTE key = 0xcd;
	XOR(buffer, size, key);
	int i = 0;
	while (i < size) {
		printf("\\x%02x", buffer[i]);
		i++;
	}
	return 0;
}
```

### XOR Repeater

#### C Runtime

```c
#include <stdio.h>
#include <string.h>

void XOR(unsigned char *data, int data_length, char *key, int key_length) {
	int j = 0;
	
	for(int i = 0; i < data_length - 1; i++) {
		if(j == key_length - 1) j = 0;
		
		data[i] ^= key[j];
		j++;
  }
}

int main() {
	unsigned char shellcode[] = "";
	char key[] = "";

	XOR((char*) shellcode, sizeof(shellcode), key, sizeof(key));
	for(int i = 0; i < buf_length; i++) {
		printf("\\x%02x", buf[i]);
	}

	return 0;
}
```

## RC4

```c
void RC4(PCHAR key, PCHAR input, PCHAR output, DWORD length) {
    unsigned char S[256];
    int len = strlen(key);
    int j = 0;
    unsigned char tmp;
    for (int i = 0; i < 256; i++)
        S[i] = i;
    for (int i = 0; i < 256; i++) {
        j = (j + S[i] + ((PUCHAR)key)[i % len]) % 256;
        tmp = S[i];
        S[i] = S[j];
        S[j] = tmp;
    }
    int i = 0;
    j = 0;
    for (int n = 0; n < length; n++) {
        i = (i + 1) % 256;
        j = (j + S[i]) % 256;
        tmp = S[i];
        S[i] = S[j];
        S[j] = tmp;
        int rnd = S[(S[i] + S[j]) % 256];
        ((PUCHAR)output)[n] = rnd ^ ((PUCHAR)input)[n];
    }
}
```

## AES

### OpenSSL AES

TODO: Write the AES openssl encryption

https://nasmland645.wordpress.com/2015/02/08/assignment-7-shellcode-crypter/

https://medium.com/@pearcebf/slae-assignment-7-553f48beb2

### Tiny AES

```c
#include <stdio.h>
#include <stdlib.h>
#include <time.h>
#include "aes.h"

#define KEYSIZE 32
#define IVSIZE 16

void generateKey(unsigned char *key) {
	for(int i = 0; i < KEYSIZE; ++i)
		key[i] = (unsigned char)rand() % 256;
}

void generateIV(unsigned char *iv) {
	for(int i = 0; i < IVSIZE; ++i)
		iv[i] = (unsigned char)rand() % 256;
}

void addPadding(unsigned char *data, size_t length) {
	unsigned char paddingValue = 16 - (length % 16);
	for(size_t i = length; i < length + paddingValue; ++i)
		data[i] = paddingValue;
}

int main() {
	unsigned char plaintext[] = "";

	struct AES_ctx ctx;

	addPadding(plaintext, sizeof(plaintext));

	unsigned char pKEY[KEYSIZE];
	unsigned char pIV[IVSIZE];

	srand((unsigned int)time(NULL));
	generateKey(pKEY);

	srand((unsigned int)time(NULL) ^ pKEY[0]);
	generateIV(pIV);

	printf("Generate Key: ");
	for(int i = 0; i < KEYSIZE; ++i) {
		printf("\\x%02x", pKEY[i]);
	}
	printf("\n");
	
	printf("Generate IV: ");
	for(int i = 0; i < IVSIZE; ++i) {
		printf("\\x%02x", pIV[i]);
	}
	printf("\n");

	AES_init_ctx_iv(&ctx, pKEY, pIV);
	AES_CBC_encrypt_buffer(&ctx, plaintext, sizeof(plaintext));
	printf("Ciphertext Size: %zu\n", sizeof(plaintext));
	for(int i = 0; i < sizeof(plaintext); ++i) {
		printf("\\x%02x", plaintext[i]);
	}

	return 0;
}
```

---
## References

### Backlinks

- [[02 - Cryptography/Symmetric/Algorithms/Modern Ciphers/XOR/XOR Repeater|Cryptography: XOR Repeater]]

- [[RC4|Cryptography: RC4]]

### Source Repositories

- [RedSiege: Chromatophore](https://github.com/RedSiege/Chromatophore)

- [Rapid7: XOR header file](https://github.com/rapid7/metasploit-framework/blob/master/data/headers/windows/xor.h)

- [Rapid7: RC4 header file](https://github.com/rapid7/metasploit-framework/blob/master/data/headers/windows/rc4.h)

- [kokke: Tiny AES in C](https://github.com/kokke/tiny-AES-c)

### 0xPat

- [0xPat: Malware development part 5 - tips & tricks](https://0xpat.github.io/Malware_development_part_5/)

### RedSiege

- [RedSiege: Part 2 - Hail Caesar!](https://redsiege.com/blog/2024/06/adventures-in-shellcode-obfuscation-part-2-hail-caesar/)

- [RedSiege: Part 3 - Encryption](https://redsiege.com/blog/2024/07/adventures-in-shellcode-obfuscation-part-3-encryption/)

- [RedSiege: Part 4 - RC4 with a Twist](https://redsiege.com/blog/2024/07/adventures-in-shellcode-obfuscation-part-4-rc4-with-a-twist/)