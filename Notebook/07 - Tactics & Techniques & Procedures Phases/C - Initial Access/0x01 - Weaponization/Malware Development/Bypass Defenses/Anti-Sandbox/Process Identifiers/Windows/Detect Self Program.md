# Detect Self Program

## C

```c
#include <windows.h>
#include <tlhelp32.h>
#include <psapi.h>
#pragma comment(lib, "psapi.lib")

int main() {
	DWORD process_identifier = -1;
	HANDLE handle_process;
	HANDLE handle = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, 0);
	PROCESSENTRY32 process_entry = {0};
	process_entry.dwSize = sizeof(PROCESSENTRY32);

	// Get current process indentifier
	process_identifier = GetCurrentProcessId();

	if (Process32First(handle, &process_entry)) {
		do {  // find parent process identifier (PPID)
		if (process_entry.th32ProcessID == process_identifier) {
				// Now we have the parent identifier, check the module name
				// Get a handle to the process.
				handle_process = OpenProcess(PROCESS_QUERY_INFORMATION | PROCESS_VM_READ, FALSE, process_entry.th32ParentProcessID);

				// Get the process name.
				if (NULL != handle_process) {
					HMODULE handle_module;
					DWORD cbNeeded;
					TCHAR process_name[MAX_PATH];
					if (EnumProcessModules(handle_process, &handle_module, sizeof(handle_module), &cbNeeded)) {
						GetModuleBaseName(handle_process, handle_module, process_name, sizeof(process_name)/sizeof(TCHAR));
						if (strncmp(process_name, "updater.exe", strlen(process_name)) == 0) {
							// execute payload here
						} else {
							// or else call my binary in a new process
							startExe("updater.exe");
							// Wait for child
							Sleep(100);
						}
					}
				}
				// Release the handle to the process.
				CloseHandle(handle_process);
			}
		} while (Process32Next(handle, &process_entry));
	}
	CloseHandle(handle);
	return 0;
}
```