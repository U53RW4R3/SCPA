---
author(s):
  - Userware
tags:
  - vulnerability-assessment
  - initial-access
  - password-cracking
  - network-ports
  - imap
  - network-mapper
---
# IMAP

## 01 - Information Disclosure

### 1.1 - Manual

```
$ telnet <IP> 143
* OK The Microsoft Exchange IMAP4 service is ready.
>> a1 AUTHENTICATE NTLM
+
>> TlRMTVNTUAABAAAAB4IIAAAAAAAAAAAAAAAAAAAAAAA=
+ TlRMTVNTUAACAAAACgAKADgAAAAFgooCBqqVKFrKPCMAAAAAAAAAAEgASABCAAAABgOAJQAAAA9JAEkAUwAwADEAAgAKAEkASQBTADAAMQABAAoASQBJAFMAMAAxAAQACgBJAEkAUwAwADEAAwAKAEkASQBTADAAMQAHAAgAHwMI0VPy1QEAAAAA
```

### 2.2 - Network Mapper

```
$ nmap -p 143,993 --script imap-ntlm-info <IP>
```

## 02 - Brute Force

### 2.1 - Hydra

```
$ hydra
```

### 2.2 - Medusa

`LOGIN` authentication with domain via username 

```
$ medusa -M imap -m AUTH:LOGIN  -h <IP> -u '<domain_name>\\<username>' -p <password>
```

NTLM authentication with domain option.

```
$ medusa -M imap -m AUTH:NTLM -m DOMAIN:<DOMAIN_NAME> -h <IP> -u <username> -p <password>
```

NTLM authentication with domain via username.

```
$ medusa -M imap -m AUTH:NTLM -h <IP> -u <username>@<domain.tld> -p <password>
```

### 2.3 - Network Mapper

```
$ nmap -p 143,993 --script imap-brute <IP>
```

## 03 - Listing Mailboxes

Listing mailboxes with an imap command `LIST "" "*"`.

```
$ curl -k 'imaps://<IP>/' --user <username>:<password>
```

## 04 - Listing Messages in Inboxes

Listing messages in a Inbox (imap command `SELECT INBOX` and then `SEARCH ALL`).

```
$ curl -k 'imaps://<IP>/INBOX?ALL' --user <username>:<password>
```

## 05 - Search Credentials

Searching keywords related to sensitive credentials in the `Drafts` or other `Mailboxes`.

```
$ curl -k 'imaps://<IP>/Drafts?TEXT password' --user <username>:<password>
```

## 06 - Download Messages

### 6.1 - Drafts

Downloading a message (imap command `SELECT Drafts` and then `FETCH 1 BODY[]`).

```
$ curl -k 'imaps://<IP>/Drafts;MAILINDEX=1' --user <username>:<password>
```

#### 6.1.1 - SQL Format Like

We can use the `UID` (unique id) to obtain the messages, yet this one needed to be manually formatted like a SQL Query.

```
$ curl -k 'imaps://<IP>/INBOX' -X 'UID SEARCH ALL' --user <username>:<password>

$ curl -k 'imaps://<IP>/INBOX;UID=1' --user <username>:<password>
```

#### 6.1.2 -  Automated

Another method that can work is by sending parts of messages like subject and sender for the first 5 messages for example.

```
$ curl -k 'imaps://<IP>/INBOX' -X 'FETCH 1:5 BODY[HEADER.FIELDS (SUBJECT FROM)]' --user <username>:<password> -v 2>&1 | grep '^<'
```

```bash
#!/bin/bash
for m in {1..5}; do  
	echo $m
	curl "imap://$1/INBOX;MAILINDEX=$m;SECTION=HEADER.FIELDS%20(SUBJECT%20FROM)" --user $2:$3
done
```

The syntax as it follows.

```
$ ./imap-retrieve-messages.sh <IP> <username> <password>
```

---
## References

### Backlinks

- [[07 - Tactics & Techniques & Procedures Phases/A - Information Gathering/0x02 - Active Fingerprinting/Network Ports/Cross Platform/Mail Server/IMAP]]

### Penetration Testing Tools

- [Penetration Testing Tools: Medusa](https://en.kali.tools/?p=200)