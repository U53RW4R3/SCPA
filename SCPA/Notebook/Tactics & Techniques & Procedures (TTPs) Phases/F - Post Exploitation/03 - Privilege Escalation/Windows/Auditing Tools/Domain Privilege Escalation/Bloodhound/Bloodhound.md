# Bloodhound

## 01 - SharpHound

### 1.1 - Powershell

#### 1.1.1 - Help Menu

```
C:\> Get-Help Invoke-Bloodhound -full

NAME
    Invoke-BloodHound

SYNOPSIS
    Runs the BloodHound C# Ingestor using reflection. The assembly is stored in this file.


SYNTAX
    Invoke-BloodHound [-CollectionMethods <String[]>] [-Domain <String>] [-SearchForest] [-Stealth] [-LdapFilter <String>] [-DistinguishedName <String>]
    [-ComputerFile <String>] [-OutputDirectory <String>] [-OutputPrefix <String>] [-CacheName <String>] [-MemCache] [-RebuildCache] [-RandomFilenames]
    [-ZipFilename <String>] [-NoZip] [-ZipPassword <String>] [-TrackComputerCalls] [-PrettyPrint] [-LdapUsername <String>] [-LdapPassword <String>]
    [-DomainController <String>] [-LdapPort <Int32>] [-SecureLdap] [-DisableCertVerification] [-DisableSigning] [-SkipPortCheck] [-PortCheckTimeout
    <Int32>] [-SkipPasswordCheck] [-ExcludeDCs] [-Throttle <Int32>] [-Jitter <Int32>] [-Threads <Int32>] [-SkipRegistryLoggedOn] [-OverrideUsername
    <String>] [-RealDNSName <String>] [-CollectAllProperties] [-Loop] [-LoopDuration <String>] [-LoopInterval <String>] [-StatusInterval <Int32>]
    [-Verbosity <Int32>] [-Help] [-Version] [<CommonParameters>]


DESCRIPTION
    Using reflection and assembly.load, load the compiled BloodHound C# ingestor into memory
    and run it without touching disk. Parameters are converted to the equivalent CLI arguments
    for the SharpHound executable and passed in via reflection. The appropriate function
    calls are made in order to ensure that assembly dependencies are loaded properly.


PARAMETERS
    -CollectionMethods <String[]>
        Specifies the CollectionMethods being used. Possible value are:
            Group - Collect group membership information
            LocalGroup - Collect local group information for computers
            LocalAdmin - Collect local admin users for computers
            RDP - Collect remote desktop users for computers
            DCOM - Collect distributed COM users for computers
            PSRemote - Collected members of the Remote Management Users group for computers
            Session - Collect session information for computers
            Trusts - Enumerate domain trust data
            ACL - Collect ACL (Access Control List) data
            Container - Collect GPO/OU Data
            ComputerOnly - Collects Local Group and Session data
            GPOLocalGroup - Collects Local Group information using GPO (Group Policy Objects)
            LoggedOn - Collects session information using privileged methods (needs admin!)
            ObjectProps - Collects node property information for users and computers
            SPNTargets - Collects SPN targets (currently only MSSQL)
            Default - Collects Group Membership, Local Admin, Sessions, Containers, ACLs and Domain Trusts
            DcOnly - Collects Group Membership, ACLs, ObjectProps, Trusts, Containers, and GPO Admins
            All - Collect all data

        This can be a list of comma seperated valued as well to run multiple collection methods!

        Required?                    false
        Position?                    named
        Default value                [String[]]@('Default')
        Accept pipeline input?       false
        Accept wildcard characters?  false

    -Domain <String>
        Specifies the domain to enumerate. If not specified, will enumerate the current
        domain your user context specifies.

        Required?                    false
        Position?                    named
        Default value
        Accept pipeline input?       false
        Accept wildcard characters?  false

    -SearchForest [<SwitchParameter>]
        Search all trusted domains in the forest.

        Required?                    false
        Position?                    named
        Default value                False
        Accept pipeline input?       false
        Accept wildcard characters?  false

    -Stealth [<SwitchParameter>]
        Use stealth collection options, will sacrifice data quality in favor of much reduced
        network impact

        Required?                    false
        Position?                    named
        Default value                False
        Accept pipeline input?       false
        Accept wildcard characters?  false

    -LdapFilter <String>
        Append this ldap filter to the search filter to further filter the results enumerated

        Required?                    false
        Position?                    named
        Default value
        Accept pipeline input?       false
        Accept wildcard characters?  false

    -DistinguishedName <String>
        DistinguishedName to start LDAP searches at. Equivalent to the old -Ou option

        Required?                    false
        Position?                    named
        Default value
        Accept pipeline input?       false
        Accept wildcard characters?  false

    -ComputerFile <String>
        A file containing a list of computers to enumerate. This option can only be used with the following Collection Methods:
        Session, Session, LocalGroup, ComputerOnly, LoggedOn

        Required?                    false
        Position?                    named
        Default value
        Accept pipeline input?       false
        Accept wildcard characters?  false

    -OutputDirectory <String>
        Folder to output files too

        Required?                    false
        Position?                    named
        Default value                $( Get-Location )
        Accept pipeline input?       false
        Accept wildcard characters?  false

    -OutputPrefix <String>
        Prefix to add to output files

        Required?                    false
        Position?                    named
        Default value
        Accept pipeline input?       false
        Accept wildcard characters?  false

    -CacheName <String>
        Name for the cache file dropped to disk (default: unique hash generated per machine)

        Required?                    false
        Position?                    named
        Default value
        Accept pipeline input?       false
        Accept wildcard characters?  false

    -MemCache [<SwitchParameter>]
        Don't write the cache file to disk. Caching will still be performed in memory.

        Required?                    false
        Position?                    named
        Default value                False
        Accept pipeline input?       false
        Accept wildcard characters?  false

    -RebuildCache [<SwitchParameter>]
        Invalidate and rebuild the cache file

        Required?                    false
        Position?                    named
        Default value                False
        Accept pipeline input?       false
        Accept wildcard characters?  false

    -RandomFilenames [<SwitchParameter>]
        Randomize file names completely

        Required?                    false
        Position?                    named
        Default value                False
        Accept pipeline input?       false
        Accept wildcard characters?  false

    -ZipFilename <String>
        Name for the zip file output by data collection

        Required?                    false
        Position?                    named
        Default value
        Accept pipeline input?       false
        Accept wildcard characters?  false

    -NoZip [<SwitchParameter>]
        Do NOT zip the json files

        Required?                    false
        Position?                    named
        Default value                False
        Accept pipeline input?       false
        Accept wildcard characters?  false

    -ZipPassword <String>
        Encrypt the zip file with the specified password

        Required?                    false
        Position?                    named
        Default value
        Accept pipeline input?       false
        Accept wildcard characters?  false

    -TrackComputerCalls [<SwitchParameter>]
        Write a CSV file with the results of each computer API call to disk

        Required?                    false
        Position?                    named
        Default value                False
        Accept pipeline input?       false
        Accept wildcard characters?  false

    -PrettyPrint [<SwitchParameter>]
        Output "pretty" json with formatting for readability

        Required?                    false
        Position?                    named
        Default value                False
        Accept pipeline input?       false
        Accept wildcard characters?  false

    -LdapUsername <String>
        Username for connecting to LDAP. Use this if you're using a non-domain account for connecting to computers

        Required?                    false
        Position?                    named
        Default value
        Accept pipeline input?       false
        Accept wildcard characters?  false

    -LdapPassword <String>
        Password for connecting to LDAP. Use this if you're using a non-domain account for connecting to computers

        Required?                    false
        Position?                    named
        Default value
        Accept pipeline input?       false
        Accept wildcard characters?  false

    -DomainController <String>
        Domain Controller to connect too. Specifiying this can result in data loss

        Required?                    false
        Position?                    named
        Default value
        Accept pipeline input?       false
        Accept wildcard characters?  false

    -LdapPort <Int32>
        Port LDAP is running on. Defaults to 389/686 for LDAPS

        Required?                    false
        Position?                    named
        Default value                0
        Accept pipeline input?       false
        Accept wildcard characters?  false

    -SecureLdap [<SwitchParameter>]
        Connect to LDAPS (LDAP SSL) instead of regular LDAP

        Required?                    false
        Position?                    named
        Default value                False
        Accept pipeline input?       false
        Accept wildcard characters?  false

    -DisableCertVerification [<SwitchParameter>]
        Disable certificate verification for secure LDAP

        Required?                    false
        Position?                    named
        Default value                False
        Accept pipeline input?       false
        Accept wildcard characters?  false

    -DisableSigning [<SwitchParameter>]
        Disables keberos signing/sealing, making LDAP traffic viewable

        Required?                    false
        Position?                    named
        Default value                False
        Accept pipeline input?       false
        Accept wildcard characters?  false

    -SkipPortCheck [<SwitchParameter>]
        Skip SMB port checks when connecting to computers

        Required?                    false
        Position?                    named
        Default value                False
        Accept pipeline input?       false
        Accept wildcard characters?  false

    -PortCheckTimeout <Int32>

        Required?                    false
        Position?                    named
        Default value                500
        Accept pipeline input?       false
        Accept wildcard characters?  false

    -SkipPasswordCheck [<SwitchParameter>]
        Skip checking of PwdLastSet time for computer scanning

        Required?                    false
        Position?                    named
        Default value                False
        Accept pipeline input?       false
        Accept wildcard characters?  false

    -ExcludeDCs [<SwitchParameter>]
        Exclude domain controllers from enumeration (usefult o avoid Microsoft ATP/ATA)

        Required?                    false
        Position?                    named
        Default value                False
        Accept pipeline input?       false
        Accept wildcard characters?  false

    -Throttle <Int32>
        Throttle requests to computers (in milliseconds)

        Required?                    false
        Position?                    named
        Default value                0
        Accept pipeline input?       false
        Accept wildcard characters?  false

    -Jitter <Int32>
        Add jitter to throttle

        Required?                    false
        Position?                    named
        Default value                0
        Accept pipeline input?       false
        Accept wildcard characters?  false

    -Threads <Int32>
        Number of threads to run enumeration with (Default: 50)

        Required?                    false
        Position?                    named
        Default value                0
        Accept pipeline input?       false
        Accept wildcard characters?  false

    -SkipRegistryLoggedOn [<SwitchParameter>]
        Disable remote registry check in LoggedOn collection

        Required?                    false
        Position?                    named
        Default value                False
        Accept pipeline input?       false
        Accept wildcard characters?  false

    -OverrideUsername <String>
        Override username to filter for NetSessionEnum

        Required?                    false
        Position?                    named
        Default value
        Accept pipeline input?       false
        Accept wildcard characters?  false

    -RealDNSName <String>
        Overrides the DNS name used for API calls

        Required?                    false
        Position?                    named
        Default value
        Accept pipeline input?       false
        Accept wildcard characters?  false

    -CollectAllProperties [<SwitchParameter>]
        Collect all string LDAP properties on objects

        Required?                    false
        Position?                    named
        Default value                False
        Accept pipeline input?       false
        Accept wildcard characters?  false

    -Loop [<SwitchParameter>]
        Perform looping for computer collection

        Required?                    false
        Position?                    named
        Default value                False
        Accept pipeline input?       false
        Accept wildcard characters?  false

    -LoopDuration <String>
        Duration to perform looping (Default 02:00:00)

        Required?                    false
        Position?                    named
        Default value
        Accept pipeline input?       false
        Accept wildcard characters?  false

    -LoopInterval <String>
        Interval to sleep between loops (Default 00:05:00)

        Required?                    false
        Position?                    named
        Default value
        Accept pipeline input?       false
        Accept wildcard characters?  false

    -StatusInterval <Int32>
        Interval for displaying status in milliseconds

        Required?                    false
        Position?                    named
        Default value                0
        Accept pipeline input?       false
        Accept wildcard characters?  false

    -Verbosity <Int32>
        Change verbosity of output. Default 2 (lower is more)

        Required?                    false
        Position?                    named
        Default value                0
        Accept pipeline input?       false
        Accept wildcard characters?  false

    -Help [<SwitchParameter>]
        Display this help screen

        Required?                    false
        Position?                    named
        Default value                False
        Accept pipeline input?       false
        Accept wildcard characters?  false

    -Version [<SwitchParameter>]
        Display version information

        Required?                    false
        Position?                    named
        Default value                False
        Accept pipeline input?       false
        Accept wildcard characters?  false

    <CommonParameters>
        This cmdlet supports the common parameters: Verbose, Debug,
        ErrorAction, ErrorVariable, WarningAction, WarningVariable,
        OutBuffer, PipelineVariable, and OutVariable. For more information, see
        about_CommonParameters (https:/go.microsoft.com/fwlink/?LinkID=113216).

INPUTS

OUTPUTS

    -------------------------- EXAMPLE 1 --------------------------

    PS C:\>Invoke-BloodHound

    Executes the default collection options and exports JSONs to the current directory, compresses the data to a zip file,
    and then removes the JSON files from disk




    -------------------------- EXAMPLE 2 --------------------------

    PS C:\>Invoke-BloodHound -Loop -LoopInterval 00:01:00 -LoopDuration 00:10:00

    Executes session collection in a loop. Will wait 1 minute after each run to continue collection
    and will continue running for 10 minutes after which the script will exit




    -------------------------- EXAMPLE 3 --------------------------

    PS C:\>Invoke-BloodHound -CollectionMethods All

    Runs ACL, ObjectProps, Container, and Default collection methods, compresses the data to a zip file,
    and then removes the JSON files from disk




    -------------------------- EXAMPLE 4 --------------------------

    PS C:\>Invoke-BloodHound -CollectionMethods DCOnly -NoSaveCache -RandomizeFilenames -EncryptZip

    (Opsec!) Run LDAP only collection methods (Groups, Trusts, ObjectProps, ACL, Containers, GPO Admins) without outputting the cache file to disk.
    Randomizes filenames of the JSON files and the zip file and adds a password to the zip file
```

#### 1.1.2 - Usage

TODO: Provide more usage examples

```
PS C:\> Invoke-BloodHound -CollectionMethod "All,GPOLocalGroup" -Domain <domain> -ZipFileName ad-output.zip
```

### 1.2 - C\#

#### 1.2.1 - Compile

```
C:\> git clone https://github.com/BloodHoundAD/SharpHound

C:\> cd Sharphound

C:\Sharphound> dotnet build -c Release -p:TargetFrameworkVersion=v4.8.1
```

#### 1.2.1 - Manual

##### 1.2.1.1 - Help Menu

```
C:\> SharpHound.exe --help
2023-06-26T15:29:59.9659992-07:00|INFORMATION|This version of SharpHound is compatible with the 4.3.1 Release of BloodHound
SharpHound 1.1.1
Copyright (C) 2023 SpecterOps

  -c, --collectionmethods      (Default: Default) Collection Methods: Group, LocalGroup, LocalAdmin, RDP, DCOM,
                               PSRemote, Session, Trusts, ACL, Container, ComputerOnly, GPOLocalGroup, LoggedOn,
                               ObjectProps, SPNTargets, Default, DCOnly, All

  -d, --domain                 Specify domain to enumerate

  -s, --searchforest           (Default: false) Search all available domains in the forest

  --stealth                    Stealth Collection (Prefer DCOnly whenever possible!)

  -f                           Add an LDAP filter to the pregenerated filter.

  --distinguishedname          Base DistinguishedName to start the LDAP search at

  --computerfile               Path to file containing computer names to enumerate

  --outputdirectory            (Default: .) Directory to output file too

  --outputprefix               String to prepend to output file names

  --cachename                  Filename for cache (Defaults to a machine specific identifier)

  --memcache                   Keep cache in memory and don't write to disk

  --rebuildcache               (Default: false) Rebuild cache and remove all entries

  --randomfilenames            (Default: false) Use random filenames for output

  --zipfilename                Filename for the zip

  --nozip                      (Default: false) Don't zip files

  --zippassword                Password protects the zip with the specified password

  --trackcomputercalls         (Default: false) Adds a CSV tracking requests to computers

  --prettyprint                (Default: false) Pretty print JSON

  --ldapusername               Username for LDAP

  --ldappassword               Password for LDAP

  --domaincontroller           Override domain controller to pull LDAP from. This option can result in data loss

  --ldapport                   (Default: 0) Override port for LDAP

  --secureldap                 (Default: false) Connect to LDAP SSL instead of regular LDAP

  --disablecertverification    (Default: false) Disables certificate verification when using LDAPS

  --disablesigning             (Default: false) Disables Kerberos Signing/Sealing

  --skipportcheck              (Default: false) Skip checking if 445 is open

  --portchecktimeout           (Default: 500) Timeout for port checks in milliseconds

  --skippasswordcheck          (Default: false) Skip check for PwdLastSet when enumerating computers

  --excludedcs                 (Default: false) Exclude domain controllers from session/localgroup enumeration (mostly
                               for ATA/ATP)

  --throttle                   Add a delay after computer requests in milliseconds

  --jitter                     Add jitter to throttle (percent)

  --threads                    (Default: 50) Number of threads to run enumeration with

  --skipregistryloggedon       Skip registry session enumeration

  --overrideusername           Override the username to filter for NetSessionEnum

  --realdnsname                Override DNS suffix for API calls

  --collectallproperties       Collect all LDAP properties from objects

  -l, --Loop                   Loop computer collection

  --loopduration               Loop duration (hh:mm:ss - 05:00:00 is 5 hours, default: 2 hrs)

  --loopinterval               Add delay between loops (hh:mm:ss - 00:03:00 is 3 minutes)

  --statusinterval             (Default: 30000) Interval in which to display status in milliseconds

  -v                           (Default: 2) Enable verbose output

  --help                       Display this help screen.

  --version                    Display version information.
```

##### 1.2.1.2 - Usage

TODO: Provide more usage examples

```
C:\> SharpHound.exe -c Default -d <domain> --zipfilename ad-output.zip

C:\> SharpHound.exe --excludedomaincontrollers --stealth --nosavecache

C:\> SharpHound.exe --excludedomaincontrollers -c acl --nosavecache
```

### 1.3 - Impacket

TODO: Provide more usage examples

```
$ bloodhound-python -u <username> -p <password> -ns <IP> -d <domain> -c All
```

### 1.4 - Metasploit

TODO: Provide a step by step approach

```
msf > use post/windows/gather/bloodhound

msf post(windows/gather/bloodhound) > options

Module options (post/windows/gather/bloodhound):

   Name                      Current Setting  Required  Description
   ----                      ---------------  --------  -----------
   CollectionMethod          Default          yes       The collection method to use. This parameter accepts a comma separated list of values. Accepted values are Default, Group, LocalAdmin, RDP, DCOM, GPOLocalGroup, Session, ObjectProps, ComputerOnly, LoggedOn, Trusts, ACL, Container, DcOnly, All
   DisableKerbSigning                         no        Disables Kerberos Signing on requests
   Domain                                     no        Specifies the domain to enumerate. If not specified, will enumerate the current domain your user context specifies
   DomainController                           no        Specify which Domain Controller to request data from. Defaults to closest DC using Site Names
   EncryptZip                true             no        If the zip should be password protected
   ExcludeDomainControllers  false            yes       Exclude domain controllers from session queries. Useful for ATA environments which detect this behavior
   LdapPort                                   no        Override the port used to connect to LDAP
   Method                    download         yes       Method to run Sharphound with (Accepted: download, disk)
   NoSaveCache               true             no        Dont save the cache file to disk
   OutputDirectory                            no        Folder to write json output to.  Default is Windows temp
   SESSION                                    yes       The session to run this module on
   SRVHOST                   0.0.0.0          yes       The local host or network interface to listen on. This must be an address on the local machine or 0.0.0.0 to listen on all addresses.
   SRVPORT                   8080             yes       The local port to listen on.
   SSL                       false            no        Negotiate SSL for incoming connections
   SSLCert                                    no        Path to a custom SSL certificate (default is randomly generated)
   SecureLdap                false            no        Uses LDAPs instead of unencrypted LDAP on port 636
   Stealth                   false            yes       Use stealth collection options, will sacrifice data quality in favor of much reduced network impact
   URIPATH                                    no        The URI to use for this exploit (default is random)
   ZipFileName                                no        Zip Output File Name.  Blank for random

msf post(windows/gather/bloodhound) >
```

---
## References

- [Getting Started with Bloodhound](https://www.lbmc.com/blog/getting-started-with-bloodhound/)

- [Active Directory Enumeration Bloodhound](https://www.hackingarticles.in/active-directory-enumeration-bloodhound/)

- [Fox-IT Bloodhound Python Implementation](https://github.com/fox-it/BloodHound.py)

- [SharpHound](https://github.com/BloodHoundAD/SharpHound)

- [Bloodhound](https://bloodhound.readthedocs.io/)

- [Finding Active Directory Attack Paths using Bloodhound](https://blog.compass-security.com/2019/12/finding-active-directory-attack-paths-using-bloodhound/)

- [Bloodhound Active Directory](https://blog.netwrix.com/2022/12/09/bloodhound-active-directory/)

- [Enumerating Active Directory Using Bloodhound](https://www.manrajbansal.com/post/enumerating-active-directory-using-bloodhound)

- [Bloodhound 1.3 - The ACL Attack Path Update](https://medium.com/@_wald0/bloodhound-1-3-the-acl-attack-path-update-74aa56c5eb3a)