# Living off the Land

Search Tag(s): #post-exploitation #enumeration-and-discovery #living-off-the-land #windows

## 01 - Installed Programs

### 1.1 - Command Prompt

#### 1.1.1 - List Installed Software

```
C:\> wmic [/node:<IP>] [/user:<username> /password:<password>] Product GET Name,Version,Vendor

C:\> reg query hklm\software
```

DotNET MSBuild compilers

```
C:\> dir %windir%\Microsoft.NET\Framework64 /ad

C:\> dir /b %windir%\Microsoft.NET\Framework64\v*

C:\> wmic [/node:<IP>] [/user:<username> /password:<password>] product get description | findstr /c:.NET
```

#### 1.1.2 - List directories including hidden files and folders

```
C:\> dir /a "C:\Program Files"

C:\> dir /a "C:\Program Files (x86)"

C:\> wmic PATH Win32_Directory WHERE "Name LIKE 'C:\\%' AND Hidden = True"
```

#### 1.1.3 - Find a specific program

Syntax

```
C:\> where <program.exe>

C:\> where /r <C:\ | \\<IP>\c$> <program.exe>

C:\> where /r <program.exe>

C:\> dir /s /b c:\ | findstr "<program.exe>"
```

File Explorer

```
C:\> where explorer.exe

C:\> where /r C:\ explorer.exe

C:\> dir /s /b c:\ | findstr "explorer.exe"
```

Internet Explorer

```
C:\> where iexplore.exe

C:\> where /r C:\ iexplore.exe

C:\> dir /s /b c:\ | findstr "iexplore.exe"
```

Java Updater

```
C:\> where jucheck.exe

C:\> where /r C:\ jucheck.exe

C:\> dir /s /b c:\ | findstr "jucheck.exe"
```

Find MSBuild C# compiler versions

```
C:\> where /r C:\ MSBuild.exe

C:\> where /r \\<IP>\c$ MSBuild.exe

C:\> dir /s /b c:\ | findstr "MSBuild.exe"
```

### 1.2 - Powershell

#### 1.2.1 - List Installed Software

```
PS C:\> Get-CimInstance [-ComputerName <IP>] -Query "SELECT Name,Caption,Version,InstallLocation,IdentifyingNumber FROM Win32_Product" | ? {?_.Vendor -Notmatch 'Microsoft'}

PS C:\> Get-CimInstance [-ComputerName <IP>] -Query "SELECT Name,Caption,Version,InstallLocation,IdentifyingNumber FROM Win32_Product WHERE NOT LIKE 'Microsoft'"

PS C:\> Get-ChildItem -Path Registry::HKEY_LOCAL_MACHINE\SOFTWARE | Format-Table Name

PS C:\> Get-ItemProperty Registry::HKLM:\SOFTWARE
```

List the `.msi` installation that isn't vendored by Microsoft.

```
PS C:\> Get-ChildItem -Recursive -Path $Env:WINDIR\Microsoft.NET\Framework64

PS C:\> Get-Item C:\Windows\Microsoft.Net\Framework64\v4.0.30319\clr.dll | Format-Table
```

#### 1.2.2 - List directories including hidden files and folders

```
PS C:\> Get-ChildItem 'C:\Program Files\','C:\Program Files (x86)\' | Format-Table Parent,Name,LastWriteTime

PS C:\> Get-ChildItem '\\<IP>\C$\Program Files\','\\<IP>\C$\Program Files (x86)\' | Format-Table Parent,Name,LastWriteTime

PS C:\> Get-CimInstance [-ComputerName <IP>] -Query "SELECT Name FROM Win32_Directory WHERE Name LIKE 'C:\\%' AND Hidden = True"
```

#### 1.2.3 - Find a specific program

Syntax

```
PS C:\> Get-Command <program.exe> | Format-Table CommandType, Name, Definition

PS C:\> (Get-Command <program.exe>).Definition

PS C:\> (Get-ChildItem -Recurse -Path <C:\ | \\<IP>\C$\> -Include "<program.exe>" -ErrorAction SilentlyContinue).FullName

PS C:\> Get-ChildItem -Recurse -Path <C:\ | \\<IP>\C$\> -Include "<program.exe>" -ErrorAction SilentlyContinue | ForEach-Object {$_.FullName}

PS C:\> Get-ChildItem -Recurse -Path <C:\ | \\<IP>\C$\> -ErrorAction SilentlyContinue | Where-Object {($_.Name -eq "<program.exe>")} | % {$_.FullName}
```

File Explorer

```
PS C:\> (Get-Command explorer.exe).Definition

PS C:\> (Get-ChildItem -Recurse -Path C:\ -Include "explorer.exe" -ErrorAction SilentlyContinue).FullName
```

Internet Explorer

```
PS C:\> (Get-Command iexplore.exe).Definition

PS C:\> (Get-ChildItem -Recurse -Path C:\ -Include "iexplore.exe" -ErrorAction SilentlyContinue).FullName
```

Java Updater

```
PS C:\> (Get-ChildItem -Recurse -Path C:\ -Include "jucheck.exe" -ErrorAction SilentlyContinue).FullName
```

Find MSBuild C# compiler versions

```
PS C:\> (Get-ChildItem -Recurse -Path C:\ -Include "MSBuild.exe" -ErrorAction SilentlyContinue).FullName

PS C:\> (Get-ChildItem -Recurse -Path \\<IP>\c$ -Include "MSBuild.exe" -ErrorAction SilentlyContinue).FullName
```

## 02 - Powershell and .NET

### 2.1 - Command Prompt

Discover available Powershell engines.

```
C:\> reg query [\\<IP>\]HKEY_LOCAL_MACHINES\SOFTWARE\Microsoft\powershell\1\powershellengine /v powershellversion

C:\> reg query [\\<IP>\]hklm\software\microsoft\powershell\3\powershellengine /v powershellversion
```

Discover Powershell Logging.

```
C:\> reg query [\\<IP>\]HKLM\SOFTWARE\Wow6432Node\Policies\Microsoft\Windows\Powershell\Transcription

C:\> reg query [\\<IP>\]HKLM\SOFTWARE\Wow6432Node\Policies\Microsoft\Windows\PowerShell\ModuleLogging

C:\> reg query [\\<IP>\]HKLM\SOFTWARE\Wow6432Node\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging
```

Enumerate available **Common Language Runtime (CLR)** versions.

```
C:\> dir %windir%\Microsoft.Net\Framework\ /s /b | find "System.dll"

C:\> reg query "HKLM\SOFTWARE\Microsoft\Net Framework Setup\NDP\v4\Full Release"
```

### 2.2 - Powershell

Discover available Powershell engines.

```
PS C:\> Get-ItemPropertyValue HKLM:\software\microsoft\powershell\*\powershellengine -Name PowerShellVersion
```

Enumerate available Common Language Runtime (CLR) versions.

```powershell
PS C:\> [System.IO.File]::Exists("$Env:WINDIR\Microsoft.Net\Framework\v2.0.50727\System.dll")

PS C:\> [IO.File]::Exists("$Env:WINDIR\Microsoft.Net\Framework\v4.0.30319\System.dll")
```

## 03 - Device Drivers

### 3.1 - Command Prompt

```
C:\> driverquery.exe [/s <IP>] [/u [<DOMAIN>\]username>] [/p <password>] [/v] /fo list

C:\> driverquery.exe [/s <IP>] [/u [<DOMAIN>\]username>] [/p <password>] /fo table

C:\> driverquery.exe [/s <IP>] [/u [<DOMAIN>\]username>] [/p <password>] --no-msft
```

### 3.2 - Powershell

Filtering the installed 3rd party drivers with WMI.

```powershell
PS C:\> driverquery.exe [/s <IP>] [/u [<DOMAIN>\]username>] [/p <password>] /v /fo csv | ConvertFrom-CSV | Select-Object 'Display Name', 'Start Mode', Path

PS C:\> Get-CimInstance -ClassName Win32_PnPSignedDriver | Select-Object DeviceName, DriverVersion, Manufacturer | Where-Object {$_.DeviceName -like "*VMWare*"}

PS C:\> Get-CimInstance -Query "SELECT DeviceName, DriverVersion, Manufacturer WHERE LIKE '%VMWare%'"
```

Using WMI for virtualization detection.

```powershell
PS C:\> $VMAdapter = Get-CimInstance -ClassName Win32_NetworkAdapter -Filter 'Manufacturer LIKE "%VMware%" OR Name LIKE "%VMWare%"'

$VMBios = Get-CimInstance Win32_BIOS -Filter 'SerialNumber LIKE "%VMWare%"'

$VMToolsRunning = Get-CimInstance Win32_Process -Filter 'Name="vmtoolsd.exe"'

[Bool]($VMAdapter -or $VMBios -or $VMToolsRunning)
```

## 04 - Antivirus and EDR

### 4.1 - Command Prompt

```
C:\> sc [\\<IP>] query WinDefend

C:\> wmic [/node:<IP>] [/user:<username> /password:<password>] /namespace:\\root\securitycenter2 PATH antivirusproduct

C:\> wmic [/node:<IP>] [/user:<username> /password:<password>] /namespace:\\root\securitycenter2 PATH antivirusproduct GET DisplayName, ProductState, PathToSignedProductExe
```

### 4.2 - Powershell

```
PS C:\> Get-MpComputerStatus

PS C:\> Get-WindowsFeature -Name Windows-Defender

PS C:\> Get-CimInstance -Namespace root\securitycenter2 -ClassName Antivirusproduct

PS C:\> Get-CimInstance -Namespace root\SecurityCenter2 -ClassName AntiVirusProduct | Select-Object -Property DisplayName
```

---
## References

- [Config Server Firewall: CMD Where Command | Find Files Using Command Prompt](https://www.configserverfirewall.com/windows-10/cmd-where-command/)

- [Deep Dive into the Solorigate Second Stage Activation from Sunburst to Teardrop and Raindrop](https://www.microsoft.com/en-us/security/blog/2021/01/20/deep-dive-into-the-solorigate-second-stage-activation-from-sunburst-to-teardrop-and-raindrop/)